var $NGL_shaderTextHash={};$NGL_shaderTextHash["SphereImpostor.frag"]=["#define STANDARD","#define IMPOSTOR","","uniform vec3 diffuse;","uniform vec3 emissive;","uniform float roughness;","uniform float metalness;","uniform float opacity;","uniform float nearClip;","uniform mat4 projectionMatrix;","uniform float ortho;","","varying float vRadius;","varying float vRadiusSq;","varying vec3 vPoint;","varying vec3 vPointViewPosition;","","#ifdef PICKING","    uniform float objectId;","    varying vec3 vPickingColor;","#else","    #include common","    #include color_pars_fragment","    #include fog_pars_fragment","    #include bsdfs","    #include lights_pars_begin","    #include lights_physical_pars_fragment","#endif","","bool flag2 = false;","bool interior = false;","vec3 cameraPos;","vec3 cameraNormal;","","// Calculate depth based on the given camera position.","float calcDepth( in vec3 cameraPos ){","    vec2 clipZW = cameraPos.z * projectionMatrix[2].zw + projectionMatrix[3].zw;","    return 0.5 + 0.5 * clipZW.x / clipZW.y;","}","","float calcClip( vec3 cameraPos ){","    return dot( vec4( cameraPos, 1.0 ), vec4( 0.0, 0.0, 1.0, nearClip - 0.5 ) );","}","","bool Impostor( out vec3 cameraPos, out vec3 cameraNormal ){","","    vec3 cameraSpherePos = -vPointViewPosition;","    cameraSpherePos.z += vRadius;","","    vec3 rayOrigin = mix( vec3( 0.0, 0.0, 0.0 ), vPoint, ortho );","    vec3 rayDirection = mix( normalize( vPoint ), vec3( 0.0, 0.0, 1.0 ), ortho );","    vec3 cameraSphereDir = mix( cameraSpherePos, rayOrigin - cameraSpherePos, ortho );","","    float B = dot( rayDirection, cameraSphereDir );","    float det = B * B + vRadiusSq - dot( cameraSphereDir, cameraSphereDir );","","    if( det < 0.0 ){","        discard;","        return false;","    }","        float sqrtDet = sqrt( det );","        float posT = mix( B + sqrtDet, B + sqrtDet, ortho );","        float negT = mix( B - sqrtDet, sqrtDet - B, ortho );","","        cameraPos = rayDirection * negT + rayOrigin;","","        #ifdef NEAR_CLIP","if( calcDepth( cameraPos ) <= 0.0 ){","    cameraPos = rayDirection * posT + rayOrigin;","    interior = true;","    return false;","}else if( calcClip( cameraPos ) > 0.0 ){","    cameraPos = rayDirection * posT + rayOrigin;","    interior = true;","    flag2 = true;","    return false;","}else{","    cameraNormal = normalize( cameraPos - cameraSpherePos );","}","        #else","if( calcDepth( cameraPos ) <= 0.0 ){","    cameraPos = rayDirection * posT + rayOrigin;","    interior = true;","    return false;","}else{","    cameraNormal = normalize( cameraPos - cameraSpherePos );","}","        #endif","","        cameraNormal = normalize( cameraPos - cameraSpherePos );","        cameraNormal *= float(!interior) * 2.0 - 1.0;","         return !interior;","","}","","void main(void){","","    bool flag = Impostor( cameraPos, cameraNormal );","","    #ifdef NEAR_CLIP","        if( calcClip( cameraPos ) > 0.0 )","            discard;","    #endif","","    // FIXME not compatible with custom clipping plane","    //Set the depth based on the new cameraPos.","    gl_FragDepthEXT = calcDepth( cameraPos );","    if( !flag ){","","        // clamp to near clipping plane and add a tiny value to","        // make spheres with a greater radius occlude smaller ones","        #ifdef NEAR_CLIP","if( flag2 ){","    gl_FragDepthEXT = max( 0.0, calcDepth( vec3( - ( nearClip - 0.5 ) ) ) + ( 0.0000001 / vRadius ) );","}else if( gl_FragDepthEXT >= 0.0 ){","    gl_FragDepthEXT = 0.0 + ( 0.0000001 / vRadius );","}","        #else","if( gl_FragDepthEXT >= 0.0 ){","    gl_FragDepthEXT = 0.0 + ( 0.0000001 / vRadius );","}","        #endif","","    }","","    // bugfix (mac only?)","    if (gl_FragDepthEXT < 0.0)","        discard;","    if (gl_FragDepthEXT > 1.0)","        discard;","","    #ifdef PICKING","","        gl_FragColor = vec4( vPickingColor, objectId );","","    #else","","        vec3 vNormal = cameraNormal;","        vec3 vViewPosition = -cameraPos;","","        vec4 diffuseColor = vec4( diffuse, opacity );","        ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );","        vec3 totalEmissiveLight = emissive;","","        #include color_fragment","        #include roughnessmap_fragment","        #include metalnessmap_fragment","","        // don't use include normal_fragment","        vec3 normal = normalize( vNormal );","","        #include lights_physical_fragment","        //include lights_template","        #include lights_fragment_begin","        #include lights_fragment_end","","        vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveLight;","","        gl_FragColor = vec4( outgoingLight, diffuseColor.a );","        //gl_FragColor = vec4( reflectedLight.directSpecular, diffuseColor.a );","","        #include premultiplied_alpha_fragment","        #include tonemapping_fragment","        #include encodings_fragment","        //include fog_fragment","        #ifdef USE_FOG","            #ifdef USE_LOGDEPTHBUF_EXT","                float depth = gl_FragDepthEXT / gl_FragCoord.w;","            #else","                float depth = gl_FragCoord.z / gl_FragCoord.w;","            #endif","            #ifdef FOG_EXP2","                float fogFactor = whiteCompliment( exp2( - fogDensity * fogDensity * depth * depth * LOG2 ) );","            #else","                float fogFactor = smoothstep( fogNear, fogFar, depth );","            #endif","            gl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );","        #endif","","    #endif","","}"].join("\n"),$NGL_shaderTextHash["SphereImpostor.vert"]=["uniform mat4 projectionMatrixInverse;","uniform float nearClip;","","varying float vRadius;","varying float vRadiusSq;","varying vec3 vPoint;","varying vec3 vPointViewPosition;","varying float fogDepth;","varying float fogNear;","varying float fogFar;","","attribute vec2 mapping;","//attribute vec3 position;","attribute float radius;","","#ifdef PICKING","    #include unpack_clr","    attribute float primitiveId;","    varying vec3 vPickingColor;","#else","    #include color_pars_vertex","#endif","","//include matrix_scale","float matrixScale( in mat4 m ){","    vec4 r = m[ 0 ];","    return sqrt( r[ 0 ] * r[ 0 ] + r[ 1 ] * r[ 1 ] + r[ 2 ] * r[ 2 ] );","}","","const mat4 D = mat4(","    1.0, 0.0, 0.0, 0.0,","    0.0, 1.0, 0.0, 0.0,","    0.0, 0.0, 1.0, 0.0,","    0.0, 0.0, 0.0, -1.0",");","","mat4 transpose( in mat4 inMatrix ) {","    vec4 i0 = inMatrix[0];","    vec4 i1 = inMatrix[1];","    vec4 i2 = inMatrix[2];","    vec4 i3 = inMatrix[3];","","    mat4 outMatrix = mat4(","        vec4(i0.x, i1.x, i2.x, i3.x),","        vec4(i0.y, i1.y, i2.y, i3.y),","        vec4(i0.z, i1.z, i2.z, i3.z),","        vec4(i0.w, i1.w, i2.w, i3.w)","    );","    return outMatrix;","}","","//------------------------------------------------------------------------------","// Compute point size and center using the technique described in:","// 'GPU-Based Ray-Casting of Quadratic Surfaces'","// by Christian Sigg, Tim Weyrich, Mario Botsch, Markus Gross.","//","// Code based on","/*=========================================================================",""," Program:   Visualization Toolkit"," Module:    Quadrics_fs.glsl and Quadrics_vs.glsl",""," Copyright (c) Ken Martin, Will Schroeder, Bill Lorensen"," All rights reserved."," See Copyright.txt or http://www.kitware.com/Copyright.htm for details.",""," This software is distributed WITHOUT ANY WARRANTY; without even"," the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR"," PURPOSE.  See the above copyright notice for more information.",""," =========================================================================*/","","// .NAME Quadrics_fs.glsl and Quadrics_vs.glsl","// .SECTION Thanks","// <verbatim>","//","//  This file is part of the PointSprites plugin developed and contributed by","//","//  Copyright (c) CSCS - Swiss National Supercomputing Centre","//                EDF - Electricite de France","//","//  John Biddiscombe, Ugo Varetto (CSCS)","//  Stephane Ploix (EDF)","//","// </verbatim>","//","// Contributions by Alexander Rose","// - ported to WebGL","// - adapted to work with quads","void ComputePointSizeAndPositionInClipCoordSphere(){","","    vec2 xbc;","    vec2 ybc;","","    mat4 T = mat4(","        radius, 0.0, 0.0, 0.0,","        0.0, radius, 0.0, 0.0,","        0.0, 0.0, radius, 0.0,","        position.x, position.y, position.z, 1.0","    );","","    mat4 R = transpose( projectionMatrix * modelViewMatrix * T );","    float A = dot( R[ 3 ], D * R[ 3 ] );","    float B = -2.0 * dot( R[ 0 ], D * R[ 3 ] );","    float C = dot( R[ 0 ], D * R[ 0 ] );","    xbc[ 0 ] = ( -B - sqrt( B * B - 4.0 * A * C ) ) / ( 2.0 * A );","    xbc[ 1 ] = ( -B + sqrt( B * B - 4.0 * A * C ) ) / ( 2.0 * A );","    float sx = abs( xbc[ 0 ] - xbc[ 1 ] ) * 0.5;","","    A = dot( R[ 3 ], D * R[ 3 ] );","    B = -2.0 * dot( R[ 1 ], D * R[ 3 ] );","    C = dot( R[ 1 ], D * R[ 1 ] );","    ybc[ 0 ] = ( -B - sqrt( B * B - 4.0 * A * C ) ) / ( 2.0 * A );","    ybc[ 1 ] = ( -B + sqrt( B * B - 4.0 * A * C ) ) / ( 2.0 * A );","    float sy = abs( ybc[ 0 ] - ybc[ 1 ]  ) * 0.5;","","    gl_Position.xy = vec2( 0.5 * ( xbc.x + xbc.y ), 0.5 * ( ybc.x + ybc.y ) );","    gl_Position.xy -= mapping * vec2( sx, sy );","    gl_Position.xy *= gl_Position.w;","","}","","void main(void){","","    #ifdef PICKING","        vPickingColor = unpackColor( primitiveId );","    #else","        #include color_vertex","    #endif","","    vRadius = radius * matrixScale( modelViewMatrix );","","    vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","    // avoid clipping, added again in fragment shader","    mvPosition.z -= vRadius;","","    gl_Position = projectionMatrix * vec4( mvPosition.xyz, 1.0 );","    ComputePointSizeAndPositionInClipCoordSphere();","","","    vRadiusSq = vRadius * vRadius;","    vec4 vPoint4 = projectionMatrixInverse * gl_Position;","    vPoint = vPoint4.xyz / vPoint4.w;","    vPointViewPosition = -mvPosition.xyz / mvPosition.w;","","}"].join("\n"),$NGL_shaderTextHash["CylinderImpostor.frag"]=["#define STANDARD","#define IMPOSTOR","","// Open-Source PyMOL is Copyright (C) Schrodinger, LLC.","//","//  All Rights Reserved","//","//  Permission to use, copy, modify, distribute, and distribute modified","//  versions of this software and its built-in documentation for any","//  purpose and without fee is hereby granted, provided that the above","//  copyright notice appears in all copies and that both the copyright","//  notice and this permission notice appear in supporting documentation,","//  and that the name of Schrodinger, LLC not be used in advertising or","//  publicity pertaining to distribution of the software without specific,","//  written prior permission.","//","//  SCHRODINGER, LLC DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE,","//  INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN","//  NO EVENT SHALL SCHRODINGER, LLC BE LIABLE FOR ANY SPECIAL, INDIRECT OR","//  CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS","//  OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE","//  OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE","//  USE OR PERFORMANCE OF THIS SOFTWARE.","","// Contributions by Alexander Rose","// - ported to WebGL","// - dual color","// - pk color","// - custom clipping","// - three.js lighting","","uniform vec3 diffuse;","uniform vec3 emissive;","uniform float roughness;","uniform float metalness;","uniform float opacity;","uniform float nearClip;","uniform mat4 projectionMatrix;","uniform float ortho;","","varying vec3 axis;","varying vec4 base_radius;","varying vec4 end_b;","varying vec3 U;","varying vec3 V;","varying vec4 w;","","#ifdef PICKING","    uniform float objectId;","    varying vec3 vPickingColor;","#else","    varying vec3 vColor1;","    varying vec3 vColor2;","    #include common","    #include fog_pars_fragment","    #include bsdfs","    #include lights_pars_begin","    #include lights_physical_pars_fragment","#endif","","bool interior = false;","","float distSq3( vec3 v3a, vec3 v3b ){","    return (","        ( v3a.x - v3b.x ) * ( v3a.x - v3b.x ) +","        ( v3a.y - v3b.y ) * ( v3a.y - v3b.y ) +","        ( v3a.z - v3b.z ) * ( v3a.z - v3b.z )","    );","}","","// Calculate depth based on the given camera position.","float calcDepth( in vec3 cameraPos ){","    vec2 clipZW = cameraPos.z * projectionMatrix[2].zw + projectionMatrix[3].zw;","    return 0.5 + 0.5 * clipZW.x / clipZW.y;","}","","float calcClip( vec3 cameraPos ){","    return dot( vec4( cameraPos, 1.0 ), vec4( 0.0, 0.0, 1.0, nearClip - 0.5 ) );","}","","void main(){","","    vec3 point = w.xyz / w.w;","","    // unpacking","    vec3 base = base_radius.xyz;","    float vRadius = base_radius.w;","    vec3 end = end_b.xyz;","    float b = end_b.w;","","    vec3 end_cyl = end;","    vec3 surface_point = point;","","    vec3 ray_target = surface_point;","    vec3 ray_origin = vec3(0.0);","    vec3 ray_direction = mix(normalize(ray_origin - ray_target), vec3(0.0, 0.0, 1.0), ortho);","    mat3 basis = mat3( U, V, axis );","","    vec3 diff = ray_target - 0.5 * (base + end_cyl);","    vec3 P = diff * basis;","","    // angle (cos) between cylinder cylinder_axis and ray direction","    float dz = dot( axis, ray_direction );","","    float radius2 = vRadius*vRadius;","","    // calculate distance to the cylinder from ray origin","    vec3 D = vec3(dot(U, ray_direction),","                dot(V, ray_direction),","                dz);","    float a0 = P.x*P.x + P.y*P.y - radius2;","    float a1 = P.x*D.x + P.y*D.y;","    float a2 = D.x*D.x + D.y*D.y;","","    // calculate a dicriminant of the above quadratic equation","    float d = a1*a1 - a0*a2;","    if (d < 0.0)","        // outside of the cylinder","        discard;","","    float dist = (-a1 + sqrt(d)) / a2;","","    // point of intersection on cylinder surface","    vec3 new_point = ray_target + dist * ray_direction;","","    vec3 tmp_point = new_point - base;","    vec3 _normal = normalize( tmp_point - axis * dot(tmp_point, axis) );","","    ray_origin = mix( ray_origin, surface_point, ortho );","","    // test caps","    float front_cap_test = dot( tmp_point, axis );","    float end_cap_test = dot((new_point - end_cyl), axis);","","    // to calculate caps, simply check the angle between","    // the point of intersection - cylinder end vector","    // and a cap plane normal (which is the cylinder cylinder_axis)","    // if the angle < 0, the point is outside of cylinder","    // test front cap","","    #ifndef CAP","        vec3 new_point2 = ray_target + ( (-a1 - sqrt(d)) / a2 ) * ray_direction;","        vec3 tmp_point2 = new_point2 - base;","    #endif","","    // flat","    if (front_cap_test < 0.0)","    {","        // ray-plane intersection","        float dNV = dot(-axis, ray_direction);","        if (dNV < 0.0)","            discard;","        float near = dot(-axis, (base)) / dNV;","        vec3 front_point = ray_direction * near + ray_origin;","        // within the cap radius?","        if (dot(front_point - base, front_point-base) > radius2)","            discard;","","        #ifdef CAP","            new_point = front_point;","            _normal = axis;","        #else","            new_point = ray_target + ( (-a1 - sqrt(d)) / a2 ) * ray_direction;","            dNV = dot(-axis, ray_direction);","            near = dot(axis, end_cyl) / dNV;","            new_point2 = ray_direction * near + ray_origin;","            if (dot(new_point2 - end_cyl, new_point2-base) < radius2)","                discard;","            interior = true;","        #endif","    }","","    // test end cap","","","    // flat","    if( end_cap_test > 0.0 )","    {","        // ray-plane intersection","        float dNV = dot(axis, ray_direction);","        if (dNV < 0.0)","            discard;","        float near = dot(axis, end_cyl) / dNV;","        vec3 end_point = ray_direction * near + ray_origin;","        // within the cap radius?","        if( dot(end_point - end_cyl, end_point-base) > radius2 )","            discard;","","        #ifdef CAP","            new_point = end_point;","            _normal = axis;","        #else","            new_point = ray_target + ( (-a1 - sqrt(d)) / a2 ) * ray_direction;","            dNV = dot(-axis, ray_direction);","            near = dot(-axis, (base)) / dNV;","            new_point2 = ray_direction * near + ray_origin;","            if (dot(new_point2 - base, new_point2-base) < radius2)","                discard;","            interior = true;","        #endif","    }","","    gl_FragDepthEXT = calcDepth( new_point );","","    #ifdef NEAR_CLIP","        if( calcClip( new_point ) > 0.0 ){","            dist = (-a1 - sqrt(d)) / a2;","            new_point = ray_target + dist * ray_direction;","            if( calcClip( new_point ) > 0.0 )","                discard;","            interior = true;","            gl_FragDepthEXT = calcDepth( new_point );","            if( gl_FragDepthEXT >= 0.0 ){","                gl_FragDepthEXT = max( 0.0, calcDepth( vec3( - ( nearClip - 0.5 ) ) ) + ( 0.0000001 / vRadius ) );","            }","        }else if( gl_FragDepthEXT <= 0.0 ){","            dist = (-a1 - sqrt(d)) / a2;","            new_point = ray_target + dist * ray_direction;","            interior = true;","            gl_FragDepthEXT = calcDepth( new_point );","            if( gl_FragDepthEXT >= 0.0 ){","                gl_FragDepthEXT = 0.0 + ( 0.0000001 / vRadius );","            }","        }","    #else","        if( gl_FragDepthEXT <= 0.0 ){","            dist = (-a1 - sqrt(d)) / a2;","            new_point = ray_target + dist * ray_direction;","            interior = true;","            gl_FragDepthEXT = calcDepth( new_point );","            if( gl_FragDepthEXT >= 0.0 ){","                gl_FragDepthEXT = 0.0 + ( 0.0000001 / vRadius );","            }","        }","    #endif","","    // this is a workaround necessary for Mac","    // otherwise the modified fragment won't clip properly","    if (gl_FragDepthEXT < 0.0)","        discard;","    if (gl_FragDepthEXT > 1.0)","        discard;","","    #ifdef PICKING","","        gl_FragColor = vec4( vPickingColor, objectId );","","    #else","","        vec3 vViewPosition = -new_point;","        vec3 vNormal = _normal;","        vec3 vColor;","","        if( distSq3( new_point, end_cyl ) < distSq3( new_point, base ) ){","            if( b < 0.0 ){","                vColor = vColor1;","            }else{","                vColor = vColor2;","            }","        }else{","            if( b > 0.0 ){","                vColor = vColor1;","            }else{","                vColor = vColor2;","            }","        }","","        vec4 diffuseColor = vec4( diffuse, opacity );","        ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );","        vec3 totalEmissiveLight = emissive;","","        #include color_fragment","     //ifdef USE_COLOR","     //diffuseColor.r *= vColor[0];","     //diffuseColor.g *= vColor[1];","     //diffuseColor.b *= vColor[2];","     //endif","        #include roughnessmap_fragment","        #include metalnessmap_fragment","","        // don't use include normal_fragment","        vec3 normal = normalize( vNormal );","","        #include lights_physical_fragment","        //include lights_template","        #include lights_fragment_begin","        #include lights_fragment_end","","        vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveLight;","","        gl_FragColor = vec4( outgoingLight, diffuseColor.a );","        //gl_FragColor = vec4( reflectedLight.directSpecular, diffuseColor.a );","","        #include premultiplied_alpha_fragment","        #include tonemapping_fragment","        #include encodings_fragment","        //include fog_fragment","        #ifdef USE_FOG","            #ifdef USE_LOGDEPTHBUF_EXT","                float depth = gl_FragDepthEXT / gl_FragCoord.w;","            #else","                float depth = gl_FragCoord.z / gl_FragCoord.w;","            #endif","            #ifdef FOG_EXP2","                float fogFactor = whiteCompliment( exp2( - fogDensity * fogDensity * depth * depth * LOG2 ) );","            #else","                float fogFactor = smoothstep( fogNear, fogFar, depth );","            #endif","            gl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );","        #endif","","    #endif","","}"].join("\n"),$NGL_shaderTextHash["CylinderImpostor.vert"]=["// Open-Source PyMOL is Copyright (C) Schrodinger, LLC.","//","//  All Rights Reserved","//","//  Permission to use, copy, modify, distribute, and distribute modified","//  versions of this software and its built-in documentation for any","//  purpose and without fee is hereby granted, provided that the above","//  copyright notice appears in all copies and that both the copyright","//  notice and this permission notice appear in supporting documentation,","//  and that the name of Schrodinger, LLC not be used in advertising or","//  publicity pertaining to distribution of the software without specific,","//  written prior permission.","//","//  SCHRODINGER, LLC DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE,","//  INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN","//  NO EVENT SHALL SCHRODINGER, LLC BE LIABLE FOR ANY SPECIAL, INDIRECT OR","//  CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS","//  OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE","//  OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE","//  USE OR PERFORMANCE OF THIS SOFTWARE.","","// Contributions by Alexander Rose","// - ported to WebGL","// - dual color","// - pk color","// - shift","","attribute vec3 mapping;","attribute vec3 position1;","attribute vec3 position2;","attribute float radius;","","varying vec3 axis;","varying vec4 base_radius;","varying vec4 end_b;","varying vec3 U;","varying vec3 V;","varying vec4 w;","varying float fogDepth;","varying float fogNear;","varying float fogFar;","","#ifdef PICKING","    #include unpack_clr","    attribute float primitiveId;","    varying vec3 vPickingColor;","#else","    //attribute vec3 color;","    attribute vec3 color2;","    varying vec3 vColor1;","    varying vec3 vColor2;","#endif","","uniform mat4 modelViewMatrixInverse;","uniform float ortho;","","//include matrix_scale","float matrixScale( in mat4 m ){","    vec4 r = m[ 0 ];","    return sqrt( r[ 0 ] * r[ 0 ] + r[ 1 ] * r[ 1 ] + r[ 2 ] * r[ 2 ] );","}","","void main(){","","    #ifdef PICKING","        vPickingColor = unpackColor( primitiveId );","    #else","        vColor1 = color;","        vColor2 = color2;","    #endif","","    // vRadius = radius;","    base_radius.w = radius * matrixScale( modelViewMatrix );","","    //vec3 center = position;","    vec3 center = ( position2 + position1 ) / 2.0;","    vec3 dir = normalize( position2 - position1 );","    float ext = length( position2 - position1 ) / 2.0;","","    // using cameraPosition fails on some machines, not sure why","    // vec3 cam_dir = normalize( cameraPosition - mix( center, vec3( 0.0 ), ortho ) );","    vec3 cam_dir;","    if( ortho == 0.0 ){","        cam_dir = ( modelViewMatrixInverse * vec4( 0, 0, 0, 1 ) ).xyz - center;","    }else{","        cam_dir = ( modelViewMatrixInverse * vec4( 0, 0, 1, 0 ) ).xyz;","    }","    cam_dir = normalize( cam_dir );","","    vec3 ldir;","","    float b = dot( cam_dir, dir );","    end_b.w = b;","    // direction vector looks away, so flip","    if( b < 0.0 )","        ldir = -ext * dir;","    // direction vector already looks in my direction","    else","        ldir = ext * dir;","","    vec3 left = normalize( cross( cam_dir, ldir ) );","    left = radius * left;","    vec3 up = radius * normalize( cross( left, ldir ) );","","    // transform to modelview coordinates","    axis = normalize( normalMatrix * ldir );","    U = normalize( normalMatrix * up );","    V = normalize( normalMatrix * left );","","    vec4 base4 = modelViewMatrix * vec4( center - ldir, 1.0 );","    base_radius.xyz = base4.xyz / base4.w;","","    vec4 top_position = modelViewMatrix * vec4( center + ldir, 1.0 );","    vec4 end4 = top_position;","    end_b.xyz = end4.xyz / end4.w;","","    w = modelViewMatrix * vec4(","        center + mapping.x*ldir + mapping.y*left + mapping.z*up, 1.0","    );","","    gl_Position = projectionMatrix * w;","","    // avoid clipping (1.0 seems to induce flickering with some drivers)","    gl_Position.z = 0.99;","","}"].join("\n"),$NGL_shaderTextHash["SphereInstancing.frag"]=$NGL_shaderTextHash["SphereImpostor.frag"],$NGL_shaderTextHash["SphereInstancing.vert"]=["uniform mat4 projectionMatrixInverse;","uniform float nearClip;","","varying float vRadius;","varying float vRadiusSq;","varying vec3 vPoint;","varying vec3 vPointViewPosition;","varying float fogDepth;","varying float fogNear;","varying float fogFar;","","attribute vec2 mapping;","//attribute vec3 position;","attribute float radius;","attribute vec4 matrix1;","attribute vec4 matrix2;","attribute vec4 matrix3;","attribute vec4 matrix4;","","#ifdef PICKING","    #include unpack_clr","    attribute float primitiveId;","    varying vec3 vPickingColor;","#else","    #include color_pars_vertex","#endif","","//include matrix_scale","float matrixScale( in mat4 m ){","    vec4 r = m[ 0 ];","    return sqrt( r[ 0 ] * r[ 0 ] + r[ 1 ] * r[ 1 ] + r[ 2 ] * r[ 2 ] );","}","","const mat4 D = mat4(","    1.0, 0.0, 0.0, 0.0,","    0.0, 1.0, 0.0, 0.0,","    0.0, 0.0, 1.0, 0.0,","    0.0, 0.0, 0.0, -1.0",");","","mat4 transpose( in mat4 inMatrix ) {","    vec4 i0 = inMatrix[0];","    vec4 i1 = inMatrix[1];","    vec4 i2 = inMatrix[2];","    vec4 i3 = inMatrix[3];","","    mat4 outMatrix = mat4(","        vec4(i0.x, i1.x, i2.x, i3.x),","        vec4(i0.y, i1.y, i2.y, i3.y),","        vec4(i0.z, i1.z, i2.z, i3.z),","        vec4(i0.w, i1.w, i2.w, i3.w)","    );","    return outMatrix;","}","","//------------------------------------------------------------------------------","// Compute point size and center using the technique described in:","// 'GPU-Based Ray-Casting of Quadratic Surfaces'","// by Christian Sigg, Tim Weyrich, Mario Botsch, Markus Gross.","//","// Code based on","/*=========================================================================",""," Program:   Visualization Toolkit"," Module:    Quadrics_fs.glsl and Quadrics_vs.glsl",""," Copyright (c) Ken Martin, Will Schroeder, Bill Lorensen"," All rights reserved."," See Copyright.txt or http://www.kitware.com/Copyright.htm for details.",""," This software is distributed WITHOUT ANY WARRANTY; without even"," the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR"," PURPOSE.  See the above copyright notice for more information.",""," =========================================================================*/","","// .NAME Quadrics_fs.glsl and Quadrics_vs.glsl","// .SECTION Thanks","// <verbatim>","//","//  This file is part of the PointSprites plugin developed and contributed by","//","//  Copyright (c) CSCS - Swiss National Supercomputing Centre","//                EDF - Electricite de France","//","//  John Biddiscombe, Ugo Varetto (CSCS)","//  Stephane Ploix (EDF)","//","// </verbatim>","//","// Contributions by Alexander Rose","// - ported to WebGL","// - adapted to work with quads","void ComputePointSizeAndPositionInClipCoordSphere(vec4 updatePosition){","","    vec2 xbc;","    vec2 ybc;","","    mat4 T = mat4(","        radius, 0.0, 0.0, 0.0,","        0.0, radius, 0.0, 0.0,","        0.0, 0.0, radius, 0.0,","        updatePosition.x, updatePosition.y, updatePosition.z, 1.0","    );","","    mat4 R = transpose( projectionMatrix * modelViewMatrix * T );","    float A = dot( R[ 3 ], D * R[ 3 ] );","    float B = -2.0 * dot( R[ 0 ], D * R[ 3 ] );","    float C = dot( R[ 0 ], D * R[ 0 ] );","    xbc[ 0 ] = ( -B - sqrt( B * B - 4.0 * A * C ) ) / ( 2.0 * A );","    xbc[ 1 ] = ( -B + sqrt( B * B - 4.0 * A * C ) ) / ( 2.0 * A );","    float sx = abs( xbc[ 0 ] - xbc[ 1 ] ) * 0.5;","","    A = dot( R[ 3 ], D * R[ 3 ] );","    B = -2.0 * dot( R[ 1 ], D * R[ 3 ] );","    C = dot( R[ 1 ], D * R[ 1 ] );","    ybc[ 0 ] = ( -B - sqrt( B * B - 4.0 * A * C ) ) / ( 2.0 * A );","    ybc[ 1 ] = ( -B + sqrt( B * B - 4.0 * A * C ) ) / ( 2.0 * A );","    float sy = abs( ybc[ 0 ] - ybc[ 1 ]  ) * 0.5;","","    gl_Position.xy = vec2( 0.5 * ( xbc.x + xbc.y ), 0.5 * ( ybc.x + ybc.y ) );","    gl_Position.xy -= mapping * vec2( sx, sy );","    gl_Position.xy *= gl_Position.w;","","}","","  mat4 computeMat(vec4 v1, vec4 v2, vec4 v3, vec4 v4) {","    return mat4(","      v1.x, v1.y, v1.z, v1.w,","      v2.x, v2.y, v2.z, v2.w,","      v3.x, v3.y, v3.z, v3.w,","      v4.x, v4.y, v4.z, v4.w","    );","  }","","void main(void){","","    #ifdef PICKING","        vPickingColor = unpackColor( primitiveId );","    #else","        #include color_vertex","    #endif","","    vRadius = radius * matrixScale( modelViewMatrix );","","    mat4 matrix = computeMat(matrix1, matrix2, matrix3, matrix4);","    vec4 updatePosition = matrix * vec4(position, 1.0);","","//    vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","    vec4 mvPosition = modelViewMatrix * vec4( updatePosition.xyz, 1.0 );","    // avoid clipping, added again in fragment shader","    mvPosition.z -= vRadius;","","//    gl_Position = projectionMatrix * vec4( mvPosition.xyz, 1.0 );","    gl_Position = projectionMatrix * vec4( mvPosition.xyz, 1.0 );","    ComputePointSizeAndPositionInClipCoordSphere(updatePosition);","","","    vRadiusSq = vRadius * vRadius;","    vec4 vPoint4 = projectionMatrixInverse * gl_Position;","    vPoint = vPoint4.xyz / vPoint4.w;","    vPointViewPosition = -mvPosition.xyz / mvPosition.w;","","}"].join("\n"),$NGL_shaderTextHash["CylinderInstancing.frag"]=$NGL_shaderTextHash["CylinderImpostor.frag"],$NGL_shaderTextHash["CylinderInstancing.vert"]=["// Open-Source PyMOL is Copyright (C) Schrodinger, LLC.","//","//  All Rights Reserved","//","//  Permission to use, copy, modify, distribute, and distribute modified","//  versions of this software and its built-in documentation for any","//  purpose and without fee is hereby granted, provided that the above","//  copyright notice appears in all copies and that both the copyright","//  notice and this permission notice appear in supporting documentation,","//  and that the name of Schrodinger, LLC not be used in advertising or","//  publicity pertaining to distribution of the software without specific,","//  written prior permission.","//","//  SCHRODINGER, LLC DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE,","//  INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN","//  NO EVENT SHALL SCHRODINGER, LLC BE LIABLE FOR ANY SPECIAL, INDIRECT OR","//  CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS","//  OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE","//  OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE","//  USE OR PERFORMANCE OF THIS SOFTWARE.","","// Contributions by Alexander Rose","// - ported to WebGL","// - dual color","// - pk color","// - shift","","attribute vec3 mapping;","attribute vec3 position1;","attribute vec3 position2;","attribute float radius;","attribute vec4 matrix1;","attribute vec4 matrix2;","attribute vec4 matrix3;","attribute vec4 matrix4;","","varying vec3 axis;","varying vec4 base_radius;","varying vec4 end_b;","varying vec3 U;","varying vec3 V;","varying vec4 w;","varying float fogDepth;","varying float fogNear;","varying float fogFar;","","#ifdef PICKING","    #include unpack_clr","    attribute float primitiveId;","    varying vec3 vPickingColor;","#else","    //attribute vec3 color;","    attribute vec3 color2;","    varying vec3 vColor1;","    varying vec3 vColor2;","#endif","","uniform mat4 modelViewMatrixInverse;","uniform float ortho;","","//include matrix_scale","float matrixScale( in mat4 m ){","    vec4 r = m[ 0 ];","    return sqrt( r[ 0 ] * r[ 0 ] + r[ 1 ] * r[ 1 ] + r[ 2 ] * r[ 2 ] );","}","","  mat4 computeMat(vec4 v1, vec4 v2, vec4 v3, vec4 v4) {","    return mat4(","      v1.x, v1.y, v1.z, v1.w,","      v2.x, v2.y, v2.z, v2.w,","      v3.x, v3.y, v3.z, v3.w,","      v4.x, v4.y, v4.z, v4.w","    );","  }","","void main(){","","    #ifdef PICKING","        vPickingColor = unpackColor( primitiveId );","    #else","        vColor1 = color;","        vColor2 = color2;","    #endif","","    // vRadius = radius;","    base_radius.w = radius * matrixScale( modelViewMatrix );","","    //vec3 center = ( position2 + position1 ) / 2.0;","","    mat4 matrix = computeMat(matrix1, matrix2, matrix3, matrix4);","    vec4 updatePosition1 = matrix * vec4(position1, 1.0);","    vec4 updatePosition2 = matrix * vec4(position2, 1.0);","    vec3 center = ( updatePosition2.xyz + updatePosition1.xyz ) / 2.0;","","    //vec3 dir = normalize( position2 - position1 );","    vec3 dir = normalize( updatePosition2.xyz - updatePosition1.xyz );","    float ext = length( position2 - position1 ) / 2.0;","","    // using cameraPosition fails on some machines, not sure why","    // vec3 cam_dir = normalize( cameraPosition - mix( center, vec3( 0.0 ), ortho ) );","    vec3 cam_dir;","    if( ortho == 0.0 ){","        cam_dir = ( modelViewMatrixInverse * vec4( 0, 0, 0, 1 ) ).xyz - center;","    }else{","        cam_dir = ( modelViewMatrixInverse * vec4( 0, 0, 1, 0 ) ).xyz;","    }","    cam_dir = normalize( cam_dir );","","    vec3 ldir;","","    float b = dot( cam_dir, dir );","    end_b.w = b;","    // direction vector looks away, so flip","    if( b < 0.0 )","        ldir = -ext * dir;","    // direction vector already looks in my direction","    else","        ldir = ext * dir;","","    vec3 left = normalize( cross( cam_dir, ldir ) );","    left = radius * left;","    vec3 up = radius * normalize( cross( left, ldir ) );","","    // transform to modelview coordinates","    axis = normalize( normalMatrix * ldir );","    U = normalize( normalMatrix * up );","    V = normalize( normalMatrix * left );","","    vec4 base4 = modelViewMatrix * vec4( center - ldir, 1.0 );","    base_radius.xyz = base4.xyz / base4.w;","","    vec4 top_position = modelViewMatrix * vec4( center + ldir, 1.0 );","    vec4 end4 = top_position;","    end_b.xyz = end4.xyz / end4.w;","","    w = modelViewMatrix * vec4(","        center + mapping.x*ldir + mapping.y*left + mapping.z*up, 1.0","    );","","    gl_Position = projectionMatrix * w;","","    // avoid clipping (1.0 seems to induce flickering with some drivers)","    gl_Position.z = 0.99;","","}"].join("\n"),$NGL_shaderTextHash["Instancing.frag"]=["#define STANDARD","uniform vec3 diffuse;","uniform vec3 emissive;","uniform float roughness;","uniform float metalness;","uniform float opacity;","uniform float nearClip;","uniform float clipRadius;","uniform mat4 projectionMatrix;","uniform float ortho;","varying float bCylinder;","","#if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || ( !defined( PICKING ) && !defined( NOLIGHT ) )","    varying vec3 vViewPosition;","#endif","","#if defined( RADIUS_CLIP )","    varying vec3 vClipCenter;","#endif","","#if defined( PICKING )","    uniform float objectId;","    varying vec3 vPickingColor;","#elif defined( NOLIGHT )","    varying vec3 vColor;","#else","    #ifndef FLAT_SHADED","        varying vec3 vNormal;","    #endif","    #include common","    #include color_pars_fragment","    #include fog_pars_fragment","    #include bsdfs","    #include lights_pars_begin","    #include lights_physical_pars_fragment","#endif","","void main(){","    #include nearclip_fragment","    #include radiusclip_fragment","","    #if defined( PICKING )","","        gl_FragColor = vec4( vPickingColor, objectId );","","    #elif defined( NOLIGHT )","","        gl_FragColor = vec4( vColor, opacity );","","    #else","","        vec4 diffuseColor = vec4( diffuse, opacity );","        ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );","        vec3 totalEmissiveLight = emissive;","","        #include color_fragment","        #include roughnessmap_fragment","        #include metalnessmap_fragment","        #include normal_flip","        #include normal_fragment_begin","","        //include dull_interior_fragment","","        #include lights_physical_fragment","        //include lights_template","        #include lights_fragment_begin","        #include lights_fragment_end","","        vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveLight;","","        #include interior_fragment","","        gl_FragColor = vec4( outgoingLight, diffuseColor.a );","","        #include premultiplied_alpha_fragment","        #include tonemapping_fragment","        #include encodings_fragment","        #include fog_fragment","","        #include opaque_back_fragment","","    #endif","","}"].join("\n"),$NGL_shaderTextHash["Instancing.vert"]=["#define STANDARD","","uniform mat4 projectionMatrixInverse;","uniform float nearClip;","uniform vec3 clipCenter;","attribute vec4 matrix1;","attribute vec4 matrix2;","attribute vec4 matrix3;","attribute vec4 matrix4;","attribute float cylinder;","varying float bCylinder;","","#if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || ( !defined( PICKING ) && !defined( NOLIGHT ) )","    varying vec3 vViewPosition;","#endif","","#if defined( RADIUS_CLIP )","    varying vec3 vClipCenter;","#endif","","#if defined( PICKING )","    #include unpack_color","    attribute float primitiveId;","    varying vec3 vPickingColor;","#elif defined( NOLIGHT )","    varying vec3 vColor;","#else","    #include color_pars_vertex","    #ifndef FLAT_SHADED","        varying vec3 vNormal;","    #endif","#endif","","#include common","","  mat4 computeMat(vec4 v1, vec4 v2, vec4 v3, vec4 v4) {","    return mat4(","      v1.x, v1.y, v1.z, v1.w,","      v2.x, v2.y, v2.z, v2.w,","      v3.x, v3.y, v3.z, v3.w,","      v4.x, v4.y, v4.z, v4.w","    );","  }","","void main(){","    bCylinder = cylinder;","","    mat4 matrix = computeMat(matrix1, matrix2, matrix3, matrix4);","    vec4 updatePosition = matrix * vec4(position, 1.0);","","    #if defined( PICKING )","        vPickingColor = unpackColor( primitiveId );","    #elif defined( NOLIGHT )","        vColor = color;","    #else","        #include color_vertex","        //include beginnormal_vertex","        //vec3 objectNormal = vec3( normal );","        vec3 objectNormal = vec3(matrix * vec4(normal,0.0));","        #include defaultnormal_vertex","        // Normal computed with derivatives when FLAT_SHADED","        #ifndef FLAT_SHADED","            vNormal = normalize( transformedNormal );","        #endif","    #endif","","    //include begin_vertex","    vec3 transformed = updatePosition.xyz;","    //include project_vertex","    vec4 mvPosition = modelViewMatrix * vec4( transformed, 1.0 );","    gl_Position = projectionMatrix * mvPosition;","","    #if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || ( !defined( PICKING ) && !defined( NOLIGHT ) )","        vViewPosition = -mvPosition.xyz;","    #endif","","    #if defined( RADIUS_CLIP )","        vClipCenter = -( modelViewMatrix * vec4( clipCenter, 1.0 ) ).xyz;","    #endif","","    #include nearclip_vertex","","}"].join("\n"),THREE.RenderableObject=function(){"use strict";this.id=0,this.object=null,this.z=0},THREE.RenderableFace=function(){"use strict";this.id=0,this.v1=new THREE.RenderableVertex,this.v2=new THREE.RenderableVertex,this.v3=new THREE.RenderableVertex,this.normalModel=new THREE.Vector3,this.vertexNormalsModel=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3],this.vertexNormalsLength=0,this.color=new THREE.Color,this.material=null,this.uvs=[new THREE.Vector2,new THREE.Vector2,new THREE.Vector2],this.z=0},THREE.RenderableVertex=function(){"use strict";this.position=new THREE.Vector3,this.positionWorld=new THREE.Vector3,this.positionScreen=new THREE.Vector4,this.visible=!0},THREE.RenderableVertex.prototype.copy=function(e){"use strict";this.positionWorld.copy(e.positionWorld),this.positionScreen.copy(e.positionScreen)},THREE.RenderableLine=function(){"use strict";this.id=0,this.v1=new THREE.RenderableVertex,this.v2=new THREE.RenderableVertex,this.vertexColors=[new THREE.Color,new THREE.Color],this.material=null,this.z=0},THREE.RenderableSprite=function(){"use strict";this.id=0,this.object=null,this.x=0,this.y=0,this.z=0,this.rotation=0,this.scale=new THREE.Vector2,this.material=null},THREE.Projector=function(){"use strict";var _,b,n,w,g,T,r,x,C,R,S,L=[],A=0,y=[],a=0,E=[],I=0,s=[],c=0,t=[],i=0,O={objects:[],lights:[],elements:[]},N=(new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3),P=new THREE.Vector4,d=new THREE.Box3(new THREE.Vector3(-1,-1,-1),new THREE.Vector3(1,1,1)),M=new THREE.Box3,H=new Array(3),z=(new Array(4),new THREE.Matrix4),D=new THREE.Matrix4,j=(new THREE.Matrix4,new THREE.Matrix3,new THREE.Frustum);new THREE.Vector4,new THREE.Vector4;this.projectVector=function(e,t){console.warn("THREE.Projector: .projectVector() is now vector.project()."),e.project(t)},this.unprojectVector=function(e,t){console.warn("THREE.Projector: .unprojectVector() is now vector.unproject()."),e.unproject(t)},this.pkRay=function(e,t){console.error("THREE.Projector: .pkRay() is now raycaster.setFromCamera().")};var F=new function(){function o(e){var t=e.position,i=e.positionWorld,o=e.positionScreen;i.copy(t).applyMatrix4(S),o.copy(i).applyMatrix4(D);var n=1/o.w;o.x*=n,o.y*=n,o.z*=n,e.visible=-1<=o.x&&o.x<=1&&-1<=o.y&&o.y<=1&&-1<=o.z&&o.z<=1}function l(e,t,i){return!0===e.visible||!0===t.visible||!0===i.visible||(H[0]=e.positionScreen,H[1]=t.positionScreen,H[2]=i.positionScreen,d.isIntersectionBox(M.setFromPoints(H)))}function u(e,t,i){return(i.positionScreen.x-e.positionScreen.x)*(t.positionScreen.y-e.positionScreen.y)-(i.positionScreen.y-e.positionScreen.y)*(t.positionScreen.x-e.positionScreen.x)<0}var p=[],f=[],v=null,h=null,m=new THREE.Matrix3;return{setObject:function(e){h=(v=e).material,m.getNormalMatrix(v.matrixWorld),p.length=0,f.length=0},projectVertex:o,checkTriangleVisibility:l,checkBackfaceCulling:u,pushVertex:function(e,t,i){(n=function(){if(w!==a)return y[w++];var e=new THREE.RenderableVertex;return y.push(e),a++,w++,e}()).position.set(e,t,i),o(n)},pushNormal:function(e,t,i){p.push(e,t,i)},pushUv:function(e,t){f.push(e,t)},pushLine:function(e,t){var i=y[e],o=y[t];(r=function(){if(x!==c)return s[x++];var e=new THREE.RenderableLine;return s.push(e),c++,x++,e}()).id=v.id,r.v1.copy(i),r.v2.copy(o),r.z=(i.positionScreen.z+o.positionScreen.z)/2,r.material=v.material,O.elements.push(r)},pushTriangle:function(e,t,i){var o=y[e],n=y[t],r=y[i];if(!1!==l(o,n,r)&&(h.side===THREE.DoubleSide||!0===u(o,n,r))){(g=function(){if(T!==I)return E[T++];var e=new THREE.RenderableFace;return E.push(e),I++,T++,e}()).id=v.id,g.v1.copy(o),g.v2.copy(n),g.v3.copy(r),g.z=(o.positionScreen.z+n.positionScreen.z+r.positionScreen.z)/3;for(var a=0;a<3;a++){var s=3*arguments[a],c=g.vertexNormalsModel[a];c.set(p[s],p[1+s],p[2+s]),c.applyMatrix3(m).normalize();var d=2*arguments[a];g.uvs[a].set(f[d],f[1+d])}g.vertexNormalsLength=3,g.material=v.material,O.elements.push(g)}}}};function V(){if(R!==i)return t[R++];var e=new THREE.RenderableSprite;return t.push(e),i++,R++,e}function U(e,t){return e.z!==t.z?t.z-e.z:e.id!==t.id?e.id-t.id:0}this.projectScene=function(e,t,i,o){R=x=T=0,!(O.elements.length=0)===e.autoUpdate&&e.updateMatrixWorld(),void 0===t.parent&&t.updateMatrixWorld(),z.copy(t.matrixWorldInverse.copy(t.matrixWorld).invert()),D.multiplyMatrices(t.projectionMatrix,z),j.setFromMatrix(D),b=0,O.objects.length=0,O.lights.length=0,e.traverseVisible(function(e){if(e instanceof THREE.Light)O.lights.push(e);else if(e instanceof THREE.Mesh||e instanceof THREE.Line||e instanceof THREE.Sprite){if(!1===e.material.visible)return;!1!==e.frustumCulled&&!0!==j.intersectsObject(e)||((_=function(){if(b!==A)return L[b++];var e=new THREE.RenderableObject;return L.push(e),A++,b++,e}()).id=e.id,_.object=e,N.setFromMatrixPosition(e.matrixWorld),N.applyProjection(D),_.z=N.z,O.objects.push(_))}}),!0===i&&O.objects.sort(U);for(var n=0,r=O.objects.length;n<r;n++){var a=O.objects[n].object,s=a.geometry;if(F.setObject(a),S=a.matrixWorld,w=0,a instanceof THREE.Mesh){if(s instanceof THREE.BufferGeometry){var c=s.attributes,d=s.offsets;if(void 0===c.position)continue;for(var l=0,u=(g=c.position.array).length;l<u;l+=3)F.pushVertex(g[l],g[l+1],g[l+2]);if(void 0!==c.normal){var p=c.normal.array;for(l=0,u=p.length;l<u;l+=3)F.pushNormal(p[l],p[l+1],p[l+2])}if(void 0!==c.uv){var f=c.uv.array;for(l=0,u=f.length;l<u;l+=2)F.pushUv(f[l],f[l+1])}if(void 0!==c.index){var v=c.index.array;if(0<d.length)for(n=0;n<d.length;n++){var h=d[n],m=h.index;for(l=h.start,u=h.start+h.count;l<u;l+=3)F.pushTriangle(v[l]+m,v[l+1]+m,v[l+2]+m)}else for(l=0,u=v.length;l<u;l+=3)F.pushTriangle(v[l],v[l+1],v[l+2])}else for(l=0,u=g.length/3;l<u;l+=3)F.pushTriangle(l,l+1,l+2)}}else if(a instanceof THREE.Line){if(s instanceof THREE.BufferGeometry)if(void 0!==(c=s.attributes).position){var g;for(l=0,u=(g=c.position.array).length;l<u;l+=3)F.pushVertex(g[l],g[l+1],g[l+2]);if(void 0!==c.index)for(l=0,u=(v=c.index.array).length;l<u;l+=2)F.pushLine(v[l],v[l+1]);else{var y=a.mode===THREE.LinePieces?2:1;for(l=0,u=g.length/3-1;l<u;l+=y)F.pushLine(l,l+1)}}}else if(a instanceof THREE.Sprite){P.set(S.elements[12],S.elements[13],S.elements[14],1),P.applyMatrix4(D);var E=1/P.w;P.z*=E,-1<=P.z&&P.z<=1&&((C=V()).id=a.id,C.x=P.x*E,C.y=P.y*E,C.z=P.z,C.object=a,C.rotation=a.rotation,C.scale.x=a.scale.x*Math.abs(C.x-(P.x+t.projectionMatrix.elements[0])/(P.w+t.projectionMatrix.elements[12])),C.scale.y=a.scale.y*Math.abs(C.y-(P.y+t.projectionMatrix.elements[5])/(P.w+t.projectionMatrix.elements[13])),C.material=a.material,O.elements.push(C))}}return!0===o&&O.elements.sort(U),O}},THREE.TrackballControls=function(e,t,o){"use strict";var r=this;this.STATE={NONE:-1,ROTATE:0,ZOOM:1,PAN:2,TOUCH_ROTATE:3,TOUCH_ZOOM_PAN:4},this.object=e,this.domElement=void 0!==t?t:document,this.enabled=!0,this.screen={left:0,top:0,width:0,height:0},this.rotateSpeed=1,this.zoomSpeed=1.2,this.panSpeed=.3,this.noRotate=!1,this.noZoom=!1,this.noPan=!1,this.noRoll=!1,this.staticMoving=!1,this.dynamicDampingFactor=.2,this.minDistance=0,this.maxDistance=1/0,this.keys=[65,83,68],this.target=new THREE.Vector3;var i=new THREE.Vector3;this._state=this.STATE.NONE;var n=this.STATE.NONE,a=new THREE.Vector3;this._rotateStart=new THREE.Vector3,this._rotateEnd=new THREE.Vector3,this._zoomStart=new THREE.Vector2,this._zoomEnd=new THREE.Vector2;var s=0,c=0;this._panStart=new THREE.Vector2,this._panEnd=new THREE.Vector2,this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.up0=this.object.up.clone();var d={type:"change"},l={type:"start"},u={type:"end"};this.handleResize=function(){if(this.domElement===document)this.screen.left=0,this.screen.top=0,this.screen.width=window.innerWidth,this.screen.height=window.innerHeight;else{var e=this.domElement.getBoundingClientRect(),t=this.domElement.ownerDocument.documentElement;this.screen.left=e.left+window.pageXOffset-t.clientLeft,this.screen.top=e.top+window.pageYOffset-t.clientTop,this.screen.width=e.width,this.screen.height=e.height}},this.handleEvent=function(e){"function"==typeof this[e.type]&&this[e.type](e)};var p,f,v,h,m,g,y,E,_,b=(p=new THREE.Vector2,function(e,t){return p.set((e-r.screen.left)/r.screen.width,(t-r.screen.top)/r.screen.height),p}),w=(f=new THREE.Vector3,v=new THREE.Vector3,h=new THREE.Vector3,function(e,t){h.set((e-.5*r.screen.width-r.screen.left)/(.5*r.screen.width),(.5*r.screen.height+r.screen.top-t)/(.5*r.screen.height),0);var i=h.length();return r.noRoll?i<Math.SQRT1_2?h.z=Math.sqrt(1-i*i):h.z=.5/i:1<i?h.normalize():h.z=Math.sqrt(1-i*i),a.copy(r.object.position).sub(r.target),f.copy(r.object.up).setLength(h.y),f.add(v.copy(r.object.up).cross(a).setLength(h.x)),f.add(a.setLength(h.z)),f});function T(e){!1===r.enabled||Object.keys(window).length<2||(window.removeEventListener("keydown",T),n=r._state,r._state===r.STATE.NONE&&(e.keyCode!==r.keys[r.STATE.ROTATE]||r.noRotate?e.keyCode!==r.keys[r.STATE.ZOOM]||r.noZoom?e.keyCode!==r.keys[r.STATE.PAN]||r.noPan||(r._state=r.STATE.PAN):r._state=r.STATE.ZOOM:r._state=r.STATE.ROTATE))}function x(e){!1===r.enabled||Object.keys(window).length<2||(e.stopPropagation(),r._state!==r.STATE.ROTATE||r.noRotate?r._state!==r.STATE.ZOOM||r.noZoom?r._state!==r.STATE.PAN||r.noPan||r._panEnd.copy(b(e.pageX,e.pageY)):r._zoomEnd.copy(b(e.pageX,e.pageY)):r._rotateEnd.copy(w(e.pageX,e.pageY)))}function C(e){!1===r.enabled||Object.keys(window).length<2||(e.stopPropagation(),r._state=r.STATE.NONE,document.removeEventListener("mousemove",x),document.removeEventListener("mouseup",C),r.dispatchEvent(u))}function R(e){if(!(!1===r.enabled||Object.keys(window).length<2)){e.stopPropagation();var t=0;e.wheelDelta?t=e.wheelDelta/40:e.detail&&(t=-e.detail/3),r._zoomStart.y=.005*t,r.dispatchEvent(l),r.dispatchEvent(u)}}this.rotateCamera=(m=new THREE.Vector3,g=new THREE.Quaternion,function(e,t){var i;void 0===e&&(i=Math.acos(r._rotateStart.dot(r._rotateEnd)/r._rotateStart.length()/r._rotateEnd.length())),!i&&void 0===e||(void 0===e?(m.crossVectors(r._rotateStart,r._rotateEnd).normalize(),i*=r.rotateSpeed,g.setFromAxisAngle(m,-i)):g.copy(e),void 0===o||void 0===o.quaternion||void 0!==t&&!0!==t||o.quaternion.multiplyQuaternions(g,o.quaternion),a.applyQuaternion(g),r.object.up.applyQuaternion(g),r._rotateEnd.applyQuaternion(g),r.staticMoving?r._rotateStart.copy(r._rotateEnd):(g.setFromAxisAngle(m,i*(r.dynamicDampingFactor-1)),r._rotateStart.applyQuaternion(g)))}),this.zoomCamera=function(e,t){var i;r._state===r.STATE.TOUCH_ZOOM_PAN?(void 0!==e?i=e:(i=s/c,s=c),a.multiplyScalar(i),void 0===o||void 0===o._zoomFactor||void 0!==t&&!0!==t||(o._zoomFactor*=i)):(i=void 0!==e?e:1+(r._zoomEnd.y-r._zoomStart.y)*r.zoomSpeed,void 0===o||void 0===o._zoomFactor||void 0!==t&&!0!==t||(o._zoomFactor*=i),1!==i&&(a.multiplyScalar(i),r.staticMoving?r._zoomStart.copy(r._zoomEnd):r._zoomStart.y+=(r._zoomEnd.y-r._zoomStart.y)*this.dynamicDampingFactor))},this.panCamera=(y=new THREE.Vector2,E=new THREE.Vector3,_=new THREE.Vector3,function(e,t){void 0!==e?(y=e,void 0===o||void 0===o.mouseChange||void 0!==t&&!0!==t||o.mouseChange.add(e)):(y.copy(r._panEnd).sub(r._panStart),void 0===o||void 0===o.mouseChange||void 0!==t&&!0!==t||o.mouseChange.add(r._panEnd).sub(r._panStart)),y.lengthSq()&&(y.multiplyScalar(a.length()*r.panSpeed),_.copy(a).cross(r.object.up).setLength(y.x),_.add(E.copy(r.object.up).setLength(y.y)),r.object.position.add(_),r.target.add(_),r.staticMoving?r._panStart.copy(r._panEnd):r._panStart.add(y.subVectors(r._panEnd,r._panStart).multiplyScalar(r.dynamicDampingFactor)))}),this.checkDistances=function(){r.noZoom&&r.noPan||(a.lengthSq()>r.maxDistance*r.maxDistance&&r.object.position.addVectors(r.target,a.setLength(r.maxDistance)),a.lengthSq()<r.minDistance*r.minDistance&&r.object.position.addVectors(r.target,a.setLength(r.minDistance)))},this.update=function(e){a.subVectors(r.object.position,r.target),r.noRotate||(void 0!==e&&void 0!==e.quaternion?r.rotateCamera(e.quaternion,e.update):r.rotateCamera()),r.noZoom||(void 0!==e&&void 0!==e._zoomFactor?r.zoomCamera(e._zoomFactor,e.update):r.zoomCamera()),r.noPan||(void 0!==e&&void 0!==e.mouseChange?r.panCamera(e.mouseChange,e.update):r.panCamera()),r.object.position.addVectors(r.target,a),r.checkDistances(),r.object.lookAt(r.target),1e-6<i.distanceToSquared(r.object.position)&&(r.dispatchEvent(d),i.copy(r.object.position))},this.reset=function(){r._state=r.STATE.NONE,n=r.STATE.NONE,r.target.copy(r.target0),r.object.position.copy(r.position0),r.object.up.copy(r.up0),a.subVectors(r.object.position,r.target),r.object.lookAt(r.target),r.dispatchEvent(d),i.copy(r.object.position)},2<=Object.keys(window).length&&(this.domElement.addEventListener("contextmn",function(e){},!1),this.domElement.addEventListener("mousedown",function(e){!1===r.enabled||Object.keys(window).length<2||(e.stopPropagation(),r._state===r.STATE.NONE&&(r._state=e.button),r._state!==r.STATE.ROTATE||r.noRotate?r._state!==r.STATE.ZOOM||r.noZoom?r._state!==r.STATE.PAN||r.noPan||(r._panStart.copy(b(e.pageX,e.pageY)),r._panEnd.copy(r._panStart)):(r._zoomStart.copy(b(e.pageX,e.pageY)),r._zoomEnd.copy(r._zoomStart)):(r._rotateStart.copy(w(e.pageX,e.pageY)),r._rotateEnd.copy(r._rotateStart)),document.addEventListener("mousemove",x,!1),document.addEventListener("mouseup",C,!1),r.dispatchEvent(l))},!1),this.domElement.addEventListener("mousewheel",R,!1),this.domElement.addEventListener("DOMMouseScroll",R,!1),this.domElement.addEventListener("touchstart",function(e){if(!(!1===r.enabled||Object.keys(window).length<2)){switch(e.touches.length){case 1:r._state=r.STATE.TOUCH_ROTATE,r._rotateStart.copy(w(e.touches[0].pageX,e.touches[0].pageY)),r._rotateEnd.copy(r._rotateStart);break;case 2:r._state=r.STATE.TOUCH_ZOOM_PAN;var t=e.touches[0].pageX-e.touches[1].pageX,i=e.touches[0].pageY-e.touches[1].pageY;c=s=Math.sqrt(t*t+i*i);var o=(e.touches[0].pageX+e.touches[1].pageX)/2,n=(e.touches[0].pageY+e.touches[1].pageY)/2;r._panStart.copy(b(o,n)),r._panEnd.copy(r._panStart);break;default:r._state=r.STATE.NONE}r.dispatchEvent(l)}},!1),this.domElement.addEventListener("touchend",function(e){if(!(!1===r.enabled||Object.keys(window).length<2)){switch(e.touches.length){case 1:r._rotateEnd.copy(w(e.touches[0].pageX,e.touches[0].pageY)),r._rotateStart.copy(r._rotateEnd);break;case 2:s=c=0;var t=(e.touches[0].pageX+e.touches[1].pageX)/2,i=(e.touches[0].pageY+e.touches[1].pageY)/2;r._panEnd.copy(b(t,i)),r._panStart.copy(r._panEnd)}r._state=r.STATE.NONE,r.dispatchEvent(u)}},!1),this.domElement.addEventListener("touchmove",function(e){if(!(!1===r.enabled||Object.keys(window).length<2))switch(e.stopPropagation(),e.touches.length){case 1:r._rotateEnd.copy(w(e.touches[0].pageX,e.touches[0].pageY));break;case 2:var t=e.touches[0].pageX-e.touches[1].pageX,i=e.touches[0].pageY-e.touches[1].pageY;c=Math.sqrt(t*t+i*i);var o=(e.touches[0].pageX+e.touches[1].pageX)/2,n=(e.touches[0].pageY+e.touches[1].pageY)/2;r._panEnd.copy(b(o,n));break;default:r._state=r.STATE.NONE}},!1),2<=Object.keys(window).length&&window.addEventListener("keydown",T,!1),2<=Object.keys(window).length&&window.addEventListener("keyup",function(e){!1===r.enabled||Object.keys(window).length<2||(r._state=n,window.addEventListener("keydown",T,!1))},!1)),this.handleResize(),this.update()},THREE.TrackballControls.prototype=Object.create(THREE.EventDispatcher.prototype),THREE.TrackballControls.prototype.constructor=THREE.TrackballControls,THREE.OrthographicTrackballControls=function(e,t,o){this.icn3d;var r=this,a={NONE:-1,ROTATE:0,ZOOM:1,PAN:2,TOUCH_ROTATE:3,TOUCH_ZOOM_PAN:4};this.object=e,this.domElement=void 0!==t?t:document,this.enabled=!0,this.screen={left:0,top:0,width:0,height:0},this.rotateSpeed=.5,this.zoomSpeed=1.2;this.zoomSpeed*=.01,this.panSpeed=.03,this.noRotate=!1,this.noZoom=!1,this.noPan=!1,this.noRoll=!1,this.staticMoving=!1,this.dynamicDampingFactor=.2,this.keys=[65,83,68],this.target=new THREE.Vector3;var i=new THREE.Vector3;this._state=a.NONE;var n=a.NONE,s=new THREE.Vector3;this._rotateStart=new THREE.Vector3,this._rotateEnd=new THREE.Vector3,this._zoomStart=new THREE.Vector2,this._zoomEnd=new THREE.Vector2;var c=1,d=0,l=0;this._panStart=new THREE.Vector2,this._panEnd=new THREE.Vector2,this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.up0=this.object.up.clone(),this.left0=this.object.left,this.right0=this.object.right,this.top0=this.object.top,this.bottom0=this.object.bottom,this.center0=new THREE.Vector2((this.left0+this.right0)/2,(this.top0+this.bottom0)/2);var u={type:"change"},p={type:"start"},f={type:"end"};this.handleResize=function(){if(this.domElement===document)this.screen.left=0,this.screen.top=0,this.screen.width=window.innerWidth,this.screen.height=window.innerHeight;else{var e=this.domElement.getBoundingClientRect(),t=this.domElement.ownerDocument.documentElement;this.screen.left=e.left+window.pageXOffset-t.clientLeft,this.screen.top=e.top+window.pageYOffset-t.clientTop,this.screen.width=e.width,this.screen.height=e.height}this.left0=this.object.left,this.right0=this.object.right,this.top0=this.object.top,this.bottom0=this.object.bottom,this.center0.set((this.left0+this.right0)/2,(this.top0+this.bottom0)/2)},this.handleEvent=function(e){"function"==typeof this[e.type]&&this[e.type](e)};var v,h,m,g,y,E,_,b,w,T=(v=new THREE.Vector2,function(e,t){return v.set((e-r.screen.left)/r.screen.width,(t-r.screen.top)/r.screen.height),v}),x=(h=new THREE.Vector3,m=new THREE.Vector3,g=new THREE.Vector3,function(e,t){g.set((e-.5*r.screen.width-r.screen.left)/(.5*r.screen.width),(.5*r.screen.height+r.screen.top-t)/(.5*r.screen.height),0);var i=g.length();return r.noRoll?i<Math.SQRT1_2?g.z=Math.sqrt(1-i*i):g.z=.5/i:1<i?g.normalize():g.z=Math.sqrt(1-i*i),s.copy(r.object.position).sub(r.target),h.copy(r.object.up).setLength(g.y),h.add(m.copy(r.object.up).cross(s).setLength(g.x)),h.add(s.setLength(g.z)),h});function C(e){!1===r.enabled||Object.keys(window).length<2||(window.removeEventListener("keydown",C),n=r._state,r._state===a.NONE&&(e.keyCode!==r.keys[a.ROTATE]||r.noRotate?e.keyCode!==r.keys[a.ZOOM]||r.noZoom?e.keyCode!==r.keys[a.PAN]||r.noPan||(r._state=a.PAN):r._state=a.ZOOM:r._state=a.ROTATE))}function R(e){!1===r.enabled||Object.keys(window).length<2||(e.stopPropagation(),r._state!==a.ROTATE||r.noRotate?r._state!==a.ZOOM||r.noZoom?r._state!==a.PAN||r.noPan||r._panEnd.copy(T(e.pageX,e.pageY)):r._zoomEnd.copy(T(e.pageX,e.pageY)):r._rotateEnd.copy(x(e.pageX,e.pageY)))}function S(e){!1===r.enabled||Object.keys(window).length<2||(e.stopPropagation(),r._state=a.NONE,document.removeEventListener("mousemove",R),document.removeEventListener("mouseup",S),r.dispatchEvent(f))}function L(e){if(!(!1===r.enabled||Object.keys(window).length<2)){e.stopPropagation();var t=0;e.wheelDelta?t=e.wheelDelta/40:e.detail&&(t=-e.detail/3),r._zoomStart.y=.01*t,r.dispatchEvent(p),r.dispatchEvent(f)}}this.rotateCamera=(y=new THREE.Vector3,E=new THREE.Quaternion,function(e,t){var i;void 0===e&&(i=Math.acos(r._rotateStart.dot(r._rotateEnd)/r._rotateStart.length()/r._rotateEnd.length())),!i&&void 0===e||(void 0===e?(y.crossVectors(r._rotateStart,r._rotateEnd).normalize(),i*=r.rotateSpeed,E.setFromAxisAngle(y,-i)):E.copy(e),void 0===o||void 0===o.quaternion||void 0!==t&&!0!==t||o.quaternion.multiplyQuaternions(E,o.quaternion),s.applyQuaternion(E),r.object.up.applyQuaternion(E),r._rotateEnd.applyQuaternion(E),r.staticMoving?r._rotateStart.copy(r._rotateEnd):(E.setFromAxisAngle(y,i*(r.dynamicDampingFactor-1)),r._rotateStart.applyQuaternion(E)))}),this.zoomCamera=function(e,t){var i;r._state===a.TOUCH_ZOOM_PAN?void 0!==e?i=e:(i=d/l,d=l):i=void 0!==e?e:1+(r._zoomEnd.y-r._zoomStart.y)*r.zoomSpeed/.01,void 0===o||void 0===o._zoomFactor||void 0!==t&&!0!==t||(o._zoomFactor*=i),1!==i&&(c=i,r.object.left=c*r.left0+(1-c)*r.center0.x,r.object.right=c*r.right0+(1-c)*r.center0.x,r.object.top=c*r.top0+(1-c)*r.center0.y,r.object.bottom=c*r.bottom0+(1-c)*r.center0.y,r.staticMoving?r._zoomStart.copy(r._zoomEnd):r._zoomStart.y+=(r._zoomEnd.y-r._zoomStart.y)*this.dynamicDampingFactor)},this.panCamera=(_=new THREE.Vector2,b=new THREE.Vector3,w=new THREE.Vector3,function(e,t){void 0!==e?(_=e,void 0===o||void 0===o.mouseChange||void 0!==t&&!0!==t||o.mouseChange.add(e)):(_.copy(r._panEnd).sub(r._panStart),void 0===o||void 0===o.mouseChange||void 0!==t&&!0!==t||o.mouseChange.add(r._panEnd).sub(r._panStart)),_.lengthSq()&&(_.multiplyScalar(s.length()*r.panSpeed),w.copy(s).cross(r.object.up).setLength(_.x),w.add(b.copy(r.object.up).setLength(_.y)),r.object.position.add(w),r.target.add(w),r.staticMoving?r._panStart.copy(r._panEnd):r._panStart.add(_.subVectors(r._panEnd,r._panStart).multiplyScalar(r.dynamicDampingFactor)))}),this.update=function(e){s.subVectors(r.object.position,r.target),r.noRotate||(void 0!==e&&void 0!==e.quaternion?r.rotateCamera(e.quaternion,e.update):r.rotateCamera()),r.noZoom||(void 0!==e&&void 0!==e._zoomFactor?r.zoomCamera(e._zoomFactor,e.update):r.zoomCamera(),r.object.updateProjectionMatrix()),r.noPan||(void 0!==e&&void 0!==e.mouseChange?r.panCamera(e.mouseChange,e.update):r.panCamera()),r.object.position.addVectors(r.target,s),r.object.lookAt(r.target),1e-6<i.distanceToSquared(r.object.position)&&(r.dispatchEvent(u),i.copy(r.object.position))},this.reset=function(){r._state=a.NONE,n=a.NONE,r.target.copy(r.target0),r.object.position.copy(r.position0),r.object.up.copy(r.up0),s.subVectors(r.object.position,r.target),r.object.left=r.left0,r.object.right=r.right0,r.object.top=r.top0,r.object.bottom=r.bottom0,r.object.lookAt(r.target),r.dispatchEvent(u),i.copy(r.object.position)},2<=Object.keys(window).length&&(this.domElement.addEventListener("contextmn",function(e){},!1),this.domElement.addEventListener("mousedown",function(e){!1===r.enabled||Object.keys(window).length<2||(e.stopPropagation(),r._state===a.NONE&&(r._state=e.button),r._state!==a.ROTATE||r.noRotate?r._state!==a.ZOOM||r.noZoom?r._state!==a.PAN||r.noPan||(r._panStart.copy(T(e.pageX,e.pageY)),r._panEnd.copy(r._panStart)):(r._zoomStart.copy(T(e.pageX,e.pageY)),r._zoomEnd.copy(r._zoomStart)):(r._rotateStart.copy(x(e.pageX,e.pageY)),r._rotateEnd.copy(r._rotateStart)),document.addEventListener("mousemove",R,!1),document.addEventListener("mouseup",S,!1),r.dispatchEvent(p))},!1),this.domElement.addEventListener("mousewheel",L,!1),this.domElement.addEventListener("DOMMouseScroll",L,!1),this.domElement.addEventListener("touchstart",function(e){if(!(!1===r.enabled||Object.keys(window).length<2)){switch(e.touches.length){case 1:r._state=a.TOUCH_ROTATE,r._rotateStart.copy(x(e.touches[0].pageX,e.touches[0].pageY)),r._rotateEnd.copy(r._rotateStart);break;case 2:r._state=a.TOUCH_ZOOM_PAN;var t=e.touches[0].pageX-e.touches[1].pageX,i=e.touches[0].pageY-e.touches[1].pageY;l=d=Math.sqrt(t*t+i*i);var o=(e.touches[0].pageX+e.touches[1].pageX)/2,n=(e.touches[0].pageY+e.touches[1].pageY)/2;r._panStart.copy(T(o,n)),r._panEnd.copy(r._panStart);break;default:r._state=a.NONE}r.dispatchEvent(p)}},!1),this.domElement.addEventListener("touchend",function(e){if(!(!1===r.enabled||Object.keys(window).length<2)){switch(e.touches.length){case 1:r._rotateEnd.copy(x(e.touches[0].pageX,e.touches[0].pageY)),r._rotateStart.copy(r._rotateEnd);break;case 2:d=l=0;var t=(e.touches[0].pageX+e.touches[1].pageX)/2,i=(e.touches[0].pageY+e.touches[1].pageY)/2;r._panEnd.copy(T(t,i)),r._panStart.copy(r._panEnd)}r._state=a.NONE,r.dispatchEvent(f)}},!1),this.domElement.addEventListener("touchmove",function(e){if(!(!1===r.enabled||Object.keys(window).length<2))switch(e.stopPropagation(),e.touches.length){case 1:r._rotateEnd.copy(x(e.touches[0].pageX,e.touches[0].pageY));break;case 2:var t=e.touches[0].pageX-e.touches[1].pageX,i=e.touches[0].pageY-e.touches[1].pageY;l=Math.sqrt(t*t+i*i);var o=(e.touches[0].pageX+e.touches[1].pageX)/2,n=(e.touches[0].pageY+e.touches[1].pageY)/2;r._panEnd.copy(T(o,n));break;default:r._state=a.NONE}},!1),window.addEventListener("keydown",C,!1),window.addEventListener("keyup",function(e){!1===r.enabled||Object.keys(window).length<2||(r._state=n,window.addEventListener("keydown",C,!1))},!1)),this.handleResize(),this.update()},THREE.OrthographicTrackballControls.prototype=Object.create(THREE.EventDispatcher.prototype),THREE.OrthographicTrackballControls.prototype.constructor=THREE.OrthographicTrackballControls;var MMTF={};function initIcn3dpyMMTF(e){function p(e,t,i){for(var o=(e.byteLength,0),n=i.length;o<n;o++){var r=i.charCodeAt(o);if(r<128)e.setUint8(t++,r>>>0&127|0);else if(r<2048)e.setUint8(t++,r>>>6&31|192),e.setUint8(t++,r>>>0&63|128);else if(r<65536)e.setUint8(t++,r>>>12&15|224),e.setUint8(t++,r>>>6&63|128),e.setUint8(t++,r>>>0&63|128);else{if(!(r<1114112))throw new Error("bad codepoint "+r);e.setUint8(t++,r>>>18&7|240),e.setUint8(t++,r>>>12&63|128),e.setUint8(t++,r>>>6&63|128),e.setUint8(t++,r>>>0&63|128)}}}function f(e){for(var t=0,i=0,o=e.length;i<o;i++){var n=e.charCodeAt(i);if(n<128)t+=1;else if(n<2048)t+=2;else if(n<65536)t+=3;else{if(!(n<1114112))throw new Error("bad codepoint "+n);t+=4}}return t}function t(e){var t=new ArrayBuffer(function e(t){var i=typeof t;if("string"==i){if((o=f(t))<32)return 1+o;if(o<256)return 2+o;if(o<65536)return 3+o;if(o<4294967296)return 5+o}if(t instanceof Uint8Array){if((o=t.byteLength)<256)return 2+o;if(o<65536)return 3+o;if(o<4294967296)return 5+o}if("number"==i){if(Math.floor(t)!==t)return 9;if(0<=t){if(t<128)return 1;if(t<256)return 2;if(t<65536)return 3;if(t<4294967296)return 5;throw new Error("Number too big 0x"+t.toString(16))}if(-32<=t)return 1;if(-128<=t)return 2;if(-32768<=t)return 3;if(-2147483648<=t)return 5;throw new Error("Number too small -0x"+t.toString(16).substr(1))}if("boolean"==i||null===t)return 1;if("object"!=i)throw new Error("Unknown type "+i);var o,n=0;if(Array.isArray(t)){o=t.length;for(var r=0;r<o;r++)n+=e(t[r])}else{var a=Object.keys(t);for(o=a.length,r=0;r<o;r++){var s=a[r];n+=e(s)+e(t[s])}}if(o<16)return 1+n;if(o<65536)return 3+n;if(o<4294967296)return 5+n;throw new Error("Array or object too long 0x"+o.toString(16))}(e));return function e(t,i,o){var n=typeof t;if("string"==n){if((r=f(t))<32)return i.setUint8(o,160|r),p(i,o+1,t),1+r;if(r<256)return i.setUint8(o,217),i.setUint8(o+1,r),p(i,o+2,t),2+r;if(r<65536)return i.setUint8(o,218),i.setUint16(o+1,r),p(i,o+3,t),3+r;if(r<4294967296)return i.setUint8(o,219),i.setUint32(o+1,r),p(i,o+5,t),5+r}if(t instanceof Uint8Array){var r=t.byteLength,a=new Uint8Array(i.buffer);if(r<256)return i.setUint8(o,196),i.setUint8(o+1,r),a.set(t,o+2),2+r;if(r<65536)return i.setUint8(o,197),i.setUint16(o+1,r),a.set(t,o+3),3+r;if(r<4294967296)return i.setUint8(o,198),i.setUint32(o+1,r),a.set(t,o+5),5+r}if("number"==n){if(!isFinite(t))throw new Error("Number not finite: "+t);if(Math.floor(t)!==t)return i.setUint8(o,203),i.setFloat64(o+1,t),9;if(0<=t){if(t<128)return i.setUint8(o,t),1;if(t<256)return i.setUint8(o,204),i.setUint8(o+1,t),2;if(t<65536)return i.setUint8(o,205),i.setUint16(o+1,t),3;if(t<4294967296)return i.setUint8(o,206),i.setUint32(o+1,t),5;throw new Error("Number too big 0x"+t.toString(16))}if(-32<=t)return i.setInt8(o,t),1;if(-128<=t)return i.setUint8(o,208),i.setInt8(o+1,t),2;if(-32768<=t)return i.setUint8(o,209),i.setInt16(o+1,t),3;if(-2147483648<=t)return i.setUint8(o,210),i.setInt32(o+1,t),5;throw new Error("Number too small -0x"+(-t).toString(16).substr(1))}if(null===t)return i.setUint8(o,192),1;if("boolean"==n)return i.setUint8(o,t?195:194),1;if("object"!=n)throw new Error("Unknown type "+n);var s=0,c=Array.isArray(t);if(c)r=t.length;else{var d=Object.keys(t);r=d.length}if(r<16?(i.setUint8(o,r|(c?144:128)),s=1):r<65536?(i.setUint8(o,c?220:222),i.setUint16(o+1,r),s=3):r<4294967296&&(i.setUint8(o,c?221:223),i.setUint32(o+1,r),s=5),c)for(var l=0;l<r;l++)s+=e(t[l],i,o+s);else for(l=0;l<r;l++){var u=d[l];s+=e(u,i,o+s),s+=e(t[u],i,o+s)}return s}(e,new DataView(t),0),new Uint8Array(t)}function s(e,t,i){return t?new e(t.buffer,t.byteOffset,t.byteLength/(i||1)):void 0}function u(e){return s(DataView,e)}function c(e){return s(Uint8Array,e)}function d(e){return s(Int8Array,e)}function l(e){return s(Int32Array,e,4)}function v(e,t){var i=e.length/2;t=t||new Int16Array(i);for(var o=0,n=0;o<i;++o,n+=2)t[o]=e[n]<<8^e[n+1]<<0;return t}function h(e,t){var i=e.length/4;t=t||new Int32Array(i);for(var o=0,n=0;o<i;++o,n+=4)t[o]=e[n]<<24^e[n+1]<<16^e[n+2]<<8^e[n+3]<<0;return t}function i(e,t){for(var i=e.length,o=u(t=t||new Uint8Array(4*i)),n=0;n<i;++n)o.setInt32(4*n,e[n]);return c(t)}function m(e,t,i){var o=e.length,n=1/t;i=i||new Float32Array(o);for(var r=0;r<o;++r)i[r]=e[r]*n;return i}function n(e,t,i){var o=e.length;i=i||new Int32Array(o);for(var n=0;n<o;++n)i[n]=Math.round(e[n]*t);return i}function g(e,t){var i,o;if(!t){var n=0;for(i=0,o=e.length;i<o;i+=2)n+=e[i+1];t=new e.constructor(n)}var r=0;for(i=0,o=e.length;i<o;i+=2)for(var a=e[i],s=e[i+1],c=0;c<s;++c)t[r]=a,++r;return t}function o(e){if(0===e.length)return new Int32Array;var t,i,o=2;for(t=1,i=e.length;t<i;++t)e[t-1]!==e[t]&&(o+=2);var n=new Int32Array(o),r=0,a=1;for(t=1,i=e.length;t<i;++t)e[t-1]!==e[t]?(n[r]=e[t-1],n[r+1]=a,a=1,r+=2):++a;return n[r]=e[e.length-1],n[r+1]=a,n}function y(e,t){var i=e.length;t=t||new e.constructor(i),i&&(t[0]=e[0]);for(var o=1;o<i;++o)t[o]=e[o]+t[o-1];return t}function r(e,t){var i=e.length;(t=t||new e.constructor(i))[0]=e[0];for(var o=1;o<i;++o)t[o]=e[o]-e[o-1];return t}function E(e,t){var i,o,n=e instanceof Int8Array?127:32767,r=-n-1,a=e.length;if(!t){var s=0;for(i=0;i<a;++i)e[i]<n&&e[i]>r&&++s;t=new Int32Array(s)}for(o=i=0;i<a;){for(var c=0;e[i]===n||e[i]===r;)c+=e[i],++i;c+=e[i],++i,t[o]=c,++o}return t}function _(e,t,i){return m(E(e,l(i)),t,i)}function b(e,t,i){var o,n,r,a=E(e,l(i));return n=t,r=s(Float32Array,o=a,4),m(y(o,l(r)),n,r)}function a(e,t,i){return function(e,t){var i,o=t?127:32767,n=-o-1,r=e.length,a=0;for(i=0;i<r;++i){0===(d=e[i])?++a:0<d?(a+=Math.ceil(d/o),d%o==0&&(a+=1)):(a+=Math.ceil(d/n),d%n==0&&(a+=1))}var s=new(t?Int8Array:Int16Array)(a),c=0;for(i=0;i<r;++i){var d;if(0<=(d=e[i]))for(;o<=d;)s[c]=o,++c,d-=o;else for(;d<=n;)s[c]=n,++c,d-=n;s[c]=d,++c}return s}(r(n(e,t),o),i);var o}function w(e,t,i,o){var n=new ArrayBuffer(12+o.byteLength),r=new Uint8Array(n),a=new DataView(n);return a.setInt32(0,e),a.setInt32(4,t),i&&r.set(i,8),r.set(o,12),r}function T(e){return w(2,e.length,void 0,c(e))}function x(e){return w(4,e.length,void 0,i(e))}function C(e,t){return w(5,e.length/t,i([t]),c(e))}function R(e){return w(6,e.length,void 0,i(o(e)))}function S(e){return w(8,e.length,void 0,i(o(r(e))))}function L(e,t){return w(9,e.length,i([t]),i(o(n(e,t))))}function A(e,t){return w(10,e.length,i([t]),function(e,t){for(var i=e.length,o=u(t=t||new Uint8Array(2*i)),n=0;n<i;++n)o.setInt16(2*n,e[n]);return c(t)}(a(e,t)))}function I(t){var i={};return z.forEach(function(e){void 0!==t[e]&&(i[e]=t[e])}),t.bondAtomList&&(i.bondAtomList=x(t.bondAtomList)),t.bondOrderList&&(i.bondOrderList=T(t.bondOrderList)),i.xCoordList=A(t.xCoordList,1e3),i.yCoordList=A(t.yCoordList,1e3),i.zCoordList=A(t.zCoordList,1e3),t.bFactorList&&(i.bFactorList=A(t.bFactorList,100)),t.atomIdList&&(i.atomIdList=S(t.atomIdList)),t.altLocList&&(i.altLocList=R(t.altLocList)),t.occupancyList&&(i.occupancyList=L(t.occupancyList,100)),i.groupIdList=S(t.groupIdList),i.groupTypeList=x(t.groupTypeList),t.secStructList&&(i.secStructList=T(t.secStructList)),t.insCodeList&&(i.insCodeList=R(t.insCodeList)),t.sequenceIndexList&&(i.sequenceIndexList=S(t.sequenceIndexList)),i.chainIdList=C(t.chainIdList,4),t.chainNameList&&(i.chainNameList=C(t.chainNameList,4)),i}function O(n){function o(e){for(var t={},i=0;i<e;i++){t[c()]=c()}return t}function r(e){var t=n.subarray(d,d+e);return d+=e,t}function a(e){var t=n.subarray(d,d+e);d+=e;if(65535<e){for(var i=[],o=0;o<t.length;o+=65535)i.push(String.fromCharCode.apply(null,t.subarray(o,o+65535)));return i.join("")}return String.fromCharCode.apply(null,t)}function s(e){for(var t=new Array(e),i=0;i<e;i++)t[i]=c();return t}function c(){var e,t,i=n[d];if(0==(128&i))return d++,i;if(128==(240&i))return d++,o(t=15&i);if(144==(240&i))return d++,s(t=15&i);if(160==(224&i))return d++,a(t=31&i);if(224==(224&i))return e=l.getInt8(d),d++,e;switch(i){case 192:return d++,null;case 194:return d++,!1;case 195:return d++,!0;case 196:return t=l.getUint8(d+1),d+=2,r(t);case 197:return t=l.getUint16(d+1),d+=3,r(t);case 198:return t=l.getUint32(d+1),d+=5,r(t);case 202:return e=l.getFloat32(d+1),d+=5,e;case 203:return e=l.getFloat64(d+1),d+=9,e;case 204:return e=n[d+1],d+=2,e;case 205:return e=l.getUint16(d+1),d+=3,e;case 206:return e=l.getUint32(d+1),d+=5,e;case 208:return e=l.getInt8(d+1),d+=2,e;case 209:return e=l.getInt16(d+1),d+=3,e;case 210:return e=l.getInt32(d+1),d+=5,e;case 217:return t=l.getUint8(d+1),d+=2,a(t);case 218:return t=l.getUint16(d+1),d+=3,a(t);case 219:return t=l.getUint32(d+1),d+=5,a(t);case 220:return t=l.getUint16(d+1),d+=3,s(t);case 221:return t=l.getUint32(d+1),d+=5,s(t);case 222:return t=l.getUint16(d+1),d+=3,o(t);case 223:return t=l.getUint32(d+1),d+=5,o(t)}throw new Error("Unknown type 0x"+i.toString(16))}var d=0,l=new DataView(n.buffer);return c()}function N(e,t,i,o){switch(e){case 1:return function(e,t){for(var i=e.length,o=u(t=t||new Float32Array(i/4)),n=u(e),r=0,a=0,s=i/4;r<s;++r,a+=4)o.setFloat32(a,n.getFloat32(a),!0);return t}(t);case 2:return d(t);case 3:return v(t);case 4:return h(t);case 5:return c(t);case 6:return g(h(t),new Uint8Array(i));case 7:return g(h(t));case 8:return y(g(h(t)),s);case 9:return n=h(t),r=h(o)[0],m(g(n,l(a)),r,a);case 10:return b(v(t),h(o)[0]);case 11:return m(v(t),h(o)[0]);case 12:return _(v(t),h(o)[0]);case 13:return _(d(t),h(o)[0]);case 14:return E(v(t));case 15:return E(d(t))}var n,r,a,s}function P(c,e){var d=(e=e||{}).ignoreFields,l={};return D.forEach(function(e){var t,i,o,n,r,a=!!d&&-1!==d.indexOf(e),s=c[e];a||void 0===s||(s instanceof Uint8Array?l[e]=N.apply(null,(i=u(t=s),o=i.getInt32(0),n=i.getInt32(4),r=t.subarray(8,12),[o,t=t.subarray(12),n,r])):l[e]=s)}),l}function W(e){return String.fromCharCode.apply(null,e).replace(/\0/g,"")}function M(e,t){return e instanceof ArrayBuffer&&(e=new Uint8Array(e)),P(e instanceof Uint8Array?O(e):e,t)}function H(e,t,i,o){var n=new XMLHttpRequest;n.addEventListener("load",function(){try{var e=M(n.response);i(e)}catch(e){o(e)}},!0),n.addEventListener("error",o,!0),n.responseType="arraybuffer",n.open("GET",t+e.toUpperCase()),n.send()}var z=["mmtfVersion","mmtfProducer","unitCell","spaceGroup","structureId","title","depositionDate","releaseDate","experimentalMethods","resolution","rFree","rWork","bioAssemblyList","ncsOperatorList","entityList","groupList","numBonds","numAtoms","numGroups","numChains","numModels","groupsPerChain","chainsPerModel"],D=z.concat(["xCoordList","yCoordList","zCoordList","groupIdList","groupTypeList","chainIdList","bFactorList","atomIdList","altLocList","occupancyList","secStructList","insCodeList","sequenceIndexList","chainNameList","bondAtomList","bondOrderList"]),j="//mmtf.rcsb.org/v1.0/",F=j+"full/",V=j+"reduced/";return e.encode=function(e){return t(I(e))},e.decode=M,e.traverse=function(e,t,i){var o,n,r,a,s,c,d=(i=i||{}).firstModelOnly,l=t.onModel,u=t.onChain,p=t.onGroup,f=t.onAtom,v=t.onBond,h=0,m=0,g=0,y=0,E=0,_=-1,b=e.chainNameList,w=e.secStructList,T=e.insCodeList,x=e.sequenceIndexList,C=e.atomIdList,R=e.bFactorList,S=e.altLocList,L=e.occupancyList,A=e.bondAtomList,I=e.bondOrderList;for(o=0,n=e.chainsPerModel.length;o<n&&!(d&&0<h);++o){var O=e.chainsPerModel[h];for(l&&l({chainCount:O,modelIndex:h}),r=0;r<O;++r){var N=e.groupsPerChain[m];if(u){var P=W(e.chainIdList.subarray(4*m,4*m+4)),M=null;b&&(M=W(b.subarray(4*m,4*m+4))),u({groupCount:N,chainIndex:m,modelIndex:h,chainId:P,chainName:M})}for(a=0;a<N;++a){var H=e.groupList[e.groupTypeList[g]],z=H.atomNameList.length;if(p){var D=null;w&&(D=w[g]);var j=null;e.insCodeList&&(j=String.fromCharCode(T[g]));var F=null;x&&(F=x[g]),p({atomCount:z,groupIndex:g,chainIndex:m,modelIndex:h,groupId:e.groupIdList[g],groupType:e.groupTypeList[g],groupName:H.groupName,singleLetterCode:H.singleLetterCode,chemCompType:H.chemCompType,secStruct:D,insCode:j,sequenceIndex:F})}for(s=0;s<z;++s){if(f){var V=null;C&&(V=C[y]);var U=null;R&&(U=R[y]);var k=null;S&&(k=String.fromCharCode(S[y]));var G=null;L&&(G=L[y]),f({atomIndex:y,groupIndex:g,chainIndex:m,modelIndex:h,atomId:V,element:H.elementList[s],atomName:H.atomNameList[s],formalCharge:H.formalChargeList[s],xCoord:e.xCoordList[y],yCoord:e.yCoordList[y],zCoord:e.zCoordList[y],bFactor:U,altLoc:k,occupancy:G})}y+=1}if(v){var B=H.bondAtomList;for(s=0,c=H.bondOrderList.length;s<c;++s)v({atomIndex1:y-z+B[2*s],atomIndex2:y-z+B[2*s+1],bondOrder:H.bondOrderList[s]})}g+=1}m+=1}if(E=_+1,_=y-1,v&&A)for(s=0,c=A.length;s<c;s+=2){var X=A[s],q=A[s+1];(E<=X&&X<=_||E<=q&&q<=_)&&v({atomIndex1:X,atomIndex2:q,bondOrder:I?I[s/2]:null})}h+=1}},e.fetch=function(e,t,i){H(e,F,t,i)},e.fetchReduced=function(e,t,i){H(e,V,t,i)},e.version="v1.0.1",e.fetchUrl=F,e.fetchReducedUrl=V,e.encodeMsgpack=t,e.encodeMmtf=I,e.decodeMsgpack=O,e.decodeMmtf=P,e}MMTF=initIcn3dpyMMTF(MMTF),function($,J){var o,r="__instance__",a="firstChild",s=setTimeout;function h(e){return void 0!==e}function ee(e){return"object"==typeof e}function c(e){return Object.keys(e).length}function te(e,t,i){return e<t?t:i<e?i:e}function t(e,t){return parseInt(e,t||10)}function p(e){return Math.round(e)}function ie(e){var t,i,o,n,r,a,s,c,d=+e[0],l=+e[1],u=+e[2];switch(a=u*(1-l),s=(s=u*(1-(r=6*d-(n=Math.floor(6*d)))*l))||0,c=(c=u*(1-(1-r)*l))||0,(n=n||0)%6){case 0:t=u,i=c,o=a;break;case 1:t=s,i=u,o=a;break;case 2:t=a,i=u,o=c;break;case 3:t=a,i=s,o=u;break;case 4:t=c,i=a,o=u;break;case 5:t=u,i=a,o=s}return[p(255*t),p(255*i),p(255*o)]}function oe(e){return i(ie(e))}function n(e){var t,i=+e[0],o=+e[1],n=+e[2],r=Math.max(i,o,n),a=Math.min(i,o,n),s=r-a,c=0===r?0:s/r,d=r/255;switch(r){case a:t=0;break;case i:t=o-n+s*(o<n?6:0),t/=6*s;break;case o:t=n-i+2*s,t/=6*s;break;case n:t=i-o+4*s,t/=6*s}return[t,c,d]}function i(e){var t=+e[2]|+e[1]<<8|+e[0]<<16;return(t="000000"+t.toString(16)).slice(-6)}function d(e){return n(l(e))}function l(e){return 3===e.length&&(e=e.replace(/./g,"$&$&")),[t(e[0]+e[1],16),t(e[2]+e[3],16),t(e[4]+e[5],16)]}function u(e){return[e[0]/360,e[1]/100,e[2]/100]}function f(e){return[p(360*e[0]),p(100*e[1]),p(100*e[2])]}function e(e){if(ee(e))return e;var t=/\s*rgb\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)\s*$/i.exec(e),i=/\s*hsv\s*\(\s*(\d+)\s*,\s*(\d+)%\s*,\s*(\d+)%\s*\)\s*$/i.exec(e);return"#"===e[0]&&e.match(/^#([\da-f]{3}|[\da-f]{6})$/i)?d(e.slice(1)):i?u([+i[1],+i[2],+i[3]]):t?n([+t[1],+t[2],+t[3]]):[0,1,1]}(o=$.CP=function(m,g,y){var E=J.body,u=J.documentElement,_=this,t=$.CP,i=!1,n={},b=J.createElement("div"),w="touchstart mousedown",T="touchmove mousemove",x="touchend mouseup",C="orientationchange resize";if(!(_ instanceof t))return new t(m,g);function R(e,t,i){for(var o=0,n=(e=e.split(/\s+/)).length;o<n;++o)t.addEventListener(e[o],i,!1)}function S(e,t,i){for(var o=0,n=(e=e.split(/\s+/)).length;o<n;++o)t.removeEventListener(e[o],i)}function L(e,t){var i="touches",o="clientX",n="clientY",r=t[i]?t[i][0][o]:t[o],a=t[i]?t[i][0][n]:t[n],s=p(e);return{x:r-s.l,y:a-s.t}}function p(e){var t,i,o;return i=e===$?(t=$.pageXOffset||u.scrollLeft,$.pageYOffset||u.scrollTop):(t=(o=e.getBoundingClientRect()).left,o.top),{l:t,t:i}}function A(e,t){for(;(e=e.parentElement)&&e!==t;);return e}function I(e){e&&e.preventDefault()}function O(e){return e===$?{w:$.innerWidth,h:$.innerHeight}:{w:e.offsetWidth,h:e.offsetHeight}}function N(e){return i||!!h(e)&&e}function P(e){i=e}function M(e,t,i){if(!h(n[e]))return _;if(h(i))h(n[e][i])&&n[e][i].apply(_,t);else for(var o in n[e])n[e][o].apply(_,t);return _}t[r][m.id||m.name||c(t[r])]=_,h(g)&&!0!==g||(g=w),P(t.parse(m.getAttribute("data-color")||m.value||[0,1,1])),b.className="color-picker",b.innerHTML='<div class="color-picker-control"><span class="color-picker-h"><i></i></span><span class="color-picker-sv"><i></i></span></div>';var H,e=b[a].children,z=N([0,1,1]),D=e[0],j=e[1],F=D[a],V=j[a],U=0,k=0,G=0,B=0,f=0,v=0,X=0,q=0,W=oe(z);function Y(e,t){e&&"h"!==e||M("change:h",t),e&&"sv"!==e||M("change:sv",t),M("change",t)}function Z(){return b.parentNode}function Q(e,t){e||((y||t||E).appendChild(b),_.visible=!0),X=O(b).w,q=O(b).h;var i=O(j),o=O(V),s=O(D).h,c=i.w,d=i.h,l=O(F).h,u=o.w,p=o.h;if(e){function n(e){var t=e.target,i=t===m||A(t,m)===m;i?Q():_.exit(),M(i?"enter":"exit",[_])}b.style.left=b.style.top="-9999px",!1!==g&&R(g,m,n),_.create=function(){return Q(1),M("create",[_]),_},_.destroy=function(){return!1!==g&&S(g,m,n),_.exit(),P(!1),M("destroy",[_]),_}}else K();function f(e){ie(z);var t=ie([z[0],1,1]);j.style.backgroundColor="rgb("+t.join(",")+")",P(z),I(e)}function r(e){var t,i,o,n,r,a;G&&(i=te(L(D,t=e).y,0,s),z[0]=(s-i)/s,F.style.top=i-l/2+"px",f(t),W=oe(z),U||(M("drag:h",[W,_]),M("drag",[W,_]),Y("h",[W,_]))),B&&(n=L(j,o=e),r=te(n.x,0,c),a=te(n.y,0,d),z[1]=1-(c-r)/c,z[2]=(d-a)/d,V.style.right=c-r-u/2+"px",V.style.top=a-p/2+"px",f(o),W=oe(z),k||(M("drag:sv",[W,_]),M("drag",[W,_]),Y("sv",[W,_]))),k=U=0}function a(e){var t=e.target,i=G?"h":"sv",o=[oe(z),_],n=t===m||A(t,m)===m,r=t===b||A(t,b)===b;n||r?r&&(M("stop:"+i,o),M("stop",o),Y(i,o)):Z()&&!1!==g&&(_.exit(),M("exit",[_]),Y(0,o)),B=G=0}function v(e){G=U=1,r(e),I(e),M("start:h",[W,_]),M("start",[W,_]),Y("h",[W,_])}function h(e){B=k=1,r(e),I(e),M("start:sv",[W,_]),M("start",[W,_]),Y("sv",[W,_])}H=function(){z=N(z),f(),F.style.top=s-l/2-s*z[0]+"px",V.style.right=c-u/2-c*z[1]+"px",V.style.top=d-p/2-d*z[2]+"px"},_.exit=function(e){return Z()&&(Z().removeChild(b),_.visible=!1),S(w,D,v),S(w,j,h),S(T,J,r),S(x,J,a),S(C,$,K),_},H(),e||(R(w,D,v),R(w,j,h),R(T,J,r),R(x,J,a),R(C,$,K))}function K(){return _.fit()}return Q(1),s(function(){var e=[oe(z),_];M("create",e),Y(0,e)},0),_.fit=function(e){var t=O($),i=O(u),o=t.w-i.w,n=t.h-u.clientHeight,r=p($),a=p(m);if(f=a.l+r.l,v=a.t+r.t+O(m).h,ee(e))h(e[0])&&(f=e[0]),h(e[1])&&(v=e[1]);else{var s=r.l,c=r.t,d=r.l+t.w-X-o,l=r.t+t.h-q-n;f=te(f,s,d)>>0,v=te(v,c,l)>>0}return b.style.left=f+"px",b.style.top=v+"px",M("fit",[_]),_},_.set=function(e){return h(e)?("string"==typeof e&&(e=t.parse(e)),P(e),H(),_):N()},_.get=function(e){return N(e)},_.target=m,_.picker=b,_.visible=!1,_.on=function(e,t,i){return h(e)?h(t)?(h(n[e])||(n[e]={}),h(i)||(i=c(n[e])),n[e][i]=t,_):n[e]:n},_.off=function(e,t){return h(e)?h(t)?delete n[e][t]:n[e]={}:n={},_},_.fire=M,_.hooks=n,_.enter=function(e){return Q(0,e)},_}).version="1.3.9",o[r]={},o.each=function(i,e){return s(function(){var e,t=o[r];for(e in t)i(t[e],e,t)},0===e?0:e||1),o},o.parse=e,o._HSV2RGB=ie,o._HSV2HEX=oe,o._RGB2HSV=n,o._HEX2HSV=d,o._HEX2RGB=function(e){return[(t=l(e))[0]/255,t[1]/255,t[2]/255];var t},o.HSV2RGB=function(e){return ie(u(e))},o.HSV2HEX=function(e){return oe(u(e))},o.RGB2HSV=function(e){return f(n(e))},o.RGB2HEX=i,o.HEX2HSV=function(e){return f(d(e))},o.HEX2RGB=l}(window,document);var saveAs=function(s){"use strict";if(!(void 0===s||"undefined"!=typeof navigator&&/MSIE [1-9]\./.test(navigator.userAgent))){var e=s.document,c=function(){return s.URL||s.webkitURL||s},d=e.createElementNS("http://www.w3.org/1999/xhtml","a"),l="download"in d,u=/constructor/i.test(s.HTMLElement)||s.safari,p=/CriOS\/[\d]+/.test(navigator.userAgent),f=s.setImmediate||s.setTimeout,v=function(e){f(function(){throw e},0)},h=function(e){setTimeout(function(){"string"==typeof e?c().revokeObjectURL(e):e.remove()},4e4)},m=function(e){return/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(e.type)?new Blob([String.fromCharCode(65279),e],{type:e.type}):e},o=function(e,i,t){t||(e=m(e));function o(){!function(e,t,i){for(var o=(t=[].concat(t)).length;o--;){var n=e["on"+t[o]];if("function"==typeof n)try{n.call(e,i||e)}catch(e){v(e)}}}(r,"writestart progress write writeend".split(" "))}var n,r=this,a="application/octet-stream"===(e?e.type:void 0);if(r.readyState=r.INIT,l)return n=n||c().createObjectURL(e),void f(function(){var e,t;d.href=n,d.download=i,e=d,t=new MouseEvent("click"),e.dispatchEvent(t),o(),h(n),r.readyState=r.DONE},0);!function(){if((p||a&&u)&&s.FileReader){var t=new FileReader;return t.onloadend=function(){var e=p?t.result:t.result.replace(/^data:[^;]*;/,"data:attachment/file;");s.open(e,"_blank")||(s.location.href=e),e=void 0,r.readyState=r.DONE,o()},t.readAsDataURL(e),r.readyState=r.INIT}(n=n||c().createObjectURL(e),a)?s.location.href=n:s.open(n,"_blank")||(s.location.href=n);r.readyState=r.DONE,o(),h(n)}()},t=o.prototype;return"undefined"!=typeof navigator&&navigator.msSaveOrOpenBlob?function(e,t,i){return t=t||e.name||"download",i||(e=m(e)),navigator.msSaveOrOpenBlob(e,t)}:(t.abort=function(){},t.readyState=t.INIT=0,t.WRITING=1,t.DONE=2,t.error=t.onwritestart=t.onprogress=t.onwrite=t.onabort=t.onerror=t.onwriteend=null,function(e,t,i){return new o(e,t||e.name||"download",i)})}}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this);!function(e){"use strict";var n=e.HTMLCanvasElement&&e.HTMLCanvasElement.prototype,l=e.Blob&&function(){try{return Boolean(new Blob)}catch(e){return!1}}(),u=l&&e.Uint8Array&&function(){try{return 100===new Blob([new Uint8Array(100)]).size}catch(e){return!1}}(),p=e.BlobBuilder||e.WebKitBlobBuilder||e.MozBlobBuilder||e.MSBlobBuilder,f=/^data:((.*?)(;charset=.*?)?)(;base64)?,/,r=(l||p)&&e.atob&&e.ArrayBuffer&&e.Uint8Array&&function(e){var t,i,o,n,r,a,s,c,d;if(!(t=e.match(f)))throw new Error("invalid data URI");for(i=t[2]?t[1]:"text/plain"+(t[3]||";charset=US-ASCII"),o=!!t[4],n=e.slice(t[0].length),r=(o?atob:decodeURIComponent)(n),a=new ArrayBuffer(r.length),s=new Uint8Array(a),c=0;c<r.length;c+=1)s[c]=r.charCodeAt(c);return l?new Blob([u?s:a],{type:i}):((d=new p).append(a),d.getBlob(i))};e.HTMLCanvasElement&&!n.toBlob&&(n.mozGetAsFile?n.toBlob=function(e,t,i){var o=this;setTimeout(function(){i&&n.toDataURL&&r?e(r(o.toDataURL(t,i))):e(o.mozGetAsFile("blob",t))})}:n.toDataURL&&r&&(n.toBlob=function(e,t,i){var o=this;setTimeout(function(){e(r(o.toDataURL(t,i)))})})),"function"==typeof define&&define.amd?define(function(){return r}):"object"==typeof module&&module.exports?module.exports=r:e.dataURLtoBlob=r}(window);
var icn3d=function(e){"use strict";class t{constructor(e){this.icn3dui=e}cloneHash(e){this.icn3dui;let t={};void 0===e&&(e={});for(let s in e)t[s]=e[s];return t}intHash(e,t){this.icn3dui;let s={};if(void 0===e&&(e={}),void 0===t&&(t={}),Object.keys(e).length<Object.keys(t).length)for(let i in e)void 0!==t&&t[i]&&(s[i]=e[i]);else for(let i in t)void 0!==e&&e[i]&&(s[i]=t[i]);return s}exclHash(e,t){void 0===e&&(e={}),void 0===t&&(t={});let s=this.icn3dui.hashUtilsCls.cloneHash(e);for(let e in s)void 0!==t&&t[e]&&delete s[e];return s}unionHash(e,t){return this.icn3dui.hashUtilsCls.unionHashInPlace(e,t)}unionHashInPlace(e,t){return this.icn3dui,void 0===e&&(e={}),void 0===t&&(t={}),$.extend(e,t),e}unionHashNotInPlace(e,t){return this.icn3dui,$.extend({},e,t)}intHash2Atoms(e,t,s){let i=this.icn3dui;return i.hashUtilsCls.hash2Atoms(i.hashUtilsCls.intHash(e,t),s)}exclHash2Atoms(e,t,s){let i=this.icn3dui;return i.hashUtilsCls.hash2Atoms(i.hashUtilsCls.exclHash(e,t),s)}unionHash2Atoms(e,t,s){let i=this.icn3dui;return i.hashUtilsCls.hash2Atoms(i.hashUtilsCls.unionHash(e,t),s)}hash2Atoms(e,t){this.icn3dui;let s={};for(let i in e)s[i]=t[i];return s}hashvalue2array(e){this.icn3dui;let t=[];for(let s in e)t.push(e[s]);return t}}class s{constructor(e){this.icn3dui=e,this.glycanHash={GLC:{c:"1E90FF",s:"sphere"},BGC:{c:"1E90FF",s:"sphere"},NAG:{c:"1E90FF",s:"cube"},NDG:{c:"1E90FF",s:"cube"},GCS:{c:"1E90FF",s:"cube"},PA1:{c:"1E90FF",s:"cube"},GCU:{c:"1E90FF",s:"cone"},BDP:{c:"1E90FF",s:"cone"},G6D:{c:"1E90FF",s:"cone"},DDA:{c:"1E90FF",s:"cylinder"},B6D:{c:"1E90FF",s:"cylinder"},XXM:{c:"1E90FF",s:"cylinder"},MAN:{c:"00FF00",s:"sphere"},BMA:{c:"00FF00",s:"sphere"},BM3:{c:"00FF00",s:"cube"},"95Z":{c:"00FF00",s:"cube"},MAV:{c:"00FF00",s:"cone"},BEM:{c:"00FF00",s:"cone"},RAM:{c:"00FF00",s:"cone"},RM4:{c:"00FF00",s:"cone"},TYV:{c:"00FF00",s:"cylinder"},ARA:{c:"00FF00",s:"cylinder"},ARB:{c:"00FF00",s:"cylinder"},KDN:{c:"00FF00",s:"cylinder"},KDM:{c:"00FF00",s:"cylinder"},"6PZ":{c:"00FF00",s:"cylinder"},GMH:{c:"00FF00",s:"cylinder"},BDF:{c:"00FF00",s:"cylinder"},GAL:{c:"FFFF00",s:"sphere"},GLA:{c:"FFFF00",s:"sphere"},NGA:{c:"FFFF00",s:"cube"},A2G:{c:"FFFF00",s:"cube"},X6X:{c:"FFFF00",s:"cube"},"1GN":{c:"FFFF00",s:"cube"},ADA:{c:"FFFF00",s:"cone"},GTR:{c:"FFFF00",s:"cone"},LDY:{c:"FFFF00",s:"cylinder"},KDO:{c:"FFFF00",s:"cylinder"},T6T:{c:"FFFF00",s:"cylinder"},GUP:{c:"A52A2A",s:"sphere"},GL0:{c:"A52A2A",s:"sphere"},LGU:{c:"A52A2A",s:"cone"},ABE:{c:"A52A2A",s:"cylinder"},XYS:{c:"A52A2A",s:"cylinder"},XYP:{c:"A52A2A",s:"cylinder"},SOE:{c:"A52A2A",s:"cylinder"},PZU:{c:"FF69B4",s:"cylinder"},RIP:{c:"FF69B4",s:"cylinder"},"0MK":{c:"FF69B4",s:"cylinder"},ALL:{c:"8A2BE2",s:"sphere"},AFD:{c:"8A2BE2",s:"sphere"},NAA:{c:"8A2BE2",s:"cube"},SIA:{c:"8A2BE2",s:"cylinder"},SIB:{c:"8A2BE2",s:"cylinder"},AMU:{c:"8A2BE2",s:"cylinder"},X0X:{c:"1E90FF",s:"cone"},X1X:{c:"1E90FF",s:"cone"},NGC:{c:"1E90FF",s:"cylinder"},NGE:{c:"1E90FF",s:"cylinder"},"4N2":{c:"A0522D",s:"sphere"},HSQ:{c:"A0522D",s:"cube"},IDR:{c:"A0522D",s:"cone"},MUR:{c:"A0522D",s:"cylinder"},FUC:{c:"FF0000",s:"cone"},FUL:{c:"FF0000",s:"cone"}},this.nucleotidesArray=["  G","  A","  T","  C","  U"," DG"," DA"," DT"," DC"," DU","G","A","T","C","U","DG","DA","DT","DC","DU"],this.ionsArray=["  K"," NA"," MG"," AL"," CA"," TI"," MN"," FE"," NI"," CU"," ZN"," AG"," BA","  F"," CL"," BR","  I","K","NA","MG","AL","CA","TI","MN","FE","NI","CU","ZN","AG","BA","F","CL","BR","I"],this.cationsTrimArray=["K","NA","MG","AL","CA","TI","MN","FE","NI","CU","ZN","AG","BA"],this.anionsTrimArray=["F","CL","BR","I"],this.ionCharges={K:1,NA:1,MG:2,AL:3,CA:2,TI:3,MN:2,FE:3,NI:2,CU:2,ZN:2,AG:1,BA:2},this.vdwRadii={H:1.08,HE:1.34,LI:1.75,BE:2.05,B:1.47,C:1.49,N:1.41,O:1.4,F:1.39,NE:1.68,NA:1.84,MG:2.05,AL:2.11,SI:2.07,P:1.92,S:1.82,CL:1.83,AR:1.93,K:2.05,CA:2.21,SC:2.16,TI:1.87,V:1.79,CR:1.89,MN:1.97,FE:1.94,CO:1.92,NI:1.84,CU:1.86,ZN:2.1,GA:2.08,GE:2.15,AS:2.06,SE:1.93,BR:1.98,KR:2.12,RB:2.16,SR:2.24,Y:2.19,ZR:1.86,NB:2.07,MO:2.09,TC:2.09,RU:2.07,RH:1.95,PD:2.02,AG:2.03,CD:2.3,IN:2.36,SN:2.33,SB:2.25,TE:2.23,I:2.23,XE:2.21,CS:2.22,BA:2.51,LA:2.4,CE:2.35,PR:2.39,ND:2.29,PM:2.36,SM:2.29,EU:2.33,GD:2.37,TB:2.21,DY:2.29,HO:2.16,ER:2.35,TM:2.27,YB:2.42,LU:2.21,HF:2.12,TA:2.17,W:2.1,RE:2.17,OS:2.16,IR:2.02,PT:2.09,AU:2.17,HG:2.09,TL:2.35,PB:2.32,BI:2.43,PO:2.29,AT:2.36,RN:2.43,FR:2.56,RA:2.43,AC:2.6,TH:2.37,PA:2.43,U:2.4,NP:2.21,PU:2.56,AM:2.56,CM:2.56,BK:2.56,CF:2.56,ES:2.56,FM:2.56},this.covalentRadii={H:.31,HE:.28,LI:1.28,BE:.96,B:.84,C:.76,N:.71,O:.66,F:.57,NE:.58,NA:1.66,MG:1.41,AL:1.21,SI:1.11,P:1.07,S:1.05,CL:1.02,AR:1.06,K:2.03,CA:1.76,SC:1.7,TI:1.6,V:1.53,CR:1.39,MN:1.39,FE:1.32,CO:1.26,NI:1.24,CU:1.32,ZN:1.22,GA:1.22,GE:1.2,AS:1.19,SE:1.2,BR:1.2,KR:1.16,RB:2.2,SR:1.95,Y:1.9,ZR:1.75,NB:1.64,MO:1.54,TC:1.47,RU:1.46,RH:1.42,PD:1.39,AG:1.45,CD:1.44,IN:1.42,SN:1.39,SB:1.39,TE:1.38,I:1.39,XE:1.4,CS:2.44,BA:2.15,LA:2.07,CE:2.04,PR:2.03,ND:2.01,PM:1.99,SM:1.98,EU:1.98,GD:1.96,TB:1.94,DY:1.92,HO:1.92,ER:1.89,TM:1.9,YB:1.87,LU:1.87,HF:1.75,TA:1.7,W:1.62,RE:1.51,OS:1.44,IR:1.41,PT:1.36,AU:1.36,HG:1.32,TL:1.45,PB:1.46,BI:1.48,PO:1.4,AT:1.5,RN:1.5,FR:2.6,RA:2.21,AC:2.15,TH:2.06,PA:2,U:1.96,NP:1.9,PU:1.87,AM:1.8,CM:1.69},this.atomColors={H:this.thr(16777215),He:this.thr(16761035),HE:this.thr(16761035),Li:this.thr(11674146),LI:this.thr(11674146),B:this.thr(65280),C:this.thr(13158600),N:this.thr(255),O:this.thr(15728640),F:this.thr(14329120),Na:this.thr(255),NA:this.thr(255),Mg:this.thr(2263842),MG:this.thr(2263842),Al:this.thr(8421520),AL:this.thr(8421520),Si:this.thr(14329120),SI:this.thr(14329120),P:this.thr(16753920),S:this.thr(16762930),Cl:this.thr(65280),CL:this.thr(65280),Ca:this.thr(8421520),CA:this.thr(8421520),Ti:this.thr(8421520),TI:this.thr(8421520),Cr:this.thr(8421520),CR:this.thr(8421520),Mn:this.thr(8421520),MN:this.thr(8421520),Fe:this.thr(16753920),FE:this.thr(16753920),Ni:this.thr(10824234),NI:this.thr(10824234),Cu:this.thr(10824234),CU:this.thr(10824234),Zn:this.thr(10824234),ZN:this.thr(10824234),Br:this.thr(10824234),BR:this.thr(10824234),Ag:this.thr(8421520),AG:this.thr(8421520),I:this.thr(10494192),Ba:this.thr(16753920),BA:this.thr(16753920),Au:this.thr(14329120),AU:this.thr(14329120)},this.defaultAtomColor=this.thr(13421772),this.stdChainColors=[this.thr(16711935),this.thr(255),this.thr(10053171),this.thr(65433),this.thr(16750848),this.thr(16737894),this.thr(3329330),this.thr(2003199),this.thr(16416882),this.thr(16753920),this.thr(52945),this.thr(16738740),this.thr(65280),this.thr(255),this.thr(16711680),this.thr(16776960),this.thr(65535),this.thr(16711935),this.thr(3978097),this.thr(4620980),this.thr(13458524),this.thr(16770229),this.thr(11529966),this.thr(15631086),this.thr(25600),this.thr(139),this.thr(9109504),this.thr(13468991),this.thr(35723),this.thr(9699539)],this.backgroundColors={black:this.thr(0),grey:this.thr(13421772),white:this.thr(16777215),transparent:this.thr(0)},this.residueColors={ALA:this.thr(13158600),ARG:this.thr(1334015),ASN:this.thr(56540),ASP:this.thr(15075850),CYS:this.thr(15132160),GLN:this.thr(56540),GLU:this.thr(15075850),GLY:this.thr(15461355),HIS:this.thr(8553170),ILE:this.thr(1016335),LEU:this.thr(1016335),LYS:this.thr(1334015),MET:this.thr(15132160),PHE:this.thr(3289770),PRO:this.thr(14456450),SER:this.thr(16422400),THR:this.thr(16422400),TRP:this.thr(11819700),TYR:this.thr(3289770),VAL:this.thr(1016335),ASX:this.thr(16738740),GLX:this.thr(16738740),G:this.thr(32768),A:this.thr(6324479),T:this.thr(16744448),C:this.thr(16711680),U:this.thr(16744448),DG:this.thr(32768),DA:this.thr(6324479),DT:this.thr(16744448),DC:this.thr(16711680),DU:this.thr(16744448)},this.residueArea={ALA:247,ARG:366,ASN:290,ASP:285,CYS:271,GLN:336,GLU:325,GLY:217,HIS:340,ILE:324,LEU:328,LYS:373,MET:346,PHE:366,PRO:285,SER:265,THR:288,TRP:414,TYR:387,VAL:293,ASX:290,GLX:336,G:520,A:507,T:515,C:467,U:482,DG:520,DA:507,DT:515,DC:467,DU:482},this.defaultResidueColor=this.thr(12492910),this.chargeColors={"  G":this.thr(16711680),"  A":this.thr(16711680),"  T":this.thr(16711680),"  C":this.thr(16711680),"  U":this.thr(16711680)," DG":this.thr(16711680)," DA":this.thr(16711680)," DT":this.thr(16711680)," DC":this.thr(16711680)," DU":this.thr(16711680),G:this.thr(16711680),A:this.thr(16711680),T:this.thr(16711680),C:this.thr(16711680),U:this.thr(16711680),DG:this.thr(16711680),DA:this.thr(16711680),DT:this.thr(16711680),DC:this.thr(16711680),DU:this.thr(16711680),ARG:this.thr(255),LYS:this.thr(255),ASP:this.thr(16711680),GLU:this.thr(16711680),HIS:this.thr(8421631),GLY:this.thr(8947848),PRO:this.thr(8947848),ALA:this.thr(8947848),VAL:this.thr(8947848),LEU:this.thr(8947848),ILE:this.thr(8947848),PHE:this.thr(8947848),SER:this.thr(8947848),THR:this.thr(8947848),ASN:this.thr(8947848),GLN:this.thr(8947848),TYR:this.thr(8947848),MET:this.thr(8947848),CYS:this.thr(8947848),TRP:this.thr(8947848)},this.hydrophobicColors={"  G":this.thr(16711680),"  A":this.thr(16711680),"  T":this.thr(16711680),"  C":this.thr(16711680),"  U":this.thr(16711680)," DG":this.thr(16711680)," DA":this.thr(16711680)," DT":this.thr(16711680)," DC":this.thr(16711680)," DU":this.thr(16711680),G:this.thr(16711680),A:this.thr(16711680),T:this.thr(16711680),C:this.thr(16711680),U:this.thr(16711680),DG:this.thr(16711680),DA:this.thr(16711680),DT:this.thr(16711680),DC:this.thr(16711680),DU:this.thr(16711680),ARG:this.thr(255),LYS:this.thr(255),ASP:this.thr(16711680),GLU:this.thr(16711680),HIS:this.thr(8421631),TRP:this.thr().setHSL(1/3,1,.5),PHE:this.thr().setHSL(1/3,1,.6945945945945946),TYR:this.thr().setHSL(1/3,1,.745945945945946),LEU:this.thr().setHSL(1/3,1,.5+.645/1.85),ILE:this.thr().setHSL(1/3,1,.5+.77/1.85),CYS:this.thr().setHSL(1/3,1,.5+.805/1.85),MET:this.thr().setHSL(1/3,1,.5+.81/1.85),GLY:this.thr().setHSL(1/6,1,.5+.285/.58),VAL:this.thr().setHSL(1/6,1,.5+.255/.58),SER:this.thr().setHSL(1/6,1,.8879310344827587),THR:this.thr().setHSL(1/6,1,.8793103448275862),ALA:this.thr().setHSL(1/6,1,.853448275862069),ASN:this.thr().setHSL(1/6,1,.6379310344827587),PRO:this.thr().setHSL(1/6,1,.6120689655172413),GLN:this.thr().setHSL(1/6,1,.5)},this.ssColors={helix:this.thr(16711680),sheet:this.thr(32768),coil:this.thr(6324479)},this.ssColors2={helix:this.thr(16711680),sheet:this.thr(16762880),coil:this.thr(6324479)},this.b62ResArray=["A","R","N","D","C","Q","E","G","H","I","L","K","M","F","P","S","T","W","Y","V","B","Z","X","*"],this.b62Matrix=[[4,-1,-2,-2,0,-1,-1,0,-2,-1,-1,-1,-1,-2,-1,1,0,-3,-2,0,-2,-1,0,-4],[-1,5,0,-2,-3,1,0,-2,0,-3,-2,2,-1,-3,-2,-1,-1,-3,-2,-3,-1,0,-1,-4],[-2,0,6,1,-3,0,0,0,1,-3,-3,0,-2,-3,-2,1,0,-4,-2,-3,3,0,-1,-4],[-2,-2,1,6,-3,0,2,-1,-1,-3,-4,-1,-3,-3,-1,0,-1,-4,-3,-3,4,1,-1,-4],[0,-3,-3,-3,9,-3,-4,-3,-3,-1,-1,-3,-1,-2,-3,-1,-1,-2,-2,-1,-3,-3,-2,-4],[-1,1,0,0,-3,5,2,-2,0,-3,-2,1,0,-3,-1,0,-1,-2,-1,-2,0,3,-1,-4],[-1,0,0,2,-4,2,5,-2,0,-3,-3,1,-2,-3,-1,0,-1,-3,-2,-2,1,4,-1,-4],[0,-2,0,-1,-3,-2,-2,6,-2,-4,-4,-2,-3,-3,-2,0,-2,-2,-3,-3,-1,-2,-1,-4],[-2,0,1,-1,-3,0,0,-2,8,-3,-3,-1,-2,-1,-2,-1,-2,-2,2,-3,0,0,-1,-4],[-1,-3,-3,-3,-1,-3,-3,-4,-3,4,2,-3,1,0,-3,-2,-1,-3,-1,3,-3,-3,-1,-4],[-1,-2,-3,-4,-1,-2,-3,-4,-3,2,4,-2,2,0,-3,-2,-1,-2,-1,1,-4,-3,-1,-4],[-1,2,0,-1,-3,1,1,-2,-1,-3,-2,5,-1,-3,-1,0,-1,-3,-2,-2,0,1,-1,-4],[-1,-1,-2,-3,-1,0,-2,-3,-2,1,2,-1,5,0,-2,-1,-1,-1,-1,1,-3,-1,-1,-4],[-2,-3,-3,-3,-2,-3,-3,-3,-1,0,0,-3,0,6,-4,-2,-2,1,3,-1,-3,-3,-1,-4],[-1,-2,-2,-1,-3,-1,-1,-2,-2,-3,-3,-1,-2,-4,7,-1,-1,-4,-3,-2,-2,-1,-2,-4],[1,-1,1,0,-1,0,0,0,-1,-2,-2,0,-1,-2,-1,4,1,-3,-2,-2,0,0,0,-4],[0,-1,0,-1,-1,-1,-1,-2,-2,-1,-1,-1,-1,-2,-1,1,5,-2,-2,0,-1,-1,0,-4],[-3,-3,-4,-4,-2,-2,-3,-2,-2,-3,-2,-3,-1,1,-4,-3,-2,11,2,-3,-4,-3,-2,-4],[-2,-2,-2,-3,-2,-1,-2,-3,2,-1,-1,-2,-1,3,-3,-2,-2,2,7,-1,-3,-2,-1,-4],[0,-3,-3,-3,-1,-2,-2,-3,-3,3,1,-2,1,-1,-2,-2,0,-3,-1,4,-3,-2,-1,-4],[-2,-1,3,4,-3,0,1,-1,0,-3,-4,0,-3,-3,-2,0,-1,-4,-3,-3,4,1,-1,-4],[-1,0,0,1,-3,3,4,-2,0,-3,-3,1,-1,-3,-1,0,-1,-3,-2,-2,1,4,-1,-4],[0,-1,-1,-1,-2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-2,0,0,-2,-1,-1,-1,-1,-1,-4],[-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,-4,1]]}thr(e){return this.icn3dui,new THREE.Color(e)}}class i{constructor(e){this.icn3dui=e}isIE(){return this.icn3dui,!!(window.navigator.userAgent.indexOf("MSIE ")>0||window.navigator.userAgent.match(/Trident.*rv\:11\./))}isMobile(){return this.icn3dui,/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(window.navigator.userAgent)}isMac(){return this.icn3dui,/Mac/i.test(window.navigator.userAgent)}isSessionStorageSupported(){return this.icn3dui,window.sessionStorage}hexToRgb(e,t){this.icn3dui;let s=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return s?{r:parseInt(s[1],16),g:parseInt(s[2],16),b:parseInt(s[3],16),a:t}:null}isCalphaPhosOnly(e){this.icn3dui;let t=!1,s=0,i=0;for(let t in e){if(!(s<50))break;"CA"!==e[t].name&&"P"!==e[t].name&&"O3'"!==e[t].name&&"O3*"!==e[t].name&&++i,++s}return i<.5*s&&(t=!0),t}hasCovalentBond(e,t){let s=this.icn3dui,i=s.parasCls.covalentRadii[e.elem.toUpperCase()]+s.parasCls.covalentRadii[t.elem.toUpperCase()],l=e.coord.x-t.coord.x,n=e.coord.y-t.coord.y,o=e.coord.z-t.coord.z;return l*l+n*n+o*o<1.3*i*i}residueName2Abbr(e){this.icn3dui;let t=e.indexOf(" ");switch(t>0&&(e=e.substr(0,t)),e){case"  A":return"A";case"  C":return"C";case"  G":return"G";case"  T":return"T";case"  U":return"U";case"  I":return"I";case" DA":return"A";case" DC":return"C";case" DG":return"G";case" DT":return"T";case" DU":return"U";case" DI":return"I";case"DA":return"A";case"DC":return"C";case"DG":return"G";case"DT":return"T";case"DU":return"U";case"DI":return"I";case"ALA":return"A";case"ARG":return"R";case"ASN":return"N";case"ASP":return"D";case"CYS":return"C";case"GLU":return"E";case"GLN":return"Q";case"GLY":return"G";case"HIS":return"H";case"ILE":return"I";case"LEU":return"L";case"LYS":return"K";case"MET":return"M";case"PHE":return"F";case"PRO":return"P";case"SER":return"S";case"THR":return"T";case"TRP":return"W";case"TYR":return"Y";case"VAL":return"V";case"SEC":return"U";case"HOH":case"WAT":return"O";default:return e.trim()}}residueAbbr2Name(e){if(this.icn3dui,e.length>1)return e;switch(e){case"A":return"ALA";case"R":return"ARG";case"N":return"ASN";case"D":return"ASP";case"C":return"CYS";case"E":return"GLU";case"Q":return"GLN";case"G":return"GLY";case"H":return"HIS";case"I":return"ILE";case"L":return"LEU";case"K":return"LYS";case"M":return"MET";case"F":return"PHE";case"P":return"PRO";case"S":return"SER";case"T":return"THR";case"W":return"TRP";case"Y":return"TYR";case"V":return"VAL";case"O":return"HOH";default:return e.trim()}}getJSONFromArray(e){this.icn3dui;let t="";for(let s=0,i=e.length;s<i;++s)t+=JSON.stringify(e[s]),s!=i-1&&(t+=", ");return t}checkFileAPI(){this.icn3dui,window.File&&window.FileReader&&window.FileList&&window.Blob||alert("The File APIs are not fully supported in this browser.")}getIdArray(e){this.icn3dui;let t=[];if(e){let s=e.indexOf("_"),i=e.lastIndexOf("_");t.push(e.substr(0,s)),t.push(e.substr(s+1,i-s-1)),t.push(e.substr(i+1))}return t}compResid(e,t,s){let i,l,n=this.icn3dui,o=e.split(","),r=t.split(",");"save1"==s?(i=n.utilsCls.getIdArray(o[0]),l=n.utilsCls.getIdArray(r[0])):"save2"==s&&(i=n.utilsCls.getIdArray(o[1]),l=n.utilsCls.getIdArray(r[1]));let a=i[0]+"_"+i[1],d=l[0]+"_"+l[1],c=parseInt(i[2]),h=parseInt(l[2]);return a>d?1:a<d?-1:a==d?c>h?1:c<h?-1:0:void 0}toggle(e,t,s,i){this.icn3dui;let l=[e,t];for(let e in l){let t=l[e];$("#"+t).toggleClass("ui-icon-plus"),$("#"+t).toggleClass("ui-icon-minus")}l=[e,t,s,i];for(let e in l){let t=l[e];$("#"+t).toggleClass("icn3d-shown"),$("#"+t).toggleClass("icn3d-hidden")}}setViewerWidthHeight(e){if(e.bNode)return e.htmlCls.WIDTH=400,void(e.htmlCls.HEIGHT=400);let t,s;e.htmlCls.WIDTH=$(window).width()-e.htmlCls.LESSWIDTH,e.htmlCls.HEIGHT=$(window).height()-e.htmlCls.EXTRAHEIGHT-e.htmlCls.LESSHEIGHT,void 0!==e.oriWidth&&-1===e.cfg.width.toString().indexOf("%")?(t=e.oriWidth,s=e.oriHeight):(t=$("#"+e.pre+"viewer").css("width"),s=$("#"+e.pre+"viewer").css("height"),void 0===t&&(t=e.htmlCls.WIDTH),void 0===s&&(s=e.htmlCls.HEIGHT),t=-1!==e.cfg.width.toString().indexOf("%")?$(window).width()*e.cfg.width.substr(0,e.cfg.width.toString().indexOf("%"))/100-e.htmlCls.LESSWIDTH:parseInt(e.cfg.width),s=-1!==e.cfg.height.toString().indexOf("%")?$(window).height()*e.cfg.height.substr(0,e.cfg.height.toString().indexOf("%"))/100-e.htmlCls.EXTRAHEIGHT-e.htmlCls.LESSHEIGHT:parseInt(e.cfg.height)),t&&e.htmlCls.WIDTH>t&&(e.htmlCls.WIDTH=t),s&&e.htmlCls.HEIGHT>s&&(e.htmlCls.HEIGHT=s)}}class l{constructor(e){this.icn3dui=e}onId(e,t,s){if(this.icn3dui,!(Object.keys(window).length<2)&&("#"==e.substr(0,1)&&(e=e.substr(1)),document.getElementById(e))){t.split(" ").forEach((t=>{document.getElementById(e).addEventListener(t,s)}))}}onIds(e,t,s){let i=this.icn3dui;Array.isArray(e)?e.forEach((e=>{i.myEventCls.onId(e,t,s)})):i.myEventCls.onId(e,t,s)}}class n{constructor(e){this.icn3dui=e}getRmsdSuprCls(e,t,s){let i,l,n,o,r,a,d,c,h,m,p,u,C,g=this.icn3dui,f=new Array(9),b=new THREE.Vector3,y=new THREE.Vector3,v=[],w=[],S=new Array(3),_=new Array(3),A=new Array(3),x=new Array(3),k=new Array(3),O=new Array(3);if(i=0,s<=1)return{rot:void 0,trans1:void 0,trans2:void 0,rmsd:999};for(l=0;l<s;l++)v.push(e[l].clone()),w.push(t[l].clone()),b.add(e[l]),y.add(t[l]);b.multiplyScalar(1/s),y.multiplyScalar(1/s);let H=b,R=y;for(l=0;l<s;l++)v[l].sub(b),w[l].sub(y);for(l=0,a=d=0;l<s;l++)a+=v[l].x*v[l].x+v[l].y*v[l].y+v[l].z*v[l].z,d+=w[l].x*w[l].x+w[l].y*w[l].y+w[l].z*w[l].z;a/=s,d/=s;let E=new Array(9);for(l=0;l<9;++l)E[l]=0;for(l=0;l<s;l++)E[0]+=v[l].x*w[l].x,E[1]+=v[l].x*w[l].y,E[2]+=v[l].x*w[l].z,E[3]+=v[l].y*w[l].x,E[4]+=v[l].y*w[l].y,E[5]+=v[l].y*w[l].z,E[6]+=v[l].z*w[l].x,E[7]+=v[l].z*w[l].y,E[8]+=v[l].z*w[l].z;for(l=0;l<9;++l)E[l]/=s;let I=g.rmsdSuprCls.getEigenVectors(E);return n=I.k,S=I.h1,_=I.h2,A=I.h3,x=I.k1,k=I.k2,O=I.k3,c=I.d1,h=I.d2,m=I.d3,o=I.flag,u=I.s,1!=n?(i=100,f[0]=1,f[1]=0,f[2]=0,f[3]=0,f[4]=1,f[5]=0,f[6]=0,f[7]=0,f[8]=1,{rot:f,trans1:H,trans2:R,rmsd:i}):(1==o?(x[0]=E[0]*S[0]+E[3]*S[1]+E[6]*S[2],x[1]=E[1]*S[0]+E[4]*S[1]+E[7]*S[2],x[2]=E[2]*S[0]+E[5]*S[1]+E[8]*S[2],r=Math.sqrt(c),x[0]/=r,x[1]/=r,x[2]/=r,k[0]=E[0]*_[0]+E[3]*_[1]+E[6]*_[2],k[1]=E[1]*_[0]+E[4]*_[1]+E[7]*_[2],k[2]=E[2]*_[0]+E[5]*_[1]+E[8]*_[2],r=Math.sqrt(h),k[0]/=r,k[1]/=r,k[2]/=r,O[0]=E[0]*A[0]+E[3]*A[1]+E[6]*A[2],O[1]=E[1]*A[0]+E[4]*A[1]+E[7]*A[2],O[2]=E[2]*A[0]+E[5]*A[1]+E[8]*A[2],r=Math.sqrt(m),O[0]/=r,O[1]/=r,O[2]/=r):2==o&&(S[0]=E[0]*x[0]+E[1]*x[1]+E[2]*x[2],S[1]=E[3]*x[0]+E[4]*x[1]+E[5]*x[2],S[2]=E[6]*x[0]+E[7]*x[1]+E[8]*x[2],r=Math.sqrt(c),S[0]/=r,S[1]/=r,S[2]/=r,_[0]=E[0]*k[0]+E[1]*k[1]+E[2]*k[2],_[1]=E[3]*k[0]+E[4]*k[1]+E[5]*k[2],_[2]=E[6]*k[0]+E[7]*k[1]+E[8]*k[2],r=Math.sqrt(h),_[0]/=r,_[1]/=r,_[2]/=r,A[0]=E[0]*O[0]+E[1]*O[1]+E[2]*O[2],A[1]=E[3]*O[0]+E[4]*O[1]+E[5]*O[2],A[2]=E[6]*O[0]+E[7]*O[1]+E[8]*O[2],r=Math.sqrt(m),A[0]/=r,A[1]/=r,A[2]/=r),u>0?(f[0]=x[0]*S[0]+k[0]*_[0]+O[0]*A[0],f[1]=x[0]*S[1]+k[0]*_[1]+O[0]*A[1],f[2]=x[0]*S[2]+k[0]*_[2]+O[0]*A[2],f[3]=x[1]*S[0]+k[1]*_[0]+O[1]*A[0],f[4]=x[1]*S[1]+k[1]*_[1]+O[1]*A[1],f[5]=x[1]*S[2]+k[1]*_[2]+O[1]*A[2],f[6]=x[2]*S[0]+k[2]*_[0]+O[2]*A[0],f[7]=x[2]*S[1]+k[2]*_[1]+O[2]*A[1],f[8]=x[2]*S[2]+k[2]*_[2]+O[2]*A[2]):(f[0]=x[0]*S[0]+k[0]*_[0]-O[0]*A[0],f[1]=x[0]*S[1]+k[0]*_[1]-O[0]*A[1],f[2]=x[0]*S[2]+k[0]*_[2]-O[0]*A[2],f[3]=x[1]*S[0]+k[1]*_[0]-O[1]*A[0],f[4]=x[1]*S[1]+k[1]*_[1]-O[1]*A[1],f[5]=x[1]*S[2]+k[1]*_[2]-O[1]*A[2],f[6]=x[2]*S[0]+k[2]*_[0]-O[2]*A[0],f[7]=x[2]*S[1]+k[2]*_[1]-O[2]*A[1],f[8]=x[2]*S[2]+k[2]*_[2]-O[2]*A[2]),c=Math.sqrt(c),h=Math.sqrt(h),m=Math.sqrt(m),C=c+h+u*m,p=a+d-2*C,i=p>0?Math.sqrt(p):void 0,{rot:f,trans1:H,trans2:R,rmsd:i})}eigen_values(e){let t,s,i,l,n,o,r,a,d,c,h,m,p,u,C,g,f,b,y,v;if(this.icn3dui,t=e[0],s=e[1],i=e[2],l=e[3],n=e[4],o=e[5],r=e[6],a=e[7],d=e[8],c=-(t+n+d),h=t*n+(t+n)*d-o*a-s*l-i*r,m=-t*n*d+t*o*a+s*l*d-s*o*r-i*l*a+i*n*r,p=-c*c/3+h,u=c*c*c/13.5-c*h/3+m,C=.25*u*u+p*p*p/27,C<0){let e,t;e=Math.sqrt(.25*u*u-C),t=Math.acos(-.5*u/e),b=2*Math.cbrt(e)*Math.cos(t/3)}else g=Math.cbrt(-.5*u+Math.sqrt(C)),f=Math.cbrt(-.5*u-Math.sqrt(C)),b=g+f;return b-=c/3,c+=b,m/=-b,y=.5*(-c+Math.sqrt(c*c-4*m)),v=.5*(-c-Math.sqrt(c*c-4*m)),y<v&&(C=v,v=y,y=v),b<y&&(C=y,y=b,b=C),y<v&&(C=v,v=y,y=v),{d1:b,d2:y,d3:v}}null_basis(e,t,s,i,l){let n,o,r,a,d,c,h,m,p,u,C,g,f,b,y,v,w,S;if(this.icn3dui,a=e[0],d=e[1],c=e[2],h=e[3],m=e[4],p=e[5],u=e[6],C=e[7],g=e[8],S=Math.abs(a),Math.abs(d)>S&&(S=Math.abs(d)),Math.abs(c)>S&&(S=Math.abs(c)),Math.abs(h)>S&&(S=Math.abs(h)),Math.abs(m)>S&&(S=Math.abs(m)),Math.abs(p)>S&&(S=Math.abs(p)),Math.abs(u)>S&&(S=Math.abs(u)),Math.abs(C)>S&&(S=Math.abs(C)),Math.abs(g)>S&&(S=Math.abs(g)),S<1e-10)return o=3,{k:o,v1:t,v2:s,v3:i};if(r=0,a/=S,d/=S,c/=S,h/=S,m/=S,p/=S,u/=S,C/=S,g/=S,Math.abs(a)<l&&Math.abs(h)<l&&Math.abs(u)<l)n=1,t[0]=1,t[1]=0,t[2]=0,Math.abs(d)<l&&Math.abs(m)<l&&Math.abs(C)<l?(n=2,s[0]=0,s[1]=1,s[2]=0,Math.abs(c)<l&&Math.abs(p)<l&&Math.abs(g)<l&&(n=3,i[0]=0,i[1]=0,i[2]=1)):(S=Math.abs(d),Math.abs(m)>S&&(w=a,a=h,h=w,w=d,d=m,m=w,w=c,c=p,p=w,S=Math.abs(d)),Math.abs(C)>S&&(w=a,a=u,u=w,w=d,d=C,C=w,w=c,c=g,g=w),y=p-m*c/d,v=g-C*c/d,Math.abs(y)<l&&Math.abs(v)<l&&(n=2,s[0]=0,s[1]=-c/d,s[2]=1,r=1));else if(S=Math.abs(a),Math.abs(d)>S&&(w=a,a=h,h=w,w=d,d=m,m=w,w=c,c=p,p=w,S=Math.abs(a)),Math.abs(c)>S&&(w=a,a=u,u=w,w=d,d=C,C=w,w=c,c=g,g=w),f=m-h*d/a,b=p-h*c/a,y=C-u*d/a,v=g-u*c/a,Math.abs(f)<l&&Math.abs(y)<l)n=1,t[0]=-d/a,t[1]=1,t[2]=0,Math.abs(b)<l&&Math.abs(v)<l&&(n=2,s[0]=-c/a,s[1]=0,s[2]=1,r=2);else{if(Math.abs(f)<Math.abs(y)&&(w=f,f=y,y=w,w=b,b=v,v=w),!(Math.abs(v-b*y/f)<l))return o=0,t[0]=0,t[1]=0,t[2]=0,{k:o,v1:t,v2:s,v3:i};n=1,t[0]=d/a*(b/f)-c/a,t[1]=-b/f,t[2]=1,r=3}return o=n,r>0&&(1==r?(a=s[0],d=s[1],c=s[2],w=Math.sqrt(a*a+d*d+c*c),s[0]=a/w,s[1]=d/w,s[2]=c/w):2==r?(a=t[0],d=t[1],c=t[2],h=s[0],m=s[1],p=s[2],w=a*h+d*m+c*p,Math.abs(w)>=l&&(s[0]=a+w*h,s[1]=d+w*m,s[2]=c+w*p,h=s[0],m=s[1],p=s[2]),w=Math.sqrt(a*a+d*d+c*c),t[0]=a/w,t[1]=d/w,t[2]=c/w,w=Math.sqrt(h*h+m*m+p*p),s[0]=h/w,s[1]=m/w,s[2]=p/w):(a=t[0],d=t[1],c=t[2],w=Math.sqrt(a*a+d*d+c*c),t[0]=a/w,t[1]=d/w,t[2]=c/w)),{k:o,v1:t,v2:s,v3:i}}getEigenForSelection(e,t){let s,i=this.icn3dui,l=new THREE.Vector3,n=[];for(s=0;s<t;s++)n.push(e[s]),l.add(e[s]);for(l.multiplyScalar(1/t),s=0;s<t;s++)n[s].sub(l);let o=new Array(9);for(s=0;s<9;++s)o[s]=0;for(s=0;s<t;s++)o[0]+=n[s].x*n[s].x,o[1]+=n[s].x*n[s].y,o[2]+=n[s].x*n[s].z,o[3]+=n[s].y*n[s].x,o[4]+=n[s].y*n[s].y,o[5]+=n[s].y*n[s].z,o[6]+=n[s].z*n[s].x,o[7]+=n[s].z*n[s].y,o[8]+=n[s].z*n[s].z;for(s=0;s<9;++s)o[s]/=t;return i.rmsdSuprCls.getEigenVectors(o)}getEigenVectors(e,t){let s,i,l,n,o,r,a,d=this.icn3dui,c=1e-8,h=new Array(9),m=new Array(3),p=new Array(3),u=new Array(3),C=new Array(3),g=new Array(3),f=new Array(3);l=e[0]*(e[4]*e[8]-e[5]*e[7]),l-=e[1]*(e[3]*e[8]-e[5]*e[6]),l+=e[2]*(e[3]*e[7]-e[4]*e[6]),a=l<0?-1:1;let b=new Array(3),y=new Array(3);for(let e=0;e<3;++e)b[e]=new THREE.Vector3,y[e]=new THREE.Vector3;b[0].x=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],b[0].y=e[0]*e[3]+e[1]*e[4]+e[2]*e[5],b[0].z=e[0]*e[6]+e[1]*e[7]+e[2]*e[8],b[1].x=b[0].y,b[1].y=e[3]*e[3]+e[4]*e[4]+e[5]*e[5],b[1].z=e[3]*e[6]+e[4]*e[7]+e[5]*e[8],b[2].x=b[0].z,b[2].y=b[1].z,b[2].z=e[6]*e[6]+e[7]*e[7]+e[8]*e[8],y[0].x=e[0]*e[0]+e[3]*e[3]+e[6]*e[6],y[0].y=e[0]*e[1]+e[3]*e[4]+e[6]*e[7],y[0].z=e[0]*e[2]+e[3]*e[5]+e[6]*e[8],y[1].x=y[0].y,y[1].y=e[1]*e[1]+e[4]*e[4]+e[7]*e[7],y[1].z=e[1]*e[2]+e[4]*e[5]+e[7]*e[8],y[2].x=y[0].z,y[2].y=y[1].z,y[2].z=e[2]*e[2]+e[5]*e[5]+e[8]*e[8],h[0]=b[0].x,h[1]=b[0].y,h[2]=b[0].z,h[3]=b[1].x,h[4]=b[1].y,h[5]=b[1].z,h[6]=b[2].x,h[7]=b[2].y,h[8]=b[2].z;let v=d.rmsdSuprCls.eigen_values(h);n=v.d1,o=v.d2,r=v.d3,i=1,h[0]-=n,h[4]-=n,h[8]-=n;let w=d.rmsdSuprCls.null_basis(h,m,p,u,c);return s=w.k,m=w.v1,p=w.v2,u=w.v3,t||(1==s&&(h[0]+=n-o,h[4]+=n-o,h[8]+=n-o,w=d.rmsdSuprCls.null_basis(h,p,u,m,c),s=w.k,p=w.v1,u=w.v2,m=w.v3,1==s&&(h[0]+=o-r,h[4]+=o-r,h[8]+=o-r,w=d.rmsdSuprCls.null_basis(h,u,m,p,c),s=w.k,u=w.v1,m=w.v2,p=w.v3)),1!=s&&(h[0]=y[0].x,h[1]=y[0].y,h[2]=y[0].z,h[3]=y[1].x,h[4]=y[1].y,h[5]=y[1].z,h[6]=y[2].x,h[7]=y[2].y,h[8]=y[2].z,i=2,h[0]-=n,h[4]-=n,h[8]-=n,w=d.rmsdSuprCls.null_basis(h,C,g,f,c),s=w.k,C=w.v1,g=w.v2,f=w.v3,1==s&&(h[0]+=n-o,h[4]+=n-o,h[8]+=n-o,w=d.rmsdSuprCls.null_basis(h,g,f,C,c),s=w.k,g=w.v1,f=w.v2,C=w.v3,1==s&&(h[0]+=o-r,h[4]+=o-r,h[8]+=o-r,w=d.rmsdSuprCls.null_basis(h,f,C,g,c),s=w.k,f=w.v1,C=w.v2,g=w.v3)))),{k:s,h1:m,h2:p,h3:u,k1:C,k2:g,k3:f,d1:n,d2:o,d3:r,flag:i,s:a}}}class o{constructor(e){this.icn3dui=e}subdivide(e,t,s,i,l,n,o,r){let a=this.icn3dui,d=[],c=[],h=[],m=new Array,p=void 0!==n?n.length:0,u=void 0!==o?o.length:0;p>0&&Math.abs(n[0].x-e[0].x)<=6&&Math.abs(n[0].y-e[0].y)<=6&&Math.abs(n[0].z-e[0].z)<=6?(m.push(n[0]),p=1):p=0,m.push(e[0]);for(let t=1,s=e.length-1;t<s;++t){let s=e[t],i=e[t+1];m.push(s.smoothen?s.clone().add(i).multiplyScalar(.5):s)}m.push(e[e.length-1]);let C=0;u>0&&Math.abs(o[0].x-e[e.length-1].x)<=6&&Math.abs(o[0].y-e[e.length-1].y)<=6&&Math.abs(o[0].z-e[e.length-1].z)<=6&&(m.push(o[0]),++C),u>1&&Math.abs(o[0].x-o[1].x)<=6&&Math.abs(o[0].y-o[1].y)<=6&&Math.abs(o[0].z-o[1].z)<=6&&(m.push(o[1]),++C);let g=[],f=[],b=[];r&&(C=u>0?u-1:0);let y;for(let e=-1,l=m.length,n=1/s;e<=l-3;++e){y=e-p;let o=m[-1===e?0:e],r=m[e+1],u=m[e+2],v=m[e===l-3?l-1:e+3],w=0,S=a.subdivideCls.getKnot(1,w,o,r),_=a.subdivideCls.getKnot(1,S,r,u),A=a.subdivideCls.getKnot(1,_,u,v);S-w<1e-4&&(S=w+1),_-S<1e-4&&(_=S+1),A-_<1e-4&&(A=_+1),e>-1&&(void 0===i||i[y+1])&&e>=-1+p&&e<=l-3-C+1&&(d=d.concat(g),c=c.concat(f),h=h.concat(b)),g=[],f=[],b=[];let x=(_-S)*n;for(let n=0;n<s;++n){let m=S+x*n,k=a.subdivideCls.getValueFromKnot(m,w,S,_,A,o.x,r.x,u.x,v.x),O=a.subdivideCls.getValueFromKnot(m,w,S,_,A,o.y,r.y,u.y,v.y),H=a.subdivideCls.getValueFromKnot(m,w,S,_,A,o.z,r.z,u.z,v.z);i?(e>=-1+p&&e<=l-3-C&&i[y+1]&&n<=parseInt(s/2)&&(d.push(new THREE.Vector3(k,O,H)),c.push(i[y+1]),h.push(t[y+1])),e>=-1+p&&e<=l-3-C+1&&i[y+2]&&n>parseInt(s/2)&&(g.push(new THREE.Vector3(k,O,H)),f.push(i[y+2]),b.push(t[y+2]))):e>=-1+p&&e<=l-3-C&&(d.push(new THREE.Vector3(k,O,H)),c.push(y+1),h.push(t[y+1]))}}i&&!i[y+1]||(d=d.concat(g),c=c.concat(f),h=h.concat(b),d.push(m[m.length-1-C]),c.push(m.length-1-C),h.push(t[m.length-1-C])),g=[],f=[],b=[],m=[];let v=[];return v.push(d),v.push(c),v.push(h),v}getKnot(e,t,s,i){return this.icn3dui,s.distanceTo(i)+t}getValueFromKnot(e,t,s,i,l,n,o,r,a){this.icn3dui;let d,c,h=(o-n)/(s-t),m=(r-o)/(i-s),p=(a-r)/(l-i),u=(s+i)*(s+i)-4*(t*s+i*l-t*l);return 0==u?(d=9999,c=9999):(d=6*(3*m*s+2*h*l+p*s-2*h*s-2*m*l-m*i-p*s)/u,c=6*(3*m*i+2*p*t+h*s-2*m*t-2*p*i-h*i-m*s)/u),m*(e-s)+o+((2*d+c)/6/(s-i)*(e-s)*(e-i)*(e-i)+(2*c+d)/6/(i-s)*(e-s)*(e-s)*(e-i))}}class r{constructor(e){this.icn3dui=e}passFloat32(e,t){let s=this.icn3dui,i=e.length;t||(t=new Uint8Array(4*i));let l=s.convertTypeCls.getDataView(t);for(let t=0;t<i;++t)l.setFloat32(4*t,e[t],!0);return s.convertTypeCls.getUint8View(t)}passInt8(e,t){let s=this.icn3dui,i=e.length;t||(t=new Uint8Array(1*i));let l=s.convertTypeCls.getDataView(t);for(let t=0;t<i;++t)l.setInt8(1*t,e[t],!0);return s.convertTypeCls.getUint8View(t)}passInt16(e,t){let s=this.icn3dui,i=e.length;t||(t=new Uint8Array(2*i));let l=s.convertTypeCls.getDataView(t);for(let t=0;t<i;++t)l.setInt16(2*t,e[t],!0);return s.convertTypeCls.getUint8View(t)}passInt32(e,t){let s=this.icn3dui,i=e.length;t||(t=new Uint8Array(4*i));let l=s.convertTypeCls.getDataView(t);for(let t=0;t<i;++t)l.setInt32(4*t,e[t],!0);return s.convertTypeCls.getUint8View(t)}getUint8View(e){return this.icn3dui.convertTypeCls.getView(Uint8Array,e)}getDataView(e){return this.icn3dui.convertTypeCls.getView(DataView,e)}getView(e,t,s){return this.icn3dui,t?new e(t.buffer,t.byteOffset,t.byteLength/(s||1)):void 0}getBlobFromBufferAndText(e,t){let s=this.icn3dui,i=new Uint8Array(e),l=new Uint8Array(t.length);for(let e=0;e<t.length;++e)l[e]=s.convertTypeCls.passInt8([t.charCodeAt(e)])[0];let n=[];return n.push(new Blob([i],{type:"application/octet-stream"})),n.push(new Blob([l],{type:"application/octet-stream"})),new Blob(n,{type:"image/png"})}}class a{constructor(e){this.icn3d=e}setCamera(){let e=this.icn3d;if(e.icn3dui,e.bControlGl&&!e.icn3dui.bNode){window.cam=e.cams[e.opts.camera.toLowerCase()];let t=e.maxD;if(window.cam===e.perspectiveCamera){let s=void 0!==e.biomtMatrices&&e.biomtMatrices.length*e.cnt>e.maxatomcnt;s?window.camMaxDFactor=1:void 0!==window.camMaxDFactorFog?window.camMaxDFactor=window.camMaxDFactorFog:window.camMaxDFactor=2,window.cam_z>0?window.cam.position.z=t*window.camMaxDFactor:window.cam.position.z=-t*window.camMaxDFactor,"yes"===e.opts.slab?s?window.cam.near=.1:void 0!==window.camMaxDFactorFog?window.cam.near=t*window.camMaxDFactorFog-10:window.cam.near=t*window.camMaxDFactor:window.cam.near=.1,window.cam.far=1e4,e.bControlGl&&!e.icn3dui.bNode?window.controls=new THREE.TrackballControls(window.cam,void 0,e):e.icn3dui.bNode?e.controls=new THREE.TrackballControls(e.cam,document,e):e.controls=new THREE.TrackballControls(e.cam,document.getElementById(e.id),e)}else window.cam===e.orthographicCamera&&(void 0!==e.biomtMatrices&&e.biomtMatrices.length*e.cnt>10*e.maxatomcnt?window.cam.right=e.maxD/2*1.5:window.cam.right=e.maxD/2*2.5,window.cam.left=-window.cam.right,window.cam.top=window.cam.right/e.container.whratio,window.cam.bottom=-window.cam.right/e.container.whratio,"yes"===e.opts.slab?window.cam.near=2*e.maxD:window.cam.near=0,window.cam.far=1e4,e.bControlGl&&!e.icn3dui.bNode?window.controls=new THREE.OrthographicTrackballControls(window.cam,void 0,e):e.icn3dui.bNode?e.controls=new THREE.OrthographicTrackballControls(e.cam,document,e):e.controls=new THREE.OrthographicTrackballControls(e.cam,document.getElementById(e.id),e));window.cam.updateProjectionMatrix()}e.cam=e.cams[e.opts.camera.toLowerCase()];let t=e.maxD;if(e.cam===e.perspectiveCamera){let s=void 0!==e.biomtMatrices&&e.biomtMatrices.length*e.cnt>e.maxatomcnt;s?e.camMaxDFactor=1:void 0!==e.camMaxDFactorFog?e.camMaxDFactor=e.camMaxDFactorFog:e.camMaxDFactor=2,e.cam_z>0?e.cam.position.z=t*e.camMaxDFactor:e.cam.position.z=-t*e.camMaxDFactor,"yes"===e.opts.slab?s?e.cam.near=.1:void 0!==e.camMaxDFactorFog?e.cam.near=t*e.camMaxDFactorFog-10:e.cam.near=t*e.camMaxDFactor:e.cam.near=.1,e.cam.far=1e4,e.bControlGl&&!e.icn3dui.bNode?window.controls=new THREE.TrackballControls(e.cam,void 0,e):e.icn3dui.bNode?e.controls=new THREE.TrackballControls(e.cam,document,e):e.controls=new THREE.TrackballControls(e.cam,document.getElementById(e.id),e)}else e.cam===e.orthographicCamera&&(void 0!==e.biomtMatrices&&e.biomtMatrices.length*e.cnt>10*e.maxatomcnt?e.cam.right=e.maxD/2*1.5:e.cam.right=e.maxD/2*2.5,e.cam.left=-e.cam.right,e.cam.top=e.cam.right/e.container.whratio,e.cam.bottom=-e.cam.right/e.container.whratio,"yes"===e.opts.slab?e.cam.near=2*e.maxD:e.cam.near=0,e.cam.far=1e4,e.bControlGl&&!e.icn3dui.bNode?window.controls=new THREE.OrthographicTrackballControls(e.cam,void 0,e):e.icn3dui.bNode?e.controls=new THREE.OrthographicTrackballControls(e.cam,document,e):e.controls=new THREE.OrthographicTrackballControls(e.cam,document.getElementById(e.id),e));e.cam.updateProjectionMatrix()}}class d{constructor(e){this.icn3d=e}applyCenterOptions(e){let t,s=this.icn3d;switch(s.icn3dui,void 0===e&&(e=s.opts),e.rotationcenter.toLowerCase()){case"molecule center":void 0!==s.center&&this.setRotationCenter(s.center);break;case"pick center":void 0!==s.pAtom&&this.setRotationCenter(s.pAtom.coord);break;case"display center":t=this.centerAtoms(s.dAtoms).center,this.setRotationCenter(t);break;case"highlight center":t=this.centerAtoms(s.hAtoms).center,this.setRotationCenter(t)}}setRotationCenter(e){this.icn3d.icn3dui,this.setCenter(e)}setCenter(e){let t=this.icn3d;t.icn3dui,t.mdl.position.set(0,0,0),t.mdlImpostor.position.set(0,0,0),t.mdl_ghost.position.set(0,0,0),t.mdl.position.sub(e),t.mdlImpostor.position.sub(e),t.mdl_ghost.position.sub(e)}centerSelection(e){let t=this.icn3d,s=t.icn3dui;if(t.opts.rotationcenter="highlight center",void 0===e&&(e=s.hashUtilsCls.hash2Atoms(t.hAtoms,t.atoms)),t._zoomFactor=1,t.mouseChange=new THREE.Vector2(0,0),t.quaternion=new THREE.Quaternion(0,0,0,1),Object.keys(e).length>1){let s=this.centerAtoms(e);t.center=s.center,this.setCenter(t.center),t.cameraCls.setCamera()}}centerAtoms(e){let t=this.icn3d;t.icn3dui;let s=new THREE.Vector3(9999,9999,9999),i=new THREE.Vector3(-9999,-9999,-9999),l=new THREE.Vector3,n=0;for(let o in e){let e=t.atoms[o].coord;l.add(e),s.min(e),i.max(e),++n}let o=i.distanceTo(s);return{center:l.multiplyScalar(1/n),maxD:o,pmin:s,pmax:i}}setWidthHeight(e,t){let s=this.icn3d;s.icn3dui,void 0===s.scaleFactor&&(s.scaleFactor=1),s.renderer.setSize(e*s.scaleFactor,t*s.scaleFactor),s.renderer.domElement.style.width=e*s.scaleFactor+"px",s.renderer.domElement.style.height=t*s.scaleFactor+"px",s.renderer.domElement.width=e*s.scaleFactor,s.renderer.domElement.height=t*s.scaleFactor,s.container.whratio=e/t}}class c{constructor(e){this.icn3d=e}setFog(e){let t=this.icn3d,s=t.icn3dui.parasCls.backgroundColors[t.opts.background.toLowerCase()];if(e){let e=t.applyCenterCls.centerAtoms(t.hAtoms);t.maxD=e.maxD,t.maxD<5&&(t.maxD=5)}let i=void 0!==t.biomtMatrices&&t.biomtMatrices.length*t.cnt>t.maxatomcnt;"yes"===t.opts.fog?"perspective"===t.opts.camera?i?(t.scene.fog=void 0,t.bSetFog=!1):(t.scene.fog=new THREE.Fog(s,2.5*t.maxD,4*t.maxD),t.bSetFog=!0,t.camMaxDFactorFog=3):"orthographic"===t.opts.camera&&(t.scene.fog=void 0,t.bSetFog=!1):(t.scene.fog=void 0,t.bSetFog=!1),e&&!i&&t.transformCls.zoominSelection()}}class h{constructor(e){this.icn3d=e}getFirstAtomObj(e){let t=this.icn3d;if(t.icn3dui,void 0===e||0===Object.keys(e).length)return;let s=Object.keys(e)[0];return t.atoms[s]}getFirstCalphaAtomObj(e){let t,s=this.icn3d;if(s.icn3dui,void 0!==e&&0!==Object.keys(e).length){for(let i in e)if("CA"==s.atoms[i].name){t=i;break}return void 0!==t?s.atoms[t]:this.getFirstAtomObj(e)}}getFirstAtomObjByName(e,t){let s,i=this.icn3d;if(i.icn3dui,void 0===e||0===Object.keys(e).length)return i.atoms[0];for(let l in e)if(i.atoms[l].name==t){s=l;break}return void 0!==s?i.atoms[s]:void 0}getLastAtomObj(e){let t=this.icn3d;if(t.icn3dui,void 0===e||0===Object.keys(e).length)return t.atoms[0];let s=Object.keys(e),i=s[s.length-1];return t.atoms[i]}getResiduesFromAtoms(e){let t=this.icn3d;t.icn3dui;let s={};for(let i in e){s[t.atoms[i].structure+"_"+t.atoms[i].chain+"_"+t.atoms[i].resi]=1}return s}getResiduesFromCalphaAtoms(e){let t=this.icn3d;t.icn3dui;let s={};for(let i in e)if("CA"==t.atoms[i].name&&t.proteins.hasOwnProperty(i)||!t.proteins.hasOwnProperty(i)){s[t.atoms[i].structure+"_"+t.atoms[i].chain+"_"+t.atoms[i].resi]=1}return s}getChainsFromAtoms(e){let t=this.icn3d;t.icn3dui;let s={};for(let i in e){let e=t.atoms[i];s[e.structure+"_"+e.chain]=1}return s}getAtomFromResi(e,t){let s=this.icn3d;if(s.icn3dui,s.residues.hasOwnProperty(e))for(let i in s.residues[e])if(s.atoms[i].name===t&&!s.atoms[i].het)return s.atoms[i]}getAtomCoordFromResi(e,t){this.icn3d.icn3dui;let s=this.getAtomFromResi(e,t);if(void 0!==s){return void 0!==s.coord2?s.coord2:s.coord}}}class m{constructor(e){this.icn3d=e}createStrip(e,t,s,i,l,n,o,r,a,d,c,h,m,p){let u=this.icn3d,C=u.icn3dui;if(!(u.icn3dui.bNode||e.length<2)){if(i=i||u.axisDIV,m&&u.bDoublecolor&&!u.bCalphaOnly){let e=!1,t=C.subdivideCls.subdivide(m,s,i,r,n,c,h,e);m=t[0],this.setCalphaDrawnCoord(m,i,a);for(let e=0,t=p.length;e<t;++e)p[e].normalize();p=C.subdivideCls.subdivide(p,s,i,r,n,c,h,e)[0],s=t[2]}else{if(!o){let l=!1,o=C.subdivideCls.subdivide(e,s,i,r,n,c,h,l),a=C.subdivideCls.subdivide(t,s,i,r,n,c,h,l);e=o[0],t=a[0],s=o[2]}if(e.length<2)return;this.setCalphaDrawnCoord(e,i,a)}if(1===n){let s=u.coilWidth/2,i=4,l=!1;if(void 0!==d){let n,o,r=[],a=[];for(let c=0,h=e.length;c<h;++c){if(n=d[c],n!==o&&parseInt(n)!==parseInt(o)+1&&void 0!==o||c===h-1){let e=new THREE.TubeGeometry(new THREE.CatmullRomCurve3(r),r.length,s,i,l),t=new THREE.Mesh(e,u.matShader);t.renderOrder=u.renderOrderPicking,u.mdl.add(t),u.prevHighlightObjects.push(t),e=null;let n=new THREE.TubeGeometry(new THREE.CatmullRomCurve3(a),a.length,s,i,l);t=new THREE.Mesh(n,u.matShader),t.renderOrder=u.renderOrderPicking,u.mdl.add(t),u.prevHighlightObjects.push(t),n=null,r=[],a=[]}r.push(e[c]),a.push(t[c]),o=n}r=[],a=[]}else{let n=new THREE.TubeGeometry(new THREE.CatmullRomCurve3(e),e.length,s,i,l),o=new THREE.Mesh(n,u.matShader);o.renderOrder=u.renderOrderPicking,u.mdl.add(o),u.prevHighlightObjects.push(o),n=null;let r=new THREE.TubeGeometry(new THREE.CatmullRomCurve3(t),t.length,s,i,l);o=new THREE.Mesh(r,u.matShader),o.renderOrder=u.renderOrderPicking,u.mdl.add(o),u.prevHighlightObjects.push(o),r=null}}else{let i,o,r,a,d,c=new THREE.BufferGeometry,h=[],m=[],p=[],C=0,g=0,f=0;for(let n=0,c=e.length;n<c;++n){o=e[n],r=t[n];for(let e=0;e<2;++e)h[C++]=o.x,h[C++]=o.y,h[C++]=o.z;for(let e=0;e<2;++e)h[C++]=r.x,h[C++]=r.y,h[C++]=r.z;n<c-1&&(i=t[n].clone().sub(e[n]).cross(e[n+1].clone().sub(e[n])).normalize().multiplyScalar(l)),a=e[n].clone().add(i),d=t[n].clone().add(i);for(let e=0;e<2;++e)h[C++]=a.x,h[C++]=a.y,h[C++]=a.z;for(let e=0;e<2;++e)h[C++]=d.x,h[C++]=d.y,h[C++]=d.z;for(let e=0;e<8;++e){let e=s[n]?s[n]:s[n-1]?s[n-1]:{r:0,g:0,b:0};m[g++]=e.r,m[g++]=e.g,m[g++]=e.b}}let b=[[0,2,-6,-8],[-4,-2,6,4],[7,3,-5,-1],[-3,-7,1,5]];for(let t=1,s=e.length;t<s;++t){let e=8*t;for(let t=0;t<4;++t)p[f++]=e+b[t][0],p[f++]=e+b[t][1],p[f++]=e+b[t][2],p[f++]=e+b[t][3],p[f++]=e+b[t][0],p[f++]=e+b[t][2]}let y,v=3,w=h.length/v-8;for(let t=0;t<4;++t){for(let e=0;e<v;++e)h[C++]=h[2*t*v+e];for(let e=0;e<v;++e)h[C++]=h[(w+2*t)*v+e];m[g++]=s[0].r,m[g++]=s[0].g,m[g++]=s[0].b;let i=s[e.length-1]?s[e.length-1]:s[e.length-2]?s[e.length-2]:{r:0,g:0,b:0};m[g++]=i.r,m[g++]=i.g,m[g++]=i.b}w+=8,p[f++]=w,p[f++]=w+2,p[f++]=w+6,p[f++]=w+4,p[f++]=w,p[f++]=w+6,p[f++]=w+1,p[f++]=w+5,p[f++]=w+7,p[f++]=w+3,p[f++]=w+1,p[f++]=w+7,c.setAttribute("position",new THREE.BufferAttribute(new Float32Array(h),v)),c.setAttribute("color",new THREE.BufferAttribute(new Float32Array(m),v)),c.setIndex(new THREE.BufferAttribute(new Uint32Array(p),1)),c.computeVertexNormals(),2===n?(y=new THREE.Mesh(c,new THREE.MeshPhongMaterial({transparent:!0,opacity:.5,specular:u.frac,shininess:u.shininess,emissive:u.emissive,vertexColors:THREE.FaceColors,side:THREE.DoubleSide})),u.mdl.add(y),u.prevHighlightObjects.push(y)):(y=new THREE.Mesh(c,new THREE.MeshPhongMaterial({specular:u.frac,shininess:u.shininess,emissive:u.emissive,vertexColors:THREE.FaceColors,side:THREE.DoubleSide})),u.mdl.add(y),u.objects.push(y))}e=null,t=null}}setCalphaDrawnCoord(e,t,s){let i=this.icn3d;i.icn3dui;let l=0;if(void 0!==s)for(let n=0,o=e.length;n<o;n+=t){let t=s[l];i.atoms.hasOwnProperty(t)&&(i.atoms[t].coord2=e[n].clone()),++l}}}class p{constructor(e){this.icn3d=e}createCurveSub(e,t,s,i,l,n,o,r,a,d,c,h){let m,p=this.icn3d,u=p.icn3dui;if(!p.icn3dui.bNode&&0!==e.length){if(i=i||5,o)m=e;else{let t=!0,n=u.subdivideCls.subdivide(e,s,i,r,l,c,h,t);m=n[0],s=n[2]}if(0!==m.length){if(p.stripCls.setCalphaDrawnCoord(m,i,a),1===l){let e=p.coilWidth/2,t=4,s=!1;if(m.length>1)if(void 0!==d){let i,l,n=[];for(let o=0,r=m.length;o<r;++o){if(i=d[o],i!==l&&parseInt(i)!==parseInt(l)+1&&void 0!==l||o===r-1){let i=new THREE.TubeGeometry(new THREE.CatmullRomCurve3(n),n.length,e,t,s),l=new THREE.Mesh(i,p.matShader);l.renderOrder=p.renderOrderPicking,p.mdl.add(l),p.prevHighlightObjects.push(l),i=null,n=[]}n.push(m[o]),l=i}n=[]}else{let i=new THREE.TubeGeometry(new THREE.CatmullRomCurve3(m),m.length,e,t,s),l=new THREE.Mesh(i,p.matShader);l.renderOrder=p.renderOrderPicking,p.mdl.add(l),p.prevHighlightObjects.push(l),i=null}}else{let e,i=new THREE.BufferGeometry,o=[],r=[],a=0;if(2===l&&n)for(let t=0;t<m.length;++t,a+=3)m[t].addScalar(.6),o[a]=m[t].x,o[a+1]=m[t].y,o[a+2]=m[t].z,e=u.parasCls.thr(s[t]),r[a]=e.r,r[a+1]=e.g,r[a+2]=e.b;else for(let t=0;t<m.length;++t,a+=3)o[a]=m[t].x,o[a+1]=m[t].y,o[a+2]=m[t].z,e=u.parasCls.thr(s[t]),r[a]=e.r,r[a+1]=e.g,r[a+2]=e.b;let d=3;i.setAttribute("position",new THREE.BufferAttribute(new Float32Array(o),d)),i.setAttribute("color",new THREE.BufferAttribute(new Float32Array(r),d));let c=new THREE.Line(i,new THREE.LineBasicMaterial({linewidth:t,vertexColors:!0}));p.mdl.add(c),2===l?p.prevHighlightObjects.push(c):p.objects.push(c)}m=null}}}}class u{constructor(e){this.icn3d=e}createCurveSubArrow(e,t,s,i,l,n,o,r,a,d,c,h,m,p,u){let C=this.icn3d;if(C.icn3dui,C.icn3dui.bNode)return;let g=[],f=[];g.push(e),f.push(r),this.prepareStrand(g,f,t,s,i,void 0,l,n,o,a,d,!1,c,h,m,p,u),g=[],f=[]}createStripArrow(e,t,s,i,l,n,o,r,a,d,c,h,m,p,u,C){let g=this.icn3d;if(g.icn3dui,g.icn3dui.bNode)return;let f=[],b=[];f.push(e),f.push(t),b.push(r),b.push(a),this.prepareStrand(f,b,void 0,s,i,l,n,void 0,o,d,c,!0,h,m,p,u,C),f=[],b=[]}prepareStrand(e,t,s,i,l,n,o,r,a,d,c,h,m,p,u,C,g){let f=this.icn3d,b=f.icn3dui;if(1===d.length)return;let y=i,v=!u,w=[];w.push(i[i.length-2]),w.push(i[i.length-1]),l=l||f.axisDIV;let S,_,A,x,k=2/(a-1),O={};for(let e=0,s=t.length;e<s;++e)O[e]=[];let H=b.subdivideCls.subdivide(d,i,l,void 0,void 0,C,g)[0];if(1===H.length)return;let R,E=[],I=void 0===u||u?d.length-2:d.length;for(R=0;R<I;++R){for(let s=0,i=t.length;s<i;++s)O[s].push(e[s][R]);E.push(i[R])}if(E.push(i[R]),void 0===u||u)for(let e=0,s=t.length;e<s;++e)S=k*t[e]-1,_=H.length-1-l,A=d.length-2,x=new THREE.Vector3(H[_].x+c[A].x*S,H[_].y+c[A].y*S,H[_].z+c[A].z*S),O[e].push(x);let D,T=[];for(let e=0,s=t.length;e<s;++e)D=b.subdivideCls.subdivide(O[e],E,l,m,o),O[e]=D[0],i=D[2],0===e&&(T=D[1]);if(h?v?f.bDoublecolor?f.stripCls.createStrip(O[0],O[1],y,l,n,o,!0,void 0,p,T,C,g,d,c):f.stripCls.createStrip(O[0],O[1],i,l,n,o,!0,void 0,p,T,C,g,d,c):f.stripCls.createStrip(O[0],O[1],i,l,n,o,!0,void 0,p,T,C,g):f.curveCls.createCurveSub(O[0],s,i,l,o,r,!0,void 0,p,T,C,g),void 0===u||u){E=[],T=[];for(let e=0,s=t.length;e<s;++e){O[e]=[];for(let s=l*(d.length-2),i=l*(d.length-1);m[parseInt(s/l)]&&s<i;s+=l){let i=parseInt(s/l);for(let n=0;n<l;++n){let o=k*t[e]-1;o=o*1.8*(l-n)/l;let r=parseInt(s/l),a=new THREE.Vector3(H[s+n].x+c[r].x*o,H[s+n].y+c[r].y*o,H[s+n].z+c[r].z*o);a.smoothen=!0,O[e].push(a),E.push(w[0]),0===e&&T.push(i)}}let s=0,i=H.length-1,n=d.length-1,o=new THREE.Vector3(H[i].x+c[n].x*s,H[i].y+c[n].y*s,H[i].z+c[n].z*s);o.smoothen=!0,O[e].push(o),E.push(w[1]),0===e&&T.push(i)}H=[],h?f.stripCls.createStrip(O[0],O[1],E,l,n,o,!0,void 0,void 0,T,C,g):f.curveCls.createCurveSub(O[0],s,E,l,o,r,!0,void 0,void 0,T,C,g)}for(let e in O){for(let t=0,s=O[e].length;t<s;++t)O[e][t]=null;O[e]=[]}O={}}}class C{constructor(e){this.icn3d=e}createRepresentationSub(e,t,s){let i=this.icn3d;if(i.icn3dui,!i.icn3dui.bNode)for(let i in e){let l=e[i];t&&t(l);for(let e in l.bonds){let t=this.icn3d.atoms[l.bonds[e]];void 0===t||t.serial<l.serial||t.chain===l.chain&&(t.resi===l.resi||"C"===l.name&&"N"===t.name||"O3'"===l.name&&"P"===t.name||"O3*"===l.name&&"P"===t.name||"SG"===l.name&&"SG"===t.name)&&s&&s(l,t)}}}}class g{constructor(e){this.icn3d=e}createBox(e,t,s,i,l,n){let o=this.icn3d,r=o.icn3dui;if(o.icn3dui.bNode)return;void 0===t&&(t=.8),void 0===s&&(s=!1),void 0===i&&(i=.8),n?void 0===l&&(l=o.hColor):void 0===l&&(l=e.color);let a=s?t:(r.parasCls.vdwRadii[e.elem.toUpperCase()]||t)*(i||1);this.createBox_base(e.coord,a,l,n)}createBox_base(e,t,s,i,l,n){let o,r=this.icn3d;r.icn3dui,r.icn3dui.bNode||(new THREE.BoxGeometry(1,1,1),o=i||n?new THREE.Mesh(r.boxGeometry,new THREE.MeshPhongMaterial({transparent:!0,opacity:.5,specular:r.frac,shininess:r.shininess,emissive:r.emissive,color:s})):new THREE.Mesh(r.boxGeometry,new THREE.MeshPhongMaterial({specular:r.frac,shininess:r.shininess,emissive:r.emissive,color:s})),o.scale.x=o.scale.y=o.scale.z=t,o.position.copy(e),r.mdl.add(o),i?r.prevHighlightObjects.push(o):l?r.prevOtherMesh.push(o):r.objects.push(o))}createBoxRepresentation_P_CA(e,t,s){let i=this.icn3d;if(i.icn3dui,i.icn3dui.bNode)return;let l=this;i.reprSubCls.createRepresentationSub(e,(function(e){"CA"!==e.name&&"O3'"!==e.name&&"O3*"!==e.name||l.createBox(e,void 0,void 0,t,void 0,s)}))}}class f{constructor(e){this.icn3d=e}createTube(e,t,s,i,l,n){let o=this.icn3d;if(o.icn3dui,o.icn3dui.bNode)return;let r,a,d,c,h,m=[],p=[],u=[],C=[],g=[],b=0,y=[];for(let n in e)if(c=e[n],c.name===t&&!c.het){if(0==b&&(d=c),b>0&&(r!==c.chain||Math.abs(c.coord.x-h.coord.x)>6||Math.abs(c.coord.y-h.coord.y)>6||Math.abs(c.coord.z-h.coord.z)>6||parseInt(a)+1<parseInt(c.resi)&&(Math.abs(c.coord.x-h.coord.x)>3||Math.abs(c.coord.y-h.coord.y)>3||Math.abs(c.coord.z-h.coord.z)>3))){if(2!==i){if(!isNaN(d.resi)&&!isNaN(h.resi)){let e=d.structure+"_"+d.chain+"_"+(parseInt(d.resi)-1).toString(),i=o.firstAtomObjCls.getAtomCoordFromResi(e,t);C=void 0!==i?[i]:[];let n=h.structure+"_"+h.chain+"_"+(parseInt(h.resi)+1).toString(),r=h.structure+"_"+h.chain+"_"+(parseInt(h.resi)+2).toString();if(o.residues.hasOwnProperty(n)){let e=o.firstAtomObjCls.getAtomFromResi(n,t);void 0!==e&&e.ssbegin&&(n=h.structure+"_"+h.chain+"_"+(parseInt(h.resi)+2).toString(),r=h.structure+"_"+h.chain+"_"+(parseInt(h.resi)+3).toString(),m.push(e.coord),l?u.push(f.getCustomtubesize(n)):u.push(this.getRadius(s,e)),p.push(e.color))}let a=o.firstAtomObjCls.getAtomCoordFromResi(n,t);void 0!==a&&g.push(a);let c=o.firstAtomObjCls.getAtomCoordFromResi(r,t);void 0!==c&&g.push(c)}y.push({pnts:m,colors:p,radii:u,prevone:C,nexttwo:g})}m=[],p=[],u=[],C=[],g=[],d=c,b=0}if(0==m.length&&!isNaN(c.resi)){let e=c.structure+"_"+c.chain+"_"+(parseInt(c.resi)-1).toString();o.residues.hasOwnProperty(e)&&(h=o.firstAtomObjCls.getAtomFromResi(e,t),void 0!==h&&h.ssend&&(m.push(h.coord),l?u.push(f.getCustomtubesize(e)):u.push(this.getRadius(s,h)),p.push(h.color)))}let e;m.push(c.coord),e=l?f.getCustomtubesize(c.structure+"_"+c.chain+"_"+c.resi):this.getRadius(s,c),u.push(e),p.push(c.color),1===b&&(p[p.length-2]=c.color),r=c.chain,a=c.resi;let n=1.2;2!==i||c.ssbegin||o.boxCls.createBox(c,void 0,void 0,n,void 0,i),++b,h=c}if(2!==i){if(C=[],void 0!==d&&!isNaN(d.resi)){let e=d.structure+"_"+d.chain+"_"+(parseInt(d.resi)-1).toString(),s=o.firstAtomObjCls.getAtomCoordFromResi(e,t);C=void 0!==s?[s]:[]}if(g=[],void 0!==c&&!isNaN(c.resi)){let e=c.structure+"_"+c.chain+"_"+(parseInt(c.resi)+1).toString(),s=o.firstAtomObjCls.getAtomCoordFromResi(e,t);void 0!==s&&g.push(s);let i=c.structure+"_"+c.chain+"_"+(parseInt(c.resi)+2).toString(),l=o.firstAtomObjCls.getAtomCoordFromResi(i,t);void 0!==l&&g.push(l)}y.push({pnts:m,colors:p,radii:u,prevone:C,nexttwo:g})}for(let e=0,t=y.length;e<t;++e){let t=y[e].pnts,s=y[e].colors,l=y[e].radii,o=y[e].prevone,r=y[e].nexttwo;this.createTubeSub(t,s,l,i,o,r,n)}y=[]}getCustomtubesize(e){let t=this.icn3d;t.icn3dui;let s=e.lastIndexOf("_"),i=e.substr(s+1),l=e.substr(0,s);return t.queryresi2score[l]&&t.queryresi2score[l].hasOwnProperty(i)?.01*t.queryresi2score[l][i]:t.coilWidth}createTubeSub(e,t,s,i,l,n,o){let r=this.icn3d,a=r.icn3dui;if(r.icn3dui.bNode)return;if(e.length<2)return;let d,c=r.tubeDIV,h=r.axisDIV,m=1/c,p=1/h,u=new THREE.BufferGeometry,C=[],g=[],f=[],b=0,y=0,v=0,w=a.subdivideCls.subdivide(e,t,h,void 0,void 0,l,n),S=w[0];t=w[2];let _,A=new THREE.Vector3;for(let e=0,i=S.length;e<i;++e){let l,n,o,r,h=(e-1)*p;if(0===e)l=s[0];else if(h%1==0)l=s[h];else{let e=Math.floor(h),t=h-e;l=s[e]*t+s[e+1]*(1-t)}e<i-1?(n=S[e].clone().sub(S[e+1]),o=new THREE.Vector3(0,-n.z,n.y).normalize().multiplyScalar(l),r=n.clone().cross(o).normalize().multiplyScalar(l),A.dot(o)<0&&(o.negate(),r.negate()),A=o,_=r):(o=A,r=_);for(let s=0;s<c;++s){let i=2*Math.PI*m*s,l=S[e].clone().add(o.clone().multiplyScalar(Math.cos(i))).add(r.clone().multiplyScalar(Math.sin(i)));C[b++]=l.x,C[b++]=l.y,C[b++]=l.z,d=e==t.length-1&&t.length>1?a.parasCls.thr(t[t.length-2]):a.parasCls.thr(t[e]),g[y++]=d.r,g[y++]=d.g,g[y++]=d.b}}let x,k=0;for(let e=0,t=S.length-1;e<t;++e){let e=0,t=3*k,s=new THREE.Vector3(C[t],C[t+1],C[t+2]);t=3*(k+c);let i=new THREE.Vector3(C[t],C[t+1],C[t+2]);t=3*(k+c+1);let l=new THREE.Vector3(C[t],C[t+1],C[t+2]),n=s.clone().sub(i).lengthSq(),o=s.clone().sub(l).lengthSq();n>o&&(n=o,e=1);for(let t=0;t<c;++t)f[v++]=k+t,f[v++]=k+(t+e)%c+c,f[v++]=k+(t+1)%c,f[v++]=k+(t+1)%c,f[v++]=k+(t+e)%c+c,f[v++]=k+(t+e+1)%c+c;k+=c}u.setAttribute("position",new THREE.BufferAttribute(new Float32Array(C),3)),u.setAttribute("color",new THREE.BufferAttribute(new Float32Array(g),3)),u.setIndex(new THREE.BufferAttribute(new Uint32Array(f),1)),u.computeVertexNormals(),2===i?(x=new THREE.Mesh(u,new THREE.MeshPhongMaterial({transparent:!0,opacity:.5,specular:r.frac,shininess:r.shininess,emissive:r.emissive,vertexColors:THREE.FaceColors,side:THREE.DoubleSide})),r.mdl.add(x)):1===i?(x=new THREE.Mesh(u,r.matShader),x.renderOrder=r.renderOrderPicking,r.mdl.add(x)):(x=new THREE.Mesh(u,new THREE.MeshPhongMaterial({specular:r.frac,shininess:r.shininess,emissive:r.emissive,vertexColors:THREE.FaceColors,side:THREE.DoubleSide})),r.mdl.add(x)),1===i||2===i?r.prevHighlightObjects.push(x):r.objects.push(x)}getRadius(e,t){let s=this.icn3d;s.icn3dui;let i=e;return i=e||(t.b>0&&t.b<=100?.01*t.b:t.b>100?1:s.coilWidth),i}}class b{constructor(e){this.icn3d=e}createStrand(e,t,s,i,l,n,o,r,a){let d=this.icn3d,c=d.icn3dui;if(d.icn3dui.bNode)return;let h=!!i,m={};m=d.bAllAtoms?e:this.getSSExpandedAtoms(e),2===a&&(i?(i=!1,t=null,s=null,l=null,n=null,r=void 0):(i=!0,t=2,s=void 0,l=void 0,n=void 0,r=d.ribbonthickness)),t=t||d.strandDIV,s=s||d.axisDIV,l=l||d.coilWidth,o=o||!1,n=n||d.helixSheetWidth;let p={};for(let e=0;e<t;++e)p[e]=[];let u,C,g,f=[],b=[],y=[],v=[],w=[],S=null,_=null,A=null,x=null,k=null,O=null,H=null,R=null,E=!1,I=null,D=null,T=null,P=null,F=null,M=!1,L=!1,N={};d.bCalphaOnly=c.utilsCls.isCalphaPhosOnly(m);let $={};for(let e in m){let t=m[e];$[t.structure+"_"+t.chain+"_"+t.resi]=1}let U=Object.keys($).length,q=0,B=Object.keys(d.hAtoms).length==Object.keys(d.atoms).length,j=[];for(let c in m)if(g=m[c],("O"===g.name||"CA"===g.name)&&!g.het&&("CA"===g.name&&(e.hasOwnProperty(c)&&("helix"!==g.ss&&"sheet"!==g.ss||g.ssend||g.ssbegin)&&(N[c]=g),S=g.coord,A=g.color,P=g.serial,j.push(g.serial)),"O"===g.name||d.bCalphaOnly&&"CA"===g.name)){null==S&&(S=g.coord,A=g.color,P=g.serial),"O"===g.name&&(_=g.coord);let c=!0;if(u!==g.chain&&(c=!1),g.ssend&&"sheet"===g.ss?M=!0:g.ssend&&"helix"===g.ss&&(L=!0),k){1===a||2===a?w.push(d.hColor):w.push(O),C="coil"!==R&&"coil"===g.ss||E&&g.ssbegin||"coil"===R?l:n;let s,i,r=4;"O"===g.name?(s=k.clone(),null!=x?s.sub(x):(x=k.clone(),j.length>r+1?(s=x.clone(),i=d.atoms[j[j.length-1-r-1]].coord.clone(),i.sub(s)):s=new THREE.Vector3(Math.random(),Math.random(),Math.random()))):d.bCalphaOnly&&"CA"===g.name&&(j.length>r+1?(s=x.clone(),i=d.atoms[j[j.length-1-r-1]].coord.clone(),i.sub(s)):s=new THREE.Vector3(Math.random(),Math.random(),Math.random())),s.normalize(),s.multiplyScalar(C),null!==H&&s.dot(H)<0&&s.negate(),H=s;for(let e=0,s=2/(t-1);e<t;++e){let t=s*e-1,i=new THREE.Vector3(x.x+H.x*t,x.y+H.y*t,x.z+H.z*t);o||"sheet"!==R||(i.smoothen=!0),p[e].push(i)}f.push(x),b.push(H),e.hasOwnProperty(D)?(y.push(T),v.push(F)):(y.push(0),v.push(0)),++q}let m=6,N=x&&Math.abs(S.x-x.x)>m||x&&Math.abs(S.y-x.y)>m||x&&Math.abs(S.z-x.z)>m;if((g.ssbegin||g.ssend||q===U-1||N)&&p[0].length>0&&c){let c="CA",m=[],u=[];if(isNaN(d.atoms[D].resi))m=[];else{let e=d.atoms[D].structure+"_"+d.atoms[D].chain+"_"+(parseInt(d.atoms[D].resi)-1).toString(),t=d.firstAtomObjCls.getAtomCoordFromResi(e,c);m=void 0!==t?[t]:[]}if(!isNaN(d.atoms[D].resi)){let e=d.atoms[D].structure+"_"+d.atoms[D].chain+"_"+(parseInt(d.atoms[D].resi)+1).toString(),t=d.firstAtomObjCls.getAtomCoordFromResi(e,c);void 0!==t&&u.push(t);let s=d.atoms[D].structure+"_"+d.atoms[D].chain+"_"+(parseInt(d.atoms[D].resi)+2).toString(),i=d.firstAtomObjCls.getAtomCoordFromResi(s,c);void 0!==i&&u.push(i)}if(!N){1===a||2===a?w.push(d.hColor):w.push(O),C=g.ssend&&"sheet"===g.ss?0:"coil"===R&&g.ssbegin||E&&g.ssbegin||"coil"===g.ss?l:n;let s,i,r=4;"O"===g.name?(s=_.clone(),s.sub(S)):d.bCalphaOnly&&"CA"===g.name&&(j.length>r?(s=S.clone(),i=d.atoms[j[j.length-1-r]].coord.clone(),i.sub(s)):s=new THREE.Vector3(Math.random(),Math.random(),Math.random())),s.normalize(),s.multiplyScalar(C),null!==H&&s.dot(H)<0&&s.negate(),H=s;for(let e=0,s=2/(t-1);e<t;++e){let t=s*e-1,i=new THREE.Vector3(S.x+H.x*t,S.y+H.y*t,S.z+H.z*t);o||"sheet"!==R||(i.smoothen=!0),p[e].push(i)}I=g.serial,f.push(S),b.push(H),e.hasOwnProperty(I)?(y.push(g.resi),v.push(P)):(y.push(0),v.push(0))}for(let e=0;!i&&e<t;++e)M?d.curveStripArrowCls.createCurveSubArrow(p[e],1,w,s,a,h,t,e,f,b,y,v,!0,m,u):L&&(B?d.curveCls.createCurveSub(p[e],1,w,s,a,h,!1,y,v,void 0,m,u):d.curveStripArrowCls.createCurveSubArrow(p[e],1,w,s,a,h,t,e,f,b,y,v,!1,m,u));if(i)if(M){let e=0,i=t-1;d.curveStripArrowCls.createStripArrow(p[0],p[t-1],w,s,r,a,t,e,i,f,b,y,v,!0,m,u)}else if(L)if(B)d.stripCls.createStrip(p[0],p[t-1],w,s,r,a,!1,y,v,void 0,m,u,f,b);else{let e=0,i=t-1;d.curveStripArrowCls.createStripArrow(p[0],p[t-1],w,s,r,a,t,e,i,f,b,y,v,!1,m,u)}else 2===a&&d.stripCls.createStrip(p[0],p[t-1],w,s,r,a,!1,y,v,void 0,m,u,f,b);for(let e=0;e<t;++e)p[e]=[];w=[],f=[],b=[],y=[],v=[],M=!1,L=!1}if(u!==g.chain&&p[0].length>0){let e="CA",l=[],n=[];if(isNaN(d.atoms[D].resi))l=[];else{let t=d.atoms[D].structure+"_"+d.atoms[D].chain+"_"+(parseInt(d.atoms[D].resi)-1).toString();d.firstAtomObjCls.getAtomCoordFromResi(t,e)}for(let e=0;!i&&e<t;++e)M?d.curveStripArrowCls.createCurveSubArrow(p[e],1,w,s,a,h,t,e,f,b,y,v,!0,l,n):L&&(B?d.curveCls.createCurveSub(p[e],1,w,s,a,h,!1,y,v,void 0,l,n):d.curveStripArrowCls.createCurveSubArrow(p[e],1,w,s,a,h,t,e,f,b,y,v,!1,l,n));if(i)if(M){let e=0,i=t-1;d.curveStripArrowCls.createStripArrow(p[0],p[t-1],w,s,r,a,t,e,i,f,b,y,v,!0,l,n)}else if(L)if(B)d.stripCls.createStrip(p[0],p[t-1],w,s,r,a,!1,y,v,void 0,l,n,f,b);else{let e=0,i=t-1;d.curveStripArrowCls.createStripArrow(p[0],p[t-1],w,s,r,a,t,e,i,f,b,y,v,!1,l,n)}for(let e=0;e<t;++e)p[e]=[];w=[],f=[],b=[],y=[],v=[],M=!1,L=!1}u=g.chain,g.resi,R=g.ss,E=g.ssend,D=g.serial,T=g.resi,F=P,x=S,k=g.coord,O=A}j=[],d.tubeCls.createTube(N,"CA",l,a),N={},p={}}getSSExpandedAtoms(e,t){let s,i,l,n,o,r,a,d,c=this.icn3d,h=c.icn3dui,m=0,p=Object.keys(e).length,u=h.hashUtilsCls.cloneHash(e);for(let C in e){if(s=e[C].structure+"_"+e[C].chain,i=e[C].resi,l=e[C],void 0===n&&(a=e[C]),s!==n&&void 0!==n||i!==o&&i!==parseInt(o)+1&&void 0!==o||m===p-1){s!==n&&void 0!==n||i!==o&&i!==parseInt(o)+1&&void 0!==o?d=r:m===p-1&&(d=l);let C=a.resi;if(!isNaN(a.resi)&&"coil"!==a.ss&&!a.ssbegin){for(let e=parseInt(a.resi)-1;e>0;--e){let t=a.structure+"_"+a.chain+"_"+e;if(!c.residues.hasOwnProperty(t))break;let s=c.firstAtomObjCls.getFirstCalphaAtomObj(c.residues[t]);if(s.ss===a.ss&&s.ssbegin){C=s.resi;break}}for(let e=C;e<a.resi;++e){let t=a.structure+"_"+a.chain+"_"+e;u=h.hashUtilsCls.unionHash(u,h.hashUtilsCls.hash2Atoms(c.residues[t],c.atoms))}}if(!isNaN(a.resi)&&3===c.pk&&1===t&&"coil"===a.ss){let t=a.structure+"_"+a.chain+"_"+(parseInt(a.resi)-1).toString();c.residues.hasOwnProperty(t)&&(u=h.hashUtilsCls.unionHash(u,h.hashUtilsCls.hash2Atoms(c.residues[t],c.atoms)),e=h.hashUtilsCls.unionHash(e,h.hashUtilsCls.hash2Atoms(c.residues[t],c.atoms)))}let g=d.resi;if(void 0!==d.ss&&"coil"!==d.ss&&!d.ssend&&!d.notshow){let e=c.firstAtomObjCls.getLastAtomObj(c.chains[d.structure+"_"+d.chain]).resi;for(let t=parseInt(d.resi)+1;t<=parseInt(e);++t){let e=d.structure+"_"+d.chain+"_"+t;if(!c.residues.hasOwnProperty(e))break;let s=c.firstAtomObjCls.getFirstCalphaAtomObj(c.residues[e]);if(s.ss===d.ss&&s.ssend){g=s.resi;break}}for(let e=parseInt(d.resi)+1;e<=parseInt(g);++e){let t=d.structure+"_"+d.chain+"_"+e;u=h.hashUtilsCls.unionHash(u,h.hashUtilsCls.hash2Atoms(c.residues[t],c.atoms))}}if(3===c.pk&&1===t&&"coil"===d.ss){let t=d.structure+"_"+d.chain+"_"+(parseInt(d.resi)+1).toString();c.residues.hasOwnProperty(t)&&(u=h.hashUtilsCls.unionHash(u,h.hashUtilsCls.hash2Atoms(c.residues[t],c.atoms)),e=h.hashUtilsCls.unionHash(e,h.hashUtilsCls.hash2Atoms(c.residues[t],c.atoms)))}d.notshow&&(d.notshow=void 0),a=l}n=s,o=i,r=l,++m}return u}}class y{constructor(e){this.icn3d=e}createBrick(e,t,s,i){let l=this.icn3d;if(l.icn3dui,l.icn3dui.bNode)return;let n=new THREE.CylinderGeometry(1,1,1,4,1),o=new THREE.Mesh(n,new THREE.MeshPhongMaterial({specular:l.frac,shininess:l.shininess,emissive:l.emissive,color:i}));o.position.copy(e).add(t).multiplyScalar(.5),o.matrixAutoUpdate=!1,o.lookAt(t.clone().sub(e)),o.updateMatrix(),o.matrix.multiply((new THREE.Matrix4).makeScale(s,s,e.distanceTo(t))).multiply((new THREE.Matrix4).makeRotationX(.5*Math.PI)),l.mdl.add(o)}}class v{constructor(e){this.icn3d=e}createLineRepresentation(e,t){let s=this.icn3d;if(s.icn3dui,s.icn3dui.bNode)return;let i=new THREE.BufferGeometry,l=[],n=[],o=0,r=0;s.reprSubCls.createRepresentationSub(e,void 0,(function(e,t){if(e.color===t.color)l[o++]=e.coord.x,l[o++]=e.coord.y,l[o++]=e.coord.z,l[o++]=t.coord.x,l[o++]=t.coord.y,l[o++]=t.coord.z,n[r++]=e.color.r,n[r++]=e.color.g,n[r++]=e.color.b,n[r++]=t.color.r,n[r++]=t.color.g,n[r++]=t.color.b;else{let s=e.coord.clone().add(t.coord).multiplyScalar(.5);l[o++]=e.coord.x,l[o++]=e.coord.y,l[o++]=e.coord.z,l[o++]=s.x,l[o++]=s.y,l[o++]=s.z,l[o++]=t.coord.x,l[o++]=t.coord.y,l[o++]=t.coord.z,l[o++]=s.x,l[o++]=s.y,l[o++]=s.z,n[r++]=e.color.r,n[r++]=e.color.g,n[r++]=e.color.b,n[r++]=e.color.r,n[r++]=e.color.g,n[r++]=e.color.b,n[r++]=t.color.r,n[r++]=t.color.g,n[r++]=t.color.b,n[r++]=t.color.r,n[r++]=t.color.g,n[r++]=t.color.b}}));if(i.setAttribute("position",new THREE.BufferAttribute(new Float32Array(l),3)),i.setAttribute("color",new THREE.BufferAttribute(new Float32Array(n),3)),2!==t){let e;1===t||(e=new THREE.LineSegments(i,new THREE.LineBasicMaterial({linewidth:s.linewidth,vertexColors:!0})),s.mdl.add(e)),1===t?s.prevHighlightObjects.push(e):s.objects.push(e)}else 2===t&&s.boxCls.createBoxRepresentation_P_CA(e,.8,t)}createConnCalphSidechain(e,t){let s=this.icn3d;if(s.icn3dui,s.icn3dui.bNode)return;let i={};for(let s in e){let l=e[s];if(!l.het&&l.style2===t){i[l.structure+"_"+l.chain+"_"+l.resi]=1}}let l=[],n=[];for(let e in i){let t=s.firstAtomObjCls.getFirstAtomObjByName(s.residues[e],"CA");if(void 0!==t)for(let e=0,i=t.bonds.length;e<i;++e){let i=s.atoms[t.bonds[e]];("HA"===i.name||"C"!==i.name&&"N"!==i.name&&"H"!==i.elem&&i.resi==t.resi)&&(l.push(t.coord),l.push(i.coord),n.push(t.color),n.push(i.color))}if(t=s.firstAtomObjCls.getFirstAtomObjByName(s.residues[e],"N"),void 0!==t)for(let e=0,i=t.bonds.length;e<i;++e){let i=s.atoms[t.bonds[e]];"H"===i.name&&(l.push(t.coord),l.push(i.coord),n.push(t.color),n.push(i.color))}}for(let e=0,i=l.length;e<i;e+=2)if("ball and stick"===t||"stick"===t){let i="stick"===t?s.cylinderRadius:.5*s.cylinderRadius;s.cylinderCls.createCylinder(l[e],l[e+1],i,n[e+1])}else if("lines"===t){let t=this.createSingleLine(l[e],l[e+1],n[e+1],!1,.5);s.mdl.add(t)}}createSingleLine(e,t,s,i,l){let n=this.icn3d;if(n.icn3dui,n.icn3dui.bNode)return;let o,r=new THREE.BufferGeometry,a=[];o=i?new THREE.LineDashedMaterial({linewidth:1,color:s,dashSize:l,gapSize:.5*l}):new THREE.LineBasicMaterial({linewidth:1,color:s}),a[0]=e.x,a[1]=e.y,a[2]=e.z,a[3]=t.x,a[4]=t.y,a[5]=t.z;r.setAttribute("position",new THREE.BufferAttribute(new Float32Array(a),3));let d=new THREE.LineSegments(r,o);return i&&d.computeLineDistances(),d}createLines(e){let t=this.icn3d,s=t.icn3dui;if(!t.icn3dui.bNode&&void 0!==e)for(let i in e){let l=e[i];for(let e=0,n=l.length;e<n;++e){let n=l[e],o=n.position1,r=n.position2,a=!!n.dashed&&n.dashed,d=.3,c=t.lineRadius,h="#"+n.color.replace(/\#/g,""),m=s.parasCls.thr(h);if(a){let e,s,l=o.distanceTo(r),n=parseInt(l/d),a=r.clone().sub(o).multiplyScalar(d/l);for(let l=0;l<n;++l)l%2==1&&(e=o.clone().add(a.clone().multiplyScalar(l)),s=o.clone().add(a.clone().multiplyScalar(l+1)),"stabilizer"==i?t.brickCls.createBrick(e,s,c,m):t.cylinderCls.createCylinder(e,s,c,m))}else"stabilizer"==i?t.brickCls.createBrick(o,r,c,m):t.cylinderCls.createCylinder(o,r,c,m)}}}}class w{constructor(e){this.icn3d=e}createSphere(e,t,s,i,l){let n=this.icn3d,o=n.icn3dui;if(n.icn3dui.bNode)return;void 0===t&&(t=.8),void 0===s&&(s=!1);let r=o.parasCls.vdwRadii[e.elem.toUpperCase()]||t;s&&(r=t,i=1),this.createSphereBase(e.coord,e.color,r,i,l)}createSphereBase(e,t,s,i,l,n){let o,r=this.icn3d,a=r.icn3dui;if(!r.icn3dui.bNode){if(void 0===i&&(i=1),2===l)i*=1.5,t=r.hColor,o=new THREE.Mesh(r.sphereGeometry,new THREE.MeshPhongMaterial({transparent:!0,opacity:.5,specular:r.frac,shininess:r.shininess,emissive:r.emissive,color:t})),o.scale.x=o.scale.y=o.scale.z=s*(i||1),o.position.copy(e),r.mdl.add(o);else if(1===l)o=new THREE.Mesh(r.sphereGeometry,r.matShader),o.scale.x=o.scale.y=o.scale.z=s*(i||1),o.position.copy(e),o.renderOrder=r.renderOrderPicking,r.mdl.add(o);else if(void 0===t&&(t=a.parasCls.defaultAtomColor),o=n?new THREE.Mesh(r.sphereGeometry,new THREE.MeshPhongMaterial({transparent:!0,opacity:.5,specular:r.frac,shininess:r.shininess,emissive:r.emissive,color:t})):new THREE.Mesh(r.sphereGeometry,new THREE.MeshPhongMaterial({specular:r.frac,shininess:r.shininess,emissive:r.emissive,color:t})),o.scale.x=o.scale.y=o.scale.z=s*(i||1),o.position.copy(e),r.bImpo&&!n){r.posArraySphere.push(e.x),r.posArraySphere.push(e.y),r.posArraySphere.push(e.z),r.colorArraySphere.push(t.r),r.colorArraySphere.push(t.g),r.colorArraySphere.push(t.b);let l=s*(i||1);r.radiusArraySphere.push(l),r.cnt<=r.maxatomcnt&&r.mdl_ghost.add(o)}else r.mdl.add(o);1===l||2===l?r.bImpo?r.cnt<=r.maxatomcnt&&r.prevHighlightObjects_ghost.push(o):r.prevHighlightObjects.push(o):r.bImpo?r.cnt<=r.maxatomcnt&&r.objects_ghost.push(o):r.objects.push(o)}}createSphereRepresentation(e,t,s,i,l){let n=this.icn3d;if(n.icn3dui,n.icn3dui.bNode)return;let o=this;n.reprSubCls.createRepresentationSub(e,(function(e){o.createSphere(e,t,s,i,l)}))}}class S{constructor(e){this.icn3d=e}createCylinder(e,t,s,i,l,n,o,r){let a,d=this.icn3d,c=d.icn3dui;d.icn3dui.bNode||(1===l?(a=new THREE.Mesh(d.cylinderGeometryOutline,d.matShader),a.position.copy(e).add(t).multiplyScalar(.5),a.matrixAutoUpdate=!1,a.lookAt(t.clone().sub(e)),a.updateMatrix(),a.matrix.multiply((new THREE.Matrix4).makeScale(s,s,e.distanceTo(t))).multiply((new THREE.Matrix4).makeRotationX(.5*Math.PI)),a.renderOrder=d.renderOrderPicking,d.mdl.add(a),d.prevHighlightObjects.push(a)):(2===l?(a=new THREE.Mesh(d.cylinderGeometry,new THREE.MeshPhongMaterial({transparent:!0,opacity:.5,specular:d.frac,shininess:d.shininess,emissive:d.emissive,color:i})),s*=1.5):a=r?new THREE.Mesh(d.cylinderGeometry,new THREE.MeshPhongMaterial({transparent:!0,opacity:.5,specular:d.frac,shininess:d.shininess,emissive:d.emissive,color:i})):new THREE.Mesh(d.cylinderGeometry,new THREE.MeshPhongMaterial({specular:d.frac,shininess:d.shininess,emissive:d.emissive,color:i})),a.position.copy(e).add(t).multiplyScalar(.5),a.matrixAutoUpdate=!1,a.lookAt(t.clone().sub(e)),a.updateMatrix(),a.matrix.multiply((new THREE.Matrix4).makeScale(s,s,e.distanceTo(t))).multiply((new THREE.Matrix4).makeRotationX(.5*Math.PI)),d.bImpo&&!r?(d.posArray.push(e.x),d.posArray.push(e.y),d.posArray.push(e.z),i||(i=c.parasCls.thr(16777215)),d.colorArray.push(i.r),d.colorArray.push(i.g),d.colorArray.push(i.b),d.pos2Array.push(t.x),d.pos2Array.push(t.y),d.pos2Array.push(t.z),void 0!==n?(d.color2Array.push(n.r),d.color2Array.push(n.g),d.color2Array.push(n.b)):(d.color2Array.push(i.r),d.color2Array.push(i.g),d.color2Array.push(i.b)),d.radiusArray.push(s),d.cnt<=d.maxatomcnt&&d.mdl_ghost.add(a)):d.mdl.add(a),2===l?d.bImpo?d.cnt<=d.maxatomcnt&&d.prevHighlightObjects_ghost.push(a):d.prevHighlightObjects.push(a):d.bImpo?d.cnt<=d.maxatomcnt&&d.objects_ghost.push(a):(void 0===o||o)&&d.objects.push(a)))}createCylinder_base(e,t,s,i,l,n,o){let r=this.icn3d;if(r.icn3dui,r.icn3dui.bNode)return;let a=new THREE.Mesh(r.cylinderGeometry,new THREE.MeshPhongMaterial({specular:r.frac,shininess:r.shininess,emissive:r.emissive,color:i}));return a.position.copy(e).add(t).multiplyScalar(.5),a.matrixAutoUpdate=!1,a.lookAt(t.clone().sub(e)),a.updateMatrix(),a.matrix.multiply((new THREE.Matrix4).makeScale(s,s,e.distanceTo(t))).multiply((new THREE.Matrix4).makeRotationX(.5*Math.PI)),a}createCylinderHelix(e,t,s){let i=this.icn3d;if(i.icn3dui,i.icn3dui.bNode)return;let l,n,o,r=null,a={},d={};for(o in e){let c=e[o];c.het||(("helix"!==c.ss&&"sheet"!==c.ss||c.ssend||c.ssbegin)&&(a[c.serial]=c),"sheet"===c.ss&&(d[c.serial]=c),"CA"===c.name&&("helix"===c.ss&&c.ssend&&(null!==r&&l===c.chain&&n<c.resi&&(1===s||2===s?this.createCylinder(r.coord,c.coord,t,i.hColor,s):this.createCylinder(r.coord,c.coord,t,c.color)),r=null),null===r&&"helix"===c.ss&&c.ssbegin&&(r=c,l=c.chain,n=c.resi)))}1===s||2===s?(Object.keys(a).length>0&&i.tubeCls.createTube(a,"CA",i.coilWidth,s),Object.keys(d).length>0&&i.strandCls.createStrand(d,void 0,void 0,!0,0,i.helixSheetWidth,!1,2*i.ribbonthickness,s)):(Object.keys(a).length>0&&i.tubeCls.createTube(a,"CA",i.coilWidth),Object.keys(d).length>0&&i.strandCls.createStrand(d,void 0,void 0,!0,0,i.helixSheetWidth,!1,2*i.ribbonthickness))}createCylinderCurve(e,t,s,i,l){let n=this.icn3d;if(n.icn3dui,n.icn3dui.bNode)return;let o,r,a,d,c=null;for(a in e)if(d=e[a],!d.het&&-1!=t.indexOf(d.name)){if(null!==c&&o===d.chain&&r!=d.resi&&Math.abs(c.coord.x-d.coord.x)<8&&Math.abs(c.coord.y-d.coord.y)<8&&Math.abs(c.coord.z-d.coord.z)<8){let e=c.coord.clone().add(d.coord).multiplyScalar(.5);if(l)1===l&&(this.createCylinder(c.coord,e,s,c.color,l),this.createCylinder(e,d.coord,s,d.color,l),n.sphereCls.createSphere(d,s,!0,1,l));else if(i){let t=n.lineCls.createSingleLine(c.coord,e,c.color,!1);n.mdl.add(t),n.objects.push(t),t=n.lineCls.createSingleLine(e,d.coord,d.color,!1),n.mdl.add(t),n.objects.push(t)}else this.createCylinder(c.coord,e,s,c.color),this.createCylinder(e,d.coord,s,d.color),n.sphereCls.createSphere(d,s,!0,1,l)}c=d,o=d.chain,r=d.resi,n.sphereCls.createSphere(d,s,!0,1,l),2===l&&n.boxCls.createBox(d,void 0,void 0,void 0,void 0,l)}if(null!==c&&o===d.chain&&r!=d.resi&&Math.abs(c.coord.x-d.coord.x)<8&&Math.abs(c.coord.y-d.coord.y)<8&&Math.abs(c.coord.z-d.coord.z)<8){let e=c.coord.add(d.coord).multiplyScalar(.5);if(l)1===l&&(this.createCylinder(c.coord,e,s,c.color,l),this.createCylinder(e,d.coord,s,d.color,l),n.sphereCls.createSphere(d,s,!0,1,l));else if(i){let t=n.lineCls.createSingleLine(c.coord,e,c.color,!1);n.mdl.add(t),n.objects.push(t),t=n.lineCls.createSingleLine(e,d.coord,d.color,!1),n.mdl.add(t),n.objects.push(t)}else this.createCylinder(c.coord,e,s,c.color),this.createCylinder(e,d.coord,s,d.color)}}}class _{constructor(e){this.icn3d=e}applyClbondsOptions(e){let t=this.icn3d,s=t.icn3dui;if(void 0===e&&(e=t.opts),t.bCalcCrossLink||(t.clbondpnts={},t.clbondResid2serial={},this.applyClbondsOptions_base("chemical"),this.applyClbondsOptions_base("all"),t.bCalcCrossLink=!0),"yes"===e.clbonds.toLowerCase()&&"nothing"!==e.chemicals){let e="#006400",i=s.parasCls.thr(25600);if(t.lines.clbond=[],t.residuesHashClbonds={},t.structures){let l=Object.keys(t.structures);for(let n=0,o=l.length;n<o;++n){let o=l[n];if(t.clbondpnts[o])for(let l=0,n=t.clbondpnts[o].length;l<n;l+=2){let n=t.clbondpnts[o][l],r=t.clbondpnts[o][l+1],a={};if(a.color=e,a.dashed=!1,a.serial1=t.clbondResid2serial[n+","+r],a.serial2=t.clbondResid2serial[r+","+n],!t.dAtoms.hasOwnProperty(a.serial1)||!t.dAtoms.hasOwnProperty(a.serial2))continue;a.position1=t.atoms[a.serial1].coord,a.position2=t.atoms[a.serial2].coord,t.lines.clbond.push(a),t.cylinderCls.createCylinder(a.position1,a.position2,t.cylinderRadius,i);let d={};d=s.hashUtilsCls.unionHash(d,t.residues[n]),d=s.hashUtilsCls.unionHash(d,t.residues[r]);let c=s.hashUtilsCls.intHash(d,t.sidec);for(let e in c)t.atoms[e].style2="stick";t.residuesHashClbonds[n]=1,t.residuesHashClbonds[r]=1}}}}return t.residuesHashClbonds}applyClbondsOptions_base(e){let t=this.icn3d;t.icn3dui;for(let s in t.chemicals){let i=t.atoms[s],l=i.structure+"_"+i.chain+"_"+i.resi;for(let s in i.bonds){let n=t.atoms[i.bonds[s]];if(void 0!==n&&(n.chain!==i.chain||n.resi!==i.resi)){let s=n.structure+"_"+n.chain+"_"+n.resi;if("chemical"!=e||n.het){if("chemical"==e)continue;void 0===t.clbondpnts[i.structure]&&(t.clbondpnts[i.structure]=[]),t.clbondpnts[i.structure].push(l),t.clbondpnts[n.structure].push(s),t.clbondResid2serial[l+","+s]=i.serial,t.clbondResid2serial[s+","+l]=n.serial}}}}}}class A{constructor(e){this.icn3d=e}getAtomsWithinAtom(e,t,s,i,l,n,o){let r=this.icn3d;r.icn3dui;let a=this.getNeighboringAtoms(e,t,s,o);i&&(r.resid2Residhash={});let d={};for(let e in t){let c,h,m=r.atoms[e],p=m.structure+"_"+m.chain+"_"+m.resi;for(let e in r.residues[p])if("CA"===r.atoms[e].name&&"C"===r.atoms[e].elem||"O3'"===r.atoms[e].name||"O3*"===r.atoms[e].name){c=r.atoms[e];break}void 0===c&&(c=m),i&&(h=m.resn+" $"+m.structure+"."+m.chain+":"+m.resi,void 0===r.resid2Residhash[h]&&(r.resid2Residhash[h]={}));let u=m.structure+"_"+m.chain+"_"+m.resi;for(let e in a){let p=a[e];if(!r.crossstrucinter&&m.structure!=p.structure)continue;if(!o&&p.serial in t)continue;if(r.bOpm&&"DUM"===p.resn)continue;let C=p.coord.distanceTo(m.coord);if(C<s){let e,t;d[p.serial]=p,l&&(d[m.serial]=m);let s=p.structure+"_"+p.chain+"_"+p.resi;for(let t in r.residues[s])if("CA"===r.atoms[t].name&&"C"===r.atoms[t].elem||"O3'"===r.atoms[t].name||"O3*"===r.atoms[t].name){e=r.atoms[t];break}if(void 0===e&&(e=p),l&&(r.contactpnts.push({serial:e.serial,coord:e.coord}),r.contactpnts.push({serial:c.serial,coord:c.coord})),i){let s=p.structure+"_"+p.chain+"_"+p.resi;t=p.resn+" $"+p.structure+"."+p.chain+":"+p.resi;let i=C.toFixed(1),l=e.coord.distanceTo(c.coord).toFixed(1),o=u+"_"+m.resn+","+s+"_"+p.resn,a=h+","+t;if((void 0===r.resids2interAll[o]||void 0===r.resids2interAll[o].contact||!r.resids2interAll[o].contact.hasOwnProperty(a)||void 0!==r.resids2interAll[o].hbond&&!r.resids2interAll[o].hbond.hasOwnProperty(a)||void 0!==r.resids2interAll[o].ionic&&!r.resids2interAll[o].ionic.hasOwnProperty(a)||void 0!==r.resids2interAll[o].halogen&&!r.resids2interAll[o].halogen.hasOwnProperty(a)||void 0!==r.resids2interAll[o]["pi-cation"]&&!r.resids2interAll[o]["pi-cation"].hasOwnProperty(a)||void 0!==r.resids2interAll[o]["pi-stacking"]&&!r.resids2interAll[o]["pi-stacking"].hasOwnProperty(a))&&(void 0===r.resid2Residhash[h][t]||i<r.resid2Residhash[h][t].split("_")[0])){let e=void 0===r.resid2Residhash[h][t]?1:parseInt(r.resid2Residhash[h][t].split("_")[4])+1;r.resid2Residhash[h][t]=i+"_"+l+"_"+m.name+"_"+p.name+"_"+e,n||(void 0===r.resids2inter[o]&&(r.resids2inter[o]={}),void 0===r.resids2inter[o].contact&&(r.resids2inter[o].contact={}),r.resids2inter[o].contact[h+","+t]=i+"_"+l+"_"+m.name+"_"+p.name+"_"+e),void 0===r.resids2interAll[o]&&(r.resids2interAll[o]={}),void 0===r.resids2interAll[o].contact&&(r.resids2interAll[o].contact={}),r.resids2interAll[o].contact[h+","+t]=i+"_"+l+"_"+m.name+"_"+p.name+"_"+e}}}}}return d}getNeighboringAtoms(e,t,s,i){let l=this.icn3d;l.icn3dui;let n=this.getExtent(t),o=(n[2][0]-n[0][0])*(n[2][0]-n[0][0])+(n[2][1]-n[0][1])*(n[2][1]-n[0][1])+(n[2][2]-n[0][2])*(n[2][2]-n[0][2]),r=(n[2][0]-n[1][0])*(n[2][0]-n[1][0])+(n[2][1]-n[1][1])*(n[2][1]-n[1][1])+(n[2][2]-n[1][2])*(n[2][2]-n[1][2]),a=o>r?o:r,d=Math.sqrt(a),c=(d+s)*(d+s),h={};for(let o in e){let e=l.atoms[o];!i&&t.hasOwnProperty(e.serial)||(this.bOpm&&"DUM"===e.resn||e.coord.x<n[0][0]-s||e.coord.x>n[1][0]+s||e.coord.y<n[0][1]-s||e.coord.y>n[1][1]+s||e.coord.z<n[0][2]-s||e.coord.z>n[1][2]+s||(e.coord.x-n[2][0])*(e.coord.x-n[2][0])+(e.coord.y-n[2][1])*(e.coord.y-n[2][1])+(e.coord.z-n[2][2])*(e.coord.z-n[2][2])<c&&(h[e.serial]=e))}return h}getExtent(e){let t,s,i,l,n,o,r,a,d,c,h,m=this.icn3d;for(h in m.icn3dui,t=s=i=9999,l=n=o=-9999,r=a=d=c=0,e){let e=m.atoms[h];c++,r+=e.coord.x,a+=e.coord.y,d+=e.coord.z,t=t<e.coord.x?t:e.coord.x,s=s<e.coord.y?s:e.coord.y,i=i<e.coord.z?i:e.coord.z,l=l>e.coord.x?l:e.coord.x,n=n>e.coord.y?n:e.coord.y,o=o>e.coord.z?o:e.coord.z}return[[t,s,i],[l,n,o],[r/c,a/c,d/c]]}hideContact(){let e=this.icn3d;e.icn3dui,e.opts.contact="no",void 0===e.lines&&(e.lines={}),e.lines.contact=[],e.contactpnts=[];for(let t in e.atoms)e.atoms[t].style2="nothing";for(let t in e.sidec)e.hAtoms.hasOwnProperty(t)&&(e.atoms[t].style2=e.opts.sidec);for(let t in e.water)e.hAtoms.hasOwnProperty(t)&&(e.atoms[t].style=e.opts.water)}}class x{constructor(e){this.icn3d=e,this.ISDONE=2;this.edgeTable=new Uint32Array([0,0,0,0,0,0,0,2816,0,0,0,1792,0,3328,3584,3840,0,0,0,138,0,21,0,134,0,0,0,652,0,2067,3865,3600,0,0,0,42,0,0,0,294,0,0,21,28,0,3875,1049,3360,0,168,162,170,0,645,2475,2210,0,687,293,172,4010,3747,3497,3232,0,0,0,0,0,69,0,900,0,0,0,1792,138,131,1608,1920,0,81,0,2074,84,85,84,86,0,81,0,3676,330,1105,1881,1616,0,0,0,42,0,69,0,502,0,0,21,3580,138,2035,1273,1520,2816,104,2337,106,840,581,367,102,2816,3695,3429,3180,1898,1635,1385,1120,0,0,0,0,0,0,0,3910,0,0,69,588,42,2083,41,2880,0,0,0,1722,0,2293,4095,3830,0,255,757,764,2538,2291,3065,2800,0,0,81,338,0,3925,1119,3414,84,855,85,340,2130,2899,89,2384,1792,712,194,1162,4036,3781,3535,3270,708,719,197,204,3018,2755,2505,2240,0,0,0,0,168,420,168,1958,162,162,676,2988,170,163,680,928,3328,3096,3328,3642,52,53,1855,1590,2340,2111,2869,2620,298,51,825,560,3584,3584,3090,3482,1668,1941,1183,1430,146,2975,2069,2460,154,915,153,400,3840,3592,3329,3082,1796,1541,1295,1030,2818,2575,2309,2060,778,515,265,0]),this.triTable=[[],[],[],[],[],[],[],[11,9,8],[],[],[],[8,10,9],[],[10,8,11],[9,11,10],[8,10,9,8,11,10],[],[],[],[1,7,3],[],[4,2,0],[],[2,1,7],[],[],[],[2,7,3,2,9,7],[],[1,4,11,1,0,4],[3,8,0,11,9,4,11,10,9],[4,11,9,11,10,9],[],[],[],[5,3,1],[],[],[],[2,5,8,2,1,5],[],[],[2,4,0],[3,2,4],[],[0,9,1,8,10,5,8,11,10],[3,4,0,3,10,4],[5,8,10,8,11,10],[],[3,5,7],[7,1,5],[1,7,3,1,5,7],[],[9,2,0,9,7,2],[0,3,8,1,7,11,1,5,7],[11,1,7,1,5,7],[],[9,1,0,5,3,2,5,7,3],[8,2,5,8,0,2],[2,5,3,5,7,3],[3,9,1,3,8,9,7,11,10,7,10,5],[9,1,0,10,7,11,10,5,7],[3,8,0,7,10,5,7,11,10],[11,5,7,11,10,5],[],[],[],[],[],[0,6,2],[],[7,2,9,7,9,8],[],[],[],[8,10,9],[7,1,3],[7,1,0],[6,9,3,6,10,9],[7,10,8,10,9,8],[],[6,0,4],[],[11,1,4,11,3,1],[2,4,6],[2,0,4,2,4,6],[2,4,6],[1,4,2,4,6,2],[],[6,0,4],[],[2,11,3,6,9,4,6,10,9],[8,6,1,8,1,3],[10,0,6,0,4,6],[8,0,3,9,6,10,9,4,6],[10,4,6,10,9,4],[],[],[],[5,3,1],[],[0,6,2],[],[7,4,8,5,2,1,5,6,2],[],[],[2,4,0],[7,4,8,2,11,3,10,5,6],[7,1,3],[5,6,10,0,9,1,8,7,4],[5,6,10,7,0,3,7,4,0],[10,5,6,4,8,7],[9,11,8],[3,5,6],[0,5,11,0,11,8],[6,3,5,3,1,5],[3,9,6,3,8,9],[9,6,0,6,2,0],[0,3,8,2,5,6,2,1,5],[1,6,2,1,5,6],[9,11,8],[1,0,9,6,10,5,11,3,2],[6,10,5,2,8,0,2,11,8],[3,2,11,10,5,6],[10,5,6,9,3,8,9,1,3],[0,9,1,5,6,10],[8,0,3,10,5,6],[10,5,6],[],[],[],[],[],[],[],[1,10,2,9,11,6,9,8,11],[],[],[6,0,2],[3,6,9,3,2,6],[3,5,1],[0,5,1,0,11,5],[0,3,5],[6,9,11,9,8,11],[],[],[],[4,5,9,7,1,10,7,3,1],[],[11,6,7,2,4,5,2,0,4],[11,6,7,8,0,3,1,10,2,9,4,5],[6,7,11,1,10,2,9,4,5],[],[4,1,0,4,5,1,6,7,3,6,3,2],[9,4,5,0,6,7,0,2,6],[4,5,9,6,3,2,6,7,3],[6,7,11,5,3,8,5,1,3],[6,7,11,4,1,0,4,5,1],[4,5,9,3,8,0,11,6,7],[9,4,5,7,11,6],[],[],[0,6,4],[8,6,4,8,1,6],[],[0,10,2,0,9,10,4,8,11,4,11,6],[10,2,1,6,0,3,6,4,0],[10,2,1,11,4,8,11,6,4],[4,2,6],[1,0,9,2,4,8,2,6,4],[2,4,0,2,6,4],[8,2,4,2,6,4],[11,4,1,11,6,4],[0,9,1,4,11,6,4,8,11],[3,6,0,6,4,0],[8,6,4,8,11,6],[10,8,9],[6,3,9,6,7,3],[6,7,1],[10,7,1,7,3,1],[7,11,6,8,10,2,8,9,10],[11,6,7,10,0,9,10,2,0],[2,1,10,7,11,6,8,0,3],[1,10,2,6,7,11],[7,2,6,7,9,2],[1,0,9,3,6,7,3,2,6],[7,0,6,0,2,6],[2,7,3,2,6,7],[7,11,6,3,9,1,3,8,9],[9,1,0,11,6,7],[0,3,8,11,6,7],[11,6,7],[],[],[],[],[5,3,7],[8,5,2,8,7,5],[5,3,7],[1,10,2,5,8,7,5,9,8],[1,7,5],[1,7,5],[9,2,7,9,7,5],[11,3,2,8,5,9,8,7,5],[1,3,7,1,7,5],[0,7,1,7,5,1],[9,3,5,3,7,5],[9,7,5,9,8,7],[8,10,11],[3,4,10,3,10,11],[8,10,11],[5,9,4,1,11,3,1,10,11],[2,4,5],[5,2,4,2,0,4],[0,3,8,5,9,4,10,2,1],[2,1,10,9,4,5],[2,8,5,2,11,8],[3,2,11,1,4,5,1,0,4],[9,4,5,8,2,11,8,0,2],[11,3,2,9,4,5],[8,5,3,5,1,3],[5,0,4,5,1,0],[3,8,0,4,5,9],[9,4,5],[11,9,10],[11,9,10],[1,11,4,1,10,11],[8,7,4,11,1,10,11,3,1],[2,7,9,2,9,10],[4,8,7,0,10,2,0,9,10],[2,1,10,0,7,4,0,3,7],[10,2,1,8,7,4],[1,7,4],[3,2,11,4,8,7,9,1,0],[11,4,2,4,0,2],[2,11,3,7,4,8],[4,1,7,1,3,7],[1,0,9,8,7,4],[3,4,0,3,7,4],[8,7,4],[8,9,10,8,10,11],[3,9,11,9,10,11],[0,10,8,10,11,8],[10,3,1,10,11,3],[2,8,10,8,9,10],[9,2,0,9,10,2],[8,0,3,1,10,2],[10,2,1],[1,11,9,11,8,9],[11,3,2,0,9,1],[11,0,2,11,8,0],[11,3,2],[8,1,3,8,9,1],[9,1,0],[8,0,3],[]],this.edgeTable2=[0,265,515,778,2060,2309,2575,2822,1030,1295,1541,1804,3082,3331,3593,3840,400,153,915,666,2460,2197,2975,2710,1430,1183,1941,1692,3482,3219,3993,3728,560,825,51,314,2620,2869,2111,2358,1590,1855,1077,1340,3642,3891,3129,3376,928,681,419,170,2988,2725,2479,2214,1958,1711,1445,1196,4010,3747,3497,3232,2240,2505,2755,3018,204,453,719,966,3270,3535,3781,4044,1226,1475,1737,1984,2384,2137,2899,2650,348,85,863,598,3414,3167,3925,3676,1370,1107,1881,1616,2800,3065,2291,2554,764,1013,255,502,3830,4095,3317,3580,1786,2035,1273,1520,2912,2665,2403,2154,876,613,367,102,3942,3695,3429,3180,1898,1635,1385,1120,1120,1385,1635,1898,3180,3429,3695,3942,102,367,613,876,2154,2403,2665,2912,1520,1273,2035,1786,3580,3317,4095,3830,502,255,1013,764,2554,2291,3065,2800,1616,1881,1107,1370,3676,3925,3167,3414,598,863,85,348,2650,2899,2137,2384,1984,1737,1475,1226,4044,3781,3535,3270,966,719,453,204,3018,2755,2505,2240,3232,3497,3747,4010,1196,1445,1711,1958,2214,2479,2725,2988,170,419,681,928,3376,3129,3891,3642,1340,1077,1855,1590,2358,2111,2869,2620,314,51,825,560,3728,3993,3219,3482,1692,1941,1183,1430,2710,2975,2197,2460,666,915,153,400,3840,3593,3331,3082,1804,1541,1295,1030,2822,2575,2309,2060,778,515,265,0],this.triTable2=[[],[8,3,0],[9,0,1],[8,3,1,8,1,9],[11,2,3],[11,2,0,11,0,8],[11,2,3,0,1,9],[2,1,11,1,9,11,11,9,8],[10,1,2],[8,3,0,1,2,10],[9,0,2,9,2,10],[3,2,8,2,10,8,8,10,9],[10,1,3,10,3,11],[1,0,10,0,8,10,10,8,11],[0,3,9,3,11,9,9,11,10],[8,10,9,8,11,10],[8,4,7],[3,0,4,3,4,7],[1,9,0,8,4,7],[9,4,1,4,7,1,1,7,3],[2,3,11,7,8,4],[7,11,4,11,2,4,4,2,0],[3,11,2,4,7,8,9,0,1],[2,7,11,2,1,7,1,4,7,1,9,4],[10,1,2,8,4,7],[2,10,1,0,4,7,0,7,3],[4,7,8,0,2,10,0,10,9],[2,7,3,2,9,7,7,9,4,2,10,9],[8,4,7,11,10,1,11,1,3],[11,4,7,1,4,11,1,11,10,1,0,4],[3,8,0,7,11,4,11,9,4,11,10,9],[7,11,4,4,11,9,11,10,9],[9,5,4],[3,0,8,4,9,5],[5,4,0,5,0,1],[4,8,5,8,3,5,5,3,1],[11,2,3,9,5,4],[9,5,4,8,11,2,8,2,0],[3,11,2,1,5,4,1,4,0],[8,5,4,2,5,8,2,8,11,2,1,5],[2,10,1,9,5,4],[0,8,3,5,4,9,10,1,2],[10,5,2,5,4,2,2,4,0],[3,4,8,3,2,4,2,5,4,2,10,5],[5,4,9,1,3,11,1,11,10],[0,9,1,4,8,5,8,10,5,8,11,10],[3,4,0,3,10,4,4,10,5,3,11,10],[4,8,5,5,8,10,8,11,10],[9,5,7,9,7,8],[0,9,3,9,5,3,3,5,7],[8,0,7,0,1,7,7,1,5],[1,7,3,1,5,7],[11,2,3,8,9,5,8,5,7],[9,2,0,9,7,2,2,7,11,9,5,7],[0,3,8,2,1,11,1,7,11,1,5,7],[2,1,11,11,1,7,1,5,7],[1,2,10,5,7,8,5,8,9],[9,1,0,10,5,2,5,3,2,5,7,3],[5,2,10,8,2,5,8,5,7,8,0,2],[10,5,2,2,5,3,5,7,3],[3,9,1,3,8,9,7,11,10,7,10,5],[9,1,0,10,7,11,10,5,7],[3,8,0,7,10,5,7,11,10],[11,5,7,11,10,5],[11,7,6],[0,8,3,11,7,6],[9,0,1,11,7,6],[7,6,11,3,1,9,3,9,8],[2,3,7,2,7,6],[8,7,0,7,6,0,0,6,2],[1,9,0,3,7,6,3,6,2],[7,6,2,7,2,9,2,1,9,7,9,8],[1,2,10,6,11,7],[2,10,1,7,6,11,8,3,0],[11,7,6,10,9,0,10,0,2],[7,6,11,3,2,8,8,2,10,8,10,9],[6,10,7,10,1,7,7,1,3],[6,10,1,6,1,7,7,1,0,7,0,8],[9,0,3,6,9,3,6,10,9,6,3,7],[6,10,7,7,10,8,10,9,8],[8,4,6,8,6,11],[11,3,6,3,0,6,6,0,4],[0,1,9,4,6,11,4,11,8],[1,9,4,11,1,4,11,3,1,11,4,6],[3,8,2,8,4,2,2,4,6],[2,0,4,2,4,6],[1,9,0,3,8,2,2,8,4,2,4,6],[9,4,1,1,4,2,4,6,2],[10,1,2,11,8,4,11,4,6],[10,1,2,11,3,6,6,3,0,6,0,4],[0,2,10,0,10,9,4,11,8,4,6,11],[2,11,3,6,9,4,6,10,9],[8,4,6,8,6,1,6,10,1,8,1,3],[1,0,10,10,0,6,0,4,6],[8,0,3,9,6,10,9,4,6],[10,4,6,10,9,4],[9,5,4,7,6,11],[4,9,5,3,0,8,11,7,6],[6,11,7,4,0,1,4,1,5],[6,11,7,4,8,5,5,8,3,5,3,1],[4,9,5,6,2,3,6,3,7],[9,5,4,8,7,0,0,7,6,0,6,2],[4,0,1,4,1,5,6,3,7,6,2,3],[7,4,8,5,2,1,5,6,2],[6,11,7,1,2,10,9,5,4],[11,7,6,8,3,0,1,2,10,9,5,4],[11,7,6,10,5,2,2,5,4,2,4,0],[7,4,8,2,11,3,10,5,6],[4,9,5,6,10,7,7,10,1,7,1,3],[5,6,10,0,9,1,8,7,4],[5,6,10,7,0,3,7,4,0],[10,5,6,4,8,7],[5,6,9,6,11,9,9,11,8],[0,9,5,0,5,3,3,5,6,3,6,11],[0,1,5,0,5,11,5,6,11,0,11,8],[11,3,6,6,3,5,3,1,5],[9,5,6,3,9,6,3,8,9,3,6,2],[5,6,9,9,6,0,6,2,0],[0,3,8,2,5,6,2,1,5],[1,6,2,1,5,6],[1,2,10,5,6,9,9,6,11,9,11,8],[1,0,9,6,10,5,11,3,2],[6,10,5,2,8,0,2,11,8],[3,2,11,10,5,6],[10,5,6,9,3,8,9,1,3],[0,9,1,5,6,10],[8,0,3,10,5,6],[10,5,6],[10,6,5],[8,3,0,10,6,5],[0,1,9,5,10,6],[10,6,5,9,8,3,9,3,1],[3,11,2,10,6,5],[6,5,10,2,0,8,2,8,11],[1,9,0,6,5,10,11,2,3],[1,10,2,5,9,6,9,11,6,9,8,11],[1,2,6,1,6,5],[0,8,3,2,6,5,2,5,1],[5,9,6,9,0,6,6,0,2],[9,6,5,3,6,9,3,9,8,3,2,6],[11,6,3,6,5,3,3,5,1],[0,5,1,0,11,5,5,11,6,0,8,11],[0,5,9,0,3,5,3,6,5,3,11,6],[5,9,6,6,9,11,9,8,11],[10,6,5,4,7,8],[5,10,6,7,3,0,7,0,4],[5,10,6,0,1,9,8,4,7],[4,5,9,6,7,10,7,1,10,7,3,1],[7,8,4,2,3,11,10,6,5],[11,6,7,10,2,5,2,4,5,2,0,4],[11,6,7,8,0,3,1,10,2,9,4,5],[6,7,11,1,10,2,9,4,5],[7,8,4,5,1,2,5,2,6],[4,1,0,4,5,1,6,7,3,6,3,2],[9,4,5,8,0,7,0,6,7,0,2,6],[4,5,9,6,3,2,6,7,3],[6,7,11,4,5,8,5,3,8,5,1,3],[6,7,11,4,1,0,4,5,1],[4,5,9,3,8,0,11,6,7],[9,4,5,7,11,6],[10,6,4,10,4,9],[8,3,0,9,10,6,9,6,4],[1,10,0,10,6,0,0,6,4],[8,6,4,8,1,6,6,1,10,8,3,1],[2,3,11,6,4,9,6,9,10],[0,10,2,0,9,10,4,8,11,4,11,6],[10,2,1,11,6,3,6,0,3,6,4,0],[10,2,1,11,4,8,11,6,4],[9,1,4,1,2,4,4,2,6],[1,0,9,3,2,8,2,4,8,2,6,4],[2,4,0,2,6,4],[3,2,8,8,2,4,2,6,4],[1,4,9,11,4,1,11,1,3,11,6,4],[0,9,1,4,11,6,4,8,11],[11,6,3,3,6,0,6,4,0],[8,6,4,8,11,6],[6,7,10,7,8,10,10,8,9],[9,3,0,6,3,9,6,9,10,6,7,3],[6,1,10,6,7,1,7,0,1,7,8,0],[6,7,10,10,7,1,7,3,1],[7,11,6,3,8,2,8,10,2,8,9,10],[11,6,7,10,0,9,10,2,0],[2,1,10,7,11,6,8,0,3],[1,10,2,6,7,11],[7,2,6,7,9,2,2,9,1,7,8,9],[1,0,9,3,6,7,3,2,6],[8,0,7,7,0,6,0,2,6],[2,7,3,2,6,7],[7,11,6,3,9,1,3,8,9],[9,1,0,11,6,7],[0,3,8,11,6,7],[11,6,7],[11,7,5,11,5,10],[3,0,8,7,5,10,7,10,11],[9,0,1,10,11,7,10,7,5],[3,1,9,3,9,8,7,10,11,7,5,10],[10,2,5,2,3,5,5,3,7],[5,10,2,8,5,2,8,7,5,8,2,0],[9,0,1,10,2,5,5,2,3,5,3,7],[1,10,2,5,8,7,5,9,8],[2,11,1,11,7,1,1,7,5],[0,8,3,2,11,1,1,11,7,1,7,5],[9,0,2,9,2,7,2,11,7,9,7,5],[11,3,2,8,5,9,8,7,5],[1,3,7,1,7,5],[8,7,0,0,7,1,7,5,1],[0,3,9,9,3,5,3,7,5],[9,7,5,9,8,7],[4,5,8,5,10,8,8,10,11],[3,0,4,3,4,10,4,5,10,3,10,11],[0,1,9,4,5,8,8,5,10,8,10,11],[5,9,4,1,11,3,1,10,11],[3,8,4,3,4,2,2,4,5,2,5,10],[10,2,5,5,2,4,2,0,4],[0,3,8,5,9,4,10,2,1],[2,1,10,9,4,5],[8,4,5,2,8,5,2,11,8,2,5,1],[3,2,11,1,4,5,1,0,4],[9,4,5,8,2,11,8,0,2],[11,3,2,9,4,5],[4,5,8,8,5,3,5,1,3],[5,0,4,5,1,0],[3,8,0,4,5,9],[9,4,5],[7,4,11,4,9,11,11,9,10],[3,0,8,7,4,11,11,4,9,11,9,10],[11,7,4,1,11,4,1,10,11,1,4,0],[8,7,4,11,1,10,11,3,1],[2,3,7,2,7,9,7,4,9,2,9,10],[4,8,7,0,10,2,0,9,10],[2,1,10,0,7,4,0,3,7],[10,2,1,8,7,4],[2,11,7,2,7,1,1,7,4,1,4,9],[3,2,11,4,8,7,9,1,0],[7,4,11,11,4,2,4,0,2],[2,11,3,7,4,8],[9,1,4,4,1,7,1,3,7],[1,0,9,8,7,4],[3,4,0,3,7,4],[8,7,4],[8,9,10,8,10,11],[0,9,3,3,9,11,9,10,11],[1,10,0,0,10,8,10,11,8],[10,3,1,10,11,3],[3,8,2,2,8,10,8,9,10],[9,2,0,9,10,2],[8,0,3,1,10,2],[10,2,1],[2,11,1,1,11,9,11,8,9],[11,3,2,0,9,1],[11,0,2,11,8,0],[11,3,2],[8,1,3,8,9,1],[9,1,0],[8,0,3],[]]}}x.prototype.march=function(e,t,s,i){let l=!!i.fulltable,n=i.hasOwnProperty("origin")&&i.origin.hasOwnProperty("x")?i.origin:{x:0,y:0,z:0},o=!!i.voxel,r=i.matrix,a=i.nX||0,d=i.nY||0,c=i.nZ||0,h=i.scale||1,m=null;m=i.unitCube?i.unitCube:{x:h,y:h,z:h};let p,u,C=new Int32Array(a*d*c);for(p=0,u=C.length;p<u;++p)C[p]=-1;let g=function(e,s,i,l,a,h){let p={x:0,y:0,z:0},u=a;!!!(l&1<<a)&&!!(l&1<<h)&&(u=h),1&u&&i++,2&u&&s++,4&u&&e++,r?(p=new THREE.Vector3(e,s,i),p=p.applyMatrix4(r),p={x:p.x,y:p.y,z:p.z}):(p.x=n.x+m.x*e,p.y=n.y+m.y*s,p.z=n.z+m.z*i);let g=(d*e+s)*c+i;return o?(t.push(p),t.length-1):(C[g]<0&&(C[g]=t.length,t.push(p)),C[g])},f=new Int32Array(12),b=l?this.edgeTable2:this.edgeTable,y=l?this.triTable2:this.triTable;for(p=0;p<a-1;++p)for(let i=0;i<d-1;++i)for(let l=0;l<c-1;++l){let n=0;for(let t=0;t<8;++t){n|=!!(e[(d*(p+((4&t)>>2))+i+((2&t)>>1))*c+l+(1&t)]&this.ISDONE)<<t}if(0===n||255===n)continue;let r=b[n];if(0===r)continue;let a=y[n];1&r&&(f[0]=g(p,i,l,n,0,1)),2&r&&(f[1]=g(p,i,l,n,1,3)),4&r&&(f[2]=g(p,i,l,n,3,2)),8&r&&(f[3]=g(p,i,l,n,2,0)),16&r&&(f[4]=g(p,i,l,n,4,5)),32&r&&(f[5]=g(p,i,l,n,5,7)),64&r&&(f[6]=g(p,i,l,n,7,6)),128&r&&(f[7]=g(p,i,l,n,6,4)),256&r&&(f[8]=g(p,i,l,n,0,4)),512&r&&(f[9]=g(p,i,l,n,1,5)),1024&r&&(f[10]=g(p,i,l,n,3,7)),2048&r&&(f[11]=g(p,i,l,n,2,6));for(let e=0;e<a.length;e+=3){let i=f[a[e]],l=f[a[e+1]],n=f[a[e+2]];o&&e>=3&&(t.push(t[i]),i=t.length-1,t.push(t[l]),l=t.length-1,t.push(t[n]),n=t.length-1),s.push(i),s.push(l),s.push(n)}}},x.prototype.laplacianSmooth=function(e,t,s){let i,l,n,o,r,a=new Array(t.length);for(i=0,l=t.length;i<l;i++)a[i]={x:0,y:0,z:0};let d,c=new Array(20);for(i=0;i<20;i++)c[i]=new Array(t.length);for(i=0,l=t.length;i<l;i++)c[0][i]=0;for(i=0,l=s.length/3;i<l;i++){let e=3*i,t=3*i+1,l=3*i+2;for(d=!0,n=0,o=c[0][s[e]];n<o;n++)if(s[t]==c[n+1][s[e]]){d=!1;break}for(d&&(c[0][s[e]]++,c[c[0][s[e]]][s[e]]=s[t]),d=!0,n=0,o=c[0][s[e]];n<o;n++)if(s[l]==c[n+1][s[e]]){d=!1;break}for(d&&(c[0][s[e]]++,c[c[0][s[e]]][s[e]]=s[l]),d=!0,n=0,o=c[0][s[t]];n<o;n++)if(s[e]==c[n+1][s[t]]){d=!1;break}for(d&&(c[0][s[t]]++,c[c[0][s[t]]][s[t]]=s[e]),d=!0,n=0,o=c[0][s[t]];n<o;n++)if(s[l]==c[n+1][s[t]]){d=!1;break}for(d&&(c[0][s[t]]++,c[c[0][s[t]]][s[t]]=s[l]),d=!0,n=0;n<c[0][s[l]];n++)if(s[e]==c[n+1][s[l]]){d=!1;break}for(d&&(c[0][s[l]]++,c[c[0][s[l]]][s[l]]=s[e]),d=!0,n=0,o=c[0][s[l]];n<o;n++)if(s[t]==c[n+1][s[l]]){d=!1;break}d&&(c[0][s[l]]++,c[c[0][s[l]]][s[l]]=s[t])}let h=.5;for(r=0;r<e;r++){for(i=0,l=t.length;i<l;i++)if(c[0][i]<3)a[i].x=t[i].x,a[i].y=t[i].y,a[i].z=t[i].z;else if(3==c[0][i]||4==c[0][i]){for(a[i].x=0,a[i].y=0,a[i].z=0,n=0,o=c[0][i];n<o;n++)a[i].x+=t[c[n+1][i]].x,a[i].y+=t[c[n+1][i]].y,a[i].z+=t[c[n+1][i]].z;a[i].x+=h*t[i].x,a[i].y+=h*t[i].y,a[i].z+=h*t[i].z,a[i].x/=h+c[0][i],a[i].y/=h+c[0][i],a[i].z/=h+c[0][i]}else{for(a[i].x=0,a[i].y=0,a[i].z=0,n=0,o=c[0][i];n<o;n++)a[i].x+=t[c[n+1][i]].x,a[i].y+=t[c[n+1][i]].y,a[i].z+=t[c[n+1][i]].z;a[i].x+=1*t[i].x,a[i].y+=1*t[i].y,a[i].z+=1*t[i].z,a[i].x/=1+c[0][i],a[i].y/=1+c[0][i],a[i].z/=1+c[0][i]}for(i=0,l=t.length;i<l;i++)t[i].x=a[i].x,t[i].y=a[i].y,t[i].z=a[i].z}};class k{constructor(e,t){this.icn3d=e,this.threshbox=t,this.dataArray={},this.header,this.data=void 0,this.matrix=void 0,this.isovalue=void 0,this.loadPhiFrom=void 0,this.vpColor=null,this.vpPot=null,this.INOUT=1,this.ISDONE=2,this.ISBOUND=4,this.ptranx=0,this.ptrany=0,this.ptranz=0,this.probeRadius=1.4,this.defaultScaleFactor=2,this.scaleFactor=this.defaultScaleFactor,this.finalScaleFactor={},this.pHeight=0,this.pWidth=0,this.pLength=0,this.cutRadius=0,this.vpBits=null,this.vpDistance=null,this.vpAtomID=null,this.vertnumber=0,this.facenumber=0,this.pminx=0,this.pminy=0,this.pminz=0,this.pmaxx=0,this.pmaxy=0,this.pmaxz=0,this.bCalcArea=!1,this.atomsToShow={},this.vdwRadii={H:1.2,LI:1.82,Na:2.27,K:2.75,C:1.7,N:1.55,O:1.52,F:1.47,P:1.8,S:1.8,CL:1.75,BR:1.85,SE:1.9,ZN:1.39,CU:1.4,NI:1.63,X:2},this.depty={},this.widxz={},this.faces=void 0,this.verts=void 0,this.nb=[new Int32Array([1,0,0]),new Int32Array([-1,0,0]),new Int32Array([0,1,0]),new Int32Array([0,-1,0]),new Int32Array([0,0,1]),new Int32Array([0,0,-1]),new Int32Array([1,1,0]),new Int32Array([1,-1,0]),new Int32Array([-1,1,0]),new Int32Array([-1,-1,0]),new Int32Array([1,0,1]),new Int32Array([1,0,-1]),new Int32Array([-1,0,1]),new Int32Array([-1,0,-1]),new Int32Array([0,1,1]),new Int32Array([0,1,-1]),new Int32Array([0,-1,1]),new Int32Array([0,-1,-1]),new Int32Array([1,1,1]),new Int32Array([1,1,-1]),new Int32Array([1,-1,1]),new Int32Array([-1,1,1]),new Int32Array([1,-1,-1]),new Int32Array([-1,-1,1]),new Int32Array([-1,1,-1]),new Int32Array([-1,-1,-1])],this.origextent=void 0,this.marchingCube=new x}}k.prototype.getVDWIndex=function(e){return e.elem&&void 0!==this.vdwRadii[e.elem.toUpperCase()]?e.elem:"X"},k.prototype.inOrigExtent=function(e,t,s){return!(e<this.origextent[0][0]||e>this.origextent[1][0])&&(!(t<this.origextent[0][1]||t>this.origextent[1][1])&&!(s<this.origextent[0][2]||s>this.origextent[1][2]))},k.prototype.getFacesAndVertices=function(){let e,t,s=this.verts;for(e=0,t=s.length;e<t;e++)s[e].x=s[e].x/this.scaleFactor-this.ptranx,s[e].y=s[e].y/this.scaleFactor-this.ptrany,s[e].z=s[e].z/this.scaleFactor-this.ptranz;let i=[];for(e=0,t=this.faces.length;e<t;e+=3){let t=this.faces[e],l=this.faces[e+1],n=this.faces[e+2],o=s[t].atomid,r=s[l].atomid,a=s[n].atomid;this.atomsToShow[o]&&this.atomsToShow[r]&&this.atomsToShow[a]&&(t!==l&&l!==n&&t!==n&&i.push({a:t,b:l,c:n}))}return this.vpBits=null,this.vpDistance=null,this.vpAtomID=null,this.vpColor=null,this.vpPot=null,{vertices:s,faces:i}},k.prototype.initparm=function(e,t,s,i,l,n,o,r,a){this.header=l,this.dataArray=n,this.matrix=o,this.isovalue=r,this.loadPhiFrom=a,this.bCalcArea=s;for(let e=0,t=i.length;e<t;e++)this.atomsToShow[i[e]]=1;let d=1/this.scaleFactor*5.5;this.origextent=e,this.pminx=e[0][0],this.pmaxx=e[1][0],this.pminy=e[0][1],this.pmaxy=e[1][1],this.pminz=e[0][2],this.pmaxz=e[1][2],t?(this.pminx-=this.probeRadius+d,this.pminy-=this.probeRadius+d,this.pminz-=this.probeRadius+d,this.pmaxx+=this.probeRadius+d,this.pmaxy+=this.probeRadius+d,this.pmaxz+=this.probeRadius+d):(this.pminx-=d,this.pminy-=d,this.pminz-=d,this.pmaxx+=d,this.pmaxy+=d,this.pmaxz+=d),this.pminx=Math.floor(this.pminx*this.scaleFactor)/this.scaleFactor,this.pminy=Math.floor(this.pminy*this.scaleFactor)/this.scaleFactor,this.pminz=Math.floor(this.pminz*this.scaleFactor)/this.scaleFactor,this.pmaxx=Math.ceil(this.pmaxx*this.scaleFactor)/this.scaleFactor,this.pmaxy=Math.ceil(this.pmaxy*this.scaleFactor)/this.scaleFactor,this.pmaxz=Math.ceil(this.pmaxz*this.scaleFactor)/this.scaleFactor,this.ptranx=-this.pminx,this.ptrany=-this.pminy,this.ptranz=-this.pminz;let c=129,h=this.pmaxx-this.pminx;this.pmaxy-this.pminy>h&&(h=this.pmaxy-this.pminy),this.pmaxz-this.pminz>h&&(h=this.pmaxz-this.pminz),this.scaleFactor=(c-1)/h,this.scaleFactor=this.defaultScaleFactor,(this.bCalcArea||this.defaultScaleFactor*h>this.threshbox)&&(c=Math.floor(this.threshbox),this.scaleFactor=(this.threshbox-1)/h),this.pLength=Math.ceil(this.scaleFactor*(this.pmaxx-this.pminx))+1,this.pWidth=Math.ceil(this.scaleFactor*(this.pmaxy-this.pminy))+1,this.pHeight=Math.ceil(this.scaleFactor*(this.pmaxz-this.pminz))+1,this.finalScaleFactor.x=(this.pLength-1)/(this.pmaxx-this.pminx),this.finalScaleFactor.y=(this.pWidth-1)/(this.pmaxy-this.pminy),this.finalScaleFactor.z=(this.pHeight-1)/(this.pmaxz-this.pminz),this.boundingatom(t),this.cutRadius=this.probeRadius*this.scaleFactor,this.vpBits=new Uint8Array(this.pLength*this.pWidth*this.pHeight),this.vpDistance=new Float64Array(this.pLength*this.pWidth*this.pHeight),this.vpAtomID=new Int32Array(this.pLength*this.pWidth*this.pHeight),this.vpColor=[],this.vpPot=[]},k.prototype.boundingatom=function(e){let t,s,i,l,n=[];for(let o in this.vdwRadii){if(!this.vdwRadii.hasOwnProperty(o))continue;let r=this.vdwRadii[o];n[o]=e?(r+this.probeRadius)*this.scaleFactor+.5:r*this.scaleFactor+.5,i=n[o]*n[o],this.widxz[o]=Math.floor(n[o])+1,this.depty[o]=new Int32Array(this.widxz[o]*this.widxz[o]),l=0;for(let e=0;e<this.widxz[o];e++)for(let n=0;n<this.widxz[o];n++)t=e*e+n*n,t>i?this.depty[o][l]=-1:(s=Math.sqrt(i-t),this.depty[o][l]=Math.floor(s)),l++}},k.prototype.fillvoxels=function(e,t){let s,i,l,n;for(s=0,n=this.vpBits.length;s<n;s++)this.vpBits[s]=0,this.vpDistance[s]=-1,this.vpAtomID[s]=-1,this.vpColor[s]=new THREE.Color,this.vpPot[s]=0;for(s in t){let i=e[t[s]];void 0!==i&&"DUM"!==i.resn&&this.fillAtom(i,e)}if(this.dataArray){let e=0,t=this.header.xExtent-1,n=0,o=this.header.yExtent-1,r=0,a=this.header.zExtent-1,d=1,c=Math.floor(.5+d*(t-e))+1,h=Math.floor(.5+d*(o-n))+1,m=Math.floor(.5+d*(a-r))+1,p=h*m,u=m,C=new Float32Array(c*h*m);for(s=0;s<c;++s)for(i=0;i<h;++i)for(l=0;l<m;++l){let e,t=s*p+i*u+l;"phi"==this.header.filetype?e=l*p+i*u+s:"cube"==this.header.filetype&&(e=s*p+i*u+l),e<this.dataArray.length&&(C[t]=this.dataArray[e])}let g=this.pWidth*this.pHeight,f=this.pHeight;for(s=0;s<this.pLength;++s)for(i=0;i<this.pWidth;++i)for(l=0;l<this.pHeight;++l){let e=s/this.finalScaleFactor.x-this.ptranx,t=i/this.finalScaleFactor.y-this.ptrany,n=l/this.finalScaleFactor.z-this.ptranz,o=new THREE.Vector3(e,t,n);o.sub(this.header.ori).multiplyScalar(this.header.scale);let r=Math.floor(o.x),a=Math.ceil(o.x),d=Math.floor(o.y),b=Math.ceil(o.y),y=Math.floor(o.z),v=Math.ceil(o.z);a==r&&(a=r+1),b==d&&(b=d+1),v==y&&(v=y+1),a>c&&(a=c),b>h&&(b=h),v>m&&(v=m);let w,S=C[r*p+d*u+y],_=C[a*p+d*u+y],A=C[r*p+b*u+y],x=C[r*p+d*u+v],k=C[a*p+b*u+y],O=C[r*p+b*u+v],H=C[a*p+d*u+v],R=C[a*p+b*u+v],E=o.x-r,I=o.y-d,D=o.z-y,T=((S*(1-E)+_*E)*(1-I)+(A*(1-E)+k*E)*I)*(1-D)+((x*(1-E)+H*E)*(1-I)+(O*(1-E)+R*E)*I)*D,P=s*g+i*f+l;this.vpPot[P]=T,T>this.isovalue&&(T=this.isovalue),T<-this.isovalue&&(T=-this.isovalue),T>0?(T/=1*this.isovalue,w=new THREE.Color(1-T,1-T,1)):(T/=-1*this.isovalue,w=new THREE.Color(1,1-T,1-T)),this.vpColor[P]=w}}for(s=0,n=this.vpBits.length;s<n;s++)this.vpBits[s]&this.INOUT&&(this.vpBits[s]|=this.ISDONE)},k.prototype.fillAtom=function(e,t){let s,i,l,n,o,r,a,d,c,h,m,p,u,C,g,f,b,y,v;s=Math.floor(.5+this.scaleFactor*(e.coord.x+this.ptranx)),i=Math.floor(.5+this.scaleFactor*(e.coord.y+this.ptrany)),l=Math.floor(.5+this.scaleFactor*(e.coord.z+this.ptranz));let w=this.getVDWIndex(e),S=0,_=this.pWidth*this.pHeight;for(h=0,v=this.widxz[w];h<v;h++)for(m=0;m<v;m++){if(-1!=this.depty[w][S])for(f=-1;f<2;f++)for(b=-1;b<2;b++)for(y=-1;y<2;y++)if(0!==f&&0!==b&&0!==y)for(a=f*h,c=y*m,p=0;p<=this.depty[w][S];p++){if(d=p*b,u=s+a,C=i+d,g=l+c,u<0||C<0||g<0||u>=this.pLength||C>=this.pWidth||g>=this.pHeight)continue;let h=u*_+C*this.pHeight+g;if(this.vpBits[h]&this.INOUT){let m=t[this.vpAtomID[h]];m.serial!=e.serial&&(n=s+a-Math.floor(.5+this.scaleFactor*(m.x+this.ptranx)),o=i+d-Math.floor(.5+this.scaleFactor*(m.y+this.ptrany)),r=l+c-Math.floor(.5+this.scaleFactor*(m.z+this.ptranz)),a*a+d*d+c*c<n*n+o*o+r*r&&(this.vpAtomID[h]=e.serial))}else this.vpBits[h]|=this.INOUT,this.vpAtomID[h]=e.serial}S++}},k.prototype.fillvoxelswaals=function(e,t){let s,i;for(s=0,i=this.vpBits.length;s<i;s++)this.vpBits[s]&=~this.ISDONE;for(s in t){let i=e[t[s]];void 0!==i&&this.fillAtomWaals(i,e)}},k.prototype.fillAtomWaals=function(e,t){let s,i,l,n,o,r,a,d,c,h,m,p,u,C,g,f,b,y,v,w=0;s=Math.floor(.5+this.scaleFactor*(e.coord.x+this.ptranx)),i=Math.floor(.5+this.scaleFactor*(e.coord.y+this.ptrany)),l=Math.floor(.5+this.scaleFactor*(e.coord.z+this.ptranz));let S=this.getVDWIndex(e),_=this.pWidth*this.pHeight;for(u=0,v=this.widxz[S];u<v;u++)for(C=0;C<v;C++){if(-1!=this.depty[S][w])for(f=-1;f<2;f++)for(b=-1;b<2;b++)for(y=-1;y<2;y++)if(0!==f&&0!==b&&0!==y)for(a=f*u,c=y*C,g=0;g<=this.depty[S][w];g++){if(d=g*b,h=s+a,m=i+d,p=l+c,h<0||m<0||p<0||h>=this.pLength||m>=this.pWidth||p>=this.pHeight)continue;let u=h*_+m*this.pHeight+p;if(this.vpBits[u]&this.ISDONE){let h=t[this.vpAtomID[u]];h.serial!=e.serial&&(n=s+a-Math.floor(.5+this.scaleFactor*(h.x+this.ptranx)),o=i+d-Math.floor(.5+this.scaleFactor*(h.y+this.ptrany)),r=l+c-Math.floor(.5+this.scaleFactor*(h.z+this.ptranz)),a*a+d*d+c*c<n*n+o*o+r*r&&(this.vpAtomID[u]=e.serial))}else this.vpBits[u]|=this.ISDONE,this.vpAtomID[u]=e.serial}w++}},k.prototype.buildboundary=function(){let e=this.pWidth*this.pHeight;for(let t=0;t<this.pLength;t++)for(let s=0;s<this.pHeight;s++)for(let i=0;i<this.pWidth;i++){let l=t*e+i*this.pHeight+s;if(this.vpBits[l]&this.INOUT){let n=0;for(;n<26;){let o=t+this.nb[n][0],r=s+this.nb[n][2],a=i+this.nb[n][1];if(o>-1&&o<this.pLength&&a>-1&&a<this.pWidth&&r>-1&&r<this.pHeight&&!(this.vpBits[o*e+a*this.pHeight+r]&this.INOUT)){this.vpBits[l]|=this.ISBOUND;break}n++}}}},k.prototype.fastdistancemap=function(){let e,t,s,i,l,n=new function(e,t,s){let i=new Int32Array(e*t*s*3);this.set=function(e,l,n,o){let r=3*((e*t+l)*s+n);i[r]=o.ix,i[r+1]=o.iy,i[r+2]=o.iz},this.get=function(e,l,n){let o=3*((e*t+l)*s+n);return{ix:i[o],iy:i[o+1],iz:i[o+2]}}}(this.pLength,this.pWidth,this.pHeight),o=this.pWidth*this.pHeight,r=this.cutRadius*this.cutRadius,a=[],d=[];for(e=0;e<this.pLength;e++)for(t=0;t<this.pWidth;t++)for(s=0;s<this.pHeight;s++)if(l=e*o+t*this.pHeight+s,this.vpBits[l]&=~this.ISDONE,this.vpBits[l]&this.INOUT&&this.vpBits[l]&this.ISBOUND){let i={ix:e,iy:t,iz:s};n.set(e,t,s,i),a.push(i),this.vpDistance[l]=0,this.vpBits[l]|=this.ISDONE,this.vpBits[l]&=~this.ISBOUND}do{for(d=this.fastoneshell(a,n),a=[],e=0,i=d.length;e<i;e++)l=o*d[e].ix+this.pHeight*d[e].iy+d[e].iz,this.vpBits[l]&=~this.ISBOUND,this.vpDistance[l]<=1.0404*r&&a.push({ix:d[e].ix,iy:d[e].iy,iz:d[e].iz})}while(0!==a.length);a=[],d=[],n=null;let c=this.scaleFactor-.5;c<0&&(c=0);let h=r-.5/(.1+c);for(e=0;e<this.pLength;e++)for(t=0;t<this.pWidth;t++)for(s=0;s<this.pHeight;s++)l=e*o+t*this.pHeight+s,this.vpBits[l]&=~this.ISBOUND,this.vpBits[l]&this.INOUT&&(this.vpBits[l]&this.ISDONE&&!(this.vpBits[l]&this.ISDONE&&this.vpDistance[l]>=h)||(this.vpBits[l]|=this.ISBOUND))},k.prototype.fastoneshell=function(e,t){let s,i,l,n,o,r,a,d,c,h,m,p,u=[];if(0===e.length)return u;let C={ix:-1,iy:-1,iz:-1},g=this.pWidth*this.pHeight;for(a=0,c=e.length;a<c;a++)for(s=e[a].ix,i=e[a].iy,l=e[a].iz,m=t.get(s,i,l),d=0;d<6;d++)C.ix=s+this.nb[d][0],C.iy=i+this.nb[d][1],C.iz=l+this.nb[d][2],C.ix<this.pLength&&C.ix>-1&&C.iy<this.pWidth&&C.iy>-1&&C.iz<this.pHeight&&C.iz>-1&&(p=C.ix*g+this.pHeight*C.iy+C.iz,this.vpBits[p]&this.INOUT&&!(this.vpBits[p]&this.ISDONE)?(t.set(C.ix,C.iy,l+this.nb[d][2],m),n=C.ix-m.ix,o=C.iy-m.iy,r=C.iz-m.iz,h=n*n+o*o+r*r,this.vpDistance[p]=h,this.vpBits[p]|=this.ISDONE,this.vpBits[p]|=this.ISBOUND,u.push({ix:C.ix,iy:C.iy,iz:C.iz})):this.vpBits[p]&this.INOUT&&this.vpBits[p]&this.ISDONE&&(n=C.ix-m.ix,o=C.iy-m.iy,r=C.iz-m.iz,h=n*n+o*o+r*r,h<this.vpDistance[p]&&(t.set(C.ix,C.iy,C.iz,m),this.vpDistance[p]=h,this.vpBits[p]&this.ISBOUND||(this.vpBits[p]|=this.ISBOUND,u.push({ix:C.ix,iy:C.iy,iz:C.iz})))));for(a=0,c=e.length;a<c;a++)for(s=e[a].ix,i=e[a].iy,l=e[a].iz,m=t.get(s,i,l),d=6;d<18;d++)C.ix=s+this.nb[d][0],C.iy=i+this.nb[d][1],C.iz=l+this.nb[d][2],C.ix<this.pLength&&C.ix>-1&&C.iy<this.pWidth&&C.iy>-1&&C.iz<this.pHeight&&C.iz>-1&&(p=C.ix*g+this.pHeight*C.iy+C.iz,this.vpBits[p]&this.INOUT&&!(this.vpBits[p]&this.ISDONE)?(t.set(C.ix,C.iy,l+this.nb[d][2],m),n=C.ix-m.ix,o=C.iy-m.iy,r=C.iz-m.iz,h=n*n+o*o+r*r,this.vpDistance[p]=h,this.vpBits[p]|=this.ISDONE,this.vpBits[p]|=this.ISBOUND,u.push({ix:C.ix,iy:C.iy,iz:C.iz})):this.vpBits[p]&this.INOUT&&this.vpBits[p]&this.ISDONE&&(n=C.ix-m.ix,o=C.iy-m.iy,r=C.iz-m.iz,h=n*n+o*o+r*r,h<this.vpDistance[p]&&(t.set(C.ix,C.iy,C.iz,m),this.vpDistance[p]=h,this.vpBits[p]&this.ISBOUND||(this.vpBits[p]|=this.ISBOUND,u.push({ix:C.ix,iy:C.iy,iz:C.iz})))));for(a=0,c=e.length;a<c;a++)for(s=e[a].ix,i=e[a].iy,l=e[a].iz,m=t.get(s,i,l),d=18;d<26;d++)C.ix=s+this.nb[d][0],C.iy=i+this.nb[d][1],C.iz=l+this.nb[d][2],C.ix<this.pLength&&C.ix>-1&&C.iy<this.pWidth&&C.iy>-1&&C.iz<this.pHeight&&C.iz>-1&&(p=C.ix*g+this.pHeight*C.iy+C.iz,this.vpBits[p]&this.INOUT&&!(this.vpBits[p]&this.ISDONE)?(t.set(C.ix,C.iy,l+this.nb[d][2],m),n=C.ix-m.ix,o=C.iy-m.iy,r=C.iz-m.iz,h=n*n+o*o+r*r,this.vpDistance[p]=h,this.vpBits[p]|=this.ISDONE,this.vpBits[p]|=this.ISBOUND,u.push({ix:C.ix,iy:C.iy,iz:C.iz})):this.vpBits[p]&this.INOUT&&this.vpBits[p]&this.ISDONE&&(n=C.ix-m.ix,o=C.iy-m.iy,r=C.iz-m.iz,h=n*n+o*o+r*r,h<this.vpDistance[p]&&(t.set(C.ix,C.iy,C.iz,m),this.vpDistance[p]=h,this.vpBits[p]&this.ISBOUND||(this.vpBits[p]|=this.ISBOUND,u.push({ix:C.ix,iy:C.iy,iz:C.iz})))));return u},k.prototype.marchingcubeinit=function(e){for(let t=0,s=this.vpBits.length;t<s;t++)1==e?this.vpBits[t]&=~this.ISBOUND:4==e?(this.vpBits[t]&=~this.ISDONE,this.vpBits[t]&this.ISBOUND&&(this.vpBits[t]|=this.ISDONE),this.vpBits[t]&=~this.ISBOUND):2==e?this.vpBits[t]&this.ISBOUND&&this.vpBits[t]&this.ISDONE?this.vpBits[t]&=~this.ISBOUND:this.vpBits[t]&this.ISBOUND&&!(this.vpBits[t]&this.ISDONE)&&(this.vpBits[t]|=this.ISDONE):3==e&&(this.vpBits[t]&=~this.ISBOUND)},k.prototype.counter=function(){let e=Array(256);for(let t=0;t<256;t++)e[t]=[];this.incrementUsed=function(t,s){void 0===e[t][s]&&(e[t][s]={used:0,unused:0}),e[t][s].used++},this.incrementUnused=function(t,s){void 0===e[t][s]&&(e[t][s]={used:0,unused:0}),e[t][s].unused++};this.print=function(){let t=this.marchingCube.triTable,s=[];for(let i=0;i<t.length;i++){let l=[];for(let s=0;s<t[i].length;s+=3){let n=s/3;void 0!==e[i][n]&&e[i][n].unused||(l.push(t[i][s]),l.push(t[i][s+1]),l.push(t[i][s+2])),void 0===e[i][n]&&console.log("undef "+i+","+n)}s.push(l)}!function(e){let t="[";for(let s=0;s<e.length;s++){let i=0,l=e[s];for(let e=0;e<l.length;e++)i|=1<<l[e];t+="0x"+i.toString(16)+", "}t+="]"}(s)}},k.prototype.marchingcube=function(e){this.marchingcubeinit(e),this.verts=[],this.faces=[],this.marchingCube.march(this.vpBits,this.verts,this.faces,{smooth:1,nX:this.pLength,nY:this.pWidth,nZ:this.pHeight});let t=this.pWidth*this.pHeight;for(let e=0,s=this.verts.length;e<s;e++)this.verts[e].atomid=this.vpAtomID[this.verts[e].x*t+this.pHeight*this.verts[e].y+this.verts[e].z],this.dataArray&&(this.verts[e].color=this.vpColor[this.verts[e].x*t+this.pHeight*this.verts[e].y+this.verts[e].z]),this.dataArray&&(this.verts[e].pot=this.vpPot[this.verts[e].x*t+this.pHeight*this.verts[e].y+this.verts[e].z]);let s,i,l=0;if(this.bCalcArea){let e={};s={};for(let t=0,i=this.faces.length;t<i;t+=3){let i=this.faces[t],n=this.faces[t+1],o=this.faces[t+2];if(i==n||n==o||i==o)continue;let r=Math.min(i,n,o),a=Math.max(i,n,o),d=r+"_"+(i+n+o-r-a)+"_"+a;if(e.hasOwnProperty(d))continue;e[d]=1;let c=this.verts[i].atomid,h=this.verts[n].atomid,m=this.verts[o].atomid;if(!this.atomsToShow[c]||!this.atomsToShow[h]||!this.atomsToShow[m])continue;let p=this.verts[i],u=this.verts[n],C=this.verts[o],g=(p.x-u.x)*(p.x-u.x)+(p.y-u.y)*(p.y-u.y)+(p.z-u.z)*(p.z-u.z),f=(p.x-C.x)*(p.x-C.x)+(p.y-C.y)*(p.y-C.y)+(p.z-C.z)*(p.z-C.z),b=(C.x-u.x)*(C.x-u.x)+(C.y-u.y)*(C.y-u.y)+(C.z-u.z)*(C.z-u.z),y=Math.min(g,f,b),v=Math.max(g,f,b),w=g+f+b-y-v,S=0;S=0==parseInt(100*(v-y))?.433*y:0==parseInt(100*(w-y))?.5*y:.707*y;let _=S/3;void 0===s[c]?s[c]=_:s[c]+=_,void 0===s[h]?s[h]=_:s[h]+=_,void 0===s[m]?s[m]=_:s[m]+=_,l+=S}i=Math.max(this.finalScaleFactor.x,this.finalScaleFactor.y,this.finalScaleFactor.z),l=l/i/i}return this.bCalcArea||this.marchingCube.laplacianSmooth(1,this.verts,this.faces),{area:l,serial2area:s,scaleFactor:i}};class O{constructor(e){this.icn3d=e,this.INOUT=1,this.ISDONE=2,this.ISBOUND=4,this.isovalue=1.5,this.dataArray={},this.matrix=void 0,this.center=void 0,this.maxdist=void 0,this.pmin=void 0,this.pmax=void 0,this.water=void 0,this.header=void 0,this.type=void 0,this.rmsd_supr=void 0,this.loadPhiFrom=void 0,this.ptranx=0,this.ptrany=0,this.ptranz=0,this.probeRadius=1.4,this.defaultScaleFactor=2,this.scaleFactor=this.defaultScaleFactor,this.pHeight=0,this.pWidth=0,this.pLength=0,this.cutRadius=0,this.vpBits=null,this.vpDistance=null,this.vpAtomID=null,this.vertnumber=0,this.facenumber=0,this.pminx=0,this.pminy=0,this.pminz=0,this.pmaxx=0,this.pmaxy=0,this.pmaxz=0,this.depty={},this.widxz={},this.faces=void 0,this.verts=void 0,this.nb=[new Int32Array([1,0,0]),new Int32Array([-1,0,0]),new Int32Array([0,1,0]),new Int32Array([0,-1,0]),new Int32Array([0,0,1]),new Int32Array([0,0,-1]),new Int32Array([1,1,0]),new Int32Array([1,-1,0]),new Int32Array([-1,1,0]),new Int32Array([-1,-1,0]),new Int32Array([1,0,1]),new Int32Array([1,0,-1]),new Int32Array([-1,0,1]),new Int32Array([-1,0,-1]),new Int32Array([0,1,1]),new Int32Array([0,1,-1]),new Int32Array([0,-1,1]),new Int32Array([0,-1,-1]),new Int32Array([1,1,1]),new Int32Array([1,1,-1]),new Int32Array([1,-1,1]),new Int32Array([-1,1,1]),new Int32Array([1,-1,-1]),new Int32Array([-1,-1,1]),new Int32Array([-1,1,-1]),new Int32Array([-1,-1,-1])],this.marchingCube=new x}}O.prototype.getFacesAndVertices=function(e,t){let s,i,l={};for(s=0,i=t.length;s<i;s++)l[t[s]]=1;let n=this.verts;for(s=0,i=n.length;s<i;s++){let e;e="phi"==this.type?new THREE.Vector3(n[s].x,n[s].y,n[s].z).multiplyScalar(1/this.header.scale).applyMatrix4(this.matrix):new THREE.Vector3(n[s].x,n[s].y,n[s].z).applyMatrix4(this.matrix),n[s].x=e.x,n[s].y=e.y,n[s].z=e.z}let o=[];for(s=0,i=this.faces.length;s<i;s+=3){let e=this.faces[s],t=this.faces[s+1],i=this.faces[s+2];e!==t&&t!==i&&e!==i&&o.push({a:e,b:t,c:i})}return this.vpBits=null,this.vpDistance=null,this.vpAtomID=null,{vertices:n,faces:o}},O.prototype.initparm=function(e,t,s,i,l,n,o,r,a,d,c,h,m){this.header=e,this.loadPhiFrom=h,this.header&&void 0!==this.header.max?this.isovalue=this.header.min+(this.header.max-this.header.min)*i/100:this.header&&void 0!==this.header.mean?this.isovalue=this.header.mean+this.header.sigma*i:this.isovalue=i,this.dataArray=t,this.matrix=s,this.center=l,this.maxdist=n,this.pmin=o,this.pmax=r,this.water=a,this.type=d,this.rmsd_supr=c,this.pminx=0,this.pmaxx=this.header.xExtent-1,this.pminy=0,this.pmaxy=this.header.yExtent-1,this.pminz=0,this.pmaxz=this.header.zExtent-1,this.ptranx=-this.pminx,this.ptrany=-this.pminy,this.ptranz=-this.pminz;let p=this.pmaxx-this.pminx;this.pmaxy-this.pminy>p&&(p=this.pmaxy-this.pminy),this.pmaxz-this.pminz>p&&(p=this.pmaxz-this.pminz),this.scaleFactor=1,this.pLength=Math.floor(.5+this.scaleFactor*(this.pmaxx-this.pminx))+1,this.pWidth=Math.floor(.5+this.scaleFactor*(this.pmaxy-this.pminy))+1,this.pHeight=Math.floor(.5+this.scaleFactor*(this.pmaxz-this.pminz))+1,this.cutRadius=this.probeRadius*this.scaleFactor,this.vpBits=new Uint8Array(this.pLength*this.pWidth*this.pHeight),this.vpAtomID=new Uint8Array(this.pLength*this.pWidth*this.pHeight)},O.prototype.transformMemPro=function(e,t,s,i){let l=e.clone();l.sub(s);let n=l.x*t[0]+l.y*t[1]+l.z*t[2]+i.x,o=l.x*t[3]+l.y*t[4]+l.z*t[5]+i.y,r=l.x*t[6]+l.y*t[7]+l.z*t[8]+i.z;return l.x=n,l.y=o,l.z=r,l},O.prototype.fillvoxels=function(e,t){let s,i,l,n,o,r;for(s=0,n=this.vpBits.length;s<n;s++)this.vpBits[s]=0,this.vpAtomID[s]=0;let a=this.pWidth*this.pHeight,d=this.pHeight;if("phi"!=this.type||this.header.bSurface){let c=(new THREE.Matrix4).copy(this.matrix).invert(),h=[];this.maxdist=parseInt(this.maxdist);let m,p,u,C=new Array(9);if(void 0!==this.rmsd_supr&&void 0!==this.rmsd_supr.rot){m=this.rmsd_supr.rot,p=this.rmsd_supr.trans1,u=this.rmsd_supr.trans2;let e=new THREE.Matrix3,t=new THREE.Matrix3;e.set(m[0],m[1],m[2],m[3],m[4],m[5],m[6],m[7],m[8]),t.copy(e).invert(),C[0]=t.elements[0],C[1]=t.elements[3],C[2]=t.elements[6],C[3]=t.elements[1],C[4]=t.elements[4],C[5]=t.elements[7],C[6]=t.elements[2],C[7]=t.elements[5],C[8]=t.elements[8]}if("phi"==this.type&&this.header.bSurface){let n=new Float32Array(this.pLength*this.pWidth*this.pHeight);for(s=0;s<this.pLength;++s)for(i=0;i<this.pWidth;++i)for(l=0;l<this.pHeight;++l){let e,t=s*a+i*d+l;"phi"==this.header.filetype?e=l*a+i*d+s:"cube"==this.header.filetype&&(e=s*a+i*d+l),e<this.dataArray.length&&(n[t]=this.dataArray[e])}for(let s in t){let i=e[t[s]];if("DUM"===i.resn)continue;let l=i.coord.clone();if("delphi"!=this.loadPhiFrom)if(void 0!==this.rmsd_supr&&void 0!==this.rmsd_supr.rot){l=this.transformMemPro(i.coord,C,u,p).applyMatrix4(c)}else l=i.coord.clone().applyMatrix4(c);l.sub(this.header.ori).multiplyScalar(this.header.scale);let o=Math.floor(l.x),r=Math.ceil(l.x),h=Math.floor(l.y),m=Math.ceil(l.y),g=Math.floor(l.z),f=Math.ceil(l.z);r==o&&(r=o+1),m==h&&(m=h+1),f==g&&(f=g+1),r>this.pLength&&(r=this.pLength),m>this.pWidth&&(m=this.pWidth),f>this.pHeight&&(f=this.pHeight);let b,y=n[o*a+h*d+g],v=n[r*a+h*d+g],w=n[o*a+m*d+g],S=n[o*a+h*d+f],_=n[r*a+m*d+g],A=n[o*a+m*d+f],x=n[r*a+h*d+f],k=n[r*a+m*d+f],O=l.x-o,H=l.y-h,R=l.z-g,E=((y*(1-O)+v*O)*(1-H)+(w*(1-O)+_*O)*H)*(1-R)+((S*(1-O)+x*O)*(1-H)+(A*(1-O)+k*O)*H)*R;E>this.isovalue&&(E=this.isovalue),E<-this.isovalue&&(E=-this.isovalue),E>0?(E/=1*this.isovalue,b=new THREE.Color(1-E,1-E,1)):(E/=-1*this.isovalue,b=new THREE.Color(1,1-E,1-E)),this.icn3d.atoms[t[s]].color=b,this.icn3d.atomPrevColors[t[s]]=b}}else{for(let m in t){let g,f=e[t[m]];if("DUM"!==f.resn){if(void 0!==this.rmsd_supr&&void 0!==this.rmsd_supr.rot){g=this.transformMemPro(f.coord,C,u,p).applyMatrix4(c)}else g=f.coord.clone().applyMatrix4(c);for(s=Math.floor(g.x)-this.maxdist,n=Math.ceil(g.x)+this.maxdist;s<=n;++s)if(!(s<0||s>this.header.xExtent*this.scaleFactor-1))for(i=Math.floor(g.y)-this.maxdist,o=Math.ceil(g.y)+this.maxdist;i<=o;++i)if(!(i<0||i>this.header.yExtent*this.scaleFactor-1))for(l=Math.floor(g.z)-this.maxdist,r=Math.ceil(g.z)+this.maxdist;l<=r;++l){if(l<0||l>this.header.zExtent*this.scaleFactor-1)continue;let e=s*a+i*d+l;h.push(e)}}}for(s=0,n=h.length;s<n;++s){let e=h[s];"2fofc"==this.type?this.vpBits[e]=this.dataArray[e]>=this.isovalue?1:0:"fofc"==this.type?(this.vpBits[e]=this.dataArray[e]>=this.isovalue||this.dataArray[e]<=-this.isovalue?1:0,this.vpAtomID[e]=this.dataArray[e]>=0?1:0):"em"==this.type&&(this.vpBits[e]=this.dataArray[e]>=this.isovalue?1:0)}}}else for(s=0;s<this.pLength;++s)for(i=0;i<this.pWidth;++i)for(l=0;l<this.pHeight;++l){let e,t=s*a+i*d+l;"phi"==this.header.filetype?e=l*a+i*d+s:"cube"==this.header.filetype&&(e=s*a+i*d+l),e<this.dataArray.length&&(this.vpBits[t]=this.dataArray[e]>=this.isovalue||this.dataArray[e]<=-this.isovalue?1:0,this.vpAtomID[t]=this.dataArray[e]>=0?1:0)}for(s=0,n=this.vpBits.length;s<n;s++)this.vpBits[s]&this.INOUT&&(this.vpBits[s]|=this.ISDONE)},O.prototype.buildboundary=function(){let e,t,s,i=this.pWidth*this.pHeight;for(e=0;e<this.pLength;e++)for(t=0;t<this.pHeight;t++)for(s=0;s<this.pWidth;s++){let l=e*i+s*this.pHeight+t;if(this.vpBits[l]&this.INOUT){let n=0;for(;n<26;){let o=e+this.nb[n][0],r=t+this.nb[n][2],a=s+this.nb[n][1];if(o>-1&&o<this.pLength&&a>-1&&a<this.pWidth&&r>-1&&r<this.pHeight&&!(this.vpBits[o*i+a*this.pHeight+r]&this.INOUT)){this.vpBits[l]|=this.ISBOUND;break}n++}}}},O.prototype.marchingcubeinit=function(e){for(let t=0,s=this.vpBits.length;t<s;t++)1==e?this.vpBits[t]&=~this.ISBOUND:4==e?(this.vpBits[t]&=~this.ISDONE,this.vpBits[t]&this.ISBOUND&&(this.vpBits[t]|=this.ISDONE),this.vpBits[t]&=~this.ISBOUND):2==e?this.vpBits[t]&this.ISBOUND&&this.vpBits[t]&this.ISDONE?this.vpBits[t]&=~this.ISBOUND:this.vpBits[t]&this.ISBOUND&&!(this.vpBits[t]&this.ISDONE)&&(this.vpBits[t]|=this.ISDONE):this.vpBits[t]&=~this.ISBOUND},O.prototype.counter=function(){let e=Array(256);for(let t=0;t<256;t++)e[t]=[];this.incrementUsed=function(t,s){void 0===e[t][s]&&(e[t][s]={used:0,unused:0}),e[t][s].used++},this.incrementUnused=function(t,s){void 0===e[t][s]&&(e[t][s]={used:0,unused:0}),e[t][s].unused++};this.print=function(){let t=this.marchingCube.triTable,s=[];for(let i=0;i<t.length;i++){let l=[];for(let s=0;s<t[i].length;s+=3){let n=s/3;void 0!==e[i][n]&&e[i][n].unused||(l.push(t[i][s]),l.push(t[i][s+1]),l.push(t[i][s+2])),void 0===e[i][n]&&console.log("undef "+i+","+n)}s.push(l)}!function(e){let t="[";for(let s=0;s<e.length;s++){let i=0,l=e[s];for(let e=0;e<l.length;e++)i|=1<<l[e];t+="0x"+i.toString(16)+", "}t+="]"}(s)}},O.prototype.marchingcube=function(e){this.marchingcubeinit(e),this.verts=[],this.faces=[],this.marchingCube.march(this.vpBits,this.verts,this.faces,{smooth:1,nX:this.pLength,nY:this.pWidth,nZ:this.pHeight});let t=this.pWidth*this.pHeight;for(let e=0,s=this.verts.length;e<s;e++)this.verts[e].atomid=this.vpAtomID[this.verts[e].x*t+this.pHeight*this.verts[e].y+this.verts[e].z];this.marchingCube.laplacianSmooth(1,this.verts,this.faces)};class H{constructor(e){this.icn3d=e}createSurfaceRepresentation(e,t,s,i){let l,n=this.icn3d,o=n.icn3dui,r=this;if(0==Object.keys(e).length)return;null==i&&(i=1),n.opacity=i;let a=n.contactCls.getExtent(e),d=[];if(n.bConsiderNeighbors){let t;t=o.hashUtilsCls.unionHash(t,e),t=o.hashUtilsCls.unionHash(t,n.contactCls.getAtomsWithinAtom(n.atoms,e,5)),d=Object.keys(t)}else d=Object.keys(e);let c,h=!(10==parseInt(10*i)||s||n.bInstanced&&Object.keys(n.atoms).length*n.biomtMatrices.length>n.maxatomcnt),m={allatoms:n.atoms,atomsToShow:Object.keys(e),extendedAtoms:d,water:n.water,center:n.center,maxdist:1,pmin:n.pmin,pmax:n.pmax,rmsd_supr:n.rmsd_supr};if(11==t)m.header=n.mapData.header2,m.data=n.mapData.data2,m.matrix=n.mapData.matrix2,m.isovalue=n.mapData.sigma2,m.type="2fofc",c=this.SetupMap(m);else if(12==t)m.header=n.mapData.header,m.data=n.mapData.data,m.matrix=n.mapData.matrix,m.isovalue=n.mapData.sigma,m.type="fofc",c=this.SetupMap(m);else if(13==t)m.maxdist=3,m.header=n.mapData.headerEm,m.data=n.mapData.dataEm,m.matrix=n.mapData.matrixEm,m.isovalue=n.mapData.sigmaEm,m.type="em",c=this.SetupMap(m);else if(14==t)m.header=n.mapData.headerPhi,m.data=n.mapData.dataPhi,m.matrix=n.mapData.matrixPhi,m.isovalue=n.mapData.contourPhi,m.type="phi",m.loadPhiFrom=n.loadPhiFrom,c=this.SetupMap(m);else{let s=o.hashUtilsCls.exclHash(e,n.water);d=o.hashUtilsCls.exclHash(d,n.water);let i=t;21==i?i=1:22==i?i=2:23==i&&(i=3),m={extent:a,allatoms:n.atoms,atomsToShow:Object.keys(s),extendedAtoms:d,type:i,threshbox:h?60:n.threshbox,bCalcArea:n.bCalcArea},m.header=n.mapData.headerPhi,m.data=n.mapData.dataPhi,m.matrix=n.mapData.matrixPhi,m.isovalue=n.mapData.contourPhi,m.loadPhiFrom=n.loadPhiFrom,c=this.SetupSurface(m)}if(n.bCalcArea){n.areavalue=c.area.toFixed(2);let e=c.serial2area,t=c.scaleFactor*c.scaleFactor;n.resid2area={};let s={},i={};for(let t in e){let l=n.atoms[t],o=l.structure+"_"+l.chain+"_"+l.resi+"_"+l.resn;s[l.structure]=1,i[l.structure+"_"+l.chain]=1,void 0===n.resid2area[o]?n.resid2area[o]=e[t]:n.resid2area[o]+=e[t]}let l='<table border="1" cellpadding="10" cellspacing="0">',r=Object.keys(s).length>1?"<th>Structure</th>":"",a=Object.keys(i).length>1?"<th>Chain</th>":"";l+="<tr>"+r+a+"<th>Residue</th><th>Number</th><th>SASA (&#8491;<sup>2</sup>)</th><th>Percent Out</th><th>In/Out</th></tr>";for(let e in n.resid2area){let d=e.lastIndexOf("_"),c=e.substr(d+1),h=o.utilsCls.getIdArray(e.substr(0,d));r=Object.keys(s).length>1?"<td>"+h[0]+"</td>":"",a=Object.keys(i).length>1?"<td>"+h[1]+"</td>":"";let m="",p="";n.resid2area[e]=(n.resid2area[e]/t).toFixed(2),o.parasCls.residueArea.hasOwnProperty(c)&&(p=parseInt(n.resid2area[e]/o.parasCls.residueArea[c]*100),p>100&&(p=100),p>=50&&(m="out"),p<20&&(m="in")),l+='<tr align="center">'+r+a+"<td>"+c+'</td><td align="right">'+h[2]+'</td><td align="right">'+n.resid2area[e]+'</td><td align="right">'+p+"%</td><td>"+m+"</td></tr>"}return l+="</table>",void(n.areahtml=l)}let p,u,C,g=c.vertices,f=c.faces,b=o.parasCls.thr("#00FFFF"),y=o.parasCls.thr("#00FF00"),v=o.parasCls.thr("#ff0000"),w=o.parasCls.thr("#00FFFF"),S=o.parasCls.thr("#0000FF"),_=o.parasCls.thr("#FF0000");11!=t&&12!=t&&13!=t&&14!=t||void 0===n.rmsd_supr||void 0===n.rmsd_supr.rot||(p=n.rmsd_supr.rot,u=n.rmsd_supr.trans1,C=n.rmsd_supr.trans2);let A=(11==t||12==t||13==t||14==t&&"delphi"!=n.loadPhiFrom)&&void 0!==n.rmsd_supr&&void 0!==n.rmsd_supr.rot;l=new THREE.BufferGeometry;let x,k=[],O=[],H=[],R=0;for(let e=0,s=g.length;e<s;++e,R+=3){let s=g[e],i=new THREE.Vector3(s.x,s.y,s.z);if(A&&(i=r.transformMemPro(i,p,u,C)),k[R]=i.x,k[R+1]=i.y,k[R+2]=i.z,11==t)x=b;else if(12==t)x=s.atomid?y:v;else if(13==t)x=w;else if(14==t)x=s.atomid?S:_;else if(21==t||22==t||23==t){x=s.color;let e=s.atomid;n.atoms[e].pot=s.pot}else{let e=s.atomid;x=n.atoms[e].color}O[R]=x.r,O[R+1]=x.g,O[R+2]=x.b}if(n.icn3dui.bNode)return;R=0;for(let e=0,t=f.length;e<t;++e,R+=3){let t=f[e];H[R]=t.a,H[R+1]=t.b,H[R+2]=t.c}if(l.setAttribute("position",new THREE.BufferAttribute(new Float32Array(k),3)),l.setAttribute("color",new THREE.BufferAttribute(new Float32Array(O),3)),l.setIndex(new THREE.BufferAttribute(new Uint32Array(H),1)),l.computeVertexNormals(),l.type="Surface",h){let e={};for(let t=0,s=f.length;t<s;++t){let s=f[t].a,i=f[t].b,l=f[t].c;void 0===e[s]&&(e[s]=[]),e[s].push(i),e[s].push(l)}for(let l in e){this.geometry=new THREE.BufferGeometry;let o=[],r=[],a=[],d=0,c=0,h=0,m=e[l],p=new THREE.Vector3(0,0,0),u=3,C=0;for(let e=0,t=m.length;e<t;e+=2){let t=m[e],s=m[e+1];o[d++]=g[l].x,o[d++]=g[l].y,o[d++]=g[l].z,o[d++]=g[t].x,o[d++]=g[t].y,o[d++]=g[t].z,o[d++]=g[s].x,o[d++]=g[s].y,o[d++]=g[s].z,r[c++]=n.atoms[g[l].atomid].color.r,r[c++]=n.atoms[g[l].atomid].color.g,r[c++]=n.atoms[g[l].atomid].color.b,r[c++]=n.atoms[g[t].atomid].color.r,r[c++]=n.atoms[g[t].atomid].color.g,r[c++]=n.atoms[g[t].atomid].color.b,r[c++]=n.atoms[g[s].atomid].color.r,r[c++]=n.atoms[g[s].atomid].color.g,r[c++]=n.atoms[g[s].atomid].color.b;let i=e/2*3;a[h++]=i,a[h++]=i+1,a[h++]=i+2,p=p.add(new THREE.Vector3(g[i].x,g[i].y,g[i].z)),p=p.add(new THREE.Vector3(g[i+1].x,g[i+1].y,g[i+1].z)),p=p.add(new THREE.Vector3(g[i+2].x,g[i+2].y,g[i+2].z)),C+=3}this.geometry.setAttribute("position",new THREE.BufferAttribute(new Float32Array(o),u)),this.geometry.setAttribute("color",new THREE.BufferAttribute(new Float32Array(r),u)),this.geometry.setIndex(new THREE.BufferAttribute(new Uint32Array(a),1)),this.geometry.computeVertexNormals(),this.geometry.type="Surface";let f,b=new THREE.Mesh(this.geometry,new THREE.MeshBasicMaterial({specular:n.frac,shininess:0,emissive:n.emissive,vertexColors:THREE.VertexColors,wireframe:s,opacity:i,transparent:!0,side:THREE.DoubleSide}));f=n.bControlGl&&!n.icn3dui.bNode?p.multiplyScalar(1/C).sub(n.oriCenter).applyMatrix4(window.cam.matrixWorldInverse):p.multiplyScalar(1/C).sub(n.oriCenter).applyMatrix4(n.cam.matrixWorldInverse),b.renderOrder=n.cam_z>0?-parseInt(f.z):parseInt(f.z),b.onBeforeRender=function(e,t,s,i,l,o){let r,a=new THREE.Vector3(0,0,0),d=i.getAttribute("position").array;for(let e=0,t=d.length;e<t;e+=3)a=a.add(new THREE.Vector3(d[e],d[e+1],d[e+2]));r=n.bControlGl&&!n.icn3dui.bNode?a.multiplyScalar(3/d.length).sub(n.oriCenter).applyMatrix4(window.cam.matrixWorldInverse):a.multiplyScalar(3/d.length).sub(n.oriCenter).applyMatrix4(n.cam.matrixWorldInverse),this.renderOrder=n.cam_z>0?-parseInt(r.z):parseInt(r.z)},n.mdl.add(b),11==t||12==t?n.prevMaps.push(b):13==t?n.prevEmmaps.push(b):14==t?n.prevPhimaps.push(b):n.prevSurfaces.push(b)}}else{let e=new THREE.Mesh(l,new THREE.MeshPhongMaterial({specular:n.frac,shininess:20,emissive:n.emissive,vertexColors:THREE.VertexColors,wireframe:s,opacity:i,transparent:!0,side:THREE.DoubleSide}));e.renderOrder=-2,n.mdl.add(e),11==t||12==t?n.prevMaps.push(e):13==t?n.prevEmmaps.push(e):14==t?n.prevPhimaps.push(e):n.prevSurfaces.push(e)}c=null,g=null,f=null,l=null}transformMemPro(e,t,s,i,l){this.icn3d.icn3dui;let n=e.clone();n.sub(s),l&&console.log("sub coord: "+JSON.stringify(n));let o=n.x*t[0]+n.y*t[1]+n.z*t[2]+i.x,r=n.x*t[3]+n.y*t[4]+n.z*t[5]+i.y,a=n.x*t[6]+n.y*t[7]+n.z*t[8]+i.z;return n.x=o,n.y=r,n.z=a,l&&console.log("out coord: "+JSON.stringify(n)),n}SetupSurface(e){let t=this.icn3d;t.icn3dui;let s=e.threshbox,i=new k(t,s);i.initparm(e.extent,1!==e.type,e.bCalcArea,e.atomsToShow,e.header,e.data,e.matrix,e.isovalue,e.loadPhiFrom),i.fillvoxels(e.allatoms,e.extendedAtoms),i.buildboundary(),2===e.type&&(i.fastdistancemap(),i.boundingatom(!1),i.fillvoxelswaals(e.allatoms,e.extendedAtoms));let l=i.marchingcube();i.vpBits=null,i.vpDistance=null,i.vpAtomID=null;let n=i.getFacesAndVertices(e.atomsToShow);return n.area=l.area,n.serial2area=l.serial2area,n.scaleFactor=l.scaleFactor,i.faces=null,i.verts=null,n}SetupMap(e){let t=this.icn3d;t.icn3dui;let s,i=new O(t);return i.initparm(e.header,e.data,e.matrix,e.isovalue,e.center,e.maxdist,e.pmin,e.pmax,e.water,e.type,e.rmsd_supr,e.loadPhiFrom,e.icn3d),i.fillvoxels(e.allatoms,e.extendedAtoms),e.header.bSurface||i.buildboundary(),e.header.bSurface||i.marchingcube(),i.vpBits=null,i.vpAtomID=null,e.header.bSurface||(s=i.getFacesAndVertices(e.allatoms,e.atomsToShow)),i.faces=null,i.verts=null,s}}class R{constructor(e){this.icn3d=e}shareLink(e){var t=this.icn3d;t.icn3dui;let s=this.shareLinkUrl(),i=s.length>4e3||0!==s.indexOf("http");e&&(s+="&random="+parseInt(1e3*Math.random()));let l=Object.keys(t.structures).join("_");if(e){if(t.bInputfile||i)return void t.saveFileCls.saveFile(l+"_image_icn3d_loadable.png","png")}else{if(t.bInputfile&&!t.bInputUrlfile)return void alert("Share Link does NOT work when the data is from custom files. Please save 'iCn3D PNG Image' in the File menu and open it in iCn3D.");if(i)return void alert("The url is more than 4000 characters and may not work. Please save 'iCn3D PNG Image' or 'State File' and open them in iCn3D.");t.icn3dui.htmlCls.clickMenuCls.setLogCmd("share link: "+s,!1)}$.ajax({url:"https://firebasedynamiclinks.googleapis.com/v1/shortLinks?key=AIzaSyBxl9CgM0dY5lagHL4UOhEpLWE1fuwdnvc",type:"POST",data:{longDynamicLink:"https://icn3d.page.link/?link="+encodeURIComponent(s)},dataType:"json",success:function(i){let n="Problem in getting shortened URL";if(void 0!==i.shortLink&&(n=i.shortLink,e)){let e=n.split("/"),s=e[e.length-1];t.saveFileCls.saveFile(l+"-"+s+".png","png");let i='<div style="float:left; border: solid 1px #0000ff; padding: 5px; margin: 10px; text-align:center;">';i+='<a href="https://structure.ncbi.nlm.nih.gov/icn3d/share.html?'+s+'" target="_blank">',i+='<img style="height:300px" src ="'+l+"-"+s+'.png"><br>\n',i+="\x3c!--Start of your comments==================--\x3e\n";let o=t.yournote?": "+t.yournote.replace(/\n/g,"<br>").replace(/; /g,", "):"";i+="PDB "+l.toUpperCase()+o+"\n",i+="\x3c!--End of your comments====================--\x3e\n",i+="</a>",i+="</div>\n\n",t.saveFileCls.saveFile(l+"-"+s+".html","html",i)}e&&void 0===i.shortLink&&t.saveFileCls.saveFile(l+"_image_icn3d_loadable.png","png");let o=n.split("page.link/");2==o.length&&(n="https://structure.ncbi.nlm.nih.gov/icn3d/share.html?"+o[1]),$("#"+t.pre+"ori_url").val(s),$("#"+t.pre+"short_url").val(n),$("#"+t.pre+"short_url_title").val(n+"&t="+t.yournote),e||t.icn3dui.htmlCls.dialogCls.openDlg("dl_copyurl","Copy a Share Link URL")},error:function(i,l,n){let o="Problem in getting shortened URL";$("#"+t.pre+"ori_url").val(s),$("#"+t.pre+"short_url").val(o),$("#"+t.pre+"short_url_title").val(o+"&t="+t.yournote),e||t.icn3dui.htmlCls.dialogCls.openDlg("dl_copyurl","Copy a Share Link URL")}})}shareLinkUrl(e){var t=this.icn3d;t.icn3dui;let s=t.icn3dui.htmlCls.baseUrl+"icn3d/full.html?";if(t.icn3dui.cfg.bSidebyside&&(s=t.icn3dui.htmlCls.baseUrl+"icn3d/full2.html?"),t.bInputUrlfile){s=window.location.href.split("?")[0]+"?"+t.inputurl+"&"}let i,l={};for(let e in t.cfg){let s=t.cfg[e];"inpara"!==e&&"command"!==e&&"usepdbnum"!==e&&"date"!==e&&"v"!==e&&void 0!==s&&("width"===e&&"100%"===s||"height"===e&&"100%"===s||"resize"===e&&!0===s||"showmenu"===e&&!0===s||"showtitle"===e&&!0===s||"showcommand"===e&&!0===s||"simplemenu"===e&&!1===s||"mobilemenu"===e&&!1===s||"closepopup"===e&&!1===s||"showanno"===e&&!1===s||"showseq"===e&&!1===s||"showalignseq"===e&&!1===s||"show2d"===e&&!1===s||"showsets"===e&&!1===s||"rotate"===e&&"right"===s||"command"!==e&&("options"===e?Object.keys(s).length>0&&(l[e]=JSON.stringify(s)):!0===s?l[e]=1:!1===s?l[e]=0:""!==s&&(l[e]=s)))}let n=-1;void 0!==t.icn3dui.cfg.inpara&&(n=t.icn3dui.cfg.inpara.indexOf("&command=")),i=-1!==n?t.icn3dui.cfg.inpara.substr(0,n):t.icn3dui.cfg.inpara;let o=!1;if(!t.bInputUrlfile){let e=i&&i.substr(1)?i.substr(1).split("&"):[];for(let t=0,s=e.length;t<s;++t){let s=e[t].split("=");2==s.length&&(l[s[0]]=s[1])}for(let e in l)"v"!==e&&("date"===e&&(o=!0),s+=e+"="+l[e]+"&")}let r=new Date,a=(r.getMonth()+1).toString();r.getMonth()+1<10&&(a="0"+a);let d=r.getDate().toString();r.getDate()<10&&(d="0"+d);let c=r.getFullYear().toString()+a+d;o||(s+="date="+c+"&"),s+="v="+t.icn3dui.REVISION+"&",s+="command=";let h=0;(e||t.bInputUrlfile)&&(h=0);let m={};m.factor=t._zoomFactor,m.mouseChange=t.mouseChange,m.quaternion=t.quaternion;let p,u=!1,C="",g="toggle highlight",f=0;if(t.commands.length>h){p=t.commands[h].split("|||")[0].trim(),-1!==p.indexOf(g)&&++f}let b,y=h+1;for(let e=t.commands.length;y<e;++y){u=!0;let e=t.commands[y].split("|||")[0].trim();(-1!==p.indexOf("select saved atoms")||-1!==p.indexOf("select sets"))&&(0===e.indexOf("select")||0===e.indexOf("select"))&&-1===p.indexOf(" name ")||-1!==p.indexOf("pickatom")&&-1!==e.indexOf("pickatom")||"show selection"==p&&-1!=t.commands.slice(y).toString().indexOf("show selection")||(-1!==p.indexOf(g)?++f:s+=y===h+1?p:"; "+p),C+=p+"\n",p=e}return p&&(u&&(s+="; "),f>0&&f%2==0&&p!==g&&(s+=g+"; "),s+=p+"|||"+t.transformCls.getTransformationStr(m),C+=p+"|||"+t.transformCls.getTransformationStr(m)+"\n"),C=C.replace(/!/g,Object.keys(t.structures)[0]+"_"),(t.bInputfile&&!t.bInputUrlfile||s.length>4e3)&&(s=C),void 0!==t.structures&&1==Object.keys(t.structures).length&&void 0!==t.inputid&&(b=Object.keys(t.structures)[0],s=s.replace(new RegExp(b+"_","g"),"!")),void 0!==t.icn3dui.cfg.blast_rep_id&&(s=s.replace(new RegExp("blast_rep_id=!","g"),"blast_rep_id="+b+"_")),s}getPngText(){var e=this.icn3d;let t;e.icn3dui;let s="";if(e.bInputfile)t=this.shareLinkUrl(true),s+="\nStart of type file======\n",s+=e.InputfileType+"\n",s+="End of type file======\n",s+="Start of data file======\n",s+=e.InputfileData,s+="End of data file======\n",s+="Start of state file======\n",s+=t,s+="End of state file======\n";else{t=this.shareLinkUrl(),t.length>4e3||0!==t.indexOf("http")?(t=this.shareLinkUrl(true),s+="\nStart of state file======\n",s+=t,s+="End of state file======\n"):s+="\nShare Link: "+t}return s=s.replace(/!/g,Object.keys(e.structures)[0]+"_"),s}}class E{constructor(e){this.icn3d=e}addHlObjects(e,t,s){let i=this.icn3d,l=i.icn3dui;void 0===e&&(e=i.hColor),void 0===s&&(s=i.hAtoms),i.applyDisplayCls.applyDisplayOptions(i.opts,l.hashUtilsCls.intHash(s,i.dAtoms),i.bHighlight),(t||i.bRender)&&i.drawCls.render()}removeHlObjects(){let e=this.icn3d;e.icn3dui;for(let t in e.prevHighlightObjects)e.mdl.remove(e.prevHighlightObjects[t]);e.prevHighlightObjects=[];for(let t in e.prevHighlightObjects_ghost)e.mdl.remove(e.prevHighlightObjects_ghost[t]);e.prevHighlightObjects_ghost=[]}}class I{constructor(e){this.icn3d=e}setThichknessFor3Dprint(){let e=this.icn3d,t=e.icn3dui;e.lineRadius=1,e.coilWidth=1.2,e.cylinderRadius=.8,e.traceRadius=1,e.dotSphereScale=.6,e.sphereRadius=1.5,e.ribbonthickness=1,e.helixSheetWidth=2,e.nucleicAcidWidth=1.4,t.htmlCls.setHtmlCls.setCookieForThickness()}prepareFor3Dprint(){let e=this.icn3d;if(e.icn3dui,e.bShowHighlight=!1,e.hlObjectsCls.removeHlObjects(),e.bDashedLines=!1,e.bSetThickness||void 0!==e.icn3dui.cfg.cid||this.setThichknessFor3Dprint(),void 0!==e.lines.hbond)for(let t=0,s=e.lines.hbond.length;t<s;++t){e.lines.hbond[t].dashed=!1,e.bDashedLines=!0}if(void 0!==e.lines.distance)for(let t=0,s=e.lines.distance.length;t<s;++t){e.lines.distance[t].dashed=!1,e.bDashedLines=!0}e.drawCls.draw()}resetAfter3Dprint(){let e=this.icn3d,t=e.icn3dui;if(void 0!==e.lines.hbond)for(let t=0,s=e.lines.hbond.length;t<s;++t){e.lines.hbond[t].dashed=!0}if(void 0!==e.lines.distance)for(let t=0,s=e.lines.distance.length;t<s;++t){e.lines.distance[t].dashed=!0}e.lineRadius=.1,e.coilWidth=.3,e.cylinderRadius=.4,e.traceRadius=.4,e.dotSphereScale=.3,e.sphereRadius=1.5,e.cylinderHelixRadius=1.6,e.ribbonthickness=.2,e.helixSheetWidth=1.3,e.nucleicAcidWidth=.8,t.htmlCls.setHtmlCls.setCookieForThickness()}removeOneStabilizer(e){let t,s=this.icn3d;s.icn3dui;for(let i=0,l=s.pairArray.length;i<l;i+=2){let l=this.getResidueRepAtom(s.pairArray[i]),n=this.getResidueRepAtom(s.pairArray[i+1]);if(null!=e)for(let s=0,o=e.length;s<o;s+=2){let o=this.getResidueRepAtom(e[s]),r=this.getResidueRepAtom(e[s+1]);if(l.serial==o.serial&&n.serial==r.serial||l.serial==r.serial&&n.serial==o.serial){t=i;break}}if(void 0!==t)break}void 0!==t&&s.pairArray.splice(t,2)}outputSelection(){let e=this.icn3d;e.icn3dui;let t={};for(let s in e.hAtoms){t[e.atoms[s].structure+"_"+e.atoms[s].chain+"_"+e.atoms[s].resi]=1}let s=Object.keys(t).sort((function(e,t){if(""!==e&&!isNaN(e))return parseInt(e)-parseInt(t);{let s=e.lastIndexOf("_"),i=t.lastIndexOf("_");if(e.substr(0,s)<t.substr(0,s))return-1;if(e.substr(0,s)>t.substr(0,s))return 1;if(e.substr(0,s)==t.substr(0,s)){if(parseInt(e.substr(s+1))<parseInt(t.substr(i+1)))return-1;if(parseInt(e.substr(s+1))>parseInt(t.substr(i+1)))return 1;if(parseInt(e.substr(s+1))==parseInt(t.substr(i+1)))return 0}}})),i="<table><tr><th>Structure</th><th>Chain</th><th>Residue Number</th></tr>";for(let e=0,t=s.length;e<t;++e){let t=s[e].indexOf("_"),l=s[e].lastIndexOf("_");i+="<tr><td>"+s[e].substr(0,t)+"</td><td>"+s[e].substr(t+1,l-t-1)+"</td><td>"+s[e].substr(l+1)+"</td></tr>"}let l=e.inputid?e.inputid:"custom";e.saveFileCls.saveFile(l+"_residues.txt","html",i)}addStabilizer(){let e=this.icn3d,t=e.icn3dui,s=3.5;if(Object.keys(e.dAtoms).length>0){let i,l={},n=12.25,o=3.2*3.2;for(let t in e.dAtoms){let s=e.atoms[t];!e.nucleotides.hasOwnProperty(s.serial)||"N1"!==s.name&&"N2"!==s.name&&"N3"!==s.name&&"N4"!==s.name&&"N6"!==s.name&&"O2"!==s.name&&"O6"!==s.name||(i=s.structure+"_"+s.chain+"_"+s.resi+"_"+s.name,l[i]=s)}let r=Object.keys(l),a=r.length;void 0===e.pairArray&&(e.pairArray=[]);for(let t=0;t<a;++t)for(let i=t+1;i<a;++i){let a=r[t],d=r[i],c=Math.abs(l[a].coord.x-l[d].coord.x);if(c>s)continue;let h=Math.abs(l[a].coord.y-l[d].coord.y);if(h>s)continue;let m=Math.abs(l[a].coord.z-l[d].coord.z);if(m>s)continue;let p=c*c+h*h+m*m;p>n||p<o||(e.pairArray.push(l[a].serial),e.pairArray.push(l[d].serial))}let d=6,c={};for(let t in e.dAtoms){let s=e.atoms[t];c[s.structure+"_"+s.chain+"_"+s.resi]=1}let h={};for(let t in e.chemicals){let s=e.atoms[t],i=s.structure+"_"+s.chain+"_"+s.resi;c.hasOwnProperty(i)&&(h[i]=1)}for(let t in e.ions){let s=e.atoms[t],i=s.structure+"_"+s.chain+"_"+s.resi;c.hasOwnProperty(i)&&(h[i]=1)}let m=Object.keys(e.chains);for(let t=0,s=m.length;t<s;++t){let s,i=m[t],l=0,n=0;for(let t=0,o=e.chainsSeq[i].length;t<o;++t)s=i+"_"+e.chainsSeq[i][t].resi,"c"!=e.secondaries[s]&&"E"!=e.secondaries[s]&&"H"!=e.secondaries[s]||(l%3!=0&&e.chainsSeq[i][t].resi==parseInt(n)+1||c.hasOwnProperty(s)&&(h[s]=1),++l,n=e.chainsSeq[i][t].resi);"c"!=e.secondaries[s]&&"E"!=e.secondaries[s]&&"H"!=e.secondaries[s]||c.hasOwnProperty(s)&&(h[s]=1)}let p=Object.keys(h);void 0===e.pairArray&&(e.pairArray=[]);let u=t.hashUtilsCls.exclHash(e.dAtoms,e.water);for(let s=0,i=p.length;s<i;++s){let i=p[s],l=e.secondaries[i],n=e.contactCls.getNeighboringAtoms(u,t.hashUtilsCls.hash2Atoms(e.residues[i],e.atoms),d),o=Object.keys(n).sort(),r=Object.keys(e.residues[i]).sort(),a=!1;if(e.proteins.hasOwnProperty(r[0])){r=[r[0]],a=!0;let t=parseInt(i.substr(i.lastIndexOf("_")+1)),s={};for(let i in n){if(e.chemicals.hasOwnProperty(i)||e.ions.hasOwnProperty(i))continue;let n=e.atoms[i];isNaN(n.resi)||("c"==l&&(n.resi>t+1||n.resi<t-1)||"E"==l&&(n.resi>t+2||n.resi<t-2)||"H"==l&&(n.resi>t+4||n.resi<t-4))&&(s[i]=1)}o=Object.keys(s).sort()}if(o.length>0&&r.length>0)if(a){let t=parseInt((o.length+.5)/2);e.pairArray.push(r[0]),e.pairArray.push(o[t])}else{let t=10,s=parseInt(o.length/(t+1));for(let i=0,l=r.length;i<l;++i)if(i%t==0){let l=parseInt(i/t)*s,n=l<o.length?l:o.length-1;e.pairArray.push(r[i]),e.pairArray.push(o[n]),r.length<t+1&&(e.pairArray.push(r[i]),e.pairArray.push(o[o.length-1]))}}}}}hideStabilizer(){let e=this.icn3d;e.icn3dui,e.pairArray=[],e.lines.stabilizer=[],e.stabilizerpnts=[];for(let t in e.water)e.atoms[t].style=e.opts.water}getResidueRepAtom(e){let t=this.icn3d;t.icn3dui;let s,i=t.atoms[e],l=i.structure+"_"+i.chain+"_"+i.resi;if(t.proteins.hasOwnProperty(e)||t.nucleotides.hasOwnProperty(e))for(let e in t.residues[l]){let i=t.atoms[e];if("CA"===i.name||"N3"===i.name){s=t.atoms[e];break}}else s=i;return void 0===s&&(s=i),s}}class D{constructor(e){this.icn3d=e}applySurfaceOptions(e){let t,s,i=this.icn3d,l=i.icn3dui;switch(void 0===e&&(e=i.opts),e.wireframe){case"yes":e.wireframe=!0;break;case"no":e.wireframe=!1}switch(e.opacity=parseFloat(e.opacity),t=l.hashUtilsCls.intHash(i.dAtoms,i.hAtoms),"nothing"===e.water&&(t=l.hashUtilsCls.exclHash(t,i.water)),s=l.hashUtilsCls.hash2Atoms(t,i.atoms),e.surface.toLowerCase()){case"van der waals surface":i.surfaceCls.createSurfaceRepresentation(s,1,e.wireframe,e.opacity);break;case"solvent accessible surface":i.surfaceCls.createSurfaceRepresentation(s,3,e.wireframe,e.opacity);break;case"molecular surface":i.surfaceCls.createSurfaceRepresentation(s,2,e.wireframe,e.opacity);break;case"van der waals surface with context":i.surfaceCls.createSurfaceRepresentation(s,1,e.wireframe,e.opacity);break;case"solvent accessible surface with context":i.surfaceCls.createSurfaceRepresentation(s,3,e.wireframe,e.opacity);break;case"molecular surface with context":i.surfaceCls.createSurfaceRepresentation(s,2,e.wireframe,e.opacity);break;case"nothing":this.removeSurfaces()}}applyMapOptions(e){let t,s,i=this.icn3d,l=i.icn3dui;switch(void 0===e&&(e=i.opts),e.mapwireframe){case"yes":e.mapwireframe=!0;break;case"no":e.mapwireframe=!1}switch(t=l.hashUtilsCls.intHash(i.dAtoms,i.hAtoms),s=l.hashUtilsCls.hash2Atoms(t,i.atoms),e.map.toLowerCase()){case"2fofc":i.surfaceCls.createSurfaceRepresentation(s,11,e.mapwireframe);break;case"fofc":i.surfaceCls.createSurfaceRepresentation(s,12,e.mapwireframe);break;case"nothing":this.removeMaps()}}applyEmmapOptions(e){let t,s,i=this.icn3d,l=i.icn3dui;switch(void 0===e&&(e=i.opts),e.emmapwireframe){case"yes":e.emmapwireframe=!0;break;case"no":e.emmapwireframe=!1}switch(t=l.hashUtilsCls.intHash(i.dAtoms,i.hAtoms),s=l.hashUtilsCls.hash2Atoms(t,i.atoms),e.emmap.toLowerCase()){case"em":i.surfaceCls.createSurfaceRepresentation(s,13,e.emmapwireframe);break;case"nothing":this.removeEmmaps()}}applyPhimapOptions(e){let t,s,i=this.icn3d,l=i.icn3dui;switch(void 0===e&&(e=i.opts),e.phimapwireframe){case"yes":e.phimapwireframe=!0;break;case"no":e.phimapwireframe=!1}switch(t=l.hashUtilsCls.intHash(i.dAtoms,i.hAtoms),s=l.hashUtilsCls.hash2Atoms(t,i.atoms),e.phimap.toLowerCase()){case"phi":i.surfaceCls.createSurfaceRepresentation(s,14,e.phimapwireframe);break;case"nothing":this.removePhimaps()}}applyphisurfaceOptions(e){let t,s,i=this.icn3d,l=i.icn3dui;switch(void 0===e&&(e=i.opts),i.phisurfwf){case"yes":e.phisurfwf=!0;break;case"no":e.phisurfwf=!1}switch(e.phisurfop=parseFloat(i.phisurfop),t=l.hashUtilsCls.intHash(i.dAtoms,i.hAtoms),"nothing"===e.water&&(t=l.hashUtilsCls.exclHash(t,i.water)),s=l.hashUtilsCls.hash2Atoms(t,i.atoms),e.phisurface.toLowerCase()){case"phi":i.surfaceCls.createSurfaceRepresentation(s,parseInt(i.phisurftype),e.phisurfwf,e.phisurfop);break;case"nothing":this.removeSurfaces()}}removeSurfaces(){let e=this.icn3d;e.icn3dui;for(let t=0,s=e.prevSurfaces.length;t<s;++t)e.mdl.remove(e.prevSurfaces[t]);e.prevSurfaces=[]}removeLastSurface(){let e=this.icn3d;e.icn3dui,e.prevSurfaces.length>0&&(e.mdl.remove(e.prevSurfaces[e.prevSurfaces.length-1]),e.prevSurfaces.slice(e.prevSurfaces.length-1,1))}removeMaps(){let e=this.icn3d;e.icn3dui;for(let t=0,s=e.prevMaps.length;t<s;++t)e.mdl.remove(e.prevMaps[t]);e.prevMaps=[]}removeEmmaps(){let e=this.icn3d;e.icn3dui;for(let t=0,s=e.prevEmmaps.length;t<s;++t)e.mdl.remove(e.prevEmmaps[t]);e.prevEmmaps=[]}removePhimaps(){let e=this.icn3d;e.icn3dui;for(let t=0,s=e.prevPhimaps.length;t<s;++t)e.mdl.remove(e.prevPhimaps[t]);e.prevPhimaps=[]}removeLastMap(){let e=this.icn3d;e.icn3dui,e.prevMaps.length>0&&(e.mdl.remove(e.prevMaps[e.prevMaps.length-1]),e.prevMaps.slice(e.prevMaps.length-1,1))}removeLastEmmap(){let e=this.icn3d;e.icn3dui,e.prevEmmaps.length>0&&(e.mdl.remove(e.prevEmmaps[e.prevEmmaps.length-1]),e.prevEmmaps.slice(e.prevEmmaps.length-1,1))}removeLastPhimap(){let e=this.icn3d;e.icn3dui,e.prevPhimaps.length>0&&(e.mdl.remove(e.prevPhimaps[e.prevPhimaps.length-1]),e.prevPhimaps.slice(e.prevPhimaps.length-1,1))}}class T{constructor(e){this.icn3d=e}exportStlFile(e){let t=this.icn3d;t.icn3dui,void 0!==t.biomtMatrices&&t.biomtMatrices.length>1&&t.bAssembly&&(t.threshbox=180/Math.pow(t.biomtMatrices.length,.33),t.applyMapCls.removeSurfaces(),t.applyMapCls.applySurfaceOptions(),t.applyMapCls.removeMaps(),t.applyMapCls.applyMapOptions(),t.applyMapCls.removeEmmaps(),t.applyMapCls.applyEmmapOptions());let s=this.saveStlFile(),i=t.inputid?t.inputid:"custom";if(t.saveFileCls.saveFile(i+e+".stl","binary",s),void 0!==t.biomtMatrices&&t.biomtMatrices.length>1&&t.bAssembly&&Object.keys(t.dAtoms).length*t.biomtMatrices.length>t.maxAtoms3DMultiFile){alert(t.biomtMatrices.length+" files will be generated for this assembly. Please merge these files using some software and 3D print the merged file.");let l=new THREE.Matrix4;l.identity();let n=1;for(let o=0;o<t.biomtMatrices.length;o++){let r=t.biomtMatrices[o];if(void 0===r)continue;if(r.equals(l))continue;let a=100*(o+1);setTimeout(function(l,n){s=this.saveStlFile(l),t.saveFileCls.saveFile(i+e+n+".stl","binary",s),s=""}.bind(this,r,n),a),++n}t.threshbox=180}}exportVrmlFile(e){let t=this.icn3d;t.icn3dui,void 0!==t.biomtMatrices&&t.biomtMatrices.length>1&&t.bAssembly&&(t.threshbox=180/Math.pow(t.biomtMatrices.length,.33),t.applyMapCls.removeSurfaces(),t.applyMapCls.applySurfaceOptions(),t.applyMapCls.removeMaps(),t.applyMapCls.applyMapOptions(),t.applyMapCls.removeEmmaps(),t.applyMapCls.applyEmmapOptions());let s=this.saveVrmlFile(),i=t.inputid?t.inputid:"custom";if(t.saveFileCls.saveFile(i+e+".wrl","text",s),void 0!==t.biomtMatrices&&t.biomtMatrices.length>1&&t.bAssembly&&Object.keys(t.dAtoms).length*t.biomtMatrices.length>t.maxAtoms3DMultiFile){alert(t.biomtMatrices.length+" files will be generated for this assembly. Please merge these files using some software and 3D print the merged file.");let i=new THREE.Matrix4;i.identity();let l=1;for(let n=0;n<t.biomtMatrices.length;n++){let o=t.biomtMatrices[n];if(void 0===o)continue;if(o.equals(i))continue;let r=100*(n+1);setTimeout(function(i,l){s=this.saveVrmlFile(i),t.saveFileCls.saveFile(t.inputid+e+l+".wrl","text",s),s=""}.bind(this,o,l),r),++l}t.threshbox=180}}getFaceCnt(e){this.icn3d.icn3dui;let t=0;for(let s=0,i=e.children.length;s<i;++s){let i=e.children[s];"Sprite"!==i.type&&(t+=i.geometry.getIndex().array.length/3)}return t}saveStlFile(e){let t=this.icn3d,s=t.icn3dui;if(Object.keys(t.dAtoms).length>7e4)return alert("Please display a subset of the structure to export 3D files. Then merge the files for 3D printing..."),[""];t.threeDPrintCls.prepareFor3Dprint();let i=0;i+=this.getFaceCnt(t.mdl),i+=this.getFaceCnt(t.mdl_ghost);let l=[],n=new Uint8Array(84),o="STL file for the structure(s) ",r=Object.keys(t.structures);for(let e=0,t=r.length;e<t;++e)o+=r[e],e<t-1&&(o+=", ");o.length>80&&(o=o.substr(0,80));for(let e=0;e<80;++e)e<o.length?n[e]=s.convertTypeCls.passInt8([o.charCodeAt(e)])[0]:n[e]=s.convertTypeCls.passInt8([" ".charCodeAt(0)])[0];if(n=void 0!==t.biomtMatrices&&t.biomtMatrices.length>1&&t.bAssembly&&Object.keys(t.dAtoms).length*t.biomtMatrices.length<=t.maxAtoms3DMultiFile?this.updateArray(n,s.convertTypeCls.passInt32([i*t.biomtMatrices.length]),80):this.updateArray(n,s.convertTypeCls.passInt32([i]),80),l.push(new Blob([n],{type:"application/octet-stream"})),l=this.processStlMeshGroup(t.mdl,l,e),l=this.processStlMeshGroup(t.mdl_ghost,l,e),void 0!==t.biomtMatrices&&t.biomtMatrices.length>1&&t.bAssembly&&Object.keys(t.dAtoms).length*t.biomtMatrices.length<=t.maxAtoms3DMultiFile){let e=new THREE.Matrix4;e.identity();for(let s=0;s<t.biomtMatrices.length;s++){let i=t.biomtMatrices[s];void 0!==i&&(i.equals(e)||(l=this.processStlMeshGroup(t.mdl,l,i),l=this.processStlMeshGroup(t.mdl_ghost,l,i)))}}return l}updateArray(e,t,s){this.icn3d.icn3dui;for(let i=0,l=t.length;i<l;++i)e[s+i]=t[i];return e}processStlMeshGroup(e,t,s){let i=this.icn3d.icn3dui;for(let l=0,n=e.children.length;l<n;++l){let n=e.children[l];if("Sprite"===n.type)continue;let o=n.geometry,r=o.getAttribute("position").array,a=o.getIndex().array,d=n.position,c=n.scale,h=n.matrix,m=new Uint8Array(a.length/3*50),p=0;for(let e=0,t=a.length;e<t;e+=3){let t,l,n,u=a[e],C=a[e+1],g=a[e+2],f=new THREE.Vector3(r[3*u],r[3*u+1],r[3*u+2]),b=new THREE.Vector3(r[3*C],r[3*C+1],r[3*C+2]),y=new THREE.Vector3(r[3*g],r[3*g+1],r[3*g+2]);"SphereGeometry"==o.type||"BoxGeometry"==o.type?(t=f.clone().multiply(c).add(d),l=b.clone().multiply(c).add(d),n=y.clone().multiply(c).add(d)):"CylinderGeometry"==o.type?(t=f.clone().applyMatrix4(h),l=b.clone().applyMatrix4(h),n=y.clone().applyMatrix4(h)):(t=f.clone(),l=b.clone(),n=y.clone()),m=this.updateArray(m,i.convertTypeCls.passFloat32([0,0,0]),p),p+=12,void 0!==s&&(t.applyMatrix4(s),l.applyMatrix4(s),n.applyMatrix4(s)),m=this.updateArray(m,i.convertTypeCls.passFloat32([t.x,t.y,t.z]),p),p+=12,m=this.updateArray(m,i.convertTypeCls.passFloat32([l.x,l.y,l.z]),p),p+=12,m=this.updateArray(m,i.convertTypeCls.passFloat32([n.x,n.y,n.z]),p),p+=12,t=l=n=void 0,m=this.updateArray(m,i.convertTypeCls.passInt16([0]),p),p+=2}t.push(new Blob([m],{type:"application/octet-stream"})),m=null}return t}saveVrmlFile(e){let t=this.icn3d;if(t.icn3dui,Object.keys(t.dAtoms).length>5e4)return alert("Please display a subset of the structure to export 3D files. Then merge the files for 3D printing..."),[""];t.threeDPrintCls.prepareFor3Dprint();let s=[];s.push("#VRML V2.0 utf8\n");let i=0,l=this.processVrmlMeshGroup(t.mdl,s,i,e);if(s=l.vrmlStrArray,i=l.vertexCnt,l=this.processVrmlMeshGroup(t.mdl_ghost,s,i,e),s=l.vrmlStrArray,i=l.vertexCnt,void 0!==t.biomtMatrices&&t.biomtMatrices.length>1&&t.bAssembly&&Object.keys(t.dAtoms).length*t.biomtMatrices.length<=t.maxAtoms3DMultiFile){let e=new THREE.Matrix4;e.identity();for(let n=0;n<t.biomtMatrices.length;n++){let o=t.biomtMatrices[n];void 0!==o&&(o.equals(e)||(l=this.processVrmlMeshGroup(t.mdl,s,i,o),s=l.vrmlStrArray,i=l.vertexCnt,l=this.processVrmlMeshGroup(t.mdl_ghost,s,i,o),s=l.vrmlStrArray,i=l.vertexCnt))}}return s}processVrmlMeshGroup(e,t,s,i){let l=this.icn3d.icn3dui;for(let s=0,n=e.children.length;s<n;++s){let n=e.children[s];if("Sprite"===n.type)continue;let o=n.geometry;n.material.type,o.type;let r=o.getAttribute("position").array,a=o.getAttribute("color")?o.getAttribute("color").array:[],d=o.getIndex().array,c=n.position,h=n.scale,m=n.matrix,p=l.parasCls.thr(1,1,1);"SphereGeometry"!=o.type&&"BoxGeometry"!=o.type&&"CylinderGeometry"!=o.type||void 0!==n.material&&(p=n.material.color),t.push("Shape {\n"),t.push("geometry IndexedFaceSet {\n"),t.push("coord Coordinate { point [ ");let u=[];for(let e=0,s=r.length;e<s;e+=3){let n,a=new THREE.Vector3(r[e],r[e+1],r[e+2]);n="SphereGeometry"==o.type||"BoxGeometry"==o.type?a.clone().multiply(h).add(c):"CylinderGeometry"==o.type?a.clone().applyMatrix4(m):a.clone(),void 0!==i&&n.applyMatrix4(i),t.push(n.x.toPrecision(5)+" "+n.y.toPrecision(5)+" "+n.z.toPrecision(5)),n=void 0,e<s-3&&t.push(", "),u.push(l.parasCls.thr(1,1,1))}t.push(" ] }\n");let C="",g="";for(let e=0,t=d.length;e<t;e+=3){let s,i=d[e],l=d[e+1],n=d[e+2];s="SphereGeometry"==o.type||"BoxGeometry"==o.type||"CylinderGeometry"==o.type?p:new THREE.Color(a[3*i],a[3*i+1],a[3*i+2]),C+=i+" "+l+" "+n,e<t-3&&(C+=", -1, "),u[i]=s,u[l]=s,u[n]=s}for(let e=0,t=u.length;e<t;++e){let s=u[e];g+=s.r.toPrecision(3)+" "+s.g.toPrecision(3)+" "+s.b.toPrecision(3),e<t-1&&(g+=", ")}t.push("coordIndex [ "+C+" ]\n"),t.push("color Color { color [ "+g+" ] } colorPerVertex TRUE\n"),t.push("  }\n"),t.push("}\n")}return{vrmlStrArray:t,vertexCnt:s}}}class P{constructor(e){this.icn3d=e}setProtNuclLigInMenu(){let e=this.icn3d;if(e.icn3dui,Object.keys(e.proteins).length>0&&(e.defNames2Residues.proteins=Object.keys(e.firstAtomObjCls.getResiduesFromAtoms(e.proteins)),e.defNames2Descr.proteins="proteins",e.defNames2Command.proteins="select :proteins"),Object.keys(e.nucleotides).length>0&&(e.defNames2Residues.nucleotides=Object.keys(e.firstAtomObjCls.getResiduesFromAtoms(e.nucleotides)),e.defNames2Descr.nucleotides="nucleotides",e.defNames2Command.nucleotides="select :nucleotides"),Object.keys(e.chemicals).length>0)if(e.bOpm){let t={},s={};for(let i in e.chemicals){let l=e.atoms[i],n=l.structure+"_"+l.chain+"_"+l.resi;"DUM"===l.resn?s[n]=1:t[n]=1}Object.keys(t).length>0&&(e.defNames2Residues.chemicals=Object.keys(t),e.defNames2Descr.chemicals="chemicals",e.defNames2Command.chemicals="select :chemicals"),Object.keys(s).length>0&&(e.defNames2Residues.membrane=Object.keys(s),e.defNames2Descr.membrane="membrane",e.defNames2Command.membrane="select :membrane")}else e.defNames2Residues.chemicals=Object.keys(e.firstAtomObjCls.getResiduesFromAtoms(e.chemicals)),e.defNames2Descr.chemicals="chemicals",e.defNames2Command.chemicals="select :chemicals";Object.keys(e.ions).length>0&&(e.defNames2Residues.ions=Object.keys(e.firstAtomObjCls.getResiduesFromAtoms(e.ions)),e.defNames2Descr.ions="ions",e.defNames2Command.ions="select :ions"),Object.keys(e.water).length>0&&(e.defNames2Residues.water=Object.keys(e.firstAtomObjCls.getResiduesFromAtoms(e.water)),e.defNames2Descr.water="water",e.defNames2Command.water="select :water"),this.setTransmemInMenu(e.halfBilayerSize,-e.halfBilayerSize)}setPredefinedInMenu(){let e=this.icn3d,t=e.icn3dui;if(this.setChainsInMenu(),this.setProtNuclLigInMenu(),void 0!==e.icn3dui.cfg.mmdbid||void 0!==e.icn3dui.cfg.gi||void 0!==e.icn3dui.cfg.chainalign)for(let t in e.tddomains)e.selectionCls.selectResidueList(e.tddomains[t],t,t,!1,!1);if((void 0!==e.icn3dui.cfg.align||void 0!==e.icn3dui.cfg.chainalign&&2==e.chainidArray.length)&&e.bFullUi){e.selectionCls.selectResidueList(e.consHash1,e.conservedName1,e.conservedName1,!1,!1),e.selectionCls.selectResidueList(e.consHash2,e.conservedName2,e.conservedName2,!1,!1),e.selectionCls.selectResidueList(e.nconsHash1,e.nonConservedName1,e.nonConservedName1,!1,!1),e.selectionCls.selectResidueList(e.nconsHash2,e.nonConservedName2,e.nonConservedName2,!1,!1),e.selectionCls.selectResidueList(e.nalignHash1,e.notAlignedName1,e.notAlignedName1,!1,!1),e.selectionCls.selectResidueList(e.nalignHash2,e.notAlignedName2,e.notAlignedName2,!1,!1);let s={};for(let i in e.alnChains)s=t.hashUtilsCls.unionHash(s,e.alnChains[i]);let i={};for(let t in s){let s=e.atoms[t];i[s.structure+"_"+s.chain+"_"+s.resi]=1}let l="protein_aligned",n="aligned protein and nucleotides",o="select "+e.resid2specCls.residueids2spec(Object.keys(i));e.selectionCls.addCustomSelection(Object.keys(i),l,n,o,!0)}}setAtomMenu(e){let t=this.icn3d;t.icn3dui;let s="",i=void 0!==t.defNames2Residues?Object.keys(t.defNames2Residues):[],l=void 0!==t.defNames2Atoms?Object.keys(t.defNames2Atoms):[],n=i.concat(l).sort(),o=[];n.forEach((e=>{-1===$.inArray(e,o)&&o.push(e)}));for(let i=0,l=o.length;i<l;++i){let l,n,r=o[i];if(void 0!==t.defNames2Atoms&&t.defNames2Atoms.hasOwnProperty(r)){let e=t.defNames2Atoms[r];e.length>0&&(l=t.atoms[e[0]])}else if(void 0!==t.defNames2Residues&&t.defNames2Residues.hasOwnProperty(r)){let e=t.defNames2Residues[r];e.length>0&&(n=t.residues[e[0]],n&&(l=t.atoms[Object.keys(n)[0]]))}let a=void 0===l||void 0===l.color||"FFFFFF"===l.color.getHexString().toUpperCase()?"DDDDDD":l.color.getHexString(),d=void 0!==l&&void 0!==l.color?a:"000000";-1!=e.indexOf(r)?s+="<option value='"+r+"' style='color:#"+d+"' selected='selected'>"+r+"</option>":s+="<option value='"+r+"' style='color:#"+d+"'>"+r+"</option>"}return s}setChainsInMenu(){let e=this.icn3d;e.icn3dui;for(let t in e.chains)if(e.chainsSeq[t]&&e.chainsSeq[t].length>1){e.defNames2Residues[t]=Object.keys(e.firstAtomObjCls.getResiduesFromAtoms(e.chains[t])),e.defNames2Descr[t]=t;let s=t.indexOf("_"),i=t.substr(0,s),l=t.substr(s+1);e.defNames2Command[t]="select $"+i+"."+l}if(1==Object.keys(e.structures)){let t=Object.keys(e.structures)[0];e.defNames2Residues[t]=Object.keys(e.residues),e.defNames2Descr[t]=t,e.defNames2Command[t]="select $"+t}else{let t=Object.keys(e.residues),s={};for(let e=0,i=t.length;e<i;++e){let i=t[e],l=i.indexOf("_"),n=i.substr(0,l);void 0===s[n]&&(s[n]=[]),s[n].push(i)}for(let t in s)e.defNames2Residues[t]=s[t],e.defNames2Descr[t]=t,e.defNames2Command[t]="select $"+t}}setTransmemInMenu(e,t,s){let i=this.icn3d;if(i.icn3dui,i.bOpm){let l={},n={},o={};for(let s in i.atoms){let r=i.atoms[s];if("DUM"===r.resn)continue;let a=r.structure+"_"+r.chain+"_"+r.resi;r.coord.z>e?n[a]=1:r.coord.z<t?o[a]=1:l[a]=1}let r=s?"2":"";Object.keys(l).length>0&&(i.defNames2Residues["transmembrane"+r]=Object.keys(l),i.defNames2Descr["transmembrane"+r]="transmembrane"+r,i.defNames2Command["transmembrane"+r]="select :transmembrane"+r),Object.keys(n).length>0&&(i.defNames2Residues["extracellular"+r]=Object.keys(n),i.defNames2Descr["extracellular"+r]="extracellular"+r,i.defNames2Command["extracellular"+r]="select :extracellular"+r),Object.keys(o).length>0&&(i.defNames2Residues["intracellular"+r]=Object.keys(o),i.defNames2Descr["intracellular"+r]="intracellular"+r,i.defNames2Command["intracellular"+r]="select :intracellular"+r)}}showSets(){let e=this.icn3d,t=e.icn3dui;e.icn3dui.bNode||(e.icn3dui.htmlCls.dialogCls.openDlg("dl_definedsets","Select sets"),$("#"+e.pre+"dl_setsmenu").show(),$("#"+e.pre+"dl_setoperations").show(),$("#"+e.pre+"dl_command").hide(),$("#"+e.pre+"atomsCustom").resizable());let s=t.hashUtilsCls.cloneHash(e.hAtoms),i=t.hashUtilsCls.cloneHash(e.dAtoms);void 0!==e.bSetChainsAdvancedMenu&&e.bSetChainsAdvancedMenu||(this.setPredefinedInMenu(),e.bSetChainsAdvancedMenu=!0),e.hAtoms=t.hashUtilsCls.cloneHash(s),e.dAtoms=t.hashUtilsCls.cloneHash(i),e.hlUpdateCls.updateHlMenus()}clickCustomAtoms(){let e=this.icn3d,t=e.icn3dui,s=this;$("#"+e.pre+"atomsCustom").change((function(e){let t=s.icn3d,i=$(this).val();if(null!==i){let e=!1;s.changeCustomAtoms(i,e),t.icn3dui.htmlCls.clickMenuCls.setLogCmd("select sets "+i.join(" "+t.setOperation+" "),!0),t.bSelectResidue=!1}})),t.myEventCls.onIds("#"+e.pre+"atomsCustom","focus",(function(e){let i=s.icn3d;t.utilsCls.isMobile()&&$("#"+i.pre+"atomsCustom").val("")}))}deleteSelectedSets(){let e=this.icn3d;e.icn3dui;let t=$("#"+e.pre+"atomsCustom").val();for(let s=0;s<t.length;++s){let i=t[s];(void 0!==e.defNames2Atoms&&e.defNames2Atoms.hasOwnProperty(i)||void 0!==e.defNames2Residues&&e.defNames2Residues.hasOwnProperty(i))&&(void 0!==e.defNames2Atoms&&e.defNames2Atoms.hasOwnProperty(i)&&delete e.defNames2Atoms[i],void 0!==e.defNames2Residues&&e.defNames2Residues.hasOwnProperty(i)&&delete e.defNames2Residues[i])}e.hlUpdateCls.updateHlMenus()}changeCustomAtoms(e,t){let s=this.icn3d,i=s.icn3dui;s.hAtoms={};for(let t=0;t<e.length;++t){let l=e[t];if(void 0!==s.defNames2Atoms&&s.defNames2Atoms.hasOwnProperty(l)||void 0!==s.defNames2Residues&&s.defNames2Residues.hasOwnProperty(l)){if(void 0!==s.defNames2Atoms&&s.defNames2Atoms.hasOwnProperty(l)){let e=s.defNames2Atoms[l];for(let t=0,i=e.length;t<i;++t)s.hAtoms[e[t]]=1}if(void 0!==s.defNames2Residues&&s.defNames2Residues.hasOwnProperty(l)){let e=s.defNames2Residues[l],t={};for(let l=0,n=e.length;l<n;++l)t=i.hashUtilsCls.unionHash(t,s.residues[e[l]]);s.hAtoms=i.hashUtilsCls.unionHash(s.hAtoms,t)}}}s.hlUpdateCls.updateHlAll(e,t),s.annotationCls.showAnnoSelectedChains(),$("#"+s.pre+"command").val(""),$("#"+s.pre+"command_name").val("");for(let t=0,i=e.length;t<i;++t)if(s.defNames2Atoms[e[t]],s.defNames2Residues[e[t]],s.defNames2Descr[e[t]],0===t)$("#"+s.pre+"command").val("saved atoms "+e[t]),$("#"+s.pre+"command_name").val(e[t]);else{let i=$("#"+s.pre+"command").val();$("#"+s.pre+"command").val(i+" "+s.setOperation+" "+e[t]),i=$("#"+s.pre+"command_name").val(),$("#"+s.pre+"command_name").val(i+" "+s.setOperation+" "+e[t])}}setHAtomsFromSets(e,t){let s=this.icn3d,i=s.icn3dui;for(let l=0;l<e.length;++l){let n=e[l];if(void 0!==s.defNames2Atoms&&s.defNames2Atoms.hasOwnProperty(n)||void 0!==s.defNames2Residues&&s.defNames2Residues.hasOwnProperty(n)){if(void 0!==s.defNames2Atoms&&s.defNames2Atoms.hasOwnProperty(n)){let e=s.defNames2Atoms[n];if("or"===t)for(let t=0,i=e.length;t<i;++t)s.hAtoms[e[t]]=1;else if("and"===t){let t={};for(let s=0,i=e.length;s<i;++s)t[e[s]]=1;s.hAtoms=i.hashUtilsCls.intHash(s.hAtoms,t)}else if("not"===t){let t={};for(let s=0,i=e.length;s<i;++s)t[e[s]]=1;s.hAtoms=i.hashUtilsCls.exclHash(s.hAtoms,t)}}if(void 0!==s.defNames2Residues&&s.defNames2Residues.hasOwnProperty(n)){let e=s.defNames2Residues[n],l={};for(let t=0,n=e.length;t<n;++t)l=i.hashUtilsCls.unionHash(l,s.residues[e[t]]);"or"===t?s.hAtoms=i.hashUtilsCls.unionHash(s.hAtoms,l):"and"===t?s.hAtoms=i.hashUtilsCls.intHash(s.hAtoms,l):"not"===t&&(s.hAtoms=i.hashUtilsCls.exclHash(s.hAtoms,l))}}}}updateAdvancedCommands(e,t){let s=this.icn3d;s.icn3dui;let i=" "+t+" ";for(let l=0,n=e.length;l<n;++l)if(0===l&&"or"==t)$("#"+s.pre+"command").val("saved atoms "+e[l]),$("#"+s.pre+"command_name").val(e[l]);else{let t=$("#"+s.pre+"command").val();$("#"+s.pre+"command").val(t+i+e[l]),t=$("#"+s.pre+"command_name").val(),$("#"+s.pre+"command_name").val(t+i+e[l])}}combineSets(e,t,s,i){let l=this.icn3d,n=l.icn3dui;if(l.hAtoms={},this.setHAtomsFromSets(e,"or"),0==Object.keys(l.hAtoms).length&&(l.hAtoms=n.hashUtilsCls.cloneHash(l.atoms)),this.setHAtomsFromSets(t,"and"),this.setHAtomsFromSets(s,"not"),l.bInitial||l.hlUpdateCls.updateHlAll(),l.annotationCls.showAnnoSelectedChains(),$("#"+l.pre+"command").val(""),$("#"+l.pre+"command_name").val(""),this.updateAdvancedCommands(e,"or"),this.updateAdvancedCommands(t,"and"),this.updateAdvancedCommands(s,"not"),void 0!==i){let e="select "+$("#"+l.pre+"command").val();$("#"+l.pre+"command_name").val(i),l.selectionCls.addCustomSelection(Object.keys(l.hAtoms),i,i,e,!1)}}commandSelect(e){let t=this.icn3d;t.icn3dui;let s=$("#"+t.pre+"command"+e).val(),i=$("#"+t.pre+"command_name"+e).val().replace(/;/g,"_").replace(/\s+/g,"_");s&&(t.selByCommCls.selectByCommand(s,i,i),t.icn3dui.htmlCls.clickMenuCls.setLogCmd("select "+s+" | name "+i,!0))}clickCommand_apply(){let e=this.icn3d,t=e.icn3dui,s=this;t.myEventCls.onIds("#"+e.pre+"command_apply","click",(function(e){s.icn3d,e.preventDefault(),s.commandSelect("")})),t.myEventCls.onIds("#"+e.pre+"command_apply2","click",(function(e){s.icn3d,e.preventDefault(),s.commandSelect("2")}))}selectCombinedSets(e,t){this.icn3d.icn3dui;let s=e.split(" "),i=[],l=[],n=[],o="or";for(let e=0,t=s.length;e<t;++e)"or"!==s[e]&&"and"!==s[e]&&"not"!==s[e]?"or"===o?i.push(s[e]):"and"===o?l.push(s[e]):"not"===o&&n.push(s[e]):o=s[e];null!==s&&this.combineSets(i,l,n,t)}clickModeswitch(){let e=this.icn3d,t=e.icn3dui,s=this;t.myEventCls.onIds("#"+e.pre+"modeswitch","click",(function(t){void 0!==$("#"+e.pre+"modeswitch")[0]&&$("#"+e.pre+"modeswitch")[0].checked?s.setModeAndDisplay("selection"):s.setModeAndDisplay("all")}))}setModeAndDisplay(e){let t=this.icn3d,s=t.icn3dui;"all"===e?(this.setMode("all"),t.prevHighlightAtoms=s.hashUtilsCls.cloneHash(t.hAtoms),t.icn3dui.htmlCls.clickMenuCls.setLogCmd("set mode all",!0),t.selectionCls.selectAll(),t.drawCls.draw()):(this.setMode("selection"),void 0!==t.prevHighlightAtoms?t.hAtoms=s.hashUtilsCls.cloneHash(t.prevHighlightAtoms):t.selectionCls.selectAll(),t.icn3dui.htmlCls.clickMenuCls.setLogCmd("set mode selection",!0),t.hlUpdateCls.updateHlAll())}setMode(e){let t=this.icn3d;t.icn3dui,"all"===e?($("#"+t.pre+"modeall").show(),$("#"+t.pre+"modeselection").hide(),void 0!==$("#"+t.pre+"modeswitch")[0]&&($("#"+t.pre+"modeswitch")[0].checked=!1),$("#"+t.pre+"style").hasClass("icn3d-modeselection")&&$("#"+t.pre+"style").removeClass("icn3d-modeselection"),$("#"+t.pre+"color").hasClass("icn3d-modeselection")&&$("#"+t.pre+"color").removeClass("icn3d-modeselection")):($("#"+t.pre+"modeall").hide(),$("#"+t.pre+"modeselection").show(),void 0!==$("#"+t.pre+"modeswitch")[0]&&($("#"+t.pre+"modeswitch")[0].checked=!0),$("#"+t.pre+"style").hasClass("icn3d-modeselection")||$("#"+t.pre+"style").addClass("icn3d-modeselection"),$("#"+t.pre+"color").hasClass("icn3d-modeselection")||$("#"+t.pre+"color").addClass("icn3d-modeselection"))}getAtomsFromOneSet(e){let t=this.icn3d,s=t.icn3dui,i={};if(void 0===t.defNames2Residues.proteins&&this.showSets(),-1!==Object.keys(t.chains).indexOf(e))i=s.hashUtilsCls.unionHash(i,t.chains[e]);else{if(void 0!==t.defNames2Residues[e]&&t.defNames2Residues[e].length>0)for(let l=0,n=t.defNames2Residues[e].length;l<n;++l){let n=t.defNames2Residues[e][l];i=s.hashUtilsCls.unionHash(i,t.residues[n])}if(void 0!==t.defNames2Atoms[e]&&t.defNames2Atoms[e].length>0)for(let s=0,l=t.defNames2Atoms[e].length;s<l;++s){i[t.defNames2Atoms[e][s]]=1}}return i}getAtomsFromNameArray(e){let t=this.icn3d,s=t.icn3dui,i={};for(let l=0,n=e.length;l<n;++l)if("non-selected"===e[l]){let e={};for(let s in t.atoms)!t.hAtoms.hasOwnProperty(s)&&t.dAtoms.hasOwnProperty(s)&&(e[s]=t.atoms[s]);i=s.hashUtilsCls.unionHash(i,e)}else i="selected"===e[l]?s.hashUtilsCls.unionHash(i,s.hashUtilsCls.hash2Atoms(t.hAtoms,t.atoms)):s.hashUtilsCls.unionHash(i,s.hashUtilsCls.hash2Atoms(this.getAtomsFromOneSet(e[l]),t.atoms));return 0==e.length&&(i=t.atoms),i}}class F{constructor(e){this.icn3d=e}isHbondDonorAcceptor(e){let t=this.icn3d;if(t.icn3dui,"N"==e.name&&!e.het||"N"==e.elem&&"Arg"==e.resn||"N"==e.elem&&"Asn"==e.resn||"N"==e.elem&&"Gln"==e.resn||"N"==e.elem&&"Lys"==e.resn||"N"==e.elem&&"Trp"==e.resn)return"donor";if("O"==e.name&&!e.het||"S"==e.elem&&"Met"==e.resn||"O"==e.elem&&"Asn"==e.resn||"O"==e.elem&&"Asp"==e.resn||"O"==e.elem&&"Gln"==e.resn||"O"==e.elem&&"Glu"==e.resn)return"acceptor";if("S"==e.elem&&"Cys"==e.resn||"N"==e.elem&&"His"==e.resn||"O"==e.elem&&"Ser"==e.resn||"O"==e.elem&&"Thr"==e.resn||"O"==e.elem&&"Tyr"==e.resn)return"both";if("Pro"==e.resn)return"none";if("N"==e.elem){if("Asn"==e.resn||"Gln"==e.resn)return"both";let s=0,i=0;for(let i=0,l=e.bonds.length;i<l;++i)"H"==t.atoms[e.bonds[i]].elem&&++s;if(2==s)return"donor";s=0;for(let l=0,n=e.bonds.length;l<n;++l){let n=t.atoms[e.bonds[l]];if("H"!=n.elem){++s;for(let e=0,s=n.bonds.length;e<s;++e)"N"==t.atoms[n.bonds[e]].elem&&++i}}return 1==s?"donor":2==s?i>1?"ring":"donor":"none"}if("O"==e.elem&&1==e.bonds.length){if("Asn"==e.resn||"Gln"==e.resn)return"both";for(let s=0,i=e.bonds.length;s<i;++s)if("H"==t.atoms[e.bonds[s]].elem)return"donor";let s=t.atoms[e.bonds[0]],i=0;for(let e=0,l=s.bonds.length;e<l;++e)"O"!=t.atoms[s.bonds[e]].elem&&"N"!=t.atoms[s.bonds[e]].elem&&"S"!=t.atoms[s.bonds[e]].elem||++i;return i>=2?"acceptor":"both"}if("O"==e.elem&&2==e.bonds.length){for(let s=0,i=e.bonds.length;s<i;++s)if("H"==t.atoms[e.bonds[s]].elem)return"donor";return"acceptor"}return"both"}calcAngles(e,t){let s=this.icn3d;s.icn3dui;let i=[],l=new THREE.Vector3,n=new THREE.Vector3;l.subVectors(t.coord,e.coord);for(let t=0,o=e.bonds.length;t<o;++t)"H"!=s.atoms[e.bonds[t]].elem&&(n.subVectors(s.atoms[e.bonds[t]].coord,e.coord),i.push(l.angleTo(n)));return i}calcPlaneAngle(e,t){let s=this.icn3d;s.icn3dui;let i=e,l=new THREE.Vector3;l.subVectors(t.coord,e.coord);let n=[new THREE.Vector3,new THREE.Vector3],o=0;for(let t=0,l=e.bonds.length;t<l&&!(o>1);++t)"H"!=s.atoms[e.bonds[t]].elem&&(i=s.atoms[e.bonds[t]],n[o++].subVectors(s.atoms[e.bonds[t]].coord,e.coord));if(1===o)for(let t=0,l=i.bonds.length;t<l&&!(o>1);++t)"H"!=s.atoms[i.bonds[t]].elem&&s.atoms[i.bonds[t]].serial!=e.serial&&n[o++].subVectors(s.atoms[i.bonds[t]].coord,e.coord);if(2!==o)return;let r=n[0].cross(n[1]);return Math.abs(Math.PI/2-r.angleTo(l))}isValidHbond(e,t,s){let i=this.icn3d;i.icn3dui;let l,n,o=this.isHbondDonorAcceptor(e),r=this.isHbondDonorAcceptor(t),a=50*Math.PI/180,d=50*Math.PI/180,c=90*Math.PI/180,h=30*Math.PI/180;if("donor"==o&&("acceptor"==r||"both"==r||"ring"==r)||"acceptor"==r&&("donor"==o||"both"==o||"ring"==o))l=e,n=t;else if("acceptor"==o&&("donor"==r||"both"==r||"ring"==r)||"donor"==r&&("acceptor"==o||"both"==o||"ring"==o))n=e,l=t;else{if("both"!=o&&"ring"!=o||"both"!=r&&"ring"!=r)return!1;l=e,n=t,i.nucleotides.hasOwnProperty(e.serial)&&i.nucleotides.hasOwnProperty(t.serial)&&("ring"==o||"ring"==r)||(e.het||t.het)&&"ring"==o&&"ring"==r||(h=90*Math.PI/180)}let m=this.calcAngles(l,n),p=90*Math.PI/180;for(let e=0,t=m.length;e<t;++e)if(Math.abs(p-m[e])>d)return!1;let u=this.calcPlaneAngle(l,n);if(void 0!==u&&u>h)return!1;let C=this.calcAngles(n,l),g=90*Math.PI/180;for(let e=0,t=C.length;e<t;++e)if(Math.abs(g-C[e])>a)return!1;let f=this.calcPlaneAngle(n,l);return!(void 0!==f&&f>c)}calculateChemicalHbonds(e,t,s,i,l,n){let o=this.icn3d,r=o.icn3dui;if(0===Object.keys(e).length||0===Object.keys(t).length)return;o.resid2Residhash={};let a,d,c={},h=s*s;for(let t in e){let s=e[t],l=i?"LYS"===s.resn&&"N"===s.elem&&"N"!==s.name||"ARG"===s.resn&&("NH1"===s.name||"NH2"===s.name)||("GLU"===s.resn||"ASP"===s.resn)&&"O"===s.elem&&"O"!==s.name||s.het&&("N"===s.elem||"O"===s.elem||"S"===s.elem):"N"===s.elem||"O"===s.elem||"S"===s.elem&&(s.het||"Cys"===s.resn||"Met"===s.resn);l=o.bOpm?l&&"DUM"!==s.resn:l,l&&(a=s.structure+"_"+s.chain+"_"+s.resi,d=a+"_"+s.name,c[d]=s)}let m={},p={},u=.5,C=-27.888,g={};for(let e in t){let f=t[e],b=i?"LYS"===f.resn&&"N"===f.elem&&"N"!==f.name||"ARG"===f.resn&&("NH1"===f.name||"NH2"===f.name)||("GLU"===f.resn||"ASP"===f.resn)&&"O"===f.elem&&"O"!==f.name||f.het&&("N"===f.elem||"O"===f.elem||"S"===f.elem):"N"===f.elem||"O"===f.elem||"S"===f.elem&&(f.het||"Cys"===f.resn||"Met"===f.resn);if(b=o.bOpm?b&&"DUM"!==f.resn:b,b){a=f.structure+"_"+f.chain+"_"+f.resi,d=a+"_"+f.name;let e=f.resn+" $"+f.structure+"."+f.chain+":"+f.resi+"@"+f.name;void 0===o.resid2Residhash[e]&&(o.resid2Residhash[e]={});for(let t in c){if(i&&!(("LYS"!==f.resn&&"ARG"!==f.resn||"LYS"!==c[t].resn&&"ARG"!==c[t].resn)&&("GLU"!==f.resn&&"ASP"!==f.resn||"GLU"!==c[t].resn&&"ASP"!==c[t].resn)))continue;if(!o.crossstrucinter&&f.structure!=c[t].structure)continue;if(a==t.substr(0,t.lastIndexOf("_")))continue;let d=Math.abs(f.coord.x-c[t].coord.x);if(d>s)continue;let b=Math.abs(f.coord.y-c[t].coord.y);if(b>s)continue;let y=Math.abs(f.coord.z-c[t].coord.z);if(y>s)continue;let v=d*d+b*b+y*y;if(v>h)continue;if(!o.proteins.hasOwnProperty(f.serial)||!o.proteins.hasOwnProperty(c[t].serial)||"N"!==f.name&&"O"!==f.name||"O"!==c[t].name&&"N"!==c[t].name){if(!this.isValidHbond(f,c[t],s))continue}else{if(f.name===c[t].name)continue;if(f.structure==c[t].structure&&f.chain==c[t].chain&&Math.abs(f.resi-c[t].resi)<=1)continue;let e,i="N"===f.name?f:c[t],l="O"===f.name?f:c[t];if("Pro"===i.resn)continue;if(void 0===i.hcoord){if(!this.isValidHbond(f,c[t],s))continue}else{let s,n=i.hcoord,r=i.coord,a=l.structure+"_"+l.chain+"_"+l.resi;for(let e in o.residues[a])if("C"===o.atoms[e].name){s=o.atoms[e];break}let d=s.coord,h=l.coord,m=n.distanceTo(h),p=n.distanceTo(d),g=r.distanceTo(d),b=r.distanceTo(h);if(e=m<u||p<u||g<u||b<u?-9.9:C/m-C/p+C/g-C/b,"helix"==f.ss&&"helix"==c[t].ss&&e>-.5)continue}}if(g[f.serial]>2||g[c[t].serial]>2)continue;void 0===g[f.serial]?g[f.serial]=1:++g[f.serial],void 0===g[c[t].serial]?g[c[t].serial]=1:++g[c[t].serial],"graph"!==l&&(i?(o.saltbridgepnts.push({serial:f.serial,coord:f.coord}),o.saltbridgepnts.push({serial:c[t].serial,coord:c[t].coord})):(o.hbondpnts.push({serial:f.serial,coord:f.coord}),o.hbondpnts.push({serial:c[t].serial,coord:c[t].coord})));let w=c[t].structure+"_"+c[t].chain+"_"+c[t].resi;m=r.hashUtilsCls.unionHash(m,o.residues[a]),m=r.hashUtilsCls.unionHash(m,o.residues[w]),p[a]=1,p[w]=1;let S=c[t].resn+" $"+c[t].structure+"."+c[t].chain+":"+c[t].resi+"@"+c[t].name,_=a+"_"+f.resn+","+w+"_"+c[t].resn;void 0!==o.resids2interAll[_]&&void 0!==o.resids2interAll[_].ionic&&o.resids2interAll[_].ionic.hasOwnProperty(e+","+S)||(o.resid2Residhash[e][S]=v.toFixed(1),n||(void 0===o.resids2inter[_]&&(o.resids2inter[_]={}),void 0===o.resids2inter[_].hbond&&(o.resids2inter[_].hbond={}),o.resids2inter[_].hbond[e+","+S]=v.toFixed(1)),void 0===o.resids2interAll[_]&&(o.resids2interAll[_]={}),void 0===o.resids2interAll[_].hbond&&(o.resids2interAll[_].hbond={}),o.resids2interAll[_].hbond[e+","+S]=v.toFixed(1))}}}let f=Object.keys(p);if("graph"!==l)for(let e=0,t=f.length;e<t;++e)for(let t in o.residues[f[e]])o.atoms[t].style2="stick";return m}setHbondsContacts(e,t){let s=this.icn3d;s.icn3dui;let i=t,l="hbond"==t?"hbonds":t;if(s.lines[i]=[],"yes"===e[l].toLowerCase()){let e,l;"hbond"==t?(l=s.hbondpnts,e="#0F0"):"saltbridge"==t?(l=s.saltbridgepnts,e="#0FF"):"contact"==t?(l=s.contactpnts,e="#888"):"halogen"==t?(l=s.halogenpnts,e="#F0F"):"pi-cation"==t?(l=s.picationpnts,e="#F00"):"pi-stacking"==t&&(l=s.pistackingpnts,e="#00F");for(let t=0,n=Math.floor(l.length/2);t<n;t++){let n={};n.position1=l[2*t].coord,n.serial1=l[2*t].serial,n.position2=l[2*t+1].coord,n.serial2=l[2*t+1].serial,n.color=e,n.dashed=!0,(void 0===n.serial1||void 0===n.serial2||s.dAtoms.hasOwnProperty(n.serial1)||s.dAtoms.hasOwnProperty(n.serial2))&&s.lines[i].push(n)}}}hideHbonds(){let e=this.icn3d;e.icn3dui,e.opts.hbonds="no",void 0===e.lines&&(e.lines={}),e.lines.hbond=[],e.hbondpnts=[];for(let t in e.atoms)e.atoms[t].style2="nothing";for(let t in e.sidec)e.hAtoms.hasOwnProperty(t)&&(e.atoms[t].style2=e.opts.sidec);for(let t in e.water)e.hAtoms.hasOwnProperty(t)&&(e.atoms[t].style=e.opts.water)}}class M{constructor(e){this.icn3d=e}calculateHalogenPiInteractions(e,t,s,i,l,n){let o=this.icn3d,r=o.icn3dui;if(0===Object.keys(e).length||0===Object.keys(t).length)return;let a={},d={},c={},h={};if("halogen"==l){for(let t in e){let s=e[t];a=r.hashUtilsCls.unionHash(a,this.getHalogenDonar(s)),c=r.hashUtilsCls.unionHash(c,this.getHalogenAcceptor(s))}for(let e in t){let s=t[e];h=r.hashUtilsCls.unionHash(h,this.getHalogenDonar(s)),d=r.hashUtilsCls.unionHash(d,this.getHalogenAcceptor(s))}}else if("pi-cation"==l){o.processedRes={};for(let t in e){let s=e[t];a=r.hashUtilsCls.unionHash(a,this.getPi(s,!1)),c=r.hashUtilsCls.unionHash(c,this.getCation(s))}o.processedRes={};for(let e in t){let s=t[e];h=r.hashUtilsCls.unionHash(h,this.getPi(s,!1)),d=r.hashUtilsCls.unionHash(d,this.getCation(s))}}else if("pi-stacking"==l){o.processedRes={};for(let t in e){let s=e[t];a=r.hashUtilsCls.unionHash(a,this.getPi(s,!0))}o.processedRes={};for(let e in t){let s=t[e];d=r.hashUtilsCls.unionHash(d,this.getPi(s,!0))}}let m={},p={};o.resid2Residhash={};let u=s*s;for(let e in a){let t=a[e],c=t.resn+" $"+t.structure+"."+t.chain+":"+t.resi+"@"+t.name;void 0===o.resid2Residhash[c]&&(o.resid2Residhash[c]={});for(let a in d){let h=d[a];if((o.crossstrucinter||t.structure==h.structure)&&e.substr(0,e.lastIndexOf("_"))!=a.substr(0,a.lastIndexOf("_"))){if("pi-cation"==l&&"ARG"===h.resn&&"NH1"===h.name){let e=h.structure+"_"+h.chain+"_"+h.resi,t=o.firstAtomObjCls.getFirstAtomObjByName(o.residues[e],"NH2"),s=h.coord.clone().add(t.coord).multiplyScalar(.5);h=r.hashUtilsCls.cloneHash(h),h.coord=s}if("pi-stacking"==l&&void 0!==t.normal&&void 0!==h.normal){let e=Math.abs(t.normal.dot(h.normal));if(e>.5&&e<.866)continue}this.getHalogenPiInteractions(t,h,i,l,s,u,c,n)&&(m=r.hashUtilsCls.unionHash(m,o.residues[t.structure+"_"+t.chain+"_"+t.resi]),m=r.hashUtilsCls.unionHash(m,o.residues[h.structure+"_"+h.chain+"_"+h.resi]),p[t.structure+"_"+t.chain+"_"+t.resi]=1,p[h.structure+"_"+h.chain+"_"+h.resi]=1)}}}for(let e in c){let t=c[e],a=t.resn+" $"+t.structure+"."+t.chain+":"+t.resi+"@"+t.name;if(void 0===o.resid2Residhash[a]&&(o.resid2Residhash[a]={}),"pi-cation"==l&&"ARG"===t.resn&&"NH1"===t.name){let e=t.structure+"_"+t.chain+"_"+t.resi,s=o.firstAtomObjCls.getFirstAtomObjByName(o.residues[e],"NH2"),i=t.coord.clone().add(s.coord).multiplyScalar(.5);t=r.hashUtilsCls.cloneHash(t),t.coord=i}for(let d in h){let c=h[d];(o.crossstrucinter||t.structure==c.structure)&&(e.substr(0,e.lastIndexOf("_"))!=d.substr(0,d.lastIndexOf("_"))&&this.getHalogenPiInteractions(t,c,i,l,s,u,a,n)&&(m=r.hashUtilsCls.unionHash(m,o.residues[t.structure+"_"+t.chain+"_"+t.resi]),m=r.hashUtilsCls.unionHash(m,o.residues[c.structure+"_"+c.chain+"_"+c.resi]),p[t.structure+"_"+t.chain+"_"+t.resi]=1,p[c.structure+"_"+c.chain+"_"+c.resi]=1))}}let C=Object.keys(p);if("graph"!==i)for(let e=0,t=C.length;e<t;++e)for(let t in o.residues[C[e]])o.atoms[t].style2="stick",o.ions.hasOwnProperty(t)&&(o.atoms[t].style2="sphere");return m}getHalogenDonar(e){this.icn3d.icn3dui;let t={};if("CL"===e.elem||"BR"===e.elem||"I"===e.elem){t[e.structure+"_"+e.chain+"_"+e.resi+"_"+e.name]=e}return t}getHalogenAcceptor(e){let t=this.icn3d;t.icn3dui;let s={},i="N"===e.elem||"O"===e.elem||"S"===e.elem;if(i=t.bOpm?i&&"DUM"!==e.resn:i,i){s[e.structure+"_"+e.chain+"_"+e.resi+"_"+e.name]=e}return s}getPi(e,t){let s=this.icn3d,i=s.icn3dui,l={},n=e.structure+"_"+e.chain+"_"+e.resi,o=e.het||s.nucleotides.hasOwnProperty(e.serial)||"PHE"===e.resn||"TYR"===e.resn||"TRP"===e.resn;if(t&&(o=o||"HIS"===e.resn),o&&!s.processedRes.hasOwnProperty(n)){if(e.het){let e=this.getAromaticPisLigand(n);l=i.hashUtilsCls.unionHash(l,e)}else{let t,i,o;o=s.nucleotides.hasOwnProperty(e.serial)?this.getAromaticRings(e.resn,n,"nucleotide"):this.getAromaticRings(e.resn,n,"protein"),void 0!==o&&(t=o.piPosArray,i=o.normalArray);for(let s=0,o=t.length;s<o;++s)l[n+"_pi"+s]={resn:e.resn,name:"pi"+s,coord:t[s],serial:e.serial,structure:e.structure,chain:e.chain,resi:e.resi,normal:i[s]}}s.processedRes[n]=1}return l}getCation(e){let t=this.icn3d,s=t.icn3dui,i={};if("ARG"===e.resn&&"NH2"===e.name)return;let l="LYS"===e.resn&&"N"===e.elem&&"N"!==e.name||"ARG"===e.resn&&("NH1"===e.name||"NH2"===e.name)||e.het&&-1!==s.parasCls.cationsTrimArray.indexOf(e.elem)||e.het&&"N"===e.elem&&1==e.bonds.length;if(l=t.bOpm?l&&"DUM"!==e.resn:l,l){i[e.structure+"_"+e.chain+"_"+e.resi+"_"+e.name]=e}return i}getHalogenPiInteractions(e,t,s,i,l,n,o,r){let a=this.icn3d;a.icn3dui;let d=Math.abs(e.coord.x-t.coord.x);if(d>l)return!1;let c=Math.abs(e.coord.y-t.coord.y);if(c>l)return!1;let h=Math.abs(e.coord.z-t.coord.z);if(h>l)return!1;let m=d*d+c*c+h*h;if(m>n)return!1;"graph"!==s&&("halogen"==i?(a.halogenpnts.push({serial:e.serial,coord:e.coord}),a.halogenpnts.push({serial:t.serial,coord:t.coord})):"pi-cation"==i?(a.picationpnts.push({serial:e.serial,coord:e.coord}),a.picationpnts.push({serial:t.serial,coord:t.coord})):"pi-stacking"==i&&(a.pistackingpnts.push({serial:e.serial,coord:e.coord}),a.pistackingpnts.push({serial:t.serial,coord:t.coord})));let p=t.resn+" $"+t.structure+"."+t.chain+":"+t.resi+"@"+t.name;a.resid2Residhash[o][p]=m.toFixed(1);let u=e.structure+"_"+e.chain+"_"+e.resi+"_"+e.resn+","+t.structure+"_"+t.chain+"_"+t.resi+"_"+t.resn;return r||(void 0===a.resids2inter[u]&&(a.resids2inter[u]={}),void 0===a.resids2inter[u][i]&&(a.resids2inter[u][i]={}),a.resids2inter[u][i][o+","+p]=m.toFixed(1)),void 0===a.resids2interAll[u]&&(a.resids2interAll[u]={}),void 0===a.resids2interAll[u][i]&&(a.resids2interAll[u][i]={}),a.resids2interAll[u][i][o+","+p]=m.toFixed(1),!0}getRingNormal(e){if(this.icn3d.icn3dui,e.length<3)return;let t=e[0].clone().sub(e[1]),s=e[1].clone().sub(e[2]);return t.cross(s).normalize()}getAromaticRings(e,t,s){let i=this.icn3d;i.icn3dui;let l=[],n=[],o=[],r=[];if("nucleotide"==s){let s=new THREE.Vector3,a=new THREE.Vector3;if("A"==e.trim().toUpperCase()||"DA"==e.trim().toUpperCase()||"G"==e.trim().toUpperCase()||"DG"==e.trim().toUpperCase()){for(let e in i.residues[t]){let t=i.atoms[e];"N1"==t.name||"C2"==t.name||"N3"==t.name||"C6"==t.name?(s.add(t.coord),o.push(t.coord)):"C4"==t.name||"C5"==t.name?(s.add(t.coord),a.add(t.coord),o.push(t.coord),r.push(t.coord)):"N7"!=t.name&&"C8"!=t.name&&"N9"!=t.name||(a.add(t.coord),r.push(t.coord))}6==o.length&&(s.multiplyScalar(1/6),l.push(s),n.push(this.getRingNormal(o))),5==r.length&&(a.multiplyScalar(.2),l.push(a),n.push(this.getRingNormal(r)))}else if("C"==e.trim().toUpperCase()||"DC"==e.trim().toUpperCase()||"T"==e.trim().toUpperCase()||"DT"==e.trim().toUpperCase()||"U"==e.trim().toUpperCase()||"DU"==e.trim().toUpperCase()){for(let e in i.residues[t]){let t=i.atoms[e];"N1"==t.name||"C2"==t.name||"N3"==t.name||"C6"==t.name?(s.add(t.coord),o.push(t.coord)):"C4"!=t.name&&"C5"!=t.name||(s.add(t.coord),o.push(t.coord))}6==o.length&&(s.multiplyScalar(1/6),l.push(s),n.push(this.getRingNormal(o)))}}else if("protein"==s){let s=new THREE.Vector3,a=new THREE.Vector3;if("PHE"==e.toUpperCase()||"TYR"==e.toUpperCase()){for(let e in i.residues[t]){let t=i.atoms[e];"CG"!=t.name&&"CD1"!=t.name&&"CE1"!=t.name&&"CZ"!=t.name&&"CE2"!=t.name&&"CD2"!=t.name||(s.add(t.coord),o.push(t.coord))}6==o.length&&(s.multiplyScalar(1/6),l.push(s),n.push(this.getRingNormal(o)))}else if("HIS"==e.toUpperCase()){for(let e in i.residues[t]){let t=i.atoms[e];"CG"!=t.name&&"ND1"!=t.name&&"CE1"!=t.name&&"NE2"!=t.name&&"CD2"!=t.name||(s.add(t.coord),o.push(t.coord))}5==o.length&&(s.multiplyScalar(.2),l.push(s),n.push(this.getRingNormal(o)))}else if("TRP"==e.toUpperCase()){for(let e in i.residues[t]){let t=i.atoms[e];"CZ2"==t.name||"CH2"==t.name||"CZ3"==t.name||"CE3"==t.name?(s.add(t.coord),o.push(t.coord)):"CD2"==t.name||"CE2"==t.name?(s.add(t.coord),a.add(t.coord),o.push(t.coord),r.push(t.coord)):"CG"!=t.name&&"CD1"!=t.name&&"NE1"!=t.name||(a.add(t.coord),r.push(t.coord))}6==o.length&&(s.multiplyScalar(1/6),l.push(s),n.push(this.getRingNormal(o))),5==r.length&&(a.multiplyScalar(.2),l.push(a),n.push(this.getRingNormal(r)))}}return{piPosArray:l,normalArray:n}}dfs_cycle(e,t,s){let i=this.icn3d;if(i.icn3dui,2==i.ring_color[e])return s;if(1==i.ring_color[e]){s++;let l=t;for(i.ring_mark[l]=s;l!=e;)l=i.ring_par[l],i.ring_mark[l]=s;return s}if(i.ring_par[e]=t,i.ring_color[e]=1,void 0!==i.atoms[e])for(let t=0,l=i.atoms[e].bonds.length;t<l;++t){let l=i.atoms[e].bonds[t];l!=i.ring_par[e]&&(s=this.dfs_cycle(l,e,s))}return i.ring_color[e]=2,s}getAromaticPisLigand(e){let t=this.icn3d;t.icn3dui;let s={},i=Object.keys(t.residues[e]),l=i.length;t.ring_color={},t.ring_par={},t.ring_mark={};let n=0;n=this.dfs_cycle(i[1],i[0],n);let o={};for(let e=0;e<l;e++){let s=i[e];0!=t.ring_mark[s]&&(void 0===o[t.ring_mark[s]]&&(o[t.ring_mark[s]]=[]),o[t.ring_mark[s]].push(s))}for(let i=1;i<=n;i++){let l,n=new THREE.Vector3,r=0,a=[];if(o.hasOwnProperty(i))for(let e=0,s=o[i].length;e<s;++e)l=o[i][e],n.add(t.atoms[l].coord),a.push(t.atoms[l].coord),++r;if(5==r||6==r){let i=a[0].clone().sub(a[1]).normalize(),o=a[1].clone().sub(a[2]).normalize(),d=a[2].clone().sub(a[3]).normalize(),c=i.cross(o).normalize(),h=c.dot(d);if(Math.abs(h)<.052){n.multiplyScalar(1/r);let i=t.atoms[l];s[e+"_pi"+l]={resn:i.resn,name:"pi"+l,coord:n,serial:i.serial,structure:i.structure,chain:i.chain,resi:i.resi,normal:c}}}}return s}hideHalogenPi(){let e=this.icn3d;e.icn3dui,e.opts.halogen="no",e.opts["pi-cation"]="no",e.opts["pi-stacking"]="no",void 0===e.lines&&(e.lines={}),e.lines.halogen=[],e.lines["pi-cation"]=[],e.lines["pi-stacking"]=[],e.halogenpnts=[],e.picationpnts=[],e.pistackingpnts=[];for(let t in e.atoms)e.atoms[t].style2="nothing";for(let t in e.sidec)e.hAtoms.hasOwnProperty(t)&&(e.atoms[t].style2=e.opts.sidec);for(let t in e.water)e.hAtoms.hasOwnProperty(t)&&(e.atoms[t].style=e.opts.water)}}class L{constructor(e){this.icn3d=e}calculateIonicInteractions(e,t,s,i,l,n){let o=this.icn3d,r=o.icn3dui;if(0===Object.keys(e).length||0===Object.keys(t).length)return;o.resid2Residhash={};let a,d,c={},h={},m=s*s;for(let t in e){let s=e[t];if("ARG"===s.resn&&"NH2"===s.name||"GLU"===s.resn&&"OE2"===s.name||"ASP"===s.resn&&"OD2"===s.name)continue;let i,l=("LYS"===s.resn||"HIS"===s.resn)&&"N"===s.elem&&"N"!==s.name||"ARG"===s.resn&&("NH1"===s.name||"NH2"===s.name)||s.het&&-1!==r.parasCls.cationsTrimArray.indexOf(s.elem)||s.het&&"N"===s.elem&&1==s.bonds.length;if(s.het&&"O"===s.elem&&1==s.bonds.length){let e=o.atoms[s.bonds[0]];for(let t=0;t<e.bonds.length;++t){let l=e.bonds[t];if("O"==o.atoms[l].elem&&l!=s.serial){i=!0;break}}}let n="GLU"===s.resn&&("OE1"===s.name||"OE2"===s.name)||"ASP"===s.resn&&("OD1"===s.name||"OD2"===s.name)||o.nucleotides.hasOwnProperty(s.serial)&&("OP1"===s.name||"OP2"===s.name||"O1P"===s.name||"O2P"===s.name)||s.het&&-1!==r.parasCls.anionsTrimArray.indexOf(s.elem)||i;l=o.bOpm?l&&"DUM"!==s.resn:l,n=o.bOpm?n&&"DUM"!==s.resn:n,(l||n)&&(a=s.structure+"_"+s.chain+"_"+s.resi,d=a+"_"+s.name,l&&(c[d]=s),n&&(h[d]=s))}let p={},u={};for(let e in t){let i=t[e];if("ARG"===i.resn&&"NH2"===i.name||"GLU"===i.resn&&"OE2"===i.name||"ASP"===i.resn&&"OD2"===i.name)continue;let C=("LYS"===i.resn||"HIS"===i.resn)&&"N"===i.elem&&"N"!==i.name||"ARG"===i.resn&&("NH1"===i.name||"NH2"===i.name)||i.het&&-1!==r.parasCls.cationsTrimArray.indexOf(i.elem),g="GLU"===i.resn&&("OE1"===i.name||"OE2"===i.name)||"ASP"===i.resn&&("OD1"===i.name||"OD2"===i.name)||o.nucleotides.hasOwnProperty(i.serial)&&("OP1"===i.name||"OP2"===i.name||"O1P"===i.name||"O2P"===i.name)||i.het&&-1!==r.parasCls.anionsTrimArray.indexOf(i.elem);if(C=o.bOpm?C&&"DUM"!==i.resn:C,g=o.bOpm?g&&"DUM"!==i.resn:g,C||g){a=i.structure+"_"+i.chain+"_"+i.resi,d=a+"_"+i.name;let e=i.resn+" $"+i.structure+"."+i.chain+":"+i.resi+"@"+i.name;void 0===o.resid2Residhash[e]&&(o.resid2Residhash[e]={});let t={};C?t=h:g&&(t=c);let f,b=i.structure+"_"+i.chain+"_"+i.resi;C&&"ARG"===i.resn&&"NH1"===i.name?f=o.firstAtomObjCls.getFirstAtomObjByName(o.residues[b],"NH2"):g&&"GLU"===i.resn&&"OE1"===i.name?f=o.firstAtomObjCls.getFirstAtomObjByName(o.residues[b],"OE2"):g&&"ASP"===i.resn&&"OD1"===i.name&&(f=o.firstAtomObjCls.getFirstAtomObjByName(o.residues[b],"OD2"));let y=void 0===f?i.coord:i.coord.clone().add(f.coord).multiplyScalar(.5);for(let d in t){if(a==d.substr(0,d.lastIndexOf("_")))continue;if(!o.crossstrucinter&&i.structure!=t[d].structure)continue;let c,h=t[d].structure+"_"+t[d].chain+"_"+t[d].resi;g&&"ARG"===t[d].resn&&"NH1"===t[d].name?c=o.firstAtomObjCls.getFirstAtomObjByName(o.residues[h],"NH2"):C&&"GLU"===t[d].resn&&"OE1"===t[d].name?c=o.firstAtomObjCls.getFirstAtomObjByName(o.residues[h],"OE2"):C&&"ASP"===t[d].resn&&"OD1"===t[d].name&&(c=o.firstAtomObjCls.getFirstAtomObjByName(o.residues[h],"OD2"));let f=void 0===c?t[d].coord:t[d].coord.clone().add(c.coord).multiplyScalar(.5),b=Math.abs(y.x-f.x);if(b>s)continue;let v=Math.abs(y.y-f.y);if(v>s)continue;let w=Math.abs(y.z-f.z);if(w>s)continue;let S=b*b+v*v+w*w;if(S>m)continue;"graph"!==l&&(o.saltbridgepnts.push({serial:i.serial,coord:y}),o.saltbridgepnts.push({serial:t[d].serial,coord:f}));let _=t[d].structure+"_"+t[d].chain+"_"+t[d].resi;p=r.hashUtilsCls.unionHash(p,o.residues[a]),p=r.hashUtilsCls.unionHash(p,o.residues[_]),u[a]=1,u[_]=1;let A=t[d].resn+" $"+t[d].structure+"."+t[d].chain+":"+t[d].resi+"@"+t[d].name;o.resid2Residhash[e][A]=S.toFixed(1);let x=a+"_"+i.resn+","+_+"_"+t[d].resn;n||(void 0===o.resids2inter[x]&&(o.resids2inter[x]={}),void 0===o.resids2inter[x].ionic&&(o.resids2inter[x].ionic={}),o.resids2inter[x].ionic[e+","+A]=S.toFixed(1)),void 0===o.resids2interAll[x]&&(o.resids2interAll[x]={}),void 0===o.resids2interAll[x].ionic&&(o.resids2interAll[x].ionic={}),o.resids2interAll[x].ionic[e+","+A]=S.toFixed(1)}}}let C=Object.keys(u);if("graph"!==l)for(let e=0,t=C.length;e<t;++e)for(let t in o.residues[C[e]])o.atoms[t].style2="stick",o.ions.hasOwnProperty(t)&&(o.atoms[t].style2="sphere");return p}hideSaltbridge(){let e=this.icn3d;e.icn3dui,e.opts.saltbridge="no",void 0===e.lines&&(e.lines={}),e.lines.saltbridge=[],e.saltbridgepnts=[];for(let t in e.atoms)e.atoms[t].style2="nothing";for(let t in e.sidec)e.hAtoms.hasOwnProperty(t)&&(e.atoms[t].style2=e.opts.sidec);for(let t in e.water)e.hAtoms.hasOwnProperty(t)&&(e.atoms[t].style=e.opts.water)}}class N{constructor(e){this.icn3d=e}getGraphData(e,t,s,i,l,n,o){let r=this.icn3d,a=r.icn3dui,d="",c="",h=[],m=[],p=this.getNodesLinksForSet(e,n,"a",o),u=this.getNodesLinksForSet(t,n,"b",o);h=p.node.concat(u.node);let C=[],g={},f=0;for(let e=0,t=h.length;e<t;++e){let t=h[e],s=JSON.parse(t);if(g.hasOwnProperty(s.id)){C[g[s.id]].s="ab"}else C.push(s),g[s.id]=f,++f}let b=[];for(let e=0,t=C.length;e<t;++e){let t=C[e];b.push(JSON.stringify(t))}d=b.join(", "),m=p.link.concat(u.link),c=m.join(", ");let y=a.hashUtilsCls.unionHash(a.hashUtilsCls.cloneHash(t),e),v="",w="",S="",_="",A="",x="";1==s.length&&1==i.length&&s[0]==i[0]||(v+=this.getHbondLinksForSet(e,n),v+=this.getHbondLinksForSet(t,n)),1==s.length&&1==i.length&&s[0]==i[0]||(w+=this.getIonicLinksForSet(e,n),w+=this.getIonicLinksForSet(t,n)),1==s.length&&1==i.length&&s[0]==i[0]||(S+=this.getHalogenPiLinksForSet(e,n),S+=this.getHalogenPiLinksForSet(t,n)),1==s.length&&1==i.length&&s[0]==i[0]||(_+=this.getContactLinksForSet(e,n),_+=this.getContactLinksForSet(t,n));for(let e in r.ssbondpnts)for(let t=0,s=r.ssbondpnts[e].length;t<s;t+=2){let s=r.ssbondpnts[e][t],i=r.ssbondpnts[e][t+1],l=r.firstAtomObjCls.getFirstAtomObj(r.residues[s]),o=r.firstAtomObjCls.getFirstAtomObj(r.residues[i]);if(y.hasOwnProperty(l.serial)&&y.hasOwnProperty(o.serial)){let e=a.utilsCls.residueName2Abbr(l.resn)+l.resi;"chain"!=n&&"structure"!=n||(e+="."+l.chain),"structure"==n&&(e+="."+l.structure);let t=a.utilsCls.residueName2Abbr(o.resn)+o.resi;"chain"!=n&&"structure"!=n||(t+="."+o.chain),"structure"==n&&(t+="."+o.structure),A+=', {"source": "'+e+'", "target": "'+t+'", "v": '+r.icn3dui.htmlCls.ssbondValue+', "c": "'+r.icn3dui.htmlCls.ssbondColor+'"}'}}for(let e in r.clbondpnts)for(let t=0,s=r.clbondpnts[e].length;t<s;t+=2){let s=r.clbondpnts[e][t],i=r.clbondpnts[e][t+1],l=r.firstAtomObjCls.getFirstAtomObj(r.residues[s]),o=r.firstAtomObjCls.getFirstAtomObj(r.residues[i]);if(y.hasOwnProperty(l.serial)&&y.hasOwnProperty(o.serial)){let e=a.utilsCls.residueName2Abbr(l.resn)+l.resi;"chain"!=n&&"structure"!=n||(e+="."+l.chain),"structure"==n&&(e+="."+l.structure);let t=a.utilsCls.residueName2Abbr(o.resn)+o.resi;"chain"!=n&&"structure"!=n||(t+="."+o.chain),"structure"==n&&(t+="."+o.structure),x+=', {"source": "'+e+'", "target": "'+t+'", "v": '+r.icn3dui.htmlCls.clbondValue+', "c": "'+r.icn3dui.htmlCls.clbondColor+'"}'}}let k='{"nodes": ['+d+'], "links": [';return k+=""==c?c+l.substr(1)+A+x+_+v+w+S:c+l+A+x+_+v+w+S,k+="]}",k}drawResNode(e,t,s,i,l,n,o,r,a){let d=this.icn3d;d.icn3dui;let c,h=e.r.substr(4);c=r?l-t*(s+i):l+t*(s+i),d.firstAtomObjCls.getFirstAtomObj(d.residues[h]);let m="#"+e.c.toUpperCase();d.hColor.getHexString().toUpperCase();let p=e.id.indexOf("."),u=-1==p?e.id:e.id.substr(0,p),C="a"==o?-7:10;t%2==1&&(C="a"==o?C-7:C+7),a&&(u=u.substr(1),r||(C+=4*s));let g="<g class='icn3d-node' resid='"+h+"' >";return g+="<title>"+e.id+"</title>",r?(g+="<circle cx='"+n+"' cy='"+c+"' r='"+s+"' fill='"+m+"' stroke-width='1' stroke='"+"#000' resid='"+h+"' />",g+="<text x='"+(n-20).toString()+"' y='"+(c+2).toString()+"' fill='"+"#000' stroke='none' style='font-size:6; text-anchor:middle' >"+u+"</text>"):(g+="<circle cx='"+c+"' cy='"+n+"' r='"+s+"' fill='"+m+"' stroke-width='1' stroke='"+"#000' resid='"+h+"' />",g+="<text x='"+(c+0).toString()+"' y='"+(n+C).toString()+"' fill='"+"#000' stroke='none' style='font-size:6; text-anchor:middle' >"+u+"</text>"),g+="</g>",g}getNodeTopBottom(e,t,s){this.icn3d.icn3dui;let i=this,l=[],n=[];for(let s in e){let e=t[s];e&&("a"==e.s?l.push(e):"b"==e.s?n.push(e):"ab"==e.s&&(l.push(e),n.push(e)))}return l.sort((function(e,t){return i.compNode(e,t)})),n.sort((function(e,t){return i.compNode(e,t,s)})),{nodeArray1:l,nodeArray2:n}}updateGraphJson(e,t,s,i,l){let n=this.icn3d.icn3dui,o="";return o+='"structure'+t+'": {"id": "'+e+'", "nodes1":[',o+=n.utilsCls.getJSONFromArray(s),o+='], \n"nodes2":[',o+=n.utilsCls.getJSONFromArray(i),o+='], \n"links":[',o+=n.utilsCls.getJSONFromArray(l),o+="]}",o}updateGraphColor(){let e=this.icn3d,t=e.icn3dui;if(void 0!==e.graphStr){let s=JSON.parse(e.graphStr),i={};for(let t in e.residues){let s=e.firstAtomObjCls.getFirstAtomObj(e.residues[t]);i[t]=s.color.getHexString().toUpperCase()}let l={};for(let e=0,n=s.nodes.length;e<n;++e){let n=s.nodes[e],o=[];o.push(""),o.push("");let r=n.r.substr(4);o=o.concat(t.utilsCls.getIdArray(r));let a=o[2]+"_"+o[3]+"_"+o[4];n.c=i[a],l[n.id]=a}for(let t=0,n=s.links.length;t<n;++t){let n=s.links[t];if(n.v==e.icn3dui.htmlCls.ssValue||n.v==e.icn3dui.htmlCls.coilValue){let e=l[n.target];n.c=i[e]}}e.graphStr=JSON.stringify(s)}e.bGraph&&e.drawGraphCls.drawGraph(e.graphStr,e.pre+"dl_graph"),e.bLinegraph&&e.lineGraphCls.drawLineGraph(e.graphStr),e.bScatterplot&&e.lineGraphCls.drawLineGraph(e.graphStr,!0)}handleForce(){let e=this.icn3d;0==e.icn3dui.htmlCls.force&&void 0!==e.simulation?(e.simulation.stop(),e.simulation.force("charge",null),e.simulation.force("x",null),e.simulation.force("y",null),e.simulation.force("r",null),e.simulation.force("link",null)):e.drawGraphCls.drawGraph(e.graphStr,e.pre+"dl_graph")}getNodesLinksForSet(e,t,s,i){let l=this.icn3d,n=l.icn3dui,o=[],r=[],a=0,d=l.icn3dui.htmlCls.coilValue,c="",h="",m=0,p={};for(let u in e){let e=l.atoms[u];if("DUM"!=e.chain&&(i||e.het||"CA"==e.name&&"C"==e.elem||"O3'"==e.name||"O3*"==e.name||"P"==e.name)){let i=e.structure+"_"+e.chain+"_"+e.resi;if(p.hasOwnProperty(i))continue;p[i]=1;let u=n.utilsCls.residueName2Abbr(e.resn)+e.resi;"chain"!=t&&"structure"!=t||(u+="."+e.chain),"structure"==t&&(u+="."+e.structure);let C="1_1_"+i;o.push('{"id": "'+u+'", "r": "'+C+'", "s": "'+s+'", "x": '+e.coord.x.toFixed(0)+', "y": '+e.coord.y.toFixed(0)+', "c": "'+e.color.getHexString().toUpperCase()+'"}'),a>0&&c==e.chain&&(parseInt(e.resi)==parseInt(m)+1||e.resi==m)&&(r.push('{"source": "'+h+'", "target": "'+u+'", "v": '+d+', "c": "'+e.color.getHexString().toUpperCase()+'"}'),e.ssbegin&&(d=l.icn3dui.htmlCls.ssValue),e.ssend&&(d=l.icn3dui.htmlCls.coilValue)),c=e.chain,h=u,m=e.resi,++a}}return{node:o,link:r}}getHbondLinksForSet(e,t){let s=this.icn3d,i=s.icn3dui,l={},n=parseFloat($("#"+s.pre+"hbondthreshold").val()),o=e,r=o;if(Object.keys(r).length>0&&Object.keys(o).length>0){let e=!1;s.hBondCls.calculateChemicalHbonds(i.hashUtilsCls.intHash2Atoms(s.dAtoms,r,s.atoms),i.hashUtilsCls.intHash2Atoms(s.dAtoms,o,s.atoms),parseFloat(n),e,"graph",!0),l=i.hashUtilsCls.cloneHash(s.resid2Residhash)}return this.getGraphLinks(l,l,s.icn3dui.htmlCls.hbondInsideColor,t,s.icn3dui.htmlCls.hbondValuehbondInsideValue)}getIonicLinksForSet(e,t){let s=this.icn3d,i=s.icn3dui,l={},n=parseFloat($("#"+s.pre+"saltbridgethreshold").val()),o=e,r=o;if(Object.keys(r).length>0&&Object.keys(o).length>0){let e=!1;s.saltbridgeCls.calculateIonicInteractions(i.hashUtilsCls.intHash2Atoms(s.dAtoms,r,s.atoms),i.hashUtilsCls.intHash2Atoms(s.dAtoms,o,s.atoms),parseFloat(n),e,"graph",!0),l=i.hashUtilsCls.cloneHash(s.resid2Residhash)}return this.getGraphLinks(l,l,s.icn3dui.htmlCls.ionicInsideColor,t,s.icn3dui.htmlCls.ionicInsideValue)}getHalogenPiLinksForSet(e,t){let s,i=this.icn3d,l=i.icn3dui,n={},o=e,r=o,a="";return s=parseFloat($("#"+i.pre+"halogenthreshold").val()),Object.keys(r).length>0&&Object.keys(o).length>0&&(i.piHalogenCls.calculateHalogenPiInteractions(l.hashUtilsCls.intHash2Atoms(i.dAtoms,o,i.atoms),l.hashUtilsCls.intHash2Atoms(i.dAtoms,r,i.atoms),parseFloat(s),"graph","halogen",!0),n=l.hashUtilsCls.cloneHash(i.resid2Residhash)),a+=this.getGraphLinks(n,n,i.icn3dui.htmlCls.halogenInsideColor,t,i.icn3dui.htmlCls.halogenInsideValue),s=parseFloat($("#"+i.pre+"picationthreshold").val()),Object.keys(r).length>0&&Object.keys(o).length>0&&(i.piHalogenCls.calculateHalogenPiInteractions(l.hashUtilsCls.intHash2Atoms(i.dAtoms,o,i.atoms),l.hashUtilsCls.intHash2Atoms(i.dAtoms,r,i.atoms),parseFloat(s),"graph","pi-cation",!0),n=l.hashUtilsCls.cloneHash(i.resid2Residhash)),a+=this.getGraphLinks(n,n,i.icn3dui.htmlCls.picationInsideColor,t,i.icn3dui.htmlCls.picationInsideValue),s=parseFloat($("#"+i.pre+"pistackingthreshold").val()),Object.keys(r).length>0&&Object.keys(o).length>0&&(i.piHalogenCls.calculateHalogenPiInteractions(l.hashUtilsCls.intHash2Atoms(i.dAtoms,o,i.atoms),l.hashUtilsCls.intHash2Atoms(i.dAtoms,r,i.atoms),parseFloat(s),"graph","pi-stacking",!0),n=l.hashUtilsCls.cloneHash(i.resid2Residhash)),a+=this.getGraphLinks(n,n,i.icn3dui.htmlCls.pistackingInsideColor,t,i.icn3dui.htmlCls.pistackingInsideValue),a}getContactLinksForSet(e,t,s){let i=this.icn3d;i.icn3dui;let l=[],n="",o="",r={};for(let t in e){let e=i.atoms[t];e.ss==n&&e.chain==o||(Object.keys(r).length>0&&l.push(r),r={}),r[e.serial]=1,n=e.ss,o=e.chain}Object.keys(r).length>0&&l.push(r);let a=l.length,d="";for(let e=0;e<a;++e)for(let i=e+1;i<a;++i)d+=this.getContactLinks(l[e],l[i],t,!0,s);return d}getContactLinks(e,t,s,i,l){let n=this.icn3d,o=n.icn3dui,r=parseFloat($("#"+n.pre+"contactthreshold").val());n.contactCls.getAtomsWithinAtom(t,e,parseFloat(r),!0,!1,i);let a=o.hashUtilsCls.cloneHash(n.resid2Residhash);return this.getGraphLinks(a,a,n.icn3dui.htmlCls.contactInsideColor,s,n.icn3dui.htmlCls.contactInsideValue,l)}compNode(e,t,s){let i=this.icn3d.icn3dui,l=e.r.substr(4),n=t.r.substr(4),o=i.utilsCls.getIdArray(l),r=i.utilsCls.getIdArray(n),a=o[0]+"_"+o[1],d=r[0]+"_"+r[1],c=parseInt(o[2]),h=parseInt(r[2]);return a>d?s?-1:1:a<d?s?1:-1:a==d?c>h?1:c<h?-1:0:void 0}getGraphLinks(e,t,s,i,l,n){var o=this.icn3d,r=o.icn3dui;let a="";l=void 0===l?1:l;let d="",c={};for(let h in e){h=h.trim();let e=h.indexOf(" "),m=h.indexOf(":"),p=h.indexOf("@"),u=-1!==p?p:h.length,C=h.indexOf("."),g=h.indexOf("$"),f=r.utilsCls.residueName2Abbr(h.substr(0,e))+h.substr(m+1,u-m-1);"chain"!=i&&"structure"!=i||(f+="."+h.substr(C+1,m-C-1)),"structure"==i&&(f+="."+h.substr(g+1,C-g-1));for(let e in t[h]){e=e.trim();let t=e.indexOf(" "),h=e.indexOf(":"),m=e.indexOf("@"),p=-1!==m?m:e.length,u=e.indexOf("."),C=e.indexOf("$"),g=r.utilsCls.residueName2Abbr(e.substr(0,t))+e.substr(h+1,p-h-1);if(e.substr(u+1,h-u-1),"chain"!=i&&"structure"!=i||(g+="."+e.substr(u+1,h-u-1)),"structure"==i&&(g+="."+e.substr(C+1,u-C-1)),n&&(f=o.resi2resirange[f],g=o.resi2resirange[g]),!c.hasOwnProperty(f+"_"+g)&&void 0!==f&&void 0!==g){let e=', {"source": "'+f+'", "target": "'+g+'", "v": '+l+', "c": "'+s+'"}';e!=d&&(a+=e),d=e,c[f+"_"+g]=1,c[g+"_"+f]=1}}}return a}convertLabel2Resid(e){this.icn3d.icn3dui,e.indexOf(" ");let t=e.indexOf("@"),s=-1!==t?t:e.length,i=e.indexOf("$"),l=e.indexOf("."),n=e.indexOf(":");return e.substr(i+1,l-i-1)+"_"+e.substr(l+1,n-l-1)+"_"+e.substr(n+1,s-n-1)}}class U{constructor(e){this.icn3d=e}drawLineGraph(e,t){let s,i=this.icn3d,l=i.icn3dui,n=JSON.parse(e),o=[],r=[],a=[],d={};for(let e=0,t=n.nodes.length;e<t;++e){let t=n.nodes[e];d[t.id]=t}let c={};for(let e=0,t=n.links.length;e<t;++e){let t=n.links[e];t.v!=i.icn3dui.htmlCls.hbondValue&&t.v!=i.icn3dui.htmlCls.ionicValue&&t.v!=i.icn3dui.htmlCls.halogenValue&&t.v!=i.icn3dui.htmlCls.picationValue&&t.v!=i.icn3dui.htmlCls.pistackingValue&&t.v!=i.icn3dui.htmlCls.contactValue||(o.push(t),c[t.source]=1,c[t.target]=1)}let h=i.getGraphCls.getNodeTopBottom(c,d);if(r=h.nodeArray1,a=h.nodeArray2,i.lineGraphStr="{\n",Object.keys(i.structures).length>1){let e=[],n=[],r=[],a=[],c=[],h=[],m=Object.keys(i.structures)[0],p=Object.keys(i.structures)[1],u=[],C=[],g=[],f={},b={},y={};for(let e=0,t=o.length;e<t;++e){let t=o[e],s=d[t.source],i=d[t.target];if(!(s&&i&&s.r&&i.r))continue;let n=[];n.push(""),n.push("");let r=s.r.substr(4);n=n.concat(l.utilsCls.getIdArray(r));let a=[];a.push(""),a.push(""),r=i.r.substr(4),a=a.concat(l.utilsCls.getIdArray(r)),n[2]==m&&a[2]==m?(u.push(t),f[t.source]=1,f[t.target]=1):n[2]==p&&a[2]==p?(C.push(t),b[t.source]=1,b[t.target]=1):(g.push(t),y[t.source]=1,y[t.target]=1)}let v=i.getGraphCls.getNodeTopBottom(f,d);e=v.nodeArray1,n=v.nodeArray2;let w=i.getGraphCls.getNodeTopBottom(b,d);r=w.nodeArray1,a=w.nodeArray2;let S=i.getGraphCls.getNodeTopBottom(y,d,!0);c=S.nodeArray1,h=S.nodeArray2;let _=e.length,A=n.length,x=r.length,k=a.length,O=c.length,H=h.length,R=Math.max(_,A,x,k,O,H),E=[];u.length>0&&E.push(m),C.length>0&&E.push(p),g.length>0&&E.push(m+"_"+p);let I,D,T,P,F,M=1,L=3*M,N=7*M,$=10,U=10,q=30;t?(T=(_+2+x+2)*(L+N)+4*U+2*q,D=(Math.max(A,k)+2)*(L+N)+2*$+q):(I=110,T=I*E.length,D=R*(L+N)+2*$),t?(i.scatterplotWidth=2*D,F=i.scatterplotWidth,P=l.scatterplotid):(i.linegraphWidth=2*D,F=i.linegraphWidth,P=l.linegraphid),s=0==E.length?"No interactions found for each structure<br><br>":"2D integration graph for structure(s) <b>"+E+"</b><br><br>",s+="<svg id='"+P+"' viewBox='0,0,"+D+","+T+"' width='"+F+"px'>";let B=0;u.length>0&&(t?(B-=15,s+=this.drawScatterplot_base(e,n,u,d,B),B=15,I=(_+1)*(L+N)+2*U):s+=this.drawLineGraph_base(e,n,u,d,B),B+=I,i.lineGraphStr+=i.getGraphCls.updateGraphJson(m,1,e,n,u)),C.length>0&&(t?(s+=this.drawScatterplot_base(r,a,C,d,B),I=(x+1)*(L+N)+2*U):s+=this.drawLineGraph_base(r,a,C,d,B),B+=I,u.length>0&&(i.lineGraphStr+=", \n"),i.lineGraphStr+=i.getGraphCls.updateGraphJson(p,2,r,a,C)),g.length>0&&!t&&(s+=this.drawLineGraph_base(c,h,g,d,B),(u.length>0||C.length>0)&&(i.lineGraphStr+=", \n"),i.lineGraphStr+='"structure1_2": {"id1": "'+m+'", "id2": "'+p+'", "nodes1":[',i.lineGraphStr+=l.utilsCls.getJSONFromArray(c),i.lineGraphStr+='], \n"nodes2":[',i.lineGraphStr+=l.utilsCls.getJSONFromArray(h),i.lineGraphStr+='], \n"links":[',i.lineGraphStr+=l.utilsCls.getJSONFromArray(g),i.lineGraphStr+="]}"),s+="</svg>"}else if(t){let e,t,n,c,h=Object.keys(i.structures)[0],m=r.length,p=a.length,u=1,C=3*u,g=7*u,f=30;t=(m+2)*(C+g)+2*10+f,e=(p+2)*(C+g)+2*10+f,i.scatterplotWidth=2*e,c=i.scatterplotWidth,n=l.scatterplotid,s=o.length>0?"":"No interactions found for these two sets<br><br>",s+="<svg id='"+n+"' viewBox='0,0,"+e+","+t+"' width='"+c+"px'>",s+=this.drawScatterplot_base(r,a,o,d,0),i.lineGraphStr+=i.getGraphCls.updateGraphJson(h,1,r,a,o),s+="</svg>"}else{let e=Object.keys(i.structures)[0],t=r.length,n=a.length,c=1,h=3*c,m=7*c,p=110,u=10,C=t>n?t*(h+m)+2*u:n*(h+m)+2*u;i.linegraphWidth=2*C,s=o.length>0?"":"No interactions found for these two sets<br><br>",s+="<svg id='"+l.linegraphid+"' viewBox='0,0,"+C+","+p+"' width='"+i.linegraphWidth+"px'>",s+=this.drawLineGraph_base(r,a,o,d,0),i.lineGraphStr+=i.getGraphCls.updateGraphJson(e,1,r,a,o),s+="</svg>"}return i.lineGraphStr+="}\n",i.scatterplotStr=i.lineGraphStr,t?$("#"+i.pre+"scatterplotDiv").html(s):$("#"+i.pre+"linegraphDiv").html(s),s}drawLineGraph_base(e,t,s,i,l){let n=this.icn3d;n.icn3dui;let o,r,a="",d=e.length,c=t.length;d>c?(o=10,r=10*Math.abs(d-c)*.5+10):(r=10,o=10*Math.abs(d-c)*.5+10);let h=30+l,m=80+l,p="",u={},C={};for(let t=0;t<d;++t)p+=n.getGraphCls.drawResNode(e[t],t,3,7,o,h,"a"),u[e[t].id]={x:o+10*t,y:h};for(let e=0;e<c;++e)p+=n.getGraphCls.drawResNode(t[e],e,3,7,r,m,"b"),C[t[e].id]={x:r+10*e,y:m};for(let e=0,t=s.length;e<t;++e){let t=s[e],l=i[t.source],o=i[t.target];if(void 0===l||void 0===o)continue;let r,d,c=l.r.substr(4),h=o.r.substr(4),m=u[l.id],p=C[o.id];void 0!==m&&void 0!==p&&(r=t.v==n.icn3dui.htmlCls.contactValue?1:2,t.v==n.icn3dui.htmlCls.hbondValue?d="#"+n.icn3dui.htmlCls.hbondColor:t.v==n.icn3dui.htmlCls.ionicValue?d="#"+n.icn3dui.htmlCls.ionicColor:t.v==n.icn3dui.htmlCls.halogenValue?d="#"+n.icn3dui.htmlCls.halogenColor:t.v==n.icn3dui.htmlCls.picationValue?d="#"+n.icn3dui.htmlCls.picationColor:t.v==n.icn3dui.htmlCls.pistackingValue?d="#"+n.icn3dui.htmlCls.pistackingColor:t.v==n.icn3dui.htmlCls.contactValue&&(d="#"+n.icn3dui.htmlCls.contactColor),a+="<g class='icn3d-interaction' resid1='"+c+"' resid2='"+h+"' >",a+="<title>Interaction of residue "+l.id+" with residue "+o.id+"</title>",a+="<line x1='"+m.x+"' y1='"+m.y+"' x2='"+p.x+"' y2='"+p.y+"' stroke='"+d+"' stroke-width='"+r+"' /></g>")}return a+=p,a}drawScatterplot_base(e,t,s,i,l,n){let o=this.icn3d;o.icn3dui;let r="",a=e.length,d=t.length,c=n?3:7,h=(a+1)*(3+c)+30+40,m=l+h-(50+(3+c)),p=40+(3+c),u="",C={},g={};for(let t=0;t<a;++t)u+=o.getGraphCls.drawResNode(e[t],t,3,c,m,40,"a",!0),C[e[t].id]={x:40,y:m-t*(3+c)};let f=l+h-50;for(let e=0;e<d;++e)u+=o.getGraphCls.drawResNode(t[e],e,3,c,p,f,"b",!1,n),g[t[e].id]={x:p+e*(3+c),y:f};let b=n?6:4.5,y=.5*b;for(let e=0,t=s.length;e<t;++e){let t,l,a=s[e],d=i[a.source],c=i[a.target],h=d.r.substr(4),m=c.r.substr(4),p=C[d.id],u=g[c.id];void 0!==p&&void 0!==u&&(a.v==o.icn3dui.htmlCls.hbondValue?t="#"+o.icn3dui.htmlCls.hbondColor:a.v==o.icn3dui.htmlCls.ionicValue?t="#"+o.icn3dui.htmlCls.ionicColor:a.v==o.icn3dui.htmlCls.halogenValue?t="#"+o.icn3dui.htmlCls.halogenColor:a.v==o.icn3dui.htmlCls.picationValue?t="#"+o.icn3dui.htmlCls.picationColor:a.v==o.icn3dui.htmlCls.pistackingValue?t="#"+o.icn3dui.htmlCls.pistackingColor:a.v==o.icn3dui.htmlCls.contactValue&&(t="#"+o.icn3dui.htmlCls.contactColor),l=a.v==o.icn3dui.htmlCls.contactValue?1:2,r+="<g class='icn3d-interaction' resid1='"+h+"' resid2='"+m+"' >",r+="<title>Interaction of residue "+d.id+" with residue "+c.id+"</title>",r+=n?"<rect x='"+(u.x-y).toString()+"' y='"+(p.y-y).toString()+"' width='"+b+"' height='"+b+"' fill='"+t+"' stroke-width='"+l+"' stroke='"+t+"' />":"<rect x='"+(u.x-y).toString()+"' y='"+(p.y-y).toString()+"' width='"+b+"' height='"+b+"' fill='"+t+"' fill-opacity='0.6' stroke-width='"+l+"' stroke='"+t+"' />",r+="</g>")}return r+=u,r}copyStylesInline(e,t){this.icn3d.icn3dui;let s=["svg","g"];for(let i=0;i<e.childNodes.length;i++){let l=e.childNodes[i];if(-1!=s.indexOf(l.tagName)){this.copyStylesInline(l,t.childNodes[i]);continue}let n=t.childNodes[i].currentStyle||window.getComputedStyle(t.childNodes[i]);if("undefined"!=n&&null!=n)for(let e=0;e<n.length;e++)l.style.setProperty(n[e],n.getPropertyValue(n[e]))}}}class q{constructor(e){this.icn3d=e}viewInteractionPairs(e,t,s,i,l,n,o,r,a,d,c){let h,m=this.icn3d,p=m.icn3dui;m.bRender=!1;let u,C={},g=p.hashUtilsCls.cloneHash(m.hAtoms),f="calpha"==i||"cbeta"==i||"heavyatoms"==i,b={},y={};if(f)for(let e in m.hAtoms){let t=m.atoms[e];"HOH"!=t.resn&&"WAT"!=t.resn&&"SOL"!=t.resn&&(("calpha"==i&&(t.het||"CA"==t.name||"O3'"==t.name||"O3*"==t.name)||"cbeta"==i&&(t.het||"CB"==t.name||"O3'"==t.name||"O3*"==t.name)||"heavyatoms"==i&&"H"!=t.elem)&&(b[e]=t,y[e]=t))}else b=m.definedSetsCls.getAtomsFromNameArray(e),y=m.definedSetsCls.getAtomsFromNameArray(t);let v=0,w=0;for(let e in m.structures){for(let t=0,s=m.structures[e].length;t<s;++t){let s=m.structures[e][t];for(let e in m.chains[s])if(b.hasOwnProperty(e)||y.hasOwnProperty(e)){++v;break}}++w}u=w>1?"structure":v>1?"chain":"residue";let S=[];if(l&&S.push("hbonds"),n&&S.push("salt bridge"),o&&S.push("interactions"),r&&S.push("halogen"),a&&S.push("pi-cation"),d&&S.push("pi-stacking"),s||(m.resids2inter={},m.resids2interAll={}),n){let l=parseFloat($("#"+m.pre+"saltbridgethreshold").val());l&&!isNaN(l)||(l=m.tsIonic),s||(m.hAtoms=p.hashUtilsCls.cloneHash(g),m.showInterCls.showIonicInteractions(l,e,t,s,!0,i)),C=p.hashUtilsCls.unionHash(C,m.hAtoms)}if(l){let l=parseFloat($("#"+m.pre+"hbondthreshold").val());l&&!isNaN(l)||(l=m.tsHbond),s||(m.hAtoms=p.hashUtilsCls.cloneHash(g),m.showInterCls.showHbonds(l,e,t,s,void 0,i)),C=p.hashUtilsCls.unionHash(C,m.hAtoms)}let _,A,x,k,O="";if(l&&(O+=this.exportHbondPairs(i,u)),n&&(O+=this.exportSaltbridgePairs(i,u)),r){let l=parseFloat($("#"+m.pre+"halogenthreshold").val());l&&!isNaN(l)||(l=m.tsHalogen),s||(m.hAtoms=p.hashUtilsCls.cloneHash(g),m.showInterCls.showHalogenPi(l,e,t,s,i,"halogen")),C=p.hashUtilsCls.unionHash(C,m.hAtoms),O+=this.exportHalogenPiPairs(i,u,"halogen")}if(a){let l=parseFloat($("#"+m.pre+"picationthreshold").val());l&&!isNaN(l)||(l=m.tsPication),s||(m.hAtoms=p.hashUtilsCls.cloneHash(g),m.showInterCls.showHalogenPi(l,e,t,s,i,"pi-cation")),C=p.hashUtilsCls.unionHash(C,m.hAtoms),O+=this.exportHalogenPiPairs(i,u,"pi-cation")}if(d){let l=parseFloat($("#"+m.pre+"pistackingthreshold").val());l&&!isNaN(l)||(l=m.tsPistacking),s||(m.hAtoms=p.hashUtilsCls.cloneHash(g),m.showInterCls.showHalogenPi(l,e,t,s,i,"pi-stacking")),C=p.hashUtilsCls.unionHash(C,m.hAtoms),O+=this.exportHalogenPiPairs(i,u,"pi-stacking")}if(o){let l=f?c:parseFloat($("#"+m.pre+"contactthreshold").val());if(l&&!isNaN(l)||(l=m.tsContact),1!=e.length||1!=t.length||e[0]!=t[0])s||(m.hAtoms=p.hashUtilsCls.cloneHash(g),m.showInterCls.pickCustomSphere(l,e,t,s,!0,i)),C=p.hashUtilsCls.unionHash(C,m.hAtoms),O+=this.exportSpherePairs(!0,i,u);else{if(!s){let n={},r={};if(f){let e=!0,t=m.showInterCls.pickCustomSphere_base(l,b,y,s,!0,void 0,void 0,!0,e);n=p.hashUtilsCls.unionHash(n,t.residues);for(let e in t.resid2Residhash)r[e]=p.hashUtilsCls.unionHash(r[e],t.resid2Residhash[e])}else{let o=[],a="",d="",c={};for(let e in b){let t=m.atoms[e];t.ss==a&&t.chain==d||(Object.keys(c).length>0&&o.push(c),c={}),c[t.serial]=1,a=t.ss,d=t.chain}Object.keys(c).length>0&&o.push(c);let h=o.length;A="interactions "+l+" | sets "+e+" "+t+" | true",m.opts.contact="yes";for(let e=0;e<h;++e)for(let t=e+1;t<h;++t){m.hAtoms=p.hashUtilsCls.cloneHash(g);let a=m.showInterCls.pickCustomSphere_base(l,o[e],o[t],s,!0,i,A,!0);n=p.hashUtilsCls.unionHash(n,a.residues);for(let e in a.resid2Residhash)r[e]=p.hashUtilsCls.unionHash(r[e],a.resid2Residhash[e])}}m.resid2ResidhashInteractions=r;let a,d,c=Object.keys(n);m.hAtoms={};for(let e=0,t=c.length;e<t;++e){let t=c[e];for(let e in m.residues[t])m.hAtoms[e]=1}let h=m.firstAtomObjCls.getFirstAtomObj(n);void 0!==h&&(a="sphere."+h.chain+":"+p.utilsCls.residueName2Abbr(h.resn.substr(0,3)).trim()+h.resi+"-"+radius+"A",o&&(a="interactions."+h.chain+":"+p.utilsCls.residueName2Abbr(h.resn.substr(0,3)).trim()+h.resi+"-"+$("#"+m.pre+"contactthreshold").val()+"A"),d=a,m.selectionCls.addCustomSelection(c,a,d,A,!0)),m.selectionCls.saveSelectionIfSelected(),m.drawCls.draw()}C=p.hashUtilsCls.unionHash(C,m.hAtoms),O+=this.exportSpherePairs(!0,i,u)}}m.hAtoms=p.hashUtilsCls.cloneHash(C),m.bRender=!0,m.drawCls.draw(),_=m.firstAtomObjCls.getResiduesFromAtoms(C),A="select "+m.resid2specCls.residueids2spec(Object.keys(_)),x="interface_all",k=x,m.selectionCls.addCustomSelection(Object.keys(_),x,k,A,!0);let H=p.hashUtilsCls.intHash(C,b);_=m.firstAtomObjCls.getResiduesFromAtoms(H),A="select "+m.resid2specCls.residueids2spec(Object.keys(_)),x="interface_1",k=x,m.selectionCls.addCustomSelection(Object.keys(_),x,k,A,!0);let R=p.hashUtilsCls.intHash(C,y);_=m.firstAtomObjCls.getResiduesFromAtoms(R),A="select "+m.resid2specCls.residueids2spec(Object.keys(_)),x="interface_2",k=x,m.selectionCls.addCustomSelection(Object.keys(_),x,k,A,!0);let E='<div style="text-align:center"><b>'+S.join(", ")+" between Two Sets:</b><br>",I=m.resid2specCls.atoms2residues(Object.keys(b)),D=m.resid2specCls.atoms2residues(Object.keys(y)),T="select "+m.resid2specCls.residueids2spec(I),P="select "+m.resid2specCls.residueids2spec(D);E+="Set 1: "+e+' <button class="'+m.pre+'selset" cmd="'+T+'">Highlight in 3D</button><br>',E+="Set 2: "+t+' <button class="'+m.pre+'selset" cmd="'+P+'">Highlight in 3D</button><br><br></div>',E+='<div style="text-align:center"><b>The interfaces are:</b><br>';let F=m.resid2specCls.atoms2residues(Object.keys(H)),M=m.resid2specCls.atoms2residues(Object.keys(R)),L="select "+m.resid2specCls.residueids2spec(F),N="select "+m.resid2specCls.residueids2spec(M);E+='interface_1 <button class="'+m.pre+'selset" cmd="'+L+'">Highlight in 3D</button><br>',E+='interface_2 <button class="'+m.pre+'selset" cmd="'+N+'">Highlight in 3D</button><br><br></div>',E+='<div><b>Note</b>: Each checkbox below selects the corresponding residue. You can click "Save Selection" in the "Select" menu to save the selection and click on "Highlight" button to clear the checkboxes.</div><br>';let U=E;if(("graph"==i||"linegraph"==i||"scatterplot"==i||f)&&(E=""),E+=O,"save1"==i||"save2"==i){E=U;let e="";"save1"==i?e="Set 1":"save2"==i&&(e="Set 2"),E+='<div style="text-align:center"><br><b>Interactions Sorted on '+e+'</b>: <button class="'+m.pre+'showintercntonly" style="margin-left:20px">Show Count Only</button><button class="'+m.pre+'showinterdetails" style="margin-left:20px">Show Details</button></div>',E+=this.getAllInteractionTable(i).html,h=this.getAllInteractionTable(i).bondCnt,$("#"+m.pre+"dl_interactionsorted").html(E),m.icn3dui.htmlCls.dialogCls.openDlg("dl_interactionsorted","Show sorted interactions")}else if("view"==i)$("#"+m.pre+"dl_allinteraction").html(E),m.icn3dui.htmlCls.dialogCls.openDlg("dl_allinteraction","Show interactions");else if("linegraph"==i){m.icn3dui.htmlCls.dialogCls.openDlg("dl_linegraph","Show interactions between two lines of residue nodes"),m.graphStr=m.getGraphCls.getGraphData(b,y,e,t,E,u),m.bLinegraph=!0;let s=m.lineGraphCls.drawLineGraph(m.graphStr);$("#"+m.pre+"linegraphDiv").html(s)}else if("scatterplot"==i){m.icn3dui.htmlCls.dialogCls.openDlg("dl_scatterplot","Show interactions as scatterplot"),m.graphStr=m.getGraphCls.getGraphData(b,y,e,t,E,u),m.bScatterplot=!0;let s=m.lineGraphCls.drawLineGraph(m.graphStr,!0);$("#"+m.pre+"scatterplotDiv").html(s)}else if(f){m.icn3dui.htmlCls.dialogCls.openDlg("dl_contactmap","Show contact map");let s=!0,i=m.getGraphCls.getGraphData(b,y,e,t,E,u,s);m.bContactMap=!0;let l=m.contactMapCls.drawContactMap(i);$("#"+m.pre+"contactmapDiv").html(l)}else"graph"==i&&(m.graphStr=m.getGraphCls.getGraphData(b,y,e,t,E,u),m.bGraph=!0,Object.keys(y).length+Object.keys(b).length>Object.keys(m.dAtoms).length&&(m.graphStr=m.getGraphCls.getGraphDataForDisplayed()),this.drawGraphWrapper(m.graphStr,m.deferredGraphinteraction));return{interactionTypes:S.toString(),bondCnt:h}}drawGraphWrapper(e,t,s){let i=this.icn3d,l=i.icn3dui,n=this;if(i.bGraph||($("#"+l.pre+"interactionDesc").hide(),$("#"+l.pre+"internalEdges").hide(),$("#"+l.pre+"force").hide()),void 0===i.bD3){let l="https://www.ncbi.nlm.nih.gov/Structure/icn3d/script/d3v4-force-all.min.js";$.ajax({url:l,dataType:"script",cache:!0,tryCount:0,retryLimit:1,success:function(l){i.bD3=!0,$("#"+i.icn3dui.svgid).empty(),i.icn3dui.htmlCls.dialogCls.openDlg("dl_graph","Force-directed graph"),i.drawGraphCls.drawGraph(e,i.pre+"dl_graph"),s&&n.removeForce(),void 0!==t&&t.resolve()},error:function(e,s,i){this.tryCount++,this.tryCount<=this.retryLimit?$.ajax(this):void 0!==t&&t.resolve()}})}else $("#"+i.icn3dui.svgid).empty(),i.icn3dui.htmlCls.dialogCls.openDlg("dl_graph","Force-directed graph"),i.drawGraphCls.drawGraph(e,i.pre+"dl_graph"),s&&this.removeForce()}removeForce(){let e=this.icn3d,t=e.icn3dui;setTimeout((function(){t.htmlCls.force=0,t.htmlCls.clickMenuCls.setLogCmd("graph force "+t.htmlCls.force,!0),e.getGraphCls.handleForce()}),300)}clearInteractions(){let e=this.icn3d;e.icn3dui,e.lines.hbond=[],e.hbondpnts=[],e.lines.saltbridge=[],e.saltbridgepnts=[],e.lines.contact=[],e.contactpnts=[],e.lines.halogen=[],e.lines["pi-cation"]=[],e.lines["pi-stacking"]=[],e.halogenpnts=[],e.picationpnts=[],e.pistackingpnts=[]}resetInteractionPairs(){let e=this.icn3d;e.icn3dui,e.bHbondCalc=!1,e.showInterCls.hideHbondsContacts(),e.hlUpdateCls.clearHighlight(),e.resids2inter={},e.resids2interAll={}}retrieveInteractionData(){let e=this.icn3d;if(e.icn3dui,!e.b2DShown)if(void 0!==e.icn3dui.cfg.align){let t=Object.keys(e.structures);e.ParserUtilsCls.set2DDiagramsForAlign(t[0].toUpperCase(),t[1].toUpperCase())}else void 0!==e.icn3dui.cfg.chainalign?(Object.keys(e.structures),e.ParserUtilsCls.set2DDiagramsForChainalign(e.chainidArray)):e.ParserUtilsCls.download2Ddgm(e.inputid.toUpperCase())}getAllInteractionTable(e){let t=this.icn3d,s=t.icn3dui,i=[],l=Object.keys(t.resids2inter);("save1"==e||"save2"==e)&&l.sort((function(t,i){return s.utilsCls.compResid(t,i,e)}));let n="",o="",r="",a="",d="",c="",h="",m="",p="",u=0,C=0,g=0,f=0,b=0,y=0;for(let s=0,v=l.length;s<v;++s){let v=l[s],w=v.split(","),S="save1"==e?w[0]:w[1];"save1"==e?w[1]:w[0];let _,A,x=S.split("_");s>0&&S!=o&&(i.push({cntHbond:u,cntIonic:C,cntContact:g,cntHalegen:f,cntPication:b,cntPistacking:y}),n+=this.getInteractionPerResidue(r,a,d,c,h,m,p,u,C,g,f,b,y),a="",d="",c="",h="",m="",p="",u=0,C=0,g=0,f=0,b=0,y=0),_=t.resids2inter[v].hbond,A=this.getInteractionPairDetails(_,e,"hbond"),a+=A.html,u+=A.cnt,_=t.resids2inter[v].ionic,A=this.getInteractionPairDetails(_,e,"ionic"),d+=A.html,C+=A.cnt,_=t.resids2inter[v].contact,A=this.getContactPairDetails(_,e,"contact"),c+=A.html,g+=A.cnt,_=t.resids2inter[v].halogen,A=this.getInteractionPairDetails(_,e,"halogen"),h+=A.html,f+=A.cnt,_=t.resids2inter[v]["pi-cation"],A=this.getInteractionPairDetails(_,e,"pi-cation"),m+=A.html,b+=A.cnt,_=t.resids2inter[v]["pi-stacking"],A=this.getInteractionPairDetails(_,e,"pi-stacking"),p+=A.html,y+=A.cnt,o=S,r=x}i.push({cntHbond:u,cntIonic:C,cntContact:g,cntHalegen:f,cntPication:b,cntPistacking:y}),n+=this.getInteractionPerResidue(r,a,d,c,h,m,p,u,C,g,f,b,y);let v="";if(l.length>0){v+='<br><table class="icn3d-sticky" align=center border=1 cellpadding=10 cellspacing=0><thead>',v+="<tr><th rowspan=2>Residue</th><th rowspan=2># Hydrogen<br>Bond</th><th rowspan=2># Salt Bridge<br>/Ionic Interaction</th><th rowspan=2># Contact</th>",v+="<th rowspan=2># Halogen<br>Bond</th><th rowspan=2># &pi;-Cation</th><th rowspan=2># &pi;-Stacking</th>",v+="<th>Hydrogen Bond</th><th>Salt Bridge/Ionic Interaction</th><th>Contact</th>",v+="<th>Halogen Bond</th><th>&pi;-Cation</th><th>&pi;-Stacking</th></tr>",v+="<tr>";let e='<td><table width="100%" class="icn3d-border"><tr><td>Atom1</td><td>Atom2</td><td>Distance(&#8491;)</td><td>Highlight in 3D</td></tr></table></td>';v+=e,v+=e,v+='<td><table width="100%" class="icn3d-border"><tr><td>Atom1</td><td>Atom2</td><td># Contacts</td><td>Min Distance(&#8491;)</td><td>C-alpha Distance(&#8491;)</td><td>Highlight in 3D</td></tr></table></td>',v+=e,v+=e,v+=e,v+="</tr>",v+="</thead><tbody>",v+=n,v+="</tbody></table><br/>"}return{html:v,bondCnt:i}}getInteractionPerResidue(e,t,s,i,l,n,o,r,a,d,c,h,m){this.icn3d.icn3dui;let p="";p+='<tr align="center"><th>'+e[3]+e[2]+"</th><td>"+r+"</td><td>"+a+"</td><td>"+d+"</td><td>"+c+"</td><td>"+h+"</td><td>"+m+"</td>";let u=[t,s,i,l,n,o];for(let e in u){p+='<td valign="top"><table width="100%" class="icn3d-border">'+u[e]+"</table></td>"}return p+="</tr>",p}getInteractionPairDetails(e,t,s){let i=this.icn3d;i.icn3dui;let l="",n=0,o=' <span style="background-color:#',r='">&nbsp;&nbsp;&nbsp;</span>';if(void 0!==e)for(let a in e){let d=a.split(","),c="save1"==t?d[0]:d[1],h="save1"==t?d[1]:d[0],m=i.getGraphCls.convertLabel2Resid(c),p=i.firstAtomObjCls.getFirstAtomObj(i.residues[m]),u=p.color?p.color.getHexString():"",C=i.getGraphCls.convertLabel2Resid(h),g=i.firstAtomObjCls.getFirstAtomObj(i.residues[C]),f=g.color?g.color.getHexString():"",b=Math.sqrt(e[a]).toFixed(1);l+='<tr><td><span style="white-space:nowrap"><input type="checkbox" class="'+i.pre+'seloneres" id="'+i.pre+s+"2_"+n+'a" resid="'+c+'"/> '+c+o+u+r+'</span></td><td><span style="white-space:nowrap"><input type="checkbox" class="'+i.pre+'seloneres" id="'+i.pre+s+"2_"+n+'b" resid="'+h+'"/> '+h+o+f+r+'</span></td><td align="center">'+b+"</td>",l+='<td align="center"><button class="'+i.pre+'selres" resid="'+c+"|"+h+'">Highlight</button></td>',l+="</tr>",++n}return{html:l,cnt:n}}getContactPairDetails(e,t){let s=this.icn3d;s.icn3dui;let i="",l=0,n=' <span style="background-color:#',o='">&nbsp;&nbsp;&nbsp;</span>';if(void 0!==e)for(let r in e){let a=r.split(","),d="save1"==t?a[0]:a[1],c="save1"==t?a[1]:a[0],h=s.getGraphCls.convertLabel2Resid(d),m=s.firstAtomObjCls.getFirstAtomObj(s.residues[h]),p=m.color?m.color.getHexString():"",u=s.getGraphCls.convertLabel2Resid(c),C=s.firstAtomObjCls.getFirstAtomObj(s.residues[u]),g=C.color?C.color.getHexString():"",f=e[r].split("_"),b=f[0],y=f[1],v=f[2],w=f[3],S=f[4];i+='<tr><td><span style="white-space:nowrap"><input type="checkbox" class="'+s.pre+'seloneres" id="'+s.pre+"inter2_"+l+'a" resid="'+d+'"/> '+d+"@"+v+n+p+o+'</span></td><td><span style="white-space:nowrap"><input type="checkbox" class="'+s.pre+'seloneres" id="'+s.pre+"inter2_"+l+'b" resid="'+c+'"/> '+c+"@"+w+n+g+o+'</span></td><td align="center">'+S+'</td><td align="center">'+b+'</td><td align="center">'+y+"</td>",i+='<td align="center"><button class="'+s.pre+'selres" resid="'+d+"|"+c+'">Highlight</button></td>',i+="</tr>",l+=parseInt(S)}return{html:i,cnt:l}}exportInteractions(){var e=this.icn3d;e.icn3dui;let t='<html><body><div style="text-align:center"><br><b>Interacting residues</b>:<br/><table align=center border=1 cellpadding=10 cellspacing=0><tr><th>Base Chain: Residues</th><th>Interacting Chain</th></tr>';for(let s in e.chainname2residues)for(let i in e.chainname2residues[s]){let l=s.substr(0,s.indexOf("_"))+"_"+i.substr(0,i.indexOf(" "));t+="<tr><td>"+s+": ",t+=e.resid2specCls.residueids2spec(e.chainname2residues[s][i]),t+="</td><td>"+l+"</td></tr>"}t+="</table><br/></div></body></html>";let s=e.inputid?e.inputid:"custom";e.saveFileCls.saveFile(s+"_interactions.html","html",t)}exportSsbondPairs(){var e=this.icn3d;e.icn3dui;let t="",s=0;for(let i in e.structures){let l=e.ssbondpnts[i];if(void 0===l)break;for(let e=0,i=l.length;e<i;e+=2){t+="<tr><td>"+l[e]+" Cys</td><td>"+l[e+1]+" Cys</td></tr>",++s}}let i='<html><body><div style="text-align:center"><br><b>'+s+" disulfide pairs</b>:<br><br><table align=center border=1 cellpadding=10 cellspacing=0><tr><th>Residue ID 1</th><th>Residue ID 2</th></tr>";i+=t,i+="</table><br/></div></body></html>";let l=e.inputid?e.inputid:"custom";e.saveFileCls.saveFile(l+"_disulfide_pairs.html","html",i)}exportClbondPairs(){var e=this.icn3d;e.icn3dui;let t="",s=0,i={};for(let l in e.structures){let n=e.clbondpnts[l];if(void 0===n)break;for(let l=0,o=n.length;l<o;l+=2){let o=n[l],r=n[l+1];if(!i.hasOwnProperty(o+"_"+r)){let i=e.firstAtomObjCls.getFirstAtomObj(e.residues[o]),l=e.firstAtomObjCls.getFirstAtomObj(e.residues[r]);t+="<tr><td>"+o+" "+i.resn+"</td><td>"+r+" "+l.resn+"</td></tr>",++s}i[o+"_"+r]=1,i[r+"_"+o]=1}}let l='<html><body><div style="text-align:center"><br><b>'+s+" cross-linkage pairs</b>:<br><br><table align=center border=1 cellpadding=10 cellspacing=0><tr><th>Residue ID 1</th><th>Residue ID 2</th></tr>";l+=t,l+="</table><br/></div></body></html>";let n=e.inputid?e.inputid:"custom";e.saveFileCls.saveFile(n+"_crosslinkage_pairs.html","html",l)}exportHbondPairs(e,t){var s=this.icn3d;s.icn3dui;let i="",l=0,n=' <span style="background-color:#',o='">&nbsp;&nbsp;&nbsp;</span>';for(let t in s.resid2ResidhashHbond){let r=s.getGraphCls.convertLabel2Resid(t),a=s.firstAtomObjCls.getFirstAtomObj(s.residues[r]),d=a.color?a.color.getHexString():"";for(let r in s.resid2ResidhashHbond[t]){let a=s.getGraphCls.convertLabel2Resid(r),c=s.firstAtomObjCls.getFirstAtomObj(s.residues[a]),h=c.color?c.color.getHexString():"",m=Math.sqrt(s.resid2ResidhashHbond[t][r]).toFixed(1);i+='<tr><td><input type="checkbox" class="'+s.pre+'seloneres" id="'+s.pre+"hbond_"+l+'a" resid="'+t+'"/> '+t+n+d+o+'</td><td><input type="checkbox" class="'+s.pre+'seloneres" id="'+s.pre+"hbond_"+l+'b" resid="'+r+'"/> '+r+n+h+o+'</td><td align="center">'+m+"</td>","view"==e&&(i+='<td align="center"><button class="'+s.pre+'selres" resid="'+t+"|"+r+'">Highlight</button></td>'),i+="</tr>",++l}}let r='<div style="text-align:center"><br><b>'+l+" hydrogen bond pairs</b>:</div><br>";if(l>0&&(r+="<br><table align=center border=1 cellpadding=10 cellspacing=0><tr><th>Atom 1</th><th>Atom 2</th><th>Distance(&#8491;)</th>","view"==e&&(r+='<th align="center">Highlight in 3D</th>'),r+="</tr>",r+=i,r+="</table><br/>"),"graph"==e||"linegraph"==e||"scatterplot"==e){return s.getGraphCls.getGraphLinks(s.resid2ResidhashHbond,s.resid2ResidhashHbond,s.icn3dui.htmlCls.hbondColor,t,s.icn3dui.htmlCls.hbondValue)}return r}exportSaltbridgePairs(e,t){var s=this.icn3d;s.icn3dui;let i="",l=0,n=' <span style="background-color:#',o='">&nbsp;&nbsp;&nbsp;</span>';for(let t in s.resid2ResidhashSaltbridge){let r=s.getGraphCls.convertLabel2Resid(t),a=s.firstAtomObjCls.getFirstAtomObj(s.residues[r]),d=a.color?a.color.getHexString():"";for(let r in s.resid2ResidhashSaltbridge[t]){let a=s.getGraphCls.convertLabel2Resid(r),c=s.firstAtomObjCls.getFirstAtomObj(s.residues[a]),h=c.color?c.color.getHexString():"",m=Math.sqrt(s.resid2ResidhashSaltbridge[t][r]).toFixed(1);i+='<tr><td><input type="checkbox" class="'+s.pre+'seloneres" id="'+s.pre+"saltb_"+l+'a" resid="'+t+'"/> '+t+n+d+o+'</td><td><input type="checkbox" class="'+s.pre+'seloneres" id="'+s.pre+"saltb_"+l+'b" resid="'+r+'"/> '+r+n+h+o+'</td><td align="center">'+m+"</td>","view"==e&&(i+='<td align="center"><button class="'+s.pre+'selres" resid="'+t+"|"+r+'">Highlight</button></td>'),i+="</tr>",++l}}let r='<div style="text-align:center"><br><b>'+l+" salt bridge/ionic interaction pairs</b>:</div><br>";if(l>0&&(r+="<br><table align=center border=1 cellpadding=10 cellspacing=0><tr><th>Atom 1</th><th>Atom 2</th><th>Distance(&#8491;)</th>","view"==e&&(r+='<th align="center">Highlight in 3D</th>'),r+="</tr>",r+=i,r+="</table><br/>"),"graph"==e||"linegraph"==e||"scatterplot"==e){return s.getGraphCls.getGraphLinks(s.resid2ResidhashSaltbridge,s.resid2ResidhashSaltbridge,s.icn3dui.htmlCls.ionicColor,t,s.icn3dui.htmlCls.ionicValue)}return r}exportHalogenPiPairs(e,t,s){var i=this.icn3d;i.icn3dui;let l,n,o,r="",a=0,d=' <span style="background-color:#',c='">&nbsp;&nbsp;&nbsp;</span>';"halogen"==s?(l=i.resid2ResidhashHalogen,n=i.icn3dui.htmlCls.halogenColor,o=i.icn3dui.htmlCls.halogenValue):"pi-cation"==s?(l=i.resid2ResidhashPication,n=i.icn3dui.htmlCls.picationColor,o=i.icn3dui.htmlCls.picationValue):"pi-stacking"==s&&(l=i.resid2ResidhashPistacking,n=i.icn3dui.htmlCls.pistackingColor,o=i.icn3dui.htmlCls.pistackingValue);for(let t in l){let n=i.getGraphCls.convertLabel2Resid(t),o=i.firstAtomObjCls.getFirstAtomObj(i.residues[n]),h=o.color?o.color.getHexString():"";for(let n in l[t]){let o=i.getGraphCls.convertLabel2Resid(n),m=i.firstAtomObjCls.getFirstAtomObj(i.residues[o]),p=m.color?m.color.getHexString():"",u=Math.sqrt(l[t][n]).toFixed(1);r+='<tr><td><input type="checkbox" class="'+i.pre+'seloneres" id="'+i.pre+s+"_"+a+'a" resid="'+t+'"/> '+t+d+h+c+'</td><td><input type="checkbox" class="'+i.pre+'seloneres" id="'+i.pre+s+"_"+a+'b" resid="'+n+'"/> '+n+d+p+c+'</td><td align="center">'+u+"</td>","view"==e&&(r+='<td align="center"><button class="'+i.pre+'selres" resid="'+t+"|"+n+'">Highlight</button></td>'),r+="</tr>",++a}}let h='<div style="text-align:center"><br><b>'+a+" "+s+" pairs</b>:</div><br>";if(a>0&&(h+="<br><table align=center border=1 cellpadding=10 cellspacing=0><tr><th>Atom 1</th><th>Atom 2</th><th>Distance(&#8491;)</th>","view"==e&&(h+='<th align="center">Highlight in 3D</th>'),h+="</tr>",h+=r,h+="</table><br/>"),"graph"==e||"linegraph"==e||"scatterplot"==e){return i.getGraphCls.getGraphLinks(l,l,n,t,o)}return h}exportSpherePairs(e,t,s){var i=this.icn3d;i.icn3dui;let l="",n=0,o=e?i.resid2ResidhashInteractions:i.resid2ResidhashSphere,r=' <span style="background-color:#',a='">&nbsp;&nbsp;&nbsp;</span>';for(let s in o){let d=i.getGraphCls.convertLabel2Resid(s),c=i.firstAtomObjCls.getFirstAtomObj(i.residues[d]),h=c.color?c.color.getHexString():"";for(let d in o[s]){let m=i.getGraphCls.convertLabel2Resid(d),p=i.firstAtomObjCls.getFirstAtomObj(i.residues[m]),u=p.color?p.color.getHexString():"",C=o[s][d].split("_"),g=C[0],f=C[1];c=C[2],p=C[3];let b=C[4];e?(l+='<tr><td><input type="checkbox" class="'+i.pre+'seloneres" id="'+i.pre+"inter_"+n+'a" resid="'+s+'"/> '+s+"@"+c+r+h+a+'</td><td><input type="checkbox" class="'+i.pre+'seloneres" id="'+i.pre+"inter_"+n+'b" resid="'+d+'"/> '+d+"@"+p+r+u+a+'</td><td align="center">'+b+'</td><td align="center">'+g+'</td><td align="center">'+f+"</td>","view"==t&&(l+='<td align="center"><button class="'+i.pre+'selres" resid="'+s+"|"+d+'">Highlight</button></td>'),l+="</tr>"):l+="<tr><td>"+s+"</td><td>"+d+'</td><td align="center">'+b+'</td><td align="center">'+g+'</td><td align="center">'+f+"</td></tr>",++n}}let d='<div style="text-align:center"><br><b>'+n+" residue pairs in "+(e?"the contacts":"sphere")+"</b>:</div><br>";if(n>0&&(e?(d+='<br><table align=center border=1 cellpadding=10 cellspacing=0><tr><th>Residue 1</th><th>Residue 2</th><th align="center">Num Contacts</th><th align="center">Min Distance(&#8491;)</th><th align="center">C-alpha Distance(&#8491;)</th>',"view"==t&&(d+='<th align="center">Highlight in 3D</th>'),d+="</tr>"):d+='<br><table align=center border=1 cellpadding=10 cellspacing=0><tr><th>Residue 1</th><th>Residue 2</th><th align="center">Num Contacts</th><th align="center">Min Distance(&#8491;)</th><th align="center">C-alpha Distance(&#8491;)</th></tr>',d+=l,d+="</table><br/>"),"graph"==t||"linegraph"==t||"scatterplot"==t||"calpha"==t||"cbeta"==t||"heavyatoms"==t){return i.getGraphCls.getGraphLinks(o,o,i.icn3dui.htmlCls.contactColor,s,i.icn3dui.htmlCls.contactValue)}return d}}class B{constructor(e){this.icn3d=e}showInteractions(e){let t=this.icn3d;t.icn3dui;let s=$("#"+t.pre+"atomsCustomHbond").val(),i=$("#"+t.pre+"atomsCustomHbond2").val();if(0==i.length)alert("Please select the first set");else{t.definedSetsCls.setMode("selection");let l=$("#"+t.pre+"analysis_hbond")[0].checked,n=$("#"+t.pre+"analysis_saltbridge")[0].checked,o=$("#"+t.pre+"analysis_contact")[0].checked,r=$("#"+t.pre+"analysis_halogen")[0].checked,a=$("#"+t.pre+"analysis_pication")[0].checked,d=$("#"+t.pre+"analysis_pistacking")[0].checked,c="threshold "+$("#"+t.pre+"hbondthreshold").val()+" "+$("#"+t.pre+"saltbridgethreshold").val()+" "+$("#"+t.pre+"contactthreshold").val()+" "+$("#"+t.pre+"halogenthreshold").val()+" "+$("#"+t.pre+"picationthreshold").val()+" "+$("#"+t.pre+"pistackingthreshold").val(),h=t.viewInterPairsCls.viewInteractionPairs(i,s,t.bHbondCalc,e,l,n,o,r,a,d).interactionTypes,m=t.bHbondCalc?"true":"false",p=i+" "+s+" | "+h+" | "+m+" | "+c;if("3d"==e)t.icn3dui.htmlCls.clickMenuCls.setLogCmd("display interaction 3d | "+p,!0);else if("view"==e)t.icn3dui.htmlCls.clickMenuCls.setLogCmd("view interaction pairs | "+p,!0);else if("save1"==e)t.icn3dui.htmlCls.clickMenuCls.setLogCmd("save1 interaction pairs | "+p,!0);else if("save2"==e)t.icn3dui.htmlCls.clickMenuCls.setLogCmd("save2 interaction pairs | "+p,!0);else if("linegraph"==e)t.icn3dui.htmlCls.clickMenuCls.setLogCmd("line graph interaction pairs | "+p,!0);else if("scatterplot"==e)t.icn3dui.htmlCls.clickMenuCls.setLogCmd("scatterplot interaction pairs | "+p,!0);else if("graph"==e){let e=parseInt($("#"+t.pre+"dist_ss").val()),l=parseInt($("#"+t.pre+"dist_coil").val()),n=parseInt($("#"+t.pre+"dist_hbond").val()),o=parseInt($("#"+t.pre+"dist_inter").val()),r=parseInt($("#"+t.pre+"dist_ssbond").val()),a=parseInt($("#"+t.pre+"dist_ionic").val()),d=parseInt($("#"+t.pre+"dist_halogen").val()),p=parseInt($("#"+t.pre+"dist_pication").val()),u=parseInt($("#"+t.pre+"dist_pistacking").val());t.icn3dui.htmlCls.clickMenuCls.setLogCmd("graph interaction pairs | "+i+" "+s+" | "+h+" | "+m+" | "+c+" | "+e+" "+l+" "+n+" "+o+" "+r+" "+a+" "+d+" "+p+" "+u,!0)}t.bHbondCalc=!0}}showHbonds(e,t,s,i,l,n){let o,r,a,d,c=this.icn3d,h=c.icn3dui;if(i)return;l?(o="saltbridge",r="salt bridge "+e+" | sets "+t+" "+s+" | "+i):(o="hbonds",r="hbonds "+e+" | sets "+t+" "+s+" | "+i),c.opts[o]="yes",c.opts.water="dot",a=c.definedSetsCls.getAtomsFromNameArray(t),d=c.definedSetsCls.getAtomsFromNameArray(s);let m=c.firstAtomObjCls.getFirstAtomObj(a);if(Object.keys(d).length>0&&Object.keys(a).length>0){let t,s=c.hBondCls.calculateChemicalHbonds(h.hashUtilsCls.intHash2Atoms(c.dAtoms,d,c.atoms),h.hashUtilsCls.intHash2Atoms(c.dAtoms,a,c.atoms),parseFloat(e),l);l?(c.resid2ResidhashSaltbridge=h.hashUtilsCls.cloneHash(c.resid2Residhash),t="all atoms that have salt bridges with the selected atoms"):(c.resid2ResidhashHbond=h.hashUtilsCls.cloneHash(c.resid2Residhash),t="all atoms that are hydrogen-bonded with the selected atoms");let i={};for(let e in s){i[c.atoms[e].structure+"_"+c.atoms[e].chain+"_"+c.atoms[e].resi]=1}c.hAtoms={};for(let e in i)for(let t in c.residues[e])c.hAtoms[t]=1,c.atoms[t].style2="stick";let n=o+"_"+m.serial;c.selectionCls.addCustomSelection(Object.keys(i),n,t,r,!0),c.selectionCls.saveSelectionIfSelected(),c.drawCls.draw()}}showHydrogens(){let e=this.icn3d;e.icn3dui;for(let t in e.hAtoms){let s=e.atoms[t];if("H"!==s.name){e.atoms[s.serial].bonds=e.atoms[s.serial].bonds2.concat(),e.atoms[s.serial].bondOrder=e.atoms[s.serial].bondOrder2.concat();for(let t=0,i=e.atoms[s.serial].bonds.length;t<i;++t){let i=e.atoms[s.serial].bonds[t];"H"===e.atoms[i].name&&(e.dAtoms[i]=1,e.hAtoms[i]=1)}}}}hideHydrogens(){let e=this.icn3d;e.icn3dui;for(let t in e.hAtoms){let s=e.atoms[t];if("H"===s.name){if(e.atoms[s.serial].bonds.length>0){let t=e.atoms[s.serial].bonds[0],i=e.atoms[t].bonds.indexOf(s.serial);-1!==i&&(e.atoms[t].bonds.splice(i,1),e.atoms[t].bondOrder.splice(i,1))}delete e.dAtoms[s.serial],delete e.hAtoms[s.serial]}}}hideHbondsContacts(){let e=this.icn3d;e.icn3dui;let t="set hbonds off";e.icn3dui.htmlCls.clickMenuCls.setLogCmd(t,!0),e.hBondCls.hideHbonds(),t="set salt bridge off",e.icn3dui.htmlCls.clickMenuCls.setLogCmd(t,!0),e.saltbridgeCls.hideSaltbridge(),t="set contact off",e.icn3dui.htmlCls.clickMenuCls.setLogCmd(t,!0),e.contactCls.hideContact(),t="set halogen pi off",e.icn3dui.htmlCls.clickMenuCls.setLogCmd(t,!0),e.piHalogenCls.hideHalogenPi()}showIonicInteractions(e,t,s,i,l,n){let o,r,a,d,c=this.icn3d,h=c.icn3dui;if(i)return;o="saltbridge",r="salt bridge "+e+" | sets "+t+" "+s+" | "+i,c.opts.saltbridge="yes",a=c.definedSetsCls.getAtomsFromNameArray(t),d=c.definedSetsCls.getAtomsFromNameArray(s);let m=c.firstAtomObjCls.getFirstAtomObj(a);if(Object.keys(d).length>0&&Object.keys(a).length>0){let t,s=c.saltbridgeCls.calculateIonicInteractions(h.hashUtilsCls.intHash2Atoms(c.dAtoms,d,c.atoms),h.hashUtilsCls.intHash2Atoms(c.dAtoms,a,c.atoms),parseFloat(e),l);c.resid2ResidhashSaltbridge=h.hashUtilsCls.cloneHash(c.resid2Residhash),t="all atoms that have ionic interactions with the selected atoms";let i={};for(let e in s){i[c.atoms[e].structure+"_"+c.atoms[e].chain+"_"+c.atoms[e].resi]=1}c.hAtoms={};for(let e in i)for(let t in c.residues[e])c.hAtoms[t]=1,c.atoms[t].style2="stick",c.ions.hasOwnProperty(t)&&(c.atoms[t].style2="sphere");let n="saltbridge_"+m.serial;c.selectionCls.addCustomSelection(Object.keys(i),n,t,r,!0),c.selectionCls.saveSelectionIfSelected(),c.drawCls.draw()}}showHalogenPi(e,t,s,i,l,n){let o=this.icn3d,r=o.icn3dui;if(i)return;let a,d,c=n+" "+e+" | sets "+t+" "+s+" | "+i;o.opts[n]="yes",a=o.definedSetsCls.getAtomsFromNameArray(t),d=o.definedSetsCls.getAtomsFromNameArray(s);let h=o.firstAtomObjCls.getFirstAtomObj(a);if(Object.keys(d).length>0&&Object.keys(a).length>0){let t,s=o.piHalogenCls.calculateHalogenPiInteractions(r.hashUtilsCls.intHash2Atoms(o.dAtoms,a,o.atoms),r.hashUtilsCls.intHash2Atoms(o.dAtoms,d,o.atoms),parseFloat(e),l,n);"halogen"==n?(o.resid2ResidhashHalogen=r.hashUtilsCls.cloneHash(o.resid2Residhash),t="all atoms that have halogen bonds with the selected atoms"):"pi-cation"==n?(o.resid2ResidhashPication=r.hashUtilsCls.cloneHash(o.resid2Residhash),t="all atoms that have pi-cation interactions with the selected atoms"):"pi-stacking"==n&&(o.resid2ResidhashPistacking=r.hashUtilsCls.cloneHash(o.resid2Residhash),t="all atoms that have pi-stacking with the selected atoms");let i={};for(let e in s){i[o.atoms[e].structure+"_"+o.atoms[e].chain+"_"+o.atoms[e].resi]=1}o.hAtoms={};for(let e in i)for(let t in o.residues[e])o.hAtoms[t]=1,o.atoms[t].style2="stick",o.ions.hasOwnProperty(t)&&(o.atoms[t].style2="sphere");let m=n+"_"+h.serial;o.selectionCls.addCustomSelection(Object.keys(i),m,t,c,!0),o.selectionCls.saveSelectionIfSelected(),o.drawCls.draw()}}showClbonds(){let e=this.icn3d,t=e.icn3dui;e.opts.clbonds="yes";let s=e.applyClbondsCls.applyClbondsOptions();for(let i in s)e.hAtoms=t.hashUtilsCls.unionHash(e.hAtoms,e.residues[i]);if(Object.keys(s).length>0){let t="clbonds",i="all atoms that have cross-linkages";e.selectionCls.addCustomSelection(Object.keys(s),t,i,"cross linkage",!0),e.selectionCls.saveSelectionIfSelected(),e.drawCls.draw()}}showSsbonds(){let e=this.icn3d,t=e.icn3dui;e.opts.ssbonds="yes";let s={},i=Object.keys(e.structures);for(let l=0,n=i.length;l<n;++l){let n=i[l];if(void 0!==e.ssbondpnts[n])for(let i=0,l=Math.floor(e.ssbondpnts[n].length/2);i<l;i++){let l=e.ssbondpnts[n][2*i],o=e.ssbondpnts[n][2*i+1];s[l]=1,s[o]=1,e.hAtoms=t.hashUtilsCls.unionHash(e.hAtoms,e.residues[l]),e.hAtoms=t.hashUtilsCls.unionHash(e.hAtoms,e.residues[o])}}if(Object.keys(s).length>0){let t="ssbonds",i="all atoms that have disulfide bonds";e.selectionCls.addCustomSelection(Object.keys(s),t,i,"disulfide bonds",!0),e.selectionCls.saveSelectionIfSelected(),e.drawCls.draw()}}pickCustomSphere(e,t,s,i,l,n){let o=this.icn3d,r=o.icn3dui;if(i)return;let a,d,c="select zone cutoff "+e+" | sets "+t+" "+s+" | "+i;l&&(c="interactions "+e+" | sets "+t+" "+s+" | "+i,o.opts.contact="yes"),a=o.definedSetsCls.getAtomsFromNameArray(t),d=o.definedSetsCls.getAtomsFromNameArray(s);let h,m,p=this.pickCustomSphere_base(e,a,d,i,l,n,c,!0),u=Object.keys(p.residues);o.hAtoms={};for(let e=0,t=u.length;e<t;++e){let t=u[e];for(let e in o.residues[t])o.hAtoms[e]=1}let C=o.firstAtomObjCls.getFirstAtomObj(a);void 0!==C&&(h="sphere."+C.chain+":"+r.utilsCls.residueName2Abbr(C.resn.substr(0,3)).trim()+C.resi+"-"+e+"A",l&&(h="interactions."+C.chain+":"+r.utilsCls.residueName2Abbr(C.resn.substr(0,3)).trim()+C.resi+"-"+$("#"+o.pre+"contactthreshold").val()+"A"),m=h,o.selectionCls.addCustomSelection(u,h,m,c,!0)),o.selectionCls.saveSelectionIfSelected(),o.drawCls.draw()}pickCustomSphere_base(e,t,s,i,l,n,o,r,a){let d,c=this.icn3d,h=c.icn3dui;l?(d=c.contactCls.getAtomsWithinAtom(h.hashUtilsCls.intHash2Atoms(c.dAtoms,s,c.atoms),h.hashUtilsCls.intHash2Atoms(c.dAtoms,t,c.atoms),parseFloat(e),r,l,void 0,a),c.resid2ResidhashInteractions=h.hashUtilsCls.cloneHash(c.resid2Residhash)):(d=c.contactCls.getAtomsWithinAtom(s,t,parseFloat(e),r,l),c.resid2ResidhashSphere=h.hashUtilsCls.cloneHash(c.resid2Residhash));let m={};for(let e in d){let t=d[e];c.bOpm&&"DUM"===t.resn||(m[t.structure+"_"+t.chain+"_"+t.resi]=1)}return{residues:m,resid2Residhash:c.resid2Residhash}}}class j{constructor(e){this.icn3d=e}setColorByOptions(e,t,s){let i=this.icn3d,l=i.icn3dui;if(void 0!==e)if(s)for(let e in t){let t=i.atoms[e];i.atomPrevColors[e]=t.color}else if(0===e.color.indexOf("#"))for(let s in t){let t=i.atoms[s];t.color=l.parasCls.thr().setStyle(e.color.toLowerCase()),i.atomPrevColors[s]=t.color}else{let s,n,o,r,a;switch(e.color.toLowerCase()){case"spectrum":s=0,n=0;for(let e in t){i.atoms[e].het||++n}o=n>1?1/(n-1):1;for(let e in t){let t=i.atoms[e];t.color=t.het?l.parasCls.atomColors[t.elem]||l.parasCls.defaultAtomColor:l.parasCls.thr().setHSL(3/4*(1-s++*o),1,.45),i.atomPrevColors[e]=t.color}break;case"chain":if(void 0!==i.chainsColor&&Object.keys(i.chainsColor).length>0)this.setMmdbChainColor();else{let e=-1,s="",n=l.parasCls.stdChainColors.length;for(let o in t){let t=i.atoms[o];t.chain!=s&&(++e,e%=n),t.het?(t.color=l.parasCls.atomColors[t.elem],i.atomPrevColors[o]=t.color):(t.color=l.parasCls.stdChainColors[e],Object.keys(i.chainsColor).length>0&&this.updateChainsColor(t),i.atomPrevColors[o]=t.color),s=t.chain}}break;case"domain":s=0,n=0;let d=Object.keys(i.tddomains);n=d.length,o=n>1?1/(n-1):1;for(let e=0,t=d.length;e<t;++e){let t=l.parasCls.thr().setHSL(3/4*(1-s++*o),1,.45);for(let s in i.tddomains[d[e]])for(let e in i.residues[s]){let s=i.atoms[e];s.color=t,i.atomPrevColors[e]=s.color}}break;case"secondary structure green":i.sheetcolor="green";for(let e in t){let t=i.atoms[e];t.color=t.het?l.parasCls.atomColors[t.elem]||l.parasCls.defaultAtomColor:l.parasCls.ssColors[t.ss]||l.parasCls.thr(16711935),i.atomPrevColors[e]=t.color}break;case"secondary structure yellow":case"secondary structure":i.sheetcolor="yellow";for(let e in t){let t=i.atoms[e];t.color=t.het?l.parasCls.atomColors[t.elem]||l.parasCls.defaultAtomColor:l.parasCls.ssColors2[t.ss]||l.parasCls.thr(16711935),i.atomPrevColors[e]=t.color}break;case"secondary structure spectrum":s=0,n=0;let c,h,m=[],p=-9999;for(let e in t){if(!i.proteins.hasOwnProperty(e))continue;let t=i.atoms[e];-9999==p&&(c=parseInt(e)),-9999!=p&&(t.ss!=h.ss||Math.abs(t.resi-h.resi)>1||t.ssbegin&&h.ssend)&&("coil"==h.ss||m.push([c,p]),c=e),p=parseInt(e),h=t}"coil"==h.ss||m.push([c,p]),n=m.length,o=n>1?1/(n-1):1;for(let e=0,t=m.length;e<t;++e){let t=l.parasCls.thr().setHSL(3/4*(1-s++*o),1,.45);for(let s=m[e][0];s<=m[e][1];++s){let e=i.atoms[s];e.color=t,i.atomPrevColors[s]=e.color}}break;case"residue":for(let e in t){let t=i.atoms[e];t.color=t.het?l.parasCls.atomColors[t.elem]||l.parasCls.defaultAtomColor:l.parasCls.residueColors[t.resn]||l.parasCls.defaultResidueColor,i.atomPrevColors[e]=t.color}break;case"residue custom":for(let e in t){let t=i.atoms[e];t.color=t.het?l.parasCls.atomColors[t.elem]||l.parasCls.defaultAtomColor:i.customResidueColors[t.resn]||l.parasCls.defaultResidueColor,i.atomPrevColors[e]=t.color}break;case"align custom":i.middB=50,i.spanBinv1=.02,i.spanBinv2=.02;for(let e in t){let t,s=i.atoms[e].structure+"_"+i.atoms[e].chain;if(void 0===i.queryresi2score||!i.queryresi2score.hasOwnProperty(s))continue;let n=i.atoms[e].resi;if(i.queryresi2score[s].hasOwnProperty(n)){let e=i.queryresi2score[s][n];e>100&&(e=100);let o=(i.middB-e)*i.spanBinv1,r=(e-i.middB)*i.spanBinv2;e<i.middB?"blue"==i.startColor?t="white"==i.midColor?l.parasCls.thr().setRGB(1-o,1-o,1):l.parasCls.thr().setRGB(0,0,o):"red"==i.startColor?t="white"==i.midColor?l.parasCls.thr().setRGB(1,1-o,1-o):l.parasCls.thr().setRGB(o,0,0):"green"==i.startColor&&(t="white"==i.midColor?l.parasCls.thr().setRGB(1-o,1,1-o):l.parasCls.thr().setRGB(0,o,0)):"red"==i.endColor?t="white"==i.midColor?l.parasCls.thr().setRGB(1,1-r,1-r):l.parasCls.thr().setRGB(r,0,0):"green"==i.endColor?t="white"==i.midColor?l.parasCls.thr().setRGB(1-r,1,1-r):l.parasCls.thr().setRGB(0,r,0):"blue"==i.endColor&&(t="white"==i.midColor?l.parasCls.thr().setRGB(1-r,1-r,1):l.parasCls.thr().setRGB(0,0,r))}else t=l.parasCls.defaultAtomColor;i.atoms[e].color=t,i.atomPrevColors[e]=t}break;case"charge":for(let e in t){let t=i.atoms[e];t.color=t.het?l.parasCls.defaultAtomColor:l.parasCls.chargeColors[t.resn]||l.parasCls.defaultResidueColor,i.atomPrevColors[e]=t.color}break;case"hydrophobic":for(let e in t){let t=i.atoms[e];t.color=t.het?l.parasCls.defaultAtomColor:l.parasCls.hydrophobicColors[t.resn]||l.parasCls.defaultResidueColor,i.atomPrevColors[e]=t.color}break;case"atom":for(let e in t){let t=i.atoms[e];t.color=l.parasCls.atomColors[t.elem]||l.parasCls.defaultAtomColor,i.atomPrevColors[e]=t.color}break;case"b factor":i.middB=50,i.spanBinv1=.02,i.spanBinv2=.02;for(let e in t){let t=i.atoms[e];if(void 0===t.b||0==parseInt(1e3*t.b))t.color=l.parasCls.thr().setRGB(0,1,0);else{let e=t.b;e>100&&(e=100);let s=(i.middB-e)*i.spanBinv1,n=(e-i.middB)*i.spanBinv2;t.color=e<i.middB?l.parasCls.thr().setRGB(1-s,1-s,1):l.parasCls.thr().setRGB(1,1-n,1-n)}i.bOpm&&"DUM"==t.resn&&(t.color=l.parasCls.atomColors[t.elem]),i.atomPrevColors[e]=t.color}break;case"b factor percentile":if(r=1e3,a=-1e3,!i.bfactorArray){i.bfactorArray=[];for(let e in i.atoms){let t=i.atoms[e];r>t.b&&(r=t.b),a<t.b&&(a=t.b),i.bfactorArray.push(t.b)}i.bfactorArray.sort((function(e,t){return e-t}))}let u=i.bfactorArray.length;for(let e in t){let t=i.atoms[e];if(void 0===t.b||0==parseInt(1e3*t.b)||0==i.bfactorArray.length)t.color=l.parasCls.thr().setRGB(0,1,0);else{let e=i.bfactorArray.indexOf(t.b)/u;t.color=e<.5?l.parasCls.thr().setRGB(2*e,2*e,1):l.parasCls.thr().setRGB(1,2*(1-e),2*(1-e))}i.atomPrevColors[e]=t.color}break;case"area":if(void 0===i.resid2area){let e=l.hashUtilsCls.cloneHash(i.hAtoms);i.hAtoms=l.hashUtilsCls.cloneHash(i.atoms),i.bCalcArea=!0,i.opts.surface="solvent accessible surface",i.applyMapCls.applySurfaceOptions(),i.bCalcArea=!1,i.hAtoms=l.hashUtilsCls.cloneHash(e)}let C=void 0!==i.midpercent?i.midpercent:35;i.spanBinv1=.02,i.spanBinv2=.02;for(let e in t){let t=i.atoms[e],s=t.structure+"_"+t.chain+"_"+t.resi+"_"+t.resn,n=l.parasCls.residueArea.hasOwnProperty(t.resn)?i.resid2area[s]/l.parasCls.residueArea[t.resn]*100:C;n>100&&(n=100);let o=(C-n)*i.spanBinv1,r=(n-C)*i.spanBinv2;t.color=n<C?l.parasCls.thr().setRGB(1-o,1-o,1):l.parasCls.thr().setRGB(1,1-r,1-r),i.bOpm&&"DUM"==t.resn&&(t.color=l.parasCls.atomColors[t.elem]),i.atomPrevColors[e]=t.color}break;case"identity":case"conserved":this.setConservationColor(t,!0);break;case"conservation":this.setConservationColor(t,!1);break;case"white":this.setAtmClr(t,16777215);break;case"grey":this.setAtmClr(t,8947848);break;case"red":this.setAtmClr(t,16711680);break;case"green":this.setAtmClr(t,65280);break;case"blue":this.setAtmClr(t,255);break;case"magenta":this.setAtmClr(t,16711935);break;case"yellow":this.setAtmClr(t,16776960);break;case"cyan":this.setAtmClr(t,65535);break;case"custom":break;default:for(let s in t){let t=i.atoms[s];t.color=l.parasCls.thr().setStyle("#"+e.color.toLowerCase()),i.atomPrevColors[s]=t.color}}}}setAtmClr(e,t){let s=this.icn3d,i=s.icn3dui;for(let l in e){let e=s.atoms[l];e.color=i.parasCls.thr().setHex(t),s.atomPrevColors[l]=e.color}}updateChainsColor(e){let t=this.icn3d;t.icn3dui;let s=e.structure+"_"+e.chain;void 0!==t.chainsColor[s]&&(t.chainsColor[s]=e.color)}setMmdbChainColor(e){let t,s=this.icn3d,i=s.icn3dui,l=void 0===e?s.hAtoms:e;this.applyOriginalColor(i.hashUtilsCls.hash2Atoms(l,s.atoms)),t=i.hashUtilsCls.unionHash(t,s.chemicals),t=i.hashUtilsCls.unionHash(t,s.ions);for(let e in t){let t=s.atoms[e];t.color=i.parasCls.atomColors[t.elem]||i.parasCls.defaultAtomColor,s.atomPrevColors[e]=t.color}}setConservationColor(e,t){let s=this.icn3d,i=s.icn3dui;this.setMmdbChainColor(e);for(let l in s.alnChainsSeq){let n=s.alnChainsSeq[l];for(let o=0,r=n.length;o<r;++o){let r=l+"_"+n[o].resi;for(let l in s.residues[r])if(e.hasOwnProperty(l)){let e=t?i.parasCls.thr(n[o].color):i.parasCls.thr(n[o].color2);s.atoms[l].color=e,s.atomPrevColors[l]=e}}}}applyOriginalColor(e){let t=this.icn3d,s=t.icn3dui;void 0===e&&(e=t.atoms);for(let i in e){let l=e[i],n=l.structure+"_"+l.chain;t.chainsColor.hasOwnProperty(n)?l.color=t.chainsColor[n]:l.color=s.parasCls.atomColors[l.elem],t.atomPrevColors[i]=l.color}}applyPrevColor(){let e=this.icn3d;e.icn3dui;for(let t in e.atoms){e.atoms[t].color=e.atomPrevColors[t]}}setOutlineColor(e){this.icn3d.icn3dui;let t={outline:{vertex_shader:["uniform float offset;","void main() {","vec4 pos = modelViewMatrix * vec4( position + normal * offset, 1.0 );","gl_Position = projectionMatrix * pos;","}"].join("\n"),fragment_shader:["void main(){","gl_FragColor = vec4( 1.0, 1.0, 0.0, 1.0 );","}"].join("\n")}};"yellow"===e?t.outline.fragment_shader=["void main(){","gl_FragColor = vec4( 1.0, 1.0, 0.0, 1.0 );","}"].join("\n"):"green"===e?t.outline.fragment_shader=["void main(){","gl_FragColor = vec4( 0.0, 1.0, 0.0, 1.0 );","}"].join("\n"):"red"===e&&(t.outline.fragment_shader=["void main(){","gl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );","}"].join("\n"));let s=t.outline;return new THREE.ShaderMaterial({uniforms:{offset:{type:"f",value:.5}},vertexShader:s.vertex_shader,fragmentShader:s.fragment_shader,depthTest:!1,depthWrite:!1})}}class z{constructor(e){this.icn3d=e}buildAxes(e,t,s,i,l,n){let o=this.icn3d,r=o.icn3dui;if(o.icn3dui.bNode)return;new THREE.Object3D;let a=0,d=0,c=0;n?(a=t.x,d=t.y,c=t.z):(a-=.3*e,d-=.3*e);let h,m,p,u,C,g,f,b,y,v=new THREE.Vector3(a,d,c),w=e/10,S=e/100;u=C=g=w,n&&(h=s.clone().sub(t),m=i.clone().sub(t),p=l.clone().sub(t),u=h.length(),C=m.length(),g=p.length(),S=u/100,S<.4&&(S=.4)),n?(f=o.cylinderCls.createCylinder_base(t,s,S,r.parasCls.thr(16711680)),b=o.cylinderCls.createCylinder_base(t,i,S,r.parasCls.thr(65280)),y=o.cylinderCls.createCylinder_base(t,l,S,r.parasCls.thr(255))):(f=o.cylinderCls.createCylinder_base(new THREE.Vector3(a,d,c),new THREE.Vector3(a+u,d,c),S,r.parasCls.thr(16711680)),b=o.cylinderCls.createCylinder_base(new THREE.Vector3(a,d,c),new THREE.Vector3(a,d+C,c),S,r.parasCls.thr(65280)),y=o.cylinderCls.createCylinder_base(new THREE.Vector3(a,d,c),new THREE.Vector3(a,d,c+g),S,r.parasCls.thr(255))),o.mdl.add(f),o.mdl.add(b),o.mdl.add(y);let _=n?h.normalize():new THREE.Vector3(1,0,0),A=n?s:new THREE.Vector3(v.x+w,v.y,v.z),x=this.createArrow(_,A,u,16711680,4*S,4*S);o.mdl.add(x);let k=n?m.normalize():new THREE.Vector3(0,1,0),O=n?i:new THREE.Vector3(v.x,v.y+w,v.z),H=this.createArrow(k,O,C,65280,4*S,4*S);o.mdl.add(H);let R=n?p.normalize():new THREE.Vector3(0,0,1),E=n?l:new THREE.Vector3(v.x,v.y,v.z+w),I=this.createArrow(R,E,g,255,4*S,4*S);o.mdl.add(I)}buildAllAxes(e,t){let s=this.icn3d;if(s.icn3dui,!s.icn3dui.bNode&&s.pc1)for(let i=0,l=s.axes.length;i<l;++i){let l=s.axes[i][0],n=s.axes[i][1],o=s.axes[i][2],r=s.axes[i][3];this.buildAxes(e,l,n,o,r,t)}}createArrow(e,t,s,i,l,n,o){let r=this.icn3d;if(r.icn3dui,r.icn3dui.bNode)return;let a,d=new THREE.CylinderBufferGeometry(0,.5,1,32,1);d.translate(0,.5,0),a=o?new THREE.MeshPhongMaterial({transparent:!0,opacity:.5,specular:r.frac,shininess:r.shininess,emissive:r.emissive,color:i}):new THREE.MeshPhongMaterial({specular:r.frac,shininess:r.shininess,emissive:r.emissive,side:THREE.DoubleSide,color:i});let c=new THREE.Mesh(d,a),h=new THREE.Quaternion;if(e.y>.99999)h.set(0,0,0,1);else if(e.y<-.99999)h.set(1,0,0,0);else{let t=new THREE.Vector3;t.set(e.z,0,-e.x).normalize();let s=Math.acos(e.y);h.setFromAxisAngle(t,s)}return c.applyQuaternion(h),c.scale.set(n,l,n),c.position.copy(t),c}setPc1Axes(){let e=this.icn3d,t=e.icn3dui;if(e.icn3dui.bNode)return;let s=t.hashUtilsCls.intHash(e.hAtoms,e.dAtoms),i=[],l=Object.keys(s).length<100;for(let t in s){let s=e.atoms[t],n=s.structure+"_"+s.chain+"_"+s.resi;(l||""!=n)&&i.push(s.coord.clone())}let n=t.rmsdSuprCls.getEigenForSelection(i,i.length),o=new THREE.Vector3(n.h1[0],n.h1[1],n.h1[2]);if(0==n.k&&e.bRender)return void alert("Can't determine the first principal component. Please select a subset and try it again.");let r=e.applyCenterCls.centerAtoms(s),a=r.maxD,d=r.center,c=d.clone().add(o.normalize().multiplyScalar(.4*a)),h=new THREE.Vector3(n.h2[0],n.h2[1],n.h2[2]),m=d.clone().add(h.normalize().multiplyScalar(.3*a)),p=new THREE.Vector3(n.h3[0],n.h3[1],n.h3[2]),u=d.clone().add(p.normalize().multiplyScalar(.3*a));this.buildAxes(void 0,d,c,m,u,!0);let C=[d,c,m,u];return e.axes.push(C),e.drawCls.draw(),C}}class G{constructor(e){this.icn3d=e}addResidueLabels(e,t,s,i){let l=this.icn3d,n=l.icn3dui;if(l.icn3dui.bNode)return;let o=n.hashUtilsCls.intHash(l.hAtoms,e);t?void 0===l.labels.schematic&&(l.labels.schematic=[]):void 0===l.labels.residue&&(l.labels.residue=[]);let r="";for(let e in o){let s=l.atoms[e],o={},a=s.structure+"_"+s.chain+"_"+s.resi;if(!s.het&&("CA"===s.name||"O3'"===s.name||"O3*"===s.name)||l.water.hasOwnProperty(s.serial)||l.ions.hasOwnProperty(s.serial)||l.chemicals.hasOwnProperty(s.serial)&&a!==r){o.position=s.coord,o.bSchematic=0,t&&(o.bSchematic=1),o.text=n.utilsCls.residueName2Abbr(s.resn),i&&(o.text+=s.resi),o.size=18,o.factor=.3;let e=s.color.getHexString().toUpperCase();o.color="CCCCCC"===e||"C8C8C8"===e?"#888888":"#"+e,o.background="#CCCCCC",t?l.labels.schematic.push(o):l.labels.residue.push(o)}r=a}l.hlObjectsCls.removeHlObjects()}addNonCarbonAtomLabels(e){let t=this.icn3d,s=t.icn3dui;if(t.icn3dui.bNode)return;let i=s.hashUtilsCls.intHash(t.hAtoms,e);void 0===t.labels.schematic&&(t.labels.schematic=[]);for(let e in i){let s=t.atoms[e];if(!t.residues.hasOwnProperty(s.structure+"_"+s.chain+"_"+s.resi))continue;if("C"===s.elem)continue;let i={};i.position=s.coord,i.bSchematic=1,i.text=s.elem,i.size=18,i.color="#"+s.color.getHexString(),i.background="#FFFFFF",t.labels.schematic.push(i)}t.hlObjectsCls.removeHlObjects()}addAtomLabels(e){let t=this.icn3d,s=t.icn3dui;if(t.icn3dui.bNode)return;let i=s.hashUtilsCls.intHash(t.hAtoms,e);i=s.hashUtilsCls.intHash(t.dAtoms,i),void 0===t.labels.residue&&(t.labels.residue=[]);for(let e in i){let s=t.atoms[e],i={};i.position=s.coord,i.bSchematic=0,i.text=s.name,i.size=18;let l=s.color.getHexString().toUpperCase();i.color="CCCCCC"===l||"C8C8C8"===l?"#888888":"#"+l,i.background="#CCCCCC",t.labels.residue.push(i)}t.hlObjectsCls.removeHlObjects()}}class V{constructor(e){this.icn3d=e}CalcPhiUrl(e,t,s,i,l){let n=this.icn3d;n.icn3dui;let o=this,r=new XMLHttpRequest;r.open("GET",l,!0),r.responseType="text",r.onreadystatechange=function(){if(4==this.readyState)if(200==this.status){let l=r.response;o.CalcPhi(e,t,s,i,l)}else alert("The PQR file is unavailable...");else n.ParserUtilsCls.showLoading()},r.send()}getPdbStr(e){let t=this.icn3d,s=t.icn3dui,i={},l={},n=s.hashUtilsCls.intHash(t.dAtoms,t.hAtoms);for(let e in n)t.atoms[e],t.ions.hasOwnProperty(e)?i[e]=1:l[e]=1;let o=Object.keys(l).length;if(s.utilsCls.isCalphaPhosOnly(s.hashUtilsCls.hash2Atoms(l,t.atoms)))return void(e?console.log("The potential will not be shown because the side chains are missing in the structure..."):alert("The potential will not be shown because the side chains are missing in the structure..."));if(o>3e4)return void(e?console.log("The maximum number of allowed atoms is 30,000. Please try it again with selected chains..."):alert("The maximum number of allowed atoms is 30,000. Please try it again with selected chains..."));let r="";return r+=t.saveFileCls.getPDBHeader(),r+=t.icn3dui.cfg.cid?t.saveFileCls.getAtomPDB(l,!0):t.saveFileCls.getAtomPDB(l),r+=t.saveFileCls.getAtomPDB(i,!0),r}CalcPhi(e,t,s,i,l){let n=this.icn3d;n.icn3dui;let o=this;n.loadPhiFrom="delphi";let r=n.icn3dui.cfg.cid?n.icn3dui.cfg.cid:Object.keys(n.structures).toString(),a={};if(l)a={pqr2phi:l,gsize:e,salt:t,pdbid:r};else{a={pdb2phi:this.getPdbStr(),gsize:e,salt:t,pdbid:r}}$.ajax({url:"https://www.ncbi.nlm.nih.gov/Structure/delphi/delphi.fcgi",type:"POST",data:a,dataType:"binary",responseType:"arraybuffer",cache:!0,tryCount:0,retryLimit:0,beforeSend:function(){n.ParserUtilsCls.showLoading()},complete:function(){n.ParserUtilsCls.hideLoading()},success:function(e){o.loadPhiData(e,s,i),n.bAjaxPhi=!0,i?n.setOptionCls.setOption("phisurface","phi"):n.setOptionCls.setOption("phimap","phi"),void 0!==n.deferredDelphi&&n.deferredDelphi.resolve(),void 0!==n.deferredPhi&&n.deferredPhi.resolve()},error:function(e,t,s){this.tryCount++,this.tryCount<=this.retryLimit&&$.ajax(this)}})}PhiParser(e,t,s,i){let l=this.icn3d;l.icn3dui;let n=this,o=new XMLHttpRequest;o.open("GET",e,!0),o.responseType="phiurl"==t||"phiurl2"==t?"arraybuffer":"text",o.onreadystatechange=function(){if(4==this.readyState){if(200==this.status){let e=o.response;"phiurl"==t||"phiurl2"==t?n.loadPhiData(e,s,i):n.loadCubeData(e,s,i),l.bAjaxPhi=!0,i?l.setOptionCls.setOption("phisurface","phi"):l.setOptionCls.setOption("phimap","phi")}else alert("The potential file is unavailable...");void 0!==l.deferredPhi&&l.deferredPhi.resolve()}else l.ParserUtilsCls.showLoading()},o.send()}loadPhiData(e,t,s){let i=this.icn3d;i.icn3dui;let l={filetype:"phi"},n=e.buffer&&e.buffer instanceof ArrayBuffer?e.buffer:e,o=new Float32Array(n.slice(n.byteLength-24,n.byteLength-8));l.scale=o[0];let r=o[1],a=o[2],d=o[3];l.n=new Int32Array(n.slice(n.byteLength-8,n.byteLength-4)),l.xExtent=l.yExtent=l.zExtent=l.n;let c=1/l.scale*((l.n-1)/2);l.ori=new THREE.Vector3(r-c,a-c,d-c);let h=new Float32Array(n.slice(110,n.byteLength-56));l.bSurface=s,i.mapData.headerPhi=l,i.mapData.dataPhi=h,i.mapData.contourPhi=t;let m=new THREE.Matrix4;m.identity(),m.multiply((new THREE.Matrix4).makeTranslation(l.ori.x,l.ori.y,l.ori.z)),i.mapData.matrixPhi=m}loadCubeData(e,t,s){let i=this.icn3d;i.icn3dui;let l={filetype:"cube"},n=e.split("\n"),o=[];o.push(parseFloat(n[0].substr(0,10))),o.push(parseFloat(n[0].substr(10,6))),o.push(parseFloat(n[0].substr(16,10))),o.push(parseFloat(n[0].substr(26,10))),o.push(parseFloat(n[0].substr(36,10))),l.scale=o[0];let r=o[2],a=o[3],d=o[4];l.n=o[1],l.xExtent=l.yExtent=l.zExtent=l.n;let c=1/l.scale*((l.n-1)/2);l.ori=new THREE.Vector3(r-c,a-c,d-c);let h=[];for(let e=7,t=n.length;e<t;++e){let t=n[e].split(/\s+/);for(let e=0,s=t.length;e<s;++e){let s=parseFloat(t[e]);isNaN(s)||h.push(s)}}h.length!=l.n*l.n*l.n&&console.log("the data array size "+h.length+" didn't match the grid size "+l.n*l.n*l.n+"..."),l.bSurface=s,i.mapData.headerPhi=l,i.mapData.dataPhi=h,i.mapData.contourPhi=t;let m=new THREE.Matrix4;m.identity(),m.multiply((new THREE.Matrix4).makeTranslation(l.ori.x,l.ori.y,l.ori.z)),i.mapData.matrixPhi=m}applyCommandPhi(e){let t=this.icn3d;t.icn3dui;let s=this;return t.deferredPhi=$.Deferred((function(){let t=s.icn3d,i=e.split(" | "),l=i[0].split(" "),n=i[1].split(" "),o=i[2].split(" "),r=i[3].split(" "),a=i[4].split(" "),d=l[2],c=parseFloat(n[1]),h=o[1],m=r[1],p=a[1];if(8==i.length){let e=i[5].split(" "),s=i[6].split(" "),l=i[7].split(" ");t.phisurftype=e[1],t.phisurfop=parseFloat(s[1]),t.phisurfwf=l[1],$("#"+t.pre+"delphisurftype").val(t.phisurftype),$("#"+t.pre+"delphisurfop").val(t.phisurfop),$("#"+t.pre+"delphisurfwf").val(t.phisurfwf)}let u="pqrurl2"==d||"phiurl2"==d||"cubeurl2"==d;"pqrurl"==d||"pqrurl2"==d?s.CalcPhiUrl(m,p,c,u,h):s.PhiParser(h,d,c,u)})),t.deferredPhi.promise()}applyCommandDelphi(e){let t=this.icn3d;t.icn3dui;let s=this;return t.deferredDelphi=$.Deferred((function(){let t=s.icn3d,i=e.split(" | "),l=i[0].split(" "),n=i[1].split(" "),o=i[2].split(" "),r=i[3].split(" "),a=l[2],d=n[1],c=o[1],h=r[1];if($("#"+t.pre+"delphigsize").val(c),$("#"+t.pre+"delphisalt").val(h),7==i.length){let e=i[4].split(" "),s=i[5].split(" "),l=i[6].split(" ");t.phisurftype=e[1],t.phisurfop=s[1],t.phisurfwf=l[1],$("#"+t.pre+"delphisurftype").val(t.phisurftype),$("#"+t.pre+"delphisurfop").val(t.phisurfop),$("#"+t.pre+"delphisurfwf").val(t.phisurfwf)}let m="surface"==a;s.CalcPhi(c,h,d,m)})),t.deferredDelphi.promise()}loadDelphiFile(e){let t=this.icn3d;t.icn3dui;let s=$("#"+t.pre+"delphigsize").val(),i=$("#"+t.pre+"delphisalt").val(),l="delphi2"==e?$("#"+t.pre+"delphicontour2").val():$("#"+t.pre+"delphicontour").val(),n="delphi2"==e;this.CalcPhi(s,i,l,n);let o="delphi2"==e?"surface":"map";n?t.icn3dui.htmlCls.clickMenuCls.setLogCmd("set delphi "+o+" | contour "+l+" | gsize "+s+" | salt "+i+" | surface "+t.phisurftype+" | opacity "+t.phisurfop+" | wireframe "+t.phisurfwf,!0):t.icn3dui.htmlCls.clickMenuCls.setLogCmd("set delphi "+o+" | contour "+l+" | gsize "+s+" | salt "+i,!0)}loadPhiFile(e){let t,s=this.icn3d,i=s.icn3dui,l=this;"pqr"==e||"phi"==e||"cube"==e?t=$("#"+s.pre+e+"file")[0].files[0]:"pqr2"==e?t=$("#"+s.pre+"pqrfile2")[0].files[0]:"phi2"==e?t=$("#"+s.pre+"phifile2")[0].files[0]:"cube2"==e&&(t=$("#"+s.pre+"cubefile2")[0].files[0]);let n="pqr"==e||"phi"==e||"cube"==e?$("#"+s.pre+"phicontour").val():$("#"+s.pre+"phicontour2").val();if(t){i.utilsCls.checkFileAPI();let s=new FileReader;s.onload=function(t){let s=l.icn3d,i=t.target.result,o=0,r=0;if("pqr"==e||"pqr2"==e){let t="pqr2"==e;o=$("#"+s.pre+e+"gsize").val(),r=$("#"+s.pre+e+"salt").val(),l.CalcPhi(o,r,n,t,i)}else if("phi"==e||"phi2"==e){let t="phi2"==e;l.loadPhiData(i,n,t)}else if("cube"==e||"cube2"==e){let t="cube2"==e;l.loadCubeData(i,n,t)}s.bAjaxPhi=!0,bSurface?s.setOptionCls.setOption("phisurface","phi"):s.setOptionCls.setOption("phimap","phi"),bSurface?s.icn3dui.htmlCls.clickMenuCls.setLogCmd("load phi "+e+" | contour "+n+" | file "+$("#"+s.pre+e+"file").val()+" | gsize "+o+" | salt "+r+" | surface "+s.phisurftype+" | opacity "+s.phisurfop+" | wireframe "+s.phisurfwf,!1):s.icn3dui.htmlCls.clickMenuCls.setLogCmd("load phi "+e+" | contour "+n+" | file "+$("#"+s.pre+e+"file").val()+" | gsize "+o+" | salt "+r,!1)},"phi"==e||"phi2"==e?s.readAsArrayBuffer(t):s.readAsText(t)}else alert("Please select a file before clicking 'Load'")}loadPhiFileUrl(e){let t,s=this.icn3d;s.icn3dui,"pqrurl"==e||"phiurl"==e||"cubeurl"==e?t=$("#"+s.pre+e+"file").val():"pqrurl2"==e?t=$("#"+s.pre+"pqrurlfile2").val():"phiurl2"==e?t=$("#"+s.pre+"phiurlfile2").val():"cubeurl2"==e&&(t=$("#"+s.pre+"cubeurlfile2").val());let i="pqrurl"==e||"phiurl"==e||"cubeurl"==e?$("#"+s.pre+"phiurlcontour").val():$("#"+s.pre+"phiurlcontour2").val();if(t){let l="pqrurl2"==e||"phiurl2"==e||"cubeurl2"==e,n=0,o=0;"pqrurl"==e||"pqrurl2"==e?(n=$("#"+s.pre+e+"gsize").val(),o=$("#"+s.pre+e+"salt").val(),this.CalcPhiUrl(n,o,i,l,t)):this.PhiParser(t,e,i,l),l?s.icn3dui.htmlCls.clickMenuCls.setLogCmd("set phi "+e+" | contour "+i+" | url "+encodeURIComponent(t)+" | gsize "+n+" | salt "+o+" | surface "+s.phisurftype+" | opacity "+s.phisurfop+" | wireframe "+s.phisurfwf,!0):s.icn3dui.htmlCls.clickMenuCls.setLogCmd("set phi "+e+" | contour "+i+" | url "+encodeURIComponent(t)+" | gsize "+n+" | salt "+o,!0)}else alert("Please input the file URL before clicking 'Load'")}}class W{constructor(e){this.icn3d=e}applyCommandScapBase(e){this.icn3d.icn3dui;let t=e.substr(e.lastIndexOf(" ")+1);0==e.indexOf("scap 3d")?this.retrieveScap(t):0==e.indexOf("scap interaction")?this.retrieveScap(t,!0):0==e.indexOf("scap pdb")&&this.retrieveScap(t,void 0,!0)}applyCommandScap(e){let t=this.icn3d;t.icn3dui;let s=this;return t.deferredScap=$.Deferred((function(){s.applyCommandScapBase(e)})),t.deferredScap.promise()}adjust2DWidth(e){let t=this.icn3d;t.icn3dui;e=t.pre+e;let s=$("#"+t.pre+"dl_selectannotations").hasClass("ui-dialog-content")?$("#"+t.pre+"dl_selectannotations").dialog("option","height"):t.icn3dui.htmlCls.HEIGHT,i=$("#"+t.pre+"dl_selectannotations").hasClass("ui-dialog-content")?250:.5*t.icn3dui.htmlCls.WIDTH;$("#"+e).dialog("option","width",i),$("#"+e).dialog("option","height",s);let l={my:"left-125 top+"+t.icn3dui.htmlCls.MENU_HEIGHT,at:"right top",of:"#"+t.pre+"viewer",collision:"none"};$("#"+e).dialog("option","position",l)}retrieveScap(e,t,s){let i=this.icn3d,l=i.icn3dui,n=this,o="",r=e.split(","),a={},d=[];for(let e=0,t=r.length;e<t;++e){let s=r[e].split("_"),n=s[0]+"_"+s[1]+"_"+s[2];a=l.hashUtilsCls.unionHash(a,i.residues[n]),d.push(n),o+=s[1]+"_"+s[2]+"_"+s[3],e!=t-1&&(o+=",")}let c=i.resid2specCls.residueids2spec(d),h="select "+c,m=i.showInterCls.pickCustomSphere_base(10,a,i.atoms,!1,!1,void 0,h,!1);d=Object.keys(m.residues),i.hAtoms={};for(let e=0,t=d.length;e<t;++e){let t=d[e];for(let e in i.residues[t])i.hAtoms[e]=1}i.hAtoms=l.hashUtilsCls.unionHash(i.hAtoms,a),i.hAtoms=l.hashUtilsCls.exclHash(i.hAtoms,i.chemicals);let p=i.saveFileCls.getPDBHeader()+i.saveFileCls.getAtomPDB(i.hAtoms),u=Object.keys(i.structures)[0],C={pdb:p,snp:o,pdbid:u,v:"2"};$.ajax({url:"https://www.ncbi.nlm.nih.gov/Structure/scap/scap.cgi",type:"POST",data:C,dataType:"text",cache:!0,tryCount:0,retryLimit:1,beforeSend:function(){i.ParserUtilsCls.showLoading()},complete:function(){},success:function(e){let r=e.indexOf("\n"),a=e.substr(0,r),d=e.substr(r+1);console.log("free energy: "+a+" kcal/mol");let h=l.hashUtilsCls.cloneHash(i.hAtoms);i.hAtoms={},i.loadPDBCls.loadPDB(d,u,!1,!1,!0);let m=l.hashUtilsCls.cloneHash(i.hAtoms);i.hAtoms=l.hashUtilsCls.unionHash(i.hAtoms,h),i.dAtoms=i.hAtoms,i.transformCls.zoominSelection(),i.setOptionCls.setStyle("proteins","stick"),i.opts.color="chain",i.setColorCls.setColorByOptions(i.opts,i.dAtoms);for(let e in m){let t=i.atoms[e];if(!t.het){let s=t.structure.substr(0,4)+"_"+t.chain+"_"+t.resi,l=i.firstAtomObjCls.getFirstAtomObj(i.residues[s]);i.atoms[e].color=l.color,i.atomPrevColors[e]=l.color}}if(s){let e="";e+=i.saveFileCls.getPDBHeader(),e+=i.saveFileCls.getAtomPDB(i.hAtoms);let t=i.inputid?i.inputid:"custom";i.saveFileCls.saveFile(t+"_"+o+".pdb","text",[e]),i.drawCls.draw()}else{let e=c,s="snp_"+o;if(i.selByCommCls.selectByCommand(e,s,s),i.opts.color="atom",i.setColorCls.setColorByOptions(i.opts,i.hAtoms),i.viewInterPairsCls.clearInteractions(),t){let e="linegraph";i.viewInterPairsCls.viewInteractionPairs(["selected"],["non-selected"],!1,e,!0,!0,!0,!0,!0,!0),n.adjust2DWidth("dl_linegraph")}i.hAtoms=i.dAtoms,i.drawCls.draw(),i.alertAlt||(i.alertAlt=!0,i.bRender&&alert('Please press the letter "a" to alternate between wild type and mutant.'))}$("#"+i.pre+"mn2_alternateWrap").show();let p=i.pre+"selection";$("#"+p).show(),void 0!==i.deferredScap&&i.deferredScap.resolve()},error:function(e,t,s){this.tryCount++,this.tryCount<=this.retryLimit?$.ajax(this):(alert("There are some problems in predicting the side chain of the mutant..."),i.ParserUtilsCls.hideLoading(),void 0!==i.deferredScap&&i.deferredScap.resolve())}})}}class Y{constructor(e){this.icn3d=e}applyCommandSymdBase(e){this.icn3d.icn3dui,this.retrieveSymd()}applyCommandSymd(e){let t=this.icn3d;t.icn3dui;let s=this;return t.deferredSymd=$.Deferred((function(){s.applyCommandSymdBase(e)})),t.deferredSymd.promise()}retrieveSymd(){let e=this.icn3d,t=e.icn3dui,s=this,i=t.hashUtilsCls.intHash(e.dAtoms,e.hAtoms);i=t.hashUtilsCls.intHash(i,e.proteins);let l=Object.keys(i).length,n={};for(let t in i){let s=e.atoms[t],i=s.structure+"_"+s.chain+"_"+s.resi;n[i]=1}if(l>1e4)return void alert("The maximum number of allowed atoms is 10,000. Please try it again with smaller sets...");let o="";o+=e.saveFileCls.getPDBHeader(),o+=e.saveFileCls.getAtomPDB(i);let r={pdb:o,pdbid:Object.keys(e.structures).toString()};$.ajax({url:"https://www.ncbi.nlm.nih.gov/Structure/symd/symd.cgi",type:"POST",data:r,dataType:"jsonp",cache:!0,tryCount:0,retryLimit:1,beforeSend:function(){e.ParserUtilsCls.showLoading()},complete:function(){},success:function(i){let l=i.rcsb_struct_symmetry,o="none";if(void 0!==l){let r;void 0!==e.rmsd_supr&&void 0!==e.rmsd_supr.rot&&(e.rmsd_supr.rot,e.rmsd_supr.trans1,e.rmsd_supr.trans2),void 0===e.symdArray&&(e.symdArray=[]);for(let t=0,i=l.length;t<i;++t){if("C1"==l[t].symbol)continue;o=l[t].symbol+" ","Pseudo Symmetry"==l[t].kind?o=l[t].symbol+" (pseudo)":"Global Symmetry"==l[t].kind?o=l[t].symbol+" (global)":"Local Symmetry"==l[t].kind&&(o=l[t].symbol+" (local)");let i=l[t].rotation_axes,n=[];for(let e=0,o=i.length;e<o;++e){let o=[],a=new THREE.Vector3(i[e].start[0],i[e].start[1],i[e].start[2]),d=new THREE.Vector3(i[e].end[0],i[e].end[1],i[e].end[2]);r=i[e].order,o.push(a),o.push(d);let c=s.getAxisColor(l[t].symbol,i[e].order),h=s.getPolygonColor(l[t].symbol);o.push(c),o.push(h),o.push(i[e].order),o.push("selection"),n.push(o)}let a={};a[o]=n,e.symdArray.push(a)}if(0==e.symdArray.length)$("#"+e.pre+"dl_symd").html("<br>The selected residues have no detected symmetry with a Z score of "+i.zscore+" from the program <a href='https://symd.nci.nih.gov/' target='_blank'>SymD</a>."),e.icn3dui.htmlCls.dialogCls.openDlg("dl_symd","Dynamically Calculated Symmetry Using SymD");else{let o=i.seqalign.replace(/ /g,"").split(","),a=i.nres,d=i.shift,c=i.rmsd,h=Object.keys(n),m={},p={},u=[],C=[],g=0,f=0,b={};for(let e=0,s=o[0].length;e<s;++e){let s=o[0][e],i=o[1][e];if("-"!=s){if(s==s.toUpperCase()){m[h[g]]=1;let e=t.utilsCls.getIdArray(h[g]);u.push(s+" $"+e[0]+"."+e[1]+":"+e[2]);let i=e[0]+"_"+e[1];b.hasOwnProperty(i)||(b[i]=[]),b[i].push(u.length-1)}++g}if("-"!=i){if(i==i.toUpperCase()){let e=(f+d+a)%a;p[h[e]]=1;let s=t.utilsCls.getIdArray(h[e]);C.push(i+" $"+s[0]+"."+s[1]+":"+s[2])}++f}}let y={},v={},w=[],S=[],_=!1;if(1==Object.keys(b).length){_=!0;let e=parseInt(u.length/r+.5),t=Object.keys(m),s=Object.keys(p);for(let i=0;i<e;++i)y.hasOwnProperty(s[i])||(w.push(u[i]),S.push(C[i]),y[t[i]]=1,v[s[i]]=1)}else{let e,t=0;for(let s in b)b[s].length>t&&(t=b[s].length,e=s);let s=Object.keys(m),i=Object.keys(p);for(let t=0,l=b[e].length;t<l;++t){let l=b[e][t];y.hasOwnProperty(i[l])||(w.push(u[l]),S.push(C[l]),y[s[l]]=1,v[i[l]]=1)}}let A="<br>";A+="The symmetry "+l[0].symbol+" was calculated dynamically using the program <a href='https://symd.nci.nih.gov/' target='_blank'>SymD</a>. The Z score "+i.zscore+" is greater than the threshold Z score 8. The RMSD is "+c+' angstrom. <br><br>The following sequence alignment shows the residue mapping of the best aligned sets: "symOri" and "symPerm", which are also available in the menu "Analysis > Defined Sets".<br>',$("#"+e.pre+"symd_info").html(A),s.setSeqAlignForSymmetry(w,S,_);let x=!1,k=e.icn3dui.htmlCls.alignSeqCls.getAlignSequencesAnnotations(Object.keys(e.alnChains),void 0,void 0,x,_);A=$("#"+e.pre+"dl_sequence2").html()+k.sequencesHtml,$("#"+e.pre+"dl_sequence2").html(A),$("#"+e.pre+"dl_sequence2").width(e.icn3dui.htmlCls.RESIDUE_WIDTH*k.maxSeqCnt+200),e.icn3dui.htmlCls.dialogCls.openDlg("dl_alignment","Select residues in aligned sequences from SymD");let O=Object.keys(e.defNames2Residues).length+Object.keys(e.defNames2Atoms).length,H="symOri"+O;e.selectionCls.selectResidueList(y,H,H),e.selectionCls.updateSelectionNameDesc(),e.icn3dui.htmlCls.clickMenuCls.setLogCmd("select "+e.resid2specCls.residueids2spec(Object.keys(y))+" | name "+H,!1),H="symPerm"+O,e.selectionCls.selectResidueList(v,H,H),e.selectionCls.updateSelectionNameDesc(),e.icn3dui.htmlCls.clickMenuCls.setLogCmd("select "+e.resid2specCls.residueids2spec(Object.keys(v))+" | name "+H,!1),H="symBoth"+O,y=t.hashUtilsCls.unionHash(y,v),e.selectionCls.selectResidueList(y,H,H),e.selectionCls.updateSelectionNameDesc(),e.icn3dui.htmlCls.clickMenuCls.setLogCmd("select "+e.resid2specCls.residueids2spec(Object.keys(y))+" | name "+H,!1)}}else $("#"+e.pre+"dl_symd").html("<br>The selected residues have no detected symmetry with a Z score of "+i.zscore+" from the program <a href='https://symd.nci.nih.gov/' target='_blank'>SymD</a>."),e.icn3dui.htmlCls.dialogCls.openDlg("dl_symd","Dynamically Calculated Symmetry Using SymD");e.symdtitle="none"===o?void 0:o,e.drawCls.draw(),void 0!==e.deferredSymd&&e.deferredSymd.resolve()},error:function(t,s,i){this.tryCount++,this.tryCount<=this.retryLimit?$.ajax(this):($("#"+e.pre+"dl_symd").html("<br>The web service can not determine the symmetry of the input set."),e.icn3dui.htmlCls.dialogCls.openDlg("dl_symd","Dynamically Calculated Symmetry Using SymD"),e.ParserUtilsCls.hideLoading(),void 0!==e.deferredSymd&&e.deferredSymd.resolve())}})}getResObj(e){this.icn3d.icn3dui;let t=e.substr(0,e.indexOf(" ")),s=e.indexOf("$"),i=e.indexOf("."),l=e.indexOf(":"),n=e.substr(s+1,i-s-1),o=e.substr(i+1,l-i-1),r=e.substr(l+1);return{resn:t,resid:n+"_"+o+"_"+r,resi:r,aligned:!0}}setSeqAlignForSymmetry(e,t,s){let i=this.icn3d,l=i.icn3dui;i.conservedName1="symOri_cons",i.conservedName2="symPerm_cons",i.consHash1={},i.consHash2={},i.alnChainsAnTtl={},i.alnChainsAnno={},i.alnChainsSeq={},i.alnChains={},i.alnChainsSeq={};let n={};for(let o=0,r=e.length;o<r;++o){let r,a=this.getResObj(e[o]),d=this.getResObj(t[o]),c=a.resid.substr(0,a.resid.lastIndexOf("_")),h=d.resid.substr(0,d.resid.lastIndexOf("_")),m=h;if(s){m=h.substr(0,h.indexOf("_"))+"2"+h.substr(h.indexOf("_"))}n[a.resid]=1,n[d.resid]=1,r=a.resn==d.resn?"#FF0000":"#0000FF";let p="#"+i.showAnnoCls.getColorhexFromBlosum62(a.resn,d.resn);a.color=r,d.color=r,a.color2=p,d.color2=p;for(let e in i.residues[a.resid])i.atoms[e].color=l.parasCls.thr(r),i.atomPrevColors[e]=l.parasCls.thr(r);for(let e in i.residues[d.resid])i.atoms[e].color=l.parasCls.thr(r),i.atomPrevColors[e]=l.parasCls.thr(r);void 0===i.alnChainsAnTtl[c]&&(i.alnChainsAnTtl[c]=[]);for(let e=0;e<3;++e)void 0===i.alnChainsAnTtl[c][e]&&(i.alnChainsAnTtl[c][e]=[]);for(let e=0;e<3;++e)i.alnChainsAnTtl[c][e].push("");void 0===i.alnChainsSeq[c]&&(i.alnChainsSeq[c]=[]),void 0===i.alnChainsSeq[m]&&(i.alnChainsSeq[m]=[]),i.alnChainsSeq[c].push(a),i.alnChainsSeq[m].push(d),void 0===i.alnChains[c]&&(i.alnChains[c]={}),void 0===i.alnChains[m]&&(i.alnChains[m]={}),$.extend(i.alnChains[c],i.residues[c+"_"+a.resi]),$.extend(i.alnChains[m],i.residues[m+"_"+d.resi]),i.consHash1[c+"_"+a.resi]=1,i.consHash2[m+"_"+d.resi]=1,void 0===i.alnChainsAnno[c]&&(i.alnChainsAnno[c]=[]);for(let e=0;e<3;++e)void 0===i.alnChainsAnno[c][e]&&(i.alnChainsAnno[c][e]=[]);let u=".";o%5==0&&(u="*"),o%10==0&&(u="|"),i.alnChainsAnno[c][0].push(u);let C="";o%10==0&&(C=o.toString()),i.alnChainsAnno[c][1].push(C)}}retrieveSymmetry(e){let t=this.icn3d;t.icn3dui;let s=this,i="https://data.rcsb.org/rest/v1/core/assembly/"+e+"/1";$.ajax({url:i,dataType:"json",cache:!0,tryCount:0,retryLimit:1,success:function(e){let i,l,n,o=e.rcsb_struct_symmetry;if(void 0!==o){void 0!==t.rmsd_supr&&void 0!==t.rmsd_supr.rot&&(i=t.rmsd_supr.rot,l=t.rmsd_supr.trans1,n=t.rmsd_supr.trans2),t.symmetryHash={};for(let e=0,r=o.length;e<r;++e){if("C1"==o[e].symbol)continue;let r="no title";"Pseudo Symmetry"==o[e].kind?r=o[e].symbol+" (pseudo)":"Global Symmetry"==o[e].kind?r=o[e].symbol+" (global)":"Local Symmetry"==o[e].kind&&(r=o[e].symbol+" (local)");let a=o[e].rotation_axes,d=[];for(let r=0,c=a.length;r<c;++r){let c=[],h=new THREE.Vector3(a[r].start[0],a[r].start[1],a[r].start[2]),m=new THREE.Vector3(a[r].end[0],a[r].end[1],a[r].end[2]);void 0!==t.rmsd_supr&&void 0!==t.rmsd_supr.rot&&(h=t.surfaceCls.transformMemPro(h,i,l,n),m=t.surfaceCls.transformMemPro(m,i,l,n)),c.push(h),c.push(m);let p=s.getAxisColor(o[e].symbol,a[r].order),u=s.getPolygonColor(o[e].symbol);c.push(p),c.push(u),c.push(a[r].order),c.push(o[e].clusters[0].members[0].asym_id),d.push(c)}t.symmetryHash[r]=d}if(0==Object.keys(t.symmetryHash).length)$("#"+t.pre+"dl_symmetry").html("<br>This structure has no symmetry.");else{let e="<option value='none'>None</option>",s=0;for(let i in t.symmetryHash){e+="<option value='"+i+"' "+(0==s?"selected":"")+">"+i+"</option>",++s}$("#"+t.pre+"selectSymmetry").html(e)}}else $("#"+t.pre+"dl_symmetry").html("<br>This structure has no symmetry.");t.icn3dui.htmlCls.dialogCls.openDlg("dl_symmetry","Symmetry"),void 0!==t.deferredSymmetry&&t.deferredSymmetry.resolve()},error:function(e,s,i){this.tryCount++,this.tryCount<=this.retryLimit?$.ajax(this):($("#"+t.pre+"dl_symmetry").html("<br>This structure has no symmetry."),t.icn3dui.htmlCls.dialogCls.openDlg("dl_symmetry","Symmetry"),void 0!==t.deferredSymmetry&&t.deferredSymmetry.resolve())}})}getPolygonColor(e){let t=this.icn3d.icn3dui,s=e.substr(0,1);return"C"==s?t.parasCls.thr(16747520):"D"==s?t.parasCls.thr(65535):"T"==s?t.parasCls.thr(15631086):"O"==s?t.parasCls.thr(16753920):"I"==s?t.parasCls.thr(65280):t.parasCls.thr(11119017)}getAxisColor(e,t){let s=this.icn3d.icn3dui,i=e.substr(0,1);return"C"==i?s.parasCls.thr(16711680):"D"==i?2==t?s.parasCls.thr(65535):s.parasCls.thr(16711680):"T"==i?2==t?s.parasCls.thr(65535):s.parasCls.thr(65280):"O"==i||"I"==i?2==t?s.parasCls.thr(65535):3==t?s.parasCls.thr(65280):s.parasCls.thr(16711680):s.parasCls.thr(16711680)}}class X{constructor(e){this.icn3d=e}loadPDB(e,t,s,i,l){let n,o,r=this.icn3d,a=r.icn3dui,d=[],c=[],h=e.split("\n"),m={},p={};if(l){if(r.alertAlt){let e=r.oriNStru+1,t=r.structures[e-1];for(let e=0,s=t?t.length:0;e<s;++e){for(let s in r.chains[t[e]])delete r.atoms[s],delete r.hAtoms[s],delete r.dAtoms[s];delete r.chains[t[e]]}delete r.structures[e-1]}else r.oriNStru=Object.keys(r.structures).length;o=r.oriNStru+1,n=Object.keys(r.atoms).length}else r.init(),o=1,n=0;let u,C,g,f,b,y,v,w=[],S=[],_=[],A=[],x=[],k=[],O="",H="",R="",E={},I={},D="stru",T=0,P="";for(let e in h){let t=h[e],F=t.substr(0,6);if("HEADER"===F)D=t.substr(62,4).trim(),r.molTitle="";else if("TITLE "===F){let e=t.substr(10);r.molTitle+=e.trim()+" "}else if("HELIX "===F){r.bSecondaryStructure=!0;let e,s=" "==t.substr(19,1)?"A":t.substr(19,1),i=parseInt(t.substr(21,4)),l=parseInt(t.substr(33,4));for(let t=i;t<=l;++t)e=s+"_"+t,A.push(e),t===i&&x.push(e),t===l&&k.push(e);d.push({chain:s,initialResidue:i,initialInscode:t.substr(25,1),terminalResidue:l,terminalInscode:t.substr(37,1)})}else if("SHEET "===F){void 0!==s&&s||(r.bSecondaryStructure=!0);let e=" "==t.substr(21,1)?"A":t.substr(21,1),i=parseInt(t.substr(22,4)),l=parseInt(t.substr(33,4));for(let t=i;t<=l;++t){let s=e+"_"+t;w.push(s),t===i&&S.push(s),t===l&&_.push(s)}c.push({chain:e,initialResidue:i,initialInscode:t.substr(26,1),terminalResidue:l,terminalInscode:t.substr(37,1)})}else if("HBOND "===F)void 0!==s&&s||(r.bSecondaryStructure=!0);else if("SSBOND"===F){r.bSsbondProvided=!0;let e=D+"_"+(" "==t.substr(15,1)?"A":t.substr(15,1))+"_"+t.substr(17,4).trim(),s=D+"_"+(" "==t.substr(29,1)?"A":t.substr(29,1))+"_"+t.substr(31,4).trim();void 0===r.ssbondpnts[D]&&(r.ssbondpnts[D]=[]),r.ssbondpnts[D].push(e),r.ssbondpnts[D].push(s)}else if("REMARK"===F){let e=parseInt(t.substr(7,3));if(-1!==t.indexOf("1/2 of bilayer thickness:"))r.halfBilayerSize=parseFloat(t.substr(t.indexOf(":")+1).trim());else if(350==e&&"BIOMT"==t.substr(13,5)){let e=parseInt(t[18])-1,s=parseInt(t.substr(21,2))-1;null==r.biomtMatrices[s]&&(r.biomtMatrices[s]=(new THREE.Matrix4).identity()),r.biomtMatrices[s].elements[e]=parseFloat(t.substr(24,9)),r.biomtMatrices[s].elements[e+4]=parseFloat(t.substr(34,9)),r.biomtMatrices[s].elements[e+8]=parseFloat(t.substr(44,9)),r.biomtMatrices[s].elements[e+12]=parseFloat(t.substr(54,10))}else if(465==e&&" "==t.substr(18,1)&&" "==t.substr(20,1)&&"S"!=t.substr(21,1)){let e=t.substr(15,3),s=t.substr(19,1),i=parseInt(t.substr(21,5)),l=D+"_"+s;void 0===I[l]&&(I[l]=[]);let n={};n.resi=i,n.name=a.utilsCls.residueName2Abbr(e).toLowerCase(),s!=P&&(T=0),!isNaN(i)&&(""==P||s!=P||s==P&&i>T)&&(I[l].push(n),T=i,P=s)}else 900==e&&void 0===r.emd&&"RELATED DB: EMDB"==t.substr(34).trim()&&(r.emd=t.substr(23,11).trim())}else if("SOURCE"===F&&void 0===r.organism&&"ORGANISM_COMMON"==t.substr(11,15).trim())r.organism=t.substr(28).toLowerCase().trim(),r.organism=r.organism.substr(0,r.organism.length-1);else if("ENDMDL"===F)++o,D="stru";else if("JRNL  "===F)"PMID"===t.substr(12,4)&&(r.pmid=t.substr(19).trim());else if("ATOM  "===F||"HETATM"===F){let e=D;("stru"==D||l)&&(e=1===o?D:D+o.toString());let d=t.substr(16,1);++n,E[parseInt(t.substr(6,5))]=n;let c=t.substr(76,2).trim();""===c&&(c=t.substr(12,2).trim());let h=t.substr(12,4).trim(),I=t.substr(17,3),T=t.substr(21,1);" "===T&&(T="A");let P=t.substr(22,5).trim(),M=P;if(s&&"DUM"===I&&(c=h,T="MEM",M=1,P=1),i&&"DUM"===I)break;u=e+"_"+T,g=u+"_"+P,C=u+"_"+M;let L=T+"_"+M,N=parseFloat(t.substr(30,8)),U=parseFloat(t.substr(38,8)),q=parseFloat(t.substr(46,8)),B=new THREE.Vector3(N,U,q),j={het:"H"===F[0],serial:n,name:h,alt:d,resn:I,structure:e,chain:T,resi:M,coord:B,b:parseFloat(t.substr(60,8)),elem:c,bonds:[],ss:"coil",ssbegin:!1,ssend:!1};if(j.het||"C"!==j.name||(f=n),j.het||"O"!==j.name||(y=n),!j.het&&"N"===j.name&&void 0!==b&&void 0!==v){let e=r.atoms[b].coord.distanceTo(r.atoms[v].coord),t=j.coord.x+(r.atoms[b].coord.x-r.atoms[v].coord.x)/e,s=j.coord.y+(r.atoms[b].coord.y-r.atoms[v].coord.y)/e,i=j.coord.z+(r.atoms[b].coord.z-r.atoms[v].coord.z)/e;j.hcoord=new THREE.Vector3(t,s,i)}r.atoms[n]=j,r.dAtoms[n]=1,r.hAtoms[n]=1,-1!==$.inArray(L,w)?(r.atoms[n].ss="sheet",-1!==$.inArray(L,S)&&(r.atoms[n].ssbegin=!0),-1!==$.inArray(L,_)&&(r.atoms[n].ssend=!0)):-1!==$.inArray(L,A)&&(r.atoms[n].ss="helix",-1!==$.inArray(L,x)&&(r.atoms[n].ssbegin=!0),-1!==$.inArray(L,k)&&(r.atoms[n].ssend=!0));let z="-";if(z="helix"===r.atoms[n].ss?"H":"sheet"===r.atoms[n].ss?"E":!r.atoms[n].het&&a.parasCls.residueColors.hasOwnProperty(r.atoms[n].resn.toUpperCase())?"c":"o",r.secondaries[C]=z,g!==R){let t=a.utilsCls.residueName2Abbr(I);if(r.residueId2Name[C]=t,1!==n&&(r.residues[H]=p),C!==H&&(p={}),u!==O){b=void 0,v=void 0,1!==n&&(void 0===r.chains[O]&&(r.chains[O]={}),r.chains[O]=a.hashUtilsCls.unionHash(r.chains[O],m)),m={},void 0===r.structures[e.toString()]&&(r.structures[e.toString()]=[]),r.structures[e.toString()].push(u),void 0===r.chainsSeq[u]&&(r.chainsSeq[u]=[]);let s={};s.resi=M,s.name=t,r.chainsSeq[u].push(s)}else{b=f,v=y;let e={};e.resi=M,e.name=t,r.chainsSeq[u].push(e)}}m[n]=1,p[n]=1,O=u,H=C,R=g}else if("CONECT"===F){let e=parseInt(t.substr(6,5));for(let s=0;s<4;++s){let i=parseInt(t.substr([11,16,21,26][s],5));isNaN(i)||void 0!==r.atoms[E[e]]&&r.atoms[E[e]].bonds.push(E[i])}}else"TER"===F.substr(0,3)&&++n}r.residues[C]=p,void 0===r.chains[u]&&(r.chains[u]={}),r.chains[u]=a.hashUtilsCls.unionHash2Atoms(r.chains[u],m,r.atoms),l||this.adjustSeq(I);let F=Object.keys(r.structures);for(let e=0,t=F.length;e<t;++e){let t=F[e];if(t!=D&&(void 0===r.ssbondpnts[t]&&(r.ssbondpnts[t]=[]),void 0!==r.ssbondpnts[D]))for(let e=0,s=r.ssbondpnts[D].length;e<s;++e){let s=r.ssbondpnts[D][e],i=s.indexOf("_"),l=t+s.substr(i);r.ssbondpnts[t].push(l)}}if(!r.bSsbondProvided){let e={};for(let t in r.chainsSeq){let s=r.chainsSeq[t],i=t.substr(0,t.indexOf("_"));for(let l=0,n=s.length;l<n;++l)"C"==s[l].name&&(null==e[i]&&(e[i]=[]),e[i].push(t+"_"+s[l].resi))}this.setSsbond(e)}h=null;let M,L,N=[],U=function(e){let t=N.length;for(let s=0;s<t;++s){let i=N[s];for(let e=s+1;e<t;++e){let t=N[e];i.alt===t.alt&&a.utilsCls.hasCovalentBond(i,t)&&(i.bonds.push(t.serial),t.bonds.push(i.serial))}e&&e(i)}},q=new THREE.Vector3(9999,9999,9999),B=new THREE.Vector3(-9999,-9999,-9999),j=new THREE.Vector3,z=0,G={};for(let e in r.atoms){let t=r.atoms[e],s=t.coord;j.add(s),q.min(s),B.max(s),++z,t.het?t.het&&("HOH"===t.resn||"WAT"===t.resn||"SOL"===t.resn?r.water[t.serial]=1:-1!==$.inArray(t.resn,a.parasCls.ionsArray)||t.elem.trim()===t.resn.trim()?r.ions[t.serial]=1:r.chemicals[t.serial]=1,t.color=a.parasCls.atomColors[t.elem]):-1!==$.inArray(t.resn,a.parasCls.nucleotidesArray)?(r.nucleotides[t.serial]=1,"O3'"!==t.name&&"O3*"!==t.name||(r.nucleotidesO3[t.serial]=1,r.secondaries[t.structure+"_"+t.chain+"_"+t.resi]="o")):("P"===t.elem&&(G[t.structure+"_"+t.chain+"_"+t.resi]=1),r.proteins[t.serial]=1,"CA"===t.name&&(r.calphas[t.serial]=1),"N"!==t.name&&"CA"!==t.name&&"C"!==t.name&&"O"!==t.name&&(r.sidec[t.serial]=1)),M===t.chain&&L===t.resi||(U((function(e){("C"===e.name&&"N"===t.name||"O3'"===e.name&&"P"===t.name)&&a.utilsCls.hasCovalentBond(e,t)&&(e.bonds.push(t.serial),t.bonds.push(e.serial))})),M=t.chain,L=t.resi,N.length=0),N.push(t)}for(resid in G){let e=r.residues[resid];for(n in e){let e=r.atoms[n];e.het=!0,r.chemicals[e.serial]=1,r.secondaries[resid]="o",delete r.proteins[e.serial],"CA"===e.name&&delete r.calphas[e.serial],"N"!==e.name&&"CA"!==e.name&&"C"!==e.name&&"O"!==e.name&&delete r.sidec[e.serial]}}if(U(),r.pmin=q,r.pmax=B,r.cnt=z,r.maxD=r.pmax.distanceTo(r.pmin),r.center=j.multiplyScalar(1/r.cnt),r.maxD<5&&(r.maxD=5),r.oriMaxD=r.maxD,r.oriCenter=r.center.clone(),i)return this.getChainCalpha(r.chains,r.atoms)}adjustSeq(e){let t=this.icn3d;t.icn3dui;for(let s in t.chainsSeq){if(void 0===e[s])continue;let i,l,n,o=t.chainsSeq[s],r=e[s],a=o.length,d=r.length,c=new Array(a+d);for(i=0,l=0,n=0;i<a&&l<d;)o[i].resi<=r[l].resi?(c[n]=o[i],i++):(c[n]=r[l],l++),n++;if(i<a)for(let e=i;e<a;e++)c[n]=o[e],n++;else for(let e=l;e<d;e++)c[n]=r[e],n++;t.chainsSeq[s]=c}}setSsbond(e){let t=this.icn3d;t.icn3dui;for(let s in e){let i=e[s];for(let e=0,l=i.length;e<l;++e)for(let l=e+1,n=i.length;l<n;++l){let n,o,r=i[e],a=i[l];for(let e in t.residues[r])if("S"==t.atoms[e].elem){n=t.atoms[e].coord;break}for(let e in t.residues[a])if("S"==t.atoms[e].elem){o=t.atoms[e].coord;break}void 0!==n&&void 0!==o&&(Math.abs(n.x-o.x)>4||Math.abs(n.y-o.y)>4||Math.abs(n.z-o.z)>4||(n.x-o.x)*(n.x-o.x)+(n.y-o.y)*(n.y-o.y)+(n.z-o.z)*(n.z-o.z)<16&&(void 0===t.ssbondpnts[s]&&(t.ssbondpnts[s]=[]),t.ssbondpnts[s].push(r),t.ssbondpnts[s].push(a)))}}}getChainCalpha(e,t,s,i){let l=this.icn3d,n=l.icn3dui,o={};for(let r in e){if(void 0!==i){if(r.split("_")[0]!==i)continue}let a=Object.keys(e[r]),d=[],c=0,h=0;for(let e=0,i=a.length;e<i;++e){let i=t[a[e]];if(l.proteins.hasOwnProperty(a[e])&&"CA"==i.name||l.nucleotides.hasOwnProperty(a[e])&&("O3'"==i.name||"O3*"==i.name)){if(i.resi==h)continue;let e=i.resn.trim().length>3?i.resn.trim().substr(0,3):i.resn.trim();if(!n.parasCls.chargeColors.hasOwnProperty(e))continue;s?i.resi_ori:i.resi,d.push(i.coord.clone()),++c,h=i.resi}}if(c>0){o[t[a[0]].chain]=d}}return{chainresiCalphaHash:o,center:l.center.clone()}}}class J{constructor(e){this.icn3d=e}loadAtomDataIn(e,t,s,i,l,n,o,r){let a=this.icn3d,d=a.icn3dui;a.pmin=new THREE.Vector3(9999,9999,9999),a.pmax=new THREE.Vector3(-9999,-9999,-9999),a.psum=new THREE.Vector3;let c=e.atoms,h=void 0===l||"target"===l?0:a.lastTargetSerial,m={};void 0===l||"target"===l?(a.pmid=e.pubmedId,a.chainid2title={},a.chainid2sid={}):a.pmid2=e.pubmedId;let p={},u={};if("align"===s){a.pmid="";let t=a.icn3dui.cfg.inpara&&-1!==a.icn3dui.cfg.inpara.indexOf("atype=1")?"Invariant Core ":"";a.molTitle=t+"Structure Alignment of ";for(let t=0,s=e.alignedStructures[0].length;t<s;++t){let s=e.alignedStructures[0][t];1===t&&(a.secondId=s.pdbId);let i=s.pdbId;s.mmdbId;for(let e=s.serialInterval[0],t=s.serialInterval[1];e<=t;++e)m[e]=i.toString();for(let e=0,t=s.molecules.length;e<t;++e){let t=s.molecules[e].chain,l=s.molecules[e].kind,n=s.molecules[e].name,o=s.molecules[e].sid,r=i+"_"+t;p[r]=l,a.chainid2title[r]=n,void 0!==o&&(a.chainid2sid[r]=o)}a.molTitle+='<a href="'+a.icn3dui.htmlCls.baseUrl+"mmdb/mmdbsrv.cgi?uid="+s.pdbId.toUpperCase()+'" target="_blank">'+s.pdbId.toUpperCase()+"</a>",void 0!==s.descr&&(a.pmid+=s.descr.pubmedid),0===t&&(a.molTitle+=" and ",void 0!==s.descr&&(a.pmid+="_"))}a.molTitle+=" from VAST+"}else if(void 0!==e.descr&&(a.molTitle+=e.descr.name),"mmdbid"===s){let t=e.pdbId,s={};"target"==l&&(a.alignmolid2color=[]);let i=1;for(let n in e.moleculeInfor){if(0===Object.keys(e.moleculeInfor[n]).length)continue;let o=e.moleculeInfor[n].chain.trim(),r=t+"_"+o;s.hasOwnProperty(o)?(++s[o],r+=s[o]):s[o]=1,void 0!==a.mmdbid_q&&a.mmdbid_q===a.mmdbid_t&&"query"===l&&(r=t+a.icn3dui.htmlCls.postfix+"_"+o);let d=e.moleculeInfor[n].kind,c=e.moleculeInfor[n].color,h=e.moleculeInfor[n].sid;if(p[r]=d,u[r]=c,"protein"==d&&(a.organism=e.moleculeInfor[n].taxonomyName.toLowerCase()),void 0!==h&&(a.chainid2sid[r]=h),void 0===a.pdbid_chain2title&&(a.pdbid_chain2title={}),a.pdbid_chain2title[r]=e.moleculeInfor[n].name,o==r.substr(r.lastIndexOf("_"))){let e={};e[n]=i.toString(),a.alignmolid2color.push(e)}++i}}let C,g,f,b,y,v={},w="",S="",_="",A="",x="",k="",O=0,H=0,R="",E=!0,I=!1,D="",T=d.utilsCls.isCalphaPhosOnly(c),P=0,F={};for(let e in c){++h,v[e]=h;let i,n=c[e];n.serial=h,"mmdbid"===s||"mmcifid"===s?i=t:"align"===s&&(i=m[h]);let r=!1;if(void 0!==n.chain||"mmdbid"!==s&&"align"!==s)n.chain=""===n.chain?"Misc":n.chain;else if("mmdbid"===s)if(C=n.ids.m,void 0!==a.molid2chain[C]){let e=a.molid2chain[C].indexOf("_");n.chain=a.molid2chain[C].substr(e+1)}else{let e="Misc";("protein"===p[x]&&"nucleotide"===p[x]&&n.resi!=H||"protein"!==p[x]&&"nucleotide"!==p[x]&&(n.resn.substr(0,3)!=R.substr(0,3)||n.resi!=H||"solvent"===p[x]||"HOH"===n.resn))&&++P,n.resi_ori=n.resi,n.resi=P,r=!0,n.chain=e}else if("align"===s)if(C=n.ids.m,void 0!==a.pdbid_molid2chain[i+"_"+C])n.chain=a.pdbid_molid2chain[i+"_"+C];else{let e="Misc";("protein"===p[x]&&"nucleotide"===p[x]&&n.resi!=H||"protein"!==p[x]&&"nucleotide"!==p[x]&&(n.resn.substr(0,3)!=R.substr(0,3)||n.resi!=H||"solvent"===p[x]||"HOH"===n.resn))&&(++P,n.resi_ori=n.resi,n.resi=P,r=!0),n.chain=e}if(n.chain=n.chain.trim(),"mmdbid"!==s&&"align"!==s||(n.structure=i,"mmdbid"===s&&void 0!==a.mmdbid_q&&a.mmdbid_q===a.mmdbid_t&&"query"===l&&(n.structure+=a.icn3dui.htmlCls.postfix)),A=n.structure,x=A+"_"+n.chain,"mmdbid"===s||"align"===s){r||(n.resi_ori=n.resi,a.bUsePdbNum?(n.resi=n.resi_ori,a.chainid2offset[x]||(a.chainid2offset[x]=n.resi_ori-n.ids.r)):n.resi=n.ids.r);let e=n.resn.indexOf(" ");-1!==e&&0!=e&&(n.resn=n.resn.substr(0,e))}if(x!==S&&(O=0),n.resi!==O&&(x!==S?(f=void 0,y=void 0):(f=g,y=b)),"mmdbid"===s){if(n.coord=new THREE.Vector3(n.coord[0],n.coord[1],n.coord[2]),void 0!==a.q_rotation&&a.t_trans_add.length>0&&!a.icn3dui.cfg.resnum&&!a.icn3dui.cfg.resdef)if("target"===l)n.coord.x+=a.t_trans_add[o].x,n.coord.y+=a.t_trans_add[o].y,n.coord.z+=a.t_trans_add[o].z;else if("query"===l){n.coord.x-=a.q_trans_sub[o].x,n.coord.y-=a.q_trans_sub[o].y,n.coord.z-=a.q_trans_sub[o].z;let e=n.coord.x*a.q_rotation[o].x1+n.coord.y*a.q_rotation[o].y1+n.coord.z*a.q_rotation[o].z1,t=n.coord.x*a.q_rotation[o].x2+n.coord.y*a.q_rotation[o].y2+n.coord.z*a.q_rotation[o].z2,s=n.coord.x*a.q_rotation[o].x3+n.coord.y*a.q_rotation[o].y3+n.coord.z*a.q_rotation[o].z3;n.coord.x=e,n.coord.y=t,n.coord.z=s}}else n.coord=new THREE.Vector3(n.coord.x,n.coord.y,n.coord.z);let M=d.utilsCls.residueName2Abbr(n.resn.substr(0,3));"mmdbid"!==s&&"align"!==s||!a.bFullUi||(void 0===a.mmdbMolidResid2mmdbChainResi&&(a.mmdbMolidResid2mmdbChainResi={}),a.mmdbMolidResid2mmdbChainResi[i+"_"+n.ids.m+"_"+n.ids.r]=i+"_"+n.chain+"_"+n.resi),a.pmin.min(n.coord),a.pmax.max(n.coord),a.psum.add(n.coord);let L=void 0===a.icn3dui.cfg.mmcifid&&"mmcif"!=a.InputfileType?"protein"===p[x]:"p"===n.mt,N=void 0===a.icn3dui.cfg.mmcifid&&"mmcif"!=a.InputfileType?"nucleotide"===p[x]:"n"===n.mt,$=void 0===a.icn3dui.cfg.mmcifid&&"mmcif"!=a.InputfileType?"solvent"===p[x]:"s"===n.mt,U=void 0===a.icn3dui.cfg.mmcifid&&"mmcif"!=a.InputfileType?"ligand"===p[x]||void 0!==p[x]&&-1!==p[x].indexOf("other")||void 0===p[x]:"l"===n.mt;if("Misc"!==n.chain&&"other"!==p[x]||"protein"===F[x]||"nucleotide"===F[x]||("CA"===n.name&&"C"===n.elem?F[x]="protein":"P"===n.name&&"P"===n.elem?F[x]="nucleotide":F[x]="chemical"),L||N?(L?(a.proteins[h]=1,"CA"===n.name&&(a.calphas[h]=1),"N"!==n.name&&"CA"!==n.name&&"C"!==n.name&&"O"!==n.name&&(a.sidec[h]=1)):N&&(a.nucleotides[h]=1,("O3'"==n.name||"O3*"==n.name||T&&"P"==n.name)&&(a.nucleotidesO3[h]=1)),n.het=!1):$?(a.water[h]=1,n.het=!0):U&&("HOH"===n.resn||"O"===n.resn?a.water[h]=1:n.elem===n.resn?a.ions[h]=1:a.chemicals[h]=1,n.het=!0),"mmdbid"===s?n.het?n.color=d.parasCls.atomColors[n.elem]||d.parasCls.defaultAtomColor:n.color=void 0!==u[x]?d.parasCls.thr(u[x]):d.parasCls.chargeColors[n.resn]:void 0!==n.color&&(n.color=d.parasCls.thr(n.color))," "!==n.resn.charAt(0)&&" "===n.resn.charAt(1)&&(n.resn=n.resn.charAt(0)),n.het||"C"!==n.name||(g=h),n.het||"O"!==n.name||(b=h),!n.het&&"N"===n.name&&void 0!==f&&void 0!==y){let e=a.atoms[f].coord.distanceTo(a.atoms[y].coord),t=n.coord.x+(a.atoms[f].coord.x-a.atoms[y].coord.x)/e,s=n.coord.y+(a.atoms[f].coord.y-a.atoms[y].coord.y)/e,i=n.coord.z+(a.atoms[f].coord.z-a.atoms[y].coord.z)/e;n.hcoord=new THREE.Vector3(t,s,i)}"HOH"==n.resn&&(a.water[h]=1),a.atoms[h]=n,a.dAtoms[h]=1,a.hAtoms[h]=1;let q=n.structure+"_"+n.chain;void 0===a.chains[q]&&(a.chains[q]={}),a.chains[q][h]=1;let B=q+"_"+n.resi;void 0===a.residues[B]&&(a.residues[B]={}),a.residues[B][h]=1,k=x+"_"+n.resi,k!==_&&x!==S&&(E=!0,""!==w&&(void 0===a.structures[w]&&(a.structures[w]=[]),a.structures[w].push(S))),a.residueId2Name[B]=M;let j="-";if("helix"===n.ss?j="H":"sheet"===n.ss?j="E":n.het||N?j="o":(!n.het&&d.parasCls.residueColors.hasOwnProperty(n.resn.toUpperCase())||"coil"===n.ss)&&(j="c"),a.secondaries[n.structure+"_"+n.chain+"_"+n.resi]=j,(n.resi!=O||C!=D)&&a.bFullUi&&(void 0===a.chainsSeq[q]&&(a.chainsSeq[q]=[],E=!1),!isNaN(n.resi)))if(E&&!I&&void 0!==a.chainsSeq[q][n.resi-1])a.chainsSeq[q][n.resi-1].name=M;else if(!E||!a.chainsSeq[q].hasOwnProperty(n.resi-1)){let e={};e.resi=n.resi,e.name=M,n.resi%10==0&&n.resi.toString(),a.chainsSeq[q].push(e),I=!0}O=n.resi,H=n.resi_ori,R=n.resn,w=A,S=x,_=k,D=C}a.lastTargetSerial=h;for(let e in F)if(!(Object.keys(a.chains[e]).length<10)&&"chemical"!==F[e])for(let t in a.chains[e]){let s=a.atoms[t];delete a.chemicals[t],s.het=!1,"protein"===F[e]?(a.proteins[t]=1,"CA"===s.name&&(a.calphas[t]=1),"N"!==s.name&&"CA"!==s.name&&"C"!==s.name&&"O"!==s.name&&(a.sidec[t]=1)):"nucleotide"===F[e]&&(a.nucleotides[t]=1,("O3'"==s.name||"O3*"==s.name||T&&"P"==s.name)&&(a.nucleotidesO3[t]=1))}if(void 0===a.structures[A]&&(a.structures[A]=[]),a.structures[A].push(x),a.bFullUi)if("mmdbid"===s||"mmcifid"===s)for(let i in e.sequences){let n=e.sequences[i],o=t+"_"+i;void 0!==a.mmdbid_q&&a.mmdbid_q===a.mmdbid_t&&"query"===l&&(o=t+a.icn3dui.htmlCls.postfix+"_"+i),a.ParserUtilsCls.getMissingResidues(n,s,o)}else if("align"===s)for(let e in a.chainid2seq){let t=a.chainid2seq[e];a.ParserUtilsCls.getMissingResidues(t,s,e)}if("mmcifid"!==s)for(let e in c){let t=v[e],s=void 0===a.atoms[t].bonds?0:a.atoms[t].bonds.length;for(let e=0;e<s;++e)a.atoms[t].bonds[e]=v[a.atoms[t].bonds[e]]}if(e.atoms={},a.cnt=h,(a.cnt>a.maxatomcnt||void 0!==a.biomtMatrices&&a.biomtMatrices.length*a.cnt>10*a.maxatomcnt)&&(a.opts.proteins="c alpha trace",a.opts.nucleotides="o3 trace"),a.maxD=a.pmax.distanceTo(a.pmin),a.center=a.psum.multiplyScalar(1/a.cnt),a.maxD<5&&(a.maxD=5),a.oriMaxD=a.maxD,"mmdbid"===s){let t=e.disulfides;if(void 0!==t)for(let e=0,s=t.length;e<s;++e){let s=t[e][0].ca,i=t[e][1].ca,l=a.atoms[s],n=a.atoms[i],o=l.chain,r=n.chain,d=l.structure+"_"+o+"_"+l.resi,c=n.structure+"_"+r+"_"+n.resi;void 0===a.ssbondpnts[l.structure]&&(a.ssbondpnts[l.structure]=[]),a.ssbondpnts[l.structure].push(d),a.ssbondpnts[l.structure].push(c)}}else if("mmcifid"===s){let s=e.disulfides;if(void 0!==s){void 0===a.ssbondpnts[t]&&(a.ssbondpnts[t]=[]);for(let e=0,i=s.length;e<i;++e){let i=s[e][0],l=s[e][1];a.ssbondpnts[t].push(i),a.ssbondpnts[t].push(l)}let e=Object.keys(a.structures);for(let s=0,i=e.length;s<i;++s){let i=e[s];if(i!=t){void 0===a.ssbondpnts[i]&&(a.ssbondpnts[i]=[]);for(let e=0,s=a.ssbondpnts[t].length;e<s;++e){let s=a.ssbondpnts[t][e],l=s.indexOf("_"),n=i+s.substr(l);a.ssbondpnts[i].push(n)}}}}}else if("align"===s){let e={};for(let t in a.chainid2seq)if("protein"==p[t]){let s=a.chainid2seq[t],i=t.substr(0,t.indexOf("_"));for(let l=0,n=s.length;l<n;++l)"C"==s[l][1]&&(null==e[i]&&(e[i]=[]),e[i].push(t+"_"+s[l][0]))}a.loadPDBCls.setSsbond(e)}("mmcifid"===s||"mmdbid"===s&&void 0===l)&&a.ParserUtilsCls.transformToOpmOri(t);let M={};if("align"===s&&void 0!==i&&a.bFullUi)a.setSeqAlignCls.setSeqAlign(i,e.alignedStructures);else if("mmdbid"===s&&"query"===l&&a.bFullUi&&void 0!==a.q_rotation&&!a.icn3dui.cfg.resnum&&!a.icn3dui.cfg.resdef){a.setSeqAlignCls.setSeqAlignChain(n,o);let e=!1,t=a.icn3dui.htmlCls.alignSeqCls.getAlignSequencesAnnotations(Object.keys(a.alnChains),void 0,void 0,!1,void 0,e),s=$("#"+a.pre+"dl_sequence2").html();M=a.hAtoms,$("#"+a.pre+"dl_sequence2").html(s+t.sequencesHtml),$("#"+a.pre+"dl_sequence2").width(a.icn3dui.htmlCls.RESIDUE_WIDTH*t.maxSeqCnt+200)}if("mmdbid"===s&&("target"===l||"query"===l)&&void 0===a.q_rotation){if("target"===l||"query"===l)for(let e in c){let t=c[e];t.coord.x-=a.center.x,t.coord.y-=a.center.y,t.coord.z-=a.center.z}"target"===l?(a.oriMaxD=a.maxD,a.center1=a.center):"query"===l&&(a.oriMaxD<a.maxD&&(a.oriMaxD=a.maxD),a.center2=a.center,a.center=new THREE.Vector3(0,0,0))}return a.oriCenter=a.center.clone(),a.saveFileCls.showTitle(),e={},M}}class K{constructor(e){this.icn3d=e}downloadCid(e){let t=this.icn3d;t.icn3dui;let s=this,i="https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/cid/"+e+"/record/SDF/?record_type=3d&response_type=display";t.ParserUtilsCls.setYourNote("PubChem CID "+e+" in iCn3D"),t.bCid=!0,$.ajax({url:i,dataType:"text",cache:!0,tryCount:0,retryLimit:1,beforeSend:function(){t.ParserUtilsCls.showLoading()},complete:function(){},success:function(i){let l=s.loadSdfAtomData(i,e);void 0===t.icn3dui.cfg.align&&1==Object.keys(t.structures).length&&$("#"+t.pre+"alternateWrapper").hide(),l?(t.setStyleCls.setAtomStyleByOptions(t.opts),t.setColorCls.setColorByOptions(t.opts,t.atoms),t.ParserUtilsCls.renderStructure(),void 0!==t.icn3dui.cfg.rotate&&t.resizeCanvasCls.rotStruc(t.icn3dui.cfg.rotate,!0)):alert("The SDF of CID "+e+" has the wrong format...")},error:function(e,t,s){this.tryCount++,this.tryCount<=this.retryLimit&&$.ajax(this)}}).fail((function(){alert("This CID may not have 3D structure...")}))}loadSdfData(e){let t=this.icn3d;t.icn3dui;let s=this.loadSdfAtomData(e);void 0===t.icn3dui.cfg.align&&1==Object.keys(t.structures).length&&$("#"+t.pre+"alternateWrapper").hide(),s?(t.setStyleCls.setAtomStyleByOptions(t.opts),t.setColorCls.setColorByOptions(t.opts,t.atoms),t.ParserUtilsCls.renderStructure(),void 0!==t.icn3dui.cfg.rotate&&t.resizeCanvasCls.rotStruc(t.icn3dui.cfg.rotate,!0)):alert("The SDF file has the wrong format...")}loadSdfAtomData(e,t){let s=this.icn3d;s.icn3dui;let i=e.split(/\r?\n|\r/);if(i.length<4)return!1;s.init();let l=t||1,n="LIG",o=l,r=l+"_A",a=r+"_1",d=parseInt(i[3].substr(0,3));if(isNaN(d)||d<=0)return!1;let c=parseInt(i[3].substr(3,3)),h=4;if(i.length<h+d+c)return!1;let m,p,u=d,C={},g={},f={},b=1;for(m=0;m<u;m++){p=i[h],h++;let e=p.substr(31,3).trim(),t=parseFloat(p.substr(0,10)),o=parseFloat(p.substr(10,10)),r=parseFloat(p.substr(20,10)),a={het:!0,serial:b,name:e,resn:n,structure:l,chain:"A",resi:1,coord:new THREE.Vector3(t,o,r),b:0,elem:e,bonds:[],ss:"coil",ssbegin:!1,ssend:!1,bondOrder:[]};s.atoms[b]=a,f[b]=1,C[m]=b,++b,"H"==e&&(g[m]=1)}s.dAtoms=f,s.hAtoms=f,s.structures[o]=[r],s.chains[r]=f,s.residues[a]=f,s.residueId2Name[a]=n,void 0===s.chainsSeq[r]&&(s.chainsSeq[r]=[]);let y={resi:1};for(y.name=n,s.chainsSeq[r].push(y),m=0;m<c;m++){p=i[h],h++;let e=parseInt(p.substr(0,3))-1+0,t=parseInt(p.substr(3,3))-1+0,l=p.substr(6,3).trim(),n=C[e],o=C[t];s.atoms[n].bonds.push(o),s.atoms[n].bondOrder.push(l),s.atoms[o].bonds.push(n),s.atoms[o].bondOrder.push(l),g.hasOwnProperty(e)||g.hasOwnProperty(t)||("2"==l?(s.doublebonds[n+"_"+o]=1,s.doublebonds[o+"_"+n]=1):"3"==l&&(s.triplebonds[n+"_"+o]=1,s.triplebonds[o+"_"+n]=1))}let v=!1;for(let e=i.length;h<e;++h)if(-1!=i[h].indexOf("PARTIAL_CHARGES")){v=!0;break}if(v){++h;let e=parseInt(i[h]);for(++h,m=0;m<e;++m,++h){p=i[h];let e=p.split(" "),t=parseInt(e[0]),l=parseFloat(e[1]);s.atoms[t].crg=l}}for(m in s.atoms)"H"!==s.atoms[m].name&&(s.atoms[m].bonds2=s.atoms[m].bonds.concat(),s.atoms[m].bondOrder2=s.atoms[m].bondOrder.concat());return s.ParserUtilsCls.setMaxD(),s.saveFileCls.showTitle(),!0}}class Q{constructor(e){this.icn3d=e}loadXyzData(e){let t=this.icn3d;t.icn3dui;let s=this.loadXyzAtomData(e);void 0===t.icn3dui.cfg.align&&1==Object.keys(t.structures).length&&$("#"+t.pre+"alternateWrapper").hide(),s?(t.setStyleCls.setAtomStyleByOptions(t.opts),t.setColorCls.setColorByOptions(t.opts,t.atoms),t.ParserUtilsCls.renderStructure(),void 0!==t.icn3dui.cfg.rotate&&t.resizeCanvasCls.rotStruc(t.icn3dui.cfg.rotate,!0)):alert("The XYZ file has the wrong format...")}setXyzAtomSeq(e,t,s,i){let l=this.icn3d,n=l.icn3dui;l.dAtoms=n.hashUtilsCls.unionHash(l.dAtoms,e),l.hAtoms=n.hashUtilsCls.unionHash(l.hAtoms,e),l.structures[t]=[s],l.chains[s]=e,l.residues[i]=e,l.residueId2Name[i]="LIG",void 0===l.chainsSeq[s]&&(l.chainsSeq[s]=[]);let o={resi:1,name:"LIG"};l.chainsSeq[s].push(o);let r=Object.keys(e);for(let e=0,t=r.length;e<t;++e){let t=l.atoms[r[e]];for(let s=e+1,i=r.length;s<i;++s){let i=l.atoms[r[s]],o=1.2*(n.parasCls.covalentRadii[t.elem.toUpperCase()]+n.parasCls.covalentRadii[i.elem.toUpperCase()]);Math.abs(t.coord.x-i.coord.x)>o||(Math.abs(t.coord.y-i.coord.y)>o||Math.abs(t.coord.z-i.coord.z)>o||n.utilsCls.hasCovalentBond(t,i)&&(l.atoms[r[e]].bonds.push(r[s]),l.atoms[r[s]].bonds.push(r[e])))}}}loadXyzAtomData(e){let t=this.icn3d;t.icn3dui;let s=e.split(/\r?\n|\r/);if(s.length<3)return!1;t.init();let i,l,n,o={},r=0,a=1;t.molTitle="";for(let e=0,d=s.length;e<d;++e){let d=s[e].trim();if(""===d)continue;if(""===d||isNaN(d)||(0!==e&&this.setXyzAtomSeq(o,r,i,l),++r,o={},n=r,i=n+"_A",l=i+"_1",r>1&&(t.molTitle+="; "),t.molTitle+=s[e+1].trim(),e+=2),d=s[e].trim(),""===d)continue;let c=d.replace(/,/," ").replace(/\s+/g," ").split(" "),h=c[0],m=parseFloat(c[1]),p=parseFloat(c[2]),u=parseFloat(c[3]),C={het:!0,serial:a,name:h,resn:"LIG",structure:n,chain:"A",resi:1,coord:new THREE.Vector3(m,p,u),b:0,elem:h,bonds:[],ss:"coil",ssbegin:!1,ssend:!1,bondOrder:[]};t.atoms[a]=C,o[a]=1,++a}return this.setXyzAtomSeq(o,r,i,l),t.ParserUtilsCls.setMaxD(),t.saveFileCls.showTitle(),!0}}class Z{constructor(e){this.icn3d=e}loadMol2Data(e){let t=this.icn3d;t.icn3dui;let s=this.loadMol2AtomData(e);void 0===t.icn3dui.cfg.align&&1==Object.keys(t.structures).length&&$("#"+t.pre+"alternateWrapper").hide(),s?(t.setStyleCls.setAtomStyleByOptions(t.opts),t.setColorCls.setColorByOptions(t.opts,t.atoms),t.ParserUtilsCls.renderStructure(),void 0!==t.icn3dui.cfg.rotate&&t.resizeCanvasCls.rotStruc(t.icn3dui.cfg.rotate,!0)):alert("The Mol2 file has the wrong format...")}loadMol2AtomData(e){let t=this.icn3d;t.icn3dui;let s=e.split(/\r?\n|\r/);if(s.length<4)return!1;t.init();let i,l,n="LIG",o={},r="1_A",a=0,d=0,c=1,h=!1,m=!1,p={},u={};for(let e=0,r=s.length;e<r;++e){let r=s[e].trim();if(""!==r&&"#"!==r.substr(0,1)){if("@<TRIPOS>MOLECULE"==r){t.molTitle=s[e+1].trim();let n=s[e+2].trim().replace(/\s+/g," ").split(" ");i=n[0],l=n[1],e+=4}else"@<TRIPOS>ATOM"==r?(c=1,h=!0,++e):"@<TRIPOS>BOND"==r?(m=!0,h=!1,++e):"@<TRIPOS>SUBSTRUCTURE"==r&&(m=!1,++e);if(r=s[e].trim(),""!==r&&"#"!==r.substr(0,1)){if(h&&a<i){let e=r.replace(/\s+/g," ").split(" "),s=parseInt(e[0]);p[s]=c;let i,l=e[1],d=parseFloat(e[2]),h=parseFloat(e[3]),m=parseFloat(e[4]),C=new THREE.Vector3(d,h,m),g=e[5],f=g.indexOf(".");if(i=-1===f?g:g.substr(0,f),"H"===i&&i===g)u[s]=1;else{let e={het:!0,serial:c,name:l,resn:n,structure:1,chain:"A",resi:1,coord:C,b:0,elem:i,bonds:[],ss:"coil",ssbegin:!1,ssend:!1,bondOrder:[]};t.atoms[c]=e,o[c]=1,++c}++a}if(m&&d<l){let e=r.replace(/\s+/g," ").split(" "),s=parseInt(e[1]),i=parseInt(e[2]),l=e[3],n=l;if("am"===l&&(n="1"),"ar"===l&&(n="1.5"),!(u.hasOwnProperty(s)||u.hasOwnProperty(i)||"1"!==n&&"2"!==n&&"3"!==n&&"1.5"!==n)){let e=n,l=p[s],o=p[i];t.atoms[l].bonds.push(o),t.atoms[l].bondOrder.push(e),t.atoms[o].bonds.push(l),t.atoms[o].bondOrder.push(e),"2"==e?(t.doublebonds[l+"_"+o]=1,t.doublebonds[o+"_"+l]=1):"3"==e?(t.triplebonds[l+"_"+o]=1,t.triplebonds[o+"_"+l]=1):"1.5"==e&&(t.aromaticbonds[l+"_"+o]=1,t.aromaticbonds[o+"_"+l]=1)}++d}}}}t.dAtoms=o,t.hAtoms=o,t.structures[1]=[r],t.chains["1_A"]=o,t.residues["1_A_1"]=o,t.residueId2Name["1_A_1"]=n,void 0===t.chainsSeq["1_A"]&&(t.chainsSeq["1_A"]=[]);let C={resi:1};return C.name=n,t.chainsSeq["1_A"].push(C),t.ParserUtilsCls.setMaxD(),t.saveFileCls.showTitle(),!0}}class ee{constructor(e){this.icn3d=e}applyDssp(e){let t=this.icn3d,s=t.icn3dui,i=this,l=e?"1":"0",n=Object.keys(t.structures),o=[],r=t.icn3dui.htmlCls.baseUrl+"mmcifparser/mmcifparser.cgi";for(let e=0,i=n.length;e<i;++e){let i="";i+=t.saveFileCls.getPDBHeader(e);let a={},d=t.structures[n[e]];for(let e=0,i=d.length;e<i;++e)a=s.hashUtilsCls.unionHash(a,t.chains[d[e]]);i+=t.saveFileCls.getAtomPDB(a,void 0,!0);let c=$.ajax({url:r,type:"POST",data:{dssp:"t",calphaonly:l,pdbfile:i},dataType:"jsonp",cache:!0});o.push(c)}$.when.apply(void 0,o).then((function(){let e=1==n.length?[arguments]:Array.from(arguments);i.parseDsspData(e,n)})).fail((function(){t.pdbParserCls.loadPdbDataRender(),void 0!==t.deferredSecondary&&t.deferredSecondary.resolve()}))}parseDsspData(e,t){let s=this.icn3d;s.icn3dui;for(let i=0,l=e.length;i<l;++i){let l=e[i][0];if(void 0!==l&&-1===JSON.stringify(l).indexOf("Oops there was a problem"))for(let e in s.chainsSeq){let n=e.indexOf("_");if(e.substr(0,n)!=t[i])continue;let o,r=e.substr(n+1),a=s.chainsSeq[e],d="coil";for(let t=0,i=a.length;t<i;++t){let i,n=a[t].resi,c=r+"_"+n,h="c";l.hasOwnProperty(c)?h=l[c]:l.hasOwnProperty(" _"+n)?h=l[" _"+n]:l.hasOwnProperty("_"+n)&&(h=l["_"+n]),i="H"===h?"helix":"E"===h?"sheet":"coil";let m=e+"_"+n;s.secondaries[m]=h;let p,u,C=0;if(i!==d?"coil"===d?(p=!0,u=!1):"coil"===i?(C=2,p=!1,u=!1):("sheet"===d&&"helix"===i||"helix"===d&&"sheet"===i)&&(C=2,p=!0,u=!1):(p=!1,u=!1),1==C){let t=e+"_"+o;for(let e in s.residues[t])s.atoms[e].ssbegin=!0,s.atoms[e].ssend=!1}else if(2==C){let t=e+"_"+o;for(let e in s.residues[t])s.atoms[e].ssbegin=!1,s.atoms[e].ssend=!0}for(let e in s.residues[m])s.atoms[e].ss=i,s.atoms[e].ssbegin=p,s.atoms[e].ssend=u;d=i,o=n}}else console.log("DSSP calculation had a problem with this structure "+t[i]+"...")}s.pdbParserCls.loadPdbDataRender(),void 0!==s.deferredSecondary&&s.deferredSecondary.resolve()}}class te{constructor(e){this.icn3d=e}downloadPdb(e){let t,s,i=this.icn3d;i.icn3dui,t="https://files.rcsb.org/view/"+e+".pdb",s="text",i.bCid=void 0,i.ParserUtilsCls.setYourNote(e.toUpperCase()+"(PDB) in iCn3D"),$.ajax({url:t,dataType:"text",cache:!0,tryCount:0,retryLimit:1,beforeSend:function(){i.ParserUtilsCls.showLoading()},complete:function(){},success:function(t){return i.deferredOpm=$.Deferred((function(){i.opmParserCls.loadOpmData(t,e,void 0,"pdb")})),i.deferredOpm.promise()},error:function(e,t,s){this.tryCount++,this.tryCount<=this.retryLimit&&$.ajax(this)}})}downloadUrl(e,t){let s=this.icn3d,i=s.icn3dui,l=this;s.bCid=void 0,$.ajax({url:e,dataType:"text",cache:!0,tryCount:0,retryLimit:1,beforeSend:function(){s.ParserUtilsCls.showLoading()},complete:function(){},success:function(e){s.InputfileData=e,s.InputfileType=t,"pdb"===t?l.loadPdbData(e):"mol2"===t?s.mol2ParserCls.loadMol2Data(e):"sdf"===t?s.sdfParserCls.loadSdfData(e):"xyz"===t?s.xyzParserCls.loadXyzData(e):"mmcif"===t?s.mmcifParserCls.loadMmcifData(e):"icn3dpng"===t&&(s.mmcifParserCls.loadMmcifData(e),i.htmlCls.setHtmlCls.loadPng(e))},error:function(e,t,s){this.tryCount++,this.tryCount<=this.retryLimit&&$.ajax(this)}})}loadPdbData(e,t,s){let i=this.icn3d,l=i.icn3dui;if(i.loadPDBCls.loadPDB(e,t,s),void 0===i.icn3dui.cfg.opmid&&i.ParserUtilsCls.transformToOpmOri(t),void 0!==i.biomtMatrices&&i.biomtMatrices.length>1?($("#"+i.pre+"assemblyWrapper").show(),i.asuCnt=i.biomtMatrices.length):$("#"+i.pre+"assemblyWrapper").hide(),void 0!==i.emd?($("#"+i.pre+"mapWrapper1").hide(),$("#"+i.pre+"mapWrapper2").hide(),$("#"+i.pre+"mapWrapper3").hide()):($("#"+i.pre+"emmapWrapper1").hide(),$("#"+i.pre+"emmapWrapper2").hide(),$("#"+i.pre+"emmapWrapper3").hide()),!i.bSecondaryStructure&&Object.keys(i.proteins).length>0)return i.deferredSecondary=$.Deferred((function(){let e=l.utilsCls.isCalphaPhosOnly(l.hashUtilsCls.hash2Atoms(i.proteins,i.atoms));i.dsspCls.applyDssp(e)})),i.deferredSecondary.promise();this.loadPdbDataRender()}loadPdbDataRender(){let e=this.icn3d;e.icn3dui,e.pmid=e.pmid,void 0===e.icn3dui.cfg.align&&1==Object.keys(e.structures).length&&$("#"+e.pre+"alternateWrapper").hide(),e.setStyleCls.setAtomStyleByOptions(e.opts),e.setColorCls.setColorByOptions(e.opts,e.atoms),e.ParserUtilsCls.renderStructure(),e.saveFileCls.showTitle(),void 0!==e.icn3dui.cfg.rotate&&e.resizeCanvasCls.rotStruc(e.icn3dui.cfg.rotate,!0)}}class se{constructor(e){this.icn3d=e}downloadMmtf(e){let t=this.icn3d;t.icn3dui,t.ParserUtilsCls.setYourNote(e.toUpperCase()+"(MMTF) in iCn3D"),t.bCid=void 0,MMTF.fetchReduced(e,(function(s){if(10*s.numAtoms>t.maxatomcnt){let i=!1;return 0==Object.keys(s).length?void alert("This PDB structure is not found at RCSB..."):(t.deferredOpm=$.Deferred((function(){t.opmParserCls.loadOpmData(s,e,i,"mmtf")})),t.deferredOpm.promise())}s=null,MMTF.fetch(e,(function(s){if(0!=Object.keys(s).length)return t.deferredOpm=$.Deferred((function(){t.opmParserCls.loadOpmData(s,e,true,"mmtf")})),t.deferredOpm.promise();alert("This PDB structure is not found at RCSB...")}),(function(e){}))}),(function(e){}))}parseMmtfData(e,t,s){let i=this.icn3d,l=i.icn3dui;e.numAtoms,i.init();let n=new THREE.Vector3(9999,9999,9999),o=new THREE.Vector3(-9999,-9999,-9999),r=new THREE.Vector3,a=e.structureId;if(i.molTitle=e.title,void 0!==e.bioAssemblyList&&void 0!==e.bioAssemblyList[0]&&e.bioAssemblyList[0].transformList.length>1){i.biomtMatrices=[];for(let t=0,s=e.bioAssemblyList[0].transformList.length;t<s;++t){let s=(new THREE.Matrix4).fromArray(e.bioAssemblyList[0].transformList[t].matrix).transpose();i.biomtMatrices.push(s)}}void 0!==i.biomtMatrices&&i.biomtMatrices.length>1?($("#"+i.pre+"assemblyWrapper").show(),i.asuCnt=i.biomtMatrices.length):$("#"+i.pre+"assemblyWrapper").hide();let d,c,h,m,p,u,C,g,f,b,y,v,w,S,_,A,x,k,O,H={},R=[],E="coil",I="",D=0,T=0,P={onModel:function(e){d=0===e.modelIndex?a:a+(e.modelIndex+1).toString()},onChain:function(e){c=e.chainName;let t=d+"_"+c;void 0===i.structures[d]&&(i.structures[d]=[]),i.structures[d].push(t)},onGroup:function(e){h=e.groupName,m=e.groupId;let t=d+"_"+c+"_"+m;p=0===e.secStruct||2===e.secStruct||4===e.secStruct?"helix":3===e.secStruct?"sheet":-1===e.secStruct?"other":"coil";let s=!1;if(c!==I){if(x=void 0,O=void 0,"coil"!==p&&"other"!==p?(u=!0,C=!1):(u=!1,C=!1),"coil"!==E&&"other"!==E){let e=d+"_"+I+"_"+D.toString();for(let t in i.residues[e])i.atoms[t].ssbegin=!1,i.atoms[t].ssend=!0}}else x=A,O=k,p!==E?"coil"===E||"other"===E?(u=!0,C=!1):"coil"===p||"other"===p?(s=!0,u=!1,C=!1):("sheet"===E&&"helix"===p||"helix"===E&&"sheet"===p)&&(s=!0,u=!0,C=!1):(u=!1,C=!1);if(s&&!isNaN(m)){let e=d+"_"+c+"_"+(m-1).toString();for(let t in i.residues[e])i.atoms[t].ssbegin=!1,i.atoms[t].ssend=!0}E=p,I=c,D=m,g=!1,f=!1,b=!1,"non-polymer"===e.chemCompType.toLowerCase()||"other"===e.chemCompType.toLowerCase()||-1!==e.chemCompType.toLowerCase().indexOf("saccharide")?g=!0:-1!==e.chemCompType.toLowerCase().indexOf("peptide")?f=!0:-1!==e.chemCompType.toLowerCase().indexOf("dna")||-1!==e.chemCompType.toLowerCase().indexOf("rna")?b=!0:f=!0;let n=d+"_"+c,o={};o.resi=m,o.name=l.utilsCls.residueName2Abbr(h),i.residueId2Name[t]=o.name,o.resi%10==0&&o.resi.toString();let r="-";"helix"===p?r="H":"sheet"===p?r="E":"coil"===p?r="c":"other"===p&&(r="o"),void 0===i.chainsSeq[n]&&(i.chainsSeq[n]=[]),i.bFullUi&&i.chainsSeq[n].push(o),i.secondaries[t]=r},onAtom:function(e){if(y=e.element,v=e.atomName,w=new THREE.Vector3(e.xCoord,e.yCoord,e.zCoord),S=e.bFactor,_=e.altLoc,"\0"===e.altLoc&&(_=""),""===_||"A"===_){++T,"SG"===v&&R.push(T),H[e.atomIndex]=T;let t={het:g,serial:T,name:v,alt:_,resn:h,structure:d,chain:c,resi:m,coord:w,b:S,elem:y,bonds:[],bondOrder:[],ss:p,ssbegin:u,ssend:C};if(t.het||"C"!==t.name||(A=T),t.het||"O"!==t.name||(k=T),!t.het&&"N"===t.name&&void 0!==x&&void 0!==O){let e=i.atoms[x].coord.distanceTo(i.atoms[O].coord),s=t.coord.x+(i.atoms[x].coord.x-i.atoms[O].coord.x)/e,l=t.coord.y+(i.atoms[x].coord.y-i.atoms[O].coord.y)/e,n=t.coord.z+(i.atoms[x].coord.z-i.atoms[O].coord.z)/e;t.hcoord=new THREE.Vector3(s,l,n)}i.atoms[T]=t,n.min(w),o.max(w),r.add(w);let l=d+"_"+c,a=l+"_"+m;void 0===i.chains[l]&&(i.chains[l]={}),i.chains[l][T]=1,void 0===i.residues[a]&&(i.residues[a]={}),i.residues[a][T]=1,f?(i.proteins[T]=1,"CA"===v&&(i.calphas[T]=1),"N"!==v&&"CA"!==v&&"C"!==v&&"O"!==v&&(i.sidec[T]=1)):b?(i.nucleotides[T]=1,(!s||"O3'"!=v&&"O3*"!=v)&&(s||"P"!=v)||(i.nucleotidesO3[T]=1)):y.toLowerCase()===h.toLowerCase()?i.ions[T]=1:"HOH"===h||"WAT"===h||"SQL"===h||"H2O"===h||"W"===h||"DOD"===h||"D3O"===h?i.water[T]=1:i.chemicals[T]=1,i.dAtoms[T]=1,i.hAtoms[T]=1}},onBond:function(e){let t=H[e.atomIndex1],s=H[e.atomIndex2];if(H.hasOwnProperty(e.atomIndex1)&&H.hasOwnProperty(e.atomIndex2)&&(i.atoms[t].bonds.push(s),i.atoms[s].bonds.push(t),g)){let l=e.bondOrder;i.atoms[t].bondOrder.push(l),i.atoms[s].bondOrder.push(l),2===l?(i.doublebonds[t+"_"+s]=1,i.doublebonds[s+"_"+t]=1):3===l&&(i.triplebonds[t+"_"+s]=1,i.triplebonds[s+"_"+t]=1)}}};MMTF.traverse(e,P);for(let e=0,t=R.length;e<t;++e)for(let s=e+1;s<t;++s){let t=R[e],l=R[s],n=i.atoms[t],o=i.atoms[l];if(-1!==$.inArray(l,n.bonds)){let e=n.structure+"_"+n.chain+"_"+n.resi,t=o.structure+"_"+o.chain+"_"+o.resi;void 0===i.ssbondpnts[n.structure]&&(i.ssbondpnts[n.structure]=[]),i.ssbondpnts[n.structure].push(e),i.ssbondpnts[n.structure].push(t)}}i.cnt=T,(i.cnt>i.maxatomcnt||void 0!==i.biomtMatrices&&i.biomtMatrices.length*i.cnt>10*i.maxatomcnt)&&(i.opts.proteins="c alpha trace",i.opts.nucleotides="o3 trace"),i.pmin=n,i.pmax=o,i.maxD=o.distanceTo(n),i.center=r.multiplyScalar(1/i.cnt),i.maxD<5&&(i.maxD=5),i.oriMaxD=i.maxD,i.oriCenter=i.center.clone(),i.ParserUtilsCls.transformToOpmOri(t),void 0===i.icn3dui.cfg.align&&1==Object.keys(i.structures).length&&$("#"+i.pre+"alternateWrapper").hide(),i.setStyleCls.setAtomStyleByOptions(i.opts),i.setColorCls.setColorByOptions(i.opts,i.atoms),i.ParserUtilsCls.renderStructure(),i.saveFileCls.showTitle(),void 0!==i.icn3dui.cfg.rotate&&i.resizeCanvasCls.rotStruc(i.icn3dui.cfg.rotate,!0)}}class ie{constructor(e){this.icn3d=e}downloadAlignment(e){let t=this.icn3d,s=t.icn3dui,i=this;t.opts.proteins="c alpha trace";let l=e.split(","),n="ids="+e,o=t.icn3dui.htmlCls.baseUrl+"vastplus/vastplus.cgi?v=3&cmd=c&b=1&s=1&w3d&"+n;void 0!==t.icn3dui.cfg.inpara&&(o+=t.icn3dui.cfg.inpara),t.bCid=void 0,t.pdbid_chain2title={},void 0===t.chainids2resids&&(t.chainids2resids={});let r=$.ajax({url:o,dataType:"jsonp",cache:!0,beforeSend:function(){t.ParserUtilsCls.showLoading()},complete:function(){}}),a={};r.fail((function(){return alert("These two MMDB IDs "+l+" do not have 3D alignment data."),!1})).then((function(e){if(a=e.seqalign,void 0===a)return alert("These two MMDB IDs "+l+" do not have 3D alignment data."),!1;t.pdbid_molid2chain={},t.chainsColor={};for(let i=0,l=2;i<l;++i){let l=e.alignedStructures[0][i],n=void 0!==l.pdbId?l.pdbId:l.mmdbId,o={};for(let e=0,i=l.molecules.length;e<i;++e){let i=l.molecules[e],r=i.moleculeId,a=i.chain.trim();void 0===o[a]?o[a]=1:++o[a];let d=1===o[a]?a:a+o[a].toString();t.pdbid_molid2chain[n+"_"+r]=d,"p"!==i.kind&&"n"!==i.kind||(t.chainsColor[n+"_"+d]=s.parasCls.thr(t.icn3dui.htmlCls.GREY8))}}t.mmdbidArray=[];for(let s=0,i=2;s<i;++s){let i=e.alignedStructures[0][s],l=i.pdbId;t.mmdbidArray.push(l);let n=i.molecules;for(let e in n){let s=n[e].chain;t.pdbid_chain2title[l+"_"+s]=n[e].name}}t.alignmolid2color=[],s.parasCls.stdChainColors.length;for(let e=0,s=a.length;e<s;++e){let s=a[e][0].moleculeId,i=a[e][1].moleculeId,l={};l[s]=(e+1).toString(),t.alignmolid2color.push(l),l={},l[i]=(e+1).toString(),t.alignmolid2color.push(l)}let n=t.icn3dui.htmlCls.baseUrl+"mmdb/mmdb_strview.cgi?v=2&program=icn3d&b=1&s=1&ft=1&uid="+t.mmdbidArray[0],o=t.icn3dui.htmlCls.baseUrl+"mmdb/mmdb_strview.cgi?v=2&program=icn3d&b=1&s=1&ft=1&uid="+t.mmdbidArray[1],r=$.ajax({url:n,dataType:"jsonp",cache:!0,beforeSend:function(){t.ParserUtilsCls.showLoading()},complete:function(){}}),d=$.ajax({url:o,dataType:"jsonp",cache:!0,beforeSend:function(){t.ParserUtilsCls.showLoading()},complete:function(){}});$.when(r,d).then((function(s,l){let n=e,o=s[0],r=l[0];return void 0!==o.atoms&&void 0!==r.atoms?(t.deferredOpm=$.Deferred((function(){t.ParserUtilsCls.setYourNote((t.mmdbidArray[0]+","+t.mmdbidArray[1]).toUpperCase()+"(VAST+) in iCn3D");let e=n.transform.translate.master,s=new THREE.Vector3(e[0]/1,e[1]/1,e[2]/1),l=n.transform.translate.slave,d=new THREE.Vector3(l[0]/1,l[1]/1,l[2]/1),c=n.transform.rotate,h=[];for(let e=0,t=c.length;e<t;++e)h.push(c[e]/1);t.chainid2seq={};for(let e in o.sequences){let s=t.mmdbidArray[0]+"_"+e;t.chainid2seq[s]=o.sequences[e]}for(let e in r.sequences){let s=t.mmdbidArray[1]+"_"+e;t.chainid2seq[s]=r.sequences[e]}let m=o.atoms,p=r.atoms,u=o.atomCount,C=r.atomCount;for(let e=0,t=n.alignedStructures[0].length;e<t;++e){let t=n.alignedStructures[0][e];t.serialInterval=[],0==e?(t.serialInterval.push(1),t.serialInterval.push(u)):1==e&&(t.serialInterval.push(u+1),t.serialInterval.push(u+C))}let g={};for(let e in m){let t=m[e];t.coord=new THREE.Vector3(t.coord[0],t.coord[1],t.coord[2]),t.coord.add(s);let i=t.coord.x*h[0]+t.coord.y*h[1]+t.coord.z*h[2],l=t.coord.x*h[3]+t.coord.y*h[4]+t.coord.z*h[5],n=t.coord.x*h[6]+t.coord.y*h[7]+t.coord.z*h[8];t.coord.x=i,t.coord.y=l,t.coord.z=n,g[e]=t}for(let e in p){let t=p[e];t.coord=new THREE.Vector3(t.coord[0],t.coord[1],t.coord[2]),t.coord.add(d);for(let e=0,s=t.bonds.length;e<s;++e)t.bonds[e]+=u;g[(parseInt(e)+u).toString()]=t}let f={};f.alignedStructures=n.alignedStructures,f.alignment=n.alignment,f.atoms=g,i.loadOpmDataForAlign(f,a,t.mmdbidArray)})),t.deferredOpm.promise()):(alert("invalid atoms data."),!1)}))}))}downloadAlignmentPart2(e,t,s){let i=this.icn3d;i.icn3dui,i.loadAtomDataCls.loadAtomDataIn(e,void 0,"align",t),void 0===i.icn3dui.cfg.align&&1==Object.keys(i.structures).length&&$("#"+i.pre+"alternateWrapper").hide();let l={};for(let e in i.atoms)l[e]=1;i.dAtoms=l,i.hAtoms=l,i.setStyleCls.setAtomStyleByOptions(i.opts),i.setColorCls.setColorByOptions(i.opts,i.atoms),void 0!==s&&i.ParserUtilsCls.transformToOpmOriForAlign(i.selectedPdbid,s,!0),i.ParserUtilsCls.renderStructure(),void 0!==i.icn3dui.cfg.rotate&&i.resizeCanvasCls.rotStruc(i.icn3dui.cfg.rotate,!0),i.html2ddgm="",i.icn3dui.cfg.showalignseq&&i.icn3dui.htmlCls.dialogCls.openDlg("dl_alignment","Select residues in aligned sequences"),i.icn3dui.cfg.show2d&&i.bFullUi&&i.ParserUtilsCls.set2DDiagramsForAlign(i.mmdbidArray[0].toUpperCase(),i.mmdbidArray[1].toUpperCase())}loadOpmDataForAlign(e,t,s){let i=this.icn3d;i.icn3dui;let l,n,o=this;l="https://opm-assets.storage.googleapis.com/pdb/"+s[0].toLowerCase()+".pdb",n="text",$.ajax({url:l,dataType:n,cache:!0,success:function(l){i.selectedPdbid=s[0],i.bOpm=!0;let n=i.loadPDBCls.loadPDB(l,s[0],i.bOpm,!0);$("#"+i.pre+"selectplane_z1").val(i.halfBilayerSize),$("#"+i.pre+"selectplane_z2").val(-i.halfBilayerSize),$("#"+i.pre+"extra_mem_z").val(i.halfBilayerSize),$("#"+i.pre+"intra_mem_z").val(-i.halfBilayerSize),i.init(),o.downloadAlignmentPart2(e,t,n),void 0!==i.deferredOpm&&i.deferredOpm.resolve()},error:function(l,r,a){let d="https://opm-assets.storage.googleapis.com/pdb/"+s[1].toLowerCase()+".pdb";$.ajax({url:d,dataType:n,cache:!0,success:function(l){i.selectedPdbid=s[1],i.bOpm=!0;let n=i.loadPDBCls.loadPDB(l,s[1],i.bOpm,!0);$("#"+i.pre+"selectplane_z1").val(i.halfBilayerSize),$("#"+i.pre+"selectplane_z2").val(-i.halfBilayerSize),$("#"+i.pre+"extra_mem_z").val(i.halfBilayerSize),$("#"+i.pre+"intra_mem_z").val(-i.halfBilayerSize),i.init(),o.downloadAlignmentPart2(e,t,n),void 0!==i.deferredOpm&&i.deferredOpm.resolve()},error:function(s,l,n){i.init(),o.downloadAlignmentPart2(e,t),void 0!==i.deferredOpm&&i.deferredOpm.resolve()}})}})}}class le{constructor(e){this.icn3d=e}downloadOpm(e){let t,s,i=this.icn3d;i.icn3dui,t="https://opm-assets.storage.googleapis.com/pdb/"+e.toLowerCase()+".pdb",i.ParserUtilsCls.setYourNote(e.toUpperCase()+"(OPM) in iCn3D"),s="text",i.bCid=void 0,i.bStopRotate=!0,$.ajax({url:t,dataType:"text",cache:!0,tryCount:0,retryLimit:1,beforeSend:function(){i.ParserUtilsCls.showLoading()},complete:function(){},success:function(t){i.bOpm=!0,i.pdbParserCls.loadPdbData(t,e,i.bOpm),$("#"+i.pre+"selectplane_z1").val(i.halfBilayerSize),$("#"+i.pre+"selectplane_z2").val(-i.halfBilayerSize),$("#"+i.pre+"extra_mem_z").val(i.halfBilayerSize),$("#"+i.pre+"intra_mem_z").val(-i.halfBilayerSize)},error:function(e,t,s){this.tryCount++,this.tryCount<=this.retryLimit?$.ajax(this):alert("This is probably not a transmembrane protein. It has no data in Orientations of Proteins in Membranes(OPM) database.")}})}loadOpmData(e,t,s,i,l){this.icn3d.icn3dui;let n,o,r=this;t||(t="stru"),n="https://www.ncbi.nlm.nih.gov/Structure/mmdb/mmdb_strview.cgi?v=2&program=icn3d&opm&uid="+t.toLowerCase(),o="jsonp",$.ajax({url:n,dataType:"jsonp",cache:!0,tryCount:0,retryLimit:1,success:function(n){r.setOpmData(n),r.parseAtomData(e,t,s,i,l)},error:function(n,o,a){this.tryCount++,this.tryCount<=this.retryLimit?$.ajax(this):r.parseAtomData(e,t,s,i,l)}})}setOpmData(e){let t=this.icn3d;t.icn3dui,void 0!==e.opm&&void 0!==e.opm.rot?(t.bOpm=!0,t.halfBilayerSize=e.opm.thickness,t.rmsd_supr={},t.rmsd_supr.rot=e.opm.rot,t.rmsd_supr.trans1=new THREE.Vector3(e.opm.trans1[0],e.opm.trans1[1],e.opm.trans1[2]),t.rmsd_supr.trans2=new THREE.Vector3(e.opm.trans2[0],e.opm.trans2[1],e.opm.trans2[2]),t.rmsd_supr.rmsd=e.opm.rmsd,$("#"+t.pre+"selectplane_z1").val(t.halfBilayerSize),$("#"+t.pre+"selectplane_z2").val(-t.halfBilayerSize),$("#"+t.pre+"extra_mem_z").val(t.halfBilayerSize),$("#"+t.pre+"intra_mem_z").val(-t.halfBilayerSize)):t.bOpm=!1}parseAtomData(e,t,s,i,l){let n=this.icn3d;n.icn3dui,"mmtf"===i?(n.mmtfParserCls.parseMmtfData(e,t,s),void 0!==n.deferredOpm&&n.deferredOpm.resolve()):"mmcif"===i?(n.loadAtomDataCls.loadAtomDataIn(e,e.mmcif,"mmcifid",void 0,void 0),n.mmcifParserCls.loadMmcifOpmDataPart2(e,t),void 0!==n.deferredOpm&&n.deferredOpm.resolve()):"pdb"===i?(n.pdbParserCls.loadPdbData(e,t),void 0!==n.deferredOpm&&n.deferredOpm.resolve()):"align"===i&&(n.bOpm?(n.alignParserCls.downloadAlignmentPart2(t),void 0!==n.deferredOpm&&n.deferredOpm.resolve()):void 0!==l?this.loadOpmData(e,l,s,i):(n.alignParserCls.downloadAlignmentPart2(t),void 0!==n.deferredOpm&&n.deferredOpm.resolve()))}}class ne{constructor(e){this.icn3d=e}parseMmdbDataPart1(e,t){let s=this.icn3d,i=s.icn3dui;if(void 0===e.atoms&&void 0===e.molid2rescount)return alert("invalid MMDB data."),!1;void 0!==t&&"target"!==t||(s.bStatefile||s.init(),s.chainsColor={},s.chainsGene={}),"query"===t||(s.interactionData={moleculeInfor:e.moleculeInfor,intrac:e.intrac,intracResidues:e.intracResidues}),"query"===t||(s.mmdb_data=e);let l=void 0!==e.pdbId?e.pdbId:e.mmdbId;"query"===t?s.inputid2=l:s.inputid=l;let n=e.moleculeInfor,o={},r={};for(let e in n){if(0===Object.keys(n[e]).length)continue;let a=void 0===n[e].color?"#CCCCCC":"#"+("000000"+n[e].color.toString(16)).slice(-6),d=void 0===n[e].chain?"":n[e].chain.trim();void 0===r[d]?r[d]=1:++r[d];let c=l+"_"+(1===r[d]?d:d+r[d].toString());o[e]=c,s.chainsColor[c]=void 0!==t?i.parasCls.thr(s.icn3dui.htmlCls.GREY8):i.parasCls.thr(a);let h=void 0===n[e].geneId?"":n[e].geneId,m=void 0===n[e].geneSymbol?"":n[e].geneSymbol,p=void 0===n[e].geneDesc?"":n[e].geneDesc;s.chainsGene[c]={geneId:h,geneSymbol:m,geneDesc:p}}s.molid2chain=o,$("#"+s.pre+"accordion5").show()}parseMmdbData(e,t,s,i,l){let n=this.icn3d;if(n.icn3dui,void 0!==t){this.parseMmdbDataPart1(e,t);let o=void 0!==e.pdbId?e.pdbId:e.mmdbId,r=n.loadAtomDataCls.loadAtomDataIn(e,o,"mmdbid",void 0,t,s,i,l);return this.loadMmdbOpmDataPart2(e,o,t),r}{let s=void 0!==e.pdbId?e.pdbId:e.mmdbId;this.loadMmdbOpmData(e,s,t)}}downloadMmdb(e,t){let s,i=this.icn3d,l=i.icn3dui,n=this;s=t?i.icn3dui.htmlCls.baseUrl+"mmdb/mmdb_strview.cgi?v=2&program=icn3d&b=1&s=1&ft=1&simple=1&gi="+e:i.icn3dui.htmlCls.baseUrl+"mmdb/mmdb_strview.cgi?v=2&program=icn3d&b=1&s=1&ft=1&simple=1&uid="+e,void 0!==i.icn3dui.cfg.blast_rep_id&&(s+="&buidx=0"),i.bCid=void 0,void 0!==i.icn3dui.cfg.inpara&&(s+=i.icn3dui.cfg.inpara),void 0===i.chainids2resids&&(i.chainids2resids={}),$.ajax({url:s,dataType:"jsonp",cache:!0,tryCount:0,retryLimit:1,beforeSend:function(){i.ParserUtilsCls.showLoading()},complete:function(){},success:function(o){if(0==Object.keys(o.atoms).length){let e=o.pdbId;return void i.mmtfParserCls.downloadMmtf(e)}l.utilsCls.isCalphaPhosOnly(o.atoms)||o.atomCount<=i.maxatomcnt?n.parseMmdbData(o):(o=null,$.ajax({url:s+"&complexity=2",dataType:"jsonp",cache:!0,tryCount:0,retryLimit:1,beforeSend:function(){i.ParserUtilsCls.showLoading()},complete:function(){},success:function(e){n.parseMmdbData(e)},error:function(s,l,n){this.tryCount++,this.tryCount<=this.retryLimit?$.ajax(this):t?alert("This gi "+e+" has no corresponding 3D structure..."):alert("This mmdbid "+e+" with the parameters "+i.icn3dui.cfg.inpara+" may not have 3D structure data. Please visit the summary page for details: "+i.icn3dui.htmlCls.baseUrl+"pdb/"+e)}}))},error:function(s,l,n){this.tryCount++,this.tryCount<=this.retryLimit?$.ajax(this):t?alert("This gi "+e+" has no corresponding 3D structure..."):alert("This mmdbid "+e+" with the parameters "+i.icn3dui.cfg.inpara+" may not have 3D structure data. Please visit the summary page for details: "+i.icn3dui.htmlCls.baseUrl+"pdb/"+e)}})}downloadMmdbPart2(e){let t=this.icn3d;t.icn3dui,t.bAssemblyUseAsu?($("#"+t.pre+"assemblyWrapper").show(),t.bAssembly=!0):($("#"+t.pre+"assemblyWrapper").hide(),t.bAssembly=!1),void 0!==t.emd?($("#"+t.pre+"mapWrapper1").hide(),$("#"+t.pre+"mapWrapper2").hide(),$("#"+t.pre+"mapWrapper3").hide()):($("#"+t.pre+"emmapWrapper1").hide(),$("#"+t.pre+"emmapWrapper2").hide(),$("#"+t.pre+"emmapWrapper3").hide()),t.setStyleCls.setAtomStyleByOptions(t.opts),void 0!==t.icn3dui.cfg.blast_rep_id?t.setColorCls.setColorByOptions(t.opts,t.atoms):t.setColorCls.setColorByOptions(t.opts,t.atoms,!0),void 0===e&&(t.ParserUtilsCls.renderStructure(),void 0!==t.icn3dui.cfg.rotate&&t.resizeCanvasCls.rotStruc(t.icn3dui.cfg.rotate,!0),t.html2ddgm="",t.icn3dui.cfg.show2d&&(t.icn3dui.htmlCls.dialogCls.openDlg("dl_2ddgm","Interactions"),t.bFullUi&&t.ParserUtilsCls.download2Ddgm(t.inputid.toUpperCase()))),void 0!==t.icn3dui.cfg.align&&void 0!==t.icn3dui.cfg.chainalign||1!=Object.keys(t.structures).length||null!==$("#"+t.pre+"alternateWrapper")&&$("#"+t.pre+"alternateWrapper").hide()}downloadGi(e){let t=this.icn3d;t.icn3dui,t.bCid=void 0;this.downloadMmdb(e,!0)}downloadBlast_rep_id(e){let t=this.icn3d;t.icn3dui,t.bCid=void 0;let s=e.split(",");t.icn3dui.cfg.query_id=s[0],t.icn3dui.cfg.blast_rep_id=s[1];let i=t.icn3dui.cfg.blast_rep_id.split("_")[0];this.downloadMmdb(i)}loadMmdbOpmData(e,t,s){let i=this.icn3d;i.icn3dui,void 0!==e.opm&&void 0!==e.opm.rot?(i.bOpm=!0,i.opmParserCls.setOpmData(e),this.parseMmdbDataPart1(e,s),i.loadAtomDataCls.loadAtomDataIn(e,t,"mmdbid",void 0,s),this.loadMmdbOpmDataPart2(e,t,s)):(this.parseMmdbDataPart1(e,s),i.loadAtomDataCls.loadAtomDataIn(e,t,"mmdbid",void 0,s),this.loadMmdbOpmDataPart2(e,t,s))}loadMmdbOpmDataPart2(e,t,s){let i=this.icn3d;i.icn3dui;let l=this,n=e.pdbId;void 0===s&&i.ParserUtilsCls.setYourNote(n.toUpperCase()+"(MMDB) in iCn3D");for(let t in e.domains){let s=e.domains[t].chain,l=e.domains[t].domains;for(let e=0,t=l.length;e<t;++e){let t=n+"_"+s+"_3d_domain_"+(e+1).toString();i.tddomains[t]={};let o=l[e].intervals,r={},a={};for(let e=0,l=o.length;e<l;++e){let l=Math.round(o[e][0])-1,d=Math.round(o[e][1])-1;if(!r.hasOwnProperty(l)&&!a.hasOwnProperty(d)){r[l]=1,a[d]=1;for(let e=l;e<=d;++e){let l=n+"_"+s+"_"+(e+1).toString();i.tddomains[t][l]=1}}}}}i.bAssemblyUseAsu=void 0!==e.asuAtomCount,void 0!==s?(i.bAssemblyUseAsu=!1,this.downloadMmdbPart2(s)):$.when(i.mmcifParserCls.downloadMmcifSymmetry(t)).then((function(){l.downloadMmdbPart2(s)}))}downloadUniprotid(e){let t=this.icn3d;t.icn3dui;let s="https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esummary.fcgi?db=protein&retmode=json&id="+e;t.bCid=void 0,$.ajax({url:s,dataType:"json",cache:!0,tryCount:0,retryLimit:1,beforeSend:function(){},complete:function(){},success:function(e){let t="https://www.ncbi.nlm.nih.gov/structure?linkname=protein_structure&from_uid="+e.result.uids.join(",");window.open(t,"_self")},error:function(e,t,s){this.tryCount++,this.tryCount<=this.retryLimit&&$.ajax(this)}})}}class oe{constructor(e){this.icn3d=e}realign(){let e=this.icn3d,t=e.icn3dui;e.selectionCls.saveSelectionPrep();let s="alseq_"+Object.keys(e.defNames2Atoms).length;e.selectionCls.saveSelection(s,s);let i={};e.realignResid={};let l="";for(let s in e.hAtoms){let n=e.atoms[s];if(e.proteins.hasOwnProperty(s)&&"CA"==n.name||e.nucleotides.hasOwnProperty(s)&&("O3'"==n.name||"O3*"==n.name)){if(n.structure+"_"+n.resi==l)continue;i.hasOwnProperty(n.structure)||(i[n.structure]=[]),i[n.structure].push(n.coord.clone()),e.realignResid.hasOwnProperty(n.structure)||(e.realignResid[n.structure]=[]),e.realignResid[n.structure].push({resid:n.structure+"_"+n.chain+"_"+n.resi,resn:t.utilsCls.residueName2Abbr(n.resn.substr(0,3)).substr(0,1)}),l=n.structure+"_"+n.resi}}let n=Object.keys(i),o=n[0],r=n[1],a=i[r],d=i[o];e.ParserUtilsCls.alignCoords(a,d,r,!0),e.hlUpdateCls.updateHlAll()}parseChainRealignPredefined(e,t,s,i){let l=this.icn3d,n=l.icn3dui,o=e[0].substr(0,e[0].indexOf("_"));o=o.toUpperCase();let r={};l.realignResid={},l.opts.color="grey",l.setColorCls.setColorByOptions(l.opts,l.dAtoms);for(let a=0,d=e.length-1;a<d;++a){let d=e[a+1].substr(0,e[a+1].indexOf("_"));d=d.toUpperCase(),o==d&&(d+=l.icn3dui.htmlCls.postfix);let c=t[o],h=t[d],m=s[o],p=s[d],u=i[o],C=i[d];l.realignResid[o]=[],l.realignResid[d]=[];for(let e=0,t=c.length;e<t;++e)l.realignResid[o].push({resid:u[e],resn:c[e]}),l.realignResid[d].push({resid:C[e],resn:h[e]});let g=e[0],f=e[a+1],b=!0,y=l.ParserUtilsCls.alignCoords(p,m,d,void 0,g,f,a+1,b);r=n.hashUtilsCls.unionHash(r,y)}l.chainalignParserCls.downloadChainalignmentPart3(void 0,e,r)}parseChainRealignData(e,t,s,i,l,n,o){let r=this.icn3d,a=r.icn3dui,d=s[0].substr(0,s[0].indexOf("_"));o||(d=d.toUpperCase());let c={};r.realignResid={},r.opts.color="grey",r.setColorCls.setColorByOptions(r.opts,r.dAtoms);for(let t=0,h=e.length;t<h;++t){let h=e[t][0],m=s[t+1].substr(0,s[t+1].indexOf("_"));o||(m=m.toUpperCase()),d==m&&(m+=r.icn3dui.htmlCls.postfix);let p,u,C=i[d],g=i[m],f=l[d],b=l[m],y=n[d],v=n[m];if(void 0!==h.data){p=h.data[0].query;let e=Object.keys(h.data[0].targets)[0];u=h.data[0].targets[e],u=u.hsps[0]}if(void 0!==p&&void 0!==u){let e=[],i=[],l="",n="";r.realignResid[d]=[],r.realignResid[m]=[];let o=u.segs;for(let t=0,s=o.length;t<s;++t){let s=o[t],a="",c="";for(let t=0;t<=s.orito-s.orifrom;++t){let o=y[t+s.orifrom].substr(0,y[t+s.orifrom].lastIndexOf("_")),h=v[t+s.from].substr(0,v[t+s.from].lastIndexOf("_"));f[t+s.orifrom]&&b[t+s.from]&&(e.push(f[t+s.orifrom]),i.push(b[t+s.from]),l+=C[t+s.orifrom],n+=g[t+s.from],(0==t||a==o&&c==h||a!=o&&c!=h)&&(r.realignResid[d].push({resid:y[t+s.orifrom],resn:C[t+s.orifrom]}),r.realignResid[m].push({resid:v[t+s.from],resn:g[t+s.from]})),a=o,c=h)}}let h=s[0],p=s[t+1],w=!0,S=r.ParserUtilsCls.alignCoords(i,e,m,void 0,h,p,t+1,w);c=a.hashUtilsCls.unionHash(c,S)}else void 0!==m||r.icn3dui.cfg.command?(C.length<6||g.length<6)&&!r.icn3dui.cfg.command?alert("These sequences are too short for alignment"):C.length>=6&&g.length>=6&&!r.icn3dui.cfg.command&&alert("These sequences can not be aligned to each other"):alert("Please do not align residues in the same structure")}o?(r.dAtoms=c,r.hAtoms=c,r.opts.color="identity",r.setColorCls.setColorByOptions(r.opts,r.hAtoms),r.drawCls.draw(),r.hlUpdateCls.updateHlAll(),void 0!==r.deferredRealign&&r.deferredRealign.resolve()):r.chainalignParserCls.downloadChainalignmentPart3(t,s,c)}realignOnSeqAlign(){let e=this.icn3d;e.icn3dui;let t=e.firstAtomObjCls.getChainsFromAtoms(e.hAtoms),s=Object.keys(t),i=[],l="";for(let e=0,t=s.length;e<t;++e)s[e]!=l&&i.push(s[e]),l=s[e];this.realignChainOnSeqAlign(void 0,i,!0)}realignChainOnSeqAlign(e,t,s,i){let l,n,o,r=this.icn3d,a=r.icn3dui,d=this,c={},h={},m={},p=[];if(i&&(n=a.cfg.resdef.trim().replace(/\+/gi," ").split(" | "),n.length!=t.length))alert("Please make sure the number of chains and the lines of predefined residues are the same...");else{for(let e=0,d=t.length;e<d;++e){i&&(o=n[e].trim());let d=t[e].indexOf("_"),u=t[e].substr(0,d);s||(u=u.toUpperCase()),0==e?l=u:l==u&&(u+=r.icn3dui.htmlCls.postfix);let C=u+t[e].substr(d);if(!r.chainsSeq[C])return void alert("Please select one chain per structure and try it again...");if(c.hasOwnProperty(u)||(c[u]="",h[u]=[],m[u]=[]),0==e||i){let e,t,l=parseInt(r.chainsSeq[C][0].resi);if(s){let t=r.chainsSeq[C].length,s=r.chainsSeq[C][t-1].resi;e=l.toString()+"-"+s.toString()}t=s?[e]:i?o.split(","):r.icn3dui.cfg.resnum.split(",");for(let e=0,s=t.length;e<s;++e)if(-1!=t[e].indexOf("-")){let s=t[e].split("-");for(let e=parseInt(s[0]);e<=parseInt(s[1]);++e){if(!r.chainsSeq[C][e-l]||-1==a.parasCls.b62ResArray.indexOf(r.chainsSeq[C][e-l].name.toUpperCase()))continue;c[u]+=r.chainsSeq[C][e-l].name;let t=!1;for(let s in r.residues[C+"_"+e]){let e=r.atoms[s];if(r.proteins.hasOwnProperty(s)&&"CA"==e.name&&"C"==e.elem||r.nucleotides.hasOwnProperty(s)&&("O3'"==e.name||"O3*"==e.name)&&"O"==e.elem){h[u].push(e.coord.clone()),t=!0;break}}t||h[u].push(void 0),m[u].push(C+"_"+e)}}else{let s=parseInt(t[e]);c[u]+=r.chainsSeq[C][s-l].name;let i=!1;for(let e in r.residues[C+"_"+s]){let t=r.atoms[e];if(r.proteins.hasOwnProperty(e)&&"CA"==t.name&&"C"==t.elem||r.nucleotides.hasOwnProperty(e)&&("O3'"==t.name||"O3*"==t.name)&&"O"==t.elem){h[u].push(t.coord.clone()),i=!0;break}}i||h[u].push(void 0),m[u].push(C+"_"+s)}}else for(let e=0,t=r.chainsSeq[C].length;e<t;++e){c[u]+=r.chainsSeq[C][e].name;let t=C+"_"+r.chainsSeq[C][e].resi,s=!1;for(let e in r.residues[t]){let t=r.atoms[e];if(r.proteins.hasOwnProperty(e)&&"CA"==t.name&&"C"==t.elem||r.nucleotides.hasOwnProperty(e)&&("O3'"==t.name||"O3*"==t.name)&&"O"==t.elem){h[u].push(t.coord.clone()),s=!0;break}}s||h[u].push(void 0),m[u].push(t)}if(e>0&&!i){let e=u,t=c[l],s=c[e],i=$.ajax({url:"https://www.ncbi.nlm.nih.gov/Structure/pwaln/pwaln.fcgi?from=chainalign",type:"POST",data:{targets:t,queries:s},dataType:"jsonp",cache:!0});p.push(i)}}i?d.parseChainRealignPredefined(t,c,h,m):$.when.apply(void 0,p).then((function(){let i=2==t.length?[arguments]:Array.from(arguments);d.parseChainRealignData(Array.from(i),e,t,c,h,m,s)})).fail((function(){alert("The realignment did not work...")}))}}}class re{constructor(e){this.icn3d=e}downloadChainalignmentPart2(e,t,s,i){let l=this.icn3d,n=l.icn3dui,o={};o=l.mmdbParserCls.parseMmdbData(e,"target",i[0],0);let r=!1;for(let e=0,s=t.length;e<s;++e){e==t.length-1&&(r=!0);let s=l.mmdbParserCls.parseMmdbData(t[e],"query",i[e+1],e,r);o=n.hashUtilsCls.unionHash(o,s)}l.icn3dui.cfg.resnum?l.realignParserCls.realignChainOnSeqAlign(s,i):l.icn3dui.cfg.resdef?l.realignParserCls.realignChainOnSeqAlign(s,i,void 0,!0):this.downloadChainalignmentPart3(s,i,o)}downloadChainalignmentPart3(e,t,s){let i=this.icn3d;i.icn3dui;let l={};for(let e in i.atoms)l[e]=1;if(i.dAtoms=l,i.hAtoms=l,i.setStyleCls.setAtomStyleByOptions(i.opts),i.opts.color="identity",i.setColorCls.setColorByOptions(i.opts,i.atoms),void 0!==e&&i.ParserUtilsCls.transformToOpmOriForAlign(i.selectedPdbid,e,!0),i.dAtoms=s,i.hAtoms=s,i.ParserUtilsCls.renderStructure(),i.chainidArray.length>2){let e={};for(let t in s){let s=i.atoms[t];e[s.structure+"_"+s.chain+"_"+s.resi]=1}let t="protein_aligned",l="protein aligned",n="select "+i.resid2specCls.residueids2spec(Object.keys(e));i.selectionCls.addCustomSelection(Object.keys(e),t,l,n,!0)}i.hlUpdateCls.updateHlAll(),void 0!==i.icn3dui.cfg.rotate&&i.resizeCanvasCls.rotStruc(i.icn3dui.cfg.rotate,!0),i.html2ddgm="",i.icn3dui.cfg.showalignseq&&i.icn3dui.htmlCls.dialogCls.openDlg("dl_alignment","Select residues in aligned sequences"),i.icn3dui.cfg.show2d&&i.bFullUi&&(i.icn3dui.htmlCls.dialogCls.openDlg("dl_2ddgm","Interactions"),i.bFullUi&&(i.bChainAlign?i.ParserUtilsCls.set2DDiagramsForChainalign(t):i.ParserUtilsCls.download2Ddgm(i.inputid.toUpperCase())))}downloadChainalignment(e,t,s){let i=this.icn3d;i.icn3dui;let l=this;i.opts.proteins="c alpha trace";let n=e.split(",");for(let e=0,t=n.length;e<t;++e){let t=n[e],s=t.indexOf("_");n[e]=t.substr(0,s).toUpperCase()+t.substr(s)}i.chainidArray=n;let o=n[0].indexOf("_");i.mmdbid_t=n[0].substr(0,o).toUpperCase(),i.chain_t=n[0].substr(o+1);let r=i.icn3dui.htmlCls.baseUrl+"mmdb/mmdb_strview.cgi?v=2&program=icn3d&b=1&s=1&ft=1&uid="+i.mmdbid_t;void 0!==i.icn3dui.cfg.inpara&&(r+=i.icn3dui.cfg.inpara);let a=[],d=$.ajax({url:r,dataType:"jsonp",cache:!0});a.push(d),i.ParserUtilsCls.setYourNote(e.toUpperCase()+" in iCn3D"),i.bCid=void 0,i.pdbid_chain2title={},void 0===i.chainids2resids&&(i.chainids2resids={});for(let e=1,t=n.length;e<t;++e){let t=n[e].indexOf("_");i.mmdbid_q=n[e].substr(0,t).toUpperCase(),i.chain_q=n[e].substr(t+1);let s=i.mmdbid_q+"_"+i.chain_q+","+i.mmdbid_t+"_"+i.chain_t,l=i.icn3dui.htmlCls.baseUrl+"vastdyn/vastdyn.cgi?chainpairs="+s,o=i.icn3dui.htmlCls.baseUrl+"mmdb/mmdb_strview.cgi?v=2&program=icn3d&b=1&s=1&ft=1&uid="+i.mmdbid_q;void 0!==i.icn3dui.cfg.inpara&&(o+=i.icn3dui.cfg.inpara);let r=$.ajax({url:o,dataType:"jsonp",cache:!0});if(a.push(r),!i.icn3dui.cfg.resnum&&!i.icn3dui.cfg.resdef){let e=$.ajax({url:l,dataType:"jsonp",cache:!0});a.push(e)}}$.when.apply(void 0,a).then((function(){let e=1==n.length?[arguments]:Array.from(arguments);l.parseChainAlignData(e,n,i.mmdbid_t,i.chain_t)})).fail((function(){alert("These chains can not be aligned by VAST server. You can specify the residue range and try it again...")}))}parseChainAlignData(e,t,s,i){let l=this.icn3d;l.icn3dui;let n=e[0][0];l.t_trans_add=[],l.q_trans_sub=[],l.q_rotation=[],l.qt_start_end=[],l.mmdbidArray=[],l.mmdbidArray.push(s);let o=[],r=l.icn3dui.cfg.resnum||l.icn3dui.cfg.resdef?1:2;for(let n=1,a=e.length;n<a;n+=r){let a=e[n][0],d=parseInt(n/r),c=t[d].indexOf("_"),h=t[d].substr(0,c).toUpperCase(),m=t[d].substr(c+1);if(l.icn3dui.cfg.resnum||l.icn3dui.cfg.resdef)void 0!==a&&-1===JSON.stringify(a).indexOf("Oops there was a problem")&&(l.mmdbidArray.push(h),o.push(a));else{let r=e[n+1][0];if(!r)return void alert("These chains can not be aligned by VAST server. You can specify the residue range and try it again...");void 0!==a&&-1===JSON.stringify(a).indexOf("Oops there was a problem")&&void 0!==r&&-1===JSON.stringify(r).indexOf("Oops there was a problem")&&(void 0!==r&&0!=r.length||h!=s||m!=i?void 0===r||0==r.length?(l.icn3dui.cfg.command||alert("These two chains "+t[d]+' can not align to each other. Please select sequences from these two chains in the "Sequences & Annotations" window, and click "Realign Selection" in the "File" menu to align your selection.'),l.icn3dui.cfg.showanno=1,l.icn3dui.cfg.showalignseq=0):(l.t_trans_add.push(r[0].t_trans_add),l.q_trans_sub.push(r[0].q_trans_sub),l.q_rotation.push(r[0].q_rotation),l.qt_start_end.push(r[0].segs)):(l.t_trans_add.push({x:0,y:0,z:0}),l.q_trans_sub.push({x:0,y:0,z:0}),l.q_rotation.push({x1:1,y1:0,z1:0,x2:0,y2:1,z2:0,x3:0,y3:0,z3:1}),l.qt_start_end.push(void 0)),l.mmdbidArray.push(h),o.push(a))}}l.mmdb_data_q=o,this.loadOpmDataForChainalign(n,o,t,l.mmdbidArray)}loadOpmDataForChainalign(e,t,s,i){let l=this.icn3d;l.icn3dui;let n=this;if(l.icn3dui.cfg.resnum||l.icn3dui.cfg.resdef)l.bCommandLoad||l.init(),this.downloadChainalignmentPart2(e,t,void 0,s),void 0!==l.deferredOpm&&l.deferredOpm.resolve();else{let o=l.icn3dui.htmlCls.baseUrl+"vastdyn/vastdyn.cgi?mmdbids2opm="+i.join("','");$.ajax({url:o,dataType:"jsonp",cache:!0,success:function(i){let o=i.mmdbid;if(l.selectedPdbid=o,o){let i="https://opm-assets.storage.googleapis.com/pdb/"+o.toLowerCase()+".pdb";$.ajax({url:i,dataType:"text",cache:!0,success:function(i){l.bOpm=!0;let r=l.loadPDBCls.loadPDB(i,o,l.bOpm,!0);$("#"+l.pre+"selectplane_z1").val(l.halfBilayerSize),$("#"+l.pre+"selectplane_z2").val(-l.halfBilayerSize),$("#"+l.pre+"extra_mem_z").val(l.halfBilayerSize),$("#"+l.pre+"intra_mem_z").val(-l.halfBilayerSize),l.bCommandLoad||l.init(),n.downloadChainalignmentPart2(e,t,r,s),void 0!==l.deferredOpm&&l.deferredOpm.resolve()},error:function(i,o,r){l.bCommandLoad||l.init(),n.downloadChainalignmentPart2(e,t,void 0,s),void 0!==l.deferredOpm&&l.deferredOpm.resolve()}})}else l.bCommandLoad||l.init(),n.downloadChainalignmentPart2(e,t,void 0,s),void 0!==l.deferredOpm&&l.deferredOpm.resolve()},error:function(i,o,r){l.bCommandLoad||l.init(),n.downloadChainalignmentPart2(e,t,void 0,s),void 0!==l.deferredOpm&&l.deferredOpm.resolve()}})}}}class ae{constructor(e){this.icn3d=e}dsn6Parser(e,t,s){this.icn3d.icn3dui;let i="https://edmaps.rcsb.org/maps/"+e.toLowerCase()+"_"+t+".dsn6";this.dsn6ParserBase(i,t,s)}dsn6ParserBase(e,t,s){let i=this.icn3d;i.icn3dui;let l=this;if("2fofc"==t&&i.bAjax2fofc)i.mapData.sigma2=s,i.setOptionCls.setOption("map",t);else if("fofc"==t&&i.bAjaxfofc)i.mapData.sigma=s,i.setOptionCls.setOption("map",t);else{let n=new XMLHttpRequest;n.open("GET",e,!0),n.responseType="arraybuffer",n.onreadystatechange=function(){if(4==this.readyState){if(200==this.status){let e=n.response;l.loadDsn6Data(e,t,s),"2fofc"==t?i.bAjax2fofc=!0:"fofc"==t&&(i.bAjaxfofc=!0),i.setOptionCls.setOption("map",t)}else alert("RCSB server has no corresponding eletron density map for this structure.");void 0!==i.deferredMap&&i.deferredMap.resolve()}else i.ParserUtilsCls.showLoading()},n.send()}}loadDsn6Data(e,t,s){let i=this.icn3d;i.icn3dui;let l,n,o={},r=e.buffer&&e.buffer instanceof ArrayBuffer?e.buffer:e,a=new Int16Array(r),d=new Uint8Array(r),c=String.fromCharCode.apply(null,d.subarray(0,512));if(0==c.indexOf(":-)"))o.xStart=parseInt(c.substr(10,5)),o.yStart=parseInt(c.substr(15,5)),o.zStart=parseInt(c.substr(20,5)),o.xExtent=parseInt(c.substr(32,5)),o.yExtent=parseInt(c.substr(38,5)),o.zExtent=parseInt(c.substr(42,5)),o.xRate=parseInt(c.substr(52,5)),o.yRate=parseInt(c.substr(58,5)),o.zRate=parseInt(c.substr(62,5)),o.xlen=1*parseFloat(c.substr(73,10)),o.ylen=1*parseFloat(c.substr(83,10)),o.zlen=1*parseFloat(c.substr(93,10)),o.alpha=parseFloat(c.substr(103,10)),o.beta=parseFloat(c.substr(113,10)),o.gamma=parseFloat(c.substr(123,10)),l=parseFloat(c.substr(138,12))/100,n=parseInt(c.substr(155,8)),o.sigma=100*parseFloat(c.substr(170,12));else{if(100!==a[18])for(let e=0,t=a.length;e<t;++e){let t=a[e];a[e]=(255&t)<<8|t>>8&255}o.zStart=a[2],o.xStart=a[0],o.yStart=a[1],o.xExtent=a[3],o.yExtent=a[4],o.zExtent=a[5],o.xRate=a[6],o.yRate=a[7],o.zRate=a[8];let e=1/a[17],t=1*e;o.xlen=a[9]*t,o.ylen=a[10]*t,o.zlen=a[11]*t,o.alpha=a[12]*e,o.beta=a[13]*e,o.gamma=a[14]*e,l=a[15]/a[18],n=a[16]}let h=new Float32Array(o.xExtent*o.yExtent*o.zExtent),m=512,p=Math.ceil(o.xExtent/8),u=Math.ceil(o.yExtent/8),C=Math.ceil(o.zExtent/8);for(let e=0;e<C;++e)for(let t=0;t<u;++t)for(let s=0;s<p;++s)for(let i=0;i<8;++i){let r=8*e+i;for(let e=0;e<8;++e){let i=8*t+e;for(let e=0;e<8;++e){let t=8*s+e;if(!(t<o.xExtent&&i<o.yExtent&&r<o.zExtent)){m+=8-e;break}h[(t*o.yExtent+i)*o.zExtent+r]=(d[m]-n)/l,++m}}}"2fofc"==t?(i.mapData.header2=o,i.mapData.data2=h,i.mapData.matrix2=this.getMatrix(o),i.mapData.type2=t,i.mapData.sigma2=s):(i.mapData.header=o,i.mapData.data=h,i.mapData.matrix=this.getMatrix(o),i.mapData.type=t,i.mapData.sigma=s)}getMatrix(e){this.icn3d.icn3dui;let t=e,s=[t.xlen,0,0],i=[t.ylen*Math.cos(Math.PI/180*t.gamma),t.ylen*Math.sin(Math.PI/180*t.gamma),0],l=[t.zlen*Math.cos(Math.PI/180*t.beta),t.zlen*(Math.cos(Math.PI/180*t.alpha)-Math.cos(Math.PI/180*t.gamma)*Math.cos(Math.PI/180*t.beta))/Math.sin(Math.PI/180*t.gamma),0];l[2]=Math.sqrt(t.zlen*t.zlen*Math.sin(Math.PI/180*t.beta)*Math.sin(Math.PI/180*t.beta)-l[1]*l[1]);let n=[[],s,i,l],o=[0,t.xRate,t.yRate,t.zRate],r=[0,1,2,3],a=new THREE.Matrix4;return a.set(n[r[1]][0]/o[r[1]],n[r[2]][0]/o[r[2]],n[r[3]][0]/o[r[3]],0,n[r[1]][1]/o[r[1]],n[r[2]][1]/o[r[2]],n[r[3]][1]/o[r[3]],0,n[r[1]][2]/o[r[1]],n[r[2]][2]/o[r[2]],n[r[3]][2]/o[r[3]],0,0,0,0,1),a.multiply((new THREE.Matrix4).makeTranslation(t.xStart,t.yStart,t.zStart)),a}loadDsn6File(e){var t=this.icn3d,s=t.icn3dui;let i=this,l=$("#"+t.pre+"dsn6file"+e)[0].files[0],n=$("#"+t.pre+"dsn6sigma"+e).val();if(l){s.utilsCls.checkFileAPI();let t=new FileReader;t.onload=function(t){let s=i.icn3d,l=t.target.result;i.loadDsn6Data(l,e,n),"2fofc"==e?s.bAjax2fofc=!0:"fofc"==e&&(s.bAjaxfofc=!0),s.setOptionCls.setOption("map",e),s.icn3dui.htmlCls.clickMenuCls.setLogCmd("load dsn6 file "+$("#"+s.pre+"dsn6file"+e).val(),!1)},t.readAsArrayBuffer(l)}else alert("Please select a file before clicking 'Load'")}loadDsn6FileUrl(e){var t=this.icn3d;t.icn3dui;let s=$("#"+t.pre+"dsn6fileurl"+e).val(),i=$("#"+t.pre+"dsn6sigmaurl"+e).val();s?(this.dsn6ParserBase(s,e,i),t.icn3dui.htmlCls.clickMenuCls.setLogCmd("set map "+e+" sigma "+i+" | "+encodeURIComponent(s),!0)):alert("Please input the file URL before clicking 'Load'")}}class de{constructor(e){this.icn3d=e}loadScript(e,t){let s=this.icn3d;s.icn3dui,s.bCommandLoad=!0,s.bRender=!1,s.bStopRotate=!0,e=t?e.replace(/\+/g," "):e.replace(/\+/g," ").replace(/;/g,"\n");let i=[];s.commands.length>0&&(i[0]=s.commands[0]);let l=e.trim().split("\n");s.commands=l;let n=l[0].indexOf("command=");if(t&&-1!=n){let e=l[0].substr(0,n-1);s.commands.splice(0,1,e)}s.STATENUMBER=s.commands.length,s.commands=i.concat(s.commands),s.STATENUMBER=s.commands.length,s.CURRENTNUMBER=0,s.bReplay?this.replayFirstStep(s.CURRENTNUMBER):this.execCommands(s.CURRENTNUMBER,s.STATENUMBER-1,s.STATENUMBER)}execCommands(e,t,s){let i=this.icn3d;i.icn3dui,i.bRender=!1,i.reinitAfterLoad(),this.execCommandsBase(e,t,s)}execCommandsBase(e,t,s,i){let l,n=this.icn3d,o=n.icn3dui,r=this;for(l=e;l<=t;++l){let i=l===s-1;if(n.commands[l]){if(-1!==n.commands[l].indexOf("load"))return 0===t&&e===t?void(n.bNotLoadStructure?(n.hAtoms=o.hashUtilsCls.cloneHash(n.atoms),1===n.commands.length&&(n.bAddCommands=!0),i&&this.renderFinalStep(s)):$.when(r.applyCommandLoad(n.commands[l])).then((function(){1===n.commands.length&&(n.bAddCommands=!0),i&&r.renderFinalStep(s)}))):void(n.bNotLoadStructure?(n.hAtoms=o.hashUtilsCls.cloneHash(n.atoms),n.backForward&&this.renderFinalStep(1),this.execCommandsBase(l+1,t,s)):$.when(r.applyCommandLoad(n.commands[l])).then((function(){n.backForward&&r.renderFinalStep(1),r.execCommandsBase(l+1,t,s)})));if(0==n.commands[l].trim().indexOf("set map")&&-1==n.commands[l].trim().indexOf("set map wireframe")){let e=n.commands[l].split("|||"),i=e[0].trim().split(" | ")[0].substr(8).split(" ");if(3==i.length&&"sigma"==i[1]){i[2];let o=i[0];return void(("2fofc"!=o||void 0!==n.bAjax2fofc&&n.bAjax2fofc)&&("fofc"!=o||void 0!==n.bAjaxfofc&&n.bAjaxfofc)?(r.applyCommandMap(e[0].trim()),this.execCommandsBase(l+1,t,s)):$.when(r.applyCommandMap(e[0].trim())).then((function(){r.execCommandsBase(l+1,t,s)})))}}else if(0==n.commands[l].trim().indexOf("set emmap")&&-1==n.commands[l].trim().indexOf("set emmap wireframe")){let e=n.commands[l].split("|||"),i=e[0].trim().substr(10).split(" ");if(2==i.length&&"percentage"==i[0])return i[1],void(void 0!==n.bAjaxEm&&n.bAjaxEm?(r.applyCommandEmmap(e[0].trim()),this.execCommandsBase(l+1,t,s)):$.when(r.applyCommandEmmap(e[0].trim())).then((function(){r.execCommandsBase(l+1,t,s)})))}else{if(0==n.commands[l].trim().indexOf("set phi")){let e=n.commands[l].split("|||");return void $.when(n.delphiCls.applyCommandPhi(e[0].trim())).then((function(){r.execCommandsBase(l+1,t,s)}))}if(0==n.commands[l].trim().indexOf("set delphi")){let e=n.commands[l].split("|||");return void $.when(n.delphiCls.applyCommandDelphi(e[0].trim())).then((function(){r.execCommandsBase(l+1,t,s)}))}if(0==n.commands[l].trim().indexOf("view annotations")){let e=n.commands[l].split("|||");return void(Object.keys(n.proteins).length>0&&(void 0===n.bAjaxCddSite||!n.bAjaxCddSite)?$.when(r.applyCommandAnnotationsAndCddSite(e[0].trim())).then((function(){r.execCommandsBase(l+1,t,s)})):(Object.keys(n.proteins).length>0&&r.applyCommandAnnotationsAndCddSiteBase(e[0].trim()),this.execCommandsBase(l+1,t,s)))}if(0==n.commands[l].trim().indexOf("set annotation clinvar")){let e=n.commands[l].split("|||");return void(Object.keys(n.proteins).length>0&&(void 0===n.bAjaxClinvar||!n.bAjaxClinvar)?$.when(r.applyCommandClinvar(e[0].trim())).then((function(){r.execCommandsBase(l+1,t,s)})):(Object.keys(n.proteins).length>0&&r.applyCommandClinvar(e[0].trim()),this.execCommandsBase(l+1,t,s)))}if(0==n.commands[l].trim().indexOf("set annotation snp")){let e=n.commands[l].split("|||");return void(Object.keys(n.proteins).length>0&&(void 0===n.bAjaxSnp||!n.bAjaxSnp)?$.when(r.applyCommandSnp(e[0].trim())).then((function(){r.execCommandsBase(l+1,t,s)})):(Object.keys(n.proteins).length>0&&r.applyCommandSnp(e[0].trim()),this.execCommandsBase(l+1,t,s)))}if(0==n.commands[l].trim().indexOf("set annotation 3ddomain")){let e=n.commands[l].split("|||");return void(Object.keys(n.proteins).length>0&&void 0===n.mmdb_data&&(void 0===n.bAjax3ddomain||!n.bAjax3ddomain)?$.when(r.applyCommand3ddomain(e[0].trim())).then((function(){r.execCommandsBase(l+1,t,s)})):(Object.keys(n.proteins).length>0&&r.applyCommand3ddomain(e[0].trim()),this.execCommandsBase(l+1,t,s)))}if(0==n.commands[l].trim().indexOf("set annotation all")){let e=n.commands[l].split("|||");return void(!(Object.keys(n.proteins).length>0)||void 0!==n.bAjaxClinvar&&n.bAjaxClinvar||void 0!==n.bAjaxSnp&&n.bAjaxSnp||void 0!==n.bAjax3ddomain&&n.bAjax3ddomain&&void 0!==n.mmdb_data?!(Object.keys(n.proteins).length>0)||void 0!==n.bAjaxClinvar&&n.bAjaxClinvar||void 0!==n.bAjaxSnp&&n.bAjaxSnp?!(Object.keys(n.proteins).length>0)||void 0!==n.bAjaxClinvar&&n.bAjaxClinvar||void 0!==n.bAjax3ddomain&&n.bAjax3ddomain&&void 0!==n.mmdb_data?!(Object.keys(n.proteins).length>0)||void 0!==n.bAjax3ddomain&&n.bAjax3ddomain&&void 0!==n.mmdb_data||void 0!==n.bAjaxSnp&&n.bAjaxSnp?Object.keys(n.proteins).length>0&&(void 0===n.bAjaxClinvar||!n.bAjaxClinvar)?$.when(r.applyCommandClinvar(e[0].trim())).then((function(){n.annotationCls.setAnnoTabAll(),r.execCommandsBase(l+1,t,s)})):Object.keys(n.proteins).length>0&&(void 0===n.bAjaxSnp||!n.bAjaxSnp)?$.when(r.applyCommandSnp(e[0].trim())).then((function(){n.annotationCls.setAnnoTabAll(),r.execCommandsBase(l+1,t,s)})):Object.keys(n.proteins).length>0&&(void 0===n.bAjax3ddomain||!n.bAjax3ddomain||void 0===n.mmdb_data)?$.when(r.applyCommand3ddomain(e[0].trim())).then((function(){n.annotationCls.setAnnoTabAll(),r.execCommandsBase(l+1,t,s)})):(Object.keys(n.proteins).length>0&&(n.bAjaxClinvar&&r.applyCommandClinvarBase(e[0].trim()),n.bAjaxSnp&&r.applyCommandSnpBase(e[0].trim()),(n.bAjax3ddomain||void 0!==n.mmdb_data)&&r.applyCommand3ddomainBase(e[0].trim())),n.annotationCls.setAnnoTabAll(),this.execCommandsBase(l+1,t,s)):$.when(r.applyCommand3ddomain(e[0].trim())).then(r.applyCommandSnp(e[0].trim())).then((function(){n.annotationCls.setAnnoTabAll(),r.execCommandsBase(l+1,t,s)})):$.when(r.applyCommandClinvar(e[0].trim())).then(r.applyCommand3ddomain(e[0].trim())).then((function(){n.annotationCls.setAnnoTabAll(),r.execCommandsBase(l+1,t,s)})):$.when(r.applyCommandClinvar(e[0].trim())).then(r.applyCommandSnp(e[0].trim())).then((function(){n.annotationCls.setAnnoTabAll(),r.execCommandsBase(l+1,t,s)})):$.when(r.applyCommandClinvar(e[0].trim())).then(r.applyCommandSnp(e[0].trim())).then(r.applyCommand3ddomain(e[0].trim())).then((function(){n.annotationCls.setAnnoTabAll(),r.execCommandsBase(l+1,t,s)})))}if(0==n.commands[l].trim().indexOf("view interactions")&&void 0!==n.icn3dui.cfg.align){let e=n.commands[l].split("|||");return void(void 0!==n.b2DShown&&n.b2DShown?this.execCommandsBase(l+1,t,s):$.when(r.applyCommandViewinteraction(e[0].trim())).then((function(){r.execCommandsBase(l+1,t,s)})))}if(0==n.commands[l].trim().indexOf("symmetry")){n.bAxisOnly=!1;let e=n.commands[l].split("|||")[0].trim(),i=e.substr(e.indexOf(" ")+1);return n.symmetrytitle="none"===i?void 0:i,void("none"!==i&&void 0===n.symmetryHash?$.when(r.applyCommandSymmetry(e)).then((function(){n.drawCls.draw(),r.execCommandsBase(l+1,t,s)})):(n.drawCls.draw(),this.execCommandsBase(l+1,t,s)))}if(0==n.commands[l].trim().indexOf("symd symmetry")){n.bAxisOnly=!1;let e=n.commands[l].split("|||")[0].trim();return void $.when(n.symdCls.applyCommandSymd(e)).then((function(){n.drawCls.draw(),r.execCommandsBase(l+1,t,s)}))}if(0==n.commands[l].trim().indexOf("scap")){let e=n.commands[l].split("|||")[0].trim();return void $.when(n.scapCls.applyCommandScap(e)).then((function(){r.execCommandsBase(l+1,t,s)}))}if(0==n.commands[l].trim().indexOf("realign on seq align")){let e=n.commands[l].split("|||")[0].trim(),i=e.split(" | ");if(2==i.length){let e=i[1].split(",");n.hAtoms=n.definedSetsCls.getAtomsFromNameArray(e)}return void $.when(r.applyCommandRealign(e)).then((function(){r.execCommandsBase(l+1,t,s)}))}if(0==n.commands[l].trim().indexOf("graph interaction pairs")){let e=n.commands[l].split("|||")[0].trim();return void(void 0===n.bD3?$.when(r.applyCommandGraphinteraction(e)).then((function(){r.execCommandsBase(l+1,t,s)})):(this.applyCommandGraphinteraction(e),this.execCommandsBase(l+1,t,s)))}if(0==n.commands[l].trim().indexOf("cartoon 2d")){let e=n.commands[l].split("|||")[0].trim();return void(void 0===n.bD3?$.when(r.applyCommandCartoon2d(e)).then((function(){r.execCommandsBase(l+1,t,s)})):(this.applyCommandCartoon2d(e),this.execCommandsBase(l+1,t,s)))}n.applyCommandCls.applyCommand(n.commands[l])}}}(l===s||i)&&this.renderFinalStep(l)}pressCommandtext(){let e=this.icn3d,t=e.icn3dui,s=this;$("#"+e.pre+"logtext").keypress((function(e){let i=s.icn3d;if(i.bAddLogs=!1,13==(e.keyCode?e.keyCode:e.which)){e.preventDefault();let l=$(this).val();i.bRender=!0;let n=l.split("\n"),o=i.logs.length;for(let e=o,l=n.length;e<l;++e){let l=e==o?n[e].substr(2).trim():n[e].trim();if(""===l)continue;i.logs.push(l);let r={};if(r.factor=i._zoomFactor,r.mouseChange=i.mouseChange,r.quaternion=i.quaternion,i.commands.push(l+"|||"+i.transformCls.getTransformationStr(r)),i.optsHistory.push(t.hashUtilsCls.cloneHash(i.opts)),i.optsHistory[i.optsHistory.length-1].hlatomcount=Object.keys(i.hAtoms).length,t.utilsCls.isSessionStorageSupported()&&i.setStyleCls.saveCommandsToSession(),i.STATENUMBER=i.commands.length,-1!==l.indexOf("load"))s.applyCommandLoad(l);else if(-1!==l.indexOf("set map")&&-1===l.indexOf("set map wireframe"))s.applyCommandMap(l);else if(-1!==l.indexOf("set emmap")&&-1===l.indexOf("set emmap wireframe"))s.applyCommandEmmap(l);else if(-1!==l.indexOf("set phi"))i.delphiCls.applyCommandPhi(l);else if(-1!==l.indexOf("set delphi"))i.delphiCls.applyCommandDelphi(l);else if(0==l.indexOf("view annotations"))s.applyCommandAnnotationsAndCddSite(l);else if(0==l.indexOf("set annotation clinvar"))s.applyCommandClinvar(l);else if(0==l.indexOf("set annotation snp"))s.applyCommandSnp(l);else if(0==l.indexOf("set annotation 3ddomain"))s.applyCommand3ddomain(l);else if(0==l.indexOf("set annotation all"))$.when(s.applyCommandClinvar(l)).then(s.applyCommandSnp(l)).then(s.applyCommand3ddomain(l)),i.annotationCls.setAnnoTabAll();else if(0==l.indexOf("view interactions")&&void 0!==i.icn3dui.cfg.align)s.applyCommandViewinteraction(l);else if(0==l.indexOf("symmetry")){let e=l.substr(l.indexOf(" ")+1);i.symmetrytitle="none"===e?void 0:e,"none"!==e&&void 0===i.symmetryHash&&s.applyCommandSymmetry(l)}else if(0==l.indexOf("symd symmetry"))i.symdCls.applyCommandSymd(l);else if(0==l.indexOf("scap "))i.scapCls.applyCommandScap(l);else if(0==l.indexOf("realign on seq align")){let e=l.split(" | ");if(2==e.length){let t=e[1].split(",");i.hAtoms=i.definedSetsCls.getAtomsFromNameArray(t)}s.applyCommandRealign(l)}else 0==l.indexOf("graph interaction pairs")?s.applyCommandGraphinteraction(l):i.applyCommandCls.applyCommand(l+"|||"+i.transformCls.getTransformationStr(r))}i.selectionCls.saveSelectionIfSelected(),i.drawCls.draw(),$("#"+i.pre+"logtext").val("> "+i.logs.join("\n> ")+"\n> ").scrollTop($("#"+i.pre+"logtext")[0].scrollHeight)}i.bAddLogs=!0}))}applyCommandLoad(e){let t=this.icn3d;if(t.icn3dui,!(void 0!==t.atoms&&Object.keys(t.atoms).length>0))return t.deferred2=$.Deferred((function(){t.bAddCommands=!1;let s=e.split("|||")[0].replace(/\s\s/g," ").trim();if(-1!==s.indexOf("load")){let e=s.split(" | "),i=e[0];if(e.length>1){let s=e[e.length-1].indexOf(" ");t.icn3dui.cfg.inpara=e[e.length-1].substr(s+1),"undefined"===t.icn3dui.cfg.inpara&&(t.icn3dui.cfg.inpara="")}let l=i.substr(i.lastIndexOf(" ")+1);if(t.inputid=l,-1!==s.indexOf("load mmtf"))t.icn3dui.cfg.mmtfid=l,t.mmtfParserCls.downloadMmtf(l);else if(-1!==s.indexOf("load pdb"))t.icn3dui.cfg.pdbid=l,t.pdbParserCls.downloadPdb(l);else if(-1!==s.indexOf("load opm"))t.icn3dui.cfg.opmid=l,t.opmParserCls.downloadOpm(l);else if(-1!==s.indexOf("load mmcif"))t.icn3dui.cfg.mmcifid=l,t.mmcifParserCls.downloadMmcif(l);else if(-1!==s.indexOf("load mmdb"))t.icn3dui.cfg.mmdbid=l,t.mmdbParserCls.downloadMmdb(l);else if(-1!==s.indexOf("load gi"))t.icn3dui.cfg.gi=l,t.mmdbParserCls.downloadGi(l);else if(-1!==s.indexOf("load seq_struc_ids"))t.mmdbParserCls.downloadBlast_rep_id(l);else if(-1!==s.indexOf("load cid"))t.icn3dui.cfg.cid=l,t.sdfParserCls.downloadCid(l);else if(-1!==s.indexOf("load alignment"))t.icn3dui.cfg.align=l,t.alignParserCls.downloadAlignment(l);else if(-1!==s.indexOf("load chainalignment")){let e=s.split(" | ");-1!=e[1].indexOf("resnum")&&(t.icn3dui.cfg.resnum=e[1].substr(e[1].indexOf("resnum")+7)),t.icn3dui.cfg.chainalign=l,t.chainalignParserCls.downloadChainalignment(l,t.icn3dui.cfg.resnum)}else if(-1!==s.indexOf("load url")){let s=e[1],i=void 0!==s?s.indexOf("type "):-1,n="pdb";-1!==i&&(n=s.substr(i+5)),t.icn3dui.cfg.url=l,t.pdbParserCls.downloadUrl(l,n)}}t.bAddCommands=!0})),t.deferred2.promise()}applyCommandMap(e){let t=this.icn3d;t.icn3dui;let s=this;return t.deferredMap=$.Deferred((function(){let t=s.icn3d,i=e.split(" | "),l=i[0].substr(8).split(" ");if(3==l.length&&"sigma"==l[1]){let e=l[2],s=l[0];2==i.length?t.dsn6ParserCls.dsn6ParserBase(i[1],s,e):t.dsn6ParserCls.dsn6Parser(t.inputid,s,e)}})),t.deferredMap.promise()}applyCommandEmmap(e){let t=this.icn3d;t.icn3dui;let s=this;return t.deferredEmmap=$.Deferred((function(){let t=s.icn3d,i=e.substr(10).split(" ");if(2==i.length&&"percentage"==i[0]){let e=i[1],s="em";t.densityCifParserCls.densityCifParser(t.inputid,s,e,t.emd)}})),t.deferredEmmap.promise()}applyCommandSymmetryBase(e){let t=this.icn3d;t.icn3dui,t.symdCls.retrieveSymmetry(Object.keys(t.structures)[0])}applyCommandSymmetry(e){let t=this.icn3d;t.icn3dui;let s=this;return t.deferredSymmetry=$.Deferred((function(){s.applyCommandSymmetryBase(e)})),t.deferredSymmetry.promise()}applyCommandRealignBase(e){let t=this.icn3d;t.icn3dui,t.realignParserCls.realignOnSeqAlign()}applyCommandRealign(e){let t=this.icn3d;t.icn3dui;let s=this;return t.deferredRealign=new $.Deferred((function(){s.applyCommandRealignBase(e)})),t.deferredRealign.promise()}applyCommandGraphinteractionBase(e){let t=this.icn3d;t.icn3dui;let s=e.split(" | ");if(s.length>=3){let e,i=s[1].split(" "),l=i[0].split(","),n=i[1].split(","),o=-1!==s[2].indexOf("hbonds"),r=-1!==s[2].indexOf("salt bridge"),a=-1!==s[2].indexOf("interactions"),d=-1!==s[2].indexOf("halogen"),c=-1!==s[2].indexOf("pi-cation"),h=-1!==s[2].indexOf("pi-stacking");s.length>=4&&(e="true"==s[3]),t.applyCommandCls.setStrengthPara(s),t.viewInterPairsCls.viewInteractionPairs(l,n,e,"graph",o,r,a,d,c,h)}}applyCommandGraphinteraction(e){let t=this.icn3d;t.icn3dui;let s=this;return t.deferredGraphinteraction=$.Deferred((function(){s.applyCommandGraphinteractionBase(e)})),t.deferredGraphinteraction.promise()}applyCommandCartoon2dBase(e){let t=this.icn3d;t.icn3dui;let s=e.substr(e.lastIndexOf(" ")+1);t.cartoon2dCls.draw2Dcartoon(s)}applyCommandCartoon2d(e){let t=this.icn3d;t.icn3dui;let s=this;return t.deferredCartoon2d=$.Deferred((function(){s.applyCommandCartoon2dBase(e)})),t.deferredCartoon2d.promise()}applyCommandAnnotationsAndCddSiteBase(e){let t=this.icn3d;t.icn3dui,"view annotations"==e&&t.showAnnoCls.showAnnotations()}applyCommandAnnotationsAndCddSite(e){let t=this.icn3d;t.icn3dui;let s=this;return t.deferredAnnoCddSite=$.Deferred((function(){s.applyCommandAnnotationsAndCddSiteBase(e)})),t.deferredAnnoCddSite.promise()}applyCommandClinvarBase(e){let t=this.icn3d;t.icn3dui;let s=e.lastIndexOf(" ");e.substr(s+1),t.annotationCls.setAnnoTabClinvar()}applyCommandSnpBase(e){let t=this.icn3d;t.icn3dui;let s=e.lastIndexOf(" ");e.substr(s+1),t.annotationCls.setAnnoTabSnp()}applyCommandClinvar(e){let t=this.icn3d;t.icn3dui;let s=this;return t.deferredClinvar=$.Deferred((function(){s.applyCommandClinvarBase(e)})),t.deferredClinvar.promise()}applyCommandSnp(e){let t=this.icn3d;t.icn3dui;let s=this;return t.deferredSnp=$.Deferred((function(){s.applyCommandSnpBase(e)})),t.deferredSnp.promise()}applyCommand3ddomainBase(e){let t=this.icn3d;t.icn3dui;let s=e.lastIndexOf(" "),i=e.substr(s+1);"3ddomain"!=i&&"all"!=i||t.annotationCls.setAnnoTab3ddomain()}applyCommand3ddomain(e){let t=this.icn3d;t.icn3dui;let s=this;return t.deferred3ddomain=$.Deferred((function(){s.applyCommand3ddomainBase(e)})),t.deferred3ddomain.promise()}applyCommandViewinteractionBase(e){let t=this.icn3d;if(t.icn3dui,void 0!==t.icn3dui.cfg.align||void 0!==t.icn3dui.cfg.chainalign){let e=Object.keys(t.structures);t.ParserUtilsCls.set2DDiagramsForAlign(e[0].toUpperCase(),e[1].toUpperCase())}}applyCommandViewinteraction(e){let t=this.icn3d;t.icn3dui;let s=this;return t.deferredViewinteraction=$.Deferred((function(){s.applyCommandViewinteractionBase(e)})),t.deferredViewinteraction.promise()}renderFinalStep(e){let t=this.icn3d;t.icn3dui,t.bCommandLoad=!1,t.ParserUtilsCls.hideLoading(),e+1===t.commands.length&&(t.bAddCommands=!0),t.bRender=!0;let s=t.commands[e-1]?t.commands[e-1].split("|||"):[];if(2==s.length){let e=JSON.parse(s[1]);t._zoomFactor=e.factor,t.mouseChange.x=e.mouseChange.x,t.mouseChange.y=e.mouseChange.y,t.quaternion._x=e.quaternion._x,t.quaternion._y=e.quaternion._y,t.quaternion._z=e.quaternion._z,t.quaternion._w=e.quaternion._w}if(t.selectionCls.oneStructurePerWindow(),1===e||Object.keys(t.hAtoms).length===Object.keys(t.atoms).length||void 0!==t.optsHistory[e-1]&&t.optsHistory[e-1].hasOwnProperty("hlatomcount")&&t.optsHistory[e-1].hlatomcount===Object.keys(t.atoms).length)if(t.optsHistory.length>=e){let s=t.optsHistory[e-1].pk;"no"===s?t.pk=0:"atom"===s?t.pk=1:"residue"===s?t.pk=2:"strand"===s&&(t.pk=3),t.hlUpdateCls.updateHlAll(),t.drawCls.draw()}else t.hlUpdateCls.updateHlAll(),t.drawCls.draw();else t.hlUpdateCls.updateHlAll(),t.drawCls.draw();t.icn3dui.cfg.closepopup&&(setTimeout((function(){t.resizeCanvasCls.closeDialogs()}),100),t.resizeCanvasCls.resizeCanvas(t.icn3dui.htmlCls.WIDTH,t.icn3dui.htmlCls.HEIGHT,!0)),t.bTransparentSurface&&t.bRender&&t.drawCls.render(),void 0!==t.icn3dui.deferred&&t.icn3dui.deferred.resolve(),void 0!==t.deferred2&&t.deferred2.resolve()}replayFirstStep(e){let t=this.icn3d;t.icn3dui,t.reinitAfterLoad(),this.execCommandsBase(e,e,t.STATENUMBER);let s=t.commands[e],i=t.commands[e].indexOf("|");-1!=i&&(s=t.commands[e].substr(0,i));let l=s.length>20?s.substr(0,20)+"...":s,n=t.applyCommandCls.getMenuFromCmd(s);$("#"+t.pre+"replay_cmd").html("Cmd: "+l),$("#"+t.pre+"replay_menu").html("Menu: "+n),t.bCommandLoad=!1,t.ParserUtilsCls.hideLoading(),t.bRender=!0,t.drawCls.draw()}}class ce{constructor(e){this.icn3d=e}resizeCanvas(e,t,s,i){var l=this.icn3d;if(l.icn3dui,s||l.icn3dui.cfg.resize){let s=t;$("#"+l.pre+"canvas").width(e).height(s),$("#"+l.pre+"viewer").width(e).height(t),$("#"+l.divid+" div:has(#"+l.pre+"canvas)").width(e).height(s),l.applyCenterCls.setWidthHeight(e,s),(void 0===i||i)&&l.drawCls.draw()}}windowResize(){let e=this.icn3d,t=e.icn3dui,s=this;e.icn3dui.cfg.resize&&!t.utilsCls.isMobile()&&$(window).resize((function(){let e=s.icn3d;t.utilsCls.setViewerWidthHeight(e.icn3dui);let i=e.icn3dui.htmlCls.WIDTH,l=e.icn3dui.htmlCls.HEIGHT;void 0===e||e.bFullscreen||s.resizeCanvas(i,l)}))}openFullscreen(e){var t=this.icn3d;t.icn3dui,t.icn3dui.bNode||document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement||(e.requestFullscreen?e.requestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen&&e.msRequestFullscreen())}rotStruc(e,t){var s=this.icn3d;s.icn3dui;let i=this;if(s.bStopRotate)return!1;if(s.transformCls.rotateCount>s.transformCls.rotateCountMax)return s.transformCls.resetOrientation(),!1;if(++s.transformCls.rotateCount,t)if("left"===e)s.ROT_DIR="left";else if("right"===e)s.ROT_DIR="right";else if("up"===e)s.ROT_DIR="up";else{if("down"!==e)return!1;s.ROT_DIR="down"}if("left"===e&&"left"===s.ROT_DIR)s.transformCls.rotateLeft(1);else if("right"===e&&"right"===s.ROT_DIR)s.transformCls.rotateRight(1);else if("up"===e&&"up"===s.ROT_DIR)s.transformCls.rotateUp(1);else{if("down"!==e||"down"!==s.ROT_DIR)return!1;s.transformCls.rotateDown(1)}setTimeout((function(){i.rotStruc(e)}),100)}back(){var e=this.icn3d;e.icn3dui,e.backForward=!0,e.STATENUMBER--,e.bAddCommands=!1,e.bAddLogs=!1,e.bNotLoadStructure=!0,e.STATENUMBER<1?e.STATENUMBER=1:e.loadScriptCls.execCommands(0,e.STATENUMBER-1,e.STATENUMBER,!0),e.setStyleCls.adjustIcon(),e.bAddCommands=!0,e.bAddLogs=!0}forward(){var e=this.icn3d;e.icn3dui,e.backForward=!0,e.STATENUMBER++,e.bAddCommands=!1,e.bAddLogs=!1,e.bNotLoadStructure=!0,e.STATENUMBER>e.commands.length?e.STATENUMBER=e.commands.length:e.loadScriptCls.execCommands(0,e.STATENUMBER-1,e.STATENUMBER,!0),e.setStyleCls.adjustIcon(),e.bAddCommands=!0,e.bAddLogs=!0}replayon(){var e=this.icn3d;e.icn3dui,e.CURRENTNUMBER=0,e.bReplay=1,$("#"+e.pre+"replay").show(),e.commands.length>0&&e.loadScriptCls.replayFirstStep(e.CURRENTNUMBER)}replayoff(){var e=this.icn3d;e.icn3dui,e.bReplay=0,$("#"+e.pre+"replay").hide(),++e.CURRENTNUMBER,e.loadScriptCls.execCommands(e.CURRENTNUMBER,e.STATENUMBER-1,e.STATENUMBER)}closeDialogs(){var e=this.icn3d;e.icn3dui;let t=["dl_selectannotations","dl_alignment","dl_2ddgm","dl_definedsets","dl_graph","dl_linegraph","dl_scatterplot","dl_contactmap","dl_allinteraction","dl_copyurl","dl_symmetry","dl_symd"];for(let s in t){let i=t[s];e.icn3dui.cfg.notebook?$("#"+e.pre+i).hide():$("#"+e.pre+i).hasClass("ui-dialog-content")&&$("#"+e.pre+i).dialog("isOpen")&&$("#"+e.pre+i).dialog("close")}e.icn3dui.cfg.notebook||this.resizeCanvas(e.icn3dui.htmlCls.WIDTH,e.icn3dui.htmlCls.HEIGHT,!0)}}class he{constructor(e){this.icn3d=e}showSeq(e,t,s,i,l,n,o){let r=this.icn3d;r.icn3dui;let a,d=!1;if(void 0===r.icn3dui.cfg.mmdbid&&void 0===r.icn3dui.cfg.gi&&void 0===r.icn3dui.cfg.blast_rep_id&&void 0===r.icn3dui.cfg.align&&void 0===r.icn3dui.cfg.chainalign){d=!0,a=[];for(let t=0;t<r.giSeq[e].length;++t)a.push(r.chainsSeq[e][t])}else a=r.giSeq[e];let c=[];for(let e=0,t=a.length;e<t;++e)a[e]&&c.push(a[e]);a=c;let h=r.icn3dui.htmlCls.RESIDUE_WIDTH*r.giSeq[e].length+200,m=r.giSeq[e].length;m>r.maxAnnoLength&&(r.maxAnnoLength=m);let p=["giseq","cddsite","clinvar","snp","domain","interaction","custom","ssbond","crosslink","transmem"];for(let t in p){let s=p[t];$("#"+r.pre+s+"_"+e).length&&$("#"+r.pre+s+"_"+e).width(h)}let u,C="",g="",f="";if(C+='<div class="icn3d-dl_sequence">',f+='<div class="icn3d-dl_sequence">',r.giSeq[e].length>10){u='<div class="icn3d-residueLine" style="white-space:nowrap;">';let t=r.firstAtomObjCls.getFirstCalphaAtomObj(r.chains[e]);void 0===r.icn3dui.cfg.mmdbid&&void 0===r.icn3dui.cfg.gi&&void 0===r.icn3dui.cfg.blast_rep_id&&void 0===r.icn3dui.cfg.align&&void 0===r.icn3dui.cfg.chainalign||void 0===t.resi_ori||t.resi_ori==t.resi||-1!=e.indexOf("Misc")?u+='<div class="icn3d-annoTitle" anno="0"></div>':u+='<div class="icn3d-annoTitle" anno="0" title="NCBI Residue Numbers">NCBI Residue Numbers</div>',u+='<span class="icn3d-residueNum"></span>',f+=u+"<br>",C+=u+'<span class="icn3d-seqLine">';let s=0,i=0,l="";for(let t=0,n=a.length;t<n;++t){let n;C+=this.insertGap(e,t,"-"),n=d?a[t].resi:t>=r.matchedPos[e]&&t-r.matchedPos[e]<r.chainsSeq[e].length?r.chainsSeq[e][t-r.matchedPos[e]].resi:r.baseResi[e]+1+t,C+="<span>",n%10==0&&(C+=n);let o=e+"_"+n,c=n%10!=0&&n%10!=1&&n%10!=9;if(r.residues.hasOwnProperty(o)){let e=r.firstAtomObjCls.getFirstCalphaAtomObj(r.residues[o]);"H"==r.secondaries[o]&&e.ssbegin?(++s,l='<span class="icn3d-helix-color">H'+s+"</span>",c&&(C+=l,l="")):"E"==r.secondaries[o]&&e.ssbegin?(++i,"green"==r.sheetcolor?l='<span class="icn3d-sheet-color">S'+i+"</span>":"yellow"==r.sheetcolor&&(l='<span class="icn3d-sheet-colory">S'+i+"</span>"),c&&(C+=l,l="")):e.ssend&&(l=""),""!=l&&c&&(C+=l,l="")}C+="</span>"}C+='<span class="icn3d-residueNum"></span>',C+="</span>",C+="<br>",C+="</div>",f+="</div>"}u='<div class="icn3d-residueLine" style="white-space:nowrap;">',u+='<div class="icn3d-annoTitle" anno="0"></div>',u+='<span class="icn3d-residueNum"></span>',f+=u+"<br>",C+=u+'<span class="icn3d-seqLine">';for(let t=0,s=a.length;t<s;++t){C+=this.insertGap(e,t,"-");let s=e+"_"+(t>=r.matchedPos[e]&&t-r.matchedPos[e]<r.chainsSeq[e].length?r.chainsSeq[e][t-r.matchedPos[e]].resi:r.baseResi[e]+1+t);if(r.residues.hasOwnProperty(s))if("H"==r.secondaries[s])C+=t%2==0?'<span class="icn3d-helix">':'<span class="icn3d-helix2">',C+="&nbsp;</span>";else if("E"==r.secondaries[s]){r.firstAtomObjCls.getFirstCalphaAtomObj(r.residues[s]).ssend?"green"==r.sheetcolor?C+='<span class="icn3d-sheet2">':"yellow"==r.sheetcolor&&(C+='<span class="icn3d-sheet2y">'):"green"==r.sheetcolor?C+='<span class="icn3d-sheet">':"yellow"==r.sheetcolor&&(C+='<span class="icn3d-sheety">'),C+="&nbsp;</span>"}else"c"==r.secondaries[s]?C+='<span class="icn3d-coil">&nbsp;</span>':"o"==r.secondaries[s]&&(C+='<span class="icn3d-other">&nbsp;</span>');else C+="<span>-</span>"}C+='<span class="icn3d-residueNum"></span>',C+="</span>",C+="<br>",C+="</div>",C+="</div>",f+="</div></div>",u=r.icn3dui.cfg.blast_rep_id===e?'<div id="'+r.pre+'giseq_sequence" class="icn3d-dl_sequence" style="border: solid 1px #000;">':'<div id="'+r.pre+'giseq_sequence" class="icn3d-dl_sequence">';let b="Protein",y="Protein";void 0!==s&&("nucleotide"==s?(b="Nucl.",y="Nucleotide"):"chemical"==s&&(b="Chem.",y="Chemical")),u+='<div class="icn3d-seqTitle icn3d-link icn3d-blue" gi="'+e+'" anno="sequence" chain="'+e+'"><span style="white-space:nowrap;" title="'+y+" "+e+'">'+b+" "+e+"</span></div>",u+='<span class="icn3d-residueNum" title="starting protein sequence number">'+(r.baseResi[e]+1).toString()+"</span>",f+=u+"<br>";let v='<span class="icn3d-seqLine">';C+=u+v,g+=u+v;let w,S=0;for(let t=0,s=a.length;t<s;++t){C+=this.insertGap(e,t,"-"),void 0!==r.targetGapHash&&r.targetGapHash.hasOwnProperty(t)&&(S+=r.targetGapHash[t].to-r.targetGapHash[t].from+1);let s=d?a[t].name:a[t],i=s;if(s.length>1&&(i=s[0]+".."),w=t>=r.matchedPos[e]&&t-r.matchedPos[e]<r.chainsSeq[e].length?r.chainsSeq[e][t-r.matchedPos[e]].resi:r.baseResi[e]+1+t,r.residues.hasOwnProperty(e+"_"+w)){let l="333333";if(r.icn3dui.cfg.blast_rep_id==e&&void 0!==r.fullpos2ConsTargetpos&&void 0!==r.fullpos2ConsTargetpos[t+S])l=r.fullpos2ConsTargetpos[t+S].color;else{let t=r.firstAtomObjCls.getFirstCalphaAtomObj(r.residues[e+"_"+w]),s=void 0===t.color||"FFFFFF"===t.color.getHexString()?"DDDDDD":t.color.getHexString();l=void 0!==t.color?s:"CCCCCC"}C+='<span id="giseq_'+r.pre+e+"_"+w+'" title="'+s+w+'" class="icn3d-residue" style="color:#'+l+'">'+i+"</span>"}else i=i.toLowerCase(),C+='<span title="'+s+w+'" class="icn3d-residue">'+i+"</span>"}r.icn3dui.cfg.blast_rep_id==e&&(r.opts.color="conservation",r.setColorCls.setColorByOptions(r.opts,r.atoms));let _=r.firstAtomObjCls.getFirstCalphaAtomObj(r.chains[e]),A=_.color?_.color.getHexString():"CCCCCC",x=Math.round(r.seqAnnWidth*a.length/r.maxAnnoLength);if(x<1&&(x=1),r.icn3dui.cfg.blast_rep_id!=e)g+='<div id="giseq_summary_'+r.pre+e+'" class="icn3d-seqTitle icn3d-link" gi chain="'+e+'" style="display:inline-block; color:white; font-weight:bold; background-color:#'+A+"; width:"+x+'px;">'+e+"</div>";else{let t=[],s=[];t.push(0);for(let e=0,i=a.length;e<i;++e)void 0!==r.targetGapHash&&r.targetGapHash.hasOwnProperty(e)&&(s.push(e-1),t.push(e));s.push(a.length-1),g+='<div id="giseq_summary_'+r.pre+e+'" class="icn3d-seqTitle icn3d-link" gi chain="'+e+'" style="width:'+x+'px;">';for(let i=0,l=t.length;i<l;++i)g+=this.insertGapOverview(e,t[i]),g+='<div style="display:inline-block; color:white!important; font-weight:bold; background-color:#'+A+"; width:"+Math.round(r.seqAnnWidth*(s[i]-t[i]+1)/(r.maxAnnoLength+r.nTotalGap))+'px;" class="icn3d-seqTitle icn3d-link icn3d-blue" anno="sequence" gi chain="'+e+'" title="'+e+'">'+e+"</div>";g+="</div>"}if(u='<span class="icn3d-residueNum" title="ending protein sequence number">'+w+"</span>",u+="</span>",u+="<br>",C+=u,g+=u,r.icn3dui.cfg.blast_rep_id==e){if(void 0!==o&&""!==o){u='<div class="icn3d-seqTitle icn3d-link icn3d-blue" blast="" posarray="'+r.consrvResPosArray.toString()+'" title="'+l+'" setname="'+e+'_blast" anno="sequence" chain="'+e+'"><span style="white-space:nowrap;" title="'+l+'">'+l+"</span></div>",u+='<span class="icn3d-residueNum"></span>',f+=u+"<br>";let t='<span class="icn3d-seqLine">';C+=u+t,g+=u+t;let s=0,i=0,n=1;r.queryStart;for(let t=0,l=o.length;t<l;++t){let l=o[t];if("-"==l)C+="<span>-</span>";else if(" "==l)C+="<span> </span>";else{let o=r.fullpos2ConsTargetpos[t].pos;if(r.residues.hasOwnProperty(e+"_"+o)){let s=r.fullpos2ConsTargetpos[t].color;C+='<span id="giseq_'+r.pre+e+"_"+o+'" title="'+r.fullpos2ConsTargetpos[t].res+o+'" class="icn3d-residue" style="color:#'+s+'">'+l+"</span>"}else l=l.toLowerCase(),C+='<span class="icn3d-residue">'+l+"</span>";g+=this.insertGapOverview(e,t);let a=Math.round(r.seqAnnWidth*t/(r.maxAnnoLength+r.nTotalGap)-s-i);a>=0&&(g+='<div style="display:inline-block; width:'+a+'px;">&nbsp;</div>',g+='<div style="display:inline-block; background-color:#F00; width:'+n+'px;" title="'+l+o+'">&nbsp;</div>',s+=a,i+=n)}}u='<span class="icn3d-residueNum"></span>',u+="</span>",u+="<br>",C+=u,g+=u}u='<div class="icn3d-annoTitle" anno="sequence" chain="'+e+'"><span style="white-space:nowrap;" title="'+i+'">'+i+"</span></div>",u+='<span class="icn3d-residueNum" title="starting protein sequence number">'+r.queryStart+"</span>",f+=u+"<br>";let t='<span class="icn3d-seqLine" style="font-weight: bold;">';C+=u+t,g+=u+t;let s=r.queryStart;for(let t=0,i=n.length;t<i;++t){let i=n[t];" "==i||"-"==i?C+="<span>-</span>":(void 0===r.fullpos2ConsTargetpos||void 0===r.fullpos2ConsTargetpos[t]||r.residues.hasOwnProperty(e+"_"+r.fullpos2ConsTargetpos[t].pos)||(i=i.toLowerCase()),C+='<span title="'+i+s+'" class="icn3d-residue">'+i+"</span>",++s)}let a=r.firstAtomObjCls.getFirstCalphaAtomObj(r.chains[e]),d=void 0===a.color||"FFFFFF"===a.color.getHexString()?"DDDDDD":a.color.getHexString(),c=void 0!==a.color?d:"CCCCCC",h=[],m=[],p="-";for(let e=0,t=n.length;e<t;++e){let t=n[e];"-"!=t&&"-"==p?h.push(e):"-"==t&&"-"!=p&&m.push(e-1),p=t}"-"!=p&&m.push(n.length-1);for(let t=0,s=h.length;t<s;++t){g+='<div style="display:inline-block; width:'+(0==t?Math.round(r.seqAnnWidth*(h[t]-r.baseResi[e]-1)/(r.maxAnnoLength+r.nTotalGap)):Math.round(r.seqAnnWidth*(h[t]-m[t-1]-1)/(r.maxAnnoLength+r.nTotalGap)))+'px;">&nbsp;</div>',g+='<div style="display:inline-block; color:white!important; font-weight:bold; background-color:#'+c+"; width:"+Math.round(r.seqAnnWidth*(m[t]-h[t]+1)/(r.maxAnnoLength+r.nTotalGap))+'px;" anno="sequence" chain="'+e+'" title="'+i+'">'+i+"</div>"}u='<span class="icn3d-residueNum" title="ending protein sequence number">'+r.queryEnd+"</span>",u+="</span>",u+="<br>",C+=u,g+=u}if(C+="</div>",g+="</div>",f+="</div>",r.giSeq[e].length>10){let t=r.firstAtomObjCls.getFirstCalphaAtomObj(r.chains[e]);if((void 0!==r.icn3dui.cfg.mmdbid||void 0!==r.icn3dui.cfg.gi||void 0!==r.icn3dui.cfg.blast_rep_id||void 0!==r.icn3dui.cfg.align||void 0!==r.icn3dui.cfg.chainalign)&&void 0!==t.resi_ori&&t.resi_ori!=t.resi&&-1==e.indexOf("Misc")){u='<div class="icn3d-dl_sequence">',u+='<div class="icn3d-residueLine" style="white-space:nowrap;">',u+='<div class="icn3d-annoTitle" anno="0" title="PDB Residue Numbers">PDB Residue Numbers</div>',u+='<span class="icn3d-residueNum"></span>',f+=u+"<br>",C+=u+'<span class="icn3d-seqLine">';for(let t=0,s=a.length;t<s;++t)if(C+=this.insertGap(e,t,"-"),t>=r.matchedPos[e]&&t-r.matchedPos[e]<r.chainsSeq[e].length){let s=e+"_"+r.chainsSeq[e][t-r.matchedPos[e]].resi;if(r.residues.hasOwnProperty(s)){let e=r.firstAtomObjCls.getFirstCalphaAtomObj(r.residues[s]).resi_ori;C+="<span>",e%10==0&&(C+=e+" "),C+="</span>"}else C+="<span></span>"}else C+="<span></span>";C+='<span class="icn3d-residueNum"></span>',C+="</span>",C+="<br>",C+="</div>",C+="</div>",f+="</div></div>"}}$("#"+r.pre+"dt_giseq_"+e).html(C),$("#"+r.pre+"ov_giseq_"+e).html(g),$("#"+r.pre+"tt_giseq_"+e).html(f)}insertGap(e,t,s,i){let l=this.icn3d;l.icn3dui;let n="";if(void 0!==l.targetGapHash&&l.targetGapHash.hasOwnProperty(t))for(let e=0;e<l.targetGapHash[t].to-l.targetGapHash[t].from+1;++e)n+=i?s:"<span>"+s+"</span>";return n}insertGapOverview(e,t){let s=this.icn3d;s.icn3dui;let i="";if(s.icn3dui.cfg.blast_rep_id==e&&void 0!==s.targetGapHash&&s.targetGapHash.hasOwnProperty(t)){i+='<div style="display:inline-block; background-color:#333; width:'+s.seqAnnWidth*(s.targetGapHash[t].to-s.targetGapHash[t].from+1)/(s.maxAnnoLength+s.nTotalGap)+'px; height:3px;">&nbsp;</div>'}return i}setAlternativeSeq(e,t){let s=this.icn3d;s.icn3dui;let i=s.chainsSeq[e];s.giSeq[e]=[];for(let t=0,l=i.length;t<l;++t){let l=i[t].name;s.giSeq[e][t]=l}s.matchedPos[e]=0,s.baseResi[e]=s.chainsSeq[e][0].resi-s.matchedPos[e]-1}getProteinName(e){let t=this.icn3d;t.icn3dui;let s="";if(void 0===t.icn3dui.cfg.mmdbid&&void 0===t.icn3dui.cfg.gi&&void 0===t.icn3dui.cfg.blast_rep_id||void 0===t.mmdb_data)(void 0!==t.icn3dui.cfg.align||void 0!==t.icn3dui.cfg.chainalign||t.bRealign||t.bSymd)&&void 0!==t.chainid2title&&void 0!==t.chainid2title[e]&&(s=t.chainid2title[e]);else{let i=t.mmdb_data.moleculeInfor,l=e.substr(e.indexOf("_")+1);for(let e in i)if(i[e].chain==l){s=i[e].name.replace(/\'/g,"&prime;");break}}return s}}class me{constructor(e){this.icn3d=e}clickAddTrackButton(){let e=this.icn3d,t=e.icn3dui,s=this;t.myEventCls.onIds("#"+e.pre+"addtrack_button1","click",(function(e){let t=s.icn3d;e.stopImmediatePropagation(),dialog.dialog("close");let i=$("#"+t.pre+"track_chainid").val(),l=$("#"+t.pre+"track_gi").val(),n=isNaN(l)?"Acc "+l:"gi "+l;$.ajax({url:"https://www.ncbi.nlm.nih.gov/Structure/pwaln/pwaln.fcgi?from=track",type:"POST",data:{targets:i,queries:l},dataType:"jsonp",tryCount:0,retryLimit:1,success:function(e){s.alignSequenceToStructure(i,e,n)},error:function(e,t,s){this.tryCount++,this.tryCount<=this.retryLimit&&$.ajax(this)}})})),t.myEventCls.onIds("#"+e.pre+"addtrack_button2","click",(function(e){let t=s.icn3d;e.stopImmediatePropagation(),dialog.dialog("close");let i=$("#"+t.pre+"track_chainid").val(),l=$("#"+t.pre+"track_fasta").val(),n=$("#"+t.pre+"fasta_title").val();$.ajax({url:"https://www.ncbi.nlm.nih.gov/Structure/pwaln/pwaln.fcgi?from=track",type:"POST",data:{targets:i,queries:l},dataType:"jsonp",tryCount:0,retryLimit:1,success:function(e){s.alignSequenceToStructure(i,e,n)},error:function(e,t,s){this.tryCount++,this.tryCount<=this.retryLimit&&$.ajax(this)}})})),t.myEventCls.onIds("#"+e.pre+"addtrack_button2b","click",(function(e){let t=s.icn3d;e.stopImmediatePropagation(),dialog.dialog("close");let i=$("#"+t.pre+"track_chainid").val(),l=$("#"+t.pre+"fasta_startpos").val(),n="identity"==$("#"+t.pre+"colorseqby").val()?"identity":"custom",o=$("#"+t.pre+"track_fastaalign").val().split(">"),r=o[1].indexOf("\n");o[1].substr(0,r);let a,d=o[1].substr(r+1).replace(/\n/g,""),c=[],h=[];for(let e=2,t=o.length;e<t;++e){let t=o[e].indexOf("\n"),s=o[e].substr(0,t);c.push(s);let i=o[e].substr(t+1).replace(/\n/g,"");h.push(i)}for(let e=0,s=t.giSeq[i].length;e<s;++e){(e>=t.matchedPos[i]&&e-t.matchedPos[i]<t.chainsSeq[i].length?t.chainsSeq[i][e-t.matchedPos[i]].resi:t.baseResi[i]+1+e)==l&&(a=e)}void 0===a&&alert('Please double check the start position before clicking "Add Track"'),t.targetGapHash={};let m,p,u="-",C=0,g=0,f=0,b=!1,y=0,v=0;for(let e=0,s=d.length;e<s;++e)"-"==d[e]&&d[e]!=u&&(m=g,f=0),"-"==u&&d[e]!=u&&g>0&&(p=C,t.targetGapHash[m+a]={from:m+a,to:p+f-1+a}),u=d[e],C=g,"-"!=d[e]?(++g,v=e,b||(y=e,b=!0)):++f;t.annotationCls.resetAnnoAll();let w="",S=0;for(let e in t.targetGapHash)S>0&&(w+=" "),w+=e+"_"+t.targetGapHash[e].from+"_"+t.targetGapHash[e].to,++S;t.icn3dui.htmlCls.clickMenuCls.setLogCmd("msa | "+w,!0);let _={};for(let e=0,o=h.length;e<o;++e){let o=l,r="";for(let e=0;e<a;++e){if(t.targetGapHash.hasOwnProperty(e))for(let s=0;s<t.targetGapHash[e].to-t.targetGapHash[e].from+1;++s)r+="-";r+="-"}for(let t=y;t<=v;++t)0==e&&(_[o]=0),r+=h[e][t],"-"!=d[t]&&(d[t]==h[e][t]&&++_[o],++o);let m=c[e].length<20?c[e]:c[e].substr(0,20)+"...",p=!0;s.showNewTrack(i,m,r,void 0,void 0,n,void 0,p),t.icn3dui.htmlCls.clickMenuCls.setLogCmd("add track | chainid "+i+" | title "+m+" | text "+s.simplifyText(r)+" | type "+n+" | color 0 | msa 1",!0)}if(h.length>0){void 0===t.queryresi2score&&(t.queryresi2score={}),void 0===t.queryresi2score[i]&&(t.queryresi2score[i]={});let e=h.length;for(let s in _){let l=parseInt(_[s]/e*100);t.queryresi2score[i][s]=l}let s=Object.keys(_),l=Math.min.apply(null,s),n=Math.max.apply(null,s),o="";for(let t=l;t<=n;++t)_.hasOwnProperty(t)?o+=Math.round(_[t]/e*9):o+="_";t.opts.color="align custom",t.setColorCls.setColorByOptions(t.opts,t.hAtoms),t.hlUpdateCls.updateHlAll(),t.drawCls.draw(),t.icn3dui.htmlCls.clickMenuCls.setLogCmd("color align custom | "+i+" | range "+l+"_"+n+" | "+o,!0)}})),t.myEventCls.onIds("#"+e.pre+"addtrack_button3","click",(function(e){let t=s.icn3d;e.stopImmediatePropagation(),dialog.dialog("close");let i=$("#"+t.pre+"track_chainid").val(),l=$("#"+t.pre+"track_bed")[0].files[0];if(l){window.File&&window.FileReader&&window.FileList&&window.Blob||alert("The File APIs are not fully supported in this browser.");let e=new FileReader;e.onload=function(e){let l,n=e.target.result.split("\n"),o=!1,r=!1;for(let e=0,a=n.length;e<a;++e)if("browser"!=n[e].substr(0,7))if("track"==n[e].substr(0,5)){if(-1!=n[e].toLowerCase().indexOf("itemrgb")&&(o=!0),-1!=n[e].toLowerCase().indexOf("colorbystrand=")){r=!0;let t=n[e].toLowerCase().indexOf("colorbystrand="),s=n[e].substr(t),i=s.indexOf('"');if(-1!=i){let e=s.substr(i+1),t=e.indexOf('"');if(-1!=i){l=e.substr(0,t).split(" ")}}}}else{if(""==n[e])continue;let a=n[e].replace(/\s+/g," ").split(" ");(a.length>8||a.length<6)&&(r=!1),a.length<9&&(o=!1),a[0];let d,c,h=a[1],m=a[2],p=a[3];a.length>4&&a[4],a.length>5&&(d=a[5]),a.length>6&&a[6],a.length>7&&a[7],a.length>8&&(c=a[8]),a.length>9&&a[9],a.length>10&&a[10],a.length>11&&a[11];let u=p,C="51,51,51";o?C=c:r&&("+"==d&&l.length>0?C=l[0]:"-"==d&&l.length>1?C=l[1]:"."==d&&l.length>2&&(C=l[2]));let g="",f=[];for(let e=0,s=m;e<s;++e)e<h?(g+="-",f.push("")):(g+=t.giSeq[i][e],f.push("rgb("+C+")"));s.showNewTrack(i,u,g,f,void 0,void 0,C),t.icn3dui.htmlCls.clickMenuCls.setLogCmd("add track | chainid "+i+" | title "+u+" | text "+s.simplifyText(g)+" | type bed | color "+C,!0)}},e.readAsText(l)}else alert("Please select a file...")})),t.myEventCls.onIds("#"+e.pre+"addtrack_button4","click",(function(e){let t=s.icn3d;e.stopImmediatePropagation(),dialog.dialog("close");let i=$("#"+t.pre+"track_chainid").val(),l=$("#"+t.pre+"track_title").val(),n=$("#"+t.pre+"track_text").val(),o=this.getFullText(n);s.showNewTrack(i,l,o.text,void 0,void 0,"custom",void 0,void 0,o.fromArray,o.toArray),t.icn3dui.htmlCls.clickMenuCls.setLogCmd("add track | chainid "+i+" | title "+l+" | text "+n+" | type custom",!0)})),t.myEventCls.onIds("#"+e.pre+"addtrack_button5","click",(function(e){let i=s.icn3d;e.stopImmediatePropagation(),dialog.dialog("close");let l=$("#"+i.pre+"track_chainid").val(),n=$("#"+i.pre+"track_selection").val(),o="",r=t.hashUtilsCls.intHash(i.hAtoms,i.chains[l]),a=i.firstAtomObjCls.getResiduesFromCalphaAtoms(r),d=[];for(let e=0,t=i.giSeq[l].length;e<t;++e){let t=i.giSeq[l][e],s=t;t.length>1&&(s=t[0]);let n=e>=i.matchedPos[l]&&e-i.matchedPos[l]<i.chainsSeq[l].length?i.chainsSeq[l][e-i.matchedPos[l]].resi:i.baseResi[l]+1+e;if(a.hasOwnProperty(l+"_"+n)){let e=i.firstAtomObjCls.getFirstCalphaAtomObj(i.residues[l+"_"+n]),t=void 0===e.color||"FFFFFF"===e.color.getHexString().toUpperCase()?"DDDDDD":e.color.getHexString(),r=void 0!==e.color?t:"CCCCCC";o+=s,d.push("#"+r)}else o+="-",d.push("")}s.showNewTrack(l,n,o,d,void 0,"selection",void 0),i.icn3dui.htmlCls.clickMenuCls.setLogCmd("add track | chainid "+l+" | title "+n+" | text "+s.simplifyText(o)+" | type selection",!0)}))}showNewTrack(e,t,s,i,l,n,o,r,a,d){let c=this.icn3d;c.icn3dui;let h=!1;"cannot be aligned"==s&&(h=!0);let m=s.replace(/-/g,"").length;if(!r)if(s.length>c.giSeq[e].length)s=s.substr(0,c.giSeq[e].length);else if(s.length<c.giSeq[e].length&&!h){let t="";for(let i=0,l=c.giSeq[e].length-s.length;i<l;++i)t+="-";s+=t}let p=t.replace(/\s/g,"_").replace(/\./g,"dot").replace(/\W/g,"");p.length>20&&(p=p.substr(0,20));let u=c.icn3dui.htmlCls.RESIDUE_WIDTH*s.length+200;$("#"+c.pre+"dt_custom_"+e).append("<div id='"+c.pre+"dt_custom_"+e+"_"+p+"'></div>"),$("#"+c.pre+"dt_custom_"+e+"_"+p).width(u),$("#"+c.pre+"ov_custom_"+e).append("<div id='"+c.pre+"ov_custom_"+e+"_"+p+"'></div>"),$("#"+c.pre+"ov_custom_"+e+"_"+p).width(u),$("#"+c.pre+"tt_custom_"+e).append("<div id='"+c.pre+"tt_custom_"+e+"_"+p+"'></div>"),$("#"+c.pre+"tt_custom_"+e+"_"+p).width(u);let C='<div id="'+c.pre+'giseq_sequence" class="icn3d-dl_sequence">',g=C,f=C,b=parseInt(10*Math.random()),y='<div class="icn3d-seqTitle icn3d-link icn3d-blue" custom="'+(b+1).toString()+'" from="'+a+'" to="'+d+'" shorttitle="'+p+'" index="'+b+'" setname="'+e+"_custom_"+(b+1).toString()+'" anno="sequence" chain="'+e+'" title="'+t+'">'+p+" </div>",v='<span class="icn3d-residueNum" title="residue count">'+m.toString()+" Pos</span>";f+=y+v+"<br>";let w='<span class="icn3d-seqLine">';C+=y+v+w,g+=y+v+w;let S=e.indexOf("_"),_="cst"+e.substr(S+1),A=0,x=0,k=(void 0===n||"seq"===n||"custom"===n)&&-1==s.indexOf("cannot-be-aligned")&&-1==s.indexOf("cannot be aligned"),O="identity"===n&&-1==s.indexOf("cannot-be-aligned")&&-1==s.indexOf("cannot be aligned"),H={},R=0,E=1;y="";for(let t=0,n=s.length;t<n;++t){let n=t-R;r?c.targetGapHash.hasOwnProperty(n)&&!H.hasOwnProperty(n)&&(R+=c.targetGapHash[n].to-c.targetGapHash[n].from+1,H[n]=1):C+=c.showSeqCls.insertGap(e,t,"-");let a=s.charAt(t);if(" "!=a&&"-"!=a){let s,r=c.chainsSeq[e][n]?c.chainsSeq[e][n].name:" ",d=c.showAnnoCls.getColorhexFromBlosum62(a,r),h=a==r?"FF0000":"0000FF",m=E;void 0!==l&&(m=l[t]+1),s=void 0!==i&&""!=i[t]?'style="color:'+i[t]+'"':o?'style="color:rgb('+o+')"':k?'style="color:#'+d+'"':O?'style="color:#'+h+'"':"",C+='<span id="'+_+"_"+c.pre+e+"_"+m+'" title="'+a+m+'" class="icn3d-residue" '+s+">"+a+"</span>",y+=c.showSeqCls.insertGapOverview(e,t);let p=c.icn3dui.cfg.blast_rep_id==e?Math.round(c.seqAnnWidth*t/(c.maxAnnoLength+c.nTotalGap)-A-x):Math.round(c.seqAnnWidth*t/c.maxAnnoLength-A-x);p<0&&(p=0),y+='<div style="display:inline-block; width:'+p+'px;">&nbsp;</div>',s=void 0!==i&&""!=i[t]?i[t]:o?"rgb("+o+")":k?"#"+d:"#333",y+='<div style="display:inline-block; background-color:'+s+'; width:1px;" title="'+a+(t+1).toString()+'">&nbsp;</div>',A+=p,x+=1,++E}else C+=h?"<span>"+a+"</span>":"<span>-</span>"}if(void 0!==a){y="";let s=[],i=[];for(let e=0,t=a.length;e<t;++e){s.push(a[e]);for(let t=a[e];t<=d[e];++t)void 0!==c.targetGapHash&&c.targetGapHash.hasOwnProperty(t)&&(i.push(t-1),s.push(t));i.push(d[e])}c.nTotalGap=0;for(let e in c.targetGapHash)c.nTotalGap+=c.targetGapHash[e].to-c.targetGapHash[e].from+1;let l=c.firstAtomObjCls.getFirstCalphaAtomObj(c.chains[e]),n=void 0===l.color||"FFFFFF"===l.color.getHexString()?"DDDDDD":l.color.getHexString(),o=void 0!==l.color?n:"CCCCCC";for(let l=0,n=s.length;l<n;++l){y+=c.showSeqCls.insertGapOverview(e,s[l]),y+='<div style="display:inline-block; width:'+(0==l?Math.round(c.seqAnnWidth*(s[l]-c.baseResi[e]-1)/(c.maxAnnoLength+c.nTotalGap)):Math.round(c.seqAnnWidth*(s[l]-i[l-1]-1)/(c.maxAnnoLength+c.nTotalGap)))+'px;">&nbsp;</div>',y+='<div style="display:inline-block; color:white!important; font-weight:bold; background-color:#'+o+"; width:"+Math.round(c.seqAnnWidth*(i[l]-s[l]+1)/(c.maxAnnoLength+c.nTotalGap))+'px;" class="icn3d-seqTitle icn3d-link icn3d-blue" custom="'+(b+1).toString()+'" from="'+s+'" to="'+i+'" shorttitle="'+p+'" index="'+b+'" setname="'+e+"_custom_"+(b+1).toString()+'" id="'+e+"_custom_"+b+'" anno="sequence" chain="'+e+'" title="'+t+'">'+t+"</div>"}}w='<span class="icn3d-residueNum" title="residue count">'+m.toString()+" Pos</span>",w+="</span>",w+="<br>",w+="</div>",C+=w,g+=y+w,f+="</div>",$("#"+c.pre+"dt_custom_"+e+"_"+p).html(C),$("#"+c.pre+"ov_custom_"+e+"_"+p).html(g),$("#"+c.pre+"tt_custom_"+e+"_"+p).html(f)}alignSequenceToStructure(e,t,s){let i,l,n=this.icn3d,o=n.icn3dui;void 0!==t.data&&(i=t.data[0].query,l=t.data[0].targets[e],l=l.hsps[0]);let r="";if(void 0!==i&&void 0!==l){let a=l.scores.e_value.toPrecision(2);a>1e-200&&(a=parseFloat(a).toExponential()),l.scores.bit_score;let d=t.targets[e].seqdata,c=i.seqdata,h=l.segs,m={};for(let e=0,t=h.length;e<t;++e){let t=h[e];for(let e=0;e<=t.orito-t.orifrom;++e)m[e+t.orifrom]=e+t.from}for(let t=0,s=d.length;t<s;++t)if(m.hasOwnProperty(t)){r+=c[m[t]];let s=n.showAnnoCls.getColorhexFromBlosum62(d[t],c[m[t]]),i=t+1;for(let t in n.residues[e+"_"+i]){let e=o.parasCls.thr("#"+s);n.atoms[t].color=e,n.atomPrevColors[t]=e}}else r+="-";s+=", E: "+a}else r+="cannot be aligned";this.showNewTrack(e,s,r,cssColorArray,target2queryHash,"seq"),n.hlUpdateCls.updateHlAll(),n.drawCls.draw(),n.icn3dui.htmlCls.clickMenuCls.setLogCmd("add track | chainid "+e+" | title "+s+" | text "+this.simplifyText(r)+" | type seq",!0)}defineSecondary(e,t){let s=this.icn3d;s.icn3dui,$("#"+s.pre+"dl_definedsets").hasClass("ui-dialog-content")&&$("#"+s.pre+"dl_definedsets").dialog("isOpen")||(s.icn3dui.htmlCls.dialogCls.openDlg("dl_definedsets","Select sets"),$("#"+s.pre+"atomsCustom").resizable());let i,l,n={},o=!1,r=!0,a=0,d=0,c=e+"_C(Nterm";s.hAtoms={};for(let h=0,m=s.chainsSeq[e].length;h<m;++h){let m=e+"_"+s.chainsSeq[e][h].resi;if(s.residues.hasOwnProperty(m)){let h=s.firstAtomObjCls.getFirstCalphaAtomObj(s.residues[m]),p=s.secondaries[m];"H"==p?(h.ssbegin&&(++a,Object.keys(n).length>0&&(l=i+"H"+a+")","coil"==t&&(s.selectionCls.selectResidueList(n,l,l,o,r),o||(o=!0)),n={})),i=e+"_H"+a,n[m]=1,h.ssend&&(c=e+"_C(H"+a,"helix"==t&&(s.selectionCls.selectResidueList(n,i,i,o,r),o||(o=!0)),n={})):"E"==p?(h.ssbegin&&(++d,Object.keys(n).length>0&&(l=i+"S"+d+")","coil"==t&&(s.selectionCls.selectResidueList(n,l,l,o,r),o||(o=!0)),n={})),i=e+"_S"+d,n[m]=1,h.ssend&&(c=e+"_C(S"+d,"sheet"==t&&(s.selectionCls.selectResidueList(n,i,i,o,r),o||(o=!0)),n={})):(i=c+"-",n[m]=1)}}Object.keys(n).length>0&&(l=i+"Cterm)","coil"==t&&s.selectionCls.selectResidueList(n,l,l,o,r))}simplifyText(e){this.icn3d.icn3dui;let t,s,i="",l=!1,n=-1;for(t=0,s=e.length;t<s;++t)"-"==e[t]||" "==e[t]?(l&&t!==n&&(i+=n+1==t-1?(n+1+1).toString()+" "+e.substr(n+1,t-1-n)+", ":(n+1+1).toString()+"-"+(t-1+1).toString()+" "+e.substr(n+1,t-1-n)+", ",l=!1),n=t):l=!0;return l&&t==s&&(i+=n+1==t-1?(n+1+1).toString()+" "+e.substr(n+1,t-1-n)+", ":(n+1+1).toString()+"-"+(t-1+1).toString()+" "+e.substr(n+1,t-1-n)+", "),i}checkGiSeq(e,t,s,i,l,n,o){let r=this.icn3d;r.icn3dui;let a=this;if(o>20)return!1;if(void 0!==r.giSeq&&void 0!==r.giSeq[e]){let o=this.getFullText(s);return s=o.text,this.showNewTrack(e,t,s,void 0,void 0,i,l,n),!1}setTimeout((function(){a.checkGiSeq(e,t,s,i,l,n,o+1)}),100)}getFullText(e){this.icn3d.icn3dui;let t="",s=[],i=[],l=e.split(","),n=-1;for(let e=0,o=l.length;e<o;++e){let o=l[e].trim();if(0==o.length)continue;let r=o.split(" ");if(2!==r.length)continue;let a,d,c=r[1],h=r[0].split("-");if(2==h.length)a=h[0]-1,d=h[1]-1;else{if(1!=h.length)continue;a=h[0]-1,d=a}s.push(a),i.push(d);for(let e=0;e<a-n-1;++e)t+="-";let m=d-a+1;c.length>m?t+=c.substr(0,m):t+=c;for(let e=0;e<m-c.length;++e)t+="-";n=d}return{text:t,fromArray:s,toArray:i}}setCustomFile(e,t,s,i){var l=this.icn3d,n=l.icn3dui;let o=this,r=$("#"+l.pre+"customcolor_chainid").val(),a=$("#"+l.pre+"cstcolorfile")[0].files[0];if(a){n.utilsCls.checkFileAPI();let l=new FileReader;l.onload=function(l){let a=o.icn3d,d=l.target.result.split("\n");void 0===a.queryresi2score&&(a.queryresi2score={}),a.queryresi2score[r]={};for(let e=0,t=d.length;e<t;++e)if(""!==d[e].trim()){let t=d[e].split(/\s+/);a.queryresi2score[r][t[0]]=t[1]}let c=Object.keys(a.queryresi2score[r]),h=Math.min.apply(null,c),m=Math.max.apply(null,c),p="";for(let e=h;e<=m;++e)a.queryresi2score[r].hasOwnProperty(e)?p+=Math.round(a.queryresi2score[r][e]/11):p+="_";if("color"==e){a.opts.color="align custom",a.setColorCls.setColorByOptions(a.opts,a.hAtoms),a.hlUpdateCls.updateHlAll(),a.icn3dui.htmlCls.clickMenuCls.setLogCmd("color align custom | "+r+" | range "+h+"_"+m+" | "+p+" | colorrange "+t+" "+s+" "+i,!0);let e=n.htmlCls.clickMenuCls.setLegendHtml();$("#"+n.pre+"legend").html(e)}else"tube"==e&&(a.setOptionCls.setStyle("proteins","custom tube"),a.icn3dui.htmlCls.clickMenuCls.setLogCmd("color tube | "+r+" | range "+h+"_"+m+" | "+p,!0));a.drawCls.draw()},l.readAsText(a)}else alert("Please select a file before clicking 'Load'")}}class pe{constructor(e){this.icn3d=e}calculateArea(){var e=this.icn3d;e.icn3dui,e.bCalcArea=!0,e.opts.surface="solvent accessible surface",e.applyMapCls.applySurfaceOptions(),$("#"+e.pre+"areavalue").val(e.areavalue),$("#"+e.pre+"areatable").html(e.areahtml),e.icn3dui.htmlCls.dialogCls.openDlg("dl_area","Surface area calculation"),e.bCalcArea=!1}calcBuriedSurface(e,t){var s=this.icn3d,i=s.icn3dui;if(0==e.length)alert("Please select the first set");else{let l=i.hashUtilsCls.cloneHash(s.hAtoms),n=s.definedSetsCls.getAtomsFromNameArray(e),o=s.definedSetsCls.getAtomsFromNameArray(t);s.bCalcArea=!0,s.opts.surface="solvent accessible surface",s.hAtoms=i.hashUtilsCls.cloneHash(n),s.applyMapCls.applySurfaceOptions();let r=s.areavalue,a=i.hashUtilsCls.cloneHash(s.resid2area);s.hAtoms=i.hashUtilsCls.cloneHash(o),s.applyMapCls.applySurfaceOptions();let d=s.areavalue,c=i.hashUtilsCls.cloneHash(s.resid2area);s.hAtoms=i.hashUtilsCls.unionHash(s.hAtoms,n),s.applyMapCls.applySurfaceOptions();let h=s.areavalue,m=i.hashUtilsCls.cloneHash(s.resid2area),p=0,u=0,C=0,g=0;for(let e in a)m.hasOwnProperty(e)&&(g+=parseFloat(m[e]));u=(r-g).toFixed(2);for(let e in c)m.hasOwnProperty(e)&&(C+=parseFloat(m[e]));p=(d-C).toFixed(2),s.bCalcArea=!1,s.hAtoms=i.hashUtilsCls.cloneHash(l);let f=(parseFloat(d)+parseFloat(r)-parseFloat(h)).toFixed(2),b="<br>Calculate solvent accessible surface area in the interface:<br><br>";b+="Set 1: "+e+", Surface: "+r+" &#8491;<sup>2</sup><br>",b+="Set 2: "+t+", Surface: "+d+" &#8491;<sup>2</sup><br>",b+="Total Surface: "+h+" &#8491;<sup>2</sup><br>",b+="<b>Buried Surface for Set 1</b>: "+u+" &#8491;<sup>2</sup><br>",b+="<b>Buried Surface for Set 2</b>: "+p+" &#8491;<sup>2</sup><br><br>",$("#"+s.pre+"dl_buriedarea").html(b),s.icn3dui.htmlCls.dialogCls.openDlg("dl_buriedarea","Buried solvent accessible surface area in the interface"),s.icn3dui.htmlCls.clickMenuCls.setLogCmd("buried surface "+f,!1)}}measureDistTwoSets(e,t){var s=this.icn3d,i=s.icn3dui;if(0==e.length||0==t.length)alert("Please select two sets");else{let l=i.hashUtilsCls.cloneHash(s.hAtoms),n=s.definedSetsCls.getAtomsFromNameArray(e),o=s.definedSetsCls.getAtomsFromNameArray(t),r=s.contactCls.getExtent(n),a=s.contactCls.getExtent(o),d=new THREE.Vector3(r[2][0],r[2][1],r[2][2]),c=new THREE.Vector3(a[2][0],a[2][1],a[2][2]);s.hAtoms=i.hashUtilsCls.cloneHash(l),void 0===s.distPnts&&(s.distPnts=[]),s.distPnts.push(d),s.distPnts.push(c);let h=$("#"+s.pre+"distancecolor2").val();this.addLine(d.x,d.y,d.z,c.x,c.y,c.z,h,!0,"distance");let m=0,p=0,u=d.clone().add(c).multiplyScalar(.5),C=(parseInt(10*d.distanceTo(c))/10).toString()+" A";this.addLabel(C,u.x,u.y,u.z,m,h,p,"distance"),s.drawCls.draw()}}addLine(e,t,s,i,l,n,o,r,a){var d=this.icn3d;d.icn3dui;let c={};c.position1=new THREE.Vector3(e,t,s),c.position2=new THREE.Vector3(i,l,n),c.color=o,c.dashed=r,void 0===d.lines[a]&&(d.lines[a]=[]),void 0!==a?d.lines[a].push(c):d.lines.custom.push(c),d.hlObjectsCls.removeHlObjects()}addLineFromPicking(e){var t=this.icn3d;t.icn3dui;let s=$("#"+t.pre+e+"color").val();t.pAtom.coord.x,t.pAtom2.coord.x,t.pAtom.coord.y,t.pAtom2.coord.y,t.pAtom.coord.z,t.pAtom2.coord.z;let i="stabilizer"!=e;t.icn3dui.htmlCls.clickMenuCls.setLogCmd("add line | x1 "+t.pAtom.coord.x.toPrecision(4)+" y1 "+t.pAtom.coord.y.toPrecision(4)+" z1 "+t.pAtom.coord.z.toPrecision(4)+" | x2 "+t.pAtom2.coord.x.toPrecision(4)+" y2 "+t.pAtom2.coord.y.toPrecision(4)+" z2 "+t.pAtom2.coord.z.toPrecision(4)+" | color "+s+" | dashed "+i+" | type "+e,!0),this.addLine(t.pAtom.coord.x,t.pAtom.coord.y,t.pAtom.coord.z,t.pAtom2.coord.x,t.pAtom2.coord.y,t.pAtom2.coord.z,s,i,e),t.pickpair=!1}addLabel(e,t,s,i,l,n,o,r){var a=this.icn3d;a.icn3dui;let d={};"0"!==l&&""!==l&&"undefined"!==l||(l=void 0),"0"!==n&&""!==n&&"undefined"!==n||(n=void 0),"0"!==o&&""!==o&&"undefined"!==o||(o=void 0);let c=new THREE.Vector3;c.x=t,c.y=s,c.z=i,d.position=c,d.text=e,d.size=l,d.color=n,d.background=o,void 0===a.labels[r]&&(a.labels[r]=[]),void 0!==r?a.labels[r].push(d):a.labels.custom.push(d),a.hlObjectsCls.removeHlObjects()}addChainLabels(e){var t=this.icn3d;let s=t.icn3dui.hashUtilsCls.intHash(t.hAtoms,e);void 0===t.labels.chain&&(t.labels.chain=[]);let i=t.firstAtomObjCls.getChainsFromAtoms(s);for(let e in i){let s={};s.position=t.applyCenterCls.centerAtoms(t.chains[e]).center;let i=e.indexOf("_"),l=e.substr(i+1),n=t.showSeqCls.getProteinName(e);n.length>20&&(n=n.substr(0,20)+"..."),s.text="Chain "+l+": "+n,s.size=18;let o=t.firstAtomObjCls.getFirstCalphaAtomObj(t.chains[e]).color.getHexString().toUpperCase();s.color="CCCCCC"===o||"C8C8C8"===o?"#888888":"#"+o,s.background="#CCCCCC",t.labels.chain.push(s)}t.hlObjectsCls.removeHlObjects()}addTerminiLabels(e){var t=this.icn3d,s=t.icn3dui;let i,l="#CCCCCC";i=s.hashUtilsCls.unionHash(i,t.proteins),i=s.hashUtilsCls.unionHash(i,t.nucleotides);let n=s.hashUtilsCls.intHash(t.dAtoms,i),o=s.hashUtilsCls.intHash(n,e);void 0===t.labels.chain&&(t.labels.chain=[]);let r=t.firstAtomObjCls.getChainsFromAtoms(o);for(let e in r){let i=s.hashUtilsCls.intHash(n,t.chains[e]),o=Object.keys(i),r=t.atoms[o[0]],a=t.atoms[o[o.length-1]],d={},c={};d.position=r.coord,c.position=a.coord,d.text="N-",c.text="C-",t.nucleotides.hasOwnProperty(r.serial)&&(d.text="5'",c.text="3'"),d.size=18,c.size=18;let h=r.color.getHexString().toUpperCase(),m=a.color.getHexString().toUpperCase();d.color="CCCCCC"===h||"C8C8C8"===h?"#888888":"#"+h,c.color="CCCCCC"===m||"C8C8C8"===m?"#888888":"#"+m,d.background=l,c.background=l,t.labels.chain.push(d),t.labels.chain.push(c)}t.hlObjectsCls.removeHlObjects()}}class ue{constructor(e){this.icn3d=e}showCddSiteAll(){let e=this.icn3d;e.icn3dui;let t=this;e.chainid2pssmid={};let s=$.map(e.protein_chainid,(function(e){return e})),i=Object.keys(e.protein_chainid),l=e.icn3dui.htmlCls.baseUrl+"cdannots/cdannots.fcgi?fmt&queries="+s;$.ajax({url:l,dataType:"jsonp",cache:!0,tryCount:0,retryLimit:1,success:function(s){let l={};for(let n=0,o=s.data.length;n<o;++n){let o=s.data[n];o._id;let r=i[n];l[r]=1;let a='<div id="'+e.pre+r+'_cddseq_sequence" class="icn3d-cdd icn3d-dl_sequence">',d=a,c=a,h=o.doms,m=t.setDomainFeature(h,r,!0,a,d,c);e.chainid2pssmid[r]={pssmid2name:m.pssmid2name,pssmid2fromArray:m.pssmid2fromArray,pssmid2toArray:m.pssmid2toArray};let p=m.acc2domain;a=m.html+"</div>",d=m.html2+"</div>",c=m.html3+"</div>",$("#"+e.pre+"dt_cdd_"+r).html(a),$("#"+e.pre+"ov_cdd_"+r).html(d),$("#"+e.pre+"tt_cdd_"+r).html(c),a='<div id="'+e.pre+r+'_siteseq_sequence" class="icn3d-dl_sequence">',d=a,c=a;let u=o.motifs;m=t.setDomainFeature(u,r,!1,a,d,c,p),a=m.html,d=m.html2,c=m.html3;let C=s.data[n].sites,g=void 0!==C?C.length:0;for(let s=0;s<g;++s){C[s].srcdom,C[s].type;let i=C[s].sz,l="site: "+C[s].title;l.length>17&&(l=l.substr(0,17)+"...");let n,o=C[s].title,h=[];for(let i=0,l=C[s].locs.length;i<l;++i){n=C[s].locs[i].coords;for(let s=0,i=n.length;s<i;++s)h.push(t.getAdjustedResi(Math.round(n[s]),r,e.matchedPos,e.chainsSeq,e.baseResi)-1)}let m='<div class="icn3d-seqTitle icn3d-link icn3d-blue" site="site" posarray="'+h.toString()+'" shorttitle="'+l+'" setname="'+r+"_site_"+s+'" anno="sequence" chain="'+r+'" title="'+o+'">'+l+" </div>",p='<span class="icn3d-residueNum" title="residue count">'+i.toString()+" Res</span>",u='<span class="icn3d-seqLine">';c+=m+p+"<br>",a+=m+p+u,d+=m+p+u;let g="site"+s.toString(),f=0,b=0,y=1;for(let s=0,i=e.giSeq[r].length;s<i;++s)if(a+=e.showSeqCls.insertGap(r,s,"-"),-1!=n.indexOf(s)){let i=e.giSeq[r][s],l=i;i.length>1&&(l=i[0]+"..");let n=t.getAdjustedResi(s,r,e.matchedPos,e.chainsSeq,e.baseResi);a+='<span id="'+g+"_"+e.pre+r+"_"+n+'" title="'+l+n+'" class="icn3d-residue">'+i+"</span>",d+=e.showSeqCls.insertGapOverview(r,s);let o=e.icn3dui.cfg.blast_rep_id==r?Math.round(e.seqAnnWidth*s/(e.maxAnnoLength+e.nTotalGap)-f-b):Math.round(e.seqAnnWidth*s/e.maxAnnoLength-f-b);o>=0&&(d+='<div style="display:inline-block; width:'+o+'px;">&nbsp;</div>',d+='<div style="display:inline-block; background-color:#000; width:'+y+'px;" title="'+l+n+'">&nbsp;</div>',f+=o,b+=y)}else a+="<span>-</span>";u='<span class="icn3d-residueNum" title="residue count">&nbsp;'+i.toString()+" Residues</span>",u+="</span>",u+="<br>",a+=u,d+=u}a+="</div>",d+="</div>",c+="</div>",$("#"+e.pre+"dt_site_"+r).html(a),$("#"+e.pre+"ov_site_"+r).html(d),$("#"+e.pre+"tt_site_"+r).html(c)}for(let t in e.protein_chainid)l.hasOwnProperty(t)||($("#"+e.pre+"dt_cdd_"+t).html(""),$("#"+e.pre+"ov_cdd_"+t).html(""),$("#"+e.pre+"tt_cdd_"+t).html(""),$("#"+e.pre+"dt_site_"+t).html(""),$("#"+e.pre+"ov_site_"+t).html(""),$("#"+e.pre+"tt_site_"+t).html(""));e.showAnnoCls.enableHlSeq(),e.bAjaxCddSite=!0,void 0!==e.deferredAnnoCddSite&&e.deferredAnnoCddSite.resolve()},error:function(t,i,l){if(this.tryCount++,this.tryCount<=this.retryLimit)$.ajax(this);else{console.log("No CDD data were found for the protein "+s+"...");for(let t in e.protein_chainid)$("#"+e.pre+"dt_cdd_"+t).html(""),$("#"+e.pre+"ov_cdd_"+t).html(""),$("#"+e.pre+"tt_cdd_"+t).html(""),$("#"+e.pre+"dt_site_"+t).html(""),$("#"+e.pre+"ov_site_"+t).html(""),$("#"+e.pre+"tt_site_"+t).html("");e.showAnnoCls.enableHlSeq(),e.bAjaxCddSite=!0,void 0!==e.deferredAnnoCddSite&&e.deferredAnnoCddSite.resolve()}}})}setDomainFeature(e,t,s,i,l,n,o){let r=this.icn3d;r.icn3dui;let a,d,c,h=this;s&&(o={},a={},d={},c={});let m=void 0!==e?e.length:0,p=s?14:19,u=s?100:120;for(let C=0;C<m;++C){let m=s?e[C].pssmid:0,g=s?e[C].acc:e[C].srcdom,f=e[C].type;f=s?"domain":"feat";let b=s?e[C].title.split(":")[0]:e[C].title;b=b.replace(/\"/g,"``"),b=b.replace(/'/g,"`"),s&&(o[g]=b);let y=s?e[C].defline:"",v=f+": "+b;v.length>p&&(v=v.substr(0,p)+"...");let w=f+": "+b;s&&(a[m]=b);let S=e[C].locs;if(S)for(let e=0,o=S.length;e<o;++e){let o=[],a=[],p={},_=0,A=s?S[e].segs:[S[e]];for(let e=0,s=A.length;e<s;++e){let s=Math.round(A[e].from),i=Math.round(A[e].to);o.push(h.getAdjustedResi(s,t,r.matchedPos,r.chainsSeq,r.baseResi)-1),a.push(h.getAdjustedResi(i,t,r.matchedPos,r.chainsSeq,r.baseResi)-1);for(let e=s;e<=i;++e)p[e]=1;_+=i-s+1}let x=t+"_"+b;s||(x+="_"+C+"_"+e),s&&(d[m]=o),s&&(c[m]=a);let k='<div class="icn3d-seqTitle icn3d-link icn3d-blue" '+f+'="'+g+'" from="'+o+'" to="'+a+'" shorttitle="'+v+'" setname="'+x+'" anno="sequence" chain="'+t+'" title="'+w+'">'+v+" </div>",O='<span class="icn3d-residueNum" title="residue count">'+_.toString()+" Res</span>";n+=k+O+"<br>";let H='<span class="icn3d-seqLine">';i+=k+O+H,s&&(l+='<div style="width:20px; display:inline-block;"><span id="'+r.pre+t+"_"+g+"_"+e+'_cddseq_expand" class="ui-icon ui-icon-plus icn3d-expand icn3d-link" style="width:15px;" title="Expand"></span><span id="'+r.pre+t+"_"+g+"_"+e+'_cddseq_shrink" class="ui-icon ui-icon-minus icn3d-shrink icn3d-link" style="display:none; width:15px;" title="Shrink"></span></div>'),l+='<div style="width:'+u+'px!important;" class="icn3d-seqTitle icn3d-link icn3d-blue" '+f+'="'+g+'" from="'+o+'" to="'+a+'" shorttitle="'+v+'" index="'+C+'" setname="'+x+'" anno="sequence" chain="'+t+'" title="'+w+'">'+v+" </div>",l+=O+H;let R=f+C.toString();for(let e=0,s=r.giSeq[t].length;e<s;++e)if(i+=r.showSeqCls.insertGap(t,e,"-"),p.hasOwnProperty(e)){let s=r.giSeq[t][e],l=s;s.length>1&&(l=s[0]+"..");let n=h.getAdjustedResi(e,t,r.matchedPos,r.chainsSeq,r.baseResi);i+='<span id="'+R+"_"+r.pre+t+"_"+n+'" title="'+l+n+'" class="icn3d-residue">'+s+"</span>"}else i+="<span>-</span>";let E=r.firstAtomObjCls.getFirstCalphaAtomObj(r.chains[t]),I=void 0===E.color||"FFFFFF"===E.color.getHexString()?"DDDDDD":E.color.getHexString(),D=void 0!==E.color?I:"CCCCCC";if(r.icn3dui.cfg.blast_rep_id!=t)for(let s=0,i=o.length;s<i;++s){l+='<div style="display:inline-block; width:'+(0==s?Math.round(r.seqAnnWidth*(o[s]-r.baseResi[t]-1)/r.maxAnnoLength):Math.round(r.seqAnnWidth*(o[s]-a[s-1]-1)/r.maxAnnoLength))+'px;">&nbsp;</div>',l+='<div style="display:inline-block; color:white!important; font-weight:bold; background-color:#'+D+"; width:"+Math.round(r.seqAnnWidth*(a[s]-o[s]+1)/r.maxAnnoLength)+'px;" class="icn3d-seqTitle icn3d-link icn3d-blue" domain="'+(C+1).toString()+'" from="'+o+'" to="'+a+'" shorttitle="'+v+'" index="'+C+'" setname="'+x+'" id="'+t+"_domain_"+C+"_"+e+'" anno="sequence" chain="'+t+'" title="'+w+'">'+b+" </div>"}else{let s=[],i=[];for(let e=0,t=o.length;e<t;++e){s.push(o[e]);for(let t=o[e];t<=a[e];++t)void 0!==r.targetGapHash&&r.targetGapHash.hasOwnProperty(t)&&(i.push(t-1),s.push(t));i.push(a[e])}for(let n=0,o=s.length;n<o;++n){l+=r.showSeqCls.insertGapOverview(t,s[n]),l+='<div style="display:inline-block; width:'+(0==n?Math.round(r.seqAnnWidth*(s[n]-r.baseResi[t]-1)/(r.maxAnnoLength+r.nTotalGap)):Math.round(r.seqAnnWidth*(s[n]-i[n-1]-1)/(r.maxAnnoLength+r.nTotalGap)))+'px;">&nbsp;</div>',l+='<div style="display:inline-block; color:white!important; font-weight:bold; background-color:#'+D+"; width:"+Math.round(r.seqAnnWidth*(i[n]-s[n]+1)/(r.maxAnnoLength+r.nTotalGap))+'px;" class="icn3d-seqTitle icn3d-link icn3d-blue" domain="'+(C+1).toString()+'" from="'+s+'" to="'+i+'" shorttitle="'+v+'" index="'+C+'" setname="'+x+'" id="'+t+"_domain_"+C+"_"+e+'" anno="sequence" chain="'+t+'" title="'+w+'">'+b+" </div>"}}H='<span class="icn3d-residueNum" title="residue count">&nbsp;'+_.toString()+" Residues</span>",H+="</span>",H+="<br>",i+=H,l+=H,s&&(l+='<div id="'+r.pre+t+"_"+g+"_"+e+'_cddseq" style="display:none; white-space:normal;" class="icn3d-box">'+y+'(<a href="'+r.icn3dui.htmlCls.baseUrl+"cdd/cddsrv.cgi?uid="+g+'" target="_blank" class="icn3d-blue">open details view...</a>)</div>')}}return{html:i,html2:l,html3:n,acc2domain:o,pssmid2name:a,pssmid2fromArray:d,pssmid2toArray:c}}getAdjustedResi(e,t,s,i,l){let n=this.icn3d;return n.icn3dui,e>=s[t]&&e-s[t]<n.chainsSeq[t].length?n.chainsSeq[t][e-s[t]].resi:l[t]+1+e}showAnnoType(e,t,s,i,l,n){let o=this.icn3d;o.icn3dui;let r='<div id="'+o.pre+e+"_"+s+'seq_sequence" class="icn3d-dl_sequence">',a=r,d=r;if(0==l.length)return $("#"+o.pre+"dt_"+s+"_"+e).html(""),$("#"+o.pre+"ov_"+s+"_"+e).html(""),void $("#"+o.pre+"tt_"+s+"_"+e).html("");let c=i;i.length>17&&(i=i.substr(0,17)+"...");let h=[];for(let e=0,t=l.length;e<t;++e){let t=l[e],s=Math.round(t.substr(l[e].lastIndexOf("_")+1));h.push(s)}let m=h.length,p=s,u='<div class="icn3d-seqTitle icn3d-link icn3d-blue" '+s+'="" posarray="'+h.toString()+'" shorttitle="'+i+'" setname="'+e+"_"+p+'" anno="sequence" chain="'+e+'" title="'+c+'">'+i+" </div>",C='<span class="icn3d-residueNum" title="residue count">'+m.toString()+" Res</span>";d+=u+C+"<br>";let g='<span class="icn3d-seqLine">';r+=u+C+g,a+=u+C+g;let f=s,b=0,y=0;for(let t=0,i=o.giSeq[e].length;t<i;++t)if(r+=o.showSeqCls.insertGap(e,t,"-"),-1!=h.indexOf(t+1+o.baseResi[e])){let i=o.giSeq[e][t],l=i;i.length>1&&(l=i[0]+"..");let d=t>=o.matchedPos[e]&&t-o.matchedPos[e]<o.chainsSeq[e].length?o.chainsSeq[e][t-o.matchedPos[e]].resi:o.baseResi[e]+1+t,c=e+"_"+(t+1+o.baseResi[e]).toString(),h=i+(t+1+o.baseResi[e]).toString();if("ssbond"==s){if(h="Residue "+c+" has disulfide bond with",void 0!==n[c])for(let e=0,t=n[c].length;e<t;++e)h+=" residue "+n[c][e]}else if("crosslink"==s&&(h="Residue "+c+" has cross-linkage with",void 0!==n[c]))for(let e=0,t=n[c].length;e<t;++e)h+=" residue "+n[c][e];r+='<span id="'+f+"_"+o.pre+e+"_"+d+'" title="'+h+'" class="icn3d-residue">'+l+"</span>",a+=o.showSeqCls.insertGapOverview(e,t);let m=o.icn3dui.cfg.blast_rep_id==e?Math.round(o.seqAnnWidth*t/(o.maxAnnoLength+o.nTotalGap)-b-y):Math.round(o.seqAnnWidth*t/o.maxAnnoLength-b-y);m>=0&&(a+='<div style="display:inline-block; width:'+m+'px;">&nbsp;</div>',a+='<div style="display:inline-block; background-color:#000; width:1px;" title="'+h+'">&nbsp;</div>',b+=m,y+=1)}else r+="<span>-</span>";g='<span class="icn3d-residueNum" title="residue count">&nbsp;'+m.toString()+" Residues</span>",g+="</span>",g+="<br>",r+=g,a+=g,r+="</div>",a+="</div>",d+="</div>",$("#"+o.pre+"dt_"+s+"_"+e).html(r),$("#"+o.pre+"ov_"+s+"_"+e).html(a),$("#"+o.pre+"tt_"+s+"_"+e).html(d)}setToolTip(){let e=this.icn3d;e.icn3dui,$("[id^="+e.pre+"snp]").add("[id^="+e.pre+"clinvar]").add("[id^="+e.pre+"ssbond]").add("[id^="+e.pre+"crosslink]").tooltip({content:function(){return $(this).prop("title")},show:null,close:function(e,t){t.tooltip.hover((function(){$(this).stop(!0).fadeTo(400,1)}),(function(){$(this).fadeOut("400",(function(){$(this).remove()}))}))}})}}class Ce{constructor(e){this.icn3d=e}showSsbond(e,t){let s=this.icn3d;s.icn3dui;let i=this;void 0===s.ssbondpnts?setTimeout((function(){i.showSsbond_base(e,t)}),1e3):this.showSsbond_base(e,t)}showSsbond_base(e,t){let s=this.icn3d;s.icn3dui;let i=t,l={},n=i.substr(0,i.indexOf("_")),o=s.ssbondpnts[n];if(void 0===o)return $("#"+s.pre+"dt_ssbond_"+e).html(""),$("#"+s.pre+"ov_ssbond_"+e).html(""),void $("#"+s.pre+"tt_ssbond_"+e).html("");for(let e=0,t=o.length;e<t;e+=2){let t=o[e],s=o[e+1],n=t.substr(0,t.lastIndexOf("_")),r=s.substr(0,s.lastIndexOf("_"));i===n&&(void 0===l[t]&&(l[t]=[]),l[t].push(s)),i===r&&(void 0===l[s]&&(l[s]=[]),l[s].push(t))}let r=Object.keys(l);s.annoCddSiteCls.showAnnoType(e,t,"ssbond","Disulfide Bonds",r,l)}}class ge{constructor(e){this.icn3d=e}showPicking(e,t,s){let i=this.icn3d,l=i.icn3dui;if(void 0!==i.icn3dui.cfg.cid&&0!=i.pk&&(i.pk=1),i.highlightlevel=i.pk,this.showPickingBase(e,t,s),0!=i.pk)if(void 0!==t&&void 0!==s){null!=i.icn3dui.cfg.showmenu&&1==i.icn3dui.cfg.showmenu&&(s+=i.icn3dui.htmlCls.MENU_HEIGHT);let l=1==i.pk?e.resn+e.resi+"@"+e.name:e.resn+e.resi;void 0!==i.structures&&Object.keys(i.structures).length>1?(l=e.structure+"_"+e.chain+" "+l,$("#"+i.pre+"popup").css("width","140px")):$("#"+i.pre+"popup").css("width","80px"),$("#"+i.pre+"popup").html(l),$("#"+i.pre+"popup").css("top",s).css("left",t+20).show()}else{i.hlUpdateCls.updateHlAll();let t={};t.factor=i._zoomFactor,t.mouseChange=i.mouseChange,t.quaternion={},t.quaternion._x=parseFloat(i.quaternion._x).toPrecision(5),t.quaternion._y=parseFloat(i.quaternion._y).toPrecision(5),t.quaternion._z=parseFloat(i.quaternion._z).toPrecision(5),t.quaternion._w=parseFloat(i.quaternion._w).toPrecision(5),i.bAddCommands&&(i.commands.push("pickatom "+e.serial+"|||"+i.transformCls.getTransformationStr(t)),i.optsHistory.push(l.hashUtilsCls.cloneHash(i.opts)),i.optsHistory[i.optsHistory.length-1].hlatomcount=Object.keys(i.hAtoms).length,l.utilsCls.isSessionStorageSupported()&&i.setStyleCls.saveCommandsToSession(),i.STATENUMBER=i.commands.length),i.logs.push("pickatom "+e.serial+"(chain: "+e.structure+"_"+e.chain+", residue: "+e.resn+", number: "+e.resi+", atom: "+e.name+")"),$("#"+i.pre+"logtext").length&&$("#"+i.pre+"logtext").val("> "+i.logs.join("\n> ")+"\n> ").scrollTop($("#"+i.pre+"logtext")[0].scrollHeight),i.bSphereCalc=!1,i.bHbondCalc=!1}}showPickingBase(e,t,s){this.icn3d.icn3dui,void 0===t&&void 0===s&&this.showPickingHilight(e)}showPickingHilight(e){let t=this.icn3d,s=t.icn3dui;if(t.bShift||t.bCtrl||t.hlObjectsCls.removeHlObjects(),t.pickedAtomList={},1===t.pk)t.pickedAtomList[e.serial]=1;else if(2===t.pk){let s=e.structure+"_"+e.chain+"_"+e.resi;t.pickedAtomList=t.residues[s]}else if(3===t.pk)t.pickedAtomList=this.selectStrandHelixFromAtom(e);else if(4===t.pk)t.pickedAtomList=this.select3ddomainFromAtom(e);else if(5===t.pk){let s=e.structure+"_"+e.chain;t.pickedAtomList=t.chains[s]}0===t.pk?t.bShowHighlight=!1:t.bShowHighlight=!0;let i=Object.keys(t.hAtoms).length==Object.keys(t.atoms).length?{}:s.hashUtilsCls.intHash(t.hAtoms,t.pickedAtomList),l=Object.keys(i).length;if(t.bShift||t.bCtrl)if(t.bShift){if(void 0===t.prevPickedAtomList)t.hAtoms=s.hashUtilsCls.unionHash(t.hAtoms,t.pickedAtomList);else{let e=t.firstAtomObjCls.getFirstAtomObj(t.prevPickedAtomList),i=t.firstAtomObjCls.getFirstAtomObj(t.pickedAtomList);if(e.structure+"_"+e.chain!=i.structure+"_"+i.chain)t.hAtoms=s.hashUtilsCls.unionHash(t.hAtoms,t.pickedAtomList);else{let e;e=s.hashUtilsCls.unionHash(e,t.prevPickedAtomList),e=s.hashUtilsCls.unionHash(e,t.pickedAtomList);let i=t.firstAtomObjCls.getFirstAtomObj(e),l=t.firstAtomObjCls.getLastAtomObj(e);for(let e=i.serial;e<=l.serial;++e)t.hAtoms[e]=1}}t.prevPickedAtomList=s.hashUtilsCls.cloneHash(t.pickedAtomList)}else t.bCtrl&&(t.hAtoms=l>0?s.hashUtilsCls.exclHash(t.hAtoms,t.pickedAtomList):s.hashUtilsCls.unionHash(t.hAtoms,t.pickedAtomList));else t.hAtoms=s.hashUtilsCls.cloneHash(t.pickedAtomList);t.hlObjectsCls.removeHlObjects(),t.hlObjectsCls.addHlObjects()}select3ddomainFromAtom(e){let t,s=this.icn3d,i=s.icn3dui,l=e.structure+"_"+e.chain,n=l+"_"+e.resi;for(let e in s.tddomains){let i=e.indexOf("_3d_domain");if(e.substr(0,i)==l&&-1!==Object.keys(s.tddomains[e]).indexOf(n)){t=e;break}}let o={};for(let e in s.tddomains[t])o=i.hashUtilsCls.unionHash(o,s.residues[e]);return o}selectStrandHelixFromAtom(e){let t=this.icn3d,s=t.icn3dui,i=e,l=e,n={},o=i.resi;if(!i.ssbegin&&!isNaN(i.resi)){for(let e=i.resi-1;e>0;--e){let s=i.structure+"_"+i.chain+"_"+e;if(!t.residues.hasOwnProperty(s))break;let l=t.firstAtomObjCls.getFirstCalphaAtomObj(t.residues[s]);if(o=l.resi,"coil"!==i.ss&&l.ss===i.ss&&l.ssbegin||"coil"===i.ss&&l.ss!==i.ss){"coil"===i.ss&&l.ss!==i.ss&&(o=parseInt(l.resi)+1);break}}for(let e=o;e<=i.resi;++e){let l=i.structure+"_"+i.chain+"_"+e;n=s.hashUtilsCls.unionHash(n,s.hashUtilsCls.hash2Atoms(t.residues[l],t.atoms))}}let r=l.resi,a=t.firstAtomObjCls.getLastAtomObj(t.chains[l.structure+"_"+l.chain]).resi;for(let e=parseInt(l.resi)+1;e<=parseInt(a);++e){let s=l.structure+"_"+l.chain+"_"+e;if(!t.residues.hasOwnProperty(s))break;let i=t.firstAtomObjCls.getFirstCalphaAtomObj(t.residues[s]);if(r=i.resi,"coil"!==l.ss&&i.ss===l.ss&&i.ssend||"coil"===l.ss&&i.ss!==l.ss){"coil"!==l.ss||i.ss===l.ss||isNaN(i.resi)||(r=i.resi-1);break}}for(let e=parseInt(l.resi)+1;e<=parseInt(r);++e){let i=l.structure+"_"+l.chain+"_"+e;n=s.hashUtilsCls.unionHash(n,s.hashUtilsCls.hash2Atoms(t.residues[i],t.atoms))}return n}}class fe{constructor(e){this.icn3d=e}applyCommand(e){let t=this.icn3d,s=t.icn3dui;t.bAddCommands=!1;let i=e.split("|||")[0].replace(/\s+/g," ").trim(),l=i.toLowerCase();if("share link"==l)t.shareLinkCls.shareLink();else if("export state file"==l);else if(0==l.indexOf("export canvas"))setTimeout((function(){let e=l.substr(13).trim();t.scaleFactor=""===e?1:parseInt(e),t.shareLinkCls.shareLink(!0)}),500);else if("export interactions"==l)t.viewInterPairsCls.exportInteractions();else if("export stl file"==l)setTimeout((function(){t.export3DCls.exportStlFile("")}),500);else if("export vrml file"==l)setTimeout((function(){t.export3DCls.exportVrmlFile("")}),500);else if("export stl stabilizer file"==l)setTimeout((function(){t.threeDPrintCls.hideStabilizer(),t.threeDPrintCls.resetAfter3Dprint(),t.threeDPrintCls.addStabilizer(),t.export3DCls.exportStlFile("_stab")}),500);else if("export vrml stabilizer file"==l)setTimeout((function(){t.threeDPrintCls.hideStabilizer(),t.threeDPrintCls.resetAfter3Dprint(),t.threeDPrintCls.addStabilizer(),t.export3DCls.exportVrmlFile("_stab")}),500);else if("export pdb"==l)s.htmlCls.setHtmlCls.exportPdb();else if("select all"==l)t.selectionCls.selectAll();else if("show all"==l)t.selectionCls.showAll();else if("select complement"==l)t.resid2specCls.selectComplement();else if("set pk atom"==l)t.pk=1,t.opts.pk="atom";else if("set pk off"==l)t.pk=0,t.opts.pk="no",t.drawCls.draw(),t.hlObjectsCls.removeHlObjects();else if("set pk residue"==l)t.pk=2,t.opts.pk="residue";else if("set pk strand"==l)t.pk=3,t.opts.pk="strand";else if("set pk domain"==l)t.pk=4,t.opts.pk="domain";else if("set pk chain"==l)t.pk=5,t.opts.pk="chain";else if("set surface wireframe on"==l)t.opts.wireframe="yes",t.applyMapCls.applySurfaceOptions();else if("set surface wireframe off"==l)t.opts.wireframe="no",t.applyMapCls.applySurfaceOptions();else if("set map wireframe on"==l)t.opts.mapwireframe="yes",t.applyMapCls.applyMapOptions();else if("set map wireframe off"==l)t.opts.mapwireframe="no",t.applyMapCls.applyMapOptions();else if("set emmap wireframe on"==l)t.opts.emmapwireframe="yes",t.applyMapCls.applyEmmapOptions();else if("set emmap wireframe off"==l)t.opts.emmapwireframe="no",t.applyMapCls.applyEmmapOptions();else if("set surface neighbors on"==l)t.bConsiderNeighbors=!0,t.applyMapCls.applySurfaceOptions();else if("set surface neighbors off"==l)t.bConsiderNeighbors=!1,t.applyMapCls.applySurfaceOptions();else if("set axis on"==l)t.opts.axis="yes";else if("set pc1 axis"==l)t.pc1=!0,t.axesCls.setPc1Axes();else if("set axis off"==l)t.opts.axis="no",t.pc1=!1;else if("set fog on"==l)t.opts.fog="yes",t.fogCls.setFog(!0);else if("set fog off"==l)t.opts.fog="no",t.fogCls.setFog(!0);else if("set slab on"==l)t.opts.slab="yes";else if("set slab off"==l)t.opts.slab="no";else if("set assembly on"==l)t.bAssembly=!0;else if("set assembly off"==l)t.bAssembly=!1;else if("set chemicalbinding show"==l)t.setOptionCls.setOption("chemicalbinding","show");else if("set chemicalbinding hide"==l)t.setOptionCls.setOption("chemicalbinding","hide");else if("set hbonds off"==l)t.hBondCls.hideHbonds(),t.drawCls.draw();else if("set salt bridge off"==l)t.saltbridgeCls.hideSaltbridge(),t.drawCls.draw();else if("set contact off"==l)t.contactCls.hideContact(),t.drawCls.draw();else if("set halogen pi off"==l)t.piHalogenCls.hideHalogenPi(),t.drawCls.draw();else if("hydrogens"==l)t.showInterCls.showHydrogens(),t.drawCls.draw();else if("set hydrogens off"==l)t.showInterCls.hideHydrogens(),t.drawCls.draw();else if("close popup"==l)t.resizeCanvasCls.closeDialogs();else if("set stabilizer off"==l)t.threeDPrintCls.hideStabilizer(),t.drawCls.draw();else if("set disulfide bonds off"==l)t.opts.ssbonds="no",t.drawCls.draw();else if("set cross linkage off"==l)t.opts.clbonds="no",t.drawCls.draw();else if("set lines off"==l)t.labels.distance=[],t.lines.distance=[],t.drawCls.draw();else if("set labels off"==l){for(let e in t.labels)t.labels[e]=[];t.drawCls.draw()}else if("set mode all"==l)t.definedSetsCls.setModeAndDisplay("all");else if("set mode selection"==l)t.definedSetsCls.setModeAndDisplay("selection");else if("set view detailed view"==l)t.annotationCls.setAnnoViewAndDisplay("detailed view");else if("set view overview"==l)t.annotationCls.setAnnoViewAndDisplay("overview");else if("set annotation custom"==l)t.annotationCls.setAnnoTabCustom();else if("set annotation interaction"==l)t.annotationCls.setAnnoTabInteraction();else if("set annotation cdd"==l)t.annotationCls.setAnnoTabCdd();else if("set annotation site"==l)t.annotationCls.setAnnoTabSite();else if("set annotation ssbond"==l)t.annotationCls.setAnnoTabSsbond();else if("set annotation crosslink"==l)t.annotationCls.setAnnoTabCrosslink();else if("set annotation transmembrane"==l)t.annotationCls.setAnnoTabTransmem();else if("highlight level up"==l)t.resid2specCls.switchHighlightLevelUp();else if("highlight level down"==l)t.resid2specCls.switchHighlightLevelDown();else if(0==l.indexOf("hide annotation")){let e=l.lastIndexOf(" "),s=l.substr(e+1);"all"==s?t.annotationCls.hideAnnoTabAll():"custom"==s?t.annotationCls.hideAnnoTabCustom():"clinvar"==s?t.annotationCls.hideAnnoTabClinvar():"snp"==s?t.annotationCls.hideAnnoTabSnp():"cdd"==s?t.annotationCls.hideAnnoTabCdd():"3ddomain"==s?t.annotationCls.hideAnnoTab3ddomain():"site"==s?t.annotationCls.hideAnnoTabSite():"interaction"==s?t.annotationCls.hideAnnoTabInteraction():"ssbond"==s?t.annotationCls.hideAnnoTabSsbond():"crosslink"==s?t.annotationCls.hideAnnoTabCrosslink():"transmembrane"==s&&t.annotationCls.hideAnnoTabTransmem()}else if("add residue labels"==l)t.residueLabelsCls.addResidueLabels(t.hAtoms),t.drawCls.draw();else if("add residue number labels"==l)t.residueLabelsCls.addResidueLabels(t.hAtoms,void 0,void 0,!0),t.drawCls.draw();else if("add atom labels"==l)t.residueLabelsCls.addAtomLabels(t.hAtoms),t.drawCls.draw();else if("add chain labels"==l)t.analysisCls.addChainLabels(t.hAtoms),t.drawCls.draw();else if("add terminal labels"==l)t.analysisCls.addTerminiLabels(t.hAtoms),t.drawCls.draw();else if("rotate left"==l)t.bStopRotate=!1,t.ROT_DIR="left",t.resizeCanvasCls.rotStruc("left");else if("rotate right"==l)t.bStopRotate=!1,t.ROT_DIR="right",t.resizeCanvasCls.rotStruc("right");else if("rotate up"==l)t.bStopRotate=!1,t.ROT_DIR="up",t.resizeCanvasCls.rotStruc("up");else if("rotate down"==l)t.bStopRotate=!1,t.ROT_DIR="down",t.resizeCanvasCls.rotStruc("down");else if("rotate x"==l){let e=new THREE.Vector3(1,0,0),s=.5*Math.PI;t.transformCls.setRotation(e,s)}else if("rotate y"==l){let e=new THREE.Vector3(0,1,0),s=.5*Math.PI;t.transformCls.setRotation(e,s)}else if("rotate z"==l){let e=new THREE.Vector3(0,0,1),s=.5*Math.PI;t.transformCls.setRotation(e,s)}else if("reset"===l)t.selectionCls.resetAll();else if("reset orientation"===l)t.transformCls.resetOrientation(),t.drawCls.draw();else if("reset thickness"==l)t.threeDPrintCls.resetAfter3Dprint(),t.drawCls.draw();else if("clear selection"==l)t.hlObjectsCls.removeHlObjects(),t.hlUpdateCls.removeHl2D(),t.bShowHighlight=!1,t.bSelectResidue=!1;else if("zoom selection"==l)t.transformCls.zoominSelection(),t.drawCls.draw();else if("center selection"==l)t.applyCenterCls.centerSelection(),t.drawCls.draw();else if("show selection"==l)t.selectionCls.showSelection();else if("hide selection"==l)t.selectionCls.hideSelection();else if("output selection"==l)t.threeDPrintCls.outputSelection();else if("toggle selection"==l)t.selectionCls.toggleSelection();else if("toggle highlight"==l)t.hlUpdateCls.toggleHighlight();else if("stabilizer"==l)t.threeDPrintCls.addStabilizer(),t.threeDPrintCls.prepareFor3Dprint();else if("disulfide bonds"==l)t.annoSsbondCls.showSsbonds();else if("cross linkage"==l)t.showInterCls.showClbonds();else if("back"==l)t.resizeCanvasCls.back();else if("forward"==l)t.resizeCanvasCls.forward();else if("clear all"==l)t.selectionCls.selectAll();else if("defined sets"==l)t.definedSetsCls.showSets();else if("delete selected sets"==l)t.definedSetsCls.deleteSelectedSets();else if("view interactions"==l)void 0===s.cfg.mmdbid&&void 0===s.cfg.gi||t.ParserUtilsCls.set2DDiagrams(t.inputid);else if("show annotations all chains"==l)t.annotationCls.showAnnoAllChains();else if("save color"==l)t.setOptionCls.saveColor();else if("apply saved color"==l)t.setOptionCls.applySavedColor();else if("save style"==l)t.setOptionCls.saveStyle();else if("apply saved style"==l)t.setOptionCls.applySavedStyle();else if("select main chains"==l)t.selectionCls.selectMainChains();else if("select side chains"==l)t.selectionCls.selectSideChains();else if("select main side chains"==l)t.selectionCls.selectMainSideChains();else if("realign"==l)t.realignParserCls.realign();else if("area"==l)t.analysisCls.calculateArea();else if("table inter count only"==l)$(".icn3d-border").hide();else if("table inter details"==l)$(".icn3d-border").show();else if("setoption map nothing"==l)t.setOptionCls.setOption("map","nothing");else if("setoption emmap nothing"==l)t.setOptionCls.setOption("emmap","nothing");else if("setoption phimap nothing"==l)t.setOptionCls.setOption("phimap","nothing");else if("setoption phisurface nothing"==l)t.setOptionCls.setOption("phisurface","nothing");else if("clear symd symmetry"==l)t.symdArray=[];else if("show axis"==l)t.bAxisOnly=!0;else if(0==i.indexOf("define helix sets")){let e=i.split(" | ")[1].split(" ")[1];t.addTrackCls.defineSecondary(e,"helix")}else if(0==i.indexOf("define sheet sets")){let e=i.split(" | ")[1].split(" ")[1];t.addTrackCls.defineSecondary(e,"sheet")}else if(0==i.indexOf("define coil sets")){let e=i.split(" | ")[1].split(" ")[1];t.addTrackCls.defineSecondary(e,"coil")}else if(0==i.indexOf("select interaction")){let e=i.substr(i.lastIndexOf(" ")+1).split(",");if(null!==e){let s=e[0].split("_")[0];t.b2DShown||t.ParserUtilsCls.download2Ddgm(s.toUpperCase()),t.diagram2dCls.selectInteraction(e[0],e[1])}}else if(0==i.indexOf("select saved atoms")||0==i.indexOf("select sets")){i=i.replace(/aligned_protein/g,"protein_aligned");let e=i.split(" | "),s=e[0].replace(/,/g," or "),l=19;0==i.indexOf("select sets")&&(l=12);let n=s.substr(l),o=n;2==e.length&&(o=e[1].substr(5)),t.definedSetsCls.selectCombinedSets(n,o)}else if(-1!==i.indexOf("select chain")){let e=i.substr(i.lastIndexOf(" ")+1).split(",");for(let s=0,i=e.length;s<i;++s)t.selectionCls.selectAChain(e[s],e[s],!1)}else if(-1!==i.indexOf("select alignChain")){let e=i.substr(i.lastIndexOf(" ")+1).split(",");for(let s=0,i=e.length;s<i;++s)t.selectionCls.selectAChain(e[s],"align_"+e[s],!0)}else if(0==i.indexOf("select zone cutoff")){let e=this.getThresholdNameArrays(i);t.showInterCls.pickCustomSphere(e.threshold,e.nameArray2,e.nameArray,e.bHbondCalc),t.bSphereCalc=!0}else if(0==l.indexOf("set surface opacity")){let e=l.substr(l.lastIndexOf(" ")+1);t.opts.opacity=parseFloat(e),t.applyMapCls.applySurfaceOptions(),parseInt(100*e)<100&&(t.bTransparentSurface=!0)}else if(0==l.indexOf("set label scale")){let e=l.substr(l.lastIndexOf(" ")+1);t.labelScale=parseFloat(e)}else if(0==l.indexOf("set surface")){let e=l.substr(12);t.opts.surface=e,t.applyMapCls.applySurfaceOptions()}else if(0==l.indexOf("set camera")){let e=l.substr(l.lastIndexOf(" ")+1);t.opts.camera=e}else if(0==l.indexOf("set background")){let e=l.substr(l.lastIndexOf(" ")+1);t.opts.background=e,"white"==e||"grey"==e?($("#"+t.pre+"title").css("color","black"),$("#"+t.pre+"titlelink").css("color","black")):($("#"+t.pre+"title").css("color",s.htmlCls.GREYD),$("#"+t.pre+"titlelink").css("color",s.htmlCls.GREYD))}else if(0==i.indexOf("set thickness")){let e=l.split(" | ");t.bSetThickness=!0;for(let s=1,i=e.length;s<i;++s){let i=e[s].split(" "),l=i[0],n=parseFloat(i[1]);"linerad"==l&&(t.lineRadius=n),"coilrad"==l&&(t.coilWidth=n),"stickrad"==l&&(t.cylinderRadius=n),"tracerad"==l&&(t.traceRadius=n),"ballscale"==l&&(t.dotSphereScale=n),"ribbonthick"==l&&(t.ribbonthickness=n),"proteinwidth"==l&&(t.helixSheetWidth=n),"nucleotidewidth"==l&&(t.nucleicAcidWidth=n),t.drawCls.draw()}}else if(0==i.indexOf("set light")){let e=l.split(" | ");for(let s=1,i=e.length;s<i;++s){let i=e[s].split(" "),l=i[0],n=parseFloat(i[1]);"light1"==l&&(t.light1=n),"light2"==l&&(t.light2=n),"light3"==l&&(t.light3=n),t.drawCls.draw()}}else if(0==i.indexOf("set shininess")){let e=l.lastIndexOf(" ");t.shininess=parseFloat(l.substr(e+1)),t.drawCls.draw()}else if(0==i.indexOf("set glycan")){let e=l.lastIndexOf(" ");t.bGlycansCartoon=parseInt(l.substr(e+1)),t.drawCls.draw()}else if(0==l.indexOf("set highlight color")){let e=l.substr(20);"yellow"===e?(t.hColor=s.parasCls.thr(16776960),t.matShader=t.setColorCls.setOutlineColor("yellow")):"green"===e?(t.hColor=s.parasCls.thr(65280),t.matShader=t.setColorCls.setOutlineColor("green")):"red"===e&&(t.hColor=s.parasCls.thr(16711680),t.matShader=t.setColorCls.setOutlineColor("red")),t.drawCls.draw()}else if(0==l.indexOf("set highlight style")){let e=l.substr(20);"outline"===e?t.bHighlight=1:"3d"===e&&(t.bHighlight=2),t.drawCls.draw()}else if(0==l.indexOf("add line")){let e=l.split(" | "),s=e[1].split(" "),i=e[2].split(" "),n=e[3].substr(e[3].lastIndexOf(" ")+1),o="true"===e[4].substr(e[4].lastIndexOf(" ")+1),r=e[5].substr(e[5].lastIndexOf(" ")+1);t.analysisCls.addLine(parseFloat(s[1]),parseFloat(s[3]),parseFloat(s[5]),parseFloat(i[1]),parseFloat(i[3]),parseFloat(i[5]),n,o,r),t.drawCls.draw()}else if(0==i.indexOf("add label")){let e,l,n,o,r,a,d,c=i.split(" | "),h=c[0].substr("add label".length+1),m=!1;for(let t=1,s=c.length;t<s;++t){let s=c[t].split(" ");"x"==s[0]?(m=!0,e=s[1],l=s[3],n=s[5]):"size"==s[0]?o=c[t].substr(c[t].lastIndexOf(" ")+1):"color"==s[0]?r=c[t].substr(c[t].lastIndexOf(" ")+1):"background"==s[0]?a=c[t].substr(c[t].lastIndexOf(" ")+1):"type"==s[0]&&(d=c[t].substr(c[t].lastIndexOf(" ")+1))}if(!m){let i=t.applyCenterCls.centerAtoms(s.hashUtilsCls.hash2Atoms(t.hAtoms,t.atoms));e=i.center.x,l=i.center.y,n=i.center.z}t.analysisCls.addLabel(h,e,l,n,o,r,a,d),t.drawCls.draw()}else if(0==i.indexOf("msa")){let e=i.split(" | ")[1].split(" ");t.targetGapHash={};for(let s=0,i=e.length;s<i;++s){let i=e[s].split("_");t.targetGapHash[parseInt(i[0])]={from:parseInt(i[1]),to:parseInt(i[2])}}t.annotationCls.resetAnnoAll()}else if(0==i.indexOf("add track")){let e,s,l,n=i.split(" | "),o=n[1].substr(8),r=n[2].substr(6),a=n[3].substr(5);n.length>=5&&(e=n[4].substr(5)),n.length>=6&&(s=n[5].substr(6)),n.length>=7&&(l=n[6].substr(4)),$("#"+t.pre+"anno_custom")[0].checked=!0,$("[id^="+t.pre+"custom]").show(),"0"==s&&(s=void 0),t.addTrackCls.checkGiSeq(o,r,a,e,s,l,0)}else if(0==l.indexOf("remove one stabilizer")){let e=l.split(" | ")[1].split(" "),s=[];s.push(parseInt(e[0])),s.push(parseInt(e[1])),t.threeDPrintCls.removeOneStabilizer(s),t.drawCls.draw()}else if(0==l.indexOf("add one stabilizer")){let e=l.split(" | ")[1].split(" ");void 0===t.pairArray&&(t.pairArray=[]),t.pairArray.push(parseInt(e[0])),t.pairArray.push(parseInt(e[1])),t.drawCls.draw()}else if(0==l.indexOf("select planes z-axis")){let e=l.split(" ");if(5==e.length){let s=parseFloat(e[3]),i=parseFloat(e[4]);t.selectionCls.selectBtwPlanes(s,i)}}else if(0==l.indexOf("adjust membrane z-axis")){let e=l.split(" ");if(5==e.length){let s=parseFloat(e[3]),i=parseFloat(e[4]);t.selectionCls.adjustMembrane(s,i)}}else if(0==l.indexOf("toggle membrane"))t.selectionCls.toggleMembrane();else if(0==i.indexOf("calc buried surface")){let e=i.split(" | ");if(2==e.length){let s=e[1].split(" ");if(2==s.length){let e=s[0].split(","),i=s[1].split(",");t.analysisCls.calcBuriedSurface(e,i)}}}else if(0==i.indexOf("dist")){let e=i.split(" | ");if(2==e.length){let s=e[1].split(" ");if(2==s.length){let e=s[0].split(","),i=s[1].split(",");t.analysisCls.measureDistTwoSets(e,i)}}}else if(0==i.indexOf("display interaction 3d")||0==i.indexOf("view interaction pairs")||0==i.indexOf("save1 interaction pairs")||0==i.indexOf("save2 interaction pairs")||0==i.indexOf("line graph interaction pairs")||0==i.indexOf("scatterplot interaction pairs")){let e=i.split(" | ");if(e.length>=3){let s=e[1].split(" ");if(2==s.length){let l,n,o=s[0].split(","),r=s[1].split(","),a=-1!==e[2].indexOf("hbonds"),d=-1!==e[2].indexOf("salt bridge"),c=-1!==e[2].indexOf("interactions"),h=-1!==e[2].indexOf("halogen"),m=-1!==e[2].indexOf("pi-cation"),p=-1!==e[2].indexOf("pi-stacking");if(e.length>=4&&(l="true"==e[3]),e.length>=5){let s=e[4].split(" ");s.length>=4&&($("#"+t.pre+"hbondthreshold").val(s[1]),$("#"+t.pre+"saltbridgethreshold").val(s[2]),$("#"+t.pre+"contactthreshold").val(s[3]),7==s.length&&($("#"+t.pre+"halogenthreshold").val(s[4]),$("#"+t.pre+"picationthreshold").val(s[5]),$("#"+t.pre+"pistackingthreshold").val(s[6])))}0==i.indexOf("display interaction 3d")?n="3d":0==i.indexOf("view interaction pairs")?n="view":0==i.indexOf("save1 interaction pairs")?n="save1":0==i.indexOf("save2 interaction pairs")?n="save2":0==i.indexOf("line graph interaction pairs")?n="linegraph":0==i.indexOf("scatterplot interaction pairs")&&(n="scatterplot"),t.viewInterPairsCls.viewInteractionPairs(o,r,l,n,a,d,c,h,m,p)}}}else if(0==i.indexOf("export pairs")){let e=i.split(" | ");if(3==e.length){let s=e[1].split(" ");if(2==s.length){let i=s[0].split(","),l=s[1].split(","),n=e[2].split(" ")[1];t.showInterCls.pickCustomSphere(n,i,l,t.bSphereCalc),t.bSphereCalc=!0;let o=t.viewInterPairsCls.exportSpherePairs(),r=t.inputid?t.inputid:"custom";t.saveFileCls.saveFile(r+"_sphere_pairs.html","html",o)}}}else if(0==i.indexOf("export pqr"))s.htmlCls.setHtmlCls.exportPqr();else if(0==l.indexOf("graph label")){let e=l.lastIndexOf(" "),t=l.substr(e+1);$("#"+s.svgid+"_label").val(t),$("#"+s.svgid+" text").removeClass(),$("#"+s.svgid+" text").addClass(t)}else if(0==l.indexOf("line graph scale")){let e=l.lastIndexOf(" "),i=l.substr(e+1);$("#"+s.linegraphid+"_scale").val(i),$("#"+s.linegraphid).attr("width",(t.linegraphWidth*parseFloat(i)).toString()+"px")}else if(0==l.indexOf("scatterplot scale")){let e=l.lastIndexOf(" "),i=l.substr(e+1);$("#"+s.scatterplotid+"_scale").val(i),$("#"+s.scatterplotid).attr("width",(t.scatterplotWidth*parseFloat(i)).toString()+"px")}else if(0==l.indexOf("contactmap scale")){let e=l.lastIndexOf(" "),i=l.substr(e+1);$("#"+s.contactmapid+"_scale").val(i),$("#"+s.contactmapid).attr("width",(t.contactmapWidth*parseFloat(i)).toString()+"px")}else if(0==l.indexOf("graph force")){let e=l.lastIndexOf(" ");s.htmlCls.force=parseInt(l.substr(e+1)),$("#"+s.svgid+"_force").val(s.htmlCls.force),t.getGraphCls.handleForce()}else if(0==l.indexOf("hide edges")){let e=l.lastIndexOf(" ");s.htmlCls.hideedges=parseInt(l.substr(e+1)),$("#"+s.svgid+"_hideedges").val(s.htmlCls.hideedges),s.htmlCls.hideedges?(s.htmlCls.contactInsideColor="FFF",s.htmlCls.hbondInsideColor="FFF",s.htmlCls.ionicInsideColor="FFF"):(s.htmlCls.contactInsideColor="DDD",s.htmlCls.hbondInsideColor="AFA",s.htmlCls.ionicInsideColor="8FF"),void 0!==t.graphStr&&t.bRender&&s.htmlCls.force&&t.drawGraphCls.drawGraph(t.graphStr,t.pre+"dl_graph")}else if(0==l.indexOf("reset interaction pairs"))t.viewInterPairsCls.resetInteractionPairs();else if(0==l.indexOf("side by side")){let e=l.split(" | ")[1];window.open(e,"_blank")}else if(0==i.indexOf("your note")){let e=i.split(" | ");t.yournote=e[1],$("#"+t.pre+"yournote").val(t.yournote),s.cfg.shownote&&(document.title=t.yournote)}else if(0==l.indexOf("cross structure interaction"))t.crossstrucinter=parseInt(l.substr(l.lastIndexOf(" ")+1)),$("#"+t.pre+"crossstrucinter").val(t.crossstrucinter);else if("replay on"==l)t.resizeCanvasCls.replayon();else if("replay off"==l)t.resizeCanvasCls.replayoff();else if(0==l.indexOf("contact map")){let e=l.split(" | ");if(3===e.length){let s=parseFloat(e[1].split(" ")[1]),i=e[2].split(" ")[1];t.contactMapCls.contactMap(s,i)}}else if(0==l.indexOf("pickatom")){let e=parseInt(l.substr(l.lastIndexOf(" ")+1));t.pAtom=t.atoms[e],t.pickingCls.showPicking(t.pAtom)}else if(0==i.indexOf("color")){let e=i.split(" | "),l=e[0].substr(e[0].indexOf(" ")+1);if(t.opts.color=l,"residue custom"==l&&2==e.length){t.customResidueColors=JSON.parse(e[1]);for(let e in t.customResidueColors)t.customResidueColors[e.toUpperCase()]=s.parasCls.thr("#"+t.customResidueColors[e])}else if("align custom"==l&&3==e.length){let s=e[1],i=e[2].split(", ");t.queryresi2score={},t.queryresi2score[s]={};for(let e=0,l=i.length;e<l;++e){let l=i[e].split(" ");t.queryresi2score[s][l[0]]=l[1]}}else"align custom"==l&&e.length>=4?this.setQueryresi2score(e):"area"==l&&2==e.length&&(t.midpercent=e[1],$("#"+t.pre+"midpercent").val(t.midpercent));t.setColorCls.setColorByOptions(t.opts,t.hAtoms),t.hlUpdateCls.updateHlAll(),t.getGraphCls.updateGraphColor()}else if(0==i.indexOf("remove legend"))$("#"+s.pre+"legend").hide();else if(0==i.indexOf("custom tube")){let e=i.split(" | ");this.setQueryresi2score(e),t.setOptionCls.setStyle("proteins","custom tube")}else if(0==l.indexOf("style")){let e=l.substr(l.indexOf(" ")+1),s=e.substr(0,e.indexOf(" ")),i=e.substr(e.indexOf(" ")+1);t.setOptionCls.setStyle(s,i)}else if(0==l.indexOf("window")){let e=l.substr(l.indexOf(" ")+1);"aligned sequences"==e?s.htmlCls.dialogCls.openDlg("dl_alignment","Select residues in aligned sequences"):"interaction table"==e?s.htmlCls.dialogCls.openDlg("dl_allinteraction","Show interactions"):"interaction graph"==e?s.htmlCls.dialogCls.openDlg("dl_linegraph","Show interactions between two lines of residue nodes"):"interaction scatterplot"==e?s.htmlCls.dialogCls.openDlg("dl_scatterplot","Show interactions as scatterplot"):"force-directed graph"==e&&s.htmlCls.dialogCls.openDlg("dl_graph","Force-directed graph")}else if(0==l.indexOf("set theme")){let e=l.substr(l.lastIndexOf(" ")+1);s.htmlCls.setMenuCls.setTheme(e)}else if(0==l.indexOf("set double color")){let e=l.substr(l.lastIndexOf(" ")+1);"on"==e?(t.bDoublecolor=!0,t.setOptionCls.setStyle("proteins","ribbon")):"off"==e&&(t.bDoublecolor=!1)}else if(0==l.indexOf("adjust dialog")){let e=l.substr(l.lastIndexOf(" ")+1);t.scapCls.adjust2DWidth(e)}else if(0==l.indexOf("glycans cartoon")){let e=l.substr(l.lastIndexOf(" ")+1);t.bGlycansCartoon="yes"==e}else if(-1!==l.indexOf("select displayed set"))t.hAtoms=s.hashUtilsCls.cloneHash(t.dAtoms),t.hlUpdateCls.updateHlAll();else if(-1!==l.indexOf("select prop")){let e,s,l=i.split(" | "),n=l[0].substr("select prop".length+1);if(2==l.length){let t=l[1].split("_");e=t[0],s=t[1]}t.resid2specCls.selectProperty(n,e,s)}else if(0==l.indexOf("select")&&-1!==l.indexOf("name")){let e=i.split(" | "),s="",l="",n="";for(let t=0,i=e.length;t<i;++t){let i=e[t];-1!==i.indexOf("select")?s=i.substr(i.indexOf(" ")+1):-1!==i.indexOf("name")&&(l=i.substr(i.indexOf(" ")+1))}n=l,t.selByCommCls.selectByCommand(s,l,n)}else if(-1!==l.indexOf("select $")||-1!==l.indexOf("select .")||-1!==l.indexOf("select :")||-1!==l.indexOf("select @")){let e=i.split(" | "),s=e[0].substr(e[0].indexOf(" ")+1),l="",n="";e.length>1&&(l=e[1].substr(e[1].indexOf(" ")+1)),e.length>2&&(n=e[2].substr(e[2].indexOf(" ")+1)),-1!==s.indexOf(" or ")?t.selByCommCls.selectByCommand(s,l,n):t.selByCommCls.selectBySpec(s,l,n)}s.htmlCls.clickMenuCls.setLogCmd(i,!1),t.bAddCommands=!0}setStrengthPara(e){let t=this.icn3d;if(t.icn3dui,e.length>=5){let s=e[4].split(" ");s.length>=4&&($("#"+t.pre+"hbondthreshold").val(s[1]),$("#"+t.pre+"saltbridgethreshold").val(s[2]),$("#"+t.pre+"contactthreshold").val(s[3]),s.length>=7&&($("#"+t.pre+"halogenthreshold").val(s[4]),$("#"+t.pre+"picationthreshold").val(s[5]),$("#"+t.pre+"pistackingthreshold").val(s[6])))}if(6==e.length){let s=e[5].split(" ");s.length>=6&&($("#"+t.pre+"dist_ss").val(s[0]),$("#"+t.pre+"dist_coil").val(s[1]),$("#"+t.pre+"dist_hbond").val(s[2]),$("#"+t.pre+"dist_inter").val(s[3]),$("#"+t.pre+"dist_ssbond").val(s[4]),$("#"+t.pre+"dist_ionic").val(s[5]),9==s.length&&($("#"+t.pre+"dist_halogen").val(s[6]),$("#"+t.pre+"dist_pication").val(s[7]),$("#"+t.pre+"dist_pistacking").val(s[8])))}}getThresholdNameArrays(e){let t=this.icn3d,s=t.icn3dui;if(void 0===t.bSetChainsAdvancedMenu||!t.bSetChainsAdvancedMenu){let e=s.hashUtilsCls.cloneHash(t.hAtoms);t.definedSetsCls.setPredefinedInMenu(),t.bSetChainsAdvancedMenu=!0,t.hAtoms=s.hashUtilsCls.cloneHash(e)}let i,l=e.split(" | "),n=parseFloat(l[0].substr(l[0].lastIndexOf(" ")+1)),o=[],r=[];if(l.length>=2&&l[1].length>4){let e=l[1].split(" ");e.length>1&&(r=e[1].split(",")),e.length>2&&(o=e[2].split(","))}else r=["selected"],o=["non-selected"];return 3==l.length&&(i="true"==l[2]),{threshold:n,nameArray2:r,nameArray:o,bHbondCalc:i}}setQueryresi2score(e){let t=this.icn3d,s=t.icn3dui,i=e[1],l=e[2].split(" ")[1].split("_"),n=e[3];void 0===t.queryresi2score&&(t.queryresi2score={}),t.queryresi2score[i]={};for(let e=parseInt(l[0]),s=0;e<=parseInt(l[1]);++e,++s)"_"!=n[s]&&(t.queryresi2score[i][e]=11.11111111111111*parseInt(n[s]));if(e.length>4){let i=e[4].split(" ");t.startColor=i[1],t.midColor=i[2],t.endColor=i[3];let l=s.htmlCls.clickMenuCls.setLegendHtml();$("#"+s.pre+"legend").html(l).show()}}getMenuFromCmd(e){this.icn3d.icn3dui;let t="Windows > View Sequences & Annotations",s="Analysis > H-Bonds & Interactions",i=s+" > 2D Graph(Force-Directed)",l="View > Rotate > Auto Rotation > Rotate ",n="View > Rotate > Rotate 90 deg > ",o="Select > Select on 3D > ",r="Analysis > Label > ",a="File > 3D Printing > ";return 0==(e=e.trim()).indexOf("load")?"File > Retrieve by ID, Align":0==e.indexOf("set map")&&-1==e.indexOf("set map wireframe")?"Style > Electron Density":0==e.indexOf("set emmap")&&-1==e.indexOf("set emmap wireframe")?"Style > EM Density Map":0==e.indexOf("set phi")?"Analysis > Load Potential > URL(Same Host) Phi/Cube":0==e.indexOf("set delphi")?"Analysis > DelPhi Potential":0==e.indexOf("setoption map")?"Style > Remove Map":0==e.indexOf("setoption emmap")?"Style > Remove EM Map":0==e.indexOf("view annotations")?t:0==e.indexOf("set annotation all")?t+': "All" checkbox':0==e.indexOf("set annotation clinvar")?t+': "ClinVar" checkbox':0==e.indexOf("set annotation snp")?t+': "SNP" checkbox':0==e.indexOf("set annotation 3ddomain")?t+': "3D Domains" checkbox':0==e.indexOf("view interactions")?"Windows > View 2D Diagram":0==e.indexOf("symmetry")?"Analysis > Symmetry":0==e.indexOf("realign on seq align")?"File > Realign Selection > on Sequence Alignment":0==e.indexOf("realign")?"File > Realign Selection > Residue by Residue":0==e.indexOf("graph interaction pairs")?s+" > 2D Graph(Force-Directed)":0==e.indexOf("export canvas")?"File > Save Files > iCn3D PNG Image":"export stl file"==e?a+"STL":"export vrml file"==e?a+"VRML(Color)":"export stl stabilizer file"==e?a+"STL W/ Stabilizers":"export vrml stabilizer file"==e?a+"VRML(Color, W/ Stabilizers)":"select all"==e?'Select > All; or Toggle to "All"(next to "Help")':"show all"==e?"View > View Full Structure":"select complement"==e?"Select > Inverse":"set pk atom"==e?o+"Atom":"set pk residue"==e?o+"Residue":"set pk strand"==e?o+"Strand/Helix":"set pk domain"==e?o+"3D Domain":"set pk chain"==e?o+"Chain":"set surface wireframe on"==e?"Style > Surface Wireframe > Yes":"set surface wireframe off"==e?"Style > Surface Wireframe > No":"set map wireframe on"==e?"Style > Map Wireframe > Yes":"set map wireframe off"==e?"Style > Map Wireframe > No":"set emmap wireframe on"==e?"Style > EM Map Wireframe > Yes":"set emmap wireframe off"==e?"Style > EM Map Wireframe > No":"set surface neighbors on"==e?"Style > Surface Type > ... with Context":"set axis on"==e?"View > XYZ-axes > Show":"set axis off"==e?"View > XYZ-axes > Hide":"set fog on"==e?"View > Fog for Selection > On":"set fog off"==e?"View > Fog for Selection > Off":"set slab on"==e?"View > Slab for Selection > On":"set slab off"==e?"View > Slab for Selection > Off":"set assembly on"==e?"Analysis > Assembly > Biological Assembly":"set assembly off"==e?"Analysis > Assembly > Asymmetric Unit":"set chemicalbinding show"==e?"Analysis > Chem. Binding > Show":"set chemicalbinding hide"==e?"Analysis > Chem. Binding > Hide":"set hbonds off"==e||"set salt bridge off"==e||"set contact off"==e||"set halogen pi off"==e?s+" > Reset":"hydrogens"==e?"Style > Hydrogens > Show":"set hydrogens off"==e?"Style > Hydrogens > Hide":"set stabilizer off"==e?"File > 3D Printing > Remove All Stabilizers":"set disulfide bonds off"==e?"Analysis > Disulfide Bonds > Hide":"set cross linkage off"==e?"Analysis > Cross-Linkages > Hide":"set lines off"==e?"Analysis > Distance > Hide":"set labels off"==e?"Analysis > Label > Remove":"set mode all"==e?'Toggle to "All"(next to "Help")':"set mode selection"==e?'Toggle to "Selection"(next to "Help")':"set view detailed view"==e?t+': "Details" tab':"set view overview"==e?t+': "Summary" tab':"set annotation custom"==e?t+': "Custom" checkbox':"set annotation interaction"==e?t+': "Interactions" checkbox':"set annotation cdd"==e?t+': "Conserved Domains" checkbox':"set annotation site"==e?t+': "Functional Sites" checkbox':"set annotation ssbond"==e?t+': "Disulfide Bonds" checkbox':"set annotation crosslink"==e?t+': "Cross-Linkages" checkbox':"set annotation transmembrane"==e?t+': "Transmembrane" checkbox':"highlight level up"==e?"Keyboard Arrow Up":"highlight level down"==e?"Keyboard Arrow Down":0==e.indexOf("hide annotation")?t+": checkboxes off":"add residue labels"==e?r+"per Residue":"add residue number labels"==e?r+"per Residue & Number":"add atom labels"==e?r+"per Atom":"add chain labels"==e?r+"per Chain":"add terminal labels"==e?r+"N- & C- Termini":"rotate left"==e?l+"Left; or Key l":"rotate right"==e?l+"Right; or Key j":"rotate up"==e?l+"Up; or Key i":"rotate down"==e?l+"Down; or Key m":"rotate x"==e?n+"X-axis":"rotate y"==e?n+"Y-axis":"rotate z"==e?n+"Z-axis":"reset"==e?"View > Reset > All":"reset orientation"==e?"View > Reset > Orientation":"clear selection"==e?"Select > Clear Selection":"zoom selection"==e?"Select > Zoom in Selection":"center selection"==e?"Select > Center Selection":"show selection"==e?"Select > View Only Selection":"hide selection"==e?"Select > Hide Selection":"output selection"==e?"Select > Clear Selection":"toggle highlight"==e?"Select > Toggle Highlight":"stabilizer"==e?"File > 3D Printing > Add all Stabilizers":"disulfide bonds"==e?"Analysis > Disulfide Bonds > Show":"cross linkage"==e?"Analysis > Cross-Linkages > Show":"back"==e?"View > Undo":"forward"==e?"View > Redo":"clear all"==e?"Select > Clear Selection":"defined sets"==e?"Windows > Defined Sets":"delete selected sets"==e?'Windows > Defined Sets: "Delete Selected Sets" button':"view interactions"==e?"Windows > View Interactions":"show annotations all chains"==e?t+': "Show All Chains" button':"save color"==e?"Color > Save Color":"apply saved color"==e?"Color > Apply Saved Color":"save style"==e?"Style > Save Style":"apply saved style"==e?"Style > Apply Saved Style":"select main chains"==e?"Select > Main Chains":"select side chains"==e?"Select > Side Chains":"select main side chains"==e?"Select > Main & Side Chains":"area"==e?"View > Surface Area":"table inter count only"==e?s+': "Set 1" button: "Show Count Only" button':"table inter details"==e?s+': "Set 1" button: "Show Details" button':0==e.indexOf("define helix sets")?t+': "Helix Sets" button':0==e.indexOf("define sheet sets")?t+': "Sheet Sets" button':0==e.indexOf("define coil sets")?t+': "Coil Sets" button':0==e.indexOf("select interaction")?"Windows > View 2D Diagram: click on edges":0==e.indexOf("select saved atoms")||0==e.indexOf("select sets")?"Windows > Defined Sets: select in menu":-1!==e.indexOf("select chain")?t+": click on chain names":-1!==e.indexOf("select alignChain")?"Windows > View Aligned Sequences: click on chain names":0==e.indexOf("select zone cutoff")?"Select > by Distance":0==e.indexOf("set surface opacity")?"Style > Surface Opacity":0==e.indexOf("set label scale")?"View > Label Scale":0==e.indexOf("set surface")?"Style > Surface Type":0==e.indexOf("set camera")?"View > Camera":0==e.indexOf("set background")?"Style > Background":0==e.indexOf("set thickness")?"File > 3D Printing > Set Thickness":0==e.indexOf("set highlight color")?"Select > Highlight Color":0==e.indexOf("set highlight style")?"Select > Highlight Style":0==e.indexOf("add line")||0==e.indexOf("add label")?"Analysis > Distance > between Two Atoms":0==e.indexOf("dist")?"Analysis > Distance > between Two Sets":0==e.indexOf("msa")?t+': "Add Track" button: "FASTA Alignment" button':0==e.indexOf("add track")?t+': "Add Track" button':0==e.indexOf("remove one stabilizer")?"File > 3D Printing > Remove One Stablizer":0==e.indexOf("add one stabilizer")?"File > 3D Printing > Add One Stablizer":0==e.indexOf("select planes z-axis")?"View > Select between Two X-Y Planes":0==e.indexOf("adjust membrane z-axis")?"View > Adjust Membrane":0==e.indexOf("toggle membrane")?"View > Toggle Membrane":0==e.indexOf("calc buried surface")?s+': "Buried Surface Area" button':0==e.indexOf("display interaction 3d")?s+': "3D Display Interactions" button':0==e.indexOf("view interaction pairs")?s+': "Highlight Interactions in Table" button':0==e.indexOf("save1 interaction pairs")?s+': "Set 1" button':0==e.indexOf("save2 interaction pairs")?s+': "Set 2" button':0==e.indexOf("line graph interaction pairs")?s+': "2D Interaction Network" button':0==e.indexOf("scatterplot interaction pairs")?s+': "2D Interaction Map" button':0==e.indexOf("graph label")?i+': "Label Size" menu':0==e.indexOf("graph force")?i+': "Force on Nodes" menu':0==e.indexOf("hide edges")?i+': "Internal Edges" menu':0==e.indexOf("reset interaction pairs")?s+" > Reset":0==e.indexOf("side by side")?"View > Side by Side":0==e.indexOf("your note")?"Windows > Your Notes / Window Title":0==e.indexOf("pickatom")?"Hold Alt key and click on 3D structure":0==e.indexOf("color")?"Color menu":0==e.indexOf("custom tube")?t+': "Custom Color/Tube" button: "Custom Tube" button':0==e.indexOf("style")?"Style menu":-1!==e.indexOf("select displayed set")?"Select > Displayed Set":-1!==e.indexOf("select prop")?"Select > by Property":0==e.indexOf("select")&&-1!==e.indexOf("name")?t+": drag on residues to select":-1!==e.indexOf("select $")||-1!==e.indexOf("select .")||-1!==e.indexOf("select :")||-1!==e.indexOf("select @")?"Select > Advanced; or other selection":-1!==e.indexOf("replay on")?"File > Replay Each Step > On":-1!==e.indexOf("replay off")?"File > Replay Each Step > Off":-1!==e.indexOf("set theme")?"Style > Theme Color":-1!==e.indexOf("set double color")?"Style > Two-color Helix":""}}class be{constructor(e){this.icn3d=e}selectByCommand(e,t,s){let i=this.icn3d,l=i.icn3dui;if(0===e.indexOf("saved atoms")){let s=12,l=e.substr(s);i.definedSetsCls.selectCombinedSets(l,t)}else{let n=e.replace(/ AND /g," and ").replace(/ OR /g," or ").replace(/ or and /g," and ").replace(/ and /g," or and ").replace(/ or not /g," not ").replace(/ not /g," or not "),o=("select"===n.trim().substr(0,6)?n.trim().substr(7):n.trim()).split(" or "),r={};for(let e=0,t=o.length;e<t;++e){let t=o[e].trim().replace(/\s+/g," "),s=t.indexOf(" ");i.hAtoms={},"and"===t.substr(0,s).toLowerCase()?(i.applyCommandCls.applyCommand("select "+t.substr(s+1)),r=l.hashUtilsCls.intHash(r,i.hAtoms)):"not"===t.substr(0,s).toLowerCase()?(i.applyCommandCls.applyCommand("select "+t.substr(s+1)),r=l.hashUtilsCls.exclHash(r,i.hAtoms)):(i.applyCommandCls.applyCommand("select "+t),r=l.hashUtilsCls.unionHash(r,i.hAtoms))}i.hAtoms=l.hashUtilsCls.cloneHash(r);let a=Object.keys(i.hAtoms);if(""!==t){i.selectionCls.addCustomSelection(a,t,s,e,!1);let l=[t];i.definedSetsCls.changeCustomAtoms(l)}}}selectBySpec(e,t,s,i){let l=this.icn3d,n=l.icn3dui;e="select"===e.trim().substr(0,6)?e.trim().substr(7):e.trim(),l.hAtoms={};let o,r=e.replace(/\s+/g," ").replace(/ AND /g," and ").split(" and "),a={},d={},c=!0;for(let e=0,t=r.length;e<t;++e){let t,s,i,o,h=r[e].indexOf("$"),m=r[e].indexOf("."),p=r[e].indexOf(":"),u=r[e].indexOf("@"),C=r[e];-1===u?o=["*"]:(o=C.substr(u+1).split(","),C=C.substr(0,u)),-1===p?i="*":(i=C.substr(p+1),C=C.substr(0,p)),-1===m?s="*":(s=C.substr(m+1),C=C.substr(0,m)),-1===h?t="*":(t=C.substr(h+1).toUpperCase(),C=C.substr(0,h)),1==o.length&&"*"!==o[0]&&(c=!1);let g,f,b,y,v=[],w=[];if(v="*"===t?Object.keys(l.structures):t.split(","),"*"===s){let e=Object.keys(l.chains);for(let t=0,s=e.length;t<s;++t){f=e[t],g=f.substr(0,f.indexOf("_")),-1!==v.map((function(e){return e.toLowerCase()})).indexOf(g.toLowerCase())&&w.push(f)}}else for(let e=0,t=v.length;e<t;++e){g=v[e];let t=s.split(",");for(let e in t)w.push(g+"_"+t[e])}let S=i.split(",");for(let t=0,s=S.length;t<s;++t){let s,i,r=!1,c=S[t].lastIndexOf("-"),h=!1,m=!1,p=!1;if(-1!==c)b=S[t].substr(0,c),y=S[t].substr(c+1),r=!0;else if(""===S[t]||isNaN(S[t])){if("*"===S[t])h=!0;else if("3"===S[t][0]&&(S[t].length-1)%3==0){i=S[t].toUpperCase().substr(1),p=!0}else if("proteins"!==S[t]&&"nucleotides"!==S[t]&&"chemicals"!==S[t]&&"ions"!==S[t]&&"water"!==S[t]){s=S[t].toUpperCase(),m=!0}}else b=S[t],y=b,r=!0;for(let c=0,u=w.length;c<u;++c)if(f=w[c],r)for(let t=parseInt(b);t<=parseInt(y);++t){let s=f+"_"+t;0===e?a[s]=1:a.hasOwnProperty(s)||delete a[s];for(let t in l.residues[s])for(let s=0,i=o.length;s<i;++s){let i=o[s];"*"!==i&&i!==l.atoms[t].name||(0===e?d[t]=1:d.hasOwnProperty(t)||delete d[t])}}else if(f in l.chains){let r=l.chains[f];for(let s in r)if(l.atoms[s].resn.substr(0,3).toUpperCase(),h||"proteins"===S[t]&&s in l.proteins||"nucleotides"===S[t]&&s in l.nucleotides||"chemicals"===S[t]&&s in l.chemicals||"ions"===S[t]&&s in l.ions||"water"===S[t]&&s in l.water){if(0===e)a[f+"_"+l.atoms[s].resi]=1;else{let e=f+"_"+l.atoms[s].resi;a.hasOwnProperty(e)||delete a[e]}for(let t=0,i=o.length;t<i;++t){let i=o[t];"*"!==i&&i!==l.atoms[s].name||(0===e?d[s]=1:d.hasOwnProperty(s)||delete d[s])}}if(m||p){let t=m?1:3,r=m?s:i,c="",h=[];for(let e=0,t=l.chainsSeq[f].length;e<t;++e){if(m)c+=1==l.chainsSeq[f][e].name.length?l.chainsSeq[f][e].name:" ";else if(p){let t=n.utilsCls.residueAbbr2Name(l.chainsSeq[f][e].name);c+=3==t.length?t:"   "}h.push(l.chainsSeq[f][e].resi)}c=c.toUpperCase();let u=r.replace(/x/gi,"."),C=[],g=new RegExp(u,"i"),b=c,y=b.search(g),v=y/t;for(;-1!==y;)C.push(v),b=b.substr(y+t),y=b.search(g),v+=y/t+1;for(let s=0,i=C.length;s<i;++s){let i=C[s];for(let s=0,n=r.length/t;s<n;s+=t){let n=f+"_"+h[s/t+i];0===e?a[n]=1:a.hasOwnProperty(n)||delete a[n];for(let t in l.residues[n])for(let s=0,i=o.length;s<i;++s){let i=o[s];"*"!==i&&i!==l.atoms[t].name||(0===e?d[t]=1:d.hasOwnProperty(t)||delete d[t])}}}}}}}if(l.hAtoms=n.hashUtilsCls.cloneHash(d),0==Object.keys(l.hAtoms).length&&console.log("No residues were selected. Please try another search."),(void 0===i||i)&&l.hlUpdateCls.updateHlAll(),o=c?Object.keys(a):Object.keys(d),""!=t){l.selectionCls.addCustomSelection(o,t,s,e,c);let i=[t];l.definedSetsCls.changeCustomAtoms(i)}}}class ye{constructor(e){this.icn3d=e}residueids2spec(e){var t=this.icn3d;t.icn3dui;let s="";if(void 0!==e){let i,l,n,o,r,a,d,c=e.sort((function(e,t){if(""!==e&&!isNaN(e))return parseInt(e)-parseInt(t);{let s=e.lastIndexOf("_"),i=t.lastIndexOf("_");if(e.substr(0,s)<t.substr(0,i))return-1;if(e.substr(0,s)>t.substr(0,i))return 1;if(e.substr(0,s)==t.substr(0,i)){if(parseInt(e.substr(s+1))<parseInt(t.substr(i+1)))return-1;if(parseInt(e.substr(s+1))>parseInt(t.substr(i+1)))return 1;if(parseInt(e.substr(s+1))==parseInt(t.substr(i+1)))return 0}}})),h="",m=0,p=1!=Object.keys(t.structures).length;for(let e=0,t=c.length;e<t;++e){let t=c[e];n=t.lastIndexOf("_"),i=t.substr(0,n),l=parseInt(t.substr(n+1)),o=h.indexOf("_"),r=h.substr(0,o),a=h.substr(o+1),h!==i?(e>0&&(s+=m===d?p?"$"+r+"."+a+":"+d+" or ":"."+a+":"+d+" or ":p?"$"+r+"."+a+":"+d+"-"+m+" or ":"."+a+":"+d+"-"+m+" or "),d=l):h===i&&l!=parseInt(m)+1&&(s+=m===d?p?"$"+r+"."+a+":"+d+" or ":"."+a+":"+d+" or ":p?"$"+r+"."+a+":"+d+"-"+m+" or ":"."+a+":"+d+"-"+m+" or ",d=l),h=i,m=l}o=h.indexOf("_"),r=h.substr(0,o),a=h.substr(o+1),s+=m===d?p?"$"+r+"."+a+":"+d:"."+a+":"+d:p?"$"+r+"."+a+":"+d+"-"+m:"."+a+":"+d+"-"+m}return s}atoms2spec(e){var t=this.icn3d;t.icn3dui;let s="",i=0,l={},n={},o={};for(let r in e){let e=t.atoms[r];i>0&&(s+=" or "),s+="$"+e.structure+"."+e.chain+":"+e.resi+"@"+e.name,l[e.structure]=1,n[e.structure+"_"+e.chain]=1,o[e.structure+"_"+e.chain+"_"+e.resi]=1,++i}if(1==Object.keys(o).length){let e="\\$"+atom.structure+"\\."+atom.chain+":"+atom.resi;s=s.replace(new RegExp(e,"g"),"")}else if(1==Object.keys(n).length){let e="\\$"+atom.structure+"\\."+atom.chain;s=s.replace(new RegExp(e,"g"),"")}else if(1==Object.keys(l).length){let e="\\$"+atom.structure;s=s.replace(new RegExp(e,"g"),"")}return s}atoms2residues(e){var t=this.icn3d;t.icn3dui;let s={};for(let t=0,i=e.length;t<i;++t)s[e[t]]=1;let i=t.firstAtomObjCls.getResiduesFromAtoms(s);return Object.keys(i)}selectProperty(e,t,s){var i=this.icn3d,l=i.icn3dui;let n=l.hashUtilsCls.cloneHash(i.hAtoms);if("positive"==e){let e=":r,k,h";i.hAtoms={},i.selByCommCls.selectBySpec(e,e,e)}else if("negative"==e){let e=":d,e";i.hAtoms={},i.selByCommCls.selectBySpec(e,e,e)}else if("hydrophobic"==e){let e=":w,f,y,l,i,c,m";i.hAtoms={},i.selByCommCls.selectBySpec(e,e,e)}else if("polar"==e){let e=":g,v,s,t,a,n,p,q";i.hAtoms={},i.selByCommCls.selectBySpec(e,e,e)}else if("b factor"==e){let e=l.hashUtilsCls.cloneHash(i.calphas);e=l.hashUtilsCls.unionHash(e,i.nucleotidesO3),e=l.hashUtilsCls.unionHash(e,i.chemicals),e=l.hashUtilsCls.unionHash(e,i.ions),e=l.hashUtilsCls.unionHash(e,i.water),i.hAtoms={};for(let n in e){let e=i.atoms[n];e.b>=t&&e.b<=s&&(i.hAtoms=l.hashUtilsCls.unionHash(i.hAtoms,i.residues[e.structure+"_"+e.chain+"_"+e.resi]))}}else if("percent out"==e){i.bCalcArea=!0,i.opts.surface="solvent accessible surface",i.applyMapCls.applySurfaceOptions(),i.bCalcArea=!1,i.hAtoms={};for(let e in i.resid2area){let n=e.lastIndexOf("_"),o=e.substr(n+1);if(l.parasCls.residueArea.hasOwnProperty(o)){let r=parseInt(i.resid2area[e]/l.parasCls.residueArea[o]*100);if(r>=t&&r<=s){let t=e.substr(0,n);i.hAtoms=l.hashUtilsCls.unionHash(i.hAtoms,i.residues[t])}}}}i.hAtoms=l.hashUtilsCls.intHash(i.hAtoms,n),i.drawCls.draw(),i.hlUpdateCls.updateHlAll()}selectComplement(){let e=this.icn3d,t=e.icn3dui,s={};for(let t in e.atoms)e.hAtoms.hasOwnProperty(t)||(s[t]=1);e.hAtoms=t.hashUtilsCls.cloneHash(s),e.hlUpdateCls.updateHlAll()}switchHighlightLevel(){var e=this.icn3d,t=e.icn3dui;if(e.icn3dui.bNode)return;let s=this;document.addEventListener("keydown",(function(e){let i=s.icn3d;38===e.keyCode?(e.preventDefault(),0!=Object.keys(i.pickedAtomList).length&&i.hAtoms.hasOwnProperty(i.firstAtomObjCls.getFirstAtomObj(i.pickedAtomList).serial)||(i.pickedAtomList=t.hashUtilsCls.cloneHash(i.hAtoms)),s.switchHighlightLevelUp(),i.icn3dui.htmlCls.clickMenuCls.setLogCmd("highlight level up",!0)):40===e.keyCode&&(e.preventDefault(),0!=Object.keys(i.pickedAtomList).length&&i.hAtoms.hasOwnProperty(i.firstAtomObjCls.getFirstAtomObj(i.pickedAtomList).serial)||(i.pickedAtomList=t.hashUtilsCls.cloneHash(i.hAtoms)),s.switchHighlightLevelDown(),i.icn3dui.htmlCls.clickMenuCls.setLogCmd("highlight level down",!0))}))}switchHighlightLevelUp(){var e=this.icn3d,t=e.icn3dui;if(!e.icn3dui.bNode){if(e.bShift||e.bCtrl||e.hlObjectsCls.removeHlObjects(),void 0!==e.pickedAtomList&&0!==Object.keys(e.pickedAtomList).length||(e.pickedAtomList=t.hashUtilsCls.cloneHash(e.hAtoms)),0===Object.keys(e.pickedAtomList).length&&(e.pickedAtomList=e.dAtoms),1===e.highlightlevel){e.highlightlevel=2;let s=e.firstAtomObjCls.getFirstAtomObj(e.pickedAtomList);e.bShift||e.bCtrl?e.hAtoms=t.hashUtilsCls.unionHash(e.hAtoms,e.residues[s.structure+"_"+s.chain+"_"+s.resi]):e.hAtoms=t.hashUtilsCls.cloneHash(e.residues[s.structure+"_"+s.chain+"_"+s.resi])}else if(2===e.highlightlevel){e.highlightlevel=3;let s=e.firstAtomObjCls.getFirstAtomObj(e.pickedAtomList);e.bShift||e.bCtrl?e.hAtoms=t.hashUtilsCls.unionHash(e.hAtoms,e.pickingCls.selectStrandHelixFromAtom(s)):e.hAtoms=t.hashUtilsCls.cloneHash(e.pickingCls.selectStrandHelixFromAtom(s))}else if(3===e.highlightlevel){let s;if(void 0!==e.icn3dui.cfg.mmdbid||void 0!==e.icn3dui.cfg.gi){e.highlightlevel=4;let i=e.firstAtomObjCls.getFirstAtomObj(e.pickedAtomList);s=e.pickingCls.select3ddomainFromAtom(i),e.bShift||e.bCtrl?e.hAtoms=t.hashUtilsCls.unionHash(e.hAtoms,s):e.hAtoms=t.hashUtilsCls.cloneHash(s)}if(void 0===e.icn3dui.cfg.mmdbid&&void 0===e.icn3dui.cfg.gi||0==Object.keys(s).length){e.highlightlevel=5;let s=e.firstAtomObjCls.getFirstAtomObj(e.pickedAtomList);e.bShift||e.bCtrl?e.hAtoms=t.hashUtilsCls.unionHash(e.hAtoms,e.chains[s.structure+"_"+s.chain]):e.hAtoms=t.hashUtilsCls.cloneHash(e.chains[s.structure+"_"+s.chain])}}else if(4===e.highlightlevel){e.highlightlevel=5;let s=e.firstAtomObjCls.getFirstAtomObj(e.pickedAtomList);e.bShift||e.bCtrl?e.hAtoms=t.hashUtilsCls.unionHash(e.hAtoms,e.chains[s.structure+"_"+s.chain]):e.hAtoms=t.hashUtilsCls.cloneHash(e.chains[s.structure+"_"+s.chain])}else if(5===e.highlightlevel||6===e.highlightlevel){e.highlightlevel=6;let s=e.firstAtomObjCls.getFirstAtomObj(e.pickedAtomList);e.bShift||e.bCtrl||(e.hAtoms={});let i=e.structures[s.structure];for(let s=0,l=i.length;s<l;++s)e.hAtoms=t.hashUtilsCls.unionHash(e.hAtoms,e.chains[i[s]])}e.hlObjectsCls.addHlObjects(),e.hlUpdateCls.updateHlAll()}}switchHighlightLevelDown(){var e=this.icn3d,t=e.icn3dui;if(!e.icn3dui.bNode){if(e.hlObjectsCls.removeHlObjects(),void 0!==e.pickedAtomList&&0!==Object.keys(e.pickedAtomList).length||(e.pickedAtomList=t.hashUtilsCls.cloneHash(e.hAtoms)),2!==e.highlightlevel&&1!==e.highlightlevel||1!==Object.keys(e.pickedAtomList).length){if(3===e.highlightlevel){let s={};for(let t in e.pickedAtomList)residueid=e.atoms[t].structure+"_"+e.atoms[t].chain+"_"+e.atoms[t].resi,s[residueid]=1;if(1===Object.keys(s).length){e.highlightlevel=2;let s=e.firstAtomObjCls.getFirstAtomObj(e.pickedAtomList);e.bShift||e.bCtrl?e.hAtoms=t.hashUtilsCls.unionHash(e.hAtoms,e.residues[s.structure+"_"+s.chain+"_"+s.resi]):e.hAtoms=t.hashUtilsCls.cloneHash(e.residues[s.structure+"_"+s.chain+"_"+s.resi])}}else if(4===e.highlightlevel){e.highlightlevel=3;let s=e.firstAtomObjCls.getFirstAtomObj(e.pickedAtomList);e.bShift||e.bCtrl?e.hAtoms=t.hashUtilsCls.unionHash(e.hAtoms,e.pickingCls.selectStrandHelixFromAtom(s)):e.hAtoms=t.hashUtilsCls.cloneHash(e.pickingCls.selectStrandHelixFromAtom(s))}else if(5===e.highlightlevel){let s;if(void 0!==e.icn3dui.cfg.mmdbid||void 0!==e.icn3dui.cfg.gi){e.highlightlevel=4;let i=e.firstAtomObjCls.getFirstAtomObj(e.pickedAtomList);s=e.pickingCls.select3ddomainFromAtom(i),e.bShift||e.bCtrl?e.hAtoms=t.hashUtilsCls.unionHash(e.hAtoms,s):e.hAtoms=t.hashUtilsCls.cloneHash(s)}if(void 0===e.icn3dui.cfg.mmdbid&&void 0===e.icn3dui.cfg.gi||0==Object.keys(s).length){e.highlightlevel=3;let s=e.firstAtomObjCls.getFirstAtomObj(e.pickedAtomList);e.bShift||e.bCtrl?e.hAtoms=t.hashUtilsCls.unionHash(e.hAtoms,e.pickingCls.selectStrandHelixFromAtom(s)):e.hAtoms=t.hashUtilsCls.cloneHash(e.pickingCls.selectStrandHelixFromAtom(s))}}else if(6===e.highlightlevel){e.highlightlevel=5;let s=e.firstAtomObjCls.getFirstAtomObj(e.pickedAtomList);e.bShift||e.bCtrl?e.hAtoms=t.hashUtilsCls.unionHash(e.hAtoms,e.chains[s.structure+"_"+s.chain]):e.hAtoms=t.hashUtilsCls.cloneHash(e.chains[s.structure+"_"+s.chain])}}else e.highlightlevel=1,e.hAtoms=t.hashUtilsCls.cloneHash(e.pickedAtomList),e.bShift||e.bCtrl?e.hAtoms=t.hashUtilsCls.unionHash(e.hAtoms,e.pickedAtomList):e.hAtoms=t.hashUtilsCls.cloneHash(e.pickedAtomList);e.hlObjectsCls.addHlObjects(),e.hlUpdateCls.updateHlAll()}}}class ve{constructor(e){this.icn3d=e}setSeqAlign(e,t){let s=this.icn3d;s.icn3dui;let i=t[0][0].pdbId,l=t[0][1].pdbId;s.conservedName1=i+"_cons",s.nonConservedName1=i+"_ncons",s.notAlignedName1=i+"_nalign",s.conservedName2=l+"_cons",s.nonConservedName2=l+"_ncons",s.notAlignedName2=l+"_nalign",s.consHash1={},s.nconsHash1={},s.nalignHash1={},s.consHash2={},s.nconsHash2={},s.nalignHash2={};for(let t=0,n=e.length;t<n;++t){let n=e[t][0],o=n.moleculeId,r=s.pdbid_molid2chain[i+"_"+o],a=i+"_"+r,d={},c=n.sequence.length,h=-1,m=!1;for(let e=0,t=n.sequence.length;e<t;++e){let t=s.chainid2offset[a]?s.chainid2offset[a]:0,i=s.bUsePdbNum?n.sequence[e][0]+t:n.sequence[e][0],l="~"===n.sequence[e][2]?"-":n.sequence[e][2];l=" "===l||""===l?"X":l;let o=n.sequence[e][3]?1:0;1==o&&(e<c&&!m&&(c=e,m=!0),e>h&&(h=e)),d[e]={resi:i,resn:l,aligned:o}}n=e[t][1];let p=n.moleculeId,u=s.pdbid_molid2chain[l+"_"+p],C=l+"_"+u;void 0===s.alnChainsAnTtl[a]&&(s.alnChainsAnTtl[a]=[]),void 0===s.alnChainsAnTtl[a][0]&&(s.alnChainsAnTtl[a][0]=[]),void 0===s.alnChainsAnTtl[a][1]&&(s.alnChainsAnTtl[a][1]=[]),void 0===s.alnChainsAnTtl[a][2]&&(s.alnChainsAnTtl[a][2]=[]),void 0===s.alnChainsAnTtl[a][3]&&(s.alnChainsAnTtl[a][3]=[]),void 0===s.alnChainsAnTtl[a][4]&&(s.alnChainsAnTtl[a][4]=[]),void 0===s.alnChainsAnTtl[a][5]&&(s.alnChainsAnTtl[a][5]=[]),void 0===s.alnChainsAnTtl[a][6]&&(s.alnChainsAnTtl[a][6]=[]),s.alnChainsAnTtl[a][0].push(C),s.alnChainsAnTtl[a][1].push(a),s.alnChainsAnTtl[a][2].push(""),s.alnChainsAnTtl[a][3].push(""),s.alnChainsAnTtl[a][4].push(C),s.alnChainsAnTtl[a][5].push(a),s.alnChainsAnTtl[a][6].push("");let g=1;for(let e=c;e<=h;++e){let t,o,h,m=s.chainid2offset[C]?s.chainid2offset[C]:0,p=s.bUsePdbNum?n.sequence[e][0]+m:n.sequence[e][0],f="~"===n.sequence[e][2]?"-":n.sequence[e][2],b=n.sequence[e][3]?1:0,y=d[e].aligned+b;2===y?(d[e].resn===f?(t="#FF0000",h="icn3d-cons",s.consHash1[a+"_"+d[e].resi]=1,s.consHash2[C+"_"+p]=1):(t="#0000FF",h="icn3d-ncons",s.nconsHash1[a+"_"+d[e].resi]=1,s.nconsHash2[C+"_"+p]=1),o="#"+s.showAnnoCls.getColorhexFromBlosum62(d[e].resn,f)):(t=s.icn3dui.htmlCls.GREY8,h="icn3d-nalign",s.nalignHash1[a+"_"+d[e].resi]=1,s.nalignHash2[C+"_"+p]=1),void 0===s.alnChainsSeq[a]&&(s.alnChainsSeq[a]=[]);let v={};v.mmdbid=i,v.chain=r,v.resi=d[e].resi,v.resn=""===v.resi||"icn3d-nalign"===h?d[e].resn.toLowerCase():d[e].resn,v.aligned=y,v.color=""===v.resi?s.icn3dui.htmlCls.GREYC:t,v.color2=""===v.resi?s.icn3dui.htmlCls.GREYC:o,v.class=h,s.alnChainsSeq[a].push(v),""!==d[e].resi&&(void 0===s.alnChains[a]&&(s.alnChains[a]={}),$.extend(s.alnChains[a],s.residues[a+"_"+d[e].resi])),void 0===s.alnChainsSeq[C]&&(s.alnChainsSeq[C]=[]),v={},v.mmdbid=l,v.chain=u,v.resi=p,v.resn=""===v.resi||"icn3d-nalign"===h?f.toLowerCase():f,v.aligned=y,v.color=""===v.resi?s.icn3dui.htmlCls.GREYC:t,v.color2=""===v.resi?s.icn3dui.htmlCls.GREYC:o,v.class=h,s.alnChainsSeq[C].push(v),""!==v.resi&&(void 0===s.alnChains[C]&&(s.alnChains[C]={}),$.extend(s.alnChains[C],s.residues[C+"_"+p])),void 0===s.alnChainsAnno[a]&&(s.alnChainsAnno[a]=[]),void 0===s.alnChainsAnno[a][0]&&(s.alnChainsAnno[a][0]=[]),void 0===s.alnChainsAnno[a][1]&&(s.alnChainsAnno[a][1]=[]),void 0===s.alnChainsAnno[a][2]&&(s.alnChainsAnno[a][2]=[]),void 0===s.alnChainsAnno[a][3]&&(s.alnChainsAnno[a][3]=[]),e===c&&(void 0===s.alnChainsAnno[a][4]&&(s.alnChainsAnno[a][4]=[]),void 0===s.alnChainsAnno[a][5]&&(s.alnChainsAnno[a][5]=[]),void 0===s.alnChainsAnno[a][6]&&(s.alnChainsAnno[a][6]=[]),s.alnChainsAnno[a][4].push(s.pdbid_chain2title[C]),s.alnChainsAnno[a][5].push(s.pdbid_chain2title[a]),s.alnChainsAnno[a][6].push(""));let w=a+"_"+d[e].resi,S=C+"_"+p,_=s.secondaries[w],A=s.secondaries[S];void 0!==A?s.alnChainsAnno[a][0].push(A):s.alnChainsAnno[a][0].push("-"),void 0!==_?s.alnChainsAnno[a][1].push(_):s.alnChainsAnno[a][1].push("-");let x=".";g%5==0&&(x="*"),g%10==0&&(x="|"),s.alnChainsAnno[a][2].push(x);let k="";g%10==0&&(k=g.toString()),s.alnChainsAnno[a][3].push(k),++g}}e={}}setSeqAlignChain(e,t){let s=this.icn3d;s.icn3dui;let i=s.chainidArray[0].indexOf("_"),l=e.indexOf("_"),n=s.mmdbid_t,o=e.substr(0,l).toUpperCase(),r=s.chainidArray[0].substr(i+1),a=e.substr(l+1);if(n==o&&r==a){let e=s.chainsSeq[s.mmdbid_q+"_"+s.chain_q].length;s.qt_start_end[t]={q_start:1,q_end:e,t_start:1,t_end:e}}let d,c,h,m,p,u=n+"_"+r,C=o+"_"+a;void 0!==o&&o===s.mmdbid_t&&(C=o+s.icn3dui.htmlCls.postfix+"_"+a),s.conservedName1=u+"_cons",s.nonConservedName1=u+"_ncons",s.notAlignedName1=u+"_nalign",s.conservedName2=C+"_cons",s.nonConservedName2=C+"_ncons",s.notAlignedName2=C+"_nalign",s.consHash1={},s.nconsHash1={},s.nalignHash1={},s.consHash2={},s.nconsHash2={},s.nalignHash2={},s.alnChains={},s.alnChainsSeq[u]=[],s.alnChains[u]={},s.alnChainsAnno[u]=[],s.alnChainsAnTtl[u]=[],void 0===s.alnChainsAnTtl[u]&&(s.alnChainsAnTtl[u]=[]);for(let e=0;e<7;++e)void 0===s.alnChainsAnTtl[u][e]&&(s.alnChainsAnTtl[u][e]=[]);if(s.alnChainsAnTtl[u][0].push(C),s.alnChainsAnTtl[u][1].push(u),s.alnChainsAnTtl[u][2].push(""),s.alnChainsAnTtl[u][3].push(""),s.alnChainsAnTtl[u][4].push(C),s.alnChainsAnTtl[u][5].push(u),s.alnChainsAnTtl[u][6].push(""),void 0===s.qt_start_end[t])return;let g=1;for(let e=0,i=s.qt_start_end[t].length;e<i;++e){let i=s.qt_start_end[t][e].t_start-1,l=s.qt_start_end[t][e].q_start-1,n=s.qt_start_end[t][e].t_end-1,o=s.qt_start_end[t][e].q_end-1;if(e>0){let e=g;for(let t=m+1,l=i;t<l&&void 0!==s.chainsSeq[u];++t){let i=s.chainsSeq[u][t].resi,l=s.chainsSeq[u][t].name.toLowerCase();d=s.icn3dui.htmlCls.GREY8,h="icn3d-nalign",s.nalignHash1[u+"_"+i]=1,this.setSeqPerResi(u,u,C,i,l,!1,d,void 0,h,!0,!1,e),++e}let t=g;for(let e=p+1,i=l;e<i&&void 0!==s.chainsSeq[C];++e){let i=s.chainsSeq[C][e].resi,l=s.chainsSeq[C][e].name.toLowerCase();d=s.icn3dui.htmlCls.GREY8,h="icn3d-nalign",s.nalignHash2[C+"_"+i]=1,this.setSeqPerResi(C,u,C,i,l,!1,d,void 0,h,!1,!1,t),++t}if(e<t){g=t;for(let i=0;i<t-e;++i){let t="",l="-";d=s.icn3dui.htmlCls.GREY8,h="icn3d-nalign",this.setSeqPerResi(u,u,C,t,l,!1,d,void 0,h,!0,!1,e+i)}}else{g=e;for(let i=0;i<e-t;++i){let e="",l="-";d=s.icn3dui.htmlCls.GREY8,h="icn3d-nalign",this.setSeqPerResi(C,u,C,e,l,!1,d,void 0,h,!1,!1,t+i)}}}for(let t=0;t<=n-i&&(void 0!==s.chainsSeq[u]&&void 0!==s.chainsSeq[C]);++t){if(void 0===s.chainsSeq[u][t+i]||void 0===s.chainsSeq[C][t+l])continue;let n=s.chainsSeq[u][t+i].resi,o=s.chainsSeq[C][t+l].resi,r=s.chainsSeq[u][t+i].name.toUpperCase(),a=s.chainsSeq[C][t+l].name.toUpperCase();r===a?(d="#FF0000",h="icn3d-cons",s.consHash1[u+"_"+n]=1,s.consHash2[C+"_"+o]=1):(d="#0000FF",h="icn3d-ncons",s.nconsHash1[u+"_"+n]=1,s.nconsHash2[C+"_"+o]=1),c="#"+s.showAnnoCls.getColorhexFromBlosum62(r,a);let m=0===e&&0===t;this.setSeqPerResi(u,u,C,n,r,!0,d,c,h,!0,m,g),this.setSeqPerResi(C,u,C,o,a,!0,d,c,h,!1,m,g),++g}m=n,p=o}}setSeqAlignForRealign(e,t,s){let i=this.icn3d,l=i.icn3dui,n=e.substr(0,e.indexOf("_")),o=t.substr(0,t.indexOf("_"));n==o&&(o+=i.icn3dui.htmlCls.postfix),i.conservedName1=n+"_cons",i.conservedName2=o+"_cons",i.consHash1={},i.consHash2={},i.alnChainsAnTtl={},i.alnChainsAnno={},void 0===i.alnChainsSeq&&(i.alnChainsSeq={}),i.alnChains={},i.alnChainsSeq[e]=[],i.alnChains[e]={},i.alnChainsAnno[e]=[],i.alnChainsAnTtl[e]=[];let r={};for(let e=0,t=i.realignResid[n].length;e<t;++e){let t=i.realignResid[n][e],s=t.resid.lastIndexOf("_"),a=t.resid.substr(0,s),d=t.resid.substr(s+1);t.resi=d,t.aligned=!0;let c,h=i.realignResid[o][e],m=h.resid.lastIndexOf("_"),p=h.resid.substr(0,m),u=h.resid.substr(m+1);h.resi=u,h.aligned=!0,r[t.resid]=1,r[h.resid]=1,c=t.resn==h.resn?"#FF0000":"#0000FF";let C="#"+i.showAnnoCls.getColorhexFromBlosum62(t.resn,h.resn);t.color=c,h.color=c,t.color2=C,h.color2=C;for(let e in i.residues[t.resid])i.atoms[e].color=l.parasCls.thr(c);for(let e in i.residues[h.resid])i.atoms[e].color=l.parasCls.thr(c);void 0===i.alnChainsAnTtl[a]&&(i.alnChainsAnTtl[a]=[]);for(let e=0;e<3;++e)void 0===i.alnChainsAnTtl[a][e]&&(i.alnChainsAnTtl[a][e]=[]);for(let e=0;e<3;++e)i.alnChainsAnTtl[a][e].push("");void 0===i.alnChainsSeq[a]&&(i.alnChainsSeq[a]=[]),void 0===i.alnChainsSeq[p]&&(i.alnChainsSeq[p]=[]),i.alnChainsSeq[a].push(t),i.alnChainsSeq[p].push(h),void 0===i.alnChains[a]&&(i.alnChains[a]={}),void 0===i.alnChains[p]&&(i.alnChains[p]={}),$.extend(i.alnChains[a],i.residues[a+"_"+t.resi]),$.extend(i.alnChains[p],i.residues[p+"_"+h.resi]),i.consHash1[a+"_"+t.resi]=1,i.consHash2[p+"_"+h.resi]=1,void 0===i.alnChainsAnno[a]&&(i.alnChainsAnno[a]=[]);for(let e=0;e<3;++e)void 0===i.alnChainsAnno[a][e]&&(i.alnChainsAnno[a][e]=[]);let g=".";e%5==0&&(g="*"),e%10==0&&(g="|"),i.alnChainsAnno[a][0].push(g);let f="";e%10==0&&(f=e.toString()),i.alnChainsAnno[a][1].push(f)}let a="select "+i.resid2specCls.residueids2spec(Object.keys(r));i.selectionCls.addCustomSelection(Object.keys(r),"protein_aligned","protein aligned",a,!0)}setSeqPerResi(e,t,s,i,l,n,o,r,a,d,c,h){let m=this.icn3d;m.icn3dui,void 0===m.alnChainsSeq[e]&&(m.alnChainsSeq[e]=[]);let p={},u=e.indexOf("_");if(p.mmdbid=e.substr(0,u),p.chain=e.substr(u+1),p.resi=i,p.resn=""===p.resi||"icn3d-nalign"===a?l.toLowerCase():l,p.aligned=n,p.color=""===p.resi?m.icn3dui.htmlCls.GREYC:o,p.color2=""===p.resi?m.icn3dui.htmlCls.GREYC:r,p.class=a,m.alnChainsSeq[e].push(p),""!==p.resi&&(void 0===m.alnChains[e]&&(m.alnChains[e]={}),$.extend(m.alnChains[e],m.residues[e+"_"+p.resi])),d){if(void 0===m.alnChainsAnno[e]&&(m.alnChainsAnno[e]=[]),void 0===m.alnChainsAnno[e][0]&&(m.alnChainsAnno[e][0]=[]),void 0===m.alnChainsAnno[e][1]&&(m.alnChainsAnno[e][1]=[]),void 0===m.alnChainsAnno[e][2]&&(m.alnChainsAnno[e][2]=[]),void 0===m.alnChainsAnno[e][3]&&(m.alnChainsAnno[e][3]=[]),c){void 0===m.alnChainsAnno[e][4]&&(m.alnChainsAnno[e][4]=[]),void 0===m.alnChainsAnno[e][5]&&(m.alnChainsAnno[e][5]=[]),void 0===m.alnChainsAnno[e][6]&&(m.alnChainsAnno[e][6]=[]);let t=m.pdbid_chain2title&&m.pdbid_chain2title.hasOwnProperty(s)?m.pdbid_chain2title[s]:"",i=m.pdbid_chain2title&&m.pdbid_chain2title.hasOwnProperty(e)?m.pdbid_chain2title[e]:"";m.alnChainsAnno[e][4].push(t),m.alnChainsAnno[e][5].push(i),m.alnChainsAnno[e][6].push("")}let t=".";h%5==0&&(t="*"),h%10==0&&(t="|"),m.alnChainsAnno[e][2].push(t);let l="";h%10==0&&(l=h.toString()),m.alnChainsAnno[e][3].push(l);let n=e+"_"+i,o=m.secondaries[n];void 0!==o?m.alnChainsAnno[e][1].push(o):m.alnChainsAnno[e][1].push("-")}else{let s=e+"_"+i,l=m.secondaries[s];m.alnChainsAnno.hasOwnProperty(t)&&m.alnChainsAnno[t].length>0?void 0!==l?m.alnChainsAnno[t][0].push(l):m.alnChainsAnno[t][0].push("-"):console.log("Error: ic.alnChainsAnno[chainid1] is undefined")}}}class we{constructor(e){this.icn3d=e}alignCoords(e,t,s,i,l,n,o,r){let a=this.icn3d,d=a.icn3dui,c=e.length<t.length?e.length:t.length,h={};if(c<4&&alert("Please select at least four residues in each structure..."),c>=4&&(a.rmsd_suprTmp=d.rmsdSuprCls.getRmsdSuprCls(e,t,c),void 0!==a.rmsd_suprTmp.rot)){let e=a.rmsd_suprTmp.rot;null===e[0]&&alert("Please select more residues in each structure...");let t=a.rmsd_suprTmp.trans1,d=a.rmsd_suprTmp.trans2,c=a.rmsd_suprTmp.rmsd;c&&(a.icn3dui.htmlCls.clickMenuCls.setLogCmd("realignment RMSD: "+c.toPrecision(4),!1),$("#"+a.pre+"realignrmsd").val(c.toPrecision(4)),a.icn3dui.cfg.bSidebyside||a.icn3dui.htmlCls.dialogCls.openDlg("dl_rmsd","Realignment RMSD"));for(let i=0,l=a.structures[s].length;i<l;++i){let l=a.structures[s][i];for(let s in a.chains[l]){let i=a.atoms[s];i.coord=a.surfaceCls.transformMemPro(i.coord,e,t,d)}}a.bRealign=!0,i||a.setSeqAlignCls.setSeqAlignForRealign(l,n,o);let m=!1,p=a.icn3dui.htmlCls.alignSeqCls.getAlignSequencesAnnotations(Object.keys(a.alnChains),void 0,void 0,m),u=1===o?"":$("#"+a.pre+"dl_sequence2").html();$("#"+a.pre+"dl_sequence2").html(u+p.sequencesHtml),$("#"+a.pre+"dl_sequence2").width(a.icn3dui.htmlCls.RESIDUE_WIDTH*p.maxSeqCnt+200),a.icn3dui.htmlCls.dialogCls.openDlg("dl_alignment","Select residues in aligned sequences"),r||(a.opts.color="identity",a.setColorCls.setColorByOptions(a.opts,a.hAtoms)),h=a.hAtoms}return h}getMissingResidues(e,t,s){let i=this.icn3d,l=i.icn3dui;i.chainsSeq[s]=[];for(let n=0,o=e.length;n<o;++n){let o,r;"mmdbid"===t?(o=e[n][1],r=0):"mmcifid"===t?(o=e[n][1],o=l.utilsCls.residueName2Abbr(o),r=0):"align"===t&&(o=e[n][1],r=0),""===o&&(o="x");let a={};if(i.bUsePdbNum){let t=i.chainid2offset[s]?i.chainid2offset[s]:0;a.resi="0"==e[n][r]?n+1+t:e[n][r]}else a.resi=n+1;a.name=o.toLowerCase(),i.chainsSeq[s].push(a)}}set2DDiagramsForAlign(e,t){let s=this.icn3d;s.icn3dui,s.icn3dui.htmlCls.dialogCls.openDlg("dl_2ddgm","Interactions"),e=e.substr(0,4),t=t.substr(0,4);let i=s.icn3dui.htmlCls.baseUrl+"mmdb/mmdb_strview.cgi?v=2&program=icn3d&uid="+e+"&intrac=1",l=s.icn3dui.htmlCls.baseUrl+"mmdb/mmdb_strview.cgi?v=2&program=icn3d&uid="+t+"&intrac=1";void 0!==s.icn3dui.cfg.inpara&&(i+=s.icn3dui.cfg.inpara,l+=s.icn3dui.cfg.inpara),$.ajax({url:i,dataType:"jsonp",cache:!0}).then((function(t){return s.interactionData1=t,s.html2ddgm="",s.diagram2dCls.draw2Ddgm(t,e,0),s.icn3dui.cfg.show2d&&s.icn3dui.htmlCls.dialogCls.openDlg("dl_2ddgm","Interactions"),$.ajax({url:l,dataType:"jsonp",cache:!0})})).done((function(e){s.interactionData2=e,s.diagram2dCls.draw2Ddgm(e,t,1),s.html2ddgm+="<br>"+s.diagram2dCls.set2DdgmNote(!0),$("#"+s.pre+"dl_2ddgm").html(s.html2ddgm),s.b2DShown=!0,void 0!==s.deferredViewinteraction&&s.deferredViewinteraction.resolve()}))}set2DDiagramsForChainalign(e){let t=this.icn3d;t.icn3dui;let s=this;t.icn3dui.htmlCls.dialogCls.openDlg("dl_2ddgm","Interactions");let i=[];for(let s=0,l=e.length;s<l;++s){let l=e[s].indexOf("_"),n=e[s].substr(0,l).toUpperCase(),o=t.icn3dui.htmlCls.baseUrl+"mmdb/mmdb_strview.cgi?v=2&program=icn3d&uid="+n+"&intrac=1";void 0!==t.icn3dui.cfg.inpara&&(o+=t.icn3dui.cfg.inpara);let r=$.ajax({url:o,dataType:"jsonp",cache:!0});i.push(r)}$.when.apply(void 0,i).then((function(){let t=1==e.length?[arguments]:Array.from(arguments);s.parse2DDiagramsData(t,e)})).fail((function(){}))}parse2DDiagramsData(e,t){let s=this.icn3d;s.icn3dui,s.html2ddgm="";for(let i=0,l=t.length;i<l;++i){let l=e[i][0],n=t[i].substr(0,t[i].indexOf("_"));s.diagram2dCls.draw2Ddgm(l,n,0)}s.html2ddgm+="<br>"+s.diagram2dCls.set2DdgmNote(!0),s.b2DShown=!0,$("#"+s.pre+"dl_2ddgm").html(s.html2ddgm),s.icn3dui.cfg.show2d&&s.icn3dui.htmlCls.dialogCls.openDlg("dl_2ddgm","Interactions"),void 0!==s.deferredViewinteraction&&s.deferredViewinteraction.resolve()}download2Ddgm(e,t){this.set2DDiagrams(e)}set2DDiagrams(e){let t=this.icn3d;t.icn3dui,t.icn3dui.htmlCls.dialogCls.openDlg("dl_2ddgm","Interactions"),void 0!==t.b2DShown&&t.b2DShown||(t.html2ddgm="",t.diagram2dCls.draw2Ddgm(t.interactionData,e),t.html2ddgm+="<br>"+t.diagram2dCls.set2DdgmNote(),$("#"+t.pre+"dl_2ddgm").html(t.html2ddgm)),t.b2DShown=!0}showLoading(){let e=this.icn3d;e.icn3dui,$("#"+e.pre+"wait")&&$("#"+e.pre+"wait").show(),$("#"+e.pre+"canvas")&&$("#"+e.pre+"canvas").hide(),$("#"+e.pre+"cmdlog")&&$("#"+e.pre+"cmdlog").hide()}hideLoading(){let e=this.icn3d;e.icn3dui,$("#"+e.pre+"wait")&&$("#"+e.pre+"wait").hide(),$("#"+e.pre+"canvas")&&$("#"+e.pre+"canvas").show(),$("#"+e.pre+"cmdlog")&&$("#"+e.pre+"cmdlog").show()}setYourNote(e){let t=this.icn3d;t.icn3dui,t.yournote=e,$("#"+t.pre+"yournote").val(t.yournote),t.icn3dui.cfg.shownote&&(document.title=t.yournote)}transformToOpmOri(e){let t=this.icn3d;if(t.icn3dui,void 0!==t.rmsd_supr&&void 0!==t.rmsd_supr.rot){let s=t.rmsd_supr.rot,i=t.rmsd_supr.trans1,l=t.rmsd_supr.trans2;t.rmsd_supr.rmsd;let n=0;for(let e in t.atoms){let o=t.atoms[e];o.coord=t.surfaceCls.transformMemPro(o.coord,s,i,l);let r=o.coord.x*o.coord.x+o.coord.y*o.coord.y;Math.abs(o.coord.z)<=25&&r>n&&(n=r)}this.addMemAtoms(t.halfBilayerSize,e,Math.sqrt(n)),t.bStopRotate=!0,t.bOpm=!0,$("#"+t.pre+"togglememli").show(),$("#"+t.pre+"adjustmemli").show(),$("#"+t.pre+"selectplaneli").show(),$("#"+t.pre+"anno_transmemli").show()}else t.bOpm=!1}transformToOpmOriForAlign(e,t,s){let i=this.icn3d,l=i.icn3dui;if(void 0!==t){let n=i.loadPDBCls.getChainCalpha(i.chains,i.atoms,s,e),o=1==Object.keys(n.chainresiCalphaHash).length||1==Object.keys(t.chainresiCalphaHash).length,r=[],a=[];for(let e in n.chainresiCalphaHash)if(t.chainresiCalphaHash.hasOwnProperty(e)){let s=n.chainresiCalphaHash[e],i=t.chainresiCalphaHash[e];if((s.length==i.length||o)&&(r=r.concat(s),a=a.concat(i)),r.length>500)break}let d=r.length<a.length?r.length:a.length;if(d>=4)if(i.rmsd_supr=l.rmsdSuprCls.getRmsdSuprCls(r,a,d),void 0!==i.rmsd_supr.rot&&i.rmsd_supr.rmsd<.1){let s=i.rmsd_supr.rot,l=i.rmsd_supr.trans1,n=i.rmsd_supr.trans2,o=i.rmsd_supr.rmsd;i.icn3dui.htmlCls.clickMenuCls.setLogCmd("RMSD of alignment to OPM: "+o.toPrecision(4),!1),$("#"+i.pre+"realignrmsd").val(o.toPrecision(4)),i.icn3dui.cfg.bSidebyside||i.icn3dui.htmlCls.dialogCls.openDlg("dl_rmsd","RMSD of alignment to OPM");let r=0;for(let e in i.atoms){let t=i.atoms[e];t.coord=i.surfaceCls.transformMemPro(t.coord,s,l,n);let o=t.coord.x*t.coord.x+t.coord.y*t.coord.y;Math.abs(t.coord.z)<=25&&o>r&&(r=o)}i.center=t.center,i.oriCenter=i.center.clone(),this.addMemAtoms(i.halfBilayerSize,e,Math.sqrt(r)),i.bStopRotate=!0,i.bOpm=!0,$("#"+i.pre+"togglememli").show(),$("#"+i.pre+"adjustmemli").show(),$("#"+i.pre+"selectplaneli").show(),$("#"+i.pre+"anno_transmemli").show()}else i.bOpm=!1;else i.bOpm=!1}}addOneDumAtom(e,t,s,i,l,n){let o=this.icn3d,r=o.icn3dui,a={het:!0,serial:++n,name:t,alt:void 0,resn:"DUM",structure:e,chain:"MEM",resi:1,coord:new THREE.Vector3(s,i,l),b:void 0,elem:t,bonds:[],ss:"",ssbegin:!1,ssend:!1,color:r.parasCls.atomColors[t]};return o.atoms[n]=a,o.chains[e+"_MEM"][n]=1,o.residues[e+"_MEM_1"][n]=1,o.chemicals[n]=1,o.dAtoms[n]=1,o.hAtoms[n]=1,n}addMemAtoms(e,t,s){let i=this.icn3d;i.icn3dui;t=t?t.toUpperCase():"stru",i.structures[t].push(t+"_MEM"),i.chains[t+"_MEM"]={},i.residues[t+"_MEM_1"]={},i.chainsSeq[t+"_MEM"]=[{name:"DUM",resi:1}];let l=Object.keys(i.atoms).length;for(let e=0;e<1e3;++e)if(!i.atoms.hasOwnProperty(l+e)){l=l+e-1;break}for(let i=0;i<81;++i)for(let n=0;n<81;++n){let o=2*i-80,r=2*n-80;if(Math.sqrt(o*o+r*r)<s){let s=-e-.4;l=this.addOneDumAtom(t,"N",o,r,s,l),s=e+.4,l=this.addOneDumAtom(t,"O",o,r,s,l)}}}setMaxD(){let e=this.icn3d;e.icn3dui;let t=new THREE.Vector3(9999,9999,9999),s=new THREE.Vector3(-9999,-9999,-9999),i=new THREE.Vector3,l=0;for(let n in e.atoms){let o=e.atoms[n],r=o.coord;i.add(r),t.min(r),s.max(r),++l,o.het&&(0==o.bonds.length?e.ions[o.serial]=1:e.chemicals[o.serial]=1)}e.pmin=t,e.pmax=s,e.cnt=l,e.maxD=e.pmax.distanceTo(e.pmin),e.center=i.multiplyScalar(1/e.cnt),e.maxD<5&&(e.maxD=5),e.oriMaxD=e.maxD,e.oriCenter=e.center.clone()}renderStructure(){let e=this.icn3d,t=e.icn3dui;if(e.bInitial){if(e.bOpm&&(void 0!==e.icn3dui.cfg.align||void 0!==e.icn3dui.cfg.chainalign)){let s=e.selectedPdbid+"_MEM_1";for(let i in e.residues[s]){let s=e.atoms[i];s.style="stick",s.color=t.parasCls.atomColors[s.name],e.atomPrevColors[i]=s.color,e.dAtoms[i]=1}}if(void 0!==e.icn3dui.cfg.command&&""!==e.icn3dui.cfg.command?(e.bRender=!1,e.drawCls.draw()):(e.selectionCls.oneStructurePerWindow(),e.drawCls.draw()),e.bOpm){let t=new THREE.Vector3(1,0,0),s=-.5*Math.PI;e.transformCls.setRotation(t,s)}$("#"+e.pre+"alternate").show()}else e.selectionCls.saveSelectionIfSelected(),e.drawCls.draw();if(e.bInitial&&void 0!==e.icn3dui.cfg.command&&""!==e.icn3dui.cfg.command){if(1==Object.keys(e.structures).length){let t=Object.keys(e.structures)[0];e.icn3dui.cfg.command=e.icn3dui.cfg.command.replace(new RegExp("!","g"),t+"_")}e.loadScriptCls.loadScript(e.icn3dui.cfg.command)}else void 0!==e.icn3dui.deferred&&e.icn3dui.deferred.resolve(),void 0!==e.deferred2&&e.deferred2.resolve();Object.keys(e.structures).length>=2?($("#"+e.pre+"mn2_alternateWrap").show(),$("#"+e.pre+"mn2_realignWrap").show()):($("#"+e.pre+"mn2_alternateWrap").hide(),$("#"+e.pre+"mn2_realignWrap").hide()),setTimeout((function(){if(e.bInitial){if(e.icn3dui.cfg.showsets&&e.definedSetsCls.showSets(),void 0!==e.icn3dui.cfg.align||void 0!==e.icn3dui.cfg.chainalign){let t=e.pre+"selection";if($("#"+t).show(),$("#"+t+"_expand").hide(),$("#"+t+"_shrink").show(),void 0!==e.icn3dui.cfg.align){let t=!1,s=e.icn3dui.htmlCls.alignSeqCls.getAlignSequencesAnnotations(Object.keys(e.alnChains),void 0,void 0,t);$("#"+e.pre+"dl_sequence2").html(s.sequencesHtml),$("#"+e.pre+"dl_sequence2").width(e.icn3dui.htmlCls.RESIDUE_WIDTH*s.maxSeqCnt+200)}}if(e.icn3dui.cfg.showanno){let t="view annotations";e.icn3dui.htmlCls.clickMenuCls.setLogCmd(t,!0),e.showAnnoCls.showAnnotations()}e.icn3dui.cfg.closepopup&&e.resizeCanvasCls.closeDialogs()}else e.hlUpdateCls.updateHlAll();$("#"+e.pre+"atomsCustom").length>0&&$("#"+e.pre+"atomsCustom")[0].blur(),e.bInitial=!1}),0)}}class Se{constructor(e){this.icn3d=e}downloadMmcif(e){let t=this.icn3d;t.icn3dui;let s,i,l=this;s="https://files.rcsb.org/view/"+e+".cif",i="text",t.bCid=void 0,t.ParserUtilsCls.setYourNote(e.toUpperCase()+"(MMCIF) in iCn3D"),$.ajax({url:s,dataType:"text",cache:!0,tryCount:0,retryLimit:1,beforeSend:function(){t.ParserUtilsCls.showLoading()},complete:function(){},success:function(i){s=t.icn3dui.htmlCls.baseUrl+"mmcifparser/mmcifparser.cgi",$.ajax({url:s,type:"POST",data:{mmciffile:i},dataType:"jsonp",cache:!0,tryCount:0,retryLimit:1,beforeSend:function(){t.ParserUtilsCls.showLoading()},complete:function(){},success:function(t){l.loadMmcifData(t,e)},error:function(e,t,s){this.tryCount++,this.tryCount<=this.retryLimit&&$.ajax(this)}})},error:function(e,t,s){this.tryCount++,this.tryCount<=this.retryLimit&&$.ajax(this)}})}downloadMmcifSymmetry(e,t){let s=this.icn3d;s.icn3dui;let i=this;return s.deferredSymmetry=$.Deferred((function(){i.downloadMmcifSymmetryBase(e,t)})),s.deferredSymmetry.promise()}downloadMmcifSymmetryBase(e,t){let s,i,l=this.icn3d,n=l.icn3dui,o=this;s=n.utilsCls.isMac()?"https://files.rcsb.org/view/"+e+".cif":"https://files.rcsb.org/header/"+e+".cif",i="text",l.bCid=void 0,$.ajax({url:s,dataType:"text",cache:!0,tryCount:0,retryLimit:1,success:function(i){if(l.icn3dui.cfg.notebook){let s=i.split("\n"),r=!1,a=!1,d=!1,c=!1,h=0,m="",p="",u=!1,C=!1,g="",f="";for(let e in s){let t=s[e];if("EMDB  EMD-"==t.substr(0,10))l.emd=t.substr(6).trim();else if("_entity_src_nat.common_name"==t.substr(0,27))l.organism=t.substr(27).trim(),l.organism&&(r=!0),a=!0;else if(a&&!r&&"_entity_src_nat.details"==f.substr(0,23)){let e=t.split(/\s+/);l.organism=e.length>5?e[5]:"",r=!0}else if("_pdbx_struct_oper_list.vector"==f.substr(0,29)&&t.split(/\s+/).length>2){c=!0,++h;let e=t.indexOf(" "),s=t.indexOf("' ");p+=t.substr(0,e)+t.substr(s+1),m+="["}else if(c&&"#"==t.trim())"["!=m&&(m=m.substr(0,m.length-1)),m+="]",d=!0,c=!1;else if(c&&!d)if(++h,h%2==0){p+=t;let e=p.split(/\s+/);if("X0"!=e[0]&&"P"!=e[0]&&e.length>14){let t=e[3],s=e[4],i=e[5],l=e[6],n=e[7],o=e[8],r=e[9],a=e[10];m+="["+t+","+n+","+e[11]+", 0, "+s+","+o+","+e[12]+", 0, "+i+","+r+","+e[13]+", 0, "+l+","+a+","+e[14]+", 1],"}p=""}else{let e=t.indexOf(" "),s=t.indexOf("' ");p+=t.substr(0,e)+t.substr(s+1)}else if(C&&"#"==t.trim())"["!=g&&(g=g.substr(0,g.length-1)),g+="]",u=!0,C=!1;else if("_pdbx_poly_seq_scheic.hetero"==f.trim()||C&&!u){"_pdbx_poly_seq_scheic.hetero"==f.trim()&&(C=!0,g+="[");let e=t.split(/\s+/),s=e[3],i=e[9],l=e[5];"?"==e[6]&&(g+='{"resn": "'+s+'", "chain": "'+i+'", "resi": '+l+"},")}if(r&&d&&u)break;f=t}l.bAssemblyUseAsu&&o.loadMmcifSymmetry(JSON.parse(m)),""==g&&(g="[]");let b=JSON.parse(g);if("mmtfid"===t&&void 0!==b){let t=0,s="",i={};for(let l=0,o=b.length;l<o;++l){let o=b[l].resn,r=b[l].chain,a=b[l].resi,d=e+"_"+r;void 0===i[d]&&(i[d]=[]);let c={};c.resi=a,c.name=n.utilsCls.residueName2Abbr(o).toLowerCase(),r!=s&&(t=0),!isNaN(a)&&(""==s||r!=s||r==s&&a>t)&&(i[d].push(c),t=a,s=r)}l.loadPDBCls.adjustSeq(i)}void 0!==l.deferredSymmetry&&l.deferredSymmetry.resolve()}else s=l.icn3dui.htmlCls.baseUrl+"mmcifparser/mmcifparser.cgi",$.ajax({url:s,type:"POST",data:{mmcifheader:i},dataType:"jsonp",cache:!0,tryCount:0,retryLimit:1,success:function(s){if(void 0!==s.emd&&(l.emd=s.emd),void 0!==s.organism&&(l.organism=s.organism),l.bAssemblyUseAsu&&o.loadMmcifSymmetry(s.assembly),"mmtfid"===t&&void 0!==s.missingseq){let t=0,i="",o={};for(let l=0,r=s.missingseq.length;l<r;++l){let r=s.missingseq[l].resn,a=s.missingseq[l].chain,d=s.missingseq[l].resi,c=e+"_"+a;void 0===o[c]&&(o[c]=[]);let h={};h.resi=d,h.name=n.utilsCls.residueName2Abbr(r).toLowerCase(),a!=i&&(t=0),!isNaN(d)&&(""==i||a!=i||a==i&&d>t)&&(o[c].push(h),t=d,i=a)}l.loadPDBCls.adjustSeq(o)}void 0!==l.deferredSymmetry&&l.deferredSymmetry.resolve()},error:function(e,t,s){this.tryCount++,this.tryCount<=this.retryLimit?$.ajax(this):void 0!==l.deferredSymmetry&&l.deferredSymmetry.resolve()}})},error:function(e,t,s){this.tryCount++,this.tryCount<=this.retryLimit?$.ajax(this):void 0!==l.deferredSymmetry&&l.deferredSymmetry.resolve()}})}loadMmcifData(e,t){let s=this.icn3d;return s.icn3dui,t||(t=e.mmcif),t||(t="stru"),void 0!==e.atoms&&(s.init(),void 0!==e.emd&&(s.emd=e.emd),void 0!==e.organism&&(s.organism=e.organism),void 0!==s.emd?($("#"+s.pre+"mapWrapper1").hide(),$("#"+s.pre+"mapWrapper2").hide(),$("#"+s.pre+"mapWrapper3").hide()):($("#"+s.pre+"emmapWrapper1").hide(),$("#"+s.pre+"emmapWrapper2").hide(),$("#"+s.pre+"emmapWrapper3").hide()),s.deferredOpm=$.Deferred((function(){s.opmParserCls.loadOpmData(e,t,void 0,"mmcif")})),s.deferredOpm.promise())}loadMmcifSymmetry(e){let t=this.icn3d;t.icn3dui;for(let s=0,i=e.length;s<i;++s){let i=new THREE.Matrix4;i.fromArray(e[s]),t.biomtMatrices[s]=i}t.asuCnt=t.biomtMatrices.length}loadMmcifOpmDataPart2(e,t){let s=this.icn3d;s.icn3dui,1==Object.keys(s.structures).length&&$("#"+s.pre+"alternateWrapper").hide();let i=void 0!==e.assembly?e.assembly:[];for(let e=0,t=i.length;e<t;++e){null==s.biomtMatrices[e]&&(s.biomtMatrices[e]=(new THREE.Matrix4).identity());for(let t=0,l=i[e].length;t<l;++t)s.biomtMatrices[e].elements[t]=i[e][t]}void 0!==s.biomtMatrices&&s.biomtMatrices.length>1?($("#"+s.pre+"assemblyWrapper").show(),s.asuCnt=s.biomtMatrices.length):$("#"+s.pre+"assemblyWrapper").hide(),s.setStyleCls.setAtomStyleByOptions(s.opts),s.setColorCls.setColorByOptions(s.opts,s.atoms),s.ParserUtilsCls.renderStructure(),void 0!==s.icn3dui.cfg.rotate&&s.resizeCanvasCls.rotStruc(s.icn3dui.cfg.rotate,!0)}}class _e{constructor(e){this.icn3d=e}selectSequenceNonMobile(){let e=this.icn3d;if(e.icn3dui,e.icn3dui.bNode)return;let t=this;$("#"+e.pre+"dl_sequence2").add("[id^="+e.pre+"dt_giseq]").add("[id^="+e.pre+"dt_custom]").add("[id^="+e.pre+"dt_site]").add("[id^="+e.pre+"dt_snp]").add("[id^="+e.pre+"dt_clinvar]").add("[id^="+e.pre+"dt_cdd]").add("[id^="+e.pre+"dt_domain]").add("[id^="+e.pre+"dt_interaction]").add("[id^="+e.pre+"dt_ssbond]").add("[id^="+e.pre+"dt_crosslink]").add("[id^="+e.pre+"dt_transmem]").add("[id^="+e.pre+"tt_giseq]").add("[id^="+e.pre+"tt_custom]").add("[id^="+e.pre+"tt_site]").add("[id^="+e.pre+"tt_snp]").add("[id^="+e.pre+"tt_clinvar]").add("[id^="+e.pre+"tt_cdd]").add("[id^="+e.pre+"tt_domain]").add("[id^="+e.pre+"tt_interaction]").add("[id^="+e.pre+"tt_ssbond]").add("[id^="+e.pre+"tt_crosslink]").add("[id^="+e.pre+"tt_transmem]").selectable({stop:function(){let e=t.icn3d;$(this).attr("id")===e.pre+"dl_sequence2"?(e.bAlignSeq=!0,e.bAnnotations=!1):(e.bAlignSeq=!1,e.bAnnotations=!0),!1!==e.bSelectResidue||e.bShift||e.bCtrl||e.selectionCls.removeSelection(),$("span.ui-selected",this).each((function(){let e=$(this).attr("id");void 0!==e&&t.selectResidues(e,this)})),e.hlObjectsCls.addHlObjects();let s={};for(let t in e.selectedResidues){let e=t.lastIndexOf("_");s[t.substr(0,e)]=1}let i=Object.keys(s);e.hlUpdateCls.updateHl2D(i),$("div.ui-selected",this).each((function(){void 0!==$(this).attr("chain")&&t.selectTitle(this)}))}}),$("[id^="+e.pre+"ov_giseq]").add("[id^="+e.pre+"ov_custom]").add("[id^="+e.pre+"ov_site]").add("[id^="+e.pre+"ov_snp]").add("[id^="+e.pre+"ov_clinvar]").add("[id^="+e.pre+"ov_cdd]").add("[id^="+e.pre+"ov_domain]").add("[id^="+e.pre+"ov_interaction]").add("[id^="+e.pre+"ov_ssbond]").add("[id^="+e.pre+"ov_crosslink]").add("[id^="+e.pre+"ov_transmem]").add("[id^="+e.pre+"tt_giseq]").add("[id^="+e.pre+"tt_custom]").add("[id^="+e.pre+"tt_site]").add("[id^="+e.pre+"tt_snp]").add("[id^="+e.pre+"tt_clinvar]").add("[id^="+e.pre+"tt_cdd]").add("[id^="+e.pre+"tt_domain]").add("[id^="+e.pre+"tt_interaction]").add("[id^="+e.pre+"tt_ssbond]").add("[id^="+e.pre+"tt_crosslink]").add("[id^="+e.pre+"tt_transmem]").on("click",".icn3d-seqTitle",(function(e){let s=t.icn3d;e.stopImmediatePropagation(),s.bAlignSeq=!1,s.bAnnotations=!0,t.selectTitle(this),s.hlUpdateCls.hlSummaryDomain3ddomain(this),window.getSelection?window.getSelection().empty?window.getSelection().empty():window.getSelection().removeAllRanges&&window.getSelection().removeAllRanges():document.selection&&document.selection.empty()}))}selectSequenceMobile(){let e=this.icn3d;if(e.icn3dui,e.icn3dui.bNode)return;let t=this;$("#"+e.pre+"dl_sequence2").add("[id^="+e.pre+"giseq]").add("[id^="+e.pre+"custom]").add("[id^="+e.pre+"site]").add("[id^="+e.pre+"clinvar]").add("[id^="+e.pre+"snp]").add("[id^="+e.pre+"cdd]").add("[id^="+e.pre+"domain]").add("[id^="+e.pre+"interaction]").add("[id^="+e.pre+"ssbond]").add("[id^="+e.pre+"crosslink]").add("[id^="+e.pre+"transmem]").on("click",".icn3d-residue",(function(e){let s=t.icn3d;e.stopImmediatePropagation(),$(this).attr("id")===s.pre+"dl_sequence2"?(s.bAlignSeq=!0,s.bAnnotations=!1):(s.bAlignSeq=!1,s.bAnnotations=!0);let i=$(this).attr("id");void 0!==i&&t.selectResidues(i,this),s.hlObjectsCls.addHlObjects();let l={};for(let e in s.selectedResidues){let t=e.lastIndexOf("_");l[e.substr(0,t)]=1}s.hlUpdateCls.removeHl2D();let n=Object.keys(l);s.hlUpdateCls.updateHl2D(n)}))}selectChainMobile(){let e=this.icn3d;if(e.icn3dui,e.icn3dui.bNode)return;let t=this;$("#"+e.pre+"dl_sequence2").add("[id^="+e.pre+"giseq]").add("[id^="+e.pre+"custom]").add("[id^="+e.pre+"site]").add("[id^="+e.pre+"feat]").add("[id^="+e.pre+"clinvar]").add("[id^="+e.pre+"snp]").add("[id^="+e.pre+"cdd]").add("[id^="+e.pre+"domain]").add("[id^="+e.pre+"interaction]").add("[id^="+e.pre+"ssbond]").add("[id^="+e.pre+"crosslink]").add("[id^="+e.pre+"transmem]").on("click",".icn3d-seqTitle",(function(e){let s=t.icn3d;e.stopImmediatePropagation(),$(this).attr("id")===s.pre+"dl_sequence2"?(s.bAlignSeq=!0,s.bAnnotations=!1):(s.bAlignSeq=!1,s.bAnnotations=!0),t.selectTitle(this),s.hlUpdateCls.hlSummaryDomain3ddomain(this)}))}selectTitle(e){let t=this.icn3d,s=t.icn3dui;if(!t.icn3dui.bNode&&$(e).hasClass("icn3d-seqTitle")){let i,l,n,o=$(e).attr("chain");if(t.bAlignSeq?t.bSelectAlignResidue=!1:t.bSelectResidue=!1,t.bAnnotations||t.hlUpdateCls.removeSeqChainBkgd(o),t.bCtrl||t.bShift||(t.hlUpdateCls.removeSeqResidueBkgd(),t.hlUpdateCls.removeSeqChainBkgd(),t.currSelectedSets=[]),$(e).toggleClass("icn3d-highlightSeq"),t.bAnnotations?(i=$(e).attr("setname"),l=$(e).attr("title")):i=t.bAlignSeq?"align_"+o:o,$(e).hasClass("icn3d-highlightSeq"))if(t.bAnnotations){if($(e).hasClass("icn3d-highlightSeq"))if(t.hlUpdateCls.removeHl2D(),void 0!==$(e).attr("gi")){t.bCtrl||t.bShift?(t.currSelectedSets.push(o),t.selectionCls.selectAChain(o,o,!1,!0)):(t.currSelectedSets=[o],t.selectionCls.selectAChain(o,o,!1)),t.icn3dui.htmlCls.clickMenuCls.setLogCmd("select chain "+o,!0);let e=t.currSelectedSets.join(" or ");t.currSelectedSets.length>1&&t.icn3dui.htmlCls.clickMenuCls.setLogCmd("select sets "+e,!0)}else{let r={};if(void 0!==$(e).attr("domain")||void 0!==$(e).attr("feat")||void 0!==$(e).attr("3ddomain")||void 0!==$(e).attr("custom")){t.hlUpdateCls.hlSummaryDomain3ddomain(e);let a,d=$(e).attr("from").split(","),c=$(e).attr("to").split(",");for(let e=0,t=d.length;e<t;++e){let t=parseInt(d[e]),s=parseInt(c[e]);for(let e=t;e<=s;++e)a=o+"_"+(e+1).toString(),r[a]=1}t.bCtrl||t.bShift?t.selectionCls.selectResidueList(r,i,l,!0):t.selectionCls.selectResidueList(r,i,l,!1),a=o+"_"+parseInt((from+to)/2).toString(),n=t.applyCenterCls.centerAtoms(s.hashUtilsCls.hash2Atoms(t.residues[a],t.atoms))}else if(void 0!==$(e).attr("posarray")){let a,d=$(e).attr("posarray").split(",");for(let t=0,s=d.length;t<s;++t)a=void 0!==$(e).attr("site")?o+"_"+(parseInt(d[t])+1).toString():o+"_"+d[t],r[a]=1;t.bCtrl||t.bShift?t.selectionCls.selectResidueList(r,i,l,!0):t.selectionCls.selectResidueList(r,i,l,!1),a=o+"_"+d[parseInt((0+d.length)/2)].toString(),n=t.applyCenterCls.centerAtoms(s.hashUtilsCls.hash2Atoms(t.residues[a],t.atoms))}for(let e in t.labels)"schematic"!==e&&"distance"!==e&&(t.labels[e]=[]);let a=t.LABELSIZE,d="FFFF00";void 0!==n&&t.analysisCls.addLabel(l,n.center.x,n.center.y,n.center.z,a,d,void 0,"custom"),t.drawCls.draw(),t.icn3dui.htmlCls.clickMenuCls.setLogCmd("select "+t.resid2specCls.residueids2spec(Object.keys(r))+" | name "+i,!0),t.bCtrl||t.bShift?t.currSelectedSets.push(i):t.currSelectedSets=[i];let c=t.currSelectedSets.join(" or ");t.currSelectedSets.length>1&&t.icn3dui.htmlCls.clickMenuCls.setLogCmd("select sets "+c,!0)}}else{t.bCtrl||t.bShift?(t.currSelectedSets.push(i),t.selectionCls.selectAChain(o,i,!0,!0)):(t.currSelectedSets=[i],t.selectionCls.selectAChain(o,i,!0)),t.bAlignSeq?t.icn3dui.htmlCls.clickMenuCls.setLogCmd("select alignChain "+o,!0):t.icn3dui.htmlCls.clickMenuCls.setLogCmd("select chain "+o,!0);let e=t.currSelectedSets.join(" or ");t.currSelectedSets.length>1&&t.icn3dui.htmlCls.clickMenuCls.setLogCmd("select sets "+e,!0)}else t.hlObjectsCls.removeHlObjects(),t.hlUpdateCls.removeHl2D(),$("#"+t.pre+"atomsCustom").val("")}}selectResidues(e,t){let s=this.icn3d,i=s.icn3dui;if(!s.icn3dui.bNode&&void 0!==e&&""!==e){e=e.substr(e.indexOf("_")+1),s.bSelectResidue=!0,$(t).toggleClass("icn3d-highlightSeq");let l=e.substr(e.indexOf("_")+1);if(s.residues.hasOwnProperty(l))if($(t).hasClass("icn3d-highlightSeq")){for(let e in s.residues[l])s.hAtoms[e]=1;if(s.selectedResidues[l]=1,s.bAnnotations&&void 0!==$(t).attr("disease")){let e=$(t).attr("disease"),n=s.applyCenterCls.centerAtoms(i.hashUtilsCls.hash2Atoms(s.residues[l],s.atoms)),o=15;e.length>o&&(e=e.substr(0,o)+"...");let r=s.LABELSIZE,a=s.icn3dui.htmlCls.GREYD;s.analysisCls.addLabel(e,n.center.x,n.center.y,n.center.z,r,a,void 0,"custom")}}else{for(let e in s.residues[l])delete s.hAtoms[e];delete s.selectedResidues[l],s.hlObjectsCls.removeHlObjects()}}}}class Ae{constructor(e){this.icn3d=e}showAnnotations(){let e=this.icn3d;e.icn3dui;let t=this;if(e.icn3dui.htmlCls.dialogCls.openDlg("dl_selectannotations","Sequences and Annotations"),(void 0===e.bAssemblyNote||!e.bAssemblyNote)&&void 0!==e.asuCnt){let t="     <br><div id='"+e.pre+"assembly_note' style='margin-left:5px;'><span class='icn3d-annoLargeTitle'>Assembly Tips:</span> Only the asymmetric unit is shown in the sequence window.<br>Click \"Assembly\" in the menu \"View\" to switch between asymmetric unit and biological assembly(<b>"+e.asuCnt+"</b> asymmetric unit).</div>";$("#"+e.pre+"dl_annotations_tabs").append(t),e.bAssemblyNote=!0}if(void 0===e.bAnnoShown||!e.bAnnoShown){let s=Object.keys(e.chains);void 0===e.giSeq&&(e.giSeq={}),void 0===e.currClin&&(e.currClin={}),void 0===e.resi2disease_nonempty&&(e.resi2disease_nonempty={}),void 0===e.baseResi&&(e.baseResi={}),void 0===e.matchedPos&&(e.matchedPos={});let i=e.icn3dui.cfg.notebook?e.icn3dui.htmlCls.WIDTH/2:$("#"+e.pre+"dl_selectannotations").dialog("option","width");e.seqAnnWidth=i-120-60-50,e.maxAnnoLength=1;for(let t in e.chainsSeq)e.chainsSeq[t].length>e.maxAnnoLength&&(e.maxAnnoLength=e.chainsSeq[t].length);let l={},n={},o={};e.protein_chainid={};for(let t=0,i=s.length;t<i;++t){Math.round(s[t].indexOf("_"));let i=e.firstAtomObjCls.getFirstCalphaAtomObj(e.chains[s[t]]);if(void 0===i&&(i=e.firstAtomObjCls.getFirstAtomObj(e.chains[s[t]])),void 0===i)continue;let r,a=s[t].substr(s[t].indexOf("_")+1);if(-1!==a.indexOf("_")?(a=a.substr(0,a.indexOf("_")),r=s[t].substr(0,s[t].indexOf("_"))+"_"+a):r=s[t],e.proteins.hasOwnProperty(i.serial)&&e.chainsSeq[s[t]].length>1)e.protein_chainid[s[t]]=r;else if(e.nucleotides.hasOwnProperty(i.serial)&&e.chainsSeq[s[t]].length>1)l[s[t]]=r;else if(e.chainsSeq[s[t]].length>1)n[s[t]]=r;else{let i=e.chainsSeq[s[t]][0].name,l=s[t]+"_"+e.chainsSeq[s[t]][0].resi;void 0===o[i]&&(o[i]=[]),o[i].push(l)}if((void 0!==e.icn3dui.cfg.pdbid||void 0!==e.icn3dui.cfg.opmid||void 0!==e.icn3dui.cfg.mmcifid||void 0!==e.icn3dui.cfg.mmtfid)&&(e.proteins.hasOwnProperty(i.serial)||e.nucleotides.hasOwnProperty(i.serial)))for(let i=0,l=e.chainsSeq[s[t]].length;i<l;++i){let l=e.chainsSeq[s[t]][i];if(""!==l.name&&"-"!==l.name&&l.name==l.name.toUpperCase()){let i=s[t]+"_"+l.resi,n=e.firstAtomObjCls.getFirstCalphaAtomObj(e.residues[i]);if(void 0===n&&(n=e.firstAtomObjCls.getFirstAtomObj(e.chains[s[t]])),e.proteins.hasOwnProperty(n.serial)||e.nucleotides.hasOwnProperty(n.serial))continue;{let e=l.name.trim();void 0===o[e]&&(o[e]=[]),o[e].push(i)}}}}if(void 0===e.icn3dui.cfg.blast_rep_id){if(e.bFullUi)if(void 0!==e.icn3dui.cfg.mmtfid){let i=s[0].substr(0,s[0].indexOf("_"));$.when(e.mmcifParserCls.downloadMmcifSymmetry(i,"mmtfid")).then((function(){t.showAnnoSeqData(l,n,o)}))}else this.showAnnoSeqData(l,n,o)}else if(void 0!==e.icn3dui.cfg.blast_rep_id){let s=e.icn3dui.htmlCls.baseUrl+"pwaln/pwaln.fcgi?from=querytarget",i={targets:e.icn3dui.cfg.blast_rep_id,queries:e.icn3dui.cfg.query_id};if(void 0!==e.icn3dui.cfg.query_from_to){let t=e.icn3dui.cfg.query_from_to.split(":");for(let e=0,s=t.length;e<s;++e)t[e]=parseInt(t[e])-1;i.queries=e.icn3dui.cfg.query_id+":"+t.join(":")}if(void 0!==e.icn3dui.cfg.target_from_to){let t=e.icn3dui.cfg.target_from_to.split(":");for(let e=0,s=t.length;e<s;++e)t[e]=parseInt(t[e])-1;i.targets=e.icn3dui.cfg.blast_rep_id+":"+t.join(":")}$.ajax({url:s,type:"POST",data:i,dataType:"jsonp",tryCount:0,retryLimit:1,success:function(s){e.seqStructAlignData=s,t.showAnnoSeqData(l,n,o)},error:function(e,t,s){this.tryCount++,this.tryCount<=this.retryLimit&&$.ajax(this)}})}}e.bAnnoShown=!0}showAnnoSeqData(e,t,s){let i=this.icn3d,l=i.icn3dui;this.getAnnotationData();let n=0;for(let t in e)this.getSequenceData(t,e[t],"nucleotide",n),++n;i.interactChainbase=l.hashUtilsCls.unionHash(i.interactChainbase,i.protein_chainid),i.interactChainbase=l.hashUtilsCls.unionHash(i.interactChainbase,e),n=0;for(let e in t)this.getSequenceData(e,t[e],"chemical",n),++n;i.interactChainbase=l.hashUtilsCls.unionHash(i.interactChainbase,t),i.ssbondChainbase=l.hashUtilsCls.unionHash(i.ssbondChainbase,i.protein_chainid),i.ssbondChainbase=l.hashUtilsCls.unionHash(i.ssbondChainbase,t),i.crosslinkChainbase=l.hashUtilsCls.unionHash(i.crosslinkChainbase,i.protein_chainid),i.crosslinkChainbase=l.hashUtilsCls.unionHash(i.crosslinkChainbase,e),i.crosslinkChainbase=l.hashUtilsCls.unionHash(i.crosslinkChainbase,t);for(let e in s)this.getCombinedSequenceData(e,s[e],n),++n;this.enableHlSeq(),setTimeout((function(){i.annotationCls.hideAllAnno(),i.annotationCls.clickCdd()}),0)}getAnnotationData(){let e=this.icn3d,t=e.icn3dui,s=this,i=$.map(e.protein_chainid,(function(e){return e})),l=0;for(let s in e.protein_chainid){let i=t.utilsCls.isMobile()?"none":"button",n=e.showSeqCls.getProteinName(s),o=n,r=0==l?"<span class='icn3d-annoLargeTitle'><b>Proteins</b>: </span><br><br>":"",a=e.chainsGene[s]&&e.chainsGene[s].geneId?"(Gene: <a href='https://www.ncbi.nlm.nih.gov/gene/"+e.chainsGene[s].geneId+"' target='_blank' title='"+e.chainsGene[s].geneDesc+"'>"+e.chainsGene[s].geneSymbol+"</a>)":"",d="<div id='"+e.pre+"anno_"+s+"' class='icn3d-annotation'>"+r+"<span style='font-weight:bold;'>Annotations of "+s+"</span>: <a class='icn3d-blue' href='https://www.ncbi.nlm.nih.gov/protein?term="+s+"' target='_blank' title='"+n+"'>"+o+"</a>"+a+"&nbsp;&nbsp;&nbsp;"+this.addButton(s,"icn3d-addtrack","Add Track","Add a custom track",60,i)+"&nbsp;&nbsp;&nbsp;";d+=this.addButton(s,"icn3d-customcolor","Custom Color/Tube","Use a custom file to define the colors or tubes in 3D structure",110,i)+"&nbsp;&nbsp;&nbsp;",d+=this.addButton(s,"icn3d-helixsets","Helix Sets",'Define sets for each helix in this chain and add them to the menu of "Defined Sets"',60,i)+"&nbsp;"+this.addButton(s,"icn3d-sheetsets","Sheet Sets",'Define sets for each sheet in this chain and add them to the menu of "Defined Sets"',60,i)+"&nbsp;"+this.addButton(s,"icn3d-coilsets","Coil Sets",'Define sets for each coil in this chain and add them to the menu of "Defined Sets"',60,i),$("#"+e.pre+"dl_annotations").append(d);let c=["giseq","cdd","clinvar","snp","domain","site","interaction","custom","ssbond","crosslink","transmem"];for(let t in c){let i=c[t];$("#"+e.pre+"anno_"+s).append(this.getAnDiv(s,i))}$("#"+e.pre+"anno_"+s).append("<br><hr><br>"),++l}e.annoCddSiteCls.setToolTip();let n=e.icn3dui.htmlCls.baseUrl+"/vastdyn/vastdyn.cgi?chainlist="+i;void 0!==e.chainid_seq?this.processSeqData(e.chainid_seq):$.ajax({url:n,dataType:"jsonp",cache:!0,tryCount:0,retryLimit:0,success:function(t){e.chainid_seq=t,s.processSeqData(e.chainid_seq)},error:function(t,s,l){if(this.tryCount++,this.tryCount<=this.retryLimit)$.ajax(this);else{this.enableHlSeq(),console.log("No data were found for the protein "+i+"...");for(let t in e.protein_chainid){let s=e.protein_chainid[t];e.showSeqCls.setAlternativeSeq(t,s),e.showSeqCls.showSeq(t,s)}e.annoCddSiteCls.showCddSiteAll()}}})}getSequenceData(e,t,s,i){let l=this.icn3d;l.icn3dui;let n=l.showSeqCls.getProteinName(e),o=n;o.length>40&&(o=o.substr(0,40)+"...");let r="";0==i&&("protein"==s?r="<span class='icn3d-annoLargeTitle'><b>Proteins</b>: </span><br><br>":"nucleotide"==s?r="<span class='icn3d-annoLargeTitle'><b>Nucleotides</b>: </span><br><br>":"chemical"==s&&(r="<span class='icn3d-annoLargeTitle'><b>Chemicals/Ions/Water</b>: </span><br><br>")),$("#"+l.pre+"dl_annotations").append("<div id='"+l.pre+"anno_"+e+"' class='icn3d-annotation'>"+r+"<b>"+e+"</b>: <span title='"+n+"'>"+o+"</span> </div>"),$("#"+l.pre+"anno_"+e).append(this.getAnDiv(e,"giseq")),$("#"+l.pre+"anno_"+e).append(this.getAnDiv(e,"interaction")),$("#"+l.pre+"anno_"+e).append("<br><hr><br>"),l.giSeq[e]=[];for(let t=0;t<l.chainsSeq[e].length;++t){let s=l.chainsSeq[e][t].name;l.giSeq[e][t]=s}l.matchedPos[e]=0,l.baseResi[e]=l.chainsSeq[e][0].resi-l.matchedPos[e]-1,l.showSeqCls.showSeq(e,t,s)}getCombinedSequenceData(e,t,s){let i=this.icn3d;i.icn3dui;let l,n=0==s?"<span class='icn3d-annoLargeTitle'><b>Chemicals/Ions/Water</b>: </span><br><br>":"",o=t[0].lastIndexOf("_"),r=t[0].substr(0,o),a=void 0!==i.icn3dui.cfg.mmdbid&&void 0!==i.chainid2sid?i.chainid2sid[r]:void 0;l=void 0!==a?"<b><a class='icn3d-blue' href='https://pubchem.ncbi.nlm.nih.gov/substance/"+a+"#section=2D-Structure' target='_blank'>"+e+" <img src='https://pubchem.ncbi.nlm.nih.gov/image/imgsrv.fcgi?sid="+a+"'></a></b>":"<b>"+e+"</b>",$("#"+i.pre+"dl_annotations").append("<div id='"+i.pre+"anno_"+e+"' class='icn3d-annotation'>"+n+l+"</div>"),$("#"+i.pre+"anno_"+e).append("<div id='"+i.pre+"giseq_"+e+"'><div id='"+i.pre+"dt_giseq_"+e+"' style='display:none'></div><div id='"+i.pre+"ov_giseq_"+e+"'></div></div>"),$("#"+i.pre+"anno_"+e).append("<br><hr><br>");let d='<div id="'+i.pre+'giseq_sequence" class="icn3d-dl_sequence">';d+='<div class="icn3d-seqTitle2" anno="sequence"><span style="white-space:nowrap;" title="Chemical '+e+'">Chem. '+e+"</span></div>",d+='<span class="icn3d-residueNum" style="width:60px!important;" title="starting protein sequence number">Count: '+t.length+"</span>",d+='<span class="icn3d-seqLine">';let c=d,h=d;for(let s=0,l=t.length;s<l;++s){let l=e,n=l;l.length>3&&(n=l.substr(0,3)),s<t.length-1&&(n+=",");let o=t[s],r=o.substr(o.lastIndexOf("_")+1);c+='<span id="giseq_'+i.pre+o+'" title="'+l+r+'" class="icn3d-residue icn3d-chemical">'+n+"</span>"}let m=i.icn3dui.htmlCls.GREY8,p=Math.round(i.seqAnnWidth*t.length/i.maxAnnoLength);p<1&&(p=1),h+='<div class="icn3d-seqTitle" style="display:inline-block; color:white; font-weight:bold; background-color:'+m+"; width:"+p+'px;">&nbsp;</div>',d="</span>",d+="<br>",d+="</div>",c+=d,h+=d,$("#"+i.pre+"dt_giseq_"+e).html(c),$("#"+i.pre+"ov_giseq_"+e).html(h)}processSeqData(e){let t=this.icn3d,s=t.icn3dui;for(let i in t.protein_chainid){let l=t.protein_chainid[i];if(e.hasOwnProperty(l)){let s=e[l];t.giSeq[i]=s;let n="";for(let e=0;e<10&&e<t.chainsSeq[i].length;++e)n+=t.chainsSeq[i][e].name.substr(0,1);let o=s.toLowerCase().indexOf(n.toLowerCase());-1==o?(console.log("The gi sequence didn't match the protein sequence. The start of 3D protein sequence: "+n+". The gi sequence: "+s.substr(0,10)+"."),t.showSeqCls.setAlternativeSeq(i,l)):(t.matchedPos[i]=o,t.baseResi[i]=t.chainsSeq[i][0].resi-t.matchedPos[i]-1)}else console.log("No data were found for the protein "+i+"..."),t.showSeqCls.setAlternativeSeq(i,l);if(t.icn3dui.cfg.blast_rep_id!=i)t.showSeqCls.showSeq(i,l);else if(t.icn3dui.cfg.blast_rep_id==i&&void 0===t.seqStructAlignData.data){let e;e=t.icn3dui.cfg.query_id.length>14?"Query: "+t.icn3dui.cfg.query_id.substr(0,6)+"...":isNaN(t.icn3dui.cfg.query_id)?"Query: "+t.icn3dui.cfg.query_id:"Query: gi "+t.icn3dui.cfg.query_id,compTitle=void 0,compText=void 0;let s="cannot be aligned";t.queryStart="",t.queryEnd="",alert("The sequence can NOT be aligned to the structure"),t.showSeqCls.showSeq(i,l,void 0,e,compTitle,s,compText)}else if(t.icn3dui.cfg.blast_rep_id==i&&void 0!==t.seqStructAlignData.data){let e;e=t.icn3dui.cfg.query_id.length>14?"Query: "+t.icn3dui.cfg.query_id.substr(0,6)+"...":isNaN(t.icn3dui.cfg.query_id)?"Query: "+t.icn3dui.cfg.query_id:"Query: gi "+t.icn3dui.cfg.query_id;let n,o,r=t.seqStructAlignData;void 0!==r.data&&(n=r.data[0].query,o=r.data[0].targets[i],o=void 0!==o&&o.hsps.length>0?o.hsps[0]:void 0);let a,d="",c="";if(t.queryStart="",t.queryEnd="",void 0!==n&&void 0!==o){a=o.scores.e_value.toPrecision(2),a>1e-200&&(a=parseFloat(a).toExponential()),o.scores.bit_score;let e=r.targets[i].seqdata,s=n.seqdata,l=o.segs,h={};void 0===t.targetGapHash&&(t.targetGapHash={}),t.fullpos2ConsTargetpos={},t.consrvResPosArray=[];let m=0,p=0;t.nTotalGap=0,t.queryStart=l[0].from+1,t.queryEnd=l[l.length-1].to+1;for(let e=0,s=l.length;e<s;++e){let s=l[e];if(e>0)if(s.orifrom-m<s.from-p)t.targetGapHash[s.orifrom]={from:p+1,to:s.from-1},t.nTotalGap+=t.targetGapHash[s.orifrom].to-t.targetGapHash[s.orifrom].from+1;else if(s.orifrom-m>s.from-p)for(let e=m+1;e<s.orifrom;++e)h[e]=-1;for(let e=0;e<=s.orito-s.orifrom;++e)h[e+s.orifrom]=e+s.from;m=s.orito,p=s.to}let u=0;t.alnChainsSeq[i]=[];let C=t.chainid2offset[i]?t.chainid2offset[i]:0;for(let l=0,n=e.length;l<n;++l){if(t.targetGapHash.hasOwnProperty(l))for(let e=t.targetGapHash[l].from;e<=t.targetGapHash[l].to;++e)d+=s[e];c+=t.showSeqCls.insertGap(i,l,"-",!0),t.targetGapHash.hasOwnProperty(l)&&(u+=t.targetGapHash[l].to-t.targetGapHash[l].from+1);let n=t.bUsePdbNum?l+1+C:l+1;if(h.hasOwnProperty(l)&&-1!==h[l]){d+=s[h[l]];let o=this.getColorhexFromBlosum62(e[l],s[h[l]]);e[l]==s[h[l]]?(c+=e[l],t.fullpos2ConsTargetpos[l+u]={same:1,pos:n,res:e[l],color:o},t.consrvResPosArray.push(n),t.alnChainsSeq[i].push({resi:n,color:"#FF0000",color2:"#"+o})):this.conservativeReplacement(e[l],s[h[l]])?(c+="+",t.fullpos2ConsTargetpos[l+u]={same:0,pos:n,res:e[l],color:o},t.consrvResPosArray.push(n),t.alnChainsSeq[i].push({resi:n,color:"#0000FF",color2:"#"+o})):(c+=" ",t.fullpos2ConsTargetpos[l+u]={same:-1,pos:n,res:e[l],color:o},t.alnChainsSeq[i].push({resi:n,color:t.icn3dui.htmlCls.GREYC,color2:"#"+o}))}else d+="-",c+=" "}}else d+="cannot be aligned",alert("The sequence can NOT be aligned to the structure");let h="BLAST, E: "+a;t.showSeqCls.showSeq(i,l,void 0,e,h,d,c);let m,p={};if(void 0!==t.consrvResPosArray)for(let e=0,s=t.consrvResPosArray.length;e<s;++e)m=l+"_"+t.consrvResPosArray[e],p[m]=1;let u=s.hashUtilsCls.cloneHash(t.hAtoms);t.selectionCls.selectResidueList(p,"protein_aligned",h,!1),t.hAtoms=s.hashUtilsCls.cloneHash(u)}}this.enableHlSeq(),t.annoCddSiteCls.showCddSiteAll()}enableHlSeq(){let e=this.icn3d;e.icn3dui.utilsCls.isMobile()?(e.hlSeqCls.selectSequenceMobile(),e.hlSeqCls.selectChainMobile()):e.hlSeqCls.selectSequenceNonMobile(),Object.keys(e.hAtoms).length<Object.keys(e.dAtoms).length&&e.hlUpdateCls.updateHlSeq()}getAnDiv(e,t){let s=this.icn3d;s.icn3dui;let i="Loading "+t+"...";return"custom"==t?i="":"domain"==t&&(i="Loading 3D "+t+"..."),"<div id='"+s.pre+t+"_"+e+"'><div id='"+s.pre+"tt_"+t+"_"+e+"' class='icn3d-fixed-pos' style='display:none!important'></div><div id='"+s.pre+"dt_"+t+"_"+e+"' style='display:none'>"+i+"</div><div id='"+s.pre+"ov_"+t+"_"+e+"'>"+i+"</div></div>"}addButton(e,t,s,i,l,n){return this.icn3d.icn3dui,"<div class='"+t+"' chainid='"+e+"' style='display:inline-block; font-size:11px; font-weight:bold; width:"+l+"px!important;'><button style='-webkit-appearance:"+n+"; height:18px; width:"+l+"px;'><span style='white-space:nowrap; margin-left:-3px;' title='"+i+"'>"+s+"</span></button></div>"}addSnpButton(e,t,s,i,l,n){let o=this.icn3d;return o.icn3dui,"<div class='"+o.pre+t+"' snp='"+e+"' style='margin:3px 0 3px 0; display:inline-block; font-size:11px; font-weight:bold; width:"+l+"px!important;'><button style='-webkit-appearance:"+n+"; height:18px; width:"+l+"px;'><span style='white-space:nowrap; margin-left:-3px;' title='"+i+"'>"+s+"</span></button></div>"}conservativeReplacement(e,t){let s=this.icn3d.icn3dui,i=-1!==s.parasCls.b62ResArray.indexOf(e)?s.parasCls.b62ResArray.indexOf(e):s.parasCls.b62ResArray.length-1,l=-1!==s.parasCls.b62ResArray.indexOf(t)?s.parasCls.b62ResArray.indexOf(t):s.parasCls.b62ResArray.length-1;return s.parasCls.b62Matrix[i][l]>0}getColorhexFromBlosum62(e,t){let s=this.icn3d.icn3dui,i=-1!==s.parasCls.b62ResArray.indexOf(e)?s.parasCls.b62ResArray.indexOf(e):s.parasCls.b62ResArray.length-1,l=-1!==s.parasCls.b62ResArray.indexOf(t)?s.parasCls.b62ResArray.indexOf(t):s.parasCls.b62ResArray.length-1,n=s.parasCls.b62Matrix[i][l];if(void 0===n)return"333333";let o="333333";if(n>0){let e=221-parseInt(n/11*221),t=e<10?"0"+e.toString(16):e.toString(16);o="DD"+t+t}else{let e=221-parseInt(-1*n/4*221),t=e<10?"0"+e.toString(16):e.toString(16);o=t+t+"DD"}return o}}class xe{constructor(e){this.icn3d=e}showInteraction(e,t){let s=this.icn3d;s.icn3dui;let i=this;void 0!==s.chainname2residues||void 0===s.icn3dui.cfg.mmdbid&&void 0===s.icn3dui.cfg.gi&&void 0===s.icn3dui.cfg.blast_rep_id&&void 0===s.icn3dui.cfg.align&&void 0===s.icn3dui.cfg.chainalign?this.showInteraction_base(e,t):setTimeout((function(){i.showInteraction_base(e,t)}),1e3)}showInteraction_base(e,t){let s=this.icn3d,i=s.icn3dui;void 0===s.chainname2residues&&(s.chainname2residues={});let l=Object.keys(s.chains),n=e,o=Math.round(n.indexOf("_"));if(o>4)return;if(s.firstAtomObjCls.getFirstCalphaAtomObj(s.chains[n]),void 0===s.chainname2residues[n]){s.chainname2residues[n]={};let t=l.length;if(t>100&&void 0===s.icn3dui.cfg.mmdbid&&void 0===s.icn3dui.cfg.gi&&void 0===s.icn3dui.cfg.blast_rep_id&&void 0===s.icn3dui.cfg.align&&void 0===s.icn3dui.cfg.chainalign)return $("#"+s.pre+"dt_interaction_"+e).html(""),void $("#"+s.pre+"ov_interaction_"+e).html("");for(let e=0;e<t;++e){let t=l[e];if(t===n)continue;if(t.substr(0,t.indexOf("_"))!==n.substr(0,n.indexOf("_")))continue;if(o=Math.round(n.indexOf("_")),o>4)continue;let r,a=s.firstAtomObjCls.getFirstCalphaAtomObj(s.chains[t]);s.chemicals.hasOwnProperty(a.serial)?r="chemical":s.nucleotides.hasOwnProperty(a.serial)?r="nucleotide":s.ions.hasOwnProperty(a.serial)?r="ion":s.proteins.hasOwnProperty(a.serial)?r="protein":s.water.hasOwnProperty(a.serial)&&(r="water");let d=s.contactCls.getAtomsWithinAtom(i.hashUtilsCls.hash2Atoms(s.chains[n],s.atoms),i.hashUtilsCls.hash2Atoms(s.chains[t],s.atoms),4);if(0==Object.keys(d).length)continue;let c={};for(let e in d){let t=s.atoms[e];c[t.structure+"_"+t.chain+"_"+t.resi]=1}let h=t.substr(t.indexOf("_")+1)+"("+r+")";s.chainname2residues[n][h]=Object.keys(c)}}let r='<div id="'+s.pre+e+'_interseq_sequence" class="icn3d-dl_sequence">',a=r,d=r,c=0;for(let t in s.chainname2residues[e]){let i=s.chainname2residues[e][t],l="Interact ."+t;l.length>17&&(l=l.substr(0,17)+"...");let n="Interact ."+t,o=[];for(let e=0,t=i.length;e<t;++e){let t=i[e],l=Math.round(t.substr(i[e].lastIndexOf("_")+1)),n=Object.keys(s.residues[t])[0];(s.proteins.hasOwnProperty(n)||s.nucleotides.hasOwnProperty(n))&&o.push(l)}let h=o.length;if(0==h)continue;let m=t.replace(/\s/g,""),p='<div class="icn3d-seqTitle icn3d-link icn3d-blue" interaction="'+(c+1).toString()+'" posarray="'+o.toString()+'" shorttitle="'+l+'" setname="'+e+"_"+m+'" anno="sequence" chain="'+e+'" title="'+n+'">'+l+" </div>",u='<span class="icn3d-residueNum" title="residue count">'+h.toString()+" Res</span>";d+=p+u+"<br>";let C='<span class="icn3d-seqLine">';r+=p+u+C,a+=p+u+C;let g="inter"+c.toString(),f=0,b=0,y=1;for(let t=0,i=s.giSeq[e].length;t<i;++t)if(r+=s.showSeqCls.insertGap(e,t,"-"),-1!=o.indexOf(t+1+s.baseResi[e])){let i=s.giSeq[e][t],l=i;i.length>1&&(l=i[0]+"..");let n=t>=s.matchedPos[e]&&t-s.matchedPos[e]<s.chainsSeq[e].length?s.chainsSeq[e][t-s.matchedPos[e]].resi:s.baseResi[e]+1+t;r+='<span id="'+g+"_"+s.pre+e+"_"+n+'" title="'+i+n+'" class="icn3d-residue">'+l+"</span>",a+=s.showSeqCls.insertGapOverview(e,t);let o=s.icn3dui.cfg.blast_rep_id==e?Math.round(s.seqAnnWidth*t/(s.maxAnnoLength+s.nTotalGap)-f-b):Math.round(s.seqAnnWidth*t/s.maxAnnoLength-f-b);o>=0&&(a+='<div style="display:inline-block; width:'+o+'px;">&nbsp;</div>',a+='<div style="display:inline-block; background-color:#000; width:'+y+'px;" title="'+l+n+'">&nbsp;</div>',f+=o,b+=y)}else r+="<span>-</span>";C='<span class="icn3d-residueNum" title="residue count">&nbsp;'+h.toString()+" Residues</span>",C+="</span>",C+="<br>",r+=C,a+=C,++c}r+="</div>",a+="</div>",d+="</div>",$("#"+s.pre+"dt_interaction_"+e).html(r),$("#"+s.pre+"ov_interaction_"+e).html(a),$("#"+s.pre+"tt_interaction_"+e).html(d),i.utilsCls.isMobile()?(s.hlSeqCls.selectSequenceMobile(),s.hlSeqCls.selectChainMobile()):s.hlSeqCls.selectSequenceNonMobile()}}class ke{constructor(e){this.icn3d=e}showCrosslink(e,t){let s=this.icn3d;s.icn3dui;let i=this;void 0===s.clbondpnts?setTimeout((function(){i.showCrosslink_base(e,t)}),1e3):this.showCrosslink_base(e,t)}showCrosslink_base(e,t){let s=this.icn3d;s.icn3dui;let i=t,l={},n=i.substr(0,i.indexOf("_")),o=s.clbondpnts[n];if(void 0===o)return $("#"+s.pre+"dt_crosslink_"+e).html(""),$("#"+s.pre+"ov_crosslink_"+e).html(""),void $("#"+s.pre+"tt_crosslink_"+e).html("");for(let e=0,t=o.length;e<t;e+=2){let t=o[e],s=o[e+1];t.substr(0,t.lastIndexOf("_")),i===s.substr(0,s.lastIndexOf("_"))&&(void 0===l[s]&&(l[s]=[]),l[s].push(t))}let r=Object.keys(l);s.annoCddSiteCls.showAnnoType(e,t,"crosslink","Cross-Linkages",r,l)}}class Oe{constructor(e){this.icn3d=e}showDomainPerStructure(e){let t=this.icn3d;t.icn3dui;let s=this,i=Object.keys(t.structures),l=i[e],n=t.icn3dui.htmlCls.baseUrl+"mmdb/mmdb_strview.cgi?v=2&program=icn3d&domain&molinfor&uid="+l;if(0==e&&void 0!==t.mmdb_data)for(let e in t.protein_chainid)-1!==e.indexOf(l)&&this.showDomainWithData(e,t.mmdb_data);else if(void 0!==t.mmdb_dataArray[e])for(let s in t.protein_chainid)-1!==s.indexOf(l)&&this.showDomainWithData(s,t.mmdb_dataArray[e]);else $.ajax({url:n,dataType:"json",cache:!0,tryCount:0,retryLimit:1,success:function(n){t.mmdb_dataArray[e]=n;for(let i in t.protein_chainid)-1!==i.indexOf(l)&&s.showDomainWithData(i,t.mmdb_dataArray[e]);if(t.showAnnoCls.enableHlSeq(),t.bAjax3ddomain=!0,t.bAjaxDoneArray[e]=!0,void 0!==t.deferred3ddomain)if(void 0===t.icn3dui.cfg.align||void 0===t.icn3dui.cfg.chainalign||t.bRealign)t.deferred3ddomain.resolve();else{let e=!0;for(let s=0,l=i.length;s<l;++s)e=e&&t.bAjaxDoneArray[s];e&&t.deferred3ddomain.resolve()}},error:function(e,s,n){if(this.tryCount++,this.tryCount<=this.retryLimit)$.ajax(this);else{console.log("No 3D domain data were found for the protein "+l+"...");for(let e in t.protein_chainid)-1!==e.indexOf(l)&&($("#"+t.pre+"dt_domain_"+e).html(""),$("#"+t.pre+"ov_domain_"+e).html(""),$("#"+t.pre+"tt_domain_"+e).html(""));if(t.showAnnoCls.enableHlSeq(),t.bAjax3ddomain=!0,bAjaxDone1=!0,void 0!==t.deferred3ddomain)if(void 0===t.icn3dui.cfg.align||void 0===t.icn3dui.cfg.chainalign)t.deferred3ddomain.resolve();else{let e=!0;for(let s=0,l=i.length;s<l;++s)e=e&&t.bAjaxDoneArray[s];e&&t.deferred3ddomain.resolve()}}}})}showDomainAll(){let e=this.icn3d;e.icn3dui;let t=Object.keys(e.structures);e.mmdb_dataArray=[],e.bAjaxDoneArray=[];for(let s=0,i=t.length;s<i;++s)e.bAjaxDoneArray[s]=!1;for(let e=0,s=t.length;e<s;++e)this.showDomainPerStructure(e)}showDomainWithData(e,t){let s=this.icn3d;s.icn3dui;let i,l,n,o='<div id="'+s.pre+e+'_domainseq_sequence" class="icn3d-dl_sequence">',r=o,a=o,d=e.indexOf("_"),c=e.substr(d+1),h=t.moleculeInfor;for(let e in h)if(h[e].chain===c){n=e,l=h[e].name;break}void 0!==n&&void 0!==t.domains[n]&&(i=t.domains[n].domains),void 0===i&&(i=[]);for(let t=0,n=i.length;t<n;++t){let n="3D domain "+(t+1).toString()+" of "+l,d=n.length>17?n.substr(0,17)+"...":n,c=i[t].intervals,h={},m={},p=[],u=[],C={},g=0;for(let t=0,i=c.length;t<i;++t){let i=Math.round(c[t][0])-1,l=Math.round(c[t][1])-1;if(!h.hasOwnProperty(i)&&!m.hasOwnProperty(l)){h[i]=1,m[l]=1,p.push(i+s.baseResi[e]),u.push(l+s.baseResi[e]),g+=l-i+1;for(let e=i;e<=l;++e)C[e+1]=1}}let f='<div class="icn3d-seqTitle icn3d-link icn3d-blue" 3ddomain="'+(t+1).toString()+'" from="'+p+'" to="'+u+'" shorttitle="'+d+'" index="'+t+'" setname="'+e+"_3d_domain_"+(t+1).toString()+'" anno="sequence" chain="'+e+'" title="'+n+'">'+d+" </div>",b='<span class="icn3d-residueNum" title="residue count">'+g.toString()+" Res</span>";a+=f+b+"<br>";let y='<span class="icn3d-seqLine">';o+=f+b+y,r+=f+b+y;let v="domain3d"+t.toString();for(let t=0,i=s.giSeq[e].length;t<i;++t)if(o+=s.showSeqCls.insertGap(e,t,"-"),C.hasOwnProperty(t+1)){let i=s.giSeq[e][t],l=i;i.length>1&&(l=i[0]+"..");let n=t>=s.matchedPos[e]&&t-s.matchedPos[e]<s.chainsSeq[e].length?s.chainsSeq[e][t-s.matchedPos[e]].resi:s.baseResi[e]+1+t;o+='<span id="'+v+"_"+s.pre+e+"_"+n+'" title="'+l+n+'" class="icn3d-residue">'+i+"</span>"}else o+="<span>-</span>";let w=s.firstAtomObjCls.getFirstCalphaAtomObj(s.chains[e]),S=void 0===w.color||"FFFFFF"===w.color.getHexString()?"DDDDDD":w.color.getHexString(),_=void 0!==w.color?S:"CCCCCC";if(s.icn3dui.cfg.blast_rep_id!=e)for(let i=0,l=p.length;i<l;++i){r+='<div style="display:inline-block; width:'+(0==i?Math.round(s.seqAnnWidth*(p[i]-s.baseResi[e]-1)/s.maxAnnoLength):Math.round(s.seqAnnWidth*(p[i]-u[i-1]-1)/s.maxAnnoLength))+'px;">&nbsp;</div>',r+='<div style="display:inline-block; color:white!important; font-weight:bold; background-color:#'+_+"; width:"+Math.round(s.seqAnnWidth*(u[i]-p[i]+1)/s.maxAnnoLength)+'px;" class="icn3d-seqTitle icn3d-link icn3d-blue" 3ddomain="'+(t+1).toString()+'" from="'+p+'" to="'+u+'" shorttitle="'+d+'" index="'+t+'" setname="'+e+"_3d_domain_"+(t+1).toString()+'" id="'+e+"_3d_domain_"+t+'" anno="sequence" chain="'+e+'" title="'+n+'">3D domain '+(t+1).toString()+"</div>"}else{let i=[],l=[];for(let e=0,t=p.length;e<t;++e){i.push(p[e]);for(let t=p[e];t<=u[e];++t)void 0!==s.targetGapHash&&s.targetGapHash.hasOwnProperty(t)&&(l.push(t-1),i.push(t));l.push(u[e])}for(let o=0,a=i.length;o<a;++o){r+=s.showSeqCls.insertGapOverview(e,i[o]),r+='<div style="display:inline-block; width:'+(0==o?Math.round(s.seqAnnWidth*(i[o]-s.baseResi[e]-1)/(s.maxAnnoLength+s.nTotalGap)):Math.round(s.seqAnnWidth*(i[o]-l[o-1]-1)/(s.maxAnnoLength+s.nTotalGap)))+'px;">&nbsp;</div>',r+='<div style="display:inline-block; color:white!important; font-weight:bold; background-color:#'+_+"; width:"+Math.round(s.seqAnnWidth*(l[o]-i[o]+1)/(s.maxAnnoLength+s.nTotalGap))+'px;" class="icn3d-seqTitle icn3d-link icn3d-blue" 3ddomain="'+(t+1).toString()+'" from="'+i+'" to="'+l+'" shorttitle="'+d+'" index="'+t+'" setname="'+e+"_3d_domain_"+(t+1).toString()+'" id="'+e+"_3d_domain_"+t+'" anno="sequence" chain="'+e+'" title="'+n+'">3D domain '+(t+1).toString()+"</div>"}}y='<span class="icn3d-residueNum" title="residue count">&nbsp;'+g.toString()+" Residues</span>",y+="</span>",y+="<br>",o+=y,r+=y}o+="</div>",r+="</div>",a+="</div>",$("#"+s.pre+"dt_domain_"+e).html(o),$("#"+s.pre+"ov_domain_"+e).html(r),$("#"+s.pre+"tt_domain_"+e).html(a)}}class He{constructor(e){this.icn3d=e}navClinVar(e){let t=this.icn3d,s=t.icn3dui,i=this;t.currClin[e]=-1,s.myEventCls.onIds("#"+t.pre+e+"_prevclin","click",(function(t){let s=i.icn3d;t.stopImmediatePropagation();let l=void 0!==s.resi2disease_nonempty[e]?Object.keys(s.resi2disease_nonempty[e]).length:0;--s.currClin[e],s.currClin[e]<0&&(s.currClin[e]=l-1),i.showClinVarLabelOn3D(e)})),s.myEventCls.onIds("#"+t.pre+e+"_nextclin","click",(function(t){let s=i.icn3d;t.stopImmediatePropagation();let l=void 0!==s.resi2disease_nonempty[e]?Object.keys(s.resi2disease_nonempty[e]).length:0;++s.currClin[e],s.currClin[e]>l-1&&(s.currClin[e]=0),i.showClinVarLabelOn3D(e)}))}showClinVarLabelOn3D(e){let t,s,i=this.icn3d,l=i.icn3dui,n=Object.keys(i.resi2disease_nonempty[e]);t=e,s=t+"_"+n[i.currClin[e]];let o="",r=i.resi2disease_nonempty[e][n[i.currClin[e]]];for(let e=0,t=r.length;e<t;++e)if(""!=r[e]&&"not specified"!=r[e]&&"not provided"!=r[e]){o=r[e];break}let a=i.applyCenterCls.centerAtoms(l.hashUtilsCls.hash2Atoms(i.residues[s],i.atoms));o.length>30&&(o=o.substr(0,30)+"..."),i.selectionCls.removeSelection(),null==i.labels&&(i.labels={}),i.labels.clinvar=[];let d=i.LABELSIZE;i.analysisCls.addLabel(o,a.center.x+1,a.center.y+1,a.center.z+1,d,"#FFFF00",void 0,"clinvar"),i.hAtoms={};for(let e in i.residues[s])i.hAtoms[e]=1;$("#clinvar_"+i.pre+s).addClass("icn3d-highlightSeq"),void 0===$("#"+i.pre+"modeswitch")[0]||$("#"+i.pre+"modeswitch")[0].checked||i.definedSetsCls.setMode("selection"),i.drawCls.draw()}getSnpLine(e,t,s,i,l,n,o,r,a,d,c,h,m,p,u,C){let g=this.icn3d,f=g.icn3dui,b="",y=p?"clinvar":"snp",v=!1;for(let e in i){for(let t=0,s=i[e].length;t<s;++t)if(0==i[e][t]){v=!0;break}if(v)break}if(c){let e="ClinVar",t="SNP",s="",i="";v||void 0===g.organism||"human"===g.organism||"homo sapiens"===g.organism||(s=" <span style='color:#FFA500'>(from human)</span>",i=" <span style='color:#FFA500'>(based on human sequences and mapped to this structure by sequence similarity)</span>"),b+=p?'<div class="icn3d-seqTitle icn3d-link icn3d-blue icn3d-clinvar-path" clinvar="clinvar" posarray="'+d+'" shorttitle="'+e+'" setname="'+h+"_"+e+'" anno="sequence" chain="'+h+'" title="'+e+i+'">'+e+s+"</div>":'<div class="icn3d-seqTitle icn3d-link icn3d-blue" clinvar="clinvar" posarray="'+a+'" shorttitle="'+t+'" setname="'+h+"_"+t+'" anno="sequence" chain="'+h+'" title="'+t+i+'">'+t+s+"</div>"}else if(2==e&&p){let e=f.utilsCls.isMobile()?"none":"button";b+='<div id="'+g.pre+h+'_prevclin" style="display:inline-block; font-size:11px; font-weight:bold; width:60px!important;"><button class="link" style="-webkit-appearance:'+e+'; height:18px; width:55px;"><span style="white-space:nowrap; margin-left:-40px;" title="Show the previous ClinVar on structure">&lt; ClinVar</span></button></div>',b+='<div id="'+g.pre+h+'_nextclin" style="display:inline-block; font-size:11px; font-weight:bold; width:60px!important;"><button class="link" style="-webkit-appearance:'+e+'; height:18px; width:55px;"><span style="white-space:nowrap; margin-left:-40px;" title="Show the next ClinVar on structure">ClinVar &gt;</span></button></div>'}else b+='<div class="icn3d-seqTitle"></div>';let w=y,S=0,_=0,A={},x={};for(let t=1,i=g.giSeq[h].length;t<=i;++t)if(void 0!==o[t]){++S;let i="";for(let l=0,o=s[t].length;l<o&&!C;++l){let s=n[t][l].split("; "),o=r[t][l].split("; "),a="";for(let e=0,t=s.length;e<t;++e)""!=s[e]&&"not specified"!=s[e]&&"not provided"!=s[e]&&(a+=s[e]+"("+o[e]+"); ");""!=a&&(A[t]="icn3d-clinvar",l==e-2&&(x[t]="icn3d-clinvar",-1!=a.indexOf("Pathogenic")&&(x[t]="icn3d-clinvar-path"))),i+=a+" | "}-1!=i.indexOf("Pathogenic")&&(A[t]="icn3d-clinvar-path"),"icn3d-clinvar"!=A[t]&&"icn3d-clinvar-path"!=A[t]||++_}if(0==S&&!p)return $("#"+g.pre+"dt_clinvar_"+h).html(""),$("#"+g.pre+"ov_clinvar_"+h).html(""),$("#"+g.pre+"tt_clinvar_"+h).html(""),$("#"+g.pre+"dt_snp_"+h).html(""),$("#"+g.pre+"ov_snp_"+h).html(""),$("#"+g.pre+"tt_snp_"+h).html(""),"";if(0==_&&p)return $("#"+g.pre+"dt_clinvar_"+h).html(""),$("#"+g.pre+"ov_clinvar_"+h).html(""),$("#"+g.pre+"tt_clinvar_"+h).html(""),"";let k=p?_:S;if(b+=1==e?'<span class="icn3d-residueNum" title="residue count">'+k+" Res</span>":'<span class="icn3d-residueNum"></span>',u)return b+"<br>";b+='<span class="icn3d-seqLine">';let O="",H=0,R=0;for(let t=1,a=g.giSeq[h].length;t<=a;++t)if(m){if(void 0!==o[t]){let e=g.giSeq[h][t-1],i=e;e.length>1&&(i=e[0]+"..");let l=(t>=g.matchedPos[h]&&t-1-g.matchedPos[h]<g.chainsSeq[h].length?g.chainsSeq[h][t-1-g.matchedPos[h]].resi:g.baseResi[h]+1+t-1)+i+">";for(let e=0,i=s[t].length;e<i;++e)if(l+=s[t][e],!C){let s=n[t][e].split("; "),i=r[t][e].split("; "),l="";for(let e=0,t=s.length;e<t;++e)""!=s[e]&&"not specified"!=s[e]&&"not provided"!=s[e]&&(l+=s[e]+"("+i[e]+"); ")}b+=g.showSeqCls.insertGapOverview(h,t-1);let o=g.icn3dui.cfg.blast_rep_id==h?Math.round(g.seqAnnWidth*(t-1)/(g.maxAnnoLength+g.nTotalGap)-H-R):Math.round(g.seqAnnWidth*(t-1)/g.maxAnnoLength-H-R);p?"icn3d-clinvar"!=A[t]&&"icn3d-clinvar-path"!=A[t]||o>=0&&(b+='<div style="display:inline-block; width:'+o+'px;">&nbsp;</div>',b+='<div style="display:inline-block; background-color:#000; width:1px;" title="'+l+'">&nbsp;</div>',H+=o,R+=1):o>0&&(b+='<div style="display:inline-block; width:'+o+'px;">&nbsp;</div>',b+='<div style="display:inline-block; background-color:#000; width:1px;" title="'+l+'">&nbsp;</div>',H+=o,R+=1)}}else if(b+=g.showSeqCls.insertGap(h,t-1,"-"),void 0!==o[t])if(p||1!=e){let o=g.giSeq[h][t-1],a=o;o.length>1&&(a=o[0]+"..");let d,c=t>=g.matchedPos[h]&&t-1-g.matchedPos[h]<g.chainsSeq[h].length?g.chainsSeq[h][t-1-g.matchedPos[h]].resi:g.baseResi[h]+1+t-1,m="",u="<div class='snptip'>",y=s[t].length,v=0,S=0;if(2==e&&(v=0,S=y),p){d=1;let o=0;for(let e=v;e<y&&e<S;++e){let p=h+"_"+c+"_"+s[t][e],C=f.utilsCls.isMobile()?"none":"button",b=!0;g.residues.hasOwnProperty(h+"_"+c)||(b=!1);let v=n[t][e].split("; "),w=r[t][e].split("; "),S="",_=0;for(let t=0,s=v.length;t<s;++t)""!=v[t]&&"not specified"!=v[t]&&"not provided"!=v[t]&&(_>0?S+="; ":0!==e&&1!==e||(O='disease="'+v[t]+'"'),S+=v[t]+"("+w[t]+")",++_);""!=S&&(o<d&&(m+=s[t][e]),u+=c+a+">"+s[t][e],u+=": "+S,b&&!f.cfg.hidelicense&&(u+="<br>"+g.showAnnoCls.addSnpButton(p,"snpin3d","3D with scap","SNP in 3D with scap",70,C)+"&nbsp;&nbsp;",u+=g.showAnnoCls.addSnpButton(p,"snpinter","Interactions","SNP Interactions in 3D",70,C)+"&nbsp;&nbsp;",u+=g.showAnnoCls.addSnpButton(p,"snppdb","PDB","Download SNP PDB",35,C)),u+="<br>Links: <a href='https://www.ncbi.nlm.nih.gov/clinvar/?term="+l[t][e]+"[AlleleID]' target='_blank'>ClinVar</a>, <a href='https://www.ncbi.nlm.nih.gov/snp/?term="+i[t][e]+"' target='_blank'>dbSNP(rs"+i[t][e]+")</a>",e<y-1&&(u+="<br><br>"),++o)}o>d&&2==e&&(m+="..")}else{d=1;for(let e=v;e<y&&e<S;++e){let o=h+"_"+c+"_"+s[t][e],p=f.utilsCls.isMobile()?"none":"button",b=!0;if(g.residues.hasOwnProperty(h+"_"+c)||(b=!1),e<d&&(m+=s[t][e]),u+=c+a+">"+s[t][e],C)b&&!f.cfg.hidelicense&&(u+="<br>"+g.showAnnoCls.addSnpButton(o,"snpin3d","3D with scap","SNP in 3D with scap",70,p)+"&nbsp;&nbsp;",u+=g.showAnnoCls.addSnpButton(o,"snpinter","Interactions","SNP Interactions in 3D",70,p)+"&nbsp;&nbsp;",u+=g.showAnnoCls.addSnpButton(o,"snppdb","PDB","Download SNP PDB",35,p)),0!=i[t][e]&&(u+="<br>Link: <a href='https://www.ncbi.nlm.nih.gov/snp/?term="+i[t][e]+"' target='_blank'>dbSNP(rs"+i[t][e]+")</a>"),e<y-1&&(u+="<br><br>");else{let s=n[t][e].split("; "),a=r[t][e].split("; "),d="",c=0;for(let t=0,i=s.length;t<i;++t)""!=s[t]&&"not specified"!=s[t]&&"not provided"!=s[t]&&(c>0?d+="; ":0!==e&&1!==e||(O='disease="'+s[t]+'"'),d+=s[t]+"("+a[t]+")",++c);""!=d?(u+=": "+d,b&&!f.cfg.hidelicense&&(u+="<br>"+g.showAnnoCls.addSnpButton(o,"snpin3d","3D with scap","SNP in 3D with scap",70,p)+"&nbsp;&nbsp;",u+=g.showAnnoCls.addSnpButton(o,"snpinter","Interactions","SNP Interactions in 3D",70,p)+"&nbsp;&nbsp;",u+=g.showAnnoCls.addSnpButton(o,"snppdb","PDB","Download SNP PDB",35,p)),u+="<br>Links: <a href='https://www.ncbi.nlm.nih.gov/clinvar/?term="+l[t][e]+"[AlleleID]' target='_blank'>ClinVar</a>, <a href='https://www.ncbi.nlm.nih.gov/snp/?term="+i[t][e]+"' target='_blank'>dbSNP(rs"+i[t][e]+")</a>"):(b&&!f.cfg.hidelicense&&(u+="<br>"+g.showAnnoCls.addSnpButton(o,"snpin3d","3D with scap","SNP in 3D with scap",70,p)+"&nbsp;&nbsp;",u+=g.showAnnoCls.addSnpButton(o,"snpinter","Interactions","SNP Interactions in 3D",70,p)+"&nbsp;&nbsp;",u+=g.showAnnoCls.addSnpButton(o,"snppdb","PDB","Download SNP PDB",35,p)),u+="<br>Link: <a href='https://www.ncbi.nlm.nih.gov/snp/?term="+i[t][e]+"' target='_blank'>dbSNP(rs"+i[t][e]+")</a>"),e<y-1&&(u+="<br><br>")}}y>d&&2==e&&(m+="..")}u+="</div>",p?"icn3d-clinvar"==A[t]||"icn3d-clinvar-path"==A[t]?b+=1==e?"<span>&dArr;</span>":""==m||" "==m?"<span>-</span>":'<span id="'+w+"_"+g.pre+h+"_"+c+'" label title="'+u+'" '+O+' class="icn3d-tooltip icn3d-residue '+x[t]+'">'+m+"</span>":b+="<span>-</span>":b+=""==m||" "==m?"<span>-</span>":C?'<span id="'+w+"_"+g.pre+h+"_"+c+'" label title="'+u+'" class="icn3d-tooltip icn3d-residue '+x[t]+'">'+m+"</span>":'<span id="'+w+"_"+g.pre+h+"_"+c+'" label title="'+u+'" '+O+' class="icn3d-tooltip icn3d-residue '+x[t]+'">'+m+"</span>"}else b+="<span>&dArr;</span>";else b+="<span>-</span>";return b+=1==e?'<span class="icn3d-residueNum" title="residue count">&nbsp;'+k+" Residues</span>":'<span class="icn3d-residueNum"></span>',b+="</span>",b+="<br>",b}processSnpClinvar(e,t,s,i,l){let n=this.icn3d;n.icn3dui;let o='<div id="'+n.pre+t+'_snpseq_sequence" class="icn3d-dl_sequence">',r=o,a=o,d='<div id="'+n.pre+t+'_clinvarseq_sequence" class="icn3d-dl_sequence">',c=d,h=d,m=!i||l?e.data:e.split("\n"),p={},u={},C={};void 0===n.resi2disease_nonempty[t]&&(n.resi2disease_nonempty[t]={});let g={},f={},b={},y={},v={},w="";for(let e=0,s=m.length;e<s;++e)if(""!=m[e]){let s=!i||l?m[e]:m[e].split("\t"),o=s[3];if(o==w)continue;w=o;let r=o.substr(0,o.length-3),a=Math.round(r);o.substr(o.length-3,1);let d=o.substr(o.length-1,1),c=s[4],h=i?"":s[5],S=i?"":s[6],_=i?"":s[7];y[a+n.baseResi[t]]=1,""!=S&&(v[a+n.baseResi[t]]=1),u[a]=e+1,void 0===p[a]&&(p[a]=[]),p[a].push(d),void 0===f[a]&&(f[a]=[]),f[a].push(c),void 0===b[a]&&(b[a]=[]),b[a].push(h),void 0===C[a]&&(C[a]=[]),C[a].push(S),""!=S&&(void 0===n.resi2disease_nonempty[t][a]&&(n.resi2disease_nonempty[t][a]=[]),n.resi2disease_nonempty[t][a].push(S)),void 0===g[a]&&(g[a]=[]),g[a].push(_)}let S=Object.keys(y),_=Object.keys(v);if(i){let e=!1;o+=this.getSnpLine(1,2,p,f,b,C,u,g,S,_,1,t,!1,e,void 0,i),o+=this.getSnpLine(2,2,p,f,b,C,u,g,S,_,0,t,!1,e,void 0,i),a+=this.getSnpLine(1,2,p,f,b,C,u,g,S,_,1,t,!1,e,!0,i),a+=this.getSnpLine(2,2,p,f,b,C,u,g,S,_,0,t,!1,e,!0,i),r+=this.getSnpLine(1,2,p,f,b,C,u,g,S,_,1,t,!0,e,void 0,i),o+="</div>",r+="</div>",a+="</div>",$("#"+n.pre+"dt_snp_"+t).html(o),$("#"+n.pre+"ov_snp_"+t).html(r),$("#"+n.pre+"tt_snp_"+t).html(a)}else bClinvar=!0,d+=this.getSnpLine(1,2,p,f,b,C,u,g,S,_,1,t,!1,bClinvar,void 0,i),d+=this.getSnpLine(2,2,p,f,b,C,u,g,S,_,0,t,!1,bClinvar,void 0,i),h+=this.getSnpLine(1,2,p,f,b,C,u,g,S,_,1,t,!1,bClinvar,!0,i),h+=this.getSnpLine(2,2,p,f,b,C,u,g,S,_,0,t,!1,bClinvar,!0,i),c+=this.getSnpLine(1,2,p,f,b,C,u,g,S,_,1,t,!0,bClinvar,void 0,i),d+="</div>",c+="</div>",h+="</div>",$("#"+n.pre+"dt_clinvar_"+t).html(d),$("#"+n.pre+"ov_clinvar_"+t).html(c),$("#"+n.pre+"tt_clinvar_"+t).html(h),this.navClinVar(t,s);n.showAnnoCls.enableHlSeq(),i?(n.bAjaxSnp=!0,void 0!==n.deferredSnp&&n.deferredSnp.resolve()):(n.bAjaxClinvar=!0,void 0!==n.deferredClinvar&&n.deferredClinvar.resolve())}showClinvarPart2(e,t,s){this.icn3d.icn3dui;let i=this,l="https://www.ncbi.nlm.nih.gov/Structure/vastdyn/vastdyn.cgi?chainid_clinvar="+t;$.ajax({url:l,dataType:"jsonp",cache:!0,tryCount:0,retryLimit:1,success:function(s){if(s&&s.data&&s.data.length>0){let l=!1,n=s;i.processSnpClinvar(n,e,t,l)}else i.processNoClinvar(e)},error:function(t,s,i){this.tryCount++,this.tryCount<=this.retryLimit?$.ajax(this):this.processNoClinvar(e)}})}showSnp(e,t){this.icn3d.icn3dui,this.showSnpClinvar(e,t,!0)}showClinvar(e,t){this.icn3d.icn3dui,this.showSnpClinvar(e,t,!1)}showSnpClinvar(e,t,s){let i=this.icn3d;i.icn3dui;let l=this,n=i.icn3dui.htmlCls.baseUrl+"vastdyn/vastdyn.cgi?chainid="+t;$.ajax({url:n,dataType:"jsonp",cache:!0,tryCount:0,retryLimit:1,success:function(i){let n=i.snpgi,o=i.gi;if(s)l.showSnpPart2(e,t,n);else{let s=n;[6137708,1942289,224510717,2624886,253723219,2554905,75765331,3660278,312207882,319443632,342350956,1827805,109157826,1065265,40889086,6730307,163931185,494469,163931091,60594093,55669745,18655489,17942684,6980537,166235465,6435586,4139398,4389047,364506122,78101667,262118402,20664221,2624640,158430173,494395,28948777,34810587,13399647,3660342,261278854,342350965,384482350,378792570,15988303,213424334,4558333,2098365,10835631,3318817,374074330,332639529,122919696,4389286,319443573,2781341,67464020,194709238,210061039,364506106,28949044,40889076,161172338,17943181,4557976,62738484,365813173,6137343,350610552,17942703,576308,223674070,15826518,1310997,93279697,4139395,255311799,157837067,361132363,357380836,146387678,383280379,1127268,299856826,13786789,1311054,46015217,3402130,381353319,30750059,218766885,340707375,27065817,355333104,2624634,62738384,241913553,304446010].includes(o)&&(s=o),l.showClinvarPart2(e,t,s)}},error:function(t,i,n){this.tryCount++,this.tryCount<=this.retryLimit?$.ajax(this):s?l.processNoSnp(e):l.processNoClinvar(e)}})}showSnpPart2(e,t,s){this.icn3d.icn3dui;let i=this;if(void 0!==s){let l="https://www.ncbi.nlm.nih.gov/projects/SNP/beVarSearch.cgi?appname=iCn3D&format=bed&report=pdb2bed&connect=MSSNPSUBMISSION1&gi="+s;$.ajax({url:l,dataType:"text",cache:!0,tryCount:0,retryLimit:1,success:function(s){if(s){let l=!0;i.processSnpClinvar(s,e,t,l)}else{let s="https://www.ncbi.nlm.nih.gov/Structure/vastdyn/vastdyn.cgi?chainid_snp="+t;$.ajax({url:s,dataType:"jsonp",cache:!0,tryCount:0,retryLimit:1,success:function(s){if(s&&s.data&&s.data.length>0){let l=!0,n=!0;i.processSnpClinvar(s,e,t,l,n)}else i.processNoSnp(e)},error:function(t,s,l){this.tryCount++,this.tryCount<=this.retryLimit?$.ajax(this):i.processNoSnp(e)}})}},error:function(t,s,i){this.tryCount++,this.tryCount<=this.retryLimit?$.ajax(this):this.processNoSnp(e)}})}else this.processNoSnp(e),console.log("No gi was found for the chain "+t+"...")}processNoClinvar(e){let t=this.icn3d;t.icn3dui,console.log("No ClinVar data were found for the protein "+e+"..."),$("#"+t.pre+"dt_clinvar_"+e).html(""),$("#"+t.pre+"ov_clinvar_"+e).html(""),t.showAnnoCls.enableHlSeq(),t.bAjaxClinvar=!0,void 0!==t.deferredClinvar&&t.deferredClinvar.resolve()}processNoSnp(e){let t=this.icn3d;t.icn3dui,console.log("No SNP data were found for the protein "+e+"..."),$("#"+t.pre+"dt_snp_"+e).html(""),$("#"+t.pre+"ov_snp_"+e).html(""),t.showAnnoCls.enableHlSeq(),t.bAjaxSnp=!0,void 0!==t.deferredSnp&&t.deferredSnp.resolve()}}class Re{constructor(e){this.icn3d=e}showTransmem(e,t){let s=this.icn3d;s.icn3dui;let i=this;void 0===s.ssbondpnts?setTimeout((function(){i.showTransmem_base(e,t)}),1e3):this.showTransmem_base(e,t)}showTransmem_base(e,t){let s=this.icn3d;s.icn3dui;let i={};for(let e in s.chains[t]){let t=s.atoms[e];if(t.coord.z<s.halfBilayerSize&&t.coord.z>-s.halfBilayerSize){i[t.structure+"_"+t.chain+"_"+t.resi]=1}}let l=Object.keys(i);s.annoCddSiteCls.showAnnoType(e,t,"transmem","Transmembrane domain",l)}}class Ee{constructor(e){this.icn3d=e}hideAllAnno(){let e=this.icn3d;e.icn3dui,this.hideAllAnnoBase(),$("[id^="+e.pre+"custom]").hide()}hideAllAnnoBase(){this.icn3d.icn3dui,this.setAnnoSeqBase(!1)}setAnnoSeqBase(e){let t=this.icn3d;t.icn3dui;let s=["site","snp","clinvar","cdd","domain","interaction","ssbond","crosslink","transmem"];for(let i in s){let l=s[i];e?$("[id^="+t.pre+l+"]").show():$("[id^="+t.pre+l+"]").hide()}}setAnnoTabBase(e){let t=this.icn3d;t.icn3dui;let s=["all","binding","snp","clinvar","cdd","3dd","interact","custom","ssbond","crosslink","transmem"];for(let i in s){let l=s[i];$("#"+t.pre+"anno_"+l).length&&($("#"+t.pre+"anno_"+l)[0].checked=e)}}setAnnoTabAll(){this.icn3d.icn3dui,this.setAnnoTabBase(!0),this.setAnnoSeqBase(!0),this.updateClinvar(),this.updateSnp(),this.updateDomain(),this.updateInteraction(),this.updateSsbond(),this.updateCrosslink(),this.updateTransmem()}hideAnnoTabAll(){this.icn3d.icn3dui,this.setAnnoTabBase(!1),this.hideAllAnno()}resetAnnoAll(){let e=this.icn3d;e.icn3dui,$("[id^="+e.pre+"dt_]").html(""),$("[id^="+e.pre+"tt_]").html(""),$("[id^="+e.pre+"ov_]").html(""),e.showAnnoCls.processSeqData(e.chainid_seq),this.setAnnoViewAndDisplay("detailed view"),this.resetAnnoTabAll()}resetAnnoTabAll(){let e=this.icn3d;e.icn3dui,$("#"+e.pre+"anno_binding").length&&$("#"+e.pre+"anno_binding")[0].checked&&$("[id^="+e.pre+"site]").show(),$("#"+e.pre+"anno_snp").length&&$("#"+e.pre+"anno_snp")[0].checked&&($("[id^="+e.pre+"snp]").show(),e.bSnpShown=!1,this.updateSnp()),$("#"+e.pre+"anno_clinvar").length&&$("#"+e.pre+"anno_clinvar")[0].checked&&($("[id^="+e.pre+"clinvar]").show(),e.bClinvarShown=!1,this.updateClinvar()),$("#"+e.pre+"anno_cdd").length&&$("#"+e.pre+"anno_cdd")[0].checked&&$("[id^="+e.pre+"cdd]").show(),$("#"+e.pre+"anno_3dd").length&&$("#"+e.pre+"anno_3dd")[0].checked&&($("[id^="+e.pre+"domain]").show(),e.bDomainShown=!1,this.updateDomain()),$("#"+e.pre+"anno_interact").length&&$("#"+e.pre+"anno_interact")[0].checked&&($("[id^="+e.pre+"interaction]").show(),e.bInteractionShown=!1,this.updateInteraction()),$("#"+e.pre+"anno_custom").length&&$("#"+e.pre+"anno_custom")[0].checked&&$("[id^="+e.pre+"custom]").show(),$("#"+e.pre+"anno_ssbond").length&&$("#"+e.pre+"anno_ssbond")[0].checked&&($("[id^="+e.pre+"ssbond]").show(),e.bSSbondShown=!1,this.updateSsbond()),$("#"+e.pre+"anno_crosslink").length&&$("#"+e.pre+"anno_crosslink")[0].checked&&($("[id^="+e.pre+"crosslink]").show(),e.bCrosslinkShown=!1,this.updateCrosslink()),$("#"+e.pre+"anno_transmem").length&&$("#"+e.pre+"anno_transmem")[0].checked&&($("[id^="+e.pre+"transmem]").show(),e.bTranememShown=!1,this.updateTransmem())}setAnnoTabCustom(){let e=this.icn3d;e.icn3dui,$("[id^="+e.pre+"custom]").show(),$("#"+e.pre+"anno_custom").length&&($("#"+e.pre+"anno_custom")[0].checked=!0)}hideAnnoTabCustom(){let e=this.icn3d;e.icn3dui,$("[id^="+e.pre+"custom]").hide(),$("#"+e.pre+"anno_custom").length&&($("#"+e.pre+"anno_custom")[0].checked=!1)}setAnnoTabClinvar(){let e=this.icn3d;e.icn3dui,$("[id^="+e.pre+"clinvar]").show(),$("#"+e.pre+"anno_clinvar").length&&($("#"+e.pre+"anno_clinvar")[0].checked=!0),this.updateClinvar()}hideAnnoTabClinvar(){let e=this.icn3d;e.icn3dui,$("[id^="+e.pre+"clinvar]").hide(),$("#"+e.pre+"anno_clinvar").length&&($("#"+e.pre+"anno_clinvar")[0].checked=!1)}setAnnoTabSnp(){let e=this.icn3d;e.icn3dui,$("[id^="+e.pre+"snp]").show(),$("#"+e.pre+"anno_snp").length&&($("#"+e.pre+"anno_snp")[0].checked=!0),this.updateSnp()}hideAnnoTabSnp(){let e=this.icn3d;e.icn3dui,$("[id^="+e.pre+"snp]").hide(),$("#"+e.pre+"anno_snp").length&&($("#"+e.pre+"anno_snp")[0].checked=!1)}setAnnoTabCdd(){let e=this.icn3d;e.icn3dui,$("[id^="+e.pre+"cdd]").show(),$("#"+e.pre+"anno_cdd").length&&($("#"+e.pre+"anno_cdd")[0].checked=!0)}hideAnnoTabCdd(){let e=this.icn3d;e.icn3dui,$("[id^="+e.pre+"cdd]").hide(),$("#"+e.pre+"anno_cdd").length&&($("#"+e.pre+"anno_cdd")[0].checked=!1)}setAnnoTab3ddomain(){let e=this.icn3d;e.icn3dui,$("[id^="+e.pre+"domain]").show(),$("#"+e.pre+"anno_3dd").length&&($("#"+e.pre+"anno_3dd")[0].checked=!0),this.updateDomain()}hideAnnoTab3ddomain(){let e=this.icn3d;e.icn3dui,$("[id^="+e.pre+"domain]").hide(),$("#"+e.pre+"anno_3dd").length&&($("#"+e.pre+"anno_3dd")[0].checked=!1)}setAnnoTabSite(){let e=this.icn3d;e.icn3dui,$("[id^="+e.pre+"site]").show(),$("[id^="+e.pre+"feat]").show(),$("#"+e.pre+"anno_binding").length&&($("#"+e.pre+"anno_binding")[0].checked=!0)}hideAnnoTabSite(){let e=this.icn3d;e.icn3dui,$("[id^="+e.pre+"site]").hide(),$("[id^="+e.pre+"feat]").hide(),$("#"+e.pre+"anno_binding").length&&($("#"+e.pre+"anno_binding")[0].checked=!1)}setAnnoTabInteraction(){let e=this.icn3d;e.icn3dui,$("[id^="+e.pre+"interaction]").show(),$("#"+e.pre+"anno_interact").length&&($("#"+e.pre+"anno_interact")[0].checked=!0),this.updateInteraction()}hideAnnoTabInteraction(){let e=this.icn3d;e.icn3dui,$("[id^="+e.pre+"interaction]").hide(),$("#"+e.pre+"anno_interact").length&&($("#"+e.pre+"anno_interact")[0].checked=!1)}setAnnoTabSsbond(){let e=this.icn3d;e.icn3dui,$("[id^="+e.pre+"ssbond]").show(),$("#"+e.pre+"anno_ssbond").length&&($("#"+e.pre+"anno_ssbond")[0].checked=!0),this.updateSsbond()}hideAnnoTabSsbond(){let e=this.icn3d;e.icn3dui,$("[id^="+e.pre+"ssbond]").hide(),$("#"+e.pre+"anno_ssbond").length&&($("#"+e.pre+"anno_ssbond")[0].checked=!1)}setAnnoTabCrosslink(){let e=this.icn3d;e.icn3dui,$("[id^="+e.pre+"crosslink]").show(),$("#"+e.pre+"anno_crosslink").length&&($("#"+e.pre+"anno_crosslink")[0].checked=!0),this.updateCrosslink()}hideAnnoTabCrosslink(){let e=this.icn3d;e.icn3dui,$("[id^="+e.pre+"crosslink]").hide(),$("#"+e.pre+"anno_crosslink").length&&($("#"+e.pre+"anno_crosslink")[0].checked=!1)}setAnnoTabTransmem(){let e=this.icn3d;e.icn3dui,$("[id^="+e.pre+"transmem]").show(),$("#"+e.pre+"anno_transmem").length&&($("#"+e.pre+"anno_transmem")[0].checked=!0),this.updateTransmem()}hideAnnoTabTransmem(){let e=this.icn3d;e.icn3dui,$("[id^="+e.pre+"transmem]").hide(),$("#"+e.pre+"anno_transmem").length&&($("#"+e.pre+"anno_transmem")[0].checked=!1)}setTabs(){let e=this.icn3d,t=e.icn3dui,s=this;$("#"+e.pre+"dl_addtrack_tabs").tabs(),$("#"+e.pre+"dl_anno_view_tabs").tabs(),t.myEventCls.onIds("#"+e.pre+"anno_all","click",(function(t){$("#"+e.pre+"anno_all")[0].checked?(s.setAnnoTabAll(),e.icn3dui.htmlCls.clickMenuCls.setLogCmd("set annotation all",!0)):(s.hideAnnoTabAll(),e.icn3dui.htmlCls.clickMenuCls.setLogCmd("hide annotation all",!0))})),t.myEventCls.onIds("#"+e.pre+"anno_binding","click",(function(t){$("#"+e.pre+"anno_binding")[0].checked?(s.setAnnoTabSite(),e.icn3dui.htmlCls.clickMenuCls.setLogCmd("set annotation site",!0)):(s.hideAnnoTabSite(),e.icn3dui.htmlCls.clickMenuCls.setLogCmd("hide annotation site",!0))})),t.myEventCls.onIds("#"+e.pre+"anno_snp","click",(function(t){$("#"+e.pre+"anno_snp")[0].checked?(s.setAnnoTabSnp(),e.icn3dui.htmlCls.clickMenuCls.setLogCmd("set annotation snp",!0)):(s.hideAnnoTabSnp(),e.icn3dui.htmlCls.clickMenuCls.setLogCmd("hide annotation snp",!0))})),t.myEventCls.onIds("#"+e.pre+"anno_clinvar","click",(function(t){$("#"+e.pre+"anno_clinvar")[0].checked?(s.setAnnoTabClinvar(),e.icn3dui.htmlCls.clickMenuCls.setLogCmd("set annotation clinvar",!0)):(s.hideAnnoTabClinvar(),e.icn3dui.htmlCls.clickMenuCls.setLogCmd("hide annotation clinvar",!0))})),t.myEventCls.onIds("#"+e.pre+"anno_cdd","click",(function(e){s.clickCdd()})),t.myEventCls.onIds("#"+e.pre+"anno_3dd","click",(function(t){$("#"+e.pre+"anno_3dd")[0].checked?(s.setAnnoTab3ddomain(),e.icn3dui.htmlCls.clickMenuCls.setLogCmd("set annotation 3ddomain",!0)):(s.hideAnnoTab3ddomain(),e.icn3dui.htmlCls.clickMenuCls.setLogCmd("hide annotation 3ddomain",!0))})),t.myEventCls.onIds("#"+e.pre+"anno_interact","click",(function(t){$("#"+e.pre+"anno_interact")[0].checked?(s.setAnnoTabInteraction(),e.icn3dui.htmlCls.clickMenuCls.setLogCmd("set annotation interaction",!0)):(s.hideAnnoTabInteraction(),e.icn3dui.htmlCls.clickMenuCls.setLogCmd("hide annotation interaction",!0))})),t.myEventCls.onIds("#"+e.pre+"anno_custom","click",(function(t){$("#"+e.pre+"anno_custom")[0].checked?(s.setAnnoTabCustom(),e.icn3dui.htmlCls.clickMenuCls.setLogCmd("set annotation custom",!0)):(s.hideAnnoTabCustom(),e.icn3dui.htmlCls.clickMenuCls.setLogCmd("hide annotation custom",!0))})),t.myEventCls.onIds("#"+e.pre+"anno_ssbond","click",(function(t){$("#"+e.pre+"anno_ssbond")[0].checked?(s.setAnnoTabSsbond(),e.icn3dui.htmlCls.clickMenuCls.setLogCmd("set annotation ssbond",!0)):(s.hideAnnoTabSsbond(),e.icn3dui.htmlCls.clickMenuCls.setLogCmd("hide annotation ssbond",!0))})),t.myEventCls.onIds("#"+e.pre+"anno_crosslink","click",(function(t){$("#"+e.pre+"anno_crosslink")[0].checked?(s.setAnnoTabCrosslink(),e.icn3dui.htmlCls.clickMenuCls.setLogCmd("set annotation crosslink",!0)):(s.hideAnnoTabCrosslink(),e.icn3dui.htmlCls.clickMenuCls.setLogCmd("hide annotation crosslink",!0))})),t.myEventCls.onIds("#"+e.pre+"anno_transmem","click",(function(t){$("#"+e.pre+"anno_transmem").length&&$("#"+e.pre+"anno_transmem")[0].checked?(s.setAnnoTabTransmem(),e.icn3dui.htmlCls.clickMenuCls.setLogCmd("set annotation transmembrane",!0)):(s.hideAnnoTabTransmem(),e.icn3dui.htmlCls.clickMenuCls.setLogCmd("hide annotation transmembrane",!0))}))}clickCdd(){let e=this.icn3d;e.icn3dui,$("[id^="+e.pre+"cdd]").length>0&&($("#"+e.pre+"anno_cdd")[0].checked?(this.setAnnoTabCdd(),e.icn3dui.htmlCls.clickMenuCls.setLogCmd("set annotation cdd",!0)):(this.hideAnnoTabCdd(),e.icn3dui.htmlCls.clickMenuCls.setLogCmd("hide annotation cdd",!0)))}showAnnoSelectedChains(){let e=this.icn3d,t=e.icn3dui,s={};for(let t in e.hAtoms){let i=e.atoms[t];s[i.structure+"_"+i.chain]=1}$("#"+e.pre+"dl_annotations > .icn3d-annotation").hide();for(let i in s){$("#"+e.pre+"anno_"+i).length&&$("#"+e.pre+"anno_"+i).show();let s=e.firstAtomObjCls.getFirstCalphaAtomObj(e.chains[i]);if(void 0!==s.resn){let i=t.utilsCls.residueName2Abbr(s.resn.substr(0,3));$("#"+e.pre+"anno_"+i).show()}}}showAnnoAllChains(){let e=this.icn3d;e.icn3dui,$("#"+e.pre+"dl_annotations > .icn3d-annotation").show()}setAnnoView(e){let t=this.icn3d;t.icn3dui,"detailed view"===e?(t.view="detailed view",$("#"+t.pre+"dl_anno_view_tabs").tabs("option","active",1)):(t.view="overview",$("#"+t.pre+"dl_anno_view_tabs").tabs("option","active",0))}setAnnoDisplay(e,t){let s=this.icn3d;s.icn3dui;let i=["giseq","custom","site","snp","clinvar","cdd","domain","interaction","ssbond","crosslink","transmem"];for(let l in i){let n=i[l];$("[id^="+s.pre+t+"_"+n+"]").attr("style",e)}}showFixedTitle(){this.icn3d.icn3dui;this.setAnnoDisplay("display:block;","tt")}hideFixedTitle(){this.icn3d.icn3dui;this.setAnnoDisplay("display:none!important;","tt")}setAnnoViewAndDisplay(e){let t=this.icn3d;if(t.icn3dui,"detailed view"===e){this.setAnnoView("detailed view");let e="display:block;";this.setAnnoDisplay(e,"dt"),$("#"+t.pre+"seqguide_wrapper").attr("style",e),e="display:none;",this.setAnnoDisplay(e,"ov")}else{this.setAnnoView("overview"),this.hideFixedTitle();let e="display:none;";this.setAnnoDisplay(e,"dt"),$("#"+t.pre+"seqguide_wrapper").attr("style",e),e="display:block;",this.setAnnoDisplay(e,"ov")}}updateClinvar(){let e=this.icn3d;if(e.icn3dui,void 0===e.bClinvarShown||!e.bClinvarShown)for(let t in e.protein_chainid){let s=e.protein_chainid[t];e.annoSnpClinVarCls.showClinvar(t,s)}e.bClinvarShown=!0}updateSnp(){let e=this.icn3d;if(e.icn3dui,void 0===e.bSnpShown||!e.bSnpShown)for(let t in e.protein_chainid){let s=e.protein_chainid[t];e.annoSnpClinVarCls.showSnp(t,s)}e.bSnpShown=!0}updateDomain(){let e=this.icn3d;e.icn3dui,void 0!==e.bDomainShown&&e.bDomainShown||e.annoDomainCls.showDomainAll(),e.bDomainShown=!0}updateInteraction(){let e=this.icn3d;if(e.icn3dui,void 0===e.bInteractionShown||!e.bInteractionShown)for(let t in e.interactChainbase){let s=e.interactChainbase[t];e.annoContactCls.showInteraction(t,s)}e.bInteractionShown=!0}updateSsbond(){let e=this.icn3d;if(e.icn3dui,void 0===e.bSSbondShown||!e.bSSbondShown)for(let t in e.ssbondChainbase){let s=e.ssbondChainbase[t];e.annoSsbondCls.showSsbond(t,s)}e.bSSbondShown=!0}updateCrosslink(){let e=this.icn3d;if(e.icn3dui,void 0===e.bCrosslinkShown||!e.bCrosslinkShown)for(let t in e.crosslinkChainbase){let s=e.crosslinkChainbase[t];e.annoCrossLinkCls.showCrosslink(t,s)}e.bCrosslinkShown=!0}updateTransmem(){let e=this.icn3d;if(e.icn3dui,void 0===e.bTranememShown||!e.bTranememShown)for(let t in e.protein_chainid){let s=e.protein_chainid[t];e.annoTransMemCls.showTransmem(t,s)}e.bTranememShown=!0}}class Ie{constructor(e){this.icn3d=e}draw2Ddgm(e,t,s,i){let l=this.icn3d;l.icn3dui,t=t.substr(0,4);let n=.5,o={},r={},a={},d={},c={};if(void 0===e)return"";for(let i in e.moleculeInfor){let n="#"+("000000"+e.moleculeInfor[i].color.toString(16)).slice(-6),h=e.moleculeInfor[i].chain.trim();void 0===c[h]?c[h]=1:++c[h];let m=1===c[h]?h:h+c[h].toString(),p=t+"_"+m;void 0!==l.mmdbid_q&&l.mmdbid_q===l.mmdbid_t&&0===s&&(p=t+l.icn3dui.htmlCls.postfix+"_"+m),o[i]=p,r[i]=n,a[i]=e.moleculeInfor[i].name,d[p]=i}if(void 0===i||!i)for(let s=0,i=e.intracResidues.length;s<i;++s){let i,n,r=e.intracResidues[s],a=0;for(let e in r){let t;t=o[e],0===a?i=t:n=t,++a}if(void 0!==i&&void 0!==n){a=0;for(let e in r){let s,o,d=r[e];0===a?(s=i,o=n):(s=n,o=i),void 0===l.chainids2resids[s]&&(l.chainids2resids[s]={}),void 0===l.chainids2resids[s][o]&&(l.chainids2resids[s][o]=[]);for(let i=0,n=d.length;i<n;++i){let n=d[i],r=l.mmdbMolidResid2mmdbChainResi[t.toUpperCase()+"_"+e+"_"+n];l.chainids2resids[s][o].push(r)}if(void 0===l.chainname2residues&&(l.chainname2residues={}),n=o,!l.chains.hasOwnProperty(n))continue;let c,h=l.firstAtomObjCls.getFirstCalphaAtomObj(l.chains[n]);l.chemicals.hasOwnProperty(h.serial)?c="chemical":l.nucleotides.hasOwnProperty(h.serial)?c="nucleotide":l.ions.hasOwnProperty(h.serial)?c="ion":l.proteins.hasOwnProperty(h.serial)?c="protein":l.water.hasOwnProperty(h.serial)&&(c="water");let m=n.substr(n.indexOf("_")+1)+"("+c+")";void 0===l.chainname2residues[s]&&(l.chainname2residues[s]={}),l.chainname2residues[s][m]=l.chainids2resids[s][o],++a}}}let h="<div id='#"+l.pre+t+"'>";h+="<b>"+t.toUpperCase()+"</b><br/>",h+="<svg viewBox='0,0,150,150'>";let m={},p=[],u="",C="",g={};if(i)for(let e in l.dAtoms){let t=l.atoms[e];g[d[t.structure+"_"+t.chain]]=1}let f=Object.keys(e.moleculeInfor),b=Object.keys(e.intrac),y=[];for(let e=0,t=f.length;e<t;++e)-1===b.indexOf(f[e])&&y.push(f[e]);let v={};if(y.length>0)for(let t in e.intrac){let s=e.intrac[t];for(let e=0,i=s.intrac.length;e<i;++e){let i=s.intrac[e].toString();-1!==y.indexOf(i)&&(void 0===v[i]&&(v[i]=[]),v[i].push(t),p.push([i,t]))}if("rect"===s.shape){let e=s.coords[0]*n,i=s.coords[1]*n,l=s.coords[2]*n-e,o=s.coords[3]*n-i;m[t]=[e+l/2,i+o/2]}else if("circle"===s.shape){let e=s.coords[0]*n,i=s.coords[1]*n;s.coords[2],m[t]=[e,i]}else if("poly"===s.shape){let e=s.coords[0]*n;s.coords[1],s.coords[2];let i=s.coords[3]*n;s.coords[4],s.coords[5],s.coords[6],s.coords[7],m[t]=[e,i]}}let w=0;for(let t=0,d=f.length;t<d;++t){let d=f[t],c=o[d];if(i&&!g.hasOwnProperty(d))continue;let h=e.intrac[d],b="#FFFFFF",S=r[d];if(void 0!==c&&void 0!==l.chains[c]){let e=Object.keys(l.chains[c]);e.length>0&&(S="#"+l.atoms[e[0]].color.getHexString().toUpperCase())}let _="";l.bInitial&&void 0!==s&&(void 0!==l.alignmolid2color&&l.alignmolid2color[s].hasOwnProperty(d)?(_=l.alignmolid2color[s][d],S="#FF0000"):S="#FFFFFF");let A=a[d],x=" ",k=" ";if(void 0!==c){let e=c.indexOf("_");k=c.substr(e+1),x=k.length>1?k.substr(0,1)+"..":k}else c="Misc";void 0===S&&(S="#FFFFFF");let O=1;if(l.bInitial&&void 0!==l.alnChains[c]){let e=0;for(let t in l.alnChains[c]){let s=l.atoms[t].color.getHexString().toUpperCase();"FF0000"!==s&&"00FF00"!==s||++e}O=1*e/Object.keys(l.chains[c]).length}if(O<.2&&(O=.2),-1===y.indexOf(d)){for(let e=0,t=h.intrac.length;e<t;++e)parseInt(d)<parseInt(h.intrac[e])&&p.push([d,h.intrac[e]]);if("rect"===h.shape){let e=h.coords[0]*n,t=h.coords[1]*n,s=h.coords[2]*n-e,i=h.coords[3]*n-t;u+=this.draw2DNucleotide(e+.5*s,t+.5*i,c,k,x,A,_,b,S,n,O),m[d]=[e+s/2,t+i/2]}else if("circle"===h.shape){let e=h.coords[0]*n,t=h.coords[1]*n;u+=this.draw2DProtein(e,t,c,k,x,A,_,b,S,n,O),m[d]=[e,t]}else if("poly"===h.shape){let e=h.coords[0]*n;h.coords[1],h.coords[2];let t=h.coords[3]*n;h.coords[4],h.coords[5],h.coords[6],h.coords[7];let s=e,i=t;l.firstAtomObjCls.getFirstAtomObj(l.chains[c]),C+=this.draw2DChemical(s,i,c,k,x,A,_,b,S,n,O),m[d]=[e,t]}}else{let e,t,s=300,i=50;if(void 0!==v[d]&&v[d].length>1){let s=0,i=0;for(let e=0,t=v[d].length;e<t;++e){let t=v[d][e];if(m.hasOwnProperty(t)){let e=m[t];s+=e[0],i+=e[1]}}e=s/v[d].length,t=i/v[d].length}else{let l=s/i;w<l-1?(e=(w+1)*i*n,t=.1*s*n):w-(l-1)<l-1?(e=.1*s*n,t=(w-(l-1)+1)*i*n):(e=.25*s*n,t=e),++w}let o=e,r=t;l.firstAtomObjCls.getFirstAtomObj(l.chains[c]);let a=!0;C+=this.draw2DChemical(o,r,c,k,x,A,_,b,S,n,O,a),m[d]=[o,r]}}for(let e=0,t=p.length;e<t;++e){let t=p[e];if(i&&(!g.hasOwnProperty(t[0])||!g.hasOwnProperty(t[1])))continue;let s,l,n=m[parseInt(t[0])],r=m[parseInt(t[1])];if(void 0===n||void 0===r)continue;s=o[t[0]],l=o[t[1]];let a=s.indexOf("_"),d=l.indexOf("_"),c=s.substr(a+1),u=l.substr(d+1),C=n[0],f=n[1],b=r[0],y=r[1],v=.5*(C+b),w=.5*(f+y);h+="<g class='icn3d-interaction' chainid1='"+s+"' chainid2='"+l+"' >",h+="<title>Interaction of chain "+c+" with chain "+u+"</title>",h+="<line x1='"+C+"' y1='"+f+"' x2='"+v+"' y2='"+w+"' stroke='"+"#000000' stroke-width='2' /></g>",h+="<g class='icn3d-interaction' chainid1='"+l+"' chainid2='"+s+"' >",h+="<title>Interaction of chain "+u+" with chain "+c+"</title>",h+="<line x1='"+v+"' y1='"+w+"' x2='"+b+"' y2='"+y+"' stroke='"+"#000000' stroke-width='2' /></g>"}return h+=C+u,h+="</svg>",h+="</div>",l.html2ddgm+=h,$("#"+l.pre+"dl_2ddgm").html(l.html2ddgm),h}set2DdgmNote(e){let t="<div style='width:150px'><b>Nodes</b>:<br>";return this.icn3d.icn3dui.utilsCls.isMac()?(t+="<span style='margin-right:18px;'>&#9711;</span>Protein<br>",t+="<span style='margin-right:18px;'>&#9634;</span>Nucleotide<br>",t+="<span style='margin-right:18px;'>&#9826;</span>Chemical<br>",t+="<span style='margin-right:18px;display: inline-block;transform: skew(-25deg);'>&#9634;</span>Biopolymer<br>"):(t+="<span style='margin-right:18px;'>O</span>Protein<br>",t+="<span style='margin-right:18px;'>&#9634;</span>Nucleotide<br>",t+="<span style='margin-right:18px;'>&#9671;</span>Chemical<br>",t+="<span style='margin-right:18px;display: inline-block;transform: skew(-25deg);'>&#9634;</span>Biopolymer<br>"),t+="<br><b>Lines</b>:<br> Interactions at 4 &#197;<br>",e&&(t+="<b>Numbers in red</b>:<br> Aligned chains"),t+="</div><br/>",t}highlightNode(e,t,s,i){let l=this.icn3d;l.icn3dui,i<.2&&(i=.2);if("rect"===e){$(t).attr("stroke",l.icn3dui.htmlCls.ORANGE),$(t).attr("stroke-width",3);let e=Number($(s).attr("x")),n=Number($(s).attr("y")),o=Number($(s).attr("width")),r=Number($(s).attr("height"));$(t).attr("x",e+o/2*(1-i)),$(t).attr("y",n+r/2*(1-i)),$(t).attr("width",o*i),$(t).attr("height",r*i)}else if("circle"===e)$(t).attr("stroke",l.icn3dui.htmlCls.ORANGE),$(t).attr("stroke-width",3),$(t).attr("r",Number($(s).attr("r"))*i);else if("polygon"===e){$(t).attr("stroke",l.icn3dui.htmlCls.ORANGE),$(t).attr("stroke-width",3);let e=Number($(s).attr("x")),n=Number($(s).attr("y")),o=Number($(s).attr("x0d")),r=Number($(s).attr("y0d")),a=Number($(s).attr("x1d")),d=Number($(s).attr("y1d")),c=Number($(s).attr("x2d")),h=Number($(s).attr("y2d")),m=Number($(s).attr("x3d")),p=Number($(s).attr("y3d"));$(t).attr("points",(e+o*i).toString()+", "+(n+r*i).toString()+", "+(e+a*i).toString()+", "+(n+d*i).toString()+", "+(e+c*i).toString()+", "+(n+h*i).toString()+", "+(e+m*i).toString()+", "+(n+p*i).toString())}}removeLineGraphSelection(){let e=this.icn3d;e.icn3dui,$("#"+e.pre+"dl_linegraph circle").attr("stroke","#000000"),$("#"+e.pre+"dl_linegraph circle").attr("stroke-width",1),$("#"+e.pre+"dl_linegraph svg line.icn3d-hlline").attr("stroke","#FFF")}removeScatterplotSelection(){let e=this.icn3d;e.icn3dui,$("#"+e.pre+"dl_scatterplot circle").attr("stroke","#000000"),$("#"+e.pre+"dl_scatterplot circle").attr("stroke-width",1),$("#"+e.pre+"dl_scatterplot rect").attr("stroke","#000000"),$("#"+e.pre+"dl_scatterplot rect").attr("stroke-width",1)}click2Ddgm(){let e=this.icn3d,t=e.icn3dui,s=this;$(document).on("click","#"+e.pre+"dl_2ddgm .icn3d-node",(function(e){let i=s.icn3d;e.stopImmediatePropagation(),Object.keys(i.hAtoms).length<Object.keys(i.atoms).length&&i.definedSetsCls.setMode("selection");let l=$(this).attr("chainid");i.bCtrl||i.bShift||(i.selectionCls.removeSelection(),i.lineArray2d=[]);let n=1;void 0!==i.alnChains[l]&&(n=1*Object.keys(i.alnChains[l]).length/Object.keys(i.chains[l]).length);let o=$(this).find("rect[class='icn3d-hlnode']"),r=$(this).find("rect[class='icn3d-basenode']");s.highlightNode("rect",o,r,n),o=$(this).find("circle[class='icn3d-hlnode']"),r=$(this).find("circle[class='icn3d-basenode']"),s.highlightNode("circle",o,r,n),o=$(this).find("polygon[class='icn3d-hlnode']"),r=$(this).find("polygon[class='icn3d-basenode']"),s.highlightNode("polygon",o,r,n),i.bCtrl||i.bShift?i.hAtoms=t.hashUtilsCls.unionHash(i.hAtoms,i.chains[l]):i.hAtoms=t.hashUtilsCls.cloneHash(i.chains[l]),i.bCtrl||i.bShift?(void 0===i.chainArray2d&&(i.chainArray2d=[]),i.chainArray2d.push(l)):i.chainArray2d=[l],i.hlUpdateCls.updateHlAll(i.chainArray2d),i.annotationCls.showAnnoSelectedChains();let a="select chain "+l;i.icn3dui.htmlCls.clickMenuCls.setLogCmd(a,!0),i.bSelectResidue=!1})),$(document).on("click","#"+e.pre+"dl_2ddgm .icn3d-interaction",(function(e){let t=s.icn3d;e.stopImmediatePropagation(),Object.keys(t.hAtoms).length<Object.keys(t.atoms).length&&t.definedSetsCls.setMode("selection"),t.bClickInteraction=!0;let i=$(this).attr("chainid1"),l=$(this).attr("chainid2");$(this).find("line").attr("stroke",t.icn3dui.htmlCls.ORANGE),s.selectInteraction(i,l),t.annotationCls.showAnnoSelectedChains();let n="select interaction "+i+","+l;t.icn3dui.htmlCls.clickMenuCls.setLogCmd(n,!0),t.bClickInteraction=!1})),$(document).on("click","#"+e.pre+"dl_linegraph .icn3d-node",(function(e){let i=s.icn3d;e.stopImmediatePropagation(),Object.keys(i.hAtoms).length<Object.keys(i.atoms).length&&i.definedSetsCls.setMode("selection");let l=$(this).attr("resid");i.bCtrl||i.bShift||(i.hAtoms={},s.removeLineGraphSelection());$(this).find("circle").attr("stroke",i.icn3dui.htmlCls.ORANGE),$(this).find("circle").attr("stroke-width",2),i.hAtoms=t.hashUtilsCls.unionHash(i.hAtoms,i.residues[l]);let n="select "+i.resid2specCls.residueids2spec([l]);i.hlUpdateCls.updateHlAll(),i.icn3dui.htmlCls.clickMenuCls.setLogCmd(n,!0),i.bSelectResidue=!1})),$(document).on("click","#"+e.pre+"dl_scatterplot .icn3d-node",(function(e){s.icn3d,e.stopImmediatePropagation(),s.clickNode(this)})),$(document).on("click","#"+e.pre+"dl_linegraph .icn3d-interaction",(function(e){let i=s.icn3d;e.stopImmediatePropagation(),Object.keys(i.hAtoms).length<Object.keys(i.atoms).length&&i.definedSetsCls.setMode("selection");let l=$(this).attr("resid1"),n=$(this).attr("resid2");i.bCtrl||i.bShift||(i.hAtoms={},s.removeLineGraphSelection()),$(this).find("line.icn3d-hlline").attr("stroke",i.icn3dui.htmlCls.ORANGE),i.hAtoms=t.hashUtilsCls.unionHash(i.hAtoms,i.residues[l]),i.hAtoms=t.hashUtilsCls.unionHash(i.hAtoms,i.residues[n]);let o="select "+i.resid2specCls.residueids2spec([l,n]);i.hlUpdateCls.updateHlAll(),i.icn3dui.htmlCls.clickMenuCls.setLogCmd(o,!0)})),$(document).on("click","#"+e.pre+"dl_scatterplot .icn3d-interaction",(function(e){s.icn3d,e.stopImmediatePropagation(),s.clickInteraction(this)})),$(document).on("click","#"+e.pre+"dl_contactmap .icn3d-interaction",(function(e){s.icn3d,e.stopImmediatePropagation(),s.clickInteraction(this)})),$(document).on("click","#"+e.pre+"dl_contactmap .icn3d-node",(function(e){s.icn3d,e.stopImmediatePropagation(),s.clickNode(this)}))}clickNode(e){let t=this.icn3d,s=t.icn3dui;Object.keys(t.hAtoms).length<Object.keys(t.atoms).length&&t.definedSetsCls.setMode("selection");let i=$(e).attr("resid");t.bCtrl||t.bShift||(t.hAtoms={},this.removeScatterplotSelection());$(e).find("circle").attr("stroke",t.icn3dui.htmlCls.ORANGE),$(e).find("circle").attr("stroke-width",2),t.hAtoms=s.hashUtilsCls.unionHash(t.hAtoms,t.residues[i]);let l="select "+t.resid2specCls.residueids2spec([i]);t.hlUpdateCls.updateHlAll(),t.icn3dui.htmlCls.clickMenuCls.setLogCmd(l,!0),t.bSelectResidue=!1}clickInteraction(e){let t=this.icn3d,s=t.icn3dui;Object.keys(t.hAtoms).length<Object.keys(t.atoms).length&&t.definedSetsCls.setMode("selection");let i=$(e).attr("resid1"),l=$(e).attr("resid2");t.bCtrl||t.bShift||(t.hAtoms={},this.removeScatterplotSelection());$(e).find("rect").attr("stroke",t.icn3dui.htmlCls.ORANGE),$(e).find("rect").attr("stroke-width",2),t.hAtoms=s.hashUtilsCls.unionHash(t.hAtoms,t.residues[i]),t.hAtoms=s.hashUtilsCls.unionHash(t.hAtoms,t.residues[l]);let n="select "+t.resid2specCls.residueids2spec([i,l]);t.hlUpdateCls.updateHlAll(),t.icn3dui.htmlCls.clickMenuCls.setLogCmd(n,!0)}selectInteraction(e,t){let s=this.icn3d;s.icn3dui,s.hlUpdateCls.removeHl2D(),s.hlObjectsCls.removeHlObjects(),s.bCtrl||s.bShift?(void 0===s.lineArray2d&&(s.lineArray2d=[]),s.lineArray2d.push(e),s.lineArray2d.push(t)):s.lineArray2d=[e,t],this.selectInteractionAtoms(e,t),s.hlObjectsCls.addHlObjects(),s.hlUpdateCls.updateHlAll()}selectInteractionAtoms(e,t){let s,i,l=this.icn3d,n=l.icn3dui,o=l.chainids2resids[e][t];l.bCtrl||l.bShift||(l.hAtoms={});for(let e=0,t=o.length;e<t;++e)l.hAtoms=n.hashUtilsCls.unionHash(l.hAtoms,l.residues[o[e]]);if(Object.keys(l.structures).length>1)s="inter_"+e+"_"+t;else{let i=e.indexOf("_"),l=t.indexOf("_");s="inter_"+e.substr(i+1)+"_"+t.substr(l+1)}i="select the atoms in chain "+e+" interacting with chain "+t+" in a distance of 4 angstrom";let r="select interaction "+e+","+t;l.selectionCls.addCustomSelection(o,s,i,r,!0)}draw2DProtein(e,t,s,i,l,n,o,r,a,d,c){this.icn3d.icn3dui;let h=20*d,m="<g class='icn3d-node' chainid='"+s+"' >";return m+="<title>Chain "+i+": "+n+"</title>",m+="<circle class='icn3d-basenode' cx='"+e+"' cy='"+t+"' r='"+h+"' fill='"+r+"' stroke-width='1' stroke='"+"#000000' class='icn3d-node' chainid='"+s+"' />",m+="<circle class='icn3d-hlnode' cx='"+e+"' cy='"+t+"' r='"+(h*c).toString()+"' fill='"+a+"' stroke-width='1' stroke='"+"#000000' />",m+="<text x='"+(e-0).toString()+"' y='"+(t+4).toString()+"' style='fill:#000000; font-size:10; text-anchor:middle' >"+l+"</text>",""!==o&&(m+="<text x='"+(e-0).toString()+"' y='"+(t+h+4+6).toString()+"' style='fill:"+a+"; font-size:8; font-weight:bold; text-anchor:middle' >"+o+"</text>"),m+="</g>",m}draw2DNucleotide(e,t,s,i,l,n,o,r,a,d,c){this.icn3d.icn3dui;let h=30*d,m=30*d,p="<g class='icn3d-node' chainid='"+s+"' >";return p+="<title>Chain "+i+": "+n+"</title>",p+="<rect class='icn3d-basenode' x='"+(e-=.5*h)+"' y='"+(t-=.5*m)+"' width='"+h+"' height='"+m+"' fill='"+r+"' stroke-width='1' stroke='"+"#000000' />",p+="<rect class='icn3d-hlnode' x='"+(e+h/2*(1-c)).toString()+"' y='"+(t+m/2*(1-c)).toString()+"' width='"+(h*c).toString()+"' height='"+(m*c).toString()+"' fill='"+a+"' stroke-width='1' stroke='"+"#000000' />",p+="<text x='"+(e+h/2-0).toString()+"' y='"+(t+m/2+4).toString()+"' style='fill:#000000; font-size:10; text-anchor:middle' >"+l+"</text>",""!==o&&(p+="<text x='"+(e+h/2-0).toString()+"' y='"+(t+m+4+6).toString()+"' style='fill:"+a+"; font-size:8; font-weight:bold; text-anchor:middle' >"+o+"</text>"),p+="</g>",p}draw2DChemical(e,t,s,i,l,n,o,r,a,d,c,h){this.icn3d.icn3dui;let m,p,u,C,g,f,b,y,v=30*d;if(h){let s=.5*v/Math.sqrt(3),i=.5*v;m=e-s,p=t-i,u=e+3*s,C=t-i,g=e+s,f=t+i,b=e-3*s,y=t+i}else{let s=.5*v,i=.5*v;m=e-s,p=t,u=e,C=t+i,g=e+s,f=t,b=e,y=t-i}let w=m-e,S=p-t,_=u-e,A=C-t,x=g-e,k=f-t,O=b-e,H=y-t,R="<g class='icn3d-node' chainid='"+s+"' >";return R+="<title>Chain "+i+": "+n+"</title>",R+="<polygon class='icn3d-basenode' points='"+m+", "+p+","+u+", "+C+","+g+", "+f+","+b+", "+y+"' x='"+e+"' y='"+t+"' x0d='"+w+"' y0d='"+S+"' x1d='"+_+"' y1d='"+A+"' x2d='"+x+"' y2d='"+k+"' x3d='"+O+"' y3d='"+H+"' fill='"+r+"' stroke-width='1' stroke='"+"#000000' />",R+="<polygon class='icn3d-hlnode' points='"+(e+w*c).toString()+", "+(t+S*c).toString()+","+(e+_*c).toString()+", "+(t+A*c).toString()+","+(e+x*c).toString()+", "+(t+k*c).toString()+","+(e+O*c).toString()+", "+(t+H*c).toString()+"' fill='"+a+"' stroke-width='1' stroke='"+"#000000' />",R+="<text x='"+(e+1).toString()+"' y='"+(t+2).toString()+"' style='fill:#000000; font-size:8; text-anchor:middle' >"+l+"</text>",""!==o&&(R+="<text x='"+(e+1).toString()+"' y='"+(t+2+6).toString()+"' style='fill:"+a+"; font-size:8; font-weight:bold; text-anchor:middle' >"+o+"</text>"),R+="</g>",R}}class De{constructor(e){this.icn3d=e}update2DdgmContent(){let e=this.icn3d;e.icn3dui;let t="";void 0!==e.icn3dui.cfg.mmdbid||void 0!==e.icn3dui.cfg.gi?(t+=e.diagram2dCls.draw2Ddgm(e.interactionData,e.inputid,void 0,!0),t+=e.diagram2dCls.set2DdgmNote(),$("#"+e.pre+"dl_2ddgm").html(t)):e.mmdbidArray&&(void 0!==e.icn3dui.cfg.align||void 0!==e.icn3dui.cfg.chainalign||e.bRealign)&&(t+=e.diagram2dCls.draw2Ddgm(e.interactionData1,e.mmdbidArray[0].toUpperCase(),0,!0),void 0!==e.mmdbid_q&&e.mmdbid_q===e.mmdbid_t?t+=e.diagram2dCls.draw2Ddgm(e.interactionData2,e.mmdbidArray[0].toUpperCase(),1,!0):t+=e.diagram2dCls.draw2Ddgm(e.interactionData2,e.mmdbidArray[1].toUpperCase(),1,!0),t+=e.diagram2dCls.set2DdgmNote(!0),$("#"+e.pre+"dl_2ddgm").html(t))}changeSeqColor(e){let t=this.icn3d;t.icn3dui;for(let s=0,i=e.length;s<i;++s){let i=e[s],l=t.firstAtomObjCls.getFirstCalphaAtomObj(t.residues[i]),n=void 0===l.color||"FFFFFF"===l.color.getHexString().toUpperCase()?"DDDDDD":l.color.getHexString(),o=void 0!==l.color?n:"CCCCCC";$("[id=giseq_"+t.pre+i+"]").attr("style","color:#"+o),$("[id=align_"+t.pre+i+"]").attr("style","color:#"+o),(void 0!==t.icn3dui.cfg.align||void 0!==t.icn3dui.cfg.chainalign||t.bRealign||t.bSymd)&&$("[id=align_"+t.pre+i+"]").attr("style","color:#"+o)}}removeHlAll(){this.icn3d.icn3dui,this.removeHlObjects(),this.removeHlSeq(),this.removeHl2D(),this.removeHlMenus()}removeHlObjects(){let e=this.icn3d;e.icn3dui,e.hlObjectsCls.removeHlObjects()}removeHlSeq(){this.icn3d.icn3dui,this.removeSeqResidueBkgd()}removeHl2D(){let e=this.icn3d;e.icn3dui,$("#"+e.pre+"dl_2ddgm rect").attr("stroke","#000000"),$("#"+e.pre+"dl_2ddgm circle").attr("stroke","#000000"),$("#"+e.pre+"dl_2ddgm polygon").attr("stroke","#000000"),$("#"+e.pre+"dl_2ddgm svg line").attr("stroke","#000000"),$("#"+e.pre+"dl_2ddgm rect").attr("stroke-width",1),$("#"+e.pre+"dl_2ddgm circle").attr("stroke-width",1),$("#"+e.pre+"dl_2ddgm polygon").attr("stroke-width",1),$("#"+e.pre+"dl_2ddgm line").attr("stroke-width",1)}removeHlMenus(){let e=this.icn3d;e.icn3dui,$("#"+e.pre+"atomsCustom").val(""),$("#"+e.pre+"atomsCustom")[0].blur()}updateHlAll(e,t,s,i){let l=this.icn3d,n=l.icn3dui;l.prevHighlightAtoms=n.hashUtilsCls.cloneHash(l.hAtoms),this.updateHlObjects(i),void 0!==e?this.updateHlSeqInChain(e,s):this.updateHlSeq(void 0,void 0,s),this.updateHl2D(),(void 0===t||t)&&this.updateHlMenus(e)}updateHlObjects(e){let t=this.icn3d;t.icn3dui,t.hlObjectsCls.removeHlObjects(),(t.hAtoms&&Object.keys(t.hAtoms).length<Object.keys(t.atoms).length||e)&&(t.hlObjectsCls.addHlObjects(),t.definedSetsCls.setMode("selection"))}updateHlSeq(e,t,s){let i=this.icn3d;i.icn3dui,void 0!==s&&s||this.removeHlSeq(),void 0===t&&(t=i.firstAtomObjCls.getResiduesFromCalphaAtoms(i.hAtoms)),i.hAtoms&&Object.keys(i.hAtoms).length<Object.keys(i.atoms).length&&this.hlSequence(Object.keys(t)),this.changeSeqColor(Object.keys(t))}updateHlSeqInChain(e,t){let s=this.icn3d;if(s.icn3dui,void 0!==t&&t||this.removeHlSeq(),!s.hAtoms||Object.keys(s.hAtoms).length!=Object.keys(s.atoms).length)for(let t=0,i=e.length;t<i;++t){let i=e[t];if(-1!==Object.keys(s.chains).indexOf(i))this.hlSeqInChain(i);else{let e=[];void 0!==s.defNames2Residues[i]&&s.defNames2Residues[i].length>0&&(e=s.defNames2Residues[i]);let t={};if(void 0!==s.defNames2Atoms[i]&&s.defNames2Atoms[i].length>0){for(let e=0,l=s.defNames2Atoms[i].length;e<l;++e){let l=s.defNames2Atoms[i][e],n=s.atoms[l];t[n.structure+"_"+n.chain+"_"+n.resi]=1}e=e.concat(Object.keys(t))}this.hlSequence(e)}}}updateHl2D(e){let t=this.icn3d,s=t.icn3dui;if(this.removeHl2D(),!t.hAtoms||Object.keys(t.hAtoms).length!=Object.keys(t.atoms).length){if(void 0===e){let s=t.firstAtomObjCls.getChainsFromAtoms(t.hAtoms);e=Object.keys(s)}if(void 0!==e)for(let i=0,l=e.length;i<l;++i){let l=s.hashUtilsCls.intHash(t.chains[e[i]],t.hAtoms),n=1*Object.keys(l).length/Object.keys(t.chains[e[i]]).length,o=t.firstAtomObjCls.getFirstCalphaAtomObj(l);if(void 0!==t.alnChains[e[i]]){let n=s.hashUtilsCls.intHash(t.alnChains[e[i]],l);Object.keys(n).length>0&&(o=t.firstAtomObjCls.getFirstCalphaAtomObj(n))}let r=void 0!==o&&void 0!==o.color?"#"+o.color.getHexString():"#FFFFFF",a=$("#"+t.pre+"dl_2ddgm g[chainid="+e[i]+"] rect[class='icn3d-hlnode']"),d=$("#"+t.pre+"dl_2ddgm g[chainid="+e[i]+"] rect[class='icn3d-basenode']");void 0!==a&&(t.diagram2dCls.highlightNode("rect",a,d,n),$(a).attr("fill",r)),a=$("#"+t.pre+"dl_2ddgm g[chainid="+e[i]+"] circle[class='icn3d-hlnode']"),d=$("#"+t.pre+"dl_2ddgm g[chainid="+e[i]+"] circle[class='icn3d-basenode']"),void 0!==a&&(t.diagram2dCls.highlightNode("circle",a,d,n),$(a).attr("fill",r)),a=$("#"+t.pre+"dl_2ddgm g[chainid="+e[i]+"] polygon[class='icn3d-hlnode']"),d=$("#"+t.pre+"dl_2ddgm g[chainid="+e[i]+"] polygon[class='icn3d-basenode']"),void 0!==a&&(t.diagram2dCls.highlightNode("polygon",a,d,n),$(a).attr("fill",r))}if(void 0!==t.lineArray2d)for(let e=0,s=t.lineArray2d.length;e<s;e+=2)$("#"+t.pre+"dl_2ddgm g[chainid1="+t.lineArray2d[e]+"][chainid2="+t.lineArray2d[e+1]+"] line").attr("stroke",t.icn3dui.htmlCls.ORANGE);t.prevHighlightAtoms=s.hashUtilsCls.cloneHash(t.hAtoms),t.definedSetsCls.setMode("selection")}}updateHlMenus(e){let t=this.icn3d;t.icn3dui,void 0===e&&(e=[]);let s=t.definedSetsCls.setAtomMenu(e);$("#"+t.pre+"atomsCustom").length&&($("#"+t.pre+"atomsCustom").html(s),$("#"+t.pre+"atomsCustom")[0].blur())}hlSequence(e){let t=this.icn3d;t.icn3dui;let s={};for(let i=0,l=e.length;i<l;++i){let l=e[i],n=$("[id=giseq_"+t.pre+l+"]");0!==n.length&&n.addClass("icn3d-highlightSeq"),n=$("[id=align_"+t.pre+l+"]"),0!==n.length&&n.addClass("icn3d-highlightSeq");let o=l.lastIndexOf("_");s[l.substr(0,o)]=1}for(let e in s)0!==$("#giseq_summary_"+t.pre+e).length&&$("#giseq_summary_"+t.pre+e).addClass("icn3d-highlightSeqBox")}hlSeqInChain(e){let t=this.icn3d;t.icn3dui;for(let s=0,i=t.chainsSeq[e].length;s<i;++s){let i=e+"_"+t.chainsSeq[e][s].resi;0!==$("#giseq_"+t.pre+i).length&&$("#giseq_"+t.pre+i).addClass("icn3d-highlightSeq"),0!==$("#align_"+t.pre+i).length&&$("#align_"+t.pre+i).addClass("icn3d-highlightSeq")}0!==$("#giseq_summary_"+t.pre+e).length&&$("#giseq_summary_"+t.pre+e).addClass("icn3d-highlightSeqBox")}toggleHighlight(){let e=this.icn3d;e.icn3dui,e.bShowHighlight?(this.clearHighlight(),e.bShowHighlight=!1):(this.showHighlight(),e.bShowHighlight=!0)}clearHighlight(){let e=this.icn3d;e.icn3dui,e.labels.picking=[],e.drawCls.draw(),e.hlObjectsCls.removeHlObjects(),this.removeHl2D(),e.bRender&&e.drawCls.render(),this.removeSeqChainBkgd(),this.removeSeqResidueBkgd(),e.bSelectResidue=!1}showHighlight(){let e=this.icn3d;e.icn3dui,e.hlObjectsCls.addHlObjects(),this.updateHlAll()}highlightChains(e){let t=this.icn3d;t.icn3dui,t.hlObjectsCls.removeHlObjects(),this.removeHl2D(),t.hlObjectsCls.addHlObjects(),this.updateHl2D(e);let s={};for(let i=0,l=e.length;i<l;++i){let l=e[i];for(let e in t.chainsSeq[l]){let i=t.chainsSeq[l][e],n=l+"_"+i.resi;""!==i.name&&"-"!==i.name&&(s[n]=1)}}this.hlSequence(Object.keys(s))}hlSummaryDomain3ddomain(e){if(this.icn3d.icn3dui,void 0!==$(e).attr("domain")){let t=$(e).attr("index"),s=$(e).attr("chain");0!==$("[id^="+s+"_domain_"+t+"]").length&&$("[id^="+s+"_domain_"+t+"]").addClass("icn3d-highlightSeqBox")}if(void 0!==$(e).attr("3ddomain")){let t=$(e).attr("index"),s=$(e).attr("chain");0!==$("[id^="+s+"_3d_domain_"+t+"]").length&&$("[id^="+s+"_3d_domain_"+t+"]").addClass("icn3d-highlightSeqBox")}}removeSeqChainBkgd(e){void 0===e?$(".icn3d-seqTitle").each((function(e){$(this).removeClass("icn3d-highlightSeq"),$(this).removeClass("icn3d-highlightSeqBox")})):$(".icn3d-seqTitle").each((function(t){$(this).attr("chain")!==e&&($(this).removeClass("icn3d-highlightSeq"),$(this).removeClass("icn3d-highlightSeqBox"))}))}removeSeqResidueBkgd(){$(".icn3d-residue").each((function(e){$(this).removeClass("icn3d-highlightSeq")}))}updateHlAll(e,t,s,i){let l=this.icn3d,n=l.icn3dui;l.prevHighlightAtoms=n.hashUtilsCls.cloneHash(l.hAtoms),this.updateHlObjects(i),void 0!==e?this.updateHlSeqInChain(e,s):this.updateHlSeq(void 0,void 0,s),this.updateHl2D(),(void 0===t||t)&&this.updateHlMenus(e)}}class Te{constructor(e){this.icn3d=e}selectAll(){let e=this.icn3d;e.icn3dui,this.selectAll_base(),e.hlObjectsCls.removeHlObjects(),e.hlUpdateCls.removeHl2D(),e.hlUpdateCls.removeHlMenus(),e.bSelectResidue=!1,e.bSelectAlignResidue=!1,e.hlUpdateCls.removeSeqResidueBkgd(),e.hlUpdateCls.update2DdgmContent(),$("#"+e.pre+"dl_annotations > .icn3d-annotation").show(),e.definedSetsCls.setMode("all");let t=e.molTitle.length>40?e.molTitle.substr(0,40)+"...":e.molTitle;$("#"+e.pre+"title").html(t)}selectAll_base(){let e=this.icn3d,t=e.icn3dui;e.hAtoms={},e.dAtoms={};for(let s in e.chains)e.hAtoms=t.hashUtilsCls.unionHash(e.hAtoms,e.chains[s]),e.dAtoms=t.hashUtilsCls.unionHash(e.dAtoms,e.chains[s])}selectAChain(e,t,s,i){let l=this.icn3d,n=l.icn3dui;t=t.replace(/\s/g,"");let o=void 0!==s||s?"select alignChain "+e:"select chain "+e;void 0!==i&&i?(l.hAtoms=n.hashUtilsCls.unionHash(l.hAtoms,l.chains[e]),void 0===l.menuHlHash&&(l.menuHlHash={})):(l.hAtoms={},l.menuHlHash={}),l.menuHlHash[e]=1;let r,a=s?l.alnChainsSeq[e]:l.chainsSeq[e];r=void 0===a?0:a.length;let d={};for(let t=0,s=r;t<s;++t){let s=a[t],i=e+"_"+s.resi,n=s.name;if(""!==n&&"-"!==n){d[i]=1;for(let e in l.residues[i])l.hAtoms[e]=1}}void 0!==l.defNames2Atoms&&l.defNames2Atoms.hasOwnProperty(t)||void 0!==l.defNames2Residues&&l.defNames2Residues.hasOwnProperty(t)||this.addCustomSelection(Object.keys(d),t,t,o,!0);s?l.hlUpdateCls.updateHlAll(void 0,void 0,i,true):l.hlUpdateCls.updateHlAll(Object.keys(l.menuHlHash),void 0,i,true)}selectResidueList(e,t,s,i,l,n){let o=this.icn3d;if(o.icn3dui,void 0!==e&&Object.keys(e).length>0){if(void 0!==i&&i?void 0===o.menuHlHash&&(o.menuHlHash={}):(o.hAtoms={},o.menuHlHash={}),n)for(let t in e)o.hAtoms[t]=1;else for(let t in e)for(let e in o.residues[t])o.hAtoms[e]=1;let r,a;t=t.replace(/\s/g,""),o.menuHlHash[t]=1,n?(r="select "+o.resid2specCls.atoms2spec(o.hAtoms),a=!1):(r="select "+o.resid2specCls.residueids2spec(Object.keys(e)),a=!0);let d=Object.keys(e);this.addCustomSelection(d,t,s,r,a),(void 0===l||l)&&o.hlUpdateCls.updateHlAll(Object.keys(o.menuHlHash),void 0,i)}}selectMainChains(){let e=this.icn3d,t=e.icn3dui.hashUtilsCls.cloneHash(e.hAtoms);e.hAtoms=e.applyDisplayCls.selectMainChainSubset(t),e.hlUpdateCls.showHighlight()}selectSideChains(){let e=this.icn3d,t=e.icn3dui.hashUtilsCls.cloneHash(e.hAtoms),s=["C1'","C1*","C2'","C2*","C3'","C3*","C4'","C4*","C5'","C5*","O3'","O3*","O4'","O4*","O5'","O5*","P","OP1","O1P","OP2","O2P"];e.hAtoms={};for(let i in t)(e.proteins.hasOwnProperty(i)&&"N"!==e.atoms[i].name&&"C"!==e.atoms[i].name&&"O"!==e.atoms[i].name&&("CA"!==e.atoms[i].name||"C"!==e.atoms[i].elem)||e.nucleotides.hasOwnProperty(i)&&-1===s.indexOf(e.atoms[i].name))&&(e.hAtoms[i]=1);e.hlUpdateCls.showHighlight()}selectMainSideChains(){let e=this.icn3d,t=e.icn3dui,s=e.firstAtomObjCls.getResiduesFromAtoms(e.hAtoms);e.hAtoms={};for(let i in s)e.hAtoms=t.hashUtilsCls.unionHash(e.hAtoms,e.residues[i]),e.dAtoms=t.hashUtilsCls.unionHash(e.dAtoms,e.residues[i]);e.drawCls.draw(),e.hlUpdateCls.showHighlight()}clickShow_selected(){let e=this.icn3d,t=e.icn3dui,s=this;t.myEventCls.onIds(["#"+e.pre+"show_selected","#"+e.pre+"mn2_show_selected"],"click",(function(e){let t=s.icn3d;s.showSelection(),t.icn3dui.htmlCls.clickMenuCls.setLogCmd("show selection",!0)}))}clickHide_selected(){let e=this.icn3d,t=e.icn3dui,s=this;t.myEventCls.onIds("#"+e.pre+"mn2_hide_selected","click",(function(e){let t=s.icn3d;s.hideSelection(),t.icn3dui.htmlCls.clickMenuCls.setLogCmd("hide selection",!0)}))}getGraphDataForDisplayed(){let e=this.icn3d;e.icn3dui;let t=JSON.parse(e.graphStr),s=e.firstAtomObjCls.getResiduesFromAtoms(e.dAtoms),i=[],l=[],n={};for(let e=0,l=t.nodes.length;e<l;++e){let l=t.nodes[e],o=l.r.substr(4);s.hasOwnProperty(o)&&(i.push(l),n[l.id]=1)}for(let e=0,s=t.links.length;e<s;++e){let s=t.links[e];n.hasOwnProperty(s.source)&&n.hasOwnProperty(s.target)&&l.push(s)}return t.nodes=i,t.links=l,e.graphStr=JSON.stringify(t),e.graphStr}updateSelectionNameDesc(){let e=this.icn3d;e.icn3dui;let t=Object.keys(e.defNames2Residues).length+Object.keys(e.defNames2Atoms).length;$("#"+e.pre+"seq_command_name").val("seq_"+t),$("#"+e.pre+"seq_command_name2").val("seq_"+t),$("#"+e.pre+"alignseq_command_name").val("alseq_"+t)}addCustomSelection(e,t,s,i,l){let n=this.icn3d;n.icn3dui,l?n.defNames2Residues[t]=e:n.defNames2Atoms[t]=e,n.defNames2Command[t]=i,n.defNames2Descr[t]=s,n.hlUpdateCls.updateHlMenus([t])}showSelection(){let e=this.icn3d,t=e.icn3dui;e.dAtoms={},0==Object.keys(e.hAtoms).length&&this.selectAll_base(),e.dAtoms=t.hashUtilsCls.cloneHash(e.hAtoms);let s=e.applyCenterCls.centerAtoms(t.hashUtilsCls.hash2Atoms(e.dAtoms,e.atoms));e.maxD=s.maxD,e.maxD<5&&(e.maxD=5),e.opts.rotationcenter="display center",this.saveSelectionIfSelected(),e.drawCls.draw(),e.hlUpdateCls.update2DdgmContent(),e.hlUpdateCls.updateHl2D(),e.annotationCls.showAnnoSelectedChains(),void 0!==e.graphStr&&(e.graphStr=this.getGraphDataForDisplayed()),e.bGraph&&e.drawGraphCls.drawGraph(e.graphStr,e.pre+"dl_graph"),e.bLinegraph&&e.lineGraphCls.drawLineGraph(e.graphStr),e.bScatterplot&&e.lineGraphCls.drawLineGraph(e.graphStr,!0)}hideSelection(){let e=this.icn3d,t=e.icn3dui;e.dAtoms=t.hashUtilsCls.exclHash(e.dAtoms,e.hAtoms),e.hAtoms=t.hashUtilsCls.cloneHash(e.dAtoms);let s=e.applyCenterCls.centerAtoms(t.hashUtilsCls.hash2Atoms(e.dAtoms,e.atoms));e.maxD=s.maxD,e.maxD<5&&(e.maxD=5),e.opts.rotationcenter="display center",this.saveSelectionIfSelected(),e.drawCls.draw(),e.hlUpdateCls.update2DdgmContent(),e.hlUpdateCls.updateHl2D(),e.annotationCls.showAnnoSelectedChains()}saveSelection(e,t){let s=this.icn3d;if(s.icn3dui,s.selectedResidues={},s.selectedResidues=s.firstAtomObjCls.getResiduesFromCalphaAtoms(s.hAtoms),Object.keys(s.selectedResidues).length>0)if(1==s.pk){let i=!0;this.selectResidueList(s.hAtoms,e,t,void 0,void 0,i),this.updateSelectionNameDesc(),s.icn3dui.htmlCls.clickMenuCls.setLogCmd("select "+s.resid2specCls.atoms2spec(s.hAtoms)+" | name "+e,!0)}else this.selectResidueList(s.selectedResidues,e,t),this.updateSelectionNameDesc(),s.icn3dui.htmlCls.clickMenuCls.setLogCmd("select "+s.resid2specCls.residueids2spec(Object.keys(s.selectedResidues))+" | name "+e,!0)}removeSelection(){let e=this.icn3d;e.icn3dui,e.bAnnotations||e.hlUpdateCls.removeSeqChainBkgd(),e.bCtrl||e.bShift||(e.hlUpdateCls.removeSeqResidueBkgd(),e.hlUpdateCls.removeSeqChainBkgd()),e.selectedResidues={},e.bSelectResidue=!1,e.hAtoms={},e.hlObjectsCls.removeHlObjects(),e.hlUpdateCls.removeHl2D()}resetAll(){let e=this.icn3d;e.icn3dui,e.maxD=e.oriMaxD,e.center=e.oriCenter.clone(),e.reinitAfterLoad(),e.loadScriptCls.renderFinalStep(1),e.definedSetsCls.setMode("all"),e.icn3dui.htmlCls.clickMenuCls.setLogCmd("reset",!0),e.hlUpdateCls.removeSeqChainBkgd(),e.hlUpdateCls.removeSeqResidueBkgd(),e.hlUpdateCls.removeHl2D(),e.hlUpdateCls.removeHlMenus()}loadSelection(e){let t=this.icn3d;t.icn3dui;let s=e.trim().split("\n");for(let e=0,i=s.length;e<i;++e){let i=s[e].split("\t"),l=i[0],n=i[1],o=n.indexOf(" ");t.selByCommCls.selectByCommand(n.substr(o+1),l,l),t.icn3dui.htmlCls.clickMenuCls.setLogCmd("select "+n.substr(o+1)+" | name "+l,!0)}}oneStructurePerWindow(){let e=this.icn3d,t=e.icn3dui,s=Object.keys(e.structures);if(e.icn3dui.cfg.bSidebyside&&2==s.length){let i=s[Object.keys(window.icn3duiHash).indexOf(e.divid)],l=e.structures[i],n={};for(let s=0,i=l.length;s<i;++s)n=t.hashUtilsCls.unionHash(n,e.chains[l[s]]);e.dAtoms=t.hashUtilsCls.intHash(n,e.dAtoms),e.hAtoms=t.hashUtilsCls.cloneHash(e.dAtoms)}}showAll(){var e=this.icn3d,t=e.icn3dui;e.dAtoms=t.hashUtilsCls.cloneHash(e.atoms),e.maxD=e.oriMaxD,e.drawCls.draw()}saveSelectionIfSelected(e,t){var s=this.icn3d;if(s.icn3dui,s.bSelectResidue||s.bSelectAlignResidue){let e=$("#"+s.pre+"seq_command_name2").val().replace(/\s+/g,"_");""===e&&(e=$("#"+s.pre+"alignseq_command_name").val().replace(/\s+/g,"_")),""!==e&&this.saveSelection(e,e),s.bSelectResidue=!1,s.bSelectAlignResidue=!1}}saveSelectionPrep(){var e=this.icn3d;e.icn3dui,e.icn3dui.cfg.notebook?($("#"+e.pre+"dl_definedsets").show(),$("#"+e.pre+"atomsCustom").resizable()):$("#"+e.pre+"dl_definedsets").hasClass("ui-dialog-content")&&$("#"+e.pre+"dl_definedsets").dialog("isOpen")||(e.icn3dui.htmlCls.dialogCls.openDlg("dl_definedsets","Select sets"),$("#"+e.pre+"atomsCustom").resizable()),e.bSelectResidue=!1,e.bSelectAlignResidue=!1}selectOneResid(e,t){var s=this.icn3d;s.icn3dui;let i=e.indexOf("$"),l=e.indexOf("."),n=e.indexOf(":"),o=e.indexOf("@");-1==o&&(o=e.length);let r=e.substr(i+1,l-i-1),a=e.substr(l+1,n-l-1),d=e.substr(n+1,o-n-1),c=r+"_"+a+"_"+d;for(let e in s.residues[c])t?delete s.hAtoms[e]:s.hAtoms[e]=1;return t?delete s.selectedResidues[c]:s.selectedResidues[c]=1,"$"+r+"."+a+":"+d}toggleSelection(){var e=this.icn3d,t=e.icn3dui;if(e.bHideSelection){for(let t in e.dAtoms)e.hAtoms.hasOwnProperty(t)&&delete e.dAtoms[t];e.bHideSelection=!1}else e.dAtoms=t.hashUtilsCls.unionHash(e.dAtoms,e.hAtoms),e.bHideSelection=!0;e.drawCls.draw()}toggleMembrane(){var e=this.icn3d,t=e.icn3dui;let s=Object.keys(e.structures);for(let i=0,l=s.length;i<l;++i){let l=s[i],n=e.residues[l+"_MEM_1"],o=e.firstAtomObjCls.getFirstAtomObj(n);if(void 0===o)continue;let r=o.style;e.dAtoms.hasOwnProperty(o.serial)||(e.dAtoms=t.hashUtilsCls.unionHash(e.dAtoms,n),r="nothing");for(let t in n){let s=e.atoms[t];s.style="nothing"!==r?"nothing":"stick"}}e.drawCls.draw()}adjustMembrane(e,t){var s=this.icn3d;s.icn3dui;for(let i in s.chains[s.inputid.toUpperCase()+"_MEM"]){let l=s.atoms[i];"O"==l.name?l.coord.z=e:"N"==l.name&&(l.coord.z=t)}s.definedSetsCls.setTransmemInMenu(e,t,!0),s.hlUpdateCls.updateHlMenus(),s.drawCls.draw()}selectBtwPlanes(e,t){var s=this.icn3d;if(s.icn3dui,e<t){let s=t;t=e,e=s}let i={};for(let l in s.atoms){let n=s.atoms[l];if("DUM"!=n.resn&&(n.coord.z>=t&&n.coord.z<=e)){i[n.structure+"_"+n.chain+"_"+n.resi]=1}}let l="z_planes_"+e+"_"+t,n=l;this.selectResidueList(i,l,n,!1)}}class Pe{constructor(e){this.icn3d=e}setOption(e,t){var s=this.icn3d;if(s.icn3dui,s.opts[e]=t,s.selectionCls.saveSelectionIfSelected(),"color"===e){s.setColorCls.setColorByOptions(s.opts,s.hAtoms),s.drawCls.draw();let e=s.firstAtomObjCls.getResiduesFromCalphaAtoms(s.hAtoms);s.hlUpdateCls.changeSeqColor(Object.keys(e)),s.getGraphCls.updateGraphColor()}else"surface"===e||"opacity"===e||"wireframe"===e?("opacity"!==e&&"wireframe"!==e||s.applyMapCls.removeLastSurface(),s.applyMapCls.applySurfaceOptions(),s.drawCls.draw()):"map"===e||"mapwireframe"===e?("mapwireframe"===e&&s.applyMapCls.removeLastMap(),s.applyMapCls.applyMapOptions(),s.drawCls.draw()):"emmap"===e||"emmapwireframe"===e?("emmapwireframe"===e&&s.applyMapCls.removeLastEmmap(),s.applyMapCls.applyEmmapOptions(),s.drawCls.draw()):"phimap"===e||"phimapwireframe"===e?("phimapwireframe"===e&&s.applyMapCls.removeLastPhimap(),s.applyMapCls.applyPhimapOptions(),s.drawCls.draw()):"phisurface"===e?(s.applyMapCls.applyphisurfaceOptions(),s.drawCls.draw()):"chemicalbinding"===e?(s.bSkipChemicalbinding=!1,s.drawCls.draw()):s.drawCls.draw()}setStyle(e,t){var s=this.icn3d,i=s.icn3dui;let l={};switch(e){case"proteins":l=i.hashUtilsCls.intHash(s.hAtoms,s.proteins),Object.keys(s.hAtoms).length,Object.keys(s.proteins).length;break;case"sidec":l=i.hashUtilsCls.intHash(s.hAtoms,s.sidec);break;case"nucleotides":l=i.hashUtilsCls.intHash(s.hAtoms,s.nucleotides),Object.keys(s.hAtoms).length,Object.keys(s.nucleotides).length;break;case"chemicals":l=i.hashUtilsCls.intHash(s.hAtoms,s.chemicals);break;case"ions":l=i.hashUtilsCls.intHash(s.hAtoms,s.ions);break;case"water":l=i.hashUtilsCls.intHash(s.hAtoms,s.water)}if("sidec"===e)for(let e in l)s.atoms[e].style2=t;else for(let e in l)s.atoms[e].style=t;s.opts[e]=t,s.selectionCls.saveSelectionIfSelected(),s.drawCls.draw()}saveStyle(){var e=this.icn3d;e.icn3dui;for(let t in e.atoms){let s=e.atoms[t];s.styleSave=s.style,void 0!==s.style2&&(s.style2Save=s.style2)}}applySavedStyle(){var e=this.icn3d;e.icn3dui;for(let t in e.atoms){let s=e.atoms[t];void 0!==s.styleSave&&(s.style=s.styleSave),void 0!==s.style2Save&&(s.style2=s.style2Save)}e.drawCls.draw()}saveColor(){var e=this.icn3d;e.icn3dui;for(let t in e.atoms){let s=e.atoms[t];s.colorSave=s.color.clone()}}applySavedColor(){var e=this.icn3d;e.icn3dui;for(let t in e.atoms){let s=e.atoms[t];void 0!==s.colorSave&&(s.color=s.colorSave.clone())}e.drawCls.draw(),e.hlUpdateCls.changeSeqColor(Object.keys(e.residues))}}class Fe{constructor(e){this.icn3d=e}setStyle2Atoms(e){let t=this.icn3d;t.icn3dui,t.style2atoms={};for(let s in e)void 0===t.style2atoms[t.atoms[s].style]&&(t.style2atoms[t.atoms[s].style]={}),t.style2atoms[t.atoms[s].style][s]=1,void 0!==t.atoms[s].style2&&"nothing"!==t.atoms[s].style2&&(void 0===t.style2atoms[t.atoms[s].style2]&&(t.style2atoms[t.atoms[s].style2]={}),t.style2atoms[t.atoms[s].style2][s]=1)}setAtomStyleByOptions(e){let t,s=this.icn3d,i=s.icn3dui;if(void 0===e&&(e=s.opts),void 0!==e.proteins){t=i.hashUtilsCls.intHash(s.hAtoms,s.proteins);for(let i in t)s.atoms[i].style=e.proteins.toLowerCase()}if(void 0!==e.sidec&&"nothing"!==e.sidec){t=i.hashUtilsCls.intHash(s.hAtoms,s.sidec);for(let i in t)s.atoms[i].style2=e.sidec.toLowerCase()}if(void 0!==e.chemicals){t=i.hashUtilsCls.intHash(s.hAtoms,s.chemicals);for(let i in t)s.atoms[i].style=e.chemicals.toLowerCase()}if(void 0!==e.ions){t=i.hashUtilsCls.intHash(s.hAtoms,s.ions);for(let i in t)s.atoms[i].style=e.ions.toLowerCase()}if(void 0!==e.water){t=i.hashUtilsCls.intHash(s.hAtoms,s.water);for(let i in t)s.atoms[i].style=e.water.toLowerCase()}if(void 0!==e.nucleotides){t=i.hashUtilsCls.intHash(s.hAtoms,s.nucleotides);for(let i in t)s.atoms[i].style=e.nucleotides.toLowerCase()}}setBackground(e){var t=this.icn3d;t.icn3dui,t.setOptionCls.setOption("background",e),t.icn3dui.htmlCls.clickMenuCls.setLogCmd("set background "+e,!0);let s="black"==e||"transparent"==e?t.icn3dui.htmlCls.GREYD:"black";$("#"+t.pre+"title").css("color",s),$("#"+t.pre+"titlelink").css("color",s)}saveCommandsToSession(){var e=this.icn3d;e.icn3dui;let t=e.commands.join("\n"),s=decodeURIComponent(t);sessionStorage.setItem("commands",s)}getCommandsBeforeCrash(){var e=this.icn3d,t=e.icn3dui;window.addEventListener("load",(function(){sessionStorage.setItem("good_exit","pending")})),window.addEventListener("beforeunload",(function(){sessionStorage.setItem("good_exit","true")})),sessionStorage.getItem("good_exit")&&"pending"===sessionStorage.getItem("good_exit")&&(t.utilsCls.isMac()||(e.bCrashed=!0),e.commandsBeforeCrash=sessionStorage.getItem("commands"),e.commandsBeforeCrash||(e.commandsBeforeCrash=""))}handleContextLost(){var e=this.icn3d;e.icn3dui;let t=$("#"+e.pre+"canvas")[0];t.addEventListener("webglcontextlost",(function(e){e.preventDefault()}),!1),t.addEventListener("webglcontextrestored",(function(t){console.log("WebGL context was lost. Reset WebGLRenderer and launch iCn3D again."),e.renderer=new THREE.WebGLRenderer({canvas:e.container.get(0),antialias:!0,preserveDrawingBuffer:!0,alpha:!0}),e.drawCls.draw()}),!1)}adjustIcon(){var e=this.icn3d;e.icn3dui,1===e.STATENUMBER?$("#"+e.pre+"back").hasClass("icn3d-middleIcon")&&($("#"+e.pre+"back").toggleClass("icn3d-middleIcon"),$("#"+e.pre+"back").toggleClass("icn3d-endIcon")):$("#"+e.pre+"back").hasClass("icn3d-endIcon")&&($("#"+e.pre+"back").toggleClass("icn3d-middleIcon"),$("#"+e.pre+"back").toggleClass("icn3d-endIcon")),e.STATENUMBER===e.commands.length?$("#"+e.pre+"forward").hasClass("icn3d-middleIcon")&&($("#"+e.pre+"forward").toggleClass("icn3d-middleIcon"),$("#"+e.pre+"forward").toggleClass("icn3d-endIcon")):$("#"+e.pre+"forward").hasClass("icn3d-endIcon")&&($("#"+e.pre+"forward").toggleClass("icn3d-middleIcon"),$("#"+e.pre+"forward").toggleClass("icn3d-endIcon"))}}class Me{constructor(e){this.icn3d=e}createStickRepresentation(e,t,s,i,l,n){let o=this.icn3d;if(o.icn3dui,o.icn3dui.bNode)return;let r=void 0!==n&&n?t/o.cylinderRadius:1;o.reprSubCls.createRepresentationSub(e,(function(e){o.sphereCls.createSphere(e,t,!i,i,l)}),(function(e,t){let i=e.coord.clone().add(t.coord).multiplyScalar(.5),n=e.serial+"_"+t.serial;if(o.doublebonds.hasOwnProperty(n)){let s,n,a,d,c=new THREE.Vector3(Math.random(),Math.random(),Math.random());if(1==e.bonds.length&&1==t.bonds.length){d=t.coord.clone(),d.sub(e.coord);let s=c.clone();d.cross(s).normalize().multiplyScalar(.2*r)}else{if(e.bonds.length>=t.bonds.length&&e.bonds.length>1)s=e.serial,n=e.bonds[0],a=e.bonds[1];else{if(!(t.bonds.length>=e.bonds.length&&t.bonds.length>1))return void console.log("Double bond was not drawn due to the undefined cross plane");s=t.serial,n=t.bonds[0],a=t.bonds[1]}let i=o.atoms[s].coord.clone();i.sub(o.atoms[n].coord);let l=o.atoms[s].coord.clone();l.sub(o.atoms[a].coord),i.cross(l),0==parseInt(1e4*i.length())&&(i=new THREE.Vector3(.2,.3,.5)),d=t.coord.clone(),d.sub(e.coord),d.cross(i).normalize().multiplyScalar(.2*r),0==parseInt(1e4*d.length())&&(i=new THREE.Vector3(.5,.3,.2),d.cross(i).normalize().multiplyScalar(.2*r))}e.color===t.color?o.dAtoms.hasOwnProperty(e.serial)&&o.dAtoms.hasOwnProperty(t.serial)&&(o.cylinderCls.createCylinder(e.coord.clone().add(d),t.coord.clone().add(d),o.cylinderRadius*r*.3,e.color,l),o.cylinderCls.createCylinder(e.coord.clone().sub(d),t.coord.clone().sub(d),o.cylinderRadius*r*.3,e.color,l)):o.bImpo?o.dAtoms.hasOwnProperty(e.serial)&&o.dAtoms.hasOwnProperty(t.serial)&&(o.cylinderCls.createCylinder(e.coord.clone().add(d),t.coord.clone().add(d),o.cylinderRadius*r*.3,e.color,l,t.color),o.cylinderCls.createCylinder(e.coord.clone().sub(d),t.coord.clone().sub(d),o.cylinderRadius*r*.3,e.color,l,t.color)):o.dAtoms.hasOwnProperty(e.serial)&&o.dAtoms.hasOwnProperty(t.serial)&&(o.cylinderCls.createCylinder(e.coord.clone().add(d),i.clone().add(d),o.cylinderRadius*r*.3,e.color,l),o.cylinderCls.createCylinder(t.coord.clone().add(d),i.clone().add(d),o.cylinderRadius*r*.3,t.color,l),o.cylinderCls.createCylinder(e.coord.clone().sub(d),i.clone().sub(d),o.cylinderRadius*r*.3,e.color,l),o.cylinderCls.createCylinder(t.coord.clone().sub(d),i.clone().sub(d),o.cylinderRadius*r*.3,t.color,l))}else if(o.aromaticbonds.hasOwnProperty(n)){let s,n,a;if(e.bonds.length>t.bonds.length&&e.bonds.length>1)s=e.serial,n=e.bonds[0],a=e.bonds[1];else{if(!(t.bonds.length>1))return;s=t.serial,n=t.bonds[0],a=t.bonds[1]}let d=o.atoms[s].coord.clone();d.sub(o.atoms[n].coord);let c=o.atoms[s].coord.clone();c.sub(o.atoms[a].coord),d.cross(c);let h=t.coord.clone();h.sub(e.coord),h.cross(d).normalize().multiplyScalar(.2*r);let m=0;for(let s=0,i=e.bondOrder.length;s<i;++s)"1.5"===e.bondOrder[s]&&e.bonds[s]!==t.serial&&(m=e.bonds[s]);let p="add";if(0===m)p="add";else{let s=e.coord.clone().add(h),i=e.coord.clone().sub(h),l=t.coord.clone().sub(s).normalize(),n=o.atoms[m].coord.clone().sub(s).normalize(),r=t.coord.clone().sub(i).normalize(),a=o.atoms[m].coord.clone().sub(i).normalize();p=Math.acos(l.dot(n))<Math.acos(r.dot(a))?"sub":"add"}if(e.color===t.color){let s,i;"add"===p?(o.cylinderCls.createCylinder(e.coord.clone().sub(h),t.coord.clone().sub(h),o.cylinderRadius*r*.3,e.color,l),s=e.coord.clone().add(h),i=t.coord.clone().add(h).sub(s).multiplyScalar(1/11)):(o.cylinderCls.createCylinder(e.coord.clone().add(h),t.coord.clone().add(h),o.cylinderRadius*r*.3,e.color,l),s=e.coord.clone().sub(h),i=t.coord.clone().sub(h).sub(s).multiplyScalar(1/11));for(let t=0;t<=10;++t)if(t%2==0){let n=s.clone().add(i.clone().multiplyScalar(t)),a=s.clone().add(i.clone().multiplyScalar(t+1));o.cylinderCls.createCylinder(n,a,o.cylinderRadius*r*.3,e.color,l)}}else{let s,n;"add"===p?(o.dAtoms.hasOwnProperty(e.serial)&&o.dAtoms.hasOwnProperty(t.serial)&&(o.cylinderCls.createCylinder(e.coord.clone().sub(h),i.clone().sub(h),o.cylinderRadius*r*.3,e.color,l),o.cylinderCls.createCylinder(t.coord.clone().sub(h),i.clone().sub(h),o.cylinderRadius*r*.3,t.color,l)),s=e.coord.clone().add(h),n=t.coord.clone().add(h).sub(s).multiplyScalar(1/11)):(o.dAtoms.hasOwnProperty(e.serial)&&o.dAtoms.hasOwnProperty(t.serial)&&(o.cylinderCls.createCylinder(e.coord.clone().add(h),i.clone().add(h),o.cylinderRadius*r*.3,e.color,l),o.cylinderCls.createCylinder(t.coord.clone().add(h),i.clone().add(h),o.cylinderRadius*r*.3,t.color,l)),s=e.coord.clone().sub(h),n=t.coord.clone().sub(h).sub(s).multiplyScalar(1/11));for(let i=0;i<=10;++i)if(i%2==0&&o.dAtoms.hasOwnProperty(e.serial)&&o.dAtoms.hasOwnProperty(t.serial)){let a=s.clone().add(n.clone().multiplyScalar(i)),d=s.clone().add(n.clone().multiplyScalar(i+1));i<5?o.cylinderCls.createCylinder(a,d,o.cylinderRadius*r*.3,e.color,l):o.cylinderCls.createCylinder(a,d,o.cylinderRadius*r*.3,t.color,l)}}}else if(o.triplebonds.hasOwnProperty(n)){let s=new THREE.Vector3(Math.random(),Math.random(),Math.random()),n=t.coord.clone();n.sub(e.coord);let a=s.clone();a.cross(n).normalize().multiplyScalar(.3*r),e.color===t.color?o.dAtoms.hasOwnProperty(e.serial)&&o.dAtoms.hasOwnProperty(t.serial)&&(o.cylinderCls.createCylinder(e.coord,t.coord,o.cylinderRadius*r*.2,e.color,l),o.cylinderCls.createCylinder(e.coord.clone().add(a),t.coord.clone().add(a),o.cylinderRadius*r*.2,e.color,l),o.cylinderCls.createCylinder(e.coord.clone().sub(a),t.coord.clone().sub(a),o.cylinderRadius*r*.2,e.color,l)):o.bImpo?o.dAtoms.hasOwnProperty(e.serial)&&o.dAtoms.hasOwnProperty(t.serial)&&(o.cylinderCls.createCylinder(e.coord,t.coord,o.cylinderRadius*r*.2,e.color,l,t.color),o.cylinderCls.createCylinder(e.coord.clone().add(a),t.coord.clone().add(a),o.cylinderRadius*r*.2,e.color,l,t.color),o.cylinderCls.createCylinder(e.coord.clone().sub(a),t.coord.clone().sub(a),o.cylinderRadius*r*.2,e.color,l,t.color)):o.dAtoms.hasOwnProperty(e.serial)&&o.dAtoms.hasOwnProperty(t.serial)&&(o.cylinderCls.createCylinder(e.coord,i,o.cylinderRadius*r*.2,e.color,l),o.cylinderCls.createCylinder(t.coord,i,o.cylinderRadius*r*.2,t.color,l),o.cylinderCls.createCylinder(e.coord.clone().add(a),i.clone().add(a),o.cylinderRadius*r*.2,e.color,l),o.cylinderCls.createCylinder(t.coord.clone().add(a),i.clone().add(a),o.cylinderRadius*r*.2,t.color,l),o.cylinderCls.createCylinder(e.coord.clone().sub(a),i.clone().sub(a),o.cylinderRadius*r*.2,e.color,l),o.cylinderCls.createCylinder(t.coord.clone().sub(a),i.clone().sub(a),o.cylinderRadius*r*.2,t.color,l))}else e.color===t.color?o.cylinderCls.createCylinder(e.coord,t.coord,s,e.color,l):o.bImpo?o.dAtoms.hasOwnProperty(e.serial)&&o.dAtoms.hasOwnProperty(t.serial)&&o.cylinderCls.createCylinder(e.coord,t.coord,s,e.color,l,t.color):o.dAtoms.hasOwnProperty(e.serial)&&o.dAtoms.hasOwnProperty(t.serial)&&(o.cylinderCls.createCylinder(e.coord,i,s,e.color,l),o.cylinderCls.createCylinder(t.coord,i,s,t.color,l))}))}}class Le{constructor(e){this.icn3d=e}drawCartoonNucleicAcid(e,t,s,i){this.drawStrandNucleicAcid(e,2,t,!0,void 0,s,i)}drawStrandNucleicAcid(e,t,s,i,l,n,o){let r,a,d,c=this.icn3d;if(c.icn3dui,c.icn3dui.bNode)return;2===o&&(t=void 0,n=void 0),l=l||c.nucleicAcidWidth,s=s||c.axisDIV,t=t||c.nucleicAcidStrandDIV;let h=[];for(d=0;d<t;d++)h[d]=[];let m,p,u,C=[],g=null;for(r in e){let f=e[r];if(void 0!==f&&(("O3'"===f.name||"OP2"===f.name||"O3*"===f.name||"O2P"===f.name)&&!f.het))if("O3'"===f.name||"O3*"===f.name){if(m!==f.chain||parseInt(p)+1!==parseInt(f.resi)){if(u&&g)for(a=0;a<t;a++){let e=2/(t-1)*a-1;h[a].push(new THREE.Vector3(u.x+g.x*e,u.y+g.y*e,u.z+g.z*e))}for(i&&c.stripCls.createStrip(h[0],h[1],C,s,n,o),a=0;!n&&a<t;a++)c.curveCls.createCurveSub(h[a],1,C,s,o);for(h=[],d=0;d<t;d++)h[d]=[];C=[],g=null}u=new THREE.Vector3(f.coord.x,f.coord.y,f.coord.z),m=f.chain,p=f.resi,1===o||2===o?C.push(c.hColor):C.push(f.color)}else if("OP2"===f.name||"O2P"===f.name){if(!u){g=null;continue}let e=new THREE.Vector3(f.coord.x,f.coord.y,f.coord.z);for(e.sub(u),e.normalize().multiplyScalar(l),null!==g&&e.dot(g)<0&&e.negate(),g=e,a=0;a<t;a++){let e=2/(t-1)*a-1;h[a].push(new THREE.Vector3(u.x+g.x*e,u.y+g.y*e,u.z+g.z*e))}u=null}}if(u&&g)for(a=0;a<t;a++){let e=2/(t-1)*a-1;h[a].push(new THREE.Vector3(u.x+g.x*e,u.y+g.y*e,u.z+g.z*e))}for(i&&c.stripCls.createStrip(h[0],h[1],C,s,n,o),a=0;!n&&a<t;a++)c.curveCls.createCurveSub(h[a],1,C,s,o)}drawNucleicAcidStick(e,t){let s=this.icn3d;if(s.icn3dui,s.icn3dui.bNode)return;let i,l,n,o=null,r=null;for(n in e){let a=e[n];void 0===a||a.het||(a.resi===l&&a.chain===i||(null!==o&&null!==r&&s.cylinderCls.createCylinder(new THREE.Vector3(o.coord.x,o.coord.y,o.coord.z),new THREE.Vector3(r.coord.x,r.coord.y,r.coord.z),s.cylinderRadius,o.color,t),o=null,r=null),"O3'"!==a.name&&"O3*"!==a.name||(o=a),"  A"===a.resn||"  G"===a.resn||" DA"===a.resn||" DG"===a.resn?"N1"===a.name&&(r=a):"N3"===a.name&&(r=a),l=a.resi,i=a.chain)}null!==o&&null!==r&&s.cylinderCls.createCylinder(new THREE.Vector3(o.coord.x,o.coord.y,o.coord.z),new THREE.Vector3(r.coord.x,r.coord.y,r.coord.z),s.cylinderRadius,o.color,t)}}class Ne{constructor(e){this.icn3d=e}makeTextSprite(e,t){let s=this.icn3d,i=s.icn3dui;if(s.icn3dui.bNode)return;void 0===t&&(t={});let l,n,o,r=t.hasOwnProperty("fontface")?t.fontface:"Arial",a=t.hasOwnProperty("fontsize")?t.fontsize:18,d=t.hasOwnProperty("factor")?t.factor:1,c=t.hasOwnProperty("alpha")?t.alpha:1,h=!0,m=!1;t.hasOwnProperty("bSchematic")&&t.bSchematic&&(m=!0,a=40),t.hasOwnProperty("backgroundColor")&&void 0!==t.backgroundColor?(l=i.utilsCls.hexToRgb(t.backgroundColor,c),n=t.hasOwnProperty("borderColor")?i.utilsCls.hexToRgb(t.borderColor,c):{r:0,g:0,b:0,a:1},o=t.hasOwnProperty("borderThickness")?t.borderThickness:4):(h=!1,l=void 0,n=void 0,o=0);let p=t.hasOwnProperty("textColor")&&void 0!==t.textColor?i.utilsCls.hexToRgb(t.textColor,1):{r:255,g:255,b:0,a:1},u=document.createElement("canvas"),C=u.getContext("2d");C.font="Bold "+a+"px "+r;let g=C.measureText(e).width,f=g+2*o,b=a+2*o;m&&(f>b?b=f:f=b);let y=.8*g/b;if(u.width=f,u.height=b,C.clearRect(0,0,f,b),h)if(C.fillStyle="rgba("+l.r+","+l.g+","+l.b+","+l.a+")",C.strokeStyle="rgba("+n.r+","+n.g+","+n.b+","+n.a+")",C.lineWidth=o,m){let e=.35*f;this.circle(C,0,0,f,b,e)}else{let e=0;this.roundRect(C,0,0,f,b,e)}C.font="Bold "+a+"px "+r,C.textAlign="center",C.textBaseline="middle",C.fillStyle="rgba("+p.r+", "+p.g+", "+p.b+", 1.0)",C.strokeStyle="rgba("+p.r+", "+p.g+", "+p.b+", 1.0)",C.fillText(e,.5*f,.5*b);let v=new THREE.Texture(u);v.needsUpdate=!0;let w=new THREE.SpriteMaterial({map:v,depthTest:!1,depthWrite:!1});w.map.minFilter=THREE.LinearFilter;let S=new THREE.Sprite(w);return m?S.scale.set(.3*d,.3*d,1):S.scale.set(y*d,d,1),S}roundRect(e,t,s,i,l,n){e.beginPath(),e.moveTo(t+n,s),e.lineTo(t+i-n,s),e.quadraticCurveTo(t+i,s,t+i,s+n),e.lineTo(t+i,s+l-n),e.quadraticCurveTo(t+i,s+l,t+i-n,s+l),e.lineTo(t+n,s+l),e.quadraticCurveTo(t,s+l,t,s+l-n),e.lineTo(t,s+n),e.quadraticCurveTo(t,s,t+n,s),e.closePath(),e.fill(),e.stroke()}circle(e,t,s,i,l,n){e.beginPath(),e.arc(t+i/2,s+l/2,n,0,2*Math.PI,!0),e.closePath(),e.fill(),e.stroke()}}class $e{constructor(e){this.icn3d=e,this.textSpriteCls=new Ne(e)}createLabelRepresentation(e){let t=this.icn3d;t.icn3dui;let s=3*t.oriMaxD/100*t.labelScale;for(let i in e){let l=void 0!==e[i]?e[i]:[];for(let e=0,i=l.length;e<i;++e){let i=l[e];0==i.size&&(i.size=void 0),0==i.color&&(i.color=void 0),0==i.background&&(i.background=void 0);let n,o=void 0!==i.size?i.size:t.LABELSIZE,r=void 0!==i.color?i.color:"#ffff00",a=void 0!==i.background?i.background:"#cccccc",d=void 0!==i.alpha?i.alpha:1;if(a=i.background,void 0!==r&&void 0!==a&&r.toLowerCase()===a.toLowerCase()&&(r="#888888"),void 0!==i.bSchematic&&i.bSchematic)n=this.textSpriteCls.makeTextSprite(i.text,{fontsize:parseInt(o),textColor:r,borderColor:a,backgroundColor:a,alpha:d,bSchematic:1,factor:s});else if(1===i.text.length)n=this.textSpriteCls.makeTextSprite(i.text,{fontsize:parseInt(o),textColor:r,borderColor:a,backgroundColor:a,alpha:d,bSchematic:1,factor:s});else{let e=i.factor?s*i.factor:s;n=this.textSpriteCls.makeTextSprite(i.text,{fontsize:parseInt(o),textColor:r,borderColor:a,backgroundColor:a,alpha:d,bSchematic:0,factor:e})}n.position.set(i.position.x,i.position.y,i.position.z),t.mdl.add(n)}}}hideLabels(){let e=this.icn3d;if(e.icn3dui,void 0!==e.mdl)for(let t=0,s=e.mdl.children.length;t<s;++t){let s=e.mdl.children[t];void 0!==s&&"Sprite"===s.type&&e.mdl.remove(s)}}}class Ue{constructor(e){this.icn3d=e}applyDisplayOptions(e,t,s){let i=this.icn3d,l=i.icn3dui;if(void 0===e&&(e=i.opts),!l.bNode&&""!=l.htmlCls.setHtmlCls.getCookie("lineRadius")){let e=parseFloat(l.htmlCls.setHtmlCls.getCookie("lineRadius")),t=parseFloat(l.htmlCls.setHtmlCls.getCookie("coilWidth")),s=parseFloat(l.htmlCls.setHtmlCls.getCookie("cylinderRadius")),n=parseFloat(l.htmlCls.setHtmlCls.getCookie("traceRadius")),o=parseFloat(l.htmlCls.setHtmlCls.getCookie("dotSphereScale")),r=parseFloat(l.htmlCls.setHtmlCls.getCookie("ribbonthickness")),a=parseFloat(l.htmlCls.setHtmlCls.getCookie("helixSheetWidth")),d=parseFloat(l.htmlCls.setHtmlCls.getCookie("nucleicAcidWidth"));i.lineRadius==e&&i.coilWidth==t&&i.cylinderRadius==s&&i.traceRadius==n&&i.dotSphereScale==o&&i.ribbonthickness==r&&i.helixSheetWidth==a&&i.nucleicAcidWidth==d||l.htmlCls.clickMenuCls.setLogCmd("set thickness | linerad "+e+" | coilrad "+t+" | stickrad "+s+" | tracerad "+n+" | ribbonthick "+r+" | proteinwidth "+a+" | nucleotidewidth "+d+" | ballscale "+o,!0),i.lineRadius=e,i.coilWidth=t,i.cylinderRadius=s,i.traceRadius=n,i.dotSphereScale=o,i.ribbonthickness=r,i.helixSheetWidth=a,i.nucleicAcidWidth=d}let n,o={},r={},a={};if(1===s&&Object.keys(t).length<Object.keys(i.atoms).length){a=l.hashUtilsCls.hash2Atoms(t,i.atoms),o=i.firstAtomObjCls.getResiduesFromAtoms(t,i.atoms);for(let e in o){n=e;let t=e.lastIndexOf("_"),s=e.substr(0,t+1),i=e.substr(t+1);if(isNaN(i))continue;let l=parseInt(i),a=s+(l-1).toString();(l+1).toString(),o.hasOwnProperty(a)||o.hasOwnProperty(a)||(r[e]=1)}if(1===Object.keys(a).length&&Object.keys(i.residues[n]).length>1&&"sphere"!==a[Object.keys(a)[0]].style&&"dot"!==a[Object.keys(a)[0]].style){if(void 0===i.bCid||!i.bCid)for(let e in a){let t=a[e],l=1;i.boxCls.createBox(t,void 0,void 0,l,void 0,s)}}else for(let e in r){let n=i.firstAtomObjCls.getFirstCalphaAtomObj(i.residues[e]),o=n,r=o.structure+"_"+o.chain+"_"+(parseInt(o.resi)-1).toString(),a=o.structure+"_"+o.chain+"_"+(parseInt(o.resi)+1).toString();if("cylinder and plate"===o.style&&"helix"===o.ss)for(let t in i.residues[e]){let e=i.atoms[t],l=1;i.boxCls.createBox(e,void 0,void 0,l,void 0,s)}else if("ribbon"===o.style&&"coil"===o.ss||"strand"===o.style&&"coil"===o.ss||"o3 trace"===o.style||"schematic"===o.style||"c alpha trace"===o.style||"b factor tube"===o.style||"cylinder and plate"===o.style&&"helix"!==o.ss){if(void 0!==n&&void 0!==n.style2&&"nothing"!==n.style2)continue;let e=!1;if(!isNaN(o.resi)&&!e&&i.residues.hasOwnProperty(a)){let s=Object.keys(i.residues[a])[0],n=l.hashUtilsCls.hash2Atoms(i.residues[a],i.atoms)[s];if(o.style===n.style&&!n.ssbegin||n.ssbegin){let s=i.residues[a];if(t=l.hashUtilsCls.unionHash(t,s),e=!0,n.ssbegin)for(let e in s)i.atoms[e].notshow=!0}}if(!isNaN(o.resi)&&!e&&i.residues.hasOwnProperty(r)){let s=Object.keys(i.residues[r])[0],n=l.hashUtilsCls.hash2Atoms(i.residues[r],i.atoms)[s];o.style===n.style&&(t=l.hashUtilsCls.unionHash(t,i.residues[r]),e=!0)}}else if("ribbon"===o.style&&"coil"!==o.ss&&o.ssend||"strand"===o.style&&"coil"!==o.ss&&o.ssend){if(void 0!==n&&void 0!==n.style2&&"nothing"!==n.style2)continue;let e=!1;if(!isNaN(o.resi)&&!e&&i.residues.hasOwnProperty(a)){let s=Object.keys(i.residues[a])[0];l.hashUtilsCls.hash2Atoms(i.residues[a],i.atoms)[s],t=l.hashUtilsCls.unionHash(t,i.residues[a]),e=!0}}}a={}}i.setStyleCls.setStyle2Atoms(t),i.bAllAtoms=!1,t&&void 0!==t&&(i.bAllAtoms=Object.keys(t).length===Object.keys(i.atoms).length);let d=.5*i.cylinderRadius;void 0!==i.labels&&delete i.labels.schematic;let c=!1;if(s){let e=i.firstAtomObjCls.getResiduesFromCalphaAtoms(i.hAtoms),t=l.hashUtilsCls.intHash(i.hAtoms,i.proteins),s=i.firstAtomObjCls.getResiduesFromAtoms(t);Object.keys(s)>Object.keys(e)&&(c=!0)}for(let e in i.style2atoms){let t=i.style2atoms[e],n=l.utilsCls.isCalphaPhosOnly(l.hashUtilsCls.hash2Atoms(t,i.atoms));if("ribbon"!==e||s&&(!s||c))if("strand"!==e||s&&(!s||c))if("cylinder and plate"!==e||s&&(!s||c))if("nucleotide cartoon"===e)n?i.cylinderCls.createCylinderCurve(l.hashUtilsCls.hash2Atoms(t,i.atoms),["P"],i.traceRadius,!1,s):(i.cartoonNuclCls.drawCartoonNucleicAcid(l.hashUtilsCls.hash2Atoms(t,i.atoms),null,i.ribbonthickness,s),2!==s&&i.cartoonNuclCls.drawNucleicAcidStick(l.hashUtilsCls.hash2Atoms(t,i.atoms),s));else if("o3 trace"===e)n?i.cylinderCls.createCylinderCurve(l.hashUtilsCls.hash2Atoms(t,i.atoms),["P"],i.traceRadius,!1,s):i.cylinderCls.createCylinderCurve(l.hashUtilsCls.hash2Atoms(t,i.atoms),["O3'","O3*"],i.traceRadius,!1,s);else if("schematic"===e){let e=i.firstAtomObjCls.getFirstAtomObj(t);i.chemicals.hasOwnProperty(e.serial)?(i.residueLabelsCls.addNonCarbonAtomLabels(l.hashUtilsCls.hash2Atoms(t,i.atoms)),bSchematic=!0,i.stickCls.createStickRepresentation(l.hashUtilsCls.hash2Atoms(t,i.atoms),d,d,void 0,s,bSchematic)):(i.residueLabelsCls.addResidueLabels(l.hashUtilsCls.hash2Atoms(t,i.atoms),!0),n?i.cylinderCls.createCylinderCurve(l.hashUtilsCls.hash2Atoms(t,i.atoms),["P"],i.traceRadius,!1,s):i.cylinderCls.createCylinderCurve(l.hashUtilsCls.hash2Atoms(t,i.atoms),["O3'","O3*"],i.traceRadius,!1,s),i.cylinderCls.createCylinderCurve(l.hashUtilsCls.hash2Atoms(t,i.atoms),["CA"],i.traceRadius,!1,s))}else"c alpha trace"===e?i.cylinderCls.createCylinderCurve(l.hashUtilsCls.hash2Atoms(t,i.atoms),["CA"],i.traceRadius,!1,s):"b factor tube"===e?i.tubeCls.createTube(l.hashUtilsCls.hash2Atoms(t,i.atoms),"CA",null,s,!1,!0):"custom tube"===e?i.tubeCls.createTube(l.hashUtilsCls.hash2Atoms(t,i.atoms),"CA",null,s,!0,!0):"lines"===e?(1===s?i.stickCls.createStickRepresentation(l.hashUtilsCls.hash2Atoms(t,i.atoms),i.hlLineRadius,i.hlLineRadius,void 0,s):i.lineCls.createLineRepresentation(l.hashUtilsCls.hash2Atoms(t,i.atoms),s),i.lineCls.createConnCalphSidechain(l.hashUtilsCls.hash2Atoms(t,i.atoms),e)):"stick"===e?(i.stickCls.createStickRepresentation(l.hashUtilsCls.hash2Atoms(t,i.atoms),i.cylinderRadius,i.cylinderRadius,void 0,s,void 0),i.lineCls.createConnCalphSidechain(l.hashUtilsCls.hash2Atoms(t,i.atoms),e)):"backbone"===e?(t=this.selectMainChainSubset(t),i.stickCls.createStickRepresentation(l.hashUtilsCls.hash2Atoms(t,i.atoms),i.cylinderRadius,i.cylinderRadius,void 0,s,void 0)):"ball and stick"===e?(i.stickCls.createStickRepresentation(l.hashUtilsCls.hash2Atoms(t,i.atoms),i.cylinderRadius,.5*i.cylinderRadius,i.dotSphereScale,s,void 0),i.lineCls.createConnCalphSidechain(l.hashUtilsCls.hash2Atoms(t,i.atoms),e)):"sphere"===e?i.sphereCls.createSphereRepresentation(l.hashUtilsCls.hash2Atoms(t,i.atoms),i.sphereRadius,void 0,void 0,s):"dot"===e&&i.sphereCls.createSphereRepresentation(l.hashUtilsCls.hash2Atoms(t,i.atoms),i.sphereRadius,!1,i.dotSphereScale,s);else i.cylinderCls.createCylinderHelix(l.hashUtilsCls.hash2Atoms(t,i.atoms),i.cylinderHelixRadius,s);else i.strandCls.createStrand(l.hashUtilsCls.hash2Atoms(t,i.atoms),null,null,null,null,null,!1,void 0,s);else i.strandCls.createStrand(l.hashUtilsCls.hash2Atoms(t,i.atoms),2,void 0,!0,void 0,void 0,!1,i.ribbonthickness,s)}i.cnt>i.maxmaxatomcnt&&i.init_base(),void 0!==i.labels&&Object.keys(i.labels).length>0&&(i.labelCls.hideLabels(),i.labelCls.createLabelRepresentation(i.labels))}selectMainChainSubset(e){let t=this.icn3d;t.icn3dui;let s=["C1'","C1*","C2'","C2*","C3'","C3*","C4'","C4*","C5'","C5*","O3'","O3*","O4'","O4*","O5'","O5*","P","OP1","O1P","OP2","O2P"],i={};for(let l in e)(t.proteins.hasOwnProperty(l)&&("N"===t.atoms[l].name||"C"===t.atoms[l].name||"O"===t.atoms[l].name||"CA"===t.atoms[l].name&&"C"===t.atoms[l].elem)||t.nucleotides.hasOwnProperty(l)&&-1!==s.indexOf(t.atoms[l].name))&&(i[l]=1);return i}}class qe{constructor(e){this.icn3d=e}showGlycans(){let e=this.icn3d,t=e.icn3dui;if(e.icn3dui.bNode)return;let s={},i=e.dAtoms;for(let l in i){let i=e.atoms[l];i.het&&-1!=t.parasCls.glycanHash.hasOwnProperty(i.resn)&&(void 0===s[i.resn]&&(s[i.resn]={}),"Misc"!=i.chain&&(s[i.resn][i.structure+"_"+i.chain+"_"+i.resi]=1))}let l=Object.keys(s);for(let i=0,n=l.length;i<n;++i){let n=l[i];if(!t.parasCls.glycanHash.hasOwnProperty(n))continue;let o=t.parasCls.glycanHash[n].s,r=new THREE.Color("#"+t.parasCls.glycanHash[n].c),a=Object.keys(s[n]);for(let t=0,s=a.length;t<s;++t){let s=e.applyCenterCls.centerAtoms(e.residues[a[t]]),i=s.center,l=.5*s.maxD*.6;if("cube"==o)e.boxCls.createBox_base(i,l,r,!1,!1,!0);else if("sphere"==o)e.sphereCls.createSphereBase(i,r,l,1,!1,!0);else if("cone"==o){let t=new THREE.Vector3(0,0,1),s=e.axesCls.createArrow(t,new THREE.Vector3(0,0,-1*l).add(i),0,r,2*l,2*l,!0);e.mdl.add(s),e.objects.push(s)}else if("cylinder"==o){let t=new THREE.Vector3(0,0,l).add(i),s=new THREE.Vector3(0,0,-1*l).add(i);e.cylinderCls.createCylinder(t,s,l,r,!1,r,!1,!0)}}}}}class Be{constructor(e){this.icn3d=e}applySymd(){let e=this.icn3d;e.icn3dui;for(let t=0,s=e.symdArray.length;t<s;++t){let s=e.symdArray[t],i=Object.keys(s)[0];this.applySymmetry(i,!0,s[i])}}applySymmetry(e,t,s){let i=this.icn3d,l=i.icn3dui,n=t?s:i.symmetryHash[e];n||(n=[]);let o=e.substr(0,1),r=parseInt(e.substring(1,e.indexOf(" "))),a=1.5*i.cylinderRadius,d=1*i.cylinderRadius,c=[];for(let e=0,s=n.length;e<s;++e){let s=n[e][0],h=n[e][1],m=n[e][2],p=n[e][3],u=n[e][4],C=n[e][5];if(i.cylinderCls.createCylinder(s,h,a,m,0),!i.bAxisOnly)if("C"==o||"D"==o&&u==r){let e={};Object.keys(i.chains).length;let n=!1,o={};if(t&&Object.keys(i.hAtoms).length<Object.keys(i.atoms).length){for(let e in i.hAtoms){let t=i.atoms[e];o[t.structure+"_"+t.chain]=1}Object.keys(o).length>1&&(n=!0)}if(t)if(n){let t=Object.keys(o)[0];e=i.chains[t]}else{0==Object.keys(i.hAtoms).length&&(i.hAtoms=l.hashUtilsCls.cloneHash(i.atoms));let t,s=parseInt(Object.keys(i.hAtoms).length/u),n=0;for(let l in i.hAtoms)if(e[l]=1,t=l,++n,n>s)break;let o=i.atoms[t].structure+"_"+i.atoms[t].chain+"_"+i.atoms[t].resi;e=l.hashUtilsCls.unionHash(e,i.residues[o])}else{let t=Object.keys(i.structures)[0]+"_"+C;if(i.chains.hasOwnProperty(t)||(t=Object.keys(i.structures)[0]+"_"+C.toLowerCase()),!i.chains.hasOwnProperty(t)){t=Object.keys(i.chains)[0];for(let e in i.chains){let s=Object.keys(i.chains[e])[0];if(i.proteins.hasOwnProperty(s)){t=e;break}}}e=i.chains[t]}let a=s.clone().add(h).multiplyScalar(.5),c=new THREE.Vector3,m=0,g=h.clone().sub(s).normalize(),f=new THREE.Vector3(0,0,1),b=new THREE.Quaternion;b.setFromUnitVectors(g,f);let y=-9999;for(let t in e){let e=i.atoms[t].coord.clone();c.add(e),e.sub(a).applyQuaternion(b);let s=e.x*e.x+e.y*e.y;s>y&&(y=s),++m}let v=c.multiplyScalar(1/m),w=new THREE.Line3(s,h),S=new THREE.Vector3;w.closestPointToPoint(v,!0,S);let _,A,x,k,O=Math.sqrt(y),H=v.clone().sub(S).normalize().multiplyScalar(O),R=a.clone().add(s.clone().sub(a).multiplyScalar(.83)).add(H),E=a.clone().add(h.clone().sub(a).multiplyScalar(.83)).add(H),I=2*Math.PI/r;for(let e=0;e<r;++e){let t=(.5+e)*I,l=R.clone().sub(s);l.applyAxisAngle(g,t).add(s);let n=E.clone().sub(s);n.applyAxisAngle(g,t).add(s),i.cylinderCls.createCylinder(l,n,d,p,0),i.sphereCls.createSphereBase(l,p,d,1,0),i.sphereCls.createSphereBase(n,p,d,1,0),0==e?(_=l,A=n):(i.cylinderCls.createCylinder(l,x,d,p,0),i.cylinderCls.createCylinder(n,k,d,p,0)),x=l,k=n}_&&x&&i.cylinderCls.createCylinder(_,x,d,p,0),A&&k&&i.cylinderCls.createCylinder(A,k,d,p,0)}else("T"==o&&3==u||"O"==o&&4==u||"I"==o&&5==u)&&(c.push(s),c.push(h))}if("T"==o){let e=c[0];i.sphereCls.createSphereBase(e,colorPolygon,d,1,0);let t,s,l,n=e.distanceTo(c[2]),o=e.distanceTo(c[3]);n<o?(t=n,s=c[3]):(t=o,s=c[2]),i.sphereCls.createSphereBase(s,colorPolygon,d,1,0),i.cylinderCls.createCylinder(e,s,d,colorPolygon,0);for(let n=4,o=c.length;n<o;++n){let o=c[n];e.distanceTo(o)>t&&(i.sphereCls.createSphereBase(o,colorPolygon,d,1,0),i.cylinderCls.createCylinder(e,o,d,colorPolygon,0),i.cylinderCls.createCylinder(s,o,d,colorPolygon,0),void 0!==l&&i.cylinderCls.createCylinder(c[l],o,d,colorPolygon,0),l=n)}}else if("O"==o)for(let e=0,t=c.length;e<t;e+=2){let t=c[e],s=c[e+1];i.sphereCls.createSphereBase(t,colorPolygon,d,1,0),i.sphereCls.createSphereBase(s,colorPolygon,d,1,0);for(let l=e+2,n=c.length;l<n;++l){let e=c[l];i.sphereCls.createSphereBase(e,colorPolygon,d,1,0),i.cylinderCls.createCylinder(t,e,d,colorPolygon,0),i.cylinderCls.createCylinder(s,e,d,colorPolygon,0)}}else if("I"==o)for(let e=0,t=c.length;e<t;e+=2){let t=c[e],s=c[e+1];i.sphereCls.createSphereBase(t,colorPolygon,d,1,0),i.sphereCls.createSphereBase(s,colorPolygon,d,1,0);for(let l=e+2,n=c.length;l<n;l+=2){let e,n,o=c[l],r=c[l+1];t.distanceTo(o)<t.distanceTo(r)?(e=o,n=r):(e=r,n=o),i.sphereCls.createSphereBase(e,colorPolygon,d,1,0),i.sphereCls.createSphereBase(n,colorPolygon,d,1,0),i.cylinderCls.createCylinder(t,e,d,colorPolygon,0),i.cylinderCls.createCylinder(s,n,d,colorPolygon,0)}}}}class je{constructor(e){this.icn3d=e}applyOtherOptions(e){let t=this.icn3d,s=t.icn3dui;if(void 0===e&&(e=t.opts),t.hBondCls.setHbondsContacts(e,"contact"),t.hBondCls.setHbondsContacts(e,"halogen"),t.hBondCls.setHbondsContacts(e,"pi-cation"),t.hBondCls.setHbondsContacts(e,"pi-stacking"),t.hBondCls.setHbondsContacts(e,"hbond"),t.hBondCls.setHbondsContacts(e,"saltbridge"),void 0!==t.pairArray&&t.pairArray.length>0){this.updateStabilizer();let e="#FFFFFF",s=t.stabilizerpnts;t.lines.stabilizer=[];for(let i=0,l=Math.floor(s.length/2);i<l;i++){let l={};l.position1=s[2*i],l.position2=s[2*i+1],l.color=e,l.dashed=!1,t.lines.stabilizer.push(l)}}if(t.lineCls.createLines(t.lines),t.distPnts&&t.distPnts.length>0)for(let e=0,s=t.distPnts.length;e<s;++e)t.boxCls.createBox_base(t.distPnts[e],t.originSize,t.hColor,!1);if(void 0!==t.prevMaps)for(let e=0,s=t.prevMaps.length;e<s;++e)t.mdl.add(t.prevMaps[e]);if(void 0!==t.prevEmmaps)for(let e=0,s=t.prevEmmaps.length;e<s;++e)t.mdl.add(t.prevEmmaps[e]);if(void 0!==t.prevPhimaps)for(let e=0,s=t.prevPhimaps.length;e<s;++e)t.mdl.add(t.prevPhimaps[e]);if(void 0!==t.prevSurfaces)for(let e=0,s=t.prevSurfaces.length;e<s;++e)t.mdl.add(t.prevSurfaces[e]);if(void 0!==t.symmetryHash&&void 0!==t.symmetrytitle&&t.applySymdCls.applySymmetry(t.symmetrytitle),void 0!==t.symdArray&&t.symdArray.length>0&&t.applySymdCls.applySymd(),void 0!==t.prevOtherMesh)for(let e=0,s=t.prevOtherMesh.length;e<s;++e)t.mdl.add(t.prevOtherMesh[e]);if(""!=s.htmlCls.setHtmlCls.getCookie("glycan")){let e=parseInt(s.htmlCls.setHtmlCls.getCookie("glycan"));t.bGlycansCartoon!=e&&s.htmlCls.clickMenuCls.setLogCmd("set glycan "+e,!0),t.bGlycansCartoon=e}switch(t.bGlycansCartoon&&!t.bAlternate&&t.glycanCls.showGlycans(),t.applyCenterCls.applyCenterOptions(e),t.axesCls.buildAllAxes(void 0,!0),e.axis.toLowerCase()){case"yes":t.axis=!0,t.axesCls.buildAxes(t.maxD/2);break;case"no":t.axis=!1}switch(e.pk.toLowerCase()){case"atom":t.pk=1;break;case"no":t.pk=0;break;case"residue":t.pk=2;break;case"strand":t.pk=3}}applyChemicalbindingOptions(e){let t=this.icn3d,s=t.icn3dui;if(void 0===e&&(e=t.opts),"show"===e.chemicalbinding){let e;void 0!==t.chemicals&&Object.keys(t.chemicals).length>0&&(e=s.hashUtilsCls.hash2Atoms(t.chemicals,t.atoms));let i=4;if(void 0!==e){let l=t.contactCls.getAtomsWithinAtom(t.atoms,e,i),n=3.5;t.opts.hbonds="yes",Object.keys(l).length>0&&t.hBondCls.calculateChemicalHbonds(e,l,parseFloat(n)),t.bSetFog||t.transformCls.zoominSelection(s.hashUtilsCls.unionHash(e,l))}}else"hide"===e.chemicalbinding&&(t.hBondCls.hideHbonds(),t.bSetFog||t.transformCls.zoominSelection(t.atoms))}updateStabilizer(){let e=this.icn3d;if(e.icn3dui,e.stabilizerpnts=[],void 0!==e.pairArray)for(let t=0,s=e.pairArray.length;t<s;t+=2){let s=this.getResidueRepPos(e.pairArray[t]),i=this.getResidueRepPos(e.pairArray[t+1]);e.stabilizerpnts.push(s),e.stabilizerpnts.push(i)}}getResidueRepPos(e){let t=this.icn3d;t.icn3dui;let s,i=t.atoms[e],l=i.structure+"_"+i.chain+"_"+i.resi;if(t.proteins.hasOwnProperty(e)||t.nucleotides.hasOwnProperty(e))for(let e in t.residues[l]){let i=t.atoms[e];if("N3"===i.name){s=t.atoms[e].coord;break}if("CA"===i.name&&"coil"==i.ss){s=t.atoms[e].coord;break}if("CA"===i.name&&("helix"==i.ss||"sheet"==i.ss)){s=void 0!==t.atoms[e].coord2?t.atoms[e].coord2:t.atoms[e].coord;break}}else s=i.coord;return void 0===s&&(s=i.coord),s}}class ze{constructor(e){this.icn3d=e}applySsbondsOptions(e){let t=this.icn3d,s=t.icn3dui;if(void 0===e&&(e=t.opts),"yes"===e.ssbonds.toLowerCase()&&void 0!==t.ssbondpnts){let e,i,l="#FFFF00",n=s.parasCls.thr(16776960),o=Object.keys(t.structures);t.bAlternate?(e=t.ALTERNATE_STRUCTURE,i=t.ALTERNATE_STRUCTURE+1):(e=0,i=o.length),t.lines.ssbond=[];for(let r=e,a=i;r<a;++r){let e=o[r];if(void 0!==t.ssbondpnts[e])for(let i=Math.floor(t.ssbondpnts[e].length/2)-1;i>=0;i--){let o=t.ssbondpnts[e][2*i],r=t.ssbondpnts[e][2*i+1],a={};a.color=l,a.dashed=!0;let d=[],c=[],h=[],m=[],p=!1,u=!1;for(let e in t.residues[o])"SG"===t.atoms[e].name&&(h.push(t.atoms[e].coord),d.push(t.atoms[e].serial),p=!0);if(!p)for(let e in t.residues[o])if("CA"===t.atoms[e].name){h.push(t.atoms[e].coord),d.push(t.atoms[e].serial),p=!0,u=!0;break}p=!1;for(let e in t.residues[r])"SG"===t.atoms[e].name&&(m.push(t.atoms[e].coord),c.push(t.atoms[e].serial),p=!0);if(!p)for(let e in t.residues[r])if("CA"===t.atoms[e].name){m.push(t.atoms[e].coord),c.push(t.atoms[e].serial),p=!0,u=!0;break}let C=u?7:3,g=!1;for(let e=0,t=h.length;e<t;++e)for(let t=0,s=m.length;t<s;++t)if(h[e].distanceTo(m[t])<C){g=!0,a.serial1=d[e],a.position1=h[e],a.serial2=c[t],a.position2=m[t];break}if(void 0!==a.serial1&&void 0!==a.serial2&&!t.dAtoms.hasOwnProperty(a.serial1)&&!t.dAtoms.hasOwnProperty(a.serial2))continue;if(!g){t.ssbondpnts[e].splice(2*i,2);continue}let f,b,y,v=t.atoms[a.serial1].bonds.indexOf(a.serial2);-1!=v&&(f=t.atoms[a.serial1].bonds.slice(0,v),b=t.atoms[a.serial1].bonds.slice(v+1),t.atoms[a.serial1].bonds=f.concat(b)),v=t.atoms[a.serial2].bonds.indexOf(a.serial1),-1!=v&&(f=t.atoms[a.serial2].bonds.slice(0,v),b=t.atoms[a.serial2].bonds.slice(v+1),t.atoms[a.serial2].bonds=f.concat(b)),t.lines.ssbond.push(a),t.cylinderCls.createCylinder(a.position1,a.position2,t.cylinderRadius,n),y=s.hashUtilsCls.unionHash(y,t.residues[o]),y=s.hashUtilsCls.unionHash(y,t.residues[r]);let w=s.hashUtilsCls.intHash(y,t.sidec);for(let e in w)t.atoms[e].style2="stick"}}}}}class Ge{constructor(e){this.icn3d=e}rebuildScene(e){let t=this.icn3d;t.icn3dui,void 0===e&&(e=t.opts),this.rebuildSceneBase(e),t.fogCls.setFog(),t.cameraCls.setCamera(),void 0!==t.bSkipChemicalbinding&&t.bSkipChemicalbinding||t.applyOtherCls.applyChemicalbindingOptions(),t.bSkipChemicalbinding=!0,"show"===e.chemicalbinding&&(t.opts.hbonds="yes"),t.applySsbondsCls.applySsbondsOptions(),t.applyClbondsCls.applyClbondsOptions(),t.applyDisplayCls.applyDisplayOptions(t.opts,t.dAtoms),t.applyOtherCls.applyOtherOptions(),t.scene_ghost.updateMatrixWorld(!0)}rebuildSceneBase(e){let t=this.icn3d,s=t.icn3dui;if($.extend(t.opts,e),t.cam_z=2*t.maxD,void 0!==t.scene)for(let e=t.scene.children.length-1;e>=0;e--){let s=t.scene.children[e];t.scene.remove(s)}else t.scene=new THREE.Scene;if(void 0!==t.scene_ghost)for(let e=t.scene_ghost.children.length-1;e>=0;e--){let s=t.scene_ghost.children[e];t.scene_ghost.remove(s)}else t.scene_ghost=new THREE.Scene;if(""!=s.htmlCls.setHtmlCls.getCookie("shininess")){let e=parseFloat(s.htmlCls.setHtmlCls.getCookie("shininess"));t.shininess!=e&&s.htmlCls.clickMenuCls.setLogCmd("set shininess "+e,!0),t.shininess=e}if(!s.bNode&&""!=s.htmlCls.setHtmlCls.getCookie("light1")){let e=parseFloat(s.htmlCls.setHtmlCls.getCookie("light1")),i=parseFloat(s.htmlCls.setHtmlCls.getCookie("light2")),l=parseFloat(s.htmlCls.setHtmlCls.getCookie("light3"));t.light1==e&&t.light2==i&&t.light3==l||s.htmlCls.clickMenuCls.setLogCmd("set light | light1 "+e+" | light2 "+i+" | light3 "+l,!0),t.light1=e,t.light2=i,t.light3=l}t.directionalLight=new THREE.DirectionalLight(16777215,t.light1),t.directionalLight2=new THREE.DirectionalLight(16777215,t.light2),t.directionalLight3=new THREE.DirectionalLight(16777215,t.light3),t.cam_z>0?(t.directionalLight.position.set(-1,1,1),t.directionalLight2.position.set(1,1,1),t.directionalLight3.position.set(1,1,-1),t.lightPos=new THREE.Vector3(-1,1,1),t.lightPos2=new THREE.Vector3(1,1,1),t.lightPos3=new THREE.Vector3(1,1,-1)):(t.directionalLight.position.set(-1,1,-1),t.directionalLight2.position.set(1,1,-1),t.directionalLight3.position.set(1,1,1),t.lightPos=new THREE.Vector3(-1,1,-1),t.lightPos2=new THREE.Vector3(1,1,-1),t.lightPos3=new THREE.Vector3(1,1,1));let i=new THREE.AmbientLight(8947848);if(t.scene.add(t.directionalLight),t.scene.add(i),void 0!==t.mdl)for(let e=t.mdl.children.length-1;e>=0;e--){let s=t.mdl.children[e];s.geometry&&s.geometry.dispose(),s.material&&s.material.dispose(),t.mdl.remove(s)}if(void 0!==t.mdlImpostor){for(let e=t.mdlImpostor.children.length-1;e>=0;e--){let s=t.mdlImpostor.children[e];s.geometry&&s.geometry.dispose(),s.material&&s.material.dispose(),t.mdlImpostor.remove(s)}t.mdlImpostor.children.length=0}t.icn3dui.bNode||t.renderer.renderLists.dispose(),t.mdl=new THREE.Object3D,t.mdlImpostor=new THREE.Object3D,t.scene.add(t.mdl),t.scene.add(t.mdlImpostor),t.mdl_ghost=new THREE.Object3D,t.scene_ghost.add(t.mdl_ghost),t.objects=[],t.objects_ghost=[],t.raycaster=new THREE.Raycaster,t.projector=new THREE.Projector,t.mouse=new THREE.Vector2;let l=s.parasCls.backgroundColors[t.opts.background.toLowerCase()];t.icn3dui.bNode||("transparent"===t.opts.background.toLowerCase()?t.renderer.setClearColor(l,0):t.renderer.setClearColor(l,1)),t.perspectiveCamera=new THREE.PerspectiveCamera(20,t.container.whratio,.1,1e4),t.perspectiveCamera.position.set(0,0,t.cam_z),t.perspectiveCamera.lookAt(new THREE.Vector3(0,0,0)),t.orthographicCamera=new THREE.OrthographicCamera,t.orthographicCamera.position.set(0,0,t.cam_z),t.orthographicCamera.lookAt(new THREE.Vector3(0,0,0)),t.cams={perspective:t.perspectiveCamera,orthographic:t.orthographicCamera}}}class Ve{constructor(e){this.icn3d=e}onBeforeRender(e,t,s,i,l,n){let o=l.uniforms,r=[];if(o.objectId&&(o.objectId.value=SupportsReadPixelsFloat?this.id:this.id/255,r.push("objectId")),(o.modelViewMatrixInverse||o.modelViewMatrixInverseTranspose||o.modelViewProjectionMatrix||o.modelViewProjectionMatrixInverse)&&this.modelViewMatrix.multiplyMatrices(s.matrixWorldInverse,this.matrixWorld),o.modelViewMatrixInverse&&(o.modelViewMatrixInverse.value.copy(this.modelViewMatrix).invert(),r.push("modelViewMatrixInverse")),o.modelViewMatrixInverseTranspose&&(o.modelViewMatrixInverse?o.modelViewMatrixInverseTranspose.value.copy(o.modelViewMatrixInverse.value).transpose():o.modelViewMatrixInverseTranspose.value.copy(this.modelViewMatrix).invert().transpose(),r.push("modelViewMatrixInverseTranspose")),o.modelViewProjectionMatrix&&(s.updateProjectionMatrix(),o.modelViewProjectionMatrix.value.multiplyMatrices(s.projectionMatrix,this.modelViewMatrix),r.push("modelViewProjectionMatrix")),o.modelViewProjectionMatrixInverse){let e=new THREE.Matrix4;o.modelViewProjectionMatrix?(e.copy(o.modelViewProjectionMatrix.value),o.modelViewProjectionMatrixInverse.value.copy(e).invert()):(s.updateProjectionMatrix(),e.multiplyMatrices(s.projectionMatrix,this.modelViewMatrix),o.modelViewProjectionMatrixInverse.value.copy(e).invert()),r.push("modelViewProjectionMatrixInverse")}if(o.projectionMatrix&&(s.updateProjectionMatrix(),o.projectionMatrix.value.copy(s.projectionMatrix),r.push("projectionMatrix")),o.projectionMatrixInverse&&(s.updateProjectionMatrix(),o.projectionMatrixInverse.value.copy(s.projectionMatrix).invert(),r.push("projectionMatrixInverse")),r.length){let t=e.properties.get(l);if(t.program){let s=e.getContext(),i=t.program;s.useProgram(i.program);let l=i.getUniforms();r.forEach((function(e){l.setValue(s,e,o[e].value)}))}}}setParametersForShader(e){let t,s=this.icn3d,i=s.icn3dui.parasCls.backgroundColors[s.opts.background.toLowerCase()],l=2.5*s.maxD,n=4*s.maxD,o=void 0!==s.biomtMatrices&&s.biomtMatrices.length*s.cnt>s.maxatomcnt;"yes"===s.opts.slab?o?t=.1:void 0!==s.camMaxDFactorFog?(t=s.maxD*s.camMaxDFactorFog-10,l=2.5*s.maxD-t<0?0:2.5*s.maxD-t,n=4*s.maxD-t):t=s.maxD*s.camMaxDFactor:t=.1;let r=void 0!==e?e:1,a=s.shininess/100*.5;s.uniforms=THREE.UniformsUtils.merge([THREE.UniformsLib.common,{modelViewMatrix:{value:new THREE.Matrix4},modelViewMatrixInverse:{value:new THREE.Matrix4},modelViewMatrixInverseTranspose:{value:new THREE.Matrix4},modelViewProjectionMatrix:{value:new THREE.Matrix4},modelViewProjectionMatrixInverse:{value:new THREE.Matrix4},projectionMatrix:{value:new THREE.Matrix4},projectionMatrixInverse:{value:new THREE.Matrix4},diffuse:{type:"v3",value:[1,1,1]},emissive:{type:"v3",value:[.06,.06,.06]},roughness:{type:"f",value:.5},metalness:{type:"f",value:a},opacity:{type:"f",value:r},nearClip:{type:"f",value:t},ortho:{type:"f",value:0},shrink:{type:"f",value:.13},fogColor:{type:"v3",value:[i.r,i.g,i.b]},fogNear:{type:"f",value:l},fogFar:{type:"f",value:n},fogDensity:{type:"f",value:2}},THREE.UniformsLib.ambient,THREE.UniformsLib.lights]),s.defines={USE_COLOR:1,NEAR_CLIP:1,CAP:1},"yes"!==s.opts.fog||o||(s.defines.USE_FOG=1,"orthographic"===s.opts.camera&&(s.defines.FOG_EXP2=1)),s.bExtFragDepth&&(s.defines.USE_LOGDEPTHBUF_EXT=1)}drawImpostorShader(){let e=this.icn3d;e.icn3dui,e.icn3dui.bNode||(this.setParametersForShader(),this.createImpostorShaderSphere("SphereImpostor"),this.createImpostorShaderCylinder("CylinderImpostor"))}getShader(e){this.icn3d.icn3dui;let t=$NGL_shaderTextHash[e];return t=t.replace(/#include\s+(\S+)/gim,(function(e,t){let s;return THREE.ShaderChunk.hasOwnProperty(t)&&(s=THREE.ShaderChunk[t]),s||""})),t}createImpostorShaderBase(e,t,s,i,l,n,o,r,a){let d=this.icn3d;d.icn3dui;let c=new THREE.ShaderMaterial({defines:d.defines,uniforms:d.uniforms,vertexShader:this.getShader(e+".vert"),fragmentShader:this.getShader(e+".frag"),depthTest:!0,depthWrite:!0,lights:!0});c.extensions.fragDepth=!0,"CylinderImpostor"==e?d.CylinderImpostorMaterial=c:"SphereImpostor"==e&&(d.SphereImpostorMaterial=c);let h,m,p=n*o,u=n*r,C=new(p>65535?Uint32Array:Uint16Array)(u);for(let e=0;e<n;e++){h=e*r,m=e*o,C.set(s,h);for(let e=0;e<r;++e)C[h+e]+=m}let g=new THREE.BufferGeometry;C&&(g.setIndex(new THREE.BufferAttribute(C,1)),g.getIndex().setUsage(THREE.DynamicDrawUsage));let f={f:1,v2:2,v3:3,c:3};for(let e in l){let t,s=l[e];t=new Float32Array(p*f[s.type]),g.setAttribute(e,new THREE.BufferAttribute(t,f[s.type]).setUsage(THREE.DynamicDrawUsage))}let b,y,v,w,S,_,A=g.attributes;for(let e in i){y=i[e],b=A[e],v=b.itemSize,w=b.array;for(let e=0;e<n;++e){u=e*v,S=u*o;for(let e=0;e<o;++e){_=S+v*e;for(let e=0;e<v;++e)w[_+e]=y[u+e]}}b.needsUpdate=!0}let x=g.attributes.mapping.array;for(let e=0;e<n;e++)x.set(t,e*a*o);let k=new THREE.Mesh(g,c);k.frustumCulled=!1,k.scale.x=k.scale.y=k.scale.z=1,"CylinderImpostor"==e?k.type="Cylinder":"SphereImpostor"==e&&(k.type="Sphere"),k.onBeforeRender=this.onBeforeRender,d.mdlImpostor.add(k)}createImpostorShaderCylinder(e){let t=this.icn3d;t.icn3dui;let s=new Float32Array(t.posArray),i=new Float32Array(t.colorArray),l=new Float32Array(t.pos2Array),n=new Float32Array(t.color2Array),o=new Float32Array(t.radiusArray),r=new Float32Array([-1,1,-1,-1,-1,-1,1,1,-1,1,1,1,1,-1,-1,1,-1,1]),a=new Uint16Array([0,1,2,1,4,2,2,4,3,4,5,3]),d=s.length/3,c={position1:s,color:i,position2:l,color2:n,radius:o},h={position1:{type:"v3",value:null},color:{type:"v3",value:null},position2:{type:"v3",value:null},color2:{type:"v3",value:null},radius:{type:"f",value:null},mapping:{type:"v3",value:null}};this.createImpostorShaderBase(e,r,a,c,h,d,6,12,3),c=null,s=null,i=null,l=null,n=null,o=null,t.posArray=[],t.colorArray=[],t.pos2Array=[],t.color2Array=[],t.radiusArray=[]}createImpostorShaderSphere(e){let t=this.icn3d;t.icn3dui;let s=new Float32Array(t.posArraySphere),i=new Float32Array(t.colorArraySphere),l=new Float32Array(t.radiusArraySphere),n=new Float32Array([-1,1,-1,-1,1,1,1,-1]),o=new Uint16Array([0,1,2,1,3,2]),r=s.length/3,a={position:s,color:i,radius:l},d={position:{type:"v3",value:null},color:{type:"v3",value:null},radius:{type:"f",value:null},mapping:{type:"v2",value:null}};this.createImpostorShaderBase(e,n,o,a,d,r,4,6,2),a=null,s=null,i=null,l=null,t.posArraySphere=[],t.colorArraySphere=[],t.radiusArraySphere=[]}clearImpostors(){let e=this.icn3d;e.icn3dui,e.posArray=[],e.colorArray=[],e.pos2Array=[],e.color2Array=[],e.radiusArray=[],e.posArraySphere=[],e.colorArraySphere=[],e.radiusArraySphere=[]}}class We{constructor(e){this.icn3d=e}positionFromGeometry(e){this.icn3d.icn3dui;let t,s,i=e.geometry,l=i.vertices,n=e.position,o=e.scale,r=e.matrix,a=l.length,d=[];for(let e=0;e<a;e++)t=3*e,s="SphereGeometry"==i.type||"BoxGeometry"==i.type?l[e].clone().multiply(o).add(n):"CylinderGeometry"==i.type?l[e].clone().applyMatrix4(r):l[e],d[t+0]=s.x,d[t+1]=s.y,d[t+2]=s.z;return d}colorFromGeometry(e){let t=this.icn3d.icn3dui,s=e.geometry,i=t.parasCls.thr(1,1,1);"SphereGeometry"!=s.type&&"BoxGeometry"!=s.type&&"CylinderGeometry"!=s.type||void 0!==e.material&&(i=e.material.color);let l,n,o,r,a,d=s.faces;s.vertices.length,s.type;let c=d.length,h=[];for(let e=0;e<c;e++)n=d[e],"Surface"==s.type?(o=n.vertexColors[0],r=n.vertexColors[1],a=n.vertexColors[2]):"SphereGeometry"==s.type||"BoxGeometry"==s.type||"CylinderGeometry"==s.type?(o=i,r=i,a=i):(o=n.color,r=n.color,a=n.color),l=3*n.a,h[l+0]=o.r,h[l+1]=o.g,h[l+2]=o.b,l=3*n.b,h[l+0]=r.r,h[l+1]=r.g,h[l+2]=r.b,l=3*n.c,h[l+0]=a.r,h[l+1]=a.g,h[l+2]=a.b;return h}indexFromGeometry(e){this.icn3d.icn3dui;let t,s,i=e.geometry.faces,l=i.length,n=[];for(let e=0;e<l;e++)t=3*e,s=i[e],n[t+0]=s.a,n[t+1]=s.b,n[t+2]=s.c;return n}normalFromGeometry(e){this.icn3d.icn3dui;let t,s,i,l,n,o,r=e.geometry,a=r.faces;r.vertices.length;let d=a.length,c=[];for(let e=0;e<d;e++)s=a[e],i=s.vertexNormals,l=i[0],n=i[1],o=i[2],t=3*s.a,c[t+0]=l.x,c[t+1]=l.y,c[t+2]=l.z,t=3*s.b,c[t+0]=n.x,c[t+1]=n.y,c[t+2]=n.z,t=3*s.c,c[t+0]=o.x,c[t+1]=o.y,c[t+2]=o.z;return c}drawSymmetryMates(){let e=this.icn3d;e.icn3dui,e.icn3dui.bNode||(e.bInstanced?this.drawSymmetryMatesInstancing():this.drawSymmetryMatesNoInstancing())}applyMat(e,t,s){let i=this.icn3d;if(i.icn3dui,void 0===i.rmsd_supr)e.applyMatrix4(t);else{let s=i.rmsd_supr.rot,l=i.rmsd_supr.trans1,n=i.rmsd_supr.trans2,o=new THREE.Matrix4;o.set(s[0],s[1],s[2],0,s[3],s[4],s[5],0,s[6],s[7],s[8],0,0,0,0,1);let r=new THREE.Matrix4;r.copy(o).invert();let a=new THREE.Matrix4;a.makeTranslation(-n.x,-n.y,-n.z),e.applyMatrix4(a),e.applyMatrix4(r),a.makeTranslation(l.x,l.y,l.z),e.applyMatrix4(a),e.applyMatrix4(t),a.makeTranslation(-l.x,-l.y,-l.z),e.applyMatrix4(a),e.applyMatrix4(o),a.makeTranslation(n.x,n.y,n.z),e.applyMatrix4(a)}}drawSymmetryMatesNoInstancing(){let e=this.icn3d;if(e.icn3dui,void 0===e.biomtMatrices||0==e.biomtMatrices.length)return;let t=1,s=e.center.clone(),i=new THREE.Matrix4;i.identity();let l=new THREE.Object3D,n=new THREE.Object3D,o=new THREE.Object3D;for(let r=0;r<e.biomtMatrices.length;r++){let a,d=e.biomtMatrices[r];if(void 0===d)continue;if(d.equals(i))continue;if(void 0!==e.mdl&&(a=e.mdl.clone(),this.applyMat(a,d),l.add(a)),void 0!==e.mdlImpostor){a=e.mdlImpostor.clone(),this.applyMat(a,d);for(let t=a.children.length-1;t>=0;t--){let s=a.children[t];s.onBeforeRender=e.impostorCls.onBeforeRender,s.frustumCulled=!1}n.add(a)}void 0!==e.mdl_ghost&&(a=e.mdl_ghost.clone(),this.applyMat(a,d),o.add(a));let c=e.center.clone();this.applyMat(c,d,!0),s.add(c),++t}e.mdl.add(l),e.mdlImpostor.add(n),e.mdl_ghost.add(o),void 0!==e.bSetInstancing&&e.bSetInstancing?(e.maxD=e.maxDAssembly,e.center=e.centerAssembly.clone(),e.applyCenterCls.setCenter(e.center),e.cameraCls.setCamera()):(e.maxD*=Math.sqrt(t),e.center=s.multiplyScalar(1/t),e.maxDAssembly=e.maxD,e.centerAssembly=e.center.clone(),e.applyCenterCls.setCenter(e.center),e.cameraCls.setCamera()),e.bSetInstancing=!0}createInstancedGeometry(e){let t=this.icn3d,s=t.icn3dui,i=e.geometry,l=new THREE.InstancedBufferGeometry,n=[],o=[],r=[],a=[],d=[],c=[],h=[],m=[];if(t.bImpo&&"Cylinder"==e.type){t.instancedMaterial=this.getInstancedMaterial("CylinderInstancing");let e=s.hashUtilsCls.hashvalue2array(i.attributes.position1.array),o=s.hashUtilsCls.hashvalue2array(i.attributes.color.array),p=s.hashUtilsCls.hashvalue2array(i.attributes.position2.array),u=s.hashUtilsCls.hashvalue2array(i.attributes.color2.array),C=s.hashUtilsCls.hashvalue2array(i.index.array),g=s.hashUtilsCls.hashvalue2array(i.attributes.radius.array),f=s.hashUtilsCls.hashvalue2array(i.attributes.mapping.array);n=n.concat(e),r=r.concat(o),h=h.concat(p),m=m.concat(u),a=a.concat(C),d=d.concat(g),c=c.concat(f),l.setAttribute("position1",new THREE.BufferAttribute(new Float32Array(n),3)),l.setAttribute("color",new THREE.BufferAttribute(new Float32Array(r),3)),l.setAttribute("position2",new THREE.BufferAttribute(new Float32Array(h),3)),l.setAttribute("color2",new THREE.BufferAttribute(new Float32Array(m),3)),l.setAttribute("radius",new THREE.BufferAttribute(new Float32Array(d),1)),l.setAttribute("mapping",new THREE.BufferAttribute(new Float32Array(c),3)),l.setIndex(new THREE.BufferAttribute(new Uint32Array(a),1)),e=null,o=null,p=null,u=null,C=null,g=null,f=null}else if(t.bImpo&&"Sphere"==e.type){t.instancedMaterial=this.getInstancedMaterial("SphereInstancing");let e=s.hashUtilsCls.hashvalue2array(i.attributes.position.array),o=s.hashUtilsCls.hashvalue2array(i.attributes.color.array),h=s.hashUtilsCls.hashvalue2array(i.index.array),m=s.hashUtilsCls.hashvalue2array(i.attributes.radius.array),p=s.hashUtilsCls.hashvalue2array(i.attributes.mapping.array);n=n.concat(e),r=r.concat(o),a=a.concat(h),d=d.concat(m),c=c.concat(p),l.setAttribute("position",new THREE.BufferAttribute(new Float32Array(n),3)),l.setAttribute("color",new THREE.BufferAttribute(new Float32Array(r),3)),l.setAttribute("radius",new THREE.BufferAttribute(new Float32Array(d),1)),l.setAttribute("mapping",new THREE.BufferAttribute(new Float32Array(c),2)),l.setIndex(new THREE.BufferAttribute(new Uint32Array(a),1)),e=null,o=null,h=null,m=null,p=null}else{t.instancedMaterial=this.getInstancedMaterial("Instancing");let e=i.attributes.position?s.hashUtilsCls.hashvalue2array(i.attributes.position.array):[],d=i.attributes.normal?s.hashUtilsCls.hashvalue2array(i.attributes.normal.array):[],c=i.attributes.color?s.hashUtilsCls.hashvalue2array(i.attributes.color.array):[],h=i.index?s.hashUtilsCls.hashvalue2array(i.index.array):[];n=n.concat(e),o=o.concat(d),r=r.concat(c),a=a.concat(h);let m=[],p="CylinderGeometry"==i.type?1:0;for(let e=0,t=n.length/3;e<t;++e)m.push(p);l.setAttribute("position",new THREE.BufferAttribute(new Float32Array(n),3)),l.setAttribute("normal",new THREE.BufferAttribute(new Float32Array(o),3)),l.setAttribute("color",new THREE.BufferAttribute(new Float32Array(r),3)),l.setAttribute("cylinder",new THREE.BufferAttribute(new Float32Array(m),1)),l.setIndex(new THREE.BufferAttribute(new Uint32Array(a),1)),e=null,d=null,c=null,h=null}n=null,o=null,r=null,a=null,d=null,c=null,h=null,m=null;let p=new THREE.InstancedBufferAttribute(new Float32Array(t.matricesElements1),4),u=new THREE.InstancedBufferAttribute(new Float32Array(t.matricesElements2),4),C=new THREE.InstancedBufferAttribute(new Float32Array(t.matricesElements3),4),g=new THREE.InstancedBufferAttribute(new Float32Array(t.matricesElements4),4);return l.setAttribute("matrix1",p),l.setAttribute("matrix2",u),l.setAttribute("matrix3",C),l.setAttribute("matrix4",g),l}getInstancedMaterial(e){let t=this.icn3d;t.icn3dui;let s=new THREE.ShaderMaterial({defines:t.defines,uniforms:t.uniforms,vertexShader:t.impostorCls.getShader(e+".vert"),fragmentShader:t.impostorCls.getShader(e+".frag"),depthTest:!0,depthWrite:!0,lights:!0});return s.extensions.fragDepth=!0,s.extensions.derivatives="#extension GL_OES_standard_derivatives : enable",s}createInstancedMesh(e){let t=this.icn3d;t.icn3dui;for(let s=0,i=e.children.length;s<i;++s){let i=e.children[s];if("Sprite"===i.type)continue;let l=this.createInstancedGeometry(i),n=new THREE.Mesh(l,t.instancedMaterial);n.onBeforeRender=t.impostorCls.onBeforeRender,n.frustumCulled=!1,n.scale.x=n.scale.y=n.scale.z=1,n.type=i.type,l=null,e.add(n)}}drawSymmetryMatesInstancing(){let e=this.icn3d;if(e.icn3dui,void 0===e.biomtMatrices||0==e.biomtMatrices.length)return;let t=1,s=e.center.clone();if(e.impostorCls.setParametersForShader(),void 0===e.bSetInstancing||!e.bSetInstancing){e.matricesElements1=[],e.matricesElements2=[],e.matricesElements3=[],e.matricesElements4=[];let i=new THREE.Matrix4;i.identity();for(let l=0;l<e.biomtMatrices.length;l++){let n=e.biomtMatrices[l];if(void 0===n)continue;let o=n.toArray();if(n.equals(i))continue;e.matricesElements1.push(o[0],o[1],o[2],o[3]),e.matricesElements2.push(o[4],o[5],o[6],o[7]),e.matricesElements3.push(o[8],o[9],o[10],o[11]),e.matricesElements4.push(o[12],o[13],o[14],o[15]);let r=e.center.clone();r.applyMatrix4(n),s.add(r),++t}}this.createInstancedMesh(e.mdl),this.createInstancedMesh(e.mdlImpostor),void 0!==e.bSetInstancing&&e.bSetInstancing?(e.maxD=e.maxDAssembly,e.center=e.centerAssembly.clone(),e.applyCenterCls.setCenter(e.center),e.cameraCls.setCamera()):(e.maxD*=Math.sqrt(t),e.center=s.multiplyScalar(1/t),e.maxDAssembly=e.maxD,e.centerAssembly=e.center.clone(),e.applyCenterCls.setCenter(e.center),e.cameraCls.setCamera()),e.bSetInstancing=!0}}class Ye{constructor(e){this.icn3d=e}draw(){let e=this.icn3d,t=e.icn3dui;!e.bRender||e.hAtoms&&0!=Object.keys(e.hAtoms)||(e.hAtoms=t.hashUtilsCls.cloneHash(e.atoms)),e.sceneCls.rebuildScene(),e.bImpo&&e.impostorCls.drawImpostorShader(),e.setColorCls.applyPrevColor(),void 0!==e.biomtMatrices&&e.biomtMatrices.length>1&&(e.bAssembly?e.instancingCls.drawSymmetryMates():e.applyCenterCls.centerSelection());let s=void 0!==e.hAtoms?Object.keys(e.hAtoms).length:0;s>0&&s<Object.keys(e.dAtoms).length&&(e.hlObjectsCls.removeHlObjects(),(void 0===e.bShowHighlight||e.bShowHighlight)&&e.hlObjectsCls.addHlObjects()),!0===e.bRender&&((e.bInitial||$("#"+e.pre+"wait").is(":visible"))&&($("#"+e.pre+"wait")&&$("#"+e.pre+"wait").hide(),$("#"+e.pre+"canvas")&&$("#"+e.pre+"canvas").show(),$("#"+e.pre+"cmdlog")&&$("#"+e.pre+"cmdlog").show()),this.applyTransformation(e._zoomFactor,e.mouseChange,e.quaternion),this.render()),e.impostorCls.clearImpostors()}applyTransformation(e,t,s){let i=this.icn3d;if(i.icn3dui,i.icn3dui.bNode)return;let l={update:!1};l._zoomFactor=e,l.mouseChange=new THREE.Vector2,l.mouseChange.copy(t),l.quaternion=new THREE.Quaternion,l.quaternion.copy(s),i.bControlGl&&!i.icn3dui.bNode?window.controls.update(l):i.controls.update(l)}render(){let e=this.icn3d;if(e.icn3dui,e.icn3dui.bNode)return;let t=e.bControlGl&&!e.icn3dui.bNode?window.cam:e.cam;if(e.directionalLight){let s=new THREE.Quaternion;s.setFromUnitVectors(new THREE.Vector3(0,0,e.cam_z).normalize(),t.position.clone().normalize()),e.directionalLight.position.copy(e.lightPos.clone().applyQuaternion(s).normalize()),e.directionalLight2.position.copy(e.lightPos2.clone().applyQuaternion(s).normalize()),e.directionalLight3.position.copy(e.lightPos3.clone().applyQuaternion(s).normalize())}e.renderer.setPixelRatio(window.devicePixelRatio),e.scene&&e.renderer.render(e.scene,t)}}class Xe{constructor(e){this.icn3d=e}resetOrientation(){let e=this.icn3d;e.icn3dui;let t=!1;if(e.commands.length>0){let s=e.commands[0].split("|||");if(2==s.length){let i=JSON.parse(s[1]);e._zoomFactor=i.factor,e.mouseChange.x=i.mouseChange.x,e.mouseChange.y=i.mouseChange.y,e.quaternion._x=i.quaternion._x,e.quaternion._y=i.quaternion._y,e.quaternion._z=i.quaternion._z,e.quaternion._w=i.quaternion._w,t=!0}}t||(e._zoomFactor=1,e.mouseChange=new THREE.Vector2(0,0),e.quaternion=new THREE.Quaternion(0,0,0,1)),e.maxD=e.oriMaxD,e.center=e.oriCenter.clone(),"show"==e.ori_chemicalbinding?e.bSkipChemicalbinding=!1:"hide"==e.ori_chemicalbinding&&(e.bSkipChemicalbinding=!0)}rotateLeft(e){let t=this.icn3d;t.icn3dui;let s=new THREE.Vector3(0,1,0),i=-e/180*Math.PI;t.bControlGl&&!t.icn3dui.bNode?s.applyQuaternion(window.cam.quaternion).normalize():s.applyQuaternion(t.cam.quaternion).normalize();let l=new THREE.Quaternion;l.setFromAxisAngle(s,-i);let n={};n.quaternion=l,n.update=!0,t.bControlGl&&!t.icn3dui.bNode?window.controls.update(n):t.controls.update(n),t.bRender&&t.drawCls.render()}rotateRight(e){let t=this.icn3d;t.icn3dui;let s=new THREE.Vector3(0,1,0),i=e/180*Math.PI;t.bControlGl&&!t.icn3dui.bNode?s.applyQuaternion(window.cam.quaternion).normalize():s.applyQuaternion(t.cam.quaternion).normalize();let l=new THREE.Quaternion;l.setFromAxisAngle(s,-i);let n={};n.quaternion=l,n.update=!0,t.bControlGl&&!t.icn3dui.bNode?window.controls.update(n):t.controls.update(n),t.bRender&&t.drawCls.render()}rotateUp(e){this.icn3d.icn3dui,this.rotate_base(-e)}rotateDown(e){this.icn3d.icn3dui,this.rotate_base(e)}rotate_base(e){let t=this.icn3d;t.icn3dui;let s=new THREE.Vector3(1,0,0),i=e/180*Math.PI;t.bControlGl&&!t.icn3dui.bNode?s.applyQuaternion(window.cam.quaternion).normalize():s.applyQuaternion(t.cam.quaternion).normalize();let l=new THREE.Quaternion;l.setFromAxisAngle(s,-i);let n={};n.quaternion=l,n.update=!0,t.bControlGl&&!t.icn3dui.bNode?window.controls.update(n):t.controls.update(n),t.bRender&&t.drawCls.render()}setRotation(e,t){let s=this.icn3d;s.icn3dui,s.bControlGl&&!s.icn3dui.bNode?e.applyQuaternion(window.cam.quaternion).normalize():e.applyQuaternion(s.cam.quaternion).normalize();let i=new THREE.Quaternion;i.setFromAxisAngle(e,-t);let l={};l.quaternion=i,l.update=!0,s.bControlGl&&!s.icn3dui.bNode?window.controls.update(l):s.controls.update(l),s.bRender&&s.drawCls.render()}translateLeft(e){this.icn3d.icn3dui,this.translate_base(-e,0)}translateRight(e){this.icn3d.icn3dui,this.translate_base(e,0)}translateUp(e){this.icn3d.icn3dui,this.translate_base(0,-e)}translateDown(e){this.icn3d.icn3dui,this.translate_base(0,e)}translate_base(e,t){let s=this.icn3d;s.icn3dui;let i=new THREE.Vector2(0,0);i.x+=e/100,i.y+=t/100;let l={};l.mouseChange=i,l.update=!0,s.bControlGl&&!s.icn3dui.bNode?window.controls.update(l):s.controls.update(l),s.bRender&&s.drawCls.render()}zoomIn(e){let t=this.icn3d;t.icn3dui;let s={};s._zoomFactor=1-e,s.update=!0,t.bControlGl&&!t.icn3dui.bNode?window.controls.update(s):t.controls.update(s),t.bRender&&t.drawCls.render()}zoomOut(e){let t=this.icn3d;t.icn3dui;let s={};s._zoomFactor=1+e,s.update=!0,t.bControlGl&&!t.icn3dui.bNode?window.controls.update(s):t.controls.update(s),t.bRender&&t.drawCls.render()}zoominSelection(e){let t=this.icn3d,s=t.icn3dui,i={};if(i._zoomFactor=1/t._zoomFactor,i.update=!0,t.bControlGl&&!t.icn3dui.bNode?window.controls.update(i):t.controls.update(i),void 0===e&&(e=s.hashUtilsCls.hash2Atoms(t.hAtoms,t.atoms)),Object.keys(e).length>1){let s=t.applyCenterCls.centerAtoms(e);t.maxD=s.maxD,t.maxD<5&&(t.maxD=5),t.center=s.center,t.applyCenterCls.setCenter(t.center),t.cameraCls.setCamera()}}getTransformationStr(e){this.icn3d.icn3dui;let t={factor:1,mouseChange:{x:0,y:0},quaternion:{_x:0,_y:0,_z:0,_w:1}};return t.factor=parseFloat(e.factor).toPrecision(4),t.mouseChange.x=parseFloat(e.mouseChange.x).toPrecision(4),t.mouseChange.y=parseFloat(e.mouseChange.y).toPrecision(4),t.quaternion._x=parseFloat(e.quaternion._x).toPrecision(4),t.quaternion._y=parseFloat(e.quaternion._y).toPrecision(4),t.quaternion._z=parseFloat(e.quaternion._z).toPrecision(4),t.quaternion._w=parseFloat(e.quaternion._w).toPrecision(4),"1.0000"==t.factor&&(t.factor=1),"0.0000"==t.mouseChange.x&&(t.mouseChange.x=0),"0.0000"==t.mouseChange.y&&(t.mouseChange.y=0),"0.0000"==t.quaternion._x&&(t.quaternion._x=0),"0.0000"==t.quaternion._y&&(t.quaternion._y=0),"0.0000"==t.quaternion._z&&(t.quaternion._z=0),"1.0000"==t.quaternion._w&&(t.quaternion._w=1),JSON.stringify(t)}}class Je{constructor(e){this.icn3d=e}saveFile(e,t,s){let i,l=this.icn3d,n=l.icn3dui;if("command"===t){let e=l.loadCmd?l.loadCmd+"\n":"";for(let t=0,s=l.commands.length;t<s;++t){let i=l.commands[t].trim();if(t==s-1){let e=i.split("|||"),t={};t.factor=l._zoomFactor,t.mouseChange=l.mouseChange,t.quaternion=l.quaternion,i=e[0]+"|||"+l.transformCls.getTransformationStr(t)}e+=i+"\n"}let t=decodeURIComponent(e);i=new Blob([t],{type:"text;charset=utf-8;"})}else if("png"===t){let t=$("#"+l.pre+"canvas").width(),s=$("#"+l.pre+"canvas").height();l.applyCenterCls.setWidthHeight(t,s),l.bRender&&l.drawCls.render();let o=!0;if(window.File&&window.FileReader&&window.FileList&&window.Blob||(o=!1),n.utilsCls.isIE()){if(i=l.renderer.domElement.msToBlob(),!o)return void saveAs(i,e);{let t=new FileReader;t.onload=function(t){let s=t.target.result,o=l.shareLinkCls.getPngText();i=n.convertTypeCls.getBlobFromBufferAndText(s,o),saveAs(i,e)},t.readAsArrayBuffer(i)}}else l.renderer.domElement.toBlob((function(t){if(!o)return i=t,void saveAs(i,e);{let s=new FileReader;s.onload=function(t){let s=t.target.result,o=l.shareLinkCls.getPngText();i=n.convertTypeCls.getBlobFromBufferAndText(s,o),saveAs(i,e)},s.readAsArrayBuffer(t)}}));l.scaleFactor=1,l.applyCenterCls.setWidthHeight(t,s),l.bRender&&l.drawCls.render()}else if("html"===t){let e=decodeURIComponent(s);i=new Blob([e],{type:"text/html;charset=utf-8;"})}else if("text"===t){i=new Blob(s,{type:"text;charset=utf-8;"})}else if("binary"===t){i=new Blob(s,{type:"application/octet-stream"})}"png"!==t&&saveAs(i,e)}saveSvg(e,t){this.icn3d.icn3dui;let s=this.getSvgXml(e),i=new Blob([s],{type:"image/svg+xml"});saveAs(i,t)}getSvgXml(e){let t=this.icn3d;if(t.icn3dui,t.icn3dui.bNode)return"";return'<svg title="graph" version="1.1" xmlns:xl="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" xmlns:dc="http://purl.org/dc/elements/1.1/"><style>text {font-family: sans-serif; font-weight: bold; font-size: 18px;}</style>'+document.getElementById(e).innerHTML+"</svg>"}savePng(e,t,s,i){let l=this.icn3d,n=l.icn3dui;if(l.icn3dui.bNode)return"";let o=document.getElementById(e),r=o.getBBox(),a=o.cloneNode(!0);l.lineGraphCls.copyStylesInline(a,o);let d=document.createElement("CANVAS");d.width=s,d.height=i;let c=d.getContext("2d");c.clearRect(0,0,r.width,r.height);let h=this.getSvgXml(e),m=window.URL||window.webkitURL||window,p=new Blob([h],{type:"image/svg+xml;charset=utf-8"}),u=new Image;u.src=m.createObjectURL(p),u.onload=function(){if(c.drawImage(u,0,0),m.revokeObjectURL(this.src),n.utilsCls.isIE()){let e=d.msToBlob();return saveAs(e,t),void d.remove()}d.toBlob((function(e){saveAs(e,t),d.remove()}))}}exportCustomAtoms(){var e=this.icn3d;e.icn3dui;let t="",s=void 0!==e.defNames2Residues?Object.keys(e.defNames2Residues).sort():[];for(let i=0,l=s.length;i<l;++i){let l=s[i],n=e.defNames2Residues[l];e.defNames2Descr[l];let o=e.defNames2Command[l];o=o.replace(/,/g,", "),t+=l+"\tselect ",t+=e.resid2specCls.residueids2spec(n),t+="\n"}s=void 0!==e.defNames2Atoms?Object.keys(e.defNames2Atoms).sort():[];for(let i=0,l=s.length;i<l;++i){let l=s[i],n=e.defNames2Atoms[l];e.defNames2Descr[l];let o=e.defNames2Command[l];o=o.replace(/,/g,", ");let r=e.resid2specCls.atoms2residues(n);r.length>0&&(t+=l+"\tselect ",t+=e.resid2specCls.residueids2spec(r),t+="\n")}return t}getAtomPDB(e,t,s){let i=this.icn3d,l=i.icn3dui,n="",o={},r={};for(let e in i.chemicals){let t=i.atoms[e];if("P"==t.elem){o[e]=1;for(let e=0,s=t.bonds.length;e<s;++e){let s=t.bonds[e];s&&"O"==i.atoms[s].elem&&(r[s]=1)}}}let a=l.hashUtilsCls.intHash(e,i.calphas),d=!1,c=!0,h=!1,m=!0;for(let e in a){let t=i.atoms[e];t.ssbegin&&("helix"==t.ss?(d=!0,c&&(n+="HELIX".padEnd(15," ")+t.resn.padStart(3," ")+t.chain.padStart(2," ")+t.resi.toString().padStart(5," ")),c=!1):"sheet"==t.ss&&(h=!0,m&&(n+="SHEET".padEnd(17," ")+t.resn.padStart(3," ")+t.chain.padStart(2," ")+t.resi.toString().padStart(4," ")),m=!1)),t.ssend&&("helix"==t.ss?(c=!0,d&&(n+=t.resn.padStart(5," ")+t.chain.padStart(2," ")+t.resi.toString().padStart(5," ")+"\n"),d=!1):"sheet"==t.ss&&(m=!0,h&&(n+=t.resn.padStart(5," ")+t.chain.padStart(2," ")+t.resi.toString().padStart(4," ")+"\n"),h=!1))}let p="",u=Object.keys(i.structures).length>1,C=1,g="";n+="\n";for(let a in e){let e=i.atoms[a];if(s&&e.het)continue;u&&e.structure!=g&&(n+=p,p="",C>1&&(n+="ENDMDL\n"),n+="MODEL        "+C+"\n",g=e.structure,++C);let d="";d+=e.het?"HETATM":"ATOM  ",d+=a.toString().padStart(5," "),d+=" ";let c=e.name.trim();isNaN(c.substr(0,1))||(c=c.substr(1)+c.substr(0,1)),4==c.length?d+=c:(d+=" ",c=c.replace(/\*/g,"'"),"O1P"==c?c="OP1":"O2P"==c?c="OP2":"C5M"==c&&(c="C7 "),d+=c.padEnd(3," ")),d+=" ";let h=e.resn;d+=h.length<=3?h.padStart(3," "):h.substr(0,3),d+=" ",d+=e.chain.length<=1?e.chain.padStart(1," "):e.chain.substr(0,1);let m=e.resi;if(!isNaN(m)&&e.chain.length>3&&!isNaN(e.chain.substr(3))&&(m=m-1+parseInt(e.chain.substr(3))),d+=m.toString().length<=4?m.toString().padStart(4," "):m.toString().substr(0,4),d+=" ".padStart(4," "),d+=e.coord.x.toFixed(3).toString().padStart(8," "),d+=e.coord.y.toFixed(3).toString().padStart(8," "),d+=e.coord.z.toFixed(3).toString().padStart(8," "),t&&e.het||o.hasOwnProperty(a)||r.hasOwnProperty(a)){let t=1.5,s=0;"C"==e.elem?t=1.908:"N"==e.elem?t=1.824:"O"==e.elem?t=1.6612:"H"==e.elem?t=1.25:"S"==e.elem?t=2:"P"==e.elem?t=2.1:l.parasCls.vdwRadii.hasOwnProperty(e.elem)&&(t=l.parasCls.vdwRadii[e.elem]),void 0!==i.icn3dui.cfg.cid&&void 0!==e.crg?s=e.crg:o.hasOwnProperty(a)?s=1.38:r.hasOwnProperty(a)?s=-.595:l.parasCls.ionCharges.hasOwnProperty(e.elem)&&(s=l.parasCls.ionCharges[e.elem]),d+=s.toFixed(4).toString().padStart(8," "),d+=t.toFixed(4).toString().padStart(7," ")}else d+="1.00".padStart(6," "),d+=e.b?parseFloat(e.b).toFixed(2).toString().padStart(6," "):" ".padStart(6," "),d+=" ".padStart(10," "),d+=e.elem.padStart(2," "),d+=" ".padStart(2," ");if(e.het&&e.bonds.length>0){p+="CONECT"+a.toString().padStart(5," ");let t={};for(let s=0,i=e.bonds.length;s<i;++s)e.bonds[s]&&!t.hasOwnProperty(e.bonds[s])&&(p+=e.bonds[s].toString().padStart(5," "),t[e.bonds[s]]=1);p+="\n"}n+=d+"\n"}return n+=p,u&&(n+="ENDMDL\n"),n}getSelectedResiduePDB(){let e=this.icn3d,t=e.icn3dui,s="";s+=this.getPDBHeader();let i=t.hashUtilsCls.intHash(e.dAtoms,e.hAtoms);return s+=this.getAtomPDB(i),s}getPDBHeader(e){let t=this.icn3d;t.icn3dui,void 0===e&&(e=0);let s="";s+="HEADER    PDB From iCn3D".padEnd(62," ")+Object.keys(t.structures)[e]+"\n";let i=t.molTitle.length>50?t.molTitle.substr(0,47)+"...":t.molTitle;return-1!=i.indexOf('"')&&(i=""),s+="TITLE     "+i+"\n",s}showTitle(){var e=this.icn3d;if(e.icn3dui,void 0!==e.molTitle&&""!==e.molTitle){let t=e.molTitle,s="white"==e.opts.background||"grey"==e.opts.background?"black":e.icn3dui.htmlCls.GREYD;if(void 0===e.inputid)e.molTitle.length>40&&(t=e.molTitle.substr(0,40)+"..."),$("#"+e.pre+"title").html(t);else if(void 0!==e.icn3dui.cfg.cid){let i=this.getLinkToStructureSummary();$("#"+e.pre+"title").html("PubChem CID <a id='"+e.pre+"titlelink' href='"+i+"' style='color:"+s+"' target='_blank'>"+e.inputid.toUpperCase()+"</a>: "+t)}else if(void 0!==e.icn3dui.cfg.align)$("#"+e.pre+"title").html(t);else if(void 0!==e.icn3dui.cfg.chainalign){let s=e.icn3dui.cfg.chainalign.split(",");t="Dynamic Structure Alignment of Chain "+s[0]+" to Chain "+s[1],$("#"+e.pre+"title").html(t)}else{let i=this.getLinkToStructureSummary();e.molTitle.length>40&&(t=e.molTitle.substr(0,40)+"...");let l="";$("#"+e.pre+"title").html("PDB ID <a id='"+e.pre+"titlelink' href='"+i+"' style='color:"+s+"' target='_blank'>"+e.inputid.toUpperCase()+"</a>"+l+": "+t)}}else $("#"+e.pre+"title").html("")}getLinkToStructureSummary(e){var t=this.icn3d;t.icn3dui;let s="https://www.ncbi.nlm.nih.gov/structure/?term=";if(s=void 0!==t.icn3dui.cfg.cid?"https://www.ncbi.nlm.nih.gov/pccompound/?term=":Object.keys(t.structures).length>1?"https://www.ncbi.nlm.nih.gov/structure/?term=":t.icn3dui.htmlCls.baseUrl+"pdb/",void 0===t.inputid)s="https://www.ncbi.nlm.nih.gov/pccompound/?term="+t.molTitle;else{let i=t.inputid.split("_");1===i.length?(s+=t.inputid,e&&t.icn3dui.htmlCls.clickMenuCls.setLogCmd("link to Structure Summary "+t.inputid+": "+s,!1)):2===i.length&&(s+=i[0]+" OR "+i[1],e&&t.icn3dui.htmlCls.clickMenuCls.setLogCmd("link to structures "+i[0]+" and "+i[1]+": "+s,!1))}return s}setEntrezLinks(e){var t=this.icn3d;t.icn3dui;let s,i=Object.keys(t.structures);1===i.length?(s="https://www.ncbi.nlm.nih.gov/"+e+"/?term="+i[0],t.icn3dui.htmlCls.clickMenuCls.setLogCmd("Entrez "+e+" about PDB "+i[0]+": "+s,!1),window.open(s,"_blank")):2===i.length&&(s="https://www.ncbi.nlm.nih.gov/"+e+"/?term="+i[0]+" OR "+i[1],t.icn3dui.htmlCls.clickMenuCls.setLogCmd("Entrez "+e+" about PDB "+i[0]+" OR "+i[1]+": "+s,!1),window.open(s,"_blank"))}}class Ke{constructor(e){this.icn3dui=e}setLegendHtml(){let e=this.icn3dui.icn3d;return"<div style='height: 20px; background: linear-gradient(to right, "+(("red"==e.startColor?"#F00":"green"==e.startColor?"#0F0":"#00F")+" 0%, "+("white"==e.midColor?"#FFF":"#000")+" 50%, "+("red"==e.endColor?"#F00":"green"==e.endColor?"#0F0":"#00F")+" 100%")+");'></div><table width='100%' border='0' cellspacing='0' cellpadding='0'><tr><td width='33%'>"+e.startValue+"</td><td width='33%' align='center'>"+e.midValue+"</td><td width='33%' align='right'>"+e.endValue+"</td></tr></table>"}clickMenu1(){let e=this.icn3dui;if(e.icn3d,e.bNode)return;let t=this;e.myEventCls.onIds("#"+e.pre+"mn1_mmtfid","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_mmtfid","Please input MMTF ID")})),e.myEventCls.onIds("#"+e.pre+"mn1_pdbid","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_pdbid","Please input PDB ID")})),e.myEventCls.onIds("#"+e.pre+"mn1_opmid","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_opmid","Please input OPM PDB ID")})),e.myEventCls.onIds("#"+e.pre+"mn1_align","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_align","Align two 3D structures")})),e.myEventCls.onIds("#"+e.pre+"mn1_chainalign","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_chainalign","Align multiple chains of 3D structures")})),e.myEventCls.onIds("#"+e.pre+"mn1_mutation","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_mutation","Show the mutations in 3D")})),e.myEventCls.onIds("#"+e.pre+"mn1_pdbfile","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_pdbfile","Please input PDB File")})),e.myEventCls.onIds("#"+e.pre+"mn1_mol2file","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_mol2file","Please input Mol2 File")})),e.myEventCls.onIds("#"+e.pre+"mn1_sdffile","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_sdffile","Please input SDF File")})),e.myEventCls.onIds("#"+e.pre+"mn1_xyzfile","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_xyzfile","Please input XYZ File")})),e.myEventCls.onIds("#"+e.pre+"mn1_urlfile","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_urlfile","Load data by URL")})),e.myEventCls.onIds("#"+e.pre+"mn1_fixedversion","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_fixedversion","Open Share Link URL in the archived version of iCn3D")})),e.myEventCls.onIds("#"+e.pre+"reload_fixedversion","click",(function(s){e.icn3d;let i=$("#"+e.pre+"sharelinkurl").val();t.setLogCmd("open "+i,!1),localStorage.setItem("fixedversion","1"),window.open(i,"_blank")})),e.myEventCls.onIds("#"+e.pre+"mn1_mmciffile","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_mmciffile","Please input mmCIF File")})),e.myEventCls.onIds("#"+e.pre+"mn1_mmcifid","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_mmcifid","Please input mmCIF ID")})),e.myEventCls.onIds("#"+e.pre+"mn1_mmdbid","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_mmdbid","Please input MMDB or PDB ID")})),e.myEventCls.onIds("#"+e.pre+"mn1_blast_rep_id","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_blast_rep_id","Align sequence to structure")})),e.myEventCls.onIds("#"+e.pre+"mn1_gi","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_gi","Please input protein gi")})),e.myEventCls.onIds("#"+e.pre+"mn1_uniprotid","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_uniprotid","Please input UniProt ID")})),e.myEventCls.onIds("#"+e.pre+"mn1_cid","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_cid","Please input PubChem CID")})),e.myEventCls.onIds("#"+e.pre+"mn1_pngimage","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_pngimage","Please input the PNG image")})),e.myEventCls.onIds("#"+e.pre+"mn1_state","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_state","Please input the state file")})),e.myEventCls.onIds("#"+e.pre+"mn1_selection","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_selection","Please input the selection file")})),e.myEventCls.onIds("#"+e.pre+"mn1_dsn6","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_dsn6","Please input the DSN6 file to display electron density map")})),e.myEventCls.onIds(["#"+e.pre+"mn1_delphi","#"+e.pre+"mn1_delphi2"],"click",(function(t){e.icn3d.loadPhiFrom="delphi",$("#"+e.pre+"dl_delphi_tabs").tabs(),e.htmlCls.dialogCls.openDlg("dl_delphi","Please set parameters to display DelPhi potential map")})),e.myEventCls.onIds("#"+e.pre+"mn1_phi","click",(function(t){e.icn3d.loadPhiFrom="phi",$("#"+e.pre+"dl_phi_tabs").tabs(),$("#"+e.pre+"phitab1_tabs").tabs(),$("#"+e.pre+"phitab2_tabs").tabs(),e.htmlCls.dialogCls.openDlg("dl_phi","Please input local phi or cube file to display DelPhi potential map")})),e.myEventCls.onIds("#"+e.pre+"mn1_phiurl","click",(function(t){e.icn3d.loadPhiFrom="phiurl",$("#"+e.pre+"dl_phiurl_tabs").tabs(),$("#"+e.pre+"phiurltab1_tabs").tabs(),$("#"+e.pre+"phiurltab2_tabs").tabs(),e.htmlCls.dialogCls.openDlg("dl_phiurl","Please input URL phi or cube file to display DelPhi potential map")})),e.myEventCls.onIds("#"+e.pre+"mn1_dsn6url","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_dsn6url","Please input the DSN6 file to display electron density map")})),e.myEventCls.onIds("#"+e.pre+"mn1_exportState","click",(function(s){let i=e.icn3d;t.setLogCmd("export state file",!1);let l=i.inputid?i.inputid:"custom";i.saveFileCls.saveFile(l+"_statefile.txt","command")})),e.myEventCls.onIds("#"+e.pre+"mn1_exportPdbRes","click",(function(s){e.icn3d,e.htmlCls.setHtmlCls.exportPdb(),t.setLogCmd("export pdb",!0)})),e.myEventCls.onIds(["#"+e.pre+"delphipdb","#"+e.pre+"phipdb"],"click",(function(s){let i=e.icn3d,l=i.saveFileCls.getSelectedResiduePDB();t.setLogCmd("export PDB of selected residues",!1);let n=i.inputid?i.inputid:"custom";i.saveFileCls.saveFile(n+"_icn3d_residues.pdb","text",[l])})),e.myEventCls.onIds(["#"+e.pre+"delphipqr","#"+e.pre+"phipqr","#"+e.pre+"phiurlpqr"],"click",(function(s){e.icn3d,e.htmlCls.setHtmlCls.exportPqr(),t.setLogCmd("export pqr",!0)})),e.myEventCls.onIds("#"+e.pre+"mn1_exportStl","click",(function(s){let i=e.icn3d;t.setLogCmd("export stl file",!1),i.export3DCls.exportStlFile("")})),e.myEventCls.onIds("#"+e.pre+"mn1_exportVrml","click",(function(s){let i=e.icn3d;t.setLogCmd("export vrml file",!1),i.export3DCls.exportVrmlFile("")})),e.myEventCls.onIds("#"+e.pre+"mn1_exportStlStab","click",(function(s){let i=e.icn3d;t.setLogCmd("export stl stabilizer file",!1),i.threeDPrintCls.hideStabilizer(),i.threeDPrintCls.resetAfter3Dprint(),i.threeDPrintCls.addStabilizer(),i.export3DCls.exportStlFile("_stab")})),e.myEventCls.onIds("#"+e.pre+"mn1_exportVrmlStab","click",(function(s){let i=e.icn3d;t.setLogCmd("export vrml stabilizer file",!1),i.threeDPrintCls.hideStabilizer(),i.threeDPrintCls.resetAfter3Dprint(),i.threeDPrintCls.addStabilizer(),i.export3DCls.exportVrmlFile("_stab")})),e.myEventCls.onIds("#"+e.pre+"mn6_exportInteraction","click",(function(s){let i=e.icn3d;t.setLogCmd("export interactions",!1),void 0!==e.cfg.mmdbid&&i.viewInterPairsCls.retrieveInteractionData(),i.viewInterPairsCls.exportInteractions()})),e.myEventCls.onIds(["#"+e.pre+"mn1_exportCanvas","#"+e.pre+"saveimage"],"click",(function(s){let i=e.icn3d;t.setLogCmd("export canvas",!1);i.shareLinkCls.shareLink(!0)})),e.myEventCls.onIds("#"+e.pre+"mn1_exportCanvas2","click",(function(s){let i=e.icn3d;t.setLogCmd("export canvas 2",!1),i.scaleFactor=2,i.shareLinkCls.shareLink(!0)})),e.myEventCls.onIds("#"+e.pre+"mn1_exportCanvas4","click",(function(s){let i=e.icn3d;t.setLogCmd("export canvas 4",!1),i.scaleFactor=4,i.shareLinkCls.shareLink(!0)})),e.myEventCls.onIds("#"+e.pre+"mn1_exportCanvas8","click",(function(s){let i=e.icn3d;t.setLogCmd("export canvas 8",!1),i.scaleFactor=8,i.shareLinkCls.shareLink(!0)})),e.myEventCls.onIds("#"+e.pre+"mn1_exportCounts","click",(function(s){let i=e.icn3d;t.setLogCmd("export counts",!1);let l='<html><body><div style="text-align:center"><br><b>Total Count for atoms with coordinates</b>:<br/><table align=center border=1 cellpadding=10 cellspacing=0><tr><th>Structure Count</th><th>Chain Count</th><th>Residue Count</th><th>Atom Count</th></tr>';l+="<tr><td>"+Object.keys(i.structures).length+"</td><td>"+Object.keys(i.chains).length+"</td><td>"+Object.keys(i.residues).length+"</td><td>"+Object.keys(i.atoms).length+"</td></tr>",l+="</table><br/>",l+="<b>Counts by Chain for atoms with coordinates</b>:<br/><table align=center border=1 cellpadding=10 cellspacing=0><tr><th>Structure</th><th>Chain</th><th>Residue Count</th><th>Atom Count</th></tr>";let n=Object.keys(i.chains);for(let e=0,t=n.length;e<t;++e){let t=n[e],s=t.indexOf("_"),o=t.substr(0,s),r=t.substr(s+1),a={},d=i.chains[t];for(let e in d)a[i.atoms[e].resi]=1;l+="<tr><td>"+o+"</td><td>"+r+"</td><td>"+Object.keys(a).length+"</td><td>"+Object.keys(i.chains[t]).length+"</td></tr>"}l+="</table><br/></div></body></html>";let o=i.inputid?i.inputid:"custom";i.saveFileCls.saveFile(o+"_counts.html","html",l)})),e.myEventCls.onIds("#"+e.pre+"mn1_exportSelections","click",(function(s){let i=e.icn3d;if(t.setLogCmd("export all selections",!1),void 0===i.bSetChainsAdvancedMenu||!i.bSetChainsAdvancedMenu){let t=e.hashUtilsCls.cloneHash(i.hAtoms);i.definedSetsCls.setPredefinedInMenu(),i.bSetChainsAdvancedMenu=!0,i.hAtoms=e.hashUtilsCls.cloneHash(t)}let l=i.saveFileCls.exportCustomAtoms(),n=i.inputid?i.inputid:"custom";i.saveFileCls.saveFile(n+"_selections.txt","text",[l])})),e.myEventCls.onIds("#"+e.pre+"mn1_sharelink","click",(function(t){e.icn3d.shareLinkCls.shareLink()})),e.myEventCls.onIds("#"+e.pre+"mn1_replayon","click",(function(s){e.icn3d.resizeCanvasCls.replayon(),t.setLogCmd("replay on",!0)})),e.myEventCls.onIds("#"+e.pre+"mn1_replayoff","click",(function(s){e.icn3d.resizeCanvasCls.replayoff(),t.setLogCmd("replay off",!0)})),e.myEventCls.onIds("#"+e.pre+"mn1_link_structure","click",(function(t){let s=e.icn3d.saveFileCls.getLinkToStructureSummary(!0);window.open(s,"_blank")})),e.myEventCls.onIds("#"+e.pre+"mn1_link_bind","click",(function(s){let i=e.icn3d;url="https://www.ncbi.nlm.nih.gov/pccompound?LinkName=pccompound_structure&from_uid="+i.inputid,t.setLogCmd("link to 3D protein structures bound to CID "+i.inputid+": "+url,!1),window.open(url,"_blank")})),e.myEventCls.onIds("#"+e.pre+"mn1_link_vast","click",(function(s){let i=e.icn3d;if(void 0===i.inputid)url="https://www.ncbi.nlm.nih.gov/pccompound?term="+i.molTitle,t.setLogCmd("link to compounds "+i.molTitle+": "+url,!1);else{if(void 0!==e.cfg.cid)url="https://www.ncbi.nlm.nih.gov/pccompound?LinkName=pccompound_pccompound_3d&from_uid="+i.inputid,t.setLogCmd("link to compounds with structure similar to CID "+i.inputid+": "+url,!1);else{let s,l=i.inputid.split("_");1===l.length?(s=e.htmlCls.baseUrl+"vastplus/vastplus.cgi?uid="+i.inputid,t.setLogCmd("link to structures similar to "+i.inputid+": "+s,!1)):2===l.length&&(s=e.htmlCls.baseUrl+"vastplus/vastplus.cgi?uid="+l[0],t.setLogCmd("link to structures similar to "+l[0]+": "+s,!1))}window.open(url,"_blank")}})),e.myEventCls.onIds("#"+e.pre+"mn1_link_pubmed","click",(function(s){let i=e.icn3d;if(void 0===i.inputid){let e;e="https://www.ncbi.nlm.nih.gov/pubmed/?term="+i.molTitle,t.setLogCmd("link to literature about "+i.molTitle+": "+e,!1),window.open(e,"_blank")}else if(i.pmid){let e,s=i.pmid.toString().split("_");1===s.length?(e="https://www.ncbi.nlm.nih.gov/pubmed/"+i.pmid,t.setLogCmd("link to PubMed ID "+i.pmid+": "+e,!1)):2===s.length&&(e="https://www.ncbi.nlm.nih.gov/pubmed/?term="+s[0]+" OR "+s[1],t.setLogCmd("link to PubMed IDs "+s[0]+", "+s[1]+": "+e,!1)),window.open(e,"_blank")}else if(isNaN(i.inputid)){let e,s=i.inputid.toString().split("_");1===s.length?(e="https://www.ncbi.nlm.nih.gov/pubmed/?term="+i.inputid,t.setLogCmd("link to literature about PDB "+i.inputid+": "+e,!1)):2===s.length&&(e="https://www.ncbi.nlm.nih.gov/pubmed/?term="+s[0]+" OR "+s[1],t.setLogCmd("link to literature about PDB "+s[0]+" OR "+s[1]+": "+e,!1)),window.open(e,"_blank")}else void 0!==e.cfg.cid?alert("No literature information is available for this compound in the SDF file."):alert("No literature information is available for this structure.")})),e.myEventCls.onIds("#"+e.pre+"mn1_link_protein","click",(function(s){let i=e.icn3d,l=Object.keys(i.structures),n=Object.keys(i.chains),o="";for(let e=0,t=n.length;e<t;++e){let t=i.firstAtomObjCls.getFirstCalphaAtomObj(i.chains[n[e]]);i.proteins.hasOwnProperty(t.serial)&&6==n[e].length&&(o+=n[e]+"[accession] OR ")}o.length>0&&(o=o.substr(0,o.length-4));let r="https://www.ncbi.nlm.nih.gov/protein/?term="+o;t.setLogCmd("link to Entrez protein about PDB "+l+": "+r,!1),window.open(r,"_blank")}))}clickMenu2(){let e=this.icn3dui;if(e.icn3d,e.bNode)return;let t=this;e.myEventCls.onIds("#"+e.pre+"mn6_selectannotations","click",(function(s){e.icn3d.showAnnoCls.showAnnotations(),t.setLogCmd("view annotations",!0)})),e.myEventCls.onIds("#"+e.pre+"mn2_selectall","click",(function(s){let i=e.icn3d;t.setLogCmd("select all",!0),i.selectionCls.selectAll(),i.hlUpdateCls.removeHlAll(),i.drawCls.draw()})),e.myEventCls.onIds("#"+e.pre+"clearall","click",(function(s){let i=e.icn3d;t.setLogCmd("clear all",!0),i.bSelectResidue=!1,i.selectionCls.selectAll(),i.hlUpdateCls.removeHlAll(),i.drawCls.draw()})),e.myEventCls.onIds("#"+e.pre+"mn2_selectdisplayed","click",(function(s){let i=e.icn3d;t.setLogCmd("select displayed set",!0),i.hAtoms=e.hashUtilsCls.cloneHash(i.dAtoms),i.hlUpdateCls.updateHlAll()})),e.myEventCls.onIds("#"+e.pre+"mn2_fullstru","click",(function(s){let i=e.icn3d;t.setLogCmd("show all",!0),i.selectionCls.showAll()})),e.myEventCls.onIds("#"+e.pre+"mn2_selectcomplement","click",(function(s){let i=e.icn3d;Object.keys(i.hAtoms).length<Object.keys(i.atoms).length&&(t.setLogCmd("select complement",!0),i.resid2specCls.selectComplement())})),e.myEventCls.onIds("#"+e.pre+"mn2_selectmainchains","click",(function(s){let i=e.icn3d;t.setLogCmd("select main chains",!0),i.selectionCls.selectMainChains()})),e.myEventCls.onIds("#"+e.pre+"mn2_selectsidechains","click",(function(s){let i=e.icn3d;t.setLogCmd("select side chains",!0),i.selectionCls.selectSideChains()})),e.myEventCls.onIds("#"+e.pre+"mn2_selectmainsidechains","click",(function(s){let i=e.icn3d;t.setLogCmd("select main side chains",!0),i.selectionCls.selectMainSideChains()})),e.myEventCls.onIds("#"+e.pre+"mn2_propPos","click",(function(s){let i=e.icn3d;t.setLogCmd("select prop positive",!0),i.resid2specCls.selectProperty("positive")})),e.myEventCls.onIds("#"+e.pre+"mn2_propNeg","click",(function(s){let i=e.icn3d;t.setLogCmd("select prop negative",!0),i.resid2specCls.selectProperty("negative")})),e.myEventCls.onIds("#"+e.pre+"mn2_propHydro","click",(function(s){let i=e.icn3d;t.setLogCmd("select prop hydrophobic",!0),i.resid2specCls.selectProperty("hydrophobic")})),e.myEventCls.onIds("#"+e.pre+"mn2_propPolar","click",(function(s){let i=e.icn3d;t.setLogCmd("select prop polar",!0),i.resid2specCls.selectProperty("polar")})),e.myEventCls.onIds("#"+e.pre+"mn2_propBfactor","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_propbybfactor","Select residue based on B-factor")})),e.myEventCls.onIds("#"+e.pre+"mn2_propSolAcc","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_propbypercentout","Select residue based on the percentage of solvent accessilbe surface area")})),e.myEventCls.onIds("#"+e.pre+"applypropbybfactor","click",(function(s){let i=e.icn3d,l=$("#"+e.pre+"minbfactor").val(),n=$("#"+e.pre+"maxbfactor").val();t.setLogCmd("select prop b factor | "+l+"_"+n,!0),i.resid2specCls.selectProperty("b factor",l,n)})),e.myEventCls.onIds("#"+e.pre+"applypropbypercentout","click",(function(s){let i=e.icn3d,l=$("#"+e.pre+"minpercentout").val(),n=$("#"+e.pre+"maxpercentout").val();t.setLogCmd("select prop percent out | "+l+"_"+n,!0),i.resid2specCls.selectProperty("percent out",l,n)})),e.myEventCls.onIds("#"+e.pre+"mn2_alignment","click",(function(s){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_alignment","Select residues in aligned sequences"),t.setLogCmd("window aligned sequences",!0)})),e.myEventCls.onIds("#"+e.pre+"mn1_window_table","click",(function(s){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_allinteraction","Show interactions"),t.setLogCmd("window interaction table",!0)})),e.myEventCls.onIds("#"+e.pre+"mn1_window_linegraph","click",(function(s){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_linegraph","Show interactions between two lines of residue nodes"),t.setLogCmd("window interaction graph",!0)})),e.myEventCls.onIds("#"+e.pre+"mn1_window_scatterplot","click",(function(s){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_scatterplot","Show interactions as map"),t.setLogCmd("window interaction scatterplot",!0)})),e.myEventCls.onIds("#"+e.pre+"mn1_window_graph","click",(function(s){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_graph","Force-directed graph"),t.setLogCmd("window force-directed graph",!0)})),e.myEventCls.onIds("#"+e.pre+"mn6_yournote","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_yournote","Your note about the current display")})),e.myEventCls.onIds("#"+e.pre+"applyyournote","click",(function(s){let i=e.icn3d;i.yournote=$("#"+e.pre+"yournote").val(),i.icn3dui.cfg.shownote&&(document.title=i.yournote),e.cfg.notebook||dialog.dialog("close"),t.setLogCmd("your note | "+i.yournote,!0)})),e.myEventCls.onIds("#"+e.pre+"mn2_command","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_advanced2","Select by specification")})),e.myEventCls.onIds(["#"+e.pre+"mn2_definedsets","#"+e.pre+"definedsets","#"+e.pre+"definedsets2"],"click",(function(s){e.icn3d.definedSetsCls.showSets(),t.setLogCmd("defined sets",!0)})),e.myEventCls.onIds("#"+e.pre+"setOr","click",(function(t){e.icn3d.setOperation="or"})),e.myEventCls.onIds("#"+e.pre+"setAnd","click",(function(t){e.icn3d.setOperation="and"})),e.myEventCls.onIds("#"+e.pre+"setNot","click",(function(t){e.icn3d.setOperation="not"})),e.myEventCls.onIds("#"+e.pre+"mn2_pkNo","click",(function(s){let i=e.icn3d;i.pk=0,i.opts.pk="no",t.setLogCmd("set pk off",!0),i.drawCls.draw(),i.hlObjectsCls.removeHlObjects()})),e.myEventCls.onIds("#"+e.pre+"mn2_pkYes","click",(function(s){let i=e.icn3d;i.pk=1,i.opts.pk="atom",t.setLogCmd("set pk atom",!0)})),e.myEventCls.onIds("#"+e.pre+"mn2_pkResidue","click",(function(s){let i=e.icn3d;i.pk=2,i.opts.pk="residue",t.setLogCmd("set pk residue",!0)})),e.myEventCls.onIds("#"+e.pre+"mn2_pkStrand","click",(function(s){let i=e.icn3d;i.pk=3,i.opts.pk="strand",t.setLogCmd("set pk strand",!0)})),e.myEventCls.onIds("#"+e.pre+"mn2_pkDomain","click",(function(s){let i=e.icn3d;i.pk=4,i.opts.pk="domain",t.setLogCmd("set pk domain",!0)})),e.myEventCls.onIds("#"+e.pre+"mn2_pkChain","click",(function(s){let i=e.icn3d;i.pk=5,i.opts.pk="chain",t.setLogCmd("set pk chain",!0)})),e.myEventCls.onIds("#"+e.pre+"adjustmem","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_adjustmem","Adjust the Z-axis positions of the membrane")})),e.myEventCls.onIds("#"+e.pre+"togglemem","click",(function(s){e.icn3d.selectionCls.toggleMembrane(),t.setLogCmd("toggle membrane",!0)})),e.myEventCls.onIds("#"+e.pre+"selectplane","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_selectplane","Select a region between two planes")})),e.myEventCls.onIds("#"+e.pre+"mn2_aroundsphere","click",(function(t){let s=e.icn3d;if(void 0===s.bSetChainsAdvancedMenu||!s.bSetChainsAdvancedMenu){let t=e.hashUtilsCls.cloneHash(s.hAtoms);s.definedSetsCls.setPredefinedInMenu(),s.bSetChainsAdvancedMenu=!0,s.hAtoms=e.hashUtilsCls.cloneHash(t)}let i=s.definedSetsCls.setAtomMenu(["protein"]);$("#"+e.pre+"atomsCustomSphere").length&&$("#"+e.pre+"atomsCustomSphere").html("  <option value='non-selected' selected>non-selected</option><option value='selected'>selected</option>"+i),$("#"+e.pre+"atomsCustomSphere2").length&&$("#"+e.pre+"atomsCustomSphere2").html("  <option value='selected' selected>selected</option>"+i),e.htmlCls.dialogCls.openDlg("dl_aroundsphere","Select a sphere around a set of residues"),s.bSphereCalc=!1,$("#"+e.pre+"atomsCustomSphere").resizable(),$("#"+e.pre+"atomsCustomSphere2").resizable()})),e.myEventCls.onIds(["#"+e.pre+"mn2_select_chain","#"+e.pre+"definedSets"],"click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_select_chain","Select Structure/Chain/Custom Selection")}))}clickMenu3(){let e=this.icn3dui;if(e.icn3d,e.bNode)return;let t=this;e.myEventCls.onIds("#"+e.pre+"mn3_proteinsRibbon","click",(function(s){e.icn3d.setOptionCls.setStyle("proteins","ribbon"),t.setLogCmd("style proteins ribbon",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_proteinsStrand","click",(function(s){e.icn3d.setOptionCls.setStyle("proteins","strand"),t.setLogCmd("style proteins strand",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_proteinsCylinder","click",(function(s){e.icn3d.setOptionCls.setStyle("proteins","cylinder and plate"),t.setLogCmd("style proteins cylinder and plate",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_proteinsSchematic","click",(function(s){e.icn3d.setOptionCls.setStyle("proteins","schematic"),t.setLogCmd("style proteins schematic",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_proteinsCalpha","click",(function(s){e.icn3d.setOptionCls.setStyle("proteins","c alpha trace"),t.setLogCmd("style proteins c alpha trace",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_proteinsBackbone","click",(function(s){e.icn3d.setOptionCls.setStyle("proteins","backbone"),t.setLogCmd("style proteins backbone",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_proteinsBfactor","click",(function(s){e.icn3d.setOptionCls.setStyle("proteins","b factor tube"),t.setLogCmd("style proteins b factor tube",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_proteinsLines","click",(function(s){e.icn3d.setOptionCls.setStyle("proteins","lines"),t.setLogCmd("style proteins lines",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_proteinsStick","click",(function(s){e.icn3d.setOptionCls.setStyle("proteins","stick"),t.setLogCmd("style proteins stick",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_proteinsBallstick","click",(function(s){e.icn3d.setOptionCls.setStyle("proteins","ball and stick"),t.setLogCmd("style proteins ball and stick",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_proteinsSphere","click",(function(s){e.icn3d.setOptionCls.setStyle("proteins","sphere"),t.setLogCmd("style proteins sphere",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_proteinsNo","click",(function(s){e.icn3d.setOptionCls.setStyle("proteins","nothing"),t.setLogCmd("style proteins nothing",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_sidecLines","click",(function(s){e.icn3d.setOptionCls.setStyle("sidec","lines"),t.setLogCmd("style sidec lines",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_sidecStick","click",(function(s){e.icn3d.setOptionCls.setStyle("sidec","stick"),t.setLogCmd("style sidec stick",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_sidecBallstick","click",(function(s){e.icn3d.setOptionCls.setStyle("sidec","ball and stick"),t.setLogCmd("style sidec ball and stick",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_sidecSphere","click",(function(s){e.icn3d.setOptionCls.setStyle("sidec","sphere"),t.setLogCmd("style sidec sphere",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_sidecNo","click",(function(s){e.icn3d.setOptionCls.setStyle("sidec","nothing"),t.setLogCmd("style sidec nothing",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_nuclCartoon","click",(function(s){e.icn3d.setOptionCls.setStyle("nucleotides","nucleotide cartoon"),t.setLogCmd("style nucleotides nucleotide cartoon",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_nuclBackbone","click",(function(s){e.icn3d.setOptionCls.setStyle("nucleotides","backbone"),t.setLogCmd("style nucleotides backbone",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_nuclSchematic","click",(function(s){e.icn3d.setOptionCls.setStyle("nucleotides","schematic"),t.setLogCmd("style nucleotides schematic",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_nuclPhos","click",(function(s){e.icn3d.setOptionCls.setStyle("nucleotides","o3 trace"),t.setLogCmd("style nucleotides o3 trace",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_nuclLines","click",(function(s){e.icn3d.setOptionCls.setStyle("nucleotides","lines"),t.setLogCmd("style nucleotides lines",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_nuclStick","click",(function(s){e.icn3d.setOptionCls.setStyle("nucleotides","stick"),t.setLogCmd("style nucleotides stick",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_nuclBallstick","click",(function(s){e.icn3d.setOptionCls.setStyle("nucleotides","ball and stick"),t.setLogCmd("style nucleotides ball and stick",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_nuclSphere","click",(function(s){e.icn3d.setOptionCls.setStyle("nucleotides","sphere"),t.setLogCmd("style nucleotides sphere",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_nuclNo","click",(function(s){e.icn3d.setOptionCls.setStyle("nucleotides","nothing"),t.setLogCmd("style nucleotides nothing",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_ligLines","click",(function(s){e.icn3d.setOptionCls.setStyle("chemicals","lines"),t.setLogCmd("style chemicals lines",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_ligStick","click",(function(s){e.icn3d.setOptionCls.setStyle("chemicals","stick"),t.setLogCmd("style chemicals stick",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_ligBallstick","click",(function(s){e.icn3d.setOptionCls.setStyle("chemicals","ball and stick"),t.setLogCmd("style chemicals ball and stick",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_ligSchematic","click",(function(s){e.icn3d.setOptionCls.setStyle("chemicals","schematic"),t.setLogCmd("style chemicals schematic",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_ligSphere","click",(function(s){e.icn3d.setOptionCls.setStyle("chemicals","sphere"),t.setLogCmd("style chemicals sphere",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_ligNo","click",(function(s){e.icn3d.setOptionCls.setStyle("chemicals","nothing"),t.setLogCmd("style chemicals nothing",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_glycansCartYes","click",(function(s){let i=e.icn3d;i.bGlycansCartoon=!0,i.drawCls.draw(),t.setLogCmd("glycans cartoon yes",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_glycansCartNo","click",(function(s){let i=e.icn3d;i.bGlycansCartoon=!1,i.drawCls.draw(),t.setLogCmd("glycans cartoon no",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_hydrogensYes","click",(function(s){let i=e.icn3d;i.showInterCls.showHydrogens(),i.drawCls.draw(),t.setLogCmd("hydrogens",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_hydrogensNo","click",(function(s){let i=e.icn3d;i.showInterCls.hideHydrogens(),i.drawCls.draw(),t.setLogCmd("set hydrogens off",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_ionsSphere","click",(function(s){e.icn3d.setOptionCls.setStyle("ions","sphere"),t.setLogCmd("style ions sphere",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_ionsDot","click",(function(s){e.icn3d.setOptionCls.setStyle("ions","dot"),t.setLogCmd("style ions dot",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_ionsNo","click",(function(s){e.icn3d.setOptionCls.setStyle("ions","nothing"),t.setLogCmd("style ions nothing",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_waterSphere","click",(function(s){e.icn3d.setOptionCls.setStyle("water","sphere"),t.setLogCmd("style water sphere",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_waterDot","click",(function(s){e.icn3d.setOptionCls.setStyle("water","dot"),t.setLogCmd("style water dot",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_waterNo","click",(function(s){e.icn3d.setOptionCls.setStyle("water","nothing"),t.setLogCmd("style water nothing",!0)}))}clickMenu4(){let e=this.icn3dui;if(e.icn3d,e.bNode)return;let t=this;e.myEventCls.onIds("#"+e.pre+"mn4_clrSpectrum","click",(function(s){e.icn3d.setOptionCls.setOption("color","spectrum"),t.setLogCmd("color spectrum",!0)})),e.myEventCls.onIds("#"+e.pre+"mn4_clrChain","click",(function(s){e.icn3d.setOptionCls.setOption("color","chain"),t.setLogCmd("color chain",!0)})),e.myEventCls.onIds("#"+e.pre+"mn4_clrdomain","click",(function(s){e.icn3d.setOptionCls.setOption("color","domain"),t.setLogCmd("color domain",!0)})),e.myEventCls.onIds("#"+e.pre+"mn4_clrSSGreen","click",(function(s){let i=e.icn3d;i.sheetcolor="green",i.setOptionCls.setOption("color","secondary structure green"),t.setLogCmd("color secondary structure green",!0)})),e.myEventCls.onIds("#"+e.pre+"mn4_clrSSYellow","click",(function(s){let i=e.icn3d;i.sheetcolor="yellow",i.setOptionCls.setOption("color","secondary structure yellow"),t.setLogCmd("color secondary structure yellow",!0)})),e.myEventCls.onIds("#"+e.pre+"mn4_clrSSSpectrum","click",(function(s){e.icn3d.setOptionCls.setOption("color","secondary structure spectrum"),t.setLogCmd("color secondary structure spectrum",!0)})),e.myEventCls.onIds("#"+e.pre+"mn4_clrResidue","click",(function(s){e.icn3d.setOptionCls.setOption("color","residue"),t.setLogCmd("color residue",!0)})),e.myEventCls.onIds("#"+e.pre+"mn4_clrResidueCustom","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_rescolorfile","Please input the file on residue colors")})),e.myEventCls.onIds("#"+e.pre+"reload_rescolorfile","click",(function(s){let i=e.icn3d;s.preventDefault(),e.cfg.notebook||dialog.dialog("close");let l=$("#"+e.pre+"rescolorfile")[0].files[0];if(l){e.htmlCls.setHtmlCls.fileSupport();let s=new FileReader;s.onload=function(s){let l=s.target.result.replace(/#/g,"");i.customResidueColors=JSON.parse(l);for(let t in i.customResidueColors)i.customResidueColors[t.toUpperCase()]=e.parasCls.thr("#"+i.customResidueColors[t]);i.setOptionCls.setOption("color","residue custom"),t.setLogCmd("color residue custom | "+l,!0)},s.readAsText(l)}else alert("Please select a file before clicking 'Load'")})),e.myEventCls.onIds("#"+e.pre+"reload_customcolorfile","click",(function(s){let i=e.icn3d;s.preventDefault(),e.cfg.notebook||dialog.dialog("close"),i.startColor=$("#"+e.pre+"startColor").val(),i.midColor=$("#"+e.pre+"midColor").val(),i.endColor=$("#"+e.pre+"endColor").val();let l=t.setLegendHtml();$("#"+e.pre+"legend").html(l).show(),i.addTrackCls.setCustomFile("color",i.startColor,i.midColor,i.endColor)})),e.myEventCls.onIds("#"+e.pre+"remove_legend","click",(function(s){e.icn3d,s.preventDefault(),$("#"+e.pre+"legend").hide(),t.setLogCmd("remove legend",!0)})),e.myEventCls.onIds("#"+e.pre+"reload_customtubefile","click",(function(t){let s=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),s.addTrackCls.setCustomFile("tube")})),e.myEventCls.onIds("#"+e.pre+"mn4_clrCharge","click",(function(s){e.icn3d.setOptionCls.setOption("color","charge"),t.setLogCmd("color charge",!0)})),e.myEventCls.onIds("#"+e.pre+"mn4_clrHydrophobic","click",(function(s){e.icn3d.setOptionCls.setOption("color","hydrophobic"),t.setLogCmd("color hydrophobic",!0)})),e.myEventCls.onIds("#"+e.pre+"mn4_clrAtom","click",(function(s){e.icn3d.setOptionCls.setOption("color","atom"),t.setLogCmd("color atom",!0)})),e.myEventCls.onIds("#"+e.pre+"mn4_clrBfactor","click",(function(s){e.icn3d.setOptionCls.setOption("color","b factor"),t.setLogCmd("color b factor",!0)})),e.myEventCls.onIds("#"+e.pre+"mn4_clrArea","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_colorbyarea","Color based on residue's solvent accessibility")})),e.myEventCls.onIds("#"+e.pre+"applycolorbyarea","click",(function(s){let i=e.icn3d;i.midpercent=$("#"+e.pre+"midpercent").val(),i.setOptionCls.setOption("color","area"),t.setLogCmd("color area | "+i.midpercent,!0)})),e.myEventCls.onIds("#"+e.pre+"mn4_clrBfactorNorm","click",(function(s){e.icn3d.setOptionCls.setOption("color","b factor percentile"),t.setLogCmd("color b factor percentile",!0)})),e.myEventCls.onIds("#"+e.pre+"mn4_clrIdentity","click",(function(s){e.icn3d.setOptionCls.setOption("color","identity"),t.setLogCmd("color identity",!0)})),e.myEventCls.onIds("#"+e.pre+"mn4_clrConserved","click",(function(s){e.icn3d.setOptionCls.setOption("color","conservation"),t.setLogCmd("color conservation",!0)})),e.myEventCls.onIds("#"+e.pre+"mn4_clrCustom","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_clr","Color picker")})),$(document).on("click",".icn3d-color-rad-text",(function(s){let i=e.icn3d;s.stopImmediatePropagation();let l=$(this).attr("color");i.setOptionCls.setOption("color",l),t.setLogCmd("color "+l,!0)})),e.myEventCls.onIds("#"+e.pre+"mn4_clrSave","click",(function(s){e.icn3d.setOptionCls.saveColor(),t.setLogCmd("save color",!0)})),e.myEventCls.onIds("#"+e.pre+"mn4_clrApplySave","click",(function(s){e.icn3d.setOptionCls.applySavedColor(),t.setLogCmd("apply saved color",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_styleSave","click",(function(s){e.icn3d.setOptionCls.saveStyle(),t.setLogCmd("save style",!0)})),e.myEventCls.onIds("#"+e.pre+"mn3_styleApplySave","click",(function(s){e.icn3d.setOptionCls.applySavedStyle(),t.setLogCmd("apply saved style",!0)}))}clickMenu5(){let e=this.icn3dui;if(e.icn3d,e.bNode)return;let t=this;e.myEventCls.onIds("#"+e.pre+"mn5_neighborsYes","click",(function(s){let i=e.icn3d;i.bConsiderNeighbors=!0,i.applyMapCls.removeLastSurface(),i.applyMapCls.applySurfaceOptions(),i.bRender&&i.drawCls.render(),t.setLogCmd("set surface neighbors on",!0)})),e.myEventCls.onIds("#"+e.pre+"mn5_neighborsNo","click",(function(s){let i=e.icn3d;i.bConsiderNeighbors=!1,i.applyMapCls.removeLastSurface(),i.applyMapCls.applySurfaceOptions(),i.bRender&&i.drawCls.render(),t.setLogCmd("set surface neighbors off",!0)})),e.myEventCls.onIds("#"+e.pre+"mn5_surfaceVDW","click",(function(s){let i=e.icn3d;i.bConsiderNeighbors=!1,i.setOptionCls.setOption("surface","Van der Waals surface"),t.setLogCmd("set surface Van der Waals surface",!0)})),e.myEventCls.onIds("#"+e.pre+"mn5_surfaceSAS","click",(function(s){let i=e.icn3d;i.bConsiderNeighbors=!1,i.setOptionCls.setOption("surface","solvent accessible surface"),t.setLogCmd("set surface solvent accessible surface",!0)})),e.myEventCls.onIds("#"+e.pre+"mn5_surfaceMolecular","click",(function(s){let i=e.icn3d;i.bConsiderNeighbors=!1,i.setOptionCls.setOption("surface","molecular surface"),t.setLogCmd("set surface molecular surface",!0)})),e.myEventCls.onIds("#"+e.pre+"mn5_surfaceVDWContext","click",(function(s){let i=e.icn3d;i.bConsiderNeighbors=!0,i.setOptionCls.setOption("surface","Van der Waals surface with context"),t.setLogCmd("set surface Van der Waals surface with context",!0)})),e.myEventCls.onIds("#"+e.pre+"mn5_surfaceSASContext","click",(function(s){let i=e.icn3d;i.bConsiderNeighbors=!0,i.setOptionCls.setOption("surface","solvent accessible surface with context"),t.setLogCmd("set surface solvent accessible surface with context",!0)})),e.myEventCls.onIds("#"+e.pre+"mn5_surfaceMolecularContext","click",(function(s){let i=e.icn3d;i.bConsiderNeighbors=!0,i.setOptionCls.setOption("surface","molecular surface with context"),t.setLogCmd("set surface molecular surface with context",!0)})),e.myEventCls.onIds("#"+e.pre+"mn5_surfaceNo","click",(function(s){e.icn3d.setOptionCls.setOption("surface","nothing"),t.setLogCmd("set surface nothing",!0)})),$(document).on("click","."+e.pre+"mn5_opacity",(function(s){let i=e.icn3d,l=$(this).attr("v");i.setOptionCls.setOption("opacity",l),t.setLogCmd("set surface opacity "+l,!0)})),e.myEventCls.onIds("#"+e.pre+"mn5_wireframeYes","click",(function(s){e.icn3d.setOptionCls.setOption("wireframe","yes"),t.setLogCmd("set surface wireframe on",!0)})),e.myEventCls.onIds("#"+e.pre+"mn5_wireframeNo","click",(function(s){e.icn3d.setOptionCls.setOption("wireframe","no"),t.setLogCmd("set surface wireframe off",!0)})),e.myEventCls.onIds("#"+e.pre+"mn5_elecmap2fofc","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_elecmap2fofc","2Fo-Fc Electron Density Map")})),e.myEventCls.onIds("#"+e.pre+"mn5_elecmapfofc","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_elecmapfofc","Fo-Fc Electron Density Map")})),e.myEventCls.onIds(["#"+e.pre+"mn5_elecmapNo","#"+e.pre+"elecmapNo2","#"+e.pre+"elecmapNo3","#"+e.pre+"elecmapNo4","#"+e.pre+"elecmapNo5"],"click",(function(s){e.icn3d.setOptionCls.setOption("map","nothing"),t.setLogCmd("setoption map nothing",!0)})),e.myEventCls.onIds(["#"+e.pre+"delphimapNo","#"+e.pre+"phimapNo","#"+e.pre+"phiurlmapNo","#"+e.pre+"mn1_phimapNo"],"click",(function(s){e.icn3d.setOptionCls.setOption("phimap","nothing"),t.setLogCmd("setoption phimap nothing",!0)})),e.myEventCls.onIds(["#"+e.pre+"delphimapNo2","#"+e.pre+"phimapNo2","#"+e.pre+"phiurlmapNo2"],"click",(function(s){e.icn3d.setOptionCls.setOption("phisurface","nothing"),t.setLogCmd("setoption phisurface nothing",!0)})),e.myEventCls.onIds("#"+e.pre+"applymap2fofc","click",(function(s){let i=e.icn3d;s.preventDefault();let l=parseFloat($("#"+e.pre+"sigma2fofc").val());i.dsn6ParserCls.dsn6Parser(i.inputid,"2fofc",l),t.setLogCmd("set map 2fofc sigma "+l,!0)})),e.myEventCls.onIds("#"+e.pre+"applymapfofc","click",(function(s){let i=e.icn3d;s.preventDefault();let l=parseFloat($("#"+e.pre+"sigmafofc").val());i.dsn6ParserCls.dsn6Parser(i.inputid,"fofc",l),t.setLogCmd("set map fofc sigma "+l,!0)})),e.myEventCls.onIds("#"+e.pre+"mn5_mapwireframeYes","click",(function(s){e.icn3d.setOptionCls.setOption("mapwireframe","yes"),t.setLogCmd("set map wireframe on",!0)})),e.myEventCls.onIds("#"+e.pre+"mn5_mapwireframeNo","click",(function(s){e.icn3d.setOptionCls.setOption("mapwireframe","no"),t.setLogCmd("set map wireframe off",!0)})),e.myEventCls.onIds("#"+e.pre+"mn5_emmap","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_emmap","EM Density Map")})),e.myEventCls.onIds(["#"+e.pre+"mn5_emmapNo","#"+e.pre+"emmapNo2"],"click",(function(s){e.icn3d.setOptionCls.setOption("emmap","nothing"),t.setLogCmd("setoption emmap nothing",!0)})),e.myEventCls.onIds("#"+e.pre+"applyemmap","click",(function(s){let i=e.icn3d;s.preventDefault();let l=parseFloat($("#"+e.pre+"empercentage").val());i.densityCifParserCls.densityCifParser(i.inputid,"em",l,i.emd),t.setLogCmd("set emmap percentage "+l,!0)})),e.myEventCls.onIds("#"+e.pre+"mn5_emmapwireframeYes","click",(function(s){e.icn3d.setOptionCls.setOption("emmapwireframe","yes"),t.setLogCmd("set emmap wireframe on",!0)})),e.myEventCls.onIds("#"+e.pre+"mn5_emmapwireframeNo","click",(function(s){e.icn3d.setOptionCls.setOption("emmapwireframe","no"),t.setLogCmd("set emmap wireframe off",!0)}))}clickMenu6(){let e=this.icn3dui;if(e.icn3d,e.bNode)return;let t=this;e.myEventCls.onIds("#"+e.pre+"mn6_assemblyYes","click",(function(s){let i=e.icn3d;i.bAssembly=!0,t.setLogCmd("set assembly on",!0),i.drawCls.draw()})),e.myEventCls.onIds("#"+e.pre+"mn6_assemblyNo","click",(function(s){let i=e.icn3d;i.bAssembly=!1,t.setLogCmd("set assembly off",!0),i.drawCls.draw()})),e.myEventCls.onIds("#"+e.pre+"mn6_addlabelAtoms","click",(function(s){let i=e.icn3d;i.residueLabelsCls.addAtomLabels(i.hAtoms),i.selectionCls.saveSelectionIfSelected(),t.setLogCmd("add atom labels",!0),i.drawCls.draw()})),e.myEventCls.onIds("#"+e.pre+"mn6_addlabelResidues","click",(function(s){let i=e.icn3d;i.residueLabelsCls.addResidueLabels(i.hAtoms),i.selectionCls.saveSelectionIfSelected(),t.setLogCmd("add residue labels",!0),i.drawCls.draw()})),e.myEventCls.onIds("#"+e.pre+"mn6_addlabelResnum","click",(function(s){let i=e.icn3d;i.residueLabelsCls.addResidueLabels(i.hAtoms,void 0,void 0,!0),i.selectionCls.saveSelectionIfSelected(),t.setLogCmd("add residue number labels",!0),i.drawCls.draw()})),e.myEventCls.onIds("#"+e.pre+"mn6_addlabelChains","click",(function(s){let i=e.icn3d;i.analysisCls.addChainLabels(i.hAtoms),i.selectionCls.saveSelectionIfSelected(),t.setLogCmd("add chain labels",!0),i.drawCls.draw()})),e.myEventCls.onIds("#"+e.pre+"mn6_addlabelTermini","click",(function(s){let i=e.icn3d;i.analysisCls.addTerminiLabels(i.hAtoms),i.selectionCls.saveSelectionIfSelected(),t.setLogCmd("add terminal labels",!0),i.drawCls.draw()})),e.myEventCls.onIds("#"+e.pre+"mn6_addlabelYes","click",(function(t){let s=e.icn3d;e.htmlCls.dialogCls.openDlg("dl_addlabel","Add custom labels by selection"),s.pk=1,s.opts.pk="atom",s.pickpair=!0,s.pAtomNum=0})),e.myEventCls.onIds("#"+e.pre+"mn6_addlabelSelection","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_addlabelselection","Add custom labels by the selected")})),e.myEventCls.onIds("#"+e.pre+"mn2_saveselection","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_saveselection","Save the selected")})),e.myEventCls.onIds(["#"+e.pre+"mn6_addlabelNo","#"+e.pre+"removeLabels"],"click",(function(s){let i=e.icn3d;i.pickpair=!1;t.setLogCmd("set labels off",!0);for(let e in i.labels)i.labels[e]=[];i.drawCls.draw()})),$(document).on("click","."+e.pre+"mn6_labelscale",(function(s){let i=e.icn3d,l=$(this).attr("v");i.labelScale=l,i.drawCls.draw(),t.setLogCmd("set label scale "+l,!0)})),e.myEventCls.onIds("#"+e.pre+"mn6_distanceYes","click",(function(t){let s=e.icn3d;e.htmlCls.dialogCls.openDlg("dl_distance","Measure the distance of atoms"),s.pk=1,s.opts.pk="atom",s.pickpair=!0,s.pAtomNum=0,s.bMeasureDistance=!0})),e.myEventCls.onIds("#"+e.pre+"mn6_distTwoSets","click",(function(t){let s=e.icn3d;if(e.htmlCls.dialogCls.openDlg("dl_disttwosets","Measure the distance between two sets"),void 0===s.bSetChainsAdvancedMenu||!s.bSetChainsAdvancedMenu){let t=e.hashUtilsCls.cloneHash(s.hAtoms);s.definedSetsCls.setPredefinedInMenu(),s.bSetChainsAdvancedMenu=!0,s.hAtoms=e.hashUtilsCls.cloneHash(t)}let i=s.definedSetsCls.setAtomMenu(["protein"]);$("#"+e.pre+"atomsCustomDist").length&&$("#"+e.pre+"atomsCustomDist").html("  <option value='selected'>selected</option>"+i),$("#"+e.pre+"atomsCustomDist2").length&&$("#"+e.pre+"atomsCustomDist2").html("  <option value='selected' selected>selected</option>"+i),$("#"+e.pre+"atomsCustomDist").resizable(),$("#"+e.pre+"atomsCustomDist2").resizable(),s.bMeasureDistance=!0})),e.myEventCls.onIds("#"+e.pre+"mn6_distanceNo","click",(function(s){let i=e.icn3d;i.pickpair=!1;t.setLogCmd("set lines off",!0),i.labels.distance=[],i.lines.distance=[],i.distPnts=[],i.pk=2,i.drawCls.draw()})),e.myEventCls.onIds(["#"+e.pre+"mn2_selectedcenter","#"+e.pre+"zoomin_selection"],"click",(function(s){let i=e.icn3d;i.transformCls.zoominSelection(),i.drawCls.draw(),t.setLogCmd("zoom selection",!0)})),e.myEventCls.onIds("#"+e.pre+"mn6_center","click",(function(s){let i=e.icn3d;i.applyCenterCls.centerSelection(),i.drawCls.draw(),t.setLogCmd("center selection",!0)})),e.myEventCls.onIds(["#"+e.pre+"mn6_resetOrientation","#"+e.pre+"resetOrientation"],"click",(function(s){let i=e.icn3d;i.transformCls.resetOrientation(),i.drawCls.draw(),t.setLogCmd("reset orientation",!0)})),e.myEventCls.onIds(["#"+e.pre+"mn6_chemicalbindingshow","#"+e.pre+"chemicalbindingshow"],"click",(function(s){e.icn3d.setOptionCls.setOption("chemicalbinding","show"),t.setLogCmd("set chemicalbinding show",!0)})),e.myEventCls.onIds(["#"+e.pre+"mn6_chemicalbindinghide","#"+e.pre+"chemicalbindinghide"],"click",(function(s){e.icn3d.setOptionCls.setOption("chemicalbinding","hide"),t.setLogCmd("set chemicalbinding hide",!0)})),e.myEventCls.onIds("#"+e.pre+"mn6_sidebyside","click",(function(s){let i=e.icn3d.shareLinkCls.shareLinkUrl(void 0);0!==i.indexOf("http")?alert("The url is more than 4000 characters and may not work."):(i=i.replace("full.html","full2.html"),i+="&closepopup=1",window.open(i,"_blank"),t.setLogCmd("side by side | "+i,!0))})),$(document).on("click","."+e.pre+"mn6_rotate",(function(s){let i=e.icn3d,l=$(this).attr("v").toLowerCase(),n=l.split(" ")[1];t.setLogCmd(l,!0),i.bStopRotate=!1,i.transformCls.rotateCount=0,i.transformCls.rotateCountMax=6e3,i.ROT_DIR=n,i.resizeCanvasCls.rotStruc(n)})),$(document).on("click","."+e.pre+"mn6_rotate90",(function(s){let i,l=e.icn3d,n=$(this).attr("v").toLowerCase(),o=n.split("-")[0];t.setLogCmd(n,!0),"x"==o?i=new THREE.Vector3(1,0,0):"y"==o?i=new THREE.Vector3(0,1,0):"z"==o&&(i=new THREE.Vector3(0,0,1));let r=.5*Math.PI;l.transformCls.setRotation(i,r)})),e.myEventCls.onIds("#"+e.pre+"mn6_cameraPers","click",(function(s){e.icn3d.setOptionCls.setOption("camera","perspective"),t.setLogCmd("set camera perspective",!0)})),e.myEventCls.onIds("#"+e.pre+"mn6_cameraOrth","click",(function(s){e.icn3d.setOptionCls.setOption("camera","orthographic"),t.setLogCmd("set camera orthographic",!0)})),e.myEventCls.onIds("#"+e.pre+"mn6_bkgdBlack","click",(function(t){e.icn3d.setStyleCls.setBackground("black")})),e.myEventCls.onIds("#"+e.pre+"mn6_bkgdGrey","click",(function(t){e.icn3d.setStyleCls.setBackground("grey")})),e.myEventCls.onIds("#"+e.pre+"mn6_bkgdWhite","click",(function(t){e.icn3d.setStyleCls.setBackground("white")})),e.myEventCls.onIds("#"+e.pre+"mn6_bkgdTransparent","click",(function(t){e.icn3d.setStyleCls.setBackground("transparent")})),e.myEventCls.onIds("#"+e.pre+"mn6_showfogYes","click",(function(s){let i=e.icn3d;i.opts.fog="yes",i.fogCls.setFog(!0),i.drawCls.draw(),t.setLogCmd("set fog on",!0)})),e.myEventCls.onIds("#"+e.pre+"mn6_showfogNo","click",(function(s){let i=e.icn3d;i.opts.fog="no",i.fogCls.setFog(!0),i.drawCls.draw(),t.setLogCmd("set fog off",!0)})),e.myEventCls.onIds("#"+e.pre+"mn6_showslabYes","click",(function(s){e.icn3d.setOptionCls.setOption("slab","yes"),t.setLogCmd("set slab on",!0)})),e.myEventCls.onIds("#"+e.pre+"mn6_showslabNo","click",(function(s){e.icn3d.setOptionCls.setOption("slab","no"),t.setLogCmd("set slab off",!0)})),e.myEventCls.onIds("#"+e.pre+"mn6_showaxisYes","click",(function(s){e.icn3d.setOptionCls.setOption("axis","yes"),t.setLogCmd("set axis on",!0)})),e.myEventCls.onIds("#"+e.pre+"mn6_showaxisSel","click",(function(s){let i=e.icn3d;i.pc1=!0,i.axesCls.setPc1Axes(),t.setLogCmd("set pc1 axis",!0)})),e.myEventCls.onIds("#"+e.pre+"mn6_showaxisNo","click",(function(s){let i=e.icn3d;i.pc1=!1,i.axes=[],i.setOptionCls.setOption("axis","no"),t.setLogCmd("set axis off",!0)})),e.myEventCls.onIds("#"+e.pre+"mn6_symmetry","click",(function(t){let s=e.icn3d;s.bAxisOnly=!1,s.symdCls.retrieveSymmetry(Object.keys(s.structures)[0])})),e.myEventCls.onIds("#"+e.pre+"mn6_symd","click",(function(s){let i=e.icn3d;i.bAxisOnly=!1,i.symdCls.retrieveSymd(),i.bSymd=!0,t.setLogCmd("symd symmetry",!0)})),e.myEventCls.onIds("#"+e.pre+"mn6_clear_sym","click",(function(s){let i=e.icn3d;i.symdArray=[],i.drawCls.draw(),t.setLogCmd("clear symd symmetry",!0)})),e.myEventCls.onIds("#"+e.pre+"mn6_axes_only","click",(function(s){let i=e.icn3d;i.bAxisOnly=!0,i.drawCls.draw(),t.setLogCmd("show axis",!0)})),e.myEventCls.onIds("#"+e.pre+"mn6_area","click",(function(s){e.icn3d.analysisCls.calculateArea(),t.setLogCmd("area",!0)})),e.myEventCls.onIds("#"+e.pre+"applysymmetry","click",(function(s){let i=e.icn3d;i.bAxisOnly=!1;let l=$("#"+e.pre+"selectSymmetry").val();i.symmetrytitle="none"===l?void 0:l,i.drawCls.draw(),t.setLogCmd("symmetry "+l,!0)})),e.myEventCls.onIds("#"+e.pre+"clearsymmetry","click",(function(s){let i=e.icn3d;i.symmetrytitle=void 0,i.drawCls.draw(),t.setLogCmd("symmetry none",!0)})),e.myEventCls.onIds(["#"+e.pre+"mn6_hbondsYes","#"+e.pre+"hbondsYes"],"click",(function(t){let s=e.icn3d;if(void 0===s.bSetChainsAdvancedMenu||!s.bSetChainsAdvancedMenu){let t=e.hashUtilsCls.cloneHash(s.hAtoms);s.definedSetsCls.setPredefinedInMenu(),s.bSetChainsAdvancedMenu=!0,s.hAtoms=e.hashUtilsCls.cloneHash(t)}let i=s.definedSetsCls.setAtomMenu(["protein"]);$("#"+e.pre+"atomsCustomHbond").length&&$("#"+e.pre+"atomsCustomHbond").html("  <option value='non-selected' selected>non-selected</option><option value='selected'>selected</option>"+i),$("#"+e.pre+"atomsCustomHbond2").length&&$("#"+e.pre+"atomsCustomHbond2").html("  <option value='selected' selected>selected</option>"+i),e.htmlCls.dialogCls.openDlg("dl_hbonds","Hydrogen bonds/interactions between two sets of atoms"),s.bHbondCalc=!1,$("#"+e.pre+"atomsCustomHbond").resizable(),$("#"+e.pre+"atomsCustomHbond2").resizable()})),e.myEventCls.onIds(["#"+e.pre+"mn6_contactmap"],"click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_contact","Set contact map")})),e.myEventCls.onIds("#"+e.pre+"mn6_hbondsNo","click",(function(t){let s=e.icn3d;s.showInterCls.hideHbondsContacts(),s.drawCls.draw()})),e.myEventCls.onIds("#"+e.pre+"mn1_stabilizerYes","click",(function(s){let i=e.icn3d;i.threeDPrintCls.addStabilizer(),i.threeDPrintCls.prepareFor3Dprint(),t.setLogCmd("stabilizer",!0)})),e.myEventCls.onIds("#"+e.pre+"mn1_stabilizerNo","click",(function(s){let i=e.icn3d;t.setLogCmd("set stabilizer off",!0),i.threeDPrintCls.hideStabilizer(),i.drawCls.draw()})),e.myEventCls.onIds("#"+e.pre+"mn1_stabilizerOne","click",(function(t){let s=e.icn3d;e.htmlCls.dialogCls.openDlg("dl_stabilizer","Add One Stabilizer"),s.pk=1,s.opts.pk="atom",s.pickpair=!0,s.pAtomNum=0})),e.myEventCls.onIds("#"+e.pre+"mn1_stabilizerRmOne","click",(function(t){let s=e.icn3d;e.htmlCls.dialogCls.openDlg("dl_stabilizer_rm","Remove One Stabilizer"),s.pk=1,s.opts.pk="atom",s.pickpair=!0,s.pAtomNum=0})),e.myEventCls.onIds("#"+e.pre+"mn1_thicknessSet","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_thickness","Set Thickness for 3D Printing")})),e.myEventCls.onIds("#"+e.pre+"mn3_setThickness","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_thickness2","Preferences")})),e.myEventCls.onIds("#"+e.pre+"mn6_ssbondsYes","click",(function(s){let i=e.icn3d;t.setLogCmd("disulfide bonds",!0),i.annoSsbondCls.showSsbonds()})),e.myEventCls.onIds("#"+e.pre+"mn6_ssbondsExport","click",(function(s){e.icn3d.viewInterPairsCls.exportSsbondPairs(),t.setLogCmd("export disulfide bond pairs",!1)})),e.myEventCls.onIds("#"+e.pre+"mn6_ssbondsNo","click",(function(s){let i=e.icn3d;i.opts.ssbonds="no";t.setLogCmd("set disulfide bonds off",!0),i.lines.ssbond=[],i.setOptionCls.setStyle("sidec","nothing")})),e.myEventCls.onIds("#"+e.pre+"mn6_clbondsYes","click",(function(s){let i=e.icn3d;t.setLogCmd("cross linkage",!0),i.showInterCls.showClbonds()})),e.myEventCls.onIds("#"+e.pre+"mn6_clbondsExport","click",(function(s){e.icn3d.viewInterPairsCls.exportClbondPairs(),t.setLogCmd("export cross linkage pairs",!1)})),e.myEventCls.onIds("#"+e.pre+"mn6_clbondsNo","click",(function(s){let i=e.icn3d;i.opts.clbonds="no";t.setLogCmd("set cross linkage off",!0),i.lines.clbond=[],i.setOptionCls.setStyle("sidec","nothing")}))}setLogCmd(e,t,s){var i=this.icn3dui,l=i.icn3d;if(""===e.trim())return!1;let n=e.indexOf("|||");-1!==n&&(e=e.substr(0,n));let o={};if(o.factor=l._zoomFactor,o.mouseChange=l.mouseChange,o.quaternion={},o.quaternion._x=parseFloat(l.quaternion._x).toPrecision(5),o.quaternion._y=parseFloat(l.quaternion._y).toPrecision(5),o.quaternion._z=parseFloat(l.quaternion._z).toPrecision(5),o.quaternion._w=parseFloat(l.quaternion._w).toPrecision(5),t&&l.bAddCommands)if(l.STATENUMBER<l.commands.length){let t=l.commands[l.STATENUMBER-1],s=t.indexOf("|||");-1!=s&&e!==t.substr(0,s)&&(l.commands=l.commands.slice(0,l.STATENUMBER),l.commands.push(e+"|||"+l.transformCls.getTransformationStr(o)),l.optsHistory.push(i.hashUtilsCls.cloneHash(l.opts)),l.optsHistory[l.optsHistory.length-1].hlatomcount=Object.keys(l.hAtoms).length,i.utilsCls.isSessionStorageSupported()&&l.setStyleCls.saveCommandsToSession(),l.STATENUMBER=l.commands.length)}else l.commands.push(e+"|||"+l.transformCls.getTransformationStr(o)),l.optsHistory.push(i.hashUtilsCls.cloneHash(l.opts)),void 0!==l.hAtoms&&(l.optsHistory[l.optsHistory.length-1].hlatomcount=Object.keys(l.hAtoms).length),i.utilsCls.isSessionStorageSupported()&&l.setStyleCls.saveCommandsToSession(),l.STATENUMBER=l.commands.length;l.bAddLogs&&i.cfg.showcommand&&(l.logs.push(e),$("#"+i.pre+"logtext").val("> "+l.logs.join("\n> ")+"\n> ").scrollTop($("#"+i.pre+"logtext")[0].scrollHeight)),l.setStyleCls.adjustIcon()}}class Qe{constructor(e){this.icn3dui=e}setTopMenusHtml(e,t,s){let i=this.icn3dui;if(i.bNode)return"";let l="";l+="<div style='position:relative;'>",l+=i.htmlCls.divStr+"popup' class='icn3d-text icn3d-popup'></div>",l+=this.setReplayHtml(),l+="\x3c!--https://forum.jquery.com/topic/looking-for-a-jquery-horizontal-menu-bar--\x3e",l+=i.htmlCls.divStr+"mnlist' style='position:absolute; z-index:999; float:left; display:table-row; margin-top: -2px;'>",l+="<table border='0' cellpadding='0' cellspacing='0' width='100'><tr>";let n='<td valign="top">';if(l+=n+this.setMenu1()+"</td>",i.cfg.simplemenu||(l+=n+this.setMenu2()+"</td>"),l+=n+this.setMenu2b()+"</td>",l+=n+this.setMenu3()+"</td>",l+=n+this.setMenu4()+"</td>",i.cfg.simplemenu||(l+=n+this.setMenu5()+"</td>",l+=n+this.setMenu6()+"</td>",l+=n+"<div style='position:relative; margin-left:6px;'>"+t,l+="<div class='icn3d-commandTitle' style='min-width:40px; margin-top: 3px; white-space: nowrap;'>"+s,l+=n+'<div class="icn3d-commandTitle" style="white-space:nowrap; margin-top:10px; border-left:solid 1px #888888"><span id="'+i.pre+'selection_expand" class="icn3d-expand icn3d-link" title="Expand">'+i.htmlCls.space2+'Toolbar <span class="ui-icon ui-icon-plus" style="width:15px"></span>'+i.htmlCls.space2+'</span><span id="'+i.pre+'selection_shrink" class="icn3d-shrink icn3d-link" style="display:none;" title="Shrink">'+i.htmlCls.space2+'Toolbar <span class="ui-icon ui-icon-minus" style="width:15px"></span>'+i.htmlCls.space2+"</span></div></td>",l+=n+'<div class="icn3d-commandTitle" style="white-space:nowrap; margin-top:8px; border-left:solid 1px #888888">'+i.htmlCls.space2+'<input type="text" id="'+i.pre+'search_seq" size="10" placeholder="one-letter seq."> <button style="white-space:nowrap;" id="'+i.pre+'search_seq_button">Search</button> <a style="text-decoration: none;" href="'+i.htmlCls.baseUrl+'icn3d/icn3d.html#selectb" target="_blank" title="Specification tips">?</a></div></td>'),l+="</tr>",l+="</table>",l+="</div>",l+=this.setTools(),l+=i.htmlCls.divStr+"title' class='icn3d-commandTitle' style='font-size:1.2em; font-weight:normal; position:absolute; z-index:1; float:left; display:table-row; margin: 85px 0px 0px 5px; color:"+i.htmlCls.GREYD+"; width:"+i.htmlCls.WIDTH+"px'></div>",l+=i.htmlCls.divStr+"viewer' style='position:relative; width:100%; height:100%; background-color: "+i.htmlCls.GREYD+";'>",l+=i.htmlCls.divStr+"legend' class='icn3d-text icn3d-legend'></div>",l+=i.htmlCls.divStr+"mnLogSection'>",l+="<div style='height: "+i.htmlCls.MENU_HEIGHT+"px;'></div>",l+=" </div>",void 0===i.cfg.mmtfid){let e="top:180px; font-size: 1.8em;";l+=i.htmlCls.divStr+"wait' style='position:absolute; left:50px; "+e+" color: #444444;'>Loading data...</div>"}l+="<canvas id='"+i.pre+"canvas' style='width:100%; height: 100%; background-color: #000;'>Your browser does not support WebGL.</canvas>",(void 0===i.cfg.showcommand||i.cfg.showcommand)&&(l+=this.setLogWindow()),l+="</div>",l+="</div>",l+=i.htmlCls.setDialogCls.setDialogs(),l+=i.htmlCls.setDialogCls.setCustomDialogs(),$("#"+e).html(l),$("accordion").accordion({collapsible:!0,active:!1,heightStyle:"content"}),$("accordion div").removeClass("ui-accordion-content ui-corner-all ui-corner-bottom ui-widget-content"),$(".icn3d-mn-item").menu({position:{my:"left top",at:"right top"}}),$(".icn3d-mn-item").hover((function(){}),(function(){$("accordion").accordion("option","active","none")})),$("#"+i.pre+"accordion1").hover((function(){$("#"+i.pre+"accordion1 div").css("display","block")}),(function(){$("#"+i.pre+"accordion1 div").css("display","none")})),$("#"+i.pre+"accordion2").hover((function(){$("#"+i.pre+"accordion2 div").css("display","block")}),(function(){$("#"+i.pre+"accordion2 div").css("display","none")})),$("#"+i.pre+"accordion2b").hover((function(){$("#"+i.pre+"accordion2b div").css("display","block")}),(function(){$("#"+i.pre+"accordion2b div").css("display","none")})),$("#"+i.pre+"accordion3").hover((function(){$("#"+i.pre+"accordion3 div").css("display","block")}),(function(){$("#"+i.pre+"accordion3 div").css("display","none")})),$("#"+i.pre+"accordion4").hover((function(){$("#"+i.pre+"accordion4 div").css("display","block")}),(function(){$("#"+i.pre+"accordion4 div").css("display","none")})),$("#"+i.pre+"accordion5").hover((function(){$("#"+i.pre+"accordion5 div").css("display","block")}),(function(){$("#"+i.pre+"accordion5 div").css("display","none")})),$("#"+i.pre+"accordion6").hover((function(){$("#"+i.pre+"accordion6 div").css("display","block")}),(function(){$("#"+i.pre+"accordion6 div").css("display","none")}))}setTopMenusHtmlMobile(e,t,s){let i=this.icn3dui;if(i.bNode)return"";let l="";if(l+="<div style='position:relative;'>",l+=i.htmlCls.divStr+"popup' class='icn3d-text icn3d-popup'></div>",l+=this.setReplayHtml(),!i.utilsCls.isMobile()){let e=i.htmlCls.WIDTH-40+5;l+=i.htmlCls.buttonStr+"fullscreen' style='position:absolute; z-index:1999; display:block; padding:0px; margin: 7px 0px 0px "+e+"px; width:30px; height:34px; border-radius:4px; border:none; background-color:#f6f6f6;' title='Full screen'>",l+="<svg fill='#1c94c4' viewBox='0 0 24 24' width='24' height='24'>",l+="<path d='M0 0h24v24H0z' fill='none'></path>",l+="<path d='M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z'></path>",l+="</svg>",l+="</button>"}l+="\x3c!--https://forum.jquery.com/topic/looking-for-a-jquery-horizontal-menu-bar--\x3e",l+=i.htmlCls.divStr+"mnlist' style='position:absolute; z-index:999; float:left; display:block; margin: 5px 0px 0px 5px;'>",l+="<div>",l+="<accordion id='"+i.pre+"accordion0' class='icn3d-accordion'>",i.cfg.notebook?l+="<h3 style='width:20px; height:24px; position:relative; padding: 0'><span style='position:absolute; left:3px; top:4px;'>&#9776;</span></h3>":l+="<h3 style='width:30px; height:34px; position:relative; padding: 0; margin-top:7px!important; background-color:#f6f6f6;'><span style='position:absolute; left:7px; top:8px;'>&#9776;</span></h3>",l+="<div>";let n="<li><span class='icn3d-menu-color'";l+="<ul class='icn3d-mn-item'>",l+=n+">File</span>",l+=this.setMenu1_base(),l+=n+">Select</span>",l+=this.setMenu2_base(),l+=n+">View</span>",l+=this.setMenu2b_base(),l+=n+" id='"+i.pre+"style'>Style</span>",l+=this.setMenu3_base(),l+=n+" id='"+i.pre+"color'>Color</span>",l+=this.setMenu4_base(),l+=n+">Analysis</span>",l+=this.setMenu5_base(),l+=n+">Help</span>",l+=this.setMenu6_base(),l+="<li><div style='position:relative; margin-top:-6px;'>"+t,l+="<div class='icn3d-commandTitle' style='margin-top: 3px; white-space: nowrap;'>"+s,void 0!==i.cfg.align&&(l+="<li><span id='"+i.pre+"alternate2' class='icn3d-menu-color' title='Alternate the structures'>Alternate</span>"),l+="</ul>",l+="</div>",l+="</accordion>",l+="</div>",l+="</div>";let o="white"==i.htmlCls.opts.background||"grey"==i.htmlCls.opts.background?"black":i.htmlCls.GREYD;if(l+=i.htmlCls.divStr+"title' class='icn3d-commandTitle' style='font-size:1.2em; font-weight:normal; position:absolute; z-index:1; float:left; display:block; margin: 12px 0px 0px 40px; color:"+o+"; width:"+(i.htmlCls.WIDTH-40).toString()+"px'></div>",l+=i.htmlCls.divStr+"viewer' style='position:relative; width:100%; height:100%; background-color: "+i.htmlCls.GREYD+";'>",l+=i.htmlCls.divStr+"mnLogSection'>",l+="<div style='height: "+i.htmlCls.MENU_HEIGHT+"px;'></div>",l+="</div>",void 0===i.cfg.mmtfid){let e="top:180px; font-size: 1.8em;";l+=i.htmlCls.divStr+"wait' style='position:absolute; left:50px; "+e+" color: #444444;'>Loading data...</div>"}l+="<canvas id='"+i.pre+"canvas' style='width:100%; height: 100%; background-color: #000;'>Your browser does not support WebGL.</canvas>",(void 0===i.cfg.showcommand||i.cfg.showcommand)&&(l+=this.setLogWindow()),l+="</div>",l+="</div>",l+=i.htmlCls.setDialogCls.setDialogs(),l+=i.htmlCls.setDialogCls.setCustomDialogs(),$("#"+e).html(l),$("accordion").accordion({collapsible:!0,active:!1,heightStyle:"content"}),$("accordion div").removeClass("ui-accordion-content ui-corner-all ui-corner-bottom ui-widget-content"),$(".icn3d-mn-item").menu({position:{my:"left top",at:"right top"}}),$(".icn3d-mn-item").hover((function(){}),(function(){$("accordion").accordion("option","active","none")})),$("#"+i.pre+"accordion0").hover((function(){$("#"+i.pre+"accordion0 div").css("display","block")}),(function(){$("#"+i.pre+"accordion0 div").css("display","none")}))}setReplayHtml(e){let t=this.icn3dui;if(t.bNode)return"";let s="";return s+=t.htmlCls.divStr+"replay' style='display:none; position:absolute; z-index:9999; top:"+parseInt(t.htmlCls.HEIGHT-100).toString()+"px; left:20px;'>",s+="<div title='Click to replay one step'><svg style='cursor:pointer;' fill='#f8b84e' viewBox='0 0 60 60' width='40' height='40'>",s+='<circle style="fill:#f8b84e;" cx="29" cy="29" r="29"/>',s+="<g>",s+='<polygon style="fill:#FFFFFF;" points="44,29 22,44 22,29.273 22,14"/>',s+='<path style="fill:#FFFFFF;" d="M22,45c-0.16,0-0.321-0.038-0.467-0.116C21.205,44.711,21,44.371,21,44V14c0-0.371,0.205-0.711,0.533-0.884c0.328-0.174,0.724-0.15,1.031,0.058l22,15C44.836,28.36,45,28.669,45,29s-0.164,0.64-0.437,0.826l-22,15C22.394,44.941,22.197,45,22,45z M23,15.893v26.215L42.225,29L23,15.893z"/>',s+="</g>",s+="</svg></div>",s+=t.htmlCls.divStr+"replay_menu' style='background-color:#DDDDDD; padding:3px; font-weight:bold;'></div>",s+=t.htmlCls.divStr+"replay_cmd' style='background-color:#DDDDDD; padding:3px; max-width:250px'></div>",s+="</div>",s}setTools(){let e=this.icn3dui;if(e.bNode)return"";let t="";return t+=e.htmlCls.divStr+"selection' style='display:none;'><div style='position:absolute; z-index:555; float:left; display:table-row; margin: 32px 0px 0px 3px;'>",t+="<table style='margin-top: 3px; width:100px;'><tr valign='center'>",t+=this.setTools_base(),t+="</tr></table>",t+="</div></div>",t}setButton(e,t,s,i,l){let n=this.icn3dui;return n.bNode?"":(l=void 0!==l?"color:"+l:"","<div style='margin:3px 0px 0px 10px;'><button style='-webkit-appearance:"+e+"; height:36px;"+(n.utilsCls.isMobile()?" background-color:#DDDDDD;":"")+"' id='"+n.pre+t+"'><span style='white-space:nowrap;"+l+"' class='icn3d-commandTitle' title='"+s+"'>"+i+"</span></button></div>")}setTools_base(){let e=this.icn3dui;if(e.bNode)return"";let t="",s=e.utilsCls.isMobile()?"none":"button",i="<td valign='top'>";return t+=i+this.setButton(s,"alternate","Alternate the structures",'Alternate<br/>(Key "a")',e.htmlCls.ORANGE)+"</td>",t+=i+this.setButton(s,"saveimage","Save iCn3D PNG Image","Save iCn3D<br/>PNG Image")+"</td>",void 0===e.cfg.cid&&(t+=i+this.setButton(s,"hbondsYes","View H-Bonds & Interactions","H-Bonds &<br/> Interactions")+"</td>"),t+=i+this.setButton(s,"show_selected","View ONLY the selected atoms","View<br/> Selection")+"</td>",t+=i+this.setButton(s,"toggleHighlight","Turn on and off the 3D highlight in the viewer","Toggle<br/>Highlight")+"</td>",void 0===e.cfg.cid&&(t+=i+this.setButton(s,"removeLabels","Remove Labels","Remove<br/>Labels")+"</td>"),t}setTheme(e){let t,s,i,l,n,o=this.icn3dui;if(o.bNode)return"";o.htmlCls.themecolor=e,"orange"==e?(t="#e78f08",s="#f6a828",i="ui-bg_gloss-wave_35_f6a828_500x100.png",l="ui-icons_ef8c08_256x240.png",n="#eb8f00"):"black"==e?(t="#333333",s="#333333",i="ui-bg_gloss-wave_25_333333_500x100.png",l="ui-icons_222222_256x240.png",n="#222222"):"blue"==e&&(t="#4297d7",s="#5c9ccc",i="ui-bg_gloss-wave_55_5c9ccc_500x100.png",l="ui-icons_228ef1_256x240.png",n="#444"),$(".ui-widget-header").css({border:"1px solid "+t,background:s+' url("lib/images/'+i+'") 50% 50% repeat-x',color:"#fff","font-weight":"bold"}),$(".ui-button .ui-icon").css({"background-image":"url(lib/images/"+l+")"}),$(".ui-state-active a, .ui-state-active a:link, .ui-state-active a:visited").css({color:n,"text-decoration":"none"})}setLogWindow(){let e=this.icn3dui;if(e.bNode)return"";let t="";return t+=e.htmlCls.divStr+"cmdlog' style='float:left; margin-top: -5px; width: 100%;'>",t+="<textarea id='"+e.pre+"logtext' rows='2' style='width: 100%; height: "+e.htmlCls.CMD_HEIGHT+"px; padding: 0px; border: 0px; background-color: "+e.htmlCls.GREYD+";'></textarea>",t+="</div>",t}setMenu1(){let e=this.icn3dui;if(e.bNode)return"";let t="";return t+="<div class='icn3d-menu'>",t+="<accordion id='"+e.pre+"accordion1' class='icn3d-accordion'>",t+="<h3>File</h3>",t+="<div>",t+=this.setMenu1_base(),t+="</div>",t+="</accordion>",t+="</div>",t}setMenu1_base(){let e=this.icn3dui;if(e.bNode)return"";let t="";return t+="<ul class='icn3d-mn-item'>",t+="<li><span>Retrieve by ID</span>",t+="<ul>",t+=e.htmlCls.setHtmlCls.getLink("mn1_mmdbid","MMDB ID "+e.htmlCls.wifiStr),t+=e.htmlCls.setHtmlCls.getLink("mn1_mmtfid","MMTF ID "+e.htmlCls.wifiStr),t+=e.htmlCls.setHtmlCls.getLink("mn1_pdbid","PDB ID "+e.htmlCls.wifiStr),t+=e.htmlCls.setHtmlCls.getLink("mn1_opmid","OPM PDB ID "+e.htmlCls.wifiStr),t+=e.htmlCls.setHtmlCls.getLink("mn1_mmcifid","mmCIF ID "+e.htmlCls.wifiStr),t+=e.htmlCls.setHtmlCls.getLink("mn1_gi","NCBI gi "+e.htmlCls.wifiStr),t+=e.htmlCls.setHtmlCls.getLink("mn1_uniprotid","UniProt ID "+e.htmlCls.wifiStr),t+=e.htmlCls.setHtmlCls.getLink("mn1_cid","PubChem CID "+e.htmlCls.wifiStr),t+="</ul>",t+="</li>",t+="<li><span>Open File</span>",t+="<ul>",t+=e.htmlCls.setHtmlCls.getLink("mn1_pdbfile","PDB File"),t+=e.htmlCls.setHtmlCls.getLink("mn1_mmciffile","mmCIF File"),t+=e.htmlCls.setHtmlCls.getLink("mn1_mol2file","Mol2 File"),t+=e.htmlCls.setHtmlCls.getLink("mn1_sdffile","SDF File"),t+=e.htmlCls.setHtmlCls.getLink("mn1_xyzfile","XYZ File"),t+=e.htmlCls.setHtmlCls.getLink("mn1_urlfile","URL(Same Host) "+e.htmlCls.wifiStr),t+="<li>-</li>",t+=e.htmlCls.setHtmlCls.getLink("mn1_pngimage","iCn3D PNG Image"),t+=e.htmlCls.setHtmlCls.getLink("mn1_state","State/Script File"),t+=e.htmlCls.setHtmlCls.getLink("mn1_fixedversion","Share Link in Archived Ver. "+e.htmlCls.wifiStr),t+=e.htmlCls.setHtmlCls.getLink("mn1_selection","Selection File"),t+="<li>-</li>",t+="<li><span>Electron Density(DSN6)</span>",t+="<ul>",t+=e.htmlCls.setHtmlCls.getLink("mn1_dsn6","Local File"),t+=e.htmlCls.setHtmlCls.getLink("mn1_dsn6url","URL(Same Host) "+e.htmlCls.wifiStr),t+="</ul>",t+="</ul>",t+="</li>",t+="<li><span>Align</span>",t+="<ul>",t+=e.htmlCls.setHtmlCls.getLink("mn1_blast_rep_id","Sequence to Structure "+e.htmlCls.wifiStr),t+=e.htmlCls.setHtmlCls.getLink("mn1_align","Structure to Structure "+e.htmlCls.wifiStr),t+=e.htmlCls.setHtmlCls.getLink("mn1_chainalign","Multiple Chains "+e.htmlCls.wifiStr),t+="</ul>",t+="</li>",t+="<li id='"+e.pre+"mn2_realignWrap'><span>Realign Selection</span>",t+="<ul>",t+=e.htmlCls.setHtmlCls.getRadio("mn2_realign","mn2_realignonseqalign","on Sequence Alignment "+e.htmlCls.wifiStr,!0),t+=e.htmlCls.setHtmlCls.getRadio("mn2_realign","mn2_realignresbyres","Residue by Residue"),t+="</ul>",t+="</li>",t+="<li><span>3D Printing</span>",t+="<ul>",void 0===e.cfg.cid?(t+=e.htmlCls.setHtmlCls.getLink("mn1_exportVrmlStab","WRL/VRML(Color, W/ Stab.)"),t+=e.htmlCls.setHtmlCls.getLink("mn1_exportStlStab","STL(W/ Stabilizers)"),t+="<li>-</li>",t+=e.htmlCls.setHtmlCls.getLink("mn1_exportVrml","WRL/VRML(Color)"),t+=e.htmlCls.setHtmlCls.getLink("mn1_exportStl","STL"),t+="<li>-</li>",t+=e.htmlCls.setHtmlCls.getLink("mn1_stabilizerYes","Add All Stabilizers"),t+=e.htmlCls.setHtmlCls.getLink("mn1_stabilizerNo","Remove All Stabilizers"),t+="<li>-</li>",t+=e.htmlCls.setHtmlCls.getLink("mn1_stabilizerOne","Add One Stabilizer"),t+=e.htmlCls.setHtmlCls.getLink("mn1_stabilizerRmOne","Remove One Stabilizer"),t+="<li>-</li>",t+=e.htmlCls.setHtmlCls.getLink("mn1_thicknessSet","Set Thickness")):(t+=e.htmlCls.setHtmlCls.getLink("mn1_exportVrml","VRML(Color)"),t+=e.htmlCls.setHtmlCls.getLink("mn1_exportStl","STL")),t+="</ul>",t+="</li>",t+="<li><span>Save Files</span>",t+="<ul>",t+="<li><span>iCn3D PNG Image</span>",t+="<ul>",t+=e.htmlCls.setHtmlCls.getLink("mn1_exportCanvas","Original Size"),t+=e.htmlCls.setHtmlCls.getLink("mn1_exportCanvas2","2X Large"),t+=e.htmlCls.setHtmlCls.getLink("mn1_exportCanvas4","4X Large"),t+=e.htmlCls.setHtmlCls.getLink("mn1_exportCanvas8","8X Large"),t+="</ul>",t+="</li>",t+=e.htmlCls.setHtmlCls.getLink("mn1_exportState","State File"),t+=e.htmlCls.setHtmlCls.getLink("mn1_exportSelections","Selection File"),t+=e.htmlCls.setHtmlCls.getLink("mn1_exportCounts","Residue Counts"),t+=e.htmlCls.setHtmlCls.getLink("mn1_exportPdbRes","PDB"),t+="<li><br/></li>",t+="</ul>",t+="</li>",t+=e.htmlCls.setHtmlCls.getLink("mn1_sharelink","Share Link "+e.htmlCls.wifiStr),t+=e.htmlCls.setHtmlCls.getLink("mn1_replayon","Replay Each Step"),t+="<li><br/></li>",t+="</ul>",t}setMenu2(){let e=this.icn3dui;if(e.bNode)return"";let t="";return t+="<div class='icn3d-menu'>",t+="<accordion id='"+e.pre+"accordion2' class='icn3d-accordion'>",t+="<h3>Select</h3>",t+="<div>",t+=this.setMenu2_base(),t+="</div>",t+="</accordion>",t+="</div>",t}setMenu2_base(){let e=this.icn3dui;if(e.bNode)return"";let t="";return t+="<ul class='icn3d-mn-item'>",t+=e.htmlCls.setHtmlCls.getLink("mn2_definedsets","Defined Sets"),t+=e.htmlCls.setHtmlCls.getLink("mn2_selectall","All"),t+=e.htmlCls.setHtmlCls.getLink("mn2_selectdisplayed","Displayed Set"),t+=e.htmlCls.setHtmlCls.getLink("mn2_aroundsphere","by Distance"),t+="<li><span>by Property</span>",t+="<ul>",t+=e.htmlCls.setHtmlCls.getLink("mn2_propPos","Positive"),t+=e.htmlCls.setHtmlCls.getLink("mn2_propNeg","Negative"),t+=e.htmlCls.setHtmlCls.getLink("mn2_propHydro","Hydrophobic"),t+=e.htmlCls.setHtmlCls.getLink("mn2_propPolar","Polar"),t+=e.htmlCls.setHtmlCls.getLink("mn2_propBfactor","B-factor"),t+=e.htmlCls.setHtmlCls.getLink("mn2_propSolAcc","Solvent Accessibility"),t+="</ul>",t+="</li>",t+=e.htmlCls.setHtmlCls.getLink("mn2_selectcomplement","Inverse"),t+=e.htmlCls.setHtmlCls.getLink("mn2_selectmainchains","Main Chains"),t+=e.htmlCls.setHtmlCls.getLink("mn2_selectsidechains","Side Chains"),t+=e.htmlCls.setHtmlCls.getLink("mn2_selectmainsidechains","Main & Side Chains"),t+=e.htmlCls.setHtmlCls.getLink("mn2_command","Advanced"),void 0===e.cfg.cid?(t+="<li><span>Select on 3D</span>",t+="<ul>",t+='<li>"Alt"+Click: start selection</li>',t+='<li>"Ctrl"+Click: union selection</li>',t+='<li>"Shift"+Click: range Selection</li>',t+="<li>-</li>",t+=e.htmlCls.setHtmlCls.getRadio("mn2_pk","mn2_pkChain","Chain"),void 0===e.cfg.mmdbid&&void 0===e.cfg.gi||(t+=e.htmlCls.setHtmlCls.getRadio("mn2_pk","mn2_pkDomain","3D Domain")),t+=e.htmlCls.setHtmlCls.getRadio("mn2_pk","mn2_pkStrand","Strand/Helix"),t+=e.htmlCls.setHtmlCls.getRadio("mn2_pk","mn2_pkResidue","Residue",!0),t+=e.htmlCls.setHtmlCls.getRadio("mn2_pk","mn2_pkYes","Atom"),t+=e.htmlCls.setHtmlCls.getRadio("mn2_pk","mn2_pkNo","None"),t+="</ul>",t+="</li>"):e.utilsCls.isMobile()?t+="<li><span>Touch to pick</span>":t+='<li><span>Picking with<br>"Alt" + Click</span>',t+="<li>-</li>",t+=e.htmlCls.setHtmlCls.getLink("mn2_saveselection","Save Selection"),t+=e.htmlCls.setHtmlCls.getLink("clearall","Clear Selection"),t+="<li>-</li>",t+="<li><span>Highlight Color</span>",t+="<ul>",t+=e.htmlCls.setHtmlCls.getRadio("mn2_hl_clr","mn2_hl_clrYellow","Yellow",!0),t+=e.htmlCls.setHtmlCls.getRadio("mn2_hl_clr","mn2_hl_clrGreen","Green"),t+=e.htmlCls.setHtmlCls.getRadio("mn2_hl_clr","mn2_hl_clrRed","Red"),t+="</ul>",t+="</li>",t+="<li><span>Highlight Style</span>",t+="<ul>",t+=e.htmlCls.setHtmlCls.getRadio("mn2_hl_style","mn2_hl_styleOutline","Outline",!0),t+=e.htmlCls.setHtmlCls.getRadio("mn2_hl_style","mn2_hl_styleObject","3D Objects"),t+="</ul>",t+="</li>",t+=e.htmlCls.setHtmlCls.getLink("toggleHighlight2","Toggle Highlight"),t+="<li><br/></li>",t+="</ul>",t}setMenu2b(){let e=this.icn3dui;if(e.bNode)return"";let t="";return t+="<div class='icn3d-menu'>",t+="<accordion id='"+e.pre+"accordion2b' class='icn3d-accordion'>",t+="<h3>View</h3>",t+="<div>",t+=this.setMenu2b_base(),t+="</div>",t+="</accordion>",t+="</div>",t}setMenu2b_base(){let e=this.icn3dui;if(e.bNode)return"";let t="";return t+="<ul class='icn3d-mn-item'>",t+=e.htmlCls.setHtmlCls.getLink("mn2_show_selected","View Selection"),t+=e.htmlCls.setHtmlCls.getLink("mn2_hide_selected","Hide Selection"),t+=e.htmlCls.setHtmlCls.getLink("mn2_selectedcenter","Zoom in Selection"),t+=e.htmlCls.setHtmlCls.getLink("mn6_center","Center Selection"),t+=e.htmlCls.setHtmlCls.getLink("mn2_fullstru","View Full Structure"),t+="<li id='"+e.pre+"mn2_alternateWrap'><span id='"+e.pre+"mn2_alternate' class='icn3d-link'>Alternate(Key \"a\")</span></li>",void 0!==e.cfg.opmid?(t+="<li id='"+e.pre+"togglememli'><span id='"+e.pre+"togglemem' class='icn3d-link'>Toggle Membrane</span></li>",t+="<li id='"+e.pre+"adjustmemli'><span id='"+e.pre+"adjustmem' class='icn3d-link'>Adjust Membrane</span></li>",t+="<li id='"+e.pre+"selectplaneli'><span id='"+e.pre+"selectplane' class='icn3d-link'>Select between<br>Two X-Y Planes</span></li>"):(t+="<li id='"+e.pre+"togglememli' style='display:none'><span id='"+e.pre+"togglemem' class='icn3d-link'>Toggle Membrane</span></li>",t+="<li id='"+e.pre+"adjustmemli' style='display:none'><span id='"+e.pre+"adjustmem' class='icn3d-link'>Adjust Membrane</span></li>",t+="<li id='"+e.pre+"selectplaneli' style='display:none'><span id='"+e.pre+"selectplane' class='icn3d-link'>Select between<br>Two X-Y Planes</span></li>"),t+="<li>-</li>",t+=e.htmlCls.setHtmlCls.getLink("mn6_sidebyside","Side by Side"),t+="<li><span>Rotate</span>",t+="<ul>",t+="<li><span>Rotate 90&deg;</span>",t+="<ul>",t+=e.htmlCls.setHtmlCls.getRadio("mn6_rotate90","mn6_rotatex","X-axis(Shift + Key M)"),t+=e.htmlCls.setHtmlCls.getRadio("mn6_rotate90","mn6_rotatey","Y-axis(Shift + Key J)"),t+=e.htmlCls.setHtmlCls.getRadio("mn6_rotate90","mn6_rotatez","Z-axis"),t+="</ul>",t+="</li>",t+="<li><span>Auto Rotation</span>",t+="<ul>",t+=e.htmlCls.setHtmlCls.getRadio("mn6_rotate","mn6_rotateleft","Rotate Left"),t+=e.htmlCls.setHtmlCls.getRadio("mn6_rotate","mn6_rotateright","Rotate Right"),t+=e.htmlCls.setHtmlCls.getRadio("mn6_rotate","mn6_rotateup","Rotate Up"),t+=e.htmlCls.setHtmlCls.getRadio("mn6_rotate","mn6_rotatedown","Rotate Down"),t+="</ul>",t+="</li>",t+="</ul>",t+="</li>",t+="<li><span>Camera</span>",t+="<ul>",t+=e.htmlCls.setHtmlCls.getRadio("mn6_camera","mn6_cameraPers","Perspective",!0),t+=e.htmlCls.setHtmlCls.getRadio("mn6_camera","mn6_cameraOrth","Orthographic"),t+="</ul>",t+="</li>",t+="<li><span>Fog for Selection</span>",t+="<ul>",t+=e.htmlCls.setHtmlCls.getRadio("mn6_showfog","mn6_showfogYes","On"),t+=e.htmlCls.setHtmlCls.getRadio("mn6_showfog","mn6_showfogNo","Off",!0),t+="</ul>",t+="</li>",t+="<li><span>Slab for Selection</span>",t+="<ul>",t+=e.htmlCls.setHtmlCls.getRadio("mn6_showslab","mn6_showslabYes","On"),t+=e.htmlCls.setHtmlCls.getRadio("mn6_showslab","mn6_showslabNo","Off",!0),t+="</ul>",t+="</li>",t+="<li><span>XYZ-axes</span>",t+="<ul>",t+=e.htmlCls.setHtmlCls.getRadio("mn6_showaxis","mn6_showaxisYes","Original"),t+=e.htmlCls.setHtmlCls.getRadio("mn6_showaxis","mn6_showaxisSel","Prin. Axes on Sel."),t+=e.htmlCls.setHtmlCls.getRadio("mn6_showaxis","mn6_showaxisNo","Hide",!0),t+="</ul>",t+="</li>",t+="<li>-</li>",t+="<li><span>Reset</span>",t+="<ul>",t+=e.htmlCls.setHtmlCls.getRadio("mn6_reset","reset","All"),t+=e.htmlCls.setHtmlCls.getRadio("mn6_reset","mn6_resetOrientation","Orientation"),t+="</ul>",t+="</li>",t+=e.htmlCls.setHtmlCls.getLink("mn6_back","Undo"),t+=e.htmlCls.setHtmlCls.getLink("mn6_forward","Redo"),t+=e.htmlCls.setHtmlCls.getLink("mn6_fullscreen","Full Screen"),t+="<li><br/></li>",t+="</ul>",t}setMenu3(){let e=this.icn3dui;if(e.bNode)return"";let t="";return t+="<div class='icn3d-menu'>",t+="<accordion id='"+e.pre+"accordion3' class='icn3d-accordion'>",t+="<h3 id='"+e.pre+"style'>Style</h3>",t+="<div>",t+=this.setMenu3_base(),t+="</div>",t+="</accordion>",t+="</div>",t}setMenu3_base(){let e=this.icn3dui;if(e.bNode)return"";let t="";t+="<ul class='icn3d-mn-item'>",void 0===e.cfg.cid&&(t+="<li><span>Proteins</span>",t+="<ul>",void 0!==e.cfg.align||void 0!==e.cfg.chainalign?t+=e.htmlCls.setHtmlCls.getRadio("mn3_proteins","mn3_proteinsRibbon","Ribbon"):t+=e.htmlCls.setHtmlCls.getRadio("mn3_proteins","mn3_proteinsRibbon","Ribbon",!0),t+=e.htmlCls.setHtmlCls.getRadio("mn3_proteins","mn3_proteinsStrand","Strand"),t+=e.htmlCls.setHtmlCls.getRadio("mn3_proteins","mn3_proteinsCylinder","Cylinder and Plate"),t+=e.htmlCls.setHtmlCls.getRadio("mn3_proteins","mn3_proteinsSchematic","Schematic"),void 0!==e.cfg.align||void 0!==e.cfg.chainalign?t+=e.htmlCls.setHtmlCls.getRadio("mn3_proteins","mn3_proteinsCalpha","C Alpha Trace",!0):t+=e.htmlCls.setHtmlCls.getRadio("mn3_proteins","mn3_proteinsCalpha","C Alpha Trace"),t+=e.htmlCls.setHtmlCls.getRadio("mn3_proteins","mn3_proteinsBackbone","Backbone"),t+=e.htmlCls.setHtmlCls.getRadio("mn3_proteins","mn3_proteinsBfactor","B-factor Tube"),t+=e.htmlCls.setHtmlCls.getRadio("mn3_proteins","mn3_proteinsLines","Lines"),t+=e.htmlCls.setHtmlCls.getRadio("mn3_proteins","mn3_proteinsStick","Stick"),t+=e.htmlCls.setHtmlCls.getRadio("mn3_proteins","mn3_proteinsBallstick","Ball and Stick"),t+=e.htmlCls.setHtmlCls.getRadio("mn3_proteins","mn3_proteinsSphere","Sphere"),t+=e.htmlCls.setHtmlCls.getRadio("mn3_proteins","mn3_proteinsNo","Hide"),t+="</ul>",t+="</li>",t+="<li><span>Side Chains</span>",t+="<ul>",t+=e.htmlCls.setHtmlCls.getRadio("mn3_sidec","mn3_sidecLines","Lines"),t+=e.htmlCls.setHtmlCls.getRadio("mn3_sidec","mn3_sidecStick","Stick"),t+=e.htmlCls.setHtmlCls.getRadio("mn3_sidec","mn3_sidecBallstick","Ball and Stick"),t+=e.htmlCls.setHtmlCls.getRadio("mn3_sidec","mn3_sidecSphere","Sphere"),t+=e.htmlCls.setHtmlCls.getRadio("mn3_sidec","mn3_sidecNo","Hide",!0),t+="</ul>",t+="</li>",t+="<li><span>Nucleotides</span>",t+="<ul>",t+=e.htmlCls.setHtmlCls.getRadio("mn3_nucl","mn3_nuclCartoon","Cartoon",!0),t+=e.htmlCls.setHtmlCls.getRadio("mn3_nucl","mn3_nuclPhos","O3' Trace"),t+=e.htmlCls.setHtmlCls.getRadio("mn3_nucl","mn3_nuclBackbone","Backbone"),t+=e.htmlCls.setHtmlCls.getRadio("mn3_nucl","mn3_nuclSchematic","Schematic"),t+=e.htmlCls.setHtmlCls.getRadio("mn3_nucl","mn3_nuclLines","Lines"),t+=e.htmlCls.setHtmlCls.getRadio("mn3_nucl","mn3_nuclStick","Stick"),t+=e.htmlCls.setHtmlCls.getRadio("mn3_nucl","mn3_nuclBallstick","Ball and Stick"),t+=e.htmlCls.setHtmlCls.getRadio("mn3_nucl","mn3_nuclSphere","Sphere"),t+=e.htmlCls.setHtmlCls.getRadio("mn3_nucl","mn3_nuclNo","Hide"),t+="</ul>",t+="</li>"),t+="<li><span>Chemicals</span>",t+="<ul>",t+=e.htmlCls.setHtmlCls.getRadio("mn3_lig","mn3_ligLines","Lines"),void 0===e.cfg.cid?(t+=e.htmlCls.setHtmlCls.getRadio("mn3_lig","mn3_ligStick","Stick",!0),t+=e.htmlCls.setHtmlCls.getRadio("mn3_lig","mn3_ligBallstick","Ball and Stick")):(t+=e.htmlCls.setHtmlCls.getRadio("mn3_lig","mn3_ligStick","Stick"),t+=e.htmlCls.setHtmlCls.getRadio("mn3_lig","mn3_ligBallstick","Ball and Stick",!0)),t+=e.htmlCls.setHtmlCls.getRadio("mn3_lig","mn3_ligSchematic","Schematic"),t+=e.htmlCls.setHtmlCls.getRadio("mn3_lig","mn3_ligSphere","Sphere"),t+=e.htmlCls.setHtmlCls.getRadio("mn3_lig","mn3_ligNo","Hide"),t+="</ul>",t+="</li>",void 0!==e.cfg.cid?(t+="<li><span>Hydrogens</span>",t+="<ul>",t+=e.htmlCls.setHtmlCls.getRadio("mn3_hydrogens","mn3_hydrogensYes","Show",!0),t+=e.htmlCls.setHtmlCls.getRadio("mn3_hydrogens","mn3_hydrogensNo","Hide"),t+="</ul>",t+="</li>"):(t+="<li><span>Glycans</span>",t+="<ul>",t+=e.htmlCls.setHtmlCls.getRadio("mn3_glycansCart","mn3_glycansCartYes","Show Cartoon"),t+=e.htmlCls.setHtmlCls.getRadio("mn3_glycansCart","mn3_glycansCartNo","Hide Cartoon",!0),t+="</ul>",t+="</li>"),t+="<li><span>Ions</span>",t+="<ul>",t+=e.htmlCls.setHtmlCls.getRadio("mn3_ions","mn3_ionsSphere","Sphere",!0),t+=e.htmlCls.setHtmlCls.getRadio("mn3_ions","mn3_ionsDot","Dot"),t+=e.htmlCls.setHtmlCls.getRadio("mn3_ions","mn3_ionsNo","Hide"),t+="</ul>",t+="</li>",t+="<li><span>Water</span>",t+="<ul>",t+=e.htmlCls.setHtmlCls.getRadio("mn3_water","mn3_waterSphere","Sphere"),t+=e.htmlCls.setHtmlCls.getRadio("mn3_water","mn3_waterDot","Dot"),t+=e.htmlCls.setHtmlCls.getRadio("mn3_water","mn3_waterNo","Hide",!0),t+="</ul>",t+="</li>",t+=e.htmlCls.setHtmlCls.getLink("mn3_setThickness","Preferences"),t+="<li>-</li>",t+=e.htmlCls.setHtmlCls.getLink("mn3_styleSave","Save Style"),t+=e.htmlCls.setHtmlCls.getLink("mn3_styleApplySave","Apply Saved Style"),t+="<li>-</li>",t+="<li><span>Surface Type</span>",t+="<ul>",t+=e.htmlCls.setHtmlCls.getRadio("mn5_surface","mn5_surfaceVDW","Van der Waals"),t+=e.htmlCls.setHtmlCls.getRadio("mn5_surface","mn5_surfaceVDWContext","VDW with Context"),t+=e.htmlCls.setHtmlCls.getRadio("mn5_surface","mn5_surfaceMolecular","Molecular Surface"),t+=e.htmlCls.setHtmlCls.getRadio("mn5_surface","mn5_surfaceMolecularContext","MS with Context"),t+=e.htmlCls.setHtmlCls.getRadio("mn5_surface","mn5_surfaceSAS","Solvent Accessible"),t+=e.htmlCls.setHtmlCls.getRadio("mn5_surface","mn5_surfaceSASContext","SA with Context"),t+="</ul>",t+="</li>",t+=e.htmlCls.setHtmlCls.getLink("mn5_surfaceNo","Remove Surface"),t+="<li><span>Surface Opacity</span>",t+="<ul>",t+=e.htmlCls.setHtmlCls.getRadio("mn5_opacity","mn5_opacity10","1.0",!0);for(let s=9;s>0;--s)t+=e.htmlCls.setHtmlCls.getRadio("mn5_opacity","mn5_opacity0"+s,"0."+s);return t+="</ul>",t+="</li>",t+="<li><span>Surface Wireframe</span>",t+="<ul>",t+=e.htmlCls.setHtmlCls.getRadio("mn5_wireframe","mn5_wireframeYes","Yes"),t+=e.htmlCls.setHtmlCls.getRadio("mn5_wireframe","mn5_wireframeNo","No",!0),t+="</ul>",t+="</li>",void 0===e.cfg.cid&&void 0===e.cfg.align&&void 0===e.cfg.chainalign&&(t+="<li>-</li>",t+="<li id='"+e.pre+"mapWrapper1'><span>Electron Density</span>",t+="<ul>",t+=e.htmlCls.setHtmlCls.getRadio("mn5_elecmap","mn5_elecmap2fofc","2Fo-Fc Map"),t+=e.htmlCls.setHtmlCls.getRadio("mn5_elecmap","mn5_elecmapfofc","Fo-Fc Map"),t+="</ul>",t+="</li>",t+=e.htmlCls.setHtmlCls.getLinkWrapper("mn5_elecmapNo","Remove Map","mapWrapper2"),t+="<li id='"+e.pre+"mapWrapper3'><span>Map Wireframe</span>",t+="<ul>",t+=e.htmlCls.setHtmlCls.getRadio("mn5_mapwireframe","mn5_mapwireframeYes","Yes",!0),t+=e.htmlCls.setHtmlCls.getRadio("mn5_mapwireframe","mn5_mapwireframeNo","No"),t+="</ul>",t+="</li>",void 0===e.cfg.mmtfid&&(t+=e.htmlCls.setHtmlCls.getLinkWrapper("mn5_emmap","EM Density Map","emmapWrapper1"),t+=e.htmlCls.setHtmlCls.getLinkWrapper("mn5_emmapNo","Remove EM Map","emmapWrapper2"),t+="<li id='"+e.pre+"emmapWrapper3'><span>EM Map Wireframe</span>",t+="<ul>",t+=e.htmlCls.setHtmlCls.getRadio("mn5_emmapwireframe","mn5_emmapwireframeYes","Yes",!0),t+=e.htmlCls.setHtmlCls.getRadio("mn5_emmapwireframe","mn5_emmapwireframeNo","No"),t+="</ul>",t+="</li>")),t+="<li>-</li>",t+="<li><span>Background</span>",t+="<ul>",t+=e.htmlCls.setHtmlCls.getRadio("mn6_bkgd","mn6_bkgdTransparent","Transparent",!0),t+=e.htmlCls.setHtmlCls.getRadio("mn6_bkgd","mn6_bkgdBlack","Black"),t+=e.htmlCls.setHtmlCls.getRadio("mn6_bkgd","mn6_bkgdGrey","Grey"),t+=e.htmlCls.setHtmlCls.getRadio("mn6_bkgd","mn6_bkgdWhite","White"),t+="</ul>",t+="</li>",t+="<li><span>Dialog Color</span>",t+="<ul>",t+=e.htmlCls.setHtmlCls.getRadio("mn6_theme","mn6_themeBlue","Blue",!0),t+=e.htmlCls.setHtmlCls.getRadio("mn6_theme","mn6_themeOrange","Orange"),t+=e.htmlCls.setHtmlCls.getRadio("mn6_theme","mn6_themeBlack","Black"),t+="</ul>",t+="</li>",t+="<li><br/></li>",t+="</ul>",t}setMenu4(){let e=this.icn3dui;if(e.bNode)return"";let t="";return t+="<div class='icn3d-menu'>",t+="<accordion id='"+e.pre+"accordion4' class='icn3d-accordion'>",t+="<h3 id='"+e.pre+"color'>Color</h3>",t+="<div>",t+=this.setMenu4_base(),t+="</div>",t+="</accordion>",t+="</div>",t}setMenu4_base(){let e=this.icn3dui;if(e.bNode)return"";let t="";return t+="<ul class='icn3d-mn-item'>",t+="<li><span style='padding-left:2.3em;'>Unicolor</span>",t+="<ul>",t+="<li><span>Red</span>",t+="<ul>",t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrRed1","Red","F00"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrRed2","Indian Red","CD5C5C"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrRed3","Light Coral","F08080"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrRed4","Salmon","FA8072"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrRed5","Dark Salmon","E9967A"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrRed6","Light Salmon","FFA07A"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrRed7","Crimson","DC143C"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrRed8","Fire Brick","B22222"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrRed9","Dark Red","8B0000"),t+="</ul>",t+="<li><span>Pink</span>",t+="<ul>",t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrPink1","Pink","FFC0CB"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrPink2","Light Pink","FFB6C1"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrPink3","Hot Pink","FF69B4"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrPink4","Deep Pink","FF1493"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrPink5","Medium Violet Red","C71585"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrPink6","Pale Violet Red","DB7093"),t+="</ul>",t+="<li><span>Orange</span>",t+="<ul>",t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrOran1","Orange","FFA500"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrOran2","Dark Orange","FF8C00"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrOran3","Orange Red","FF4500"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrOran4","Tomato","FF6347"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrOran5","Coral","FF7F50"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrOran6","Light Salmon","FFA07A"),t+="</ul>",t+="<li><span>Yellow</span>",t+="<ul>",t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrYllw1","Yellow","FF0"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrYllw2","Gold","FFD700"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrYllw3","Light Yellow","FFFFE0"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrYllw4","Lemon Chiffon","FFFACD"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrYllw5","Light Golden Rod","FAFAD2"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrYllw6","Papaya Whip","FFEFD5"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrYllw7","Moccasin","FFE4B5"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrYllw8","Peach Puff","FFDAB9"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrYllw9","Pale Golden Rod","EEE8AA"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrYllw10","Khaki","F0E68C"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrYllw11","Dark Khaki","BDB76B"),t+="</ul>",t+="<li><span>Magenta</span>",t+="<ul>",t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrMgnt1","Magenta","F0F"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrMgnt2","Orchid","DA70D6"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrMgnt3","Violet","EE82EE"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrMgnt4","Plum","DDA0DD"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrMgnt5","Thistle","D8BFD8"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrMgnt6","Lavender","E6E6FA"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrMgnt7","Medium Orchid","BA55D3"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrMgnt8","Medium Purple","9370DB"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrMgnt9","Rebecca Purple","663399"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrMgnt10","Blue Violet","8A2BE2"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrMgnt11","Dark Violet","9400D3"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrMgnt12","Dark Orchid","9932CC"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrMgnt13","Dark Magenta","8B008B"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrMgnt14","Purple","800080"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrMgnt15","Indigo","4B0082"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrMgnt16","Slat Blue","6A5ACD"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrMgnt17","Dark Slate Blue","483D8B"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrMgnt18","Medium Slat Blue","6A5ACD"),t+="</ul>",t+="<li><span>Green</span>",t+="<ul>",t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrGrn1","Green","0F0"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrGrn2","Dark Green","006400"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrGrn3","Yellow Green","9ACD32"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrGrn4","Olive Drab","6B8E23"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrGrn5","Olive","808000"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrGrn6","Dark Olive Green","556B2F"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrGrn7","Medium Aquamarine","66CDAA"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrGrn8","Dark Sea Green","8FBC8B"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrGrn9","Lignt Sea Green","20B2AA"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrGrn10","Dark Cyan","008B8B"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrGrn11","Teal","008080"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrGrn12","Forest Green","228B22"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrGrn13","Sea Green","2E8B57"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrGrn14","Medium Sea Green","3CB371"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrGrn15","Spring Green","00FF7F"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrGrn16","Medium Spring","00FA9A"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrGrn17","Light Green","90EE90"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrGrn18","Pale Green","98FB98"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrGrn19","Lime Green","32CD32"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrGrn20","Lawn Green","7CFC00"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrGrn21","Chartreuse","7FFF00"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrGrn22","Green Yellow","ADFF2F"),t+="</ul>",t+="<li><span>Cyan</span>",t+="<ul>",t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrCyan1","Cyan","0FF"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrCyan2","Light Cyan","E0FFFF"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrCyan3","Pale Turquoise","AFEEEE"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrCyan4","Aquamarine","7FFFD4"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrCyan5","Turquoise","40E0D0"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrCyan6","Medium Turquoise","48D1CC"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrCyan7","Dark Turquoise","00CED1"),t+="</ul>",t+="<li><span>Blue</span>",t+="<ul>",t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrBlue1","Blue","00F"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrBlue2","Medium Blue","0000CD"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrBlue3","Dark Blue","00008B"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrBlue4","Navy","000080"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrBlue5","Midnight Blue","191970"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrBlue6","Royal Blue","4169E1"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrBlue7","Medium Slate Blue","7B68EE"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrBlue8","Corn Flower Blue","6495ED"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrBlue9","Dodger Blue","1E90FF"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrBlue10","Deep Sky Blue","00BFFF"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrBlue11","Light Sky Blue","87CEFA"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrBlue12","Sky Blue","87CEEB"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrBlue13","Light Blue","ADD8E6"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrBlue14","Powder Blue","B0E0E6"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrBlue15","Light Steel Blue","B0C4DE"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrBlue16","Steel Blue","4682B4"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrBlue17","Cadet Blue","5F9EA0"),t+="</ul>",t+="<li><span>Brown</span>",t+="<ul>",t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrBrown1","Brown","A52A2A"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrBrown2","Maroon","800000"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrBrown3","Sienna","A0522D"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrBrown4","Saddle Brown","8B4513"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrBrown5","Chocolate","D2691E"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrBrown6","Peru","CD853F"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrBrown7","Dark Golden Rod","B8860B"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrBrown8","Golden Rod","DAA520"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrBrown9","Sandy Brown","F4A460"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrBrown10","Rosy Brown","BC8F8F"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrBrown11","Tan","D2B48C"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrBrown12","Burlywood","DEB887"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrBrown13","Wheat","F5DEB3"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrBrown14","Navajo White","FFDEAD"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrBrown15","Bisque","FFE4C4"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrBrown16","Blanched Almond","FFEBCD"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrBrown17","Corn Silk","FFF8DC"),t+="</ul>",t+="<li><span>White</span>",t+="<ul>",t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrWhite1","White","FFF"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrWhite2","Snow","FFFAFA"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrWhite3","Honey Dew","F0FFF0"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrWhite4","Mint Cream","F5FFFA"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrWhite5","Azure","F0FFFF"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrWhite6","Alice Blue","F0F8FF"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrWhite7","Ghost White","F8F8FF"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrWhite8","White Smoke","F5F5F5"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrWhite9","Sea Shell","FFF5EE"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrWhite10","Beige","F5F5DC"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrWhite11","Old Lace","FDF5E6"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrWhite12","Floral White","FFFAF0"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrWhite13","Ivory","FFFFF0"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrWhite14","Antique White","FAEBD7"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrWhite15","Linen","FAF0E6"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrWhite16","Lavenderblush","FFF0F5"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrWhite17","Misty Rose","FFE4E1"),t+="</ul>",t+="<li><span>Grey</span>",t+="<ul>",t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrGray1","Gray","808080"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrGray2","Dim Gray","696969"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrGray3","Light Slate Gray","778899"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrGray4","Slate Gray","708090"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrGray5","Dark Slate Gray","2F4F4F"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrGray6","Black","000000"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrGray7","Dark Gray","A9A9A9"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrGray8","Silver","C0C0C0"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrGray9","Light Gray","D3D3D3"),t+=e.htmlCls.setHtmlCls.getRadioColor("mn4_clr","mn4_clrGray10","Gainsboro","DCDCDC"),t+="</ul>",t+="</ul>",t+=e.htmlCls.setHtmlCls.getRadio("mn4_clr","mn4_clrCustom","Color Picker"),t+="<li>-</li>",void 0===e.cfg.cid?(t+=e.htmlCls.setHtmlCls.getRadio("mn4_clr","mn4_clrSpectrum","Spectrum"),t+="<li><span style='padding-left:2.3em;'>Secondary</span>",t+="<ul>",t+=e.htmlCls.setHtmlCls.getRadio("mn4_clr","mn4_clrSSGreen","Sheet in Green"),t+=e.htmlCls.setHtmlCls.getRadio("mn4_clr","mn4_clrSSYellow","Sheet in Yellow"),t+=e.htmlCls.setHtmlCls.getRadio("mn4_clr","mn4_clrSSSpectrum","Spectrum"),t+="</ul>",t+=e.htmlCls.setHtmlCls.getRadio("mn4_clr","mn4_clrCharge","Charge"),t+=e.htmlCls.setHtmlCls.getRadio("mn4_clr","mn4_clrHydrophobic",'Wimley-White<br><span style="padding-left:1.5em;">Hydrophobicity</span>'),t+="<li><span style='padding-left:2.3em;'>B-factor</span>",t+="<ul>",t+=e.htmlCls.setHtmlCls.getRadio("mn4_clr","mn4_clrBfactor","Original"),t+=e.htmlCls.setHtmlCls.getRadio("mn4_clr","mn4_clrBfactorNorm","Percentile"),t+="</ul>",t+=e.htmlCls.setHtmlCls.getRadio("mn4_clr","mn4_clrArea",'Solvent<br><span style="padding-left:1.5em;">Accessibility</span>'),void 0!==e.cfg.align||void 0!==e.cfg.chainalign||void 0!==e.cfg.blast_rep_id?t+=e.htmlCls.setHtmlCls.getRadio("mn4_clr","mn4_clrChain","Chain"):t+=e.htmlCls.setHtmlCls.getRadio("mn4_clr","mn4_clrChain","Chain",!0),void 0===e.cfg.mmdbid&&void 0===e.cfg.gi||(t+=e.htmlCls.setHtmlCls.getRadio("mn4_clr","mn4_clrdomain","3D Domain")),t+="<li><span style='padding-left:2.3em;'>Residue</span>",t+="<ul>",t+=e.htmlCls.setHtmlCls.getRadio("mn4_clr","mn4_clrResidue","Default"),t+=e.htmlCls.setHtmlCls.getRadio("mn4_clr","mn4_clrResidueCustom","Custom"),t+="</ul>",t+=e.htmlCls.setHtmlCls.getRadio("mn4_clr","mn4_clrAtom","Atom"),void 0!==e.cfg.align||void 0!==e.cfg.chainalign?(t+=e.htmlCls.setHtmlCls.getRadio("mn4_clr","mn4_clrIdentity","Identity",!0),t+=e.htmlCls.setHtmlCls.getRadio("mn4_clr","mn4_clrConserved","Conservation")):void 0!==e.cfg.blast_rep_id&&(t+=e.htmlCls.setHtmlCls.getRadio("mn4_clr","mn4_clrIdentity","Identity"),t+=e.htmlCls.setHtmlCls.getRadio("mn4_clr","mn4_clrConserved","Conservation",!0))):(e.cfg.hidelicense||(t+=e.htmlCls.setHtmlCls.getRadio("mn4_clr","mn1_delphi2",'DelPhi<br><span style="padding-left:1.5em;">Potential '+e.htmlCls.licenseStr+"</span>")),t+=e.htmlCls.setHtmlCls.getRadio("mn4_clr","mn4_clrAtom","Atom",!0)),t+="<li>-</li>",t+=e.htmlCls.setHtmlCls.getLink("mn4_clrSave","Save Color"),t+=e.htmlCls.setHtmlCls.getLink("mn4_clrApplySave","Apply Saved Color"),t+="<li><br/></li>",t+="</ul>",t}setMenu5(){let e=this.icn3dui;if(e.bNode)return"";let t="";return t+="<div class='icn3d-menu'>",t+="<accordion id='"+e.pre+"accordion5' class='icn3d-accordion'>",t+="<h3 id='"+e.pre+"analysis' style='font-size:1.2em'>&nbsp;Analysis</h3>",t+="<div>",t+=this.setMenu5_base(),t+="</div>",t+="</accordion>",t+="</div>",t}setMenu5_base(){let e=this.icn3dui;if(e.bNode)return"";let t="";t+="<ul class='icn3d-mn-item'>",void 0===e.cfg.cid&&(t+=e.htmlCls.setHtmlCls.getLink("mn6_selectannotations","Seq. & Annotations "+e.htmlCls.wifiStr),t+=e.htmlCls.setHtmlCls.getLink("mn2_alignment","Aligned Seq. "+e.htmlCls.wifiStr),void 0===e.cfg.mmdbid&&void 0===e.cfg.gi&&void 0===e.cfg.blast_rep_id&&void 0===e.cfg.align&&void 0===e.cfg.chainalign||(t+=e.htmlCls.setHtmlCls.getLink("mn2_2ddgm","2D Diagram "+e.htmlCls.wifiStr)),t+=e.htmlCls.setHtmlCls.getLink("definedsets2","Defined Sets"),t+="<li>-</li>",t+=e.htmlCls.setHtmlCls.getLink("mn6_hbondsYes","Interactions"),t+=e.htmlCls.setHtmlCls.getLink("mn6_contactmap","Contact Map"),t+="<li><span>Bring to Front</span>",t+="<ul>",t+=e.htmlCls.setHtmlCls.getLink("mn1_window_table","Interaction Table"),t+=e.htmlCls.setHtmlCls.getLink("mn1_window_linegraph","2D Interaction Network"),t+=e.htmlCls.setHtmlCls.getLink("mn1_window_scatterplot","2D Interaction Map"),t+=e.htmlCls.setHtmlCls.getLink("mn1_window_graph","2D Graph(Force-Directed)"),t+="</ul>",t+="</li>",e.cfg.notebook||e.cfg.hidelicense||(t+=e.htmlCls.setHtmlCls.getLink("mn1_mutation","Mutation "+e.htmlCls.wifiStr)),t+="<li>-</li>"),e.cfg.notebook||e.cfg.hidelicense||(t+=e.htmlCls.setHtmlCls.getLink("mn1_delphi","DelPhi Potential "+e.htmlCls.licenseStr),t+="<li><span>Load PQR/Phi</span>",t+="<ul>",t+=e.htmlCls.setHtmlCls.getLink("mn1_phi","Local PQR/Phi/Cube File"),t+=e.htmlCls.setHtmlCls.getLink("mn1_phiurl","URL PQR/Phi/Cube File"),t+="</ul>",t+=e.htmlCls.setHtmlCls.getLink("delphipqr","Download PQR"),t+="<li>-</li>"),t+="<li><span>Distance</span>",t+="<ul>",t+=e.htmlCls.setHtmlCls.getRadio("mn6_distance","mn6_distanceYes","between Two Atoms"),t+=e.htmlCls.setHtmlCls.getRadio("mn6_distance","mn6_distTwoSets","between Two Sets"),t+=e.htmlCls.setHtmlCls.getRadio("mn6_distance","mn6_distanceNo","Hide",!0),t+="</ul>",t+="</li>",t+=e.htmlCls.setHtmlCls.getLink("mn6_area","Surface Area"),t+="<li><span>Label</span>",t+="<ul>",t+=e.htmlCls.setHtmlCls.getRadio("mn6_addlabel","mn6_addlabelYes","by Picking Atoms"),t+=e.htmlCls.setHtmlCls.getRadio("mn6_addlabel","mn6_addlabelSelection","per Selection"),t+=e.htmlCls.setHtmlCls.getRadio("mn6_addlabel","mn6_addlabelAtoms","per Atom"),void 0===e.cfg.cid&&(t+=e.htmlCls.setHtmlCls.getRadio("mn6_addlabel","mn6_addlabelResidues","per Residue"),t+=e.htmlCls.setHtmlCls.getRadio("mn6_addlabel","mn6_addlabelResnum","per Residue & Number"),t+=e.htmlCls.setHtmlCls.getRadio("mn6_addlabel","mn6_addlabelChains","per Chain"),t+=e.htmlCls.setHtmlCls.getRadio("mn6_addlabel","mn6_addlabelTermini","N- & C-Termini")),t+=e.htmlCls.setHtmlCls.getRadio("mn6_addlabel","mn6_addlabelNo","Remove",!0),t+="</ul>",t+="</li>",t+="<li><span>Label Scale</span>",t+="<ul>";for(let s=1;s<=4;++s){let i=2*s;t+=e.htmlCls.setHtmlCls.getRadio("mn6_labelscale","mn6_labelscale0"+i,"0."+i)}for(let s=1;s<=5;++s)t+=1==s?e.htmlCls.setHtmlCls.getRadio("mn6_labelscale","mn6_labelscale"+s+"0",s+".0",!0):e.htmlCls.setHtmlCls.getRadio("mn6_labelscale","mn6_labelscale"+s+"0",s+".0");if(t+="</ul>",t+="</li>",t+="<li>-</li>",void 0===e.cfg.cid){t+="<li><span>Chem. Binding</span>",t+="<ul>",t+=e.htmlCls.setHtmlCls.getRadio("mn6_chemicalbinding","mn6_chemicalbindingshow","Show"),t+=e.htmlCls.setHtmlCls.getRadio("mn6_chemicalbinding","mn6_chemicalbindinghide","Hide",!0),t+="</ul>",t+="</li>",t+="<li><span>Disulfide Bonds</span>",t+="<ul>",t+=e.htmlCls.setHtmlCls.getRadio("mn6_ssbonds","mn6_ssbondsYes","Show",!0),t+=e.htmlCls.setHtmlCls.getRadio("mn6_ssbonds","mn6_ssbondsExport","Export Pairs"),t+=e.htmlCls.setHtmlCls.getRadio("mn6_ssbonds","mn6_ssbondsNo","Hide"),t+="</ul>",t+="</li>",t+="<li><span>Cross-Linkages</span>",t+="<ul>",t+=e.htmlCls.setHtmlCls.getRadio("mn6_clbonds","mn6_clbondsYes","Show",!0),t+=e.htmlCls.setHtmlCls.getRadio("mn6_clbonds","mn6_clbondsExport","Export Pairs"),t+=e.htmlCls.setHtmlCls.getRadio("mn6_clbonds","mn6_clbondsNo","Hide"),t+="</ul>",t+="</li>";let s=void 0!==e.cfg.mmtfid||void 0!==e.cfg.pdbid||void 0!==e.cfg.opmid||void 0!==e.cfg.mmcifid||void 0!==e.cfg.mmdbid||void 0!==e.cfg.gi||void 0!==e.cfg.blast_rep_id;s&&(t+="<li id='"+e.pre+"assemblyWrapper'><span>Assembly</span>",t+="<ul>",t+=e.htmlCls.setHtmlCls.getRadio("mn6_assembly","mn6_assemblyYes","Biological Assembly",!0),t+=e.htmlCls.setHtmlCls.getRadio("mn6_assembly","mn6_assemblyNo","Asymmetric Unit"),t+="</ul>",t+="</li>"),t+="<li><span>Symmetry</span>",t+="<ul>",s&&(t+=e.htmlCls.setHtmlCls.getLink("mn6_symmetry","from PDB(precalculated) "+e.htmlCls.wifiStr)),t+=e.htmlCls.setHtmlCls.getLink("mn6_symd","from SymD(Dynamic) "+e.htmlCls.wifiStr),t+=e.htmlCls.setHtmlCls.getLink("mn6_clear_sym","Clear SymD Symmetry"),t+=e.htmlCls.setHtmlCls.getLink("mn6_axes_only","Show Axes Only"),t+="</ul>",t+="</li>",t+="<li>-</li>"}return t+=e.htmlCls.setHtmlCls.getLink("mn6_yournote","Window Title"),void 0!==e.cfg.cid?(t+="<li><span>Links</span>",t+="<ul>",t+=e.htmlCls.setHtmlCls.getLink("mn1_link_structure","Compound Summary "+e.htmlCls.wifiStr),t+=e.htmlCls.setHtmlCls.getLink("mn1_link_vast","Similar Compounds "+e.htmlCls.wifiStr),t+=e.htmlCls.setHtmlCls.getLink("mn1_link_bind","Structures Bound "+e.htmlCls.wifiStr),t+="</ul>",t+="</li>"):(t+="<li><span>Links</span>",t+="<ul>",t+=e.htmlCls.setHtmlCls.getLink("mn1_link_structure","Structure Summary "+e.htmlCls.wifiStr),t+=e.htmlCls.setHtmlCls.getLink("mn1_link_vast","Similar Structures "+e.htmlCls.wifiStr),t+=e.htmlCls.setHtmlCls.getLink("mn1_link_pubmed","Literature "+e.htmlCls.wifiStr),t+=e.htmlCls.setHtmlCls.getLink("mn1_link_protein","Protein "+e.htmlCls.wifiStr),t+="</ul>",t+="</li>"),t+="<li><br/></li>",t+="</ul>",t}setMenu6(){let e=this.icn3dui;if(e.bNode)return"";let t="";return t+="<div class='icn3d-menu'>",t+="<accordion id='"+e.pre+"accordion6' class='icn3d-accordion'>",t+="<h3>Help</h3>",t+="<div>",t+=this.setMenu6_base(),t+="</div>",t+="</accordion>",t+="</div>",t}setMenu6_base(){let e=this.icn3dui;if(e.bNode)return"";let t="",s="<li><a href='";return t+="<ul class='icn3d-mn-item'>",t+=s+e.htmlCls.baseUrl+"icn3d/icn3d.html#about' target='_blank'>About iCn3D<span style='font-size:0.9em'> "+e.REVISION+"</span></a></li>",t+=s+e.htmlCls.baseUrl+"icn3d/icn3d.html#gallery' target='_blank'>Live Gallery "+e.htmlCls.wifiStr+"</a></li>",t+="<li><span>Tutorial</span>",t+="<ul>",t+=s+e.htmlCls.baseUrl+"icn3d/icn3d.html#useicn3d' target='_blank'>Use iCn3D</a></li>",t+=s+e.htmlCls.baseUrl+"icn3d/icn3d.html#videos' target='_blank'>iCn3D Videos</a></li>",t+=s+e.htmlCls.baseUrl+"icn3d/icn3d.html#parameters' target='_blank'>URL Parameters</a></li>",t+=s+e.htmlCls.baseUrl+"icn3d/icn3d.html#commands' target='_blank'>Commands</a></li>",t+="</ul>",t+="</li>",t+=s+"https://www.ncbi.nlm.nih.gov/structure' target='_blank'>Search Structure "+e.htmlCls.wifiStr+"</a></li>",t+=s+e.htmlCls.baseUrl+"icn3d/icn3d.html#citing' target='_blank'>Citing iCn3D</a></li>",t+="<li><span>Source Code</span>",t+="<ul>",t+=s+"https://github.com/ncbi/icn3d' target='_blank'>GitHub (browser) "+e.htmlCls.wifiStr+"</a></li>",t+=s+"https://www.npmjs.com/package/icn3d' target='_blank'>npm (Node.js) "+e.htmlCls.wifiStr+"</a></li>",t+=s+"https://pypi.org/project/icn3dpy' target='_blank'>Jupyter Notebook "+e.htmlCls.wifiStr+"</a></li>",t+="</ul>",t+="</li>",t+="<li><span>Develop</span>",t+="<ul>",t+=s+e.htmlCls.baseUrl+"icn3d/icn3d.html#HowToUse' target='_blank'>How to Embed</a></li>",t+=s+e.htmlCls.baseUrl+"icn3d/icn3d.html#datastructure' target='_blank'>Data Structure</a></li>",t+=s+e.htmlCls.baseUrl+"icn3d/icn3d.html#classstructure' target='_blank'>Class Structure</a></li>",t+=s+e.htmlCls.baseUrl+"icn3d/icn3d.html#addclass' target='_blank'>Add New Classes</a></li>",t+=s+e.htmlCls.baseUrl+"icn3d/icn3d.html#modifyfunction' target='_blank'>Modify Functions</a></li>",t+="</ul>",t+="</li>",t+=s+e.htmlCls.baseUrl+"icn3d/docs/icn3d_help.html' target='_blank'>Help Doc "+e.htmlCls.wifiStr+"</a></li>",t+="<li>-</li>",t+="<li><span>Transform Hints</span>",t+="<ul>",t+="<li><span>Rotate</span>",t+="<ul>",t+="<li>Left Mouse</li>",t+="<li>Key l: Left</li>",t+="<li>Key j: Right</li>",t+="<li>Key i: Up</li>",t+="<li>Key m: Down</li>",t+="<li>Shift + Key l: Left 90&deg;</li>",t+="<li>Shift + Key j: Right 90&deg;</li>",t+="<li>Shift + Key i: Up 90&deg;</li>",t+="<li>Shift + Key m: Down 90&deg;</li>",t+="</ul>",t+="</li>",t+="<li><span>Zoom</span>",t+="<ul>",t+="<li>Middle Mouse</li>",t+="<li>Key z: Zoom in</li>",t+="<li>Key x: Zoom out</li>",t+="</ul>",t+="</li>",t+="<li><span>Translate</span>",t+="<ul>",t+="<li>Right Mouse</li>",t+="</ul>",t+="</li>",t+="</ul>",t+="</li>",t+=s+e.htmlCls.baseUrl+"icn3d/icn3d.html#HowToUseStep5' target='_blank'>Selection Hints</a></li>",t+="<li><br/></li>",t+="</ul>",t}hideMenu(){let e=this.icn3dui;e.bNode||(void 0!==$("#"+e.pre+"mnlist")[0]&&($("#"+e.pre+"mnlist")[0].style.display="none"),void 0!==$("#"+e.pre+"mnLogSection")[0]&&($("#"+e.pre+"mnLogSection")[0].style.display="none"),void 0!==$("#"+e.pre+"cmdlog")[0]&&($("#"+e.pre+"cmdlog")[0].style.display="none"),$("#"+e.pre+"title")[0].style.margin="10px 0 0 10px")}showMenu(){let e=this.icn3dui;e.bNode||(void 0!==$("#"+e.pre+"mnlist")[0]&&($("#"+e.pre+"mnlist")[0].style.display="block"),void 0!==$("#"+e.pre+"mnLogSection")[0]&&($("#"+e.pre+"mnLogSection")[0].style.display="block"),void 0!==$("#"+e.pre+"cmdlog")[0]&&($("#"+e.pre+"cmdlog")[0].style.display="block"))}}class Ze{constructor(e){this.icn3dui=e}openDlg(e,t){let s=this.icn3dui;s.icn3d,s.bNode||(e=s.pre+e,s.cfg.notebook?this.openDlgNotebook(e,t):this.openDlgRegular(e,t),s.htmlCls.themecolor||(s.htmlCls.themecolor="blue"),s.htmlCls.setMenuCls.setTheme(s.htmlCls.themecolor))}addSaveButton(e){let t=this.icn3dui;t.icn3d,t.bNode||void 0!==this.dialogHashSave&&this.dialogHashSave.hasOwnProperty(e)||($("#"+e).parent().children(".ui-dialog-titlebar").append("<span pid='"+e+"' class='icn3d-saveicon ui-icon ui-icon-disk' title='Save as an HTML file'></span>"),void 0===this.dialogHashSave&&(this.dialogHashSave={}),this.dialogHashSave[e]=1)}addHideButton(e){let t=this.icn3dui;t.icn3d,t.bNode||void 0!==this.dialogHashHide&&this.dialogHashHide.hasOwnProperty(e)||($("#"+e).parent().children(".ui-dialog-titlebar").append("<span pid='"+e+"' class='icn3d-hideicon ui-icon ui-icon-arrowthick-2-ne-sw' title='Resize the window'></span>"),void 0===this.dialogHashHide&&(this.dialogHashHide={}),this.dialogHashHide[e]=1)}getDialogStatus(){let e=this.icn3dui;if(e.icn3d,e.bNode)return;let t={},s=$("#"+e.pre+"dl_selectannotations").hasClass("ui-dialog-content"),i=$("#"+e.pre+"dl_graph").hasClass("ui-dialog-content"),l=$("#"+e.pre+"dl_linegraph").hasClass("ui-dialog-content"),n=$("#"+e.pre+"dl_scatterplot").hasClass("ui-dialog-content"),o=$("#"+e.pre+"dl_contactmap").hasClass("ui-dialog-content"),r=$("#"+e.pre+"dl_interactionsorted").hasClass("ui-dialog-content"),a=$("#"+e.pre+"dl_alignment").hasClass("ui-dialog-content"),d=$("#"+e.pre+"dl_2ddgm").hasClass("ui-dialog-content"),c=$("#"+e.pre+"dl_definedsets").hasClass("ui-dialog-content");return t.bSelectannotationsInit2=!1,t.bGraph2=!1,t.bLineGraph2=!1,t.bScatterplot2=!1,t.bTable2=!1,t.bAlignmentInit2=!1,t.bTwoddgmInit2=!1,t.bSetsInit2=!1,s&&(t.bSelectannotationsInit2=$("#"+e.pre+"dl_selectannotations").dialog("isOpen")),i&&(t.bGraph2=$("#"+e.pre+"dl_graph").dialog("isOpen")),l&&(t.bLineGraph2=$("#"+e.pre+"dl_linegraph").dialog("isOpen")),n&&(t.bScatterplot2=$("#"+e.pre+"dl_scatterplot").dialog("isOpen")),o&&(t.bContactmap2=$("#"+e.pre+"dl_contactmap").dialog("isOpen")),r&&(t.bTable2=$("#"+e.pre+"dl_interactionsorted").dialog("isOpen")),a&&(t.bAlignmentInit2=$("#"+e.pre+"dl_alignment").dialog("isOpen")),d&&(t.bTwoddgmInit2=$("#"+e.pre+"dl_2ddgm").dialog("isOpen")),c&&(t.bSetsInit2=$("#"+e.pre+"dl_definedsets").dialog("isOpen")),t}openDlgHalfWindow(e,t,s,i){let l=this.icn3dui,n=l.icn3d;if(l.bNode)return;let o=this;n.resizeCanvasCls.resizeCanvas(l.htmlCls.WIDTH-s,l.htmlCls.HEIGHT,i);let r,a=l.htmlCls.HEIGHT,d=s;r=!l.cfg.showmenu||l.utilsCls.isMobile()||l.cfg.mobilemenu?{my:"left top",at:"right top",of:"#"+l.pre+"viewer",collision:"none"}:{my:"left top",at:"right top+40",of:"#"+l.pre+"viewer",collision:"none"},l.cfg.resize=!1,window.dialog=$("#"+e).dialog({autoOpen:!0,title:t,height:a,width:d,modal:!1,position:r,close:function(t){let s=o.getDialogStatus();if(!((e!==l.pre+"dl_selectannotations"||s.bAlignmentInit2||s.bGraph2||s.bTable2||s.bLineGraph2||s.bScatterplot2||s.bContactmap2)&&(e!==l.pre+"dl_graph"||s.bSelectannotationsInit2||s.bAlignmentInit2||s.bTable2||s.bLineGraph2||s.bScatterplot2||s.bContactmap2)&&(e!==l.pre+"dl_alignment"||s.bSelectannotationsInit2||s.bGraph2||s.bTable2||s.bLineGraph2||s.bScatterplot2||s.bContactmap2)&&(e!==l.pre+"dl_interactionsorted"||s.bSelectannotationsInit2||s.bGraph2||s.bAlignmentInit2||s.bLineGraph2||s.bScatterplot2||s.bContactmap2)&&(e!==l.pre+"dl_linegraph"||s.bSelectannotationsInit2||s.bGraph2||s.bAlignmentInit2||s.bTable2||s.bScatterplot2||s.bContactmap2)&&(e!==l.pre+"dl_scatterplot"||s.bSelectannotationsInit2||s.bGraph2||s.bAlignmentInit2||s.bTable2||s.bLineGraph2||s.bContactmap2)&&(e!==l.pre+"dl_contactmap"||s.bSelectannotationsInit2||s.bGraph2||s.bAlignmentInit2||s.bTable2||s.bLineGraph2||s.bScatterplot2)))if(s.bTwoddgmInit2||s.bSetsInit2){let e=l.utilsCls.isMobile()?l.htmlCls.WIDTH:l.htmlCls.WIDTH-170;n.resizeCanvasCls.resizeCanvas(e,l.htmlCls.HEIGHT,!0),s.bTwoddgmInit2&&o.openDlg2Ddgm(l.pre+"dl_2ddgm",void 0,s.bSetsInit2),s.bSetsInit2&&o.openDlg2Ddgm(l.pre+"dl_definedsets")}else n.resizeCanvasCls.resizeCanvas(l.htmlCls.WIDTH,l.htmlCls.HEIGHT,!0)},resize:function(t){if(e==l.pre+"dl_selectannotations")n.annotationCls.hideFixedTitle();else if(e==l.pre+"dl_graph"){let t=$("#"+e).width(),s=$("#"+e).height();d3.select("#"+l.svgid).attr("width",t).attr("height",s)}else if(e==l.pre+"dl_linegraph"||e==l.pre+"dl_scatterplot"||e==l.pre+"dl_contactmap"){let t=status.bTwoddgmInit2||status.bSetsInit2?(l.htmlCls.WIDTH-170)/2:l.htmlCls.WIDTH/2,s=$("#"+e).width()/t;if(e==l.pre+"dl_linegraph"){let e=n.linegraphWidth*s;$("#"+l.linegraphid).attr("width",e)}else if(e==l.pre+"dl_scatterplot"){let e=n.scatterplotWidth*s;$("#"+l.scatterplotid).attr("width",e)}else if(e==l.pre+"dl_contactmap"){let e=n.contactmapWidth*s;$("#"+l.contactmapid).attr("width",e)}}}}),this.addSaveButton(e),this.addHideButton(e)}openDlg2Ddgm(e,t,s){let i=this.icn3dui,l=i.icn3d;if(i.bNode)return;let n,o,r=this;e===i.pre+"dl_definedsets"?(n="right top",o="Select sets"):e===i.pre+"dl_2ddgm"&&(n=s?"right top+240":"right top",o="2D Diagram");let a={my:"left top+"+i.htmlCls.MENU_HEIGHT,at:n,of:"#"+i.pre+"viewer",collision:"none"};window.dialog=$("#"+e).dialog({autoOpen:!0,title:o,height:"auto",width:170,modal:!1,position:a,close:function(e){let t=r.getDialogStatus();t.bSelectannotationsInit2||t.bGraph2||t.bLineGraph2||t.bScatterplot2||t.bTable2||t.bAlignmentInit2||l.resizeCanvasCls.resizeCanvas(i.htmlCls.WIDTH,i.htmlCls.HEIGHT,!0)}}),this.addSaveButton(e),this.addHideButton(e)}openDlgRegular(e,t){let s=this.icn3dui,i=s.icn3d;if(s.bNode)return;let l=400,n=150,o=170,r=this.getDialogStatus();if(e===s.pre+"dl_selectannotations"||e===s.pre+"dl_graph"||e===s.pre+"dl_linegraph"||e===s.pre+"dl_scatterplot"||e===s.pre+"dl_contactmap"||e===s.pre+"dl_interactionsorted"||e===s.pre+"dl_alignment"){let a=.5*s.htmlCls.WIDTH-85;if(s.htmlCls.WIDTH>=s.htmlCls.HEIGHT)this.openDlgHalfWindow(e,t,a,!0),(r.bTwoddgmInit2||r.bSetsInit2)&&(i.resizeCanvasCls.resizeCanvas(s.htmlCls.WIDTH-a-o,s.htmlCls.HEIGHT,!0),r.bTwoddgmInit2&&this.openDlg2Ddgm(s.pre+"dl_2ddgm",void 0,r.bSetsInit2),r.bSetsInit2&&this.openDlg2Ddgm(s.pre+"dl_definedsets"));else{i.resizeCanvasCls.resizeCanvas(s.htmlCls.WIDTH,.5*s.htmlCls.HEIGHT,!0),n=.5*s.htmlCls.HEIGHT,l=s.htmlCls.WIDTH;let a={my:"left top",at:"left bottom+32",of:"#"+s.pre+"canvas",collision:"none"};window.dialog=$("#"+e).dialog({autoOpen:!0,title:t,height:n,width:l,modal:!1,position:a,close:function(t){if(!((e!==s.pre+"dl_selectannotations"||r.bAlignmentInit2||r.bGraph2||r.bTable2||r.bLineGraph2||r.bScatterplot2||r.bContactmap2)&&(e!==s.pre+"dl_graph"||r.bSelectannotationsInit2||r.bAlignmentInit2||r.bTable2||r.bLineGraph2||r.bScatterplot2||r.bContactmap2)&&(e!==s.pre+"dl_alignment"||r.bSelectannotationsInit2||r.bGraph2||r.bTable2||r.bLineGraph2||r.bScatterplot2||r.bContactmap2)&&(e!==s.pre+"dl_interactionsorted"||r.bSelectannotationsInit2||r.bGraph2||r.bAlignmentInit2||r.bLineGraph2||r.bScatterplot2||r.bContactmap2)&&(e!==s.pre+"dl_linegraph"||r.bSelectannotationsInit2||r.bGraph2||r.bAlignmentInit2||r.bTable2||r.bScatterplot2||r.bContactmap2)&&(e!==s.pre+"dl_scatterplot"||r.bSelectannotationsInit2||r.bGraph2||r.bAlignmentInit2||r.bTable2||r.bLineGraph2||r.bContactmap2)&&(e!==s.pre+"dl_contactmap"||r.bSelectannotationsInit2||r.bGraph2||r.bAlignmentInit2||r.bTable2||r.bLineGraph2||r.bScatterplot2)))if(r.bTwoddgmInit2||r.bSetsInit2){let e=s.utilsCls.isMobile()?s.htmlCls.WIDTH:s.htmlCls.WIDTH-o;i.resizeCanvasCls.resizeCanvas(e,s.htmlCls.HEIGHT,!0),r.bTwoddgmInit2&&thisClass.openDlg2Ddgm(s.pre+"dl_2ddgm",void 0,r.bSetsInit2),r.bSetsInit2&&thisClass.openDlg2Ddgm(s.pre+"dl_definedsets")}else i.resizeCanvasCls.resizeCanvas(s.htmlCls.WIDTH,s.htmlCls.HEIGHT,!0)},resize:function(t){if(e==s.pre+"dl_selectannotations")i.annotationCls.hideFixedTitle();else if(e==s.pre+"dl_graph"){let t=$("#"+e).width(),i=$("#"+e).height();d3.select("#"+s.svgid).attr("width",t).attr("height",i)}else if(e==s.pre+"dl_linegraph"||e==s.pre+"dl_scatterplot"||e==s.pre+"dl_contactmap"){let t=r.bTwoddgmInit2||r.bSetsInit2?(s.htmlCls.WIDTH-o)/2:s.htmlCls.WIDTH/2,l=$("#"+e).width()/t;if(e==s.pre+"dl_linegraph"){let e=i.linegraphWidth*l;$("#"+s.linegraphid).attr("width",e)}else if(e==s.pre+"dl_scatterplot"){let e=i.scatterplotWidth*l;$("#"+s.scatterplotid).attr("width",e)}else if(e==s.pre+"dl_contactmap"){let e=i.contactmapWidth*l;$("#"+s.contactmapid).attr("width",e)}}}}),this.addSaveButton(e),this.addHideButton(e)}}else if(e===s.pre+"dl_2ddgm"){let t=0;if(s.htmlCls.WIDTH>=s.htmlCls.HEIGHT)(r.bSelectannotationsInit2||r.bGraph2||r.bLineGraph2||r.bScatterplot2||r.bTable2||r.bAlignmentInit2)&&(t=.5*s.htmlCls.WIDTH-85),i.resizeCanvasCls.resizeCanvas(s.htmlCls.WIDTH-t-o,s.htmlCls.HEIGHT,!0),this.openDlg2Ddgm(e,void 0,r.bSetsInit2);else{let t=s.utilsCls.isMobile()?s.htmlCls.WIDTH:s.htmlCls.WIDTH-o;i.resizeCanvasCls.resizeCanvas(t,.5*s.htmlCls.HEIGHT,!0),this.openDlg2Ddgm(e,.5*s.htmlCls.HEIGHT),this.openDlg2Ddgm(e,.5*s.htmlCls.HEIGHT,r.bSetsInit2)}}else{let a;if(n="auto",l="auto",e===s.pre+"dl_addtrack"&&(l="50%"),e===s.pre+"dl_definedsets"){let t=0;if(s.htmlCls.WIDTH>=s.htmlCls.HEIGHT)(r.bSelectannotationsInit2||r.bGraph2||r.bLineGraph2||r.bScatterplot2||r.bTable2||r.bAlignmentInit2)&&(t=.5*s.htmlCls.WIDTH-85),i.resizeCanvasCls.resizeCanvas(s.htmlCls.WIDTH-t-o,s.htmlCls.HEIGHT,!0),this.openDlg2Ddgm(e),r.bTwoddgmInit2&&this.openDlg2Ddgm(s.pre+"dl_2ddgm",void 0,!0);else{let t=s.utilsCls.isMobile()?s.htmlCls.WIDTH:s.htmlCls.WIDTH-o;i.resizeCanvasCls.resizeCanvas(t,.5*s.htmlCls.HEIGHT,!0),this.openDlg2Ddgm(e,.5*s.htmlCls.HEIGHT),r.bTwoddgmInit2&&this.openDlg2Ddgm(s.pre+"dl_2ddgm",.5*s.htmlCls.HEIGHT,!0)}}else s.utilsCls.isMobile()?a={my:"left top",at:"left bottom-50",of:"#"+s.pre+"canvas",collision:"none"}:e===s.pre+"dl_allinteraction"||e===s.pre+"dl_buriedarea"?(a={my:"right top",at:"right top+50",of:"#"+i.divid,collision:"none"},l=700,n=500):a=e===s.pre+"dl_rmsd"?{my:"left top",at:"right bottom-90",of:"#"+s.pre+"canvas",collision:"none"}:e===s.pre+"dl_symd"?{my:"left top",at:"right-200 bottom-200",of:"#"+s.pre+"canvas",collision:"none"}:s.cfg.align?{my:"left top",at:"left top+90",of:"#"+s.pre+"canvas",collision:"none"}:{my:"left top",at:"left top+50",of:"#"+s.pre+"canvas",collision:"none"},window.dialog=$("#"+e).dialog({autoOpen:!0,title:t,height:n,width:l,modal:!1,position:a}),this.addSaveButton(e),this.addHideButton(e)}$(".ui-dialog .ui-button span").removeClass("ui-icon-closethick").addClass("ui-icon-close")}openDlgNotebook(e,t){let s=this.icn3dui,i=s.icn3d;if(s.bNode)return;let l=400,n=150;e===s.pre+"dl_selectannotations"||e===s.pre+"dl_graph"||e===s.pre+"dl_linegraph"||e===s.pre+"dl_scatterplot"||e===s.pre+"dl_contactmap"||e===s.pre+"dl_interactionsorted"||e===s.pre+"dl_alignment"?($("#"+e).show(),n=.5*s.htmlCls.HEIGHT,l=s.htmlCls.WIDTH,$("#"+e).width(l),$("#"+e).height(n),$("#"+e).resize((function(t){let l=s.htmlCls.WIDTH/2,n=$("#"+e).width()/l;if(e==s.pre+"dl_selectannotations")i.annotationCls.hideFixedTitle();else if(e==s.pre+"dl_graph"){let t=$("#"+e).width(),i=$("#"+e).height();d3.select("#"+s.svgid).attr("width",t).attr("height",i)}else if(e==s.pre+"dl_linegraph"){let e=i.linegraphWidth*n;$("#"+s.linegraphid).attr("width",e)}else if(e==s.pre+"dl_scatterplot"){let e=i.scatterplotWidth*n;$("#"+s.scatterplotid).attr("width",e)}else if(e==s.pre+"dl_contactmap"){let e=i.contactmapWidth*n;$("#"+s.contactmapid).attr("width",e)}}))):(i.bRender&&$("#"+e).show(),n="auto",l="auto",e===s.pre+"dl_addtrack"?l="50%":e===s.pre+"dl_2ddgm"||e===s.pre+"dl_definedsets"?l=170:e!==s.pre+"dl_allinteraction"&&e!==s.pre+"dl_buriedarea"||(l=700,n=500),$("#"+e).width(l),$("#"+e).height(n))}}class et{constructor(e){this.icn3dui=e}setCustomDialogs(){var e=this.icn3dui;if(e.icn3d,e.bNode)return"";return""}setDialogs(){let e=this.icn3dui,t=e.icn3d;if(e.bNode)return"";let s="";e.htmlCls.optionStr="<option value=",s+="\x3c!-- dialog will not be part of the form --\x3e";let i=e.cfg.notebook?"":"icn3d-hidden",l=e.cfg.notebook?"icn3d-hidden":"";s+=e.htmlCls.divStr+"alldialogs' class='"+i+" icn3d-dialog'>",s+=e.htmlCls.divStr+"dl_2ddgm' class='"+l+" icn3d-dl_2ddgm'>",s+="</div>",s+=e.htmlCls.divStr+"dl_alignment' class='"+l+"' style='background-color:white;'>",s+=e.htmlCls.divStr+"symd_info'></div>",s+=e.htmlCls.divStr+"alignseqguide_wrapper'><br>"+e.htmlCls.setHtmlCls.setAlignSequenceGuide()+"</div>",s+=e.htmlCls.divStr+"dl_sequence2' class='icn3d-dl_sequence'>",s+="</div>",s+="</div>",s+=e.htmlCls.divStr+"dl_definedsets' class='"+l+"'>",s+=e.htmlCls.divStr+"dl_setsmenu'>",s+="<b>Defined Sets:</b> <br/>",s+="<select id='"+e.pre+"atomsCustom' multiple size='6' style='min-width:130px;'>",s+="</select>",s+="<div style='margin: 6px 0 6px 0;'>"+e.htmlCls.buttonStr+"deletesets'><b>Delete Selected Sets</b></button></div>",s+='        <b>Set Operations</b>: <div style="width:20px; margin-top:6px; display:inline-block;"><span id="'+e.pre+'dl_command_expand" class="ui-icon ui-icon-plus icn3d-expand icn3d-link" style="width:15px;" title="Expand"></span><span id="'+e.pre+'dl_command_shrink" class="ui-icon ui-icon-minus icn3d-shrink icn3d-link" style="display:none; width:15px;" title="Shrink"></span></div><br>',s+="</div>",s+=e.htmlCls.divStr+"dl_command' style='display:none;'>",s+=e.htmlCls.divStr+"dl_setoperations'>",s+="<label for='"+e.pre+"setOr'>"+e.htmlCls.inputRadioStr+"name='"+e.pre+"setOperation' id='"+e.pre+"setOr' checked> Union(or) </label><br/>",s+="<label for='"+e.pre+"setAnd'>"+e.htmlCls.inputRadioStr+"name='"+e.pre+"setOperation' id='"+e.pre+"setAnd'> Intersection(and) </label><br/>",s+="<label for='"+e.pre+"setNot'>"+e.htmlCls.inputRadioStr+"name='"+e.pre+"setOperation' id='"+e.pre+"setNot'> Exclusion(not) </label>",s+="</div><br>",s+=e.htmlCls.setHtmlCls.setAdvanced(),s+="</div>",s+="</div>",s+=e.htmlCls.setHtmlCls.setAdvanced(2),s+=e.htmlCls.divStr+"dl_mmtfid' class='"+l+"'>",s+="MMTF ID: "+e.htmlCls.inputTextStr+"id='"+e.pre+"mmtfid' value='1TUP' size=8> ",s+=e.htmlCls.buttonStr+"reload_mmtf'>Load</button>",s+="</div>",s+=e.htmlCls.divStr+"dl_pdbid' class='"+l+"'>",s+="PDB ID: "+e.htmlCls.inputTextStr+"id='"+e.pre+"pdbid' value='1TUP' size=8> ",s+=e.htmlCls.buttonStr+"reload_pdb'>Load</button>",s+="</div>",s+=e.htmlCls.divStr+"dl_opmid' class='"+l+"'>",s+="<a href='https://opm.phar.umich.edu' target='_blank'>Orientations of Proteins in Membranes(OPM)</a> PDB ID: "+e.htmlCls.inputTextStr+"id='"+e.pre+"opmid' value='6JXR' size=8> ",s+=e.htmlCls.buttonStr+"reload_opm'>Load</button>",s+="</div>",s+=e.htmlCls.divStr+"dl_pdbfile' class='"+l+"'>",s+='Note: Several PDB files could be concatenated into a single PDB file. Use the line "ENDMDL" to separate PDB files.<br><br>',s+="PDB File: "+e.htmlCls.inputFileStr+" id='"+e.pre+"pdbfile' size=8> ",s+=e.htmlCls.buttonStr+"reload_pdbfile'>Load</button>",s+="</div>",s+=e.htmlCls.divStr+"dl_rescolorfile' class='"+l+"'>",s+='<div style="width:450px;">The custom JSON file on residue colors has the following format for proteins("ALA" and "ARG") and nucleotides("G" and "A"):<br>',s+='{"ALA":"#C8C8C8", "ARG":"#145AFF", ..., "G":"#008000", "A":"#6080FF", ...}</div><br>',s+="Residue Color File: "+e.htmlCls.inputFileStr+"id='"+e.pre+"rescolorfile' size=8> ",s+=e.htmlCls.buttonStr+"reload_rescolorfile'>Load</button>",s+="</div>",s+=e.htmlCls.divStr+"dl_customcolor' class='"+l+"'>",s+=" <input type='hidden' id='"+e.pre+"customcolor_chainid' value=''>",s+='<div style="width:450px;">The custom file for the structure has two columns separated by space or tab: ',s+='residue number, and score in the range of 0-100. If you click "Apply Custom Color" button, ',s+='the scores 0, 50 and 100 correspond to the three colors specified below. If you click "Apply Custom Tube", ',s+='the selected residues will be displayed in a style similar to "B-factor Tube".</div><br>',s+="Custom File: "+e.htmlCls.inputFileStr+"id='"+e.pre+"cstcolorfile' size=8> <br><br>",s+="1. "+e.htmlCls.buttonStr+"reload_customcolorfile'>Apply Custom Color</button>"+e.htmlCls.buttonStr+"remove_legend' style='margin-left:30px;'>Remove Legend</button><br>",s+="<span style='margin-left:15px'>Score to Color: 0:</span> <select id='"+e.pre+"startColor'>",s+=e.htmlCls.optionStr+"'red'>Red</option>",s+=e.htmlCls.optionStr+"'green'>Green</option>",s+=e.htmlCls.optionStr+"'blue' selected>Blue</option>",s+="</select>",s+="<span style='margin-left:30px'>50</span>: <select id='"+e.pre+"midColor'>",s+=e.htmlCls.optionStr+"'white' selected>White</option>",s+=e.htmlCls.optionStr+"'black'>Black</option>",s+="</select>",s+="<span style='margin-left:30px'>100</span>: <select id='"+e.pre+"endColor'>",s+=e.htmlCls.optionStr+"'red' selected>Red</option>",s+=e.htmlCls.optionStr+"'green'>Green</option>",s+=e.htmlCls.optionStr+"'blue'>Blue</option>",s+="</select><br>",s+="or<br><br>",s+="2. "+e.htmlCls.buttonStr+"reload_customtubefile'>Apply Custom Tube</button>",s+="</div>",s+=e.htmlCls.divStr+"dl_align' class='"+l+"'>",s+="Enter the PDB IDs or MMDB IDs of two structures that have been found to be similar by <A HREF=' "+e.htmlCls.baseUrl+"vastplus/vastplus.cgi'>VAST+</A> : <br/><br/>ID1: "+e.htmlCls.inputTextStr+"id='"+e.pre+"alignid1' value='1HHO' size=8>"+e.htmlCls.space3+e.htmlCls.space3+"ID2: "+e.htmlCls.inputTextStr+"id='"+e.pre+"alignid2' value='4N7N' size=8><br/><br/>",s+=e.htmlCls.buttonStr+"reload_align_ori'>All Matching Molecules Superposed</button>"+e.htmlCls.space3+e.htmlCls.buttonStr+"reload_align_refined'>Invariant Substructure Superposed</button>",s+="</div>",s+=e.htmlCls.divStr+"dl_chainalign' class='"+l+"'>",s+="<div style='width:550px'>",s+="All chains will be aligned to the first chain in the comma-separated chain IDs. Each chain ID has the form of pdbid_chain(e.g., 1HHO_A, case sensitive).<br/><br/>",s+="<b>Chain IDs</b>: "+e.htmlCls.inputTextStr+"id='"+e.pre+"chainalignids' value='1HHO_A,4N7N_A,2HCO_A' size=50><br/><br/>",s+="<b>Optional 1</b>, full chains are used for structure alignment<br/><br/>",s+="<b>Optional 2</b>, sequence alignment (followed by structure alignemnt) based on residue numbers in the First/Master chain: <br>"+e.htmlCls.inputTextStr+"id='"+e.pre+"resalignids' placeholder='1,5,10-50' size=50><br/><br/>",s+="<b>Optional 3</b>, predefined alignment with residue numbers in each chain specified (one chain per line): <br><textarea id='"+e.pre+"predefinedres' rows='5' style='width: 100%; height: "+e.htmlCls.LOG_HEIGHT+"px; padding: 0px; border: 0px;' placeholder='1,5,10-50\n1,5,10-50\n1,5,10-50'></textarea><br/><br/>",s+=e.htmlCls.buttonStr+"reload_chainalign'>Align Biological Unit</button>"+e.htmlCls.buttonStr+"reload_chainalign_asym' style='margin-left:30px'>Align Asymmetric Unit</button><br/><br/>",s+='(Note: To align chains in custom PDB files, you could concatenate PDB files in a single PDB file with the separation line "ENDMDL". Then load it in "Open File > PDB File" in the "File" menu and click "View Sequences & Annotations" in the "Window" menu. Finally select multiple chains in the sequence window and click "Realign Selection" in the "File" menu.)<br><br>',s+="</div></div>",s+=e.htmlCls.divStr+"dl_mutation' class='"+l+"'>",s+="<div style='width:500px'>",s+='Please specify the mutations with a comma separated mutation list. Each mutation can be specified as "[PDB ID]_[Chain ID]_[Residue Number]_[One Letter Mutatnt Residue]". E.g., the mutation of N501Y in the E chain of PDB 6M0J can be specified as "6M0J_E_501_Y". <br/><br/>',s+="<div style='display:inline-block; width:110px'>Mutations: </div>"+e.htmlCls.inputTextStr+"id='"+e.pre+"mutationids' value='6M0J_E_484_K,6M0J_E_501_Y,6M0J_E_417_N' size=50><br/><br/>",s+=e.htmlCls.buttonStr+"reload_mutation_3d' title='Show the mutations in 3D using the scap program'>3D with scap</button>",s+=e.htmlCls.buttonStr+"reload_mutation_inter' style='margin-left:20px' title='Show the mutations in 3D and the change of interactions'>Interactions</button>",s+=e.htmlCls.buttonStr+"reload_mutation_pdb' style='margin-left:20px' title='Show the mutations in 3D and export the PDB of the mutant within 10 angstrom'>PDB</button>",s+="<br/><br/></div></div>",s+=e.htmlCls.divStr+"dl_mol2file' class='"+l+"'>",s+="Mol2 File: "+e.htmlCls.inputFileStr+"id='"+e.pre+"mol2file' size=8> ",s+=e.htmlCls.buttonStr+"reload_mol2file'>Load</button>",s+="</div>",s+=e.htmlCls.divStr+"dl_sdffile' class='"+l+"'>",s+="SDF File: "+e.htmlCls.inputFileStr+"id='"+e.pre+"sdffile' size=8> ",s+=e.htmlCls.buttonStr+"reload_sdffile'>Load</button>",s+="</div>",s+=e.htmlCls.divStr+"dl_xyzfile' class='"+l+"'>",s+="XYZ File: "+e.htmlCls.inputFileStr+"id='"+e.pre+"xyzfile' size=8> ",s+=e.htmlCls.buttonStr+"reload_xyzfile'>Load</button>",s+="</div>",s+=e.htmlCls.divStr+"dl_urlfile' class='"+l+"'>",s+="File type: ",s+="<select id='"+e.pre+"filetype'>",s+=e.htmlCls.optionStr+"'pdb' selected>PDB</option>",s+=e.htmlCls.optionStr+"'mol2'>Mol2</option>",s+=e.htmlCls.optionStr+"'sdf'>SDF</option>",s+=e.htmlCls.optionStr+"'xyz'>XYZ</option>",s+=e.htmlCls.optionStr+"'icn3dpng'>iCn3D PNG</option>",s+="</select><br/>",s+="URL in the same host: "+e.htmlCls.inputTextStr+"id='"+e.pre+"urlfile' size=20><br/> ",s+=e.htmlCls.buttonStr+"reload_urlfile'>Load</button>",s+="</div>",s+=e.htmlCls.divStr+"dl_mmciffile' class='"+l+"'>",s+="mmCIF File: "+e.htmlCls.inputFileStr+"id='"+e.pre+"mmciffile' value='1TUP' size=8> ",s+=e.htmlCls.buttonStr+"reload_mmciffile'>Load</button>",s+="</div>",s+=e.htmlCls.divStr+"dl_mmcifid' class='"+l+"'>",s+="mmCIF ID: "+e.htmlCls.inputTextStr+"id='"+e.pre+"mmcifid' value='1TUP' size=8> ",s+=e.htmlCls.buttonStr+"reload_mmcif'>Load</button>",s+="</div>",s+=e.htmlCls.divStr+"dl_mmdbid' class='"+l+"'>",s+="MMDB or PDB ID: "+e.htmlCls.inputTextStr+"id='"+e.pre+"mmdbid' value='1TUP' size=8> ",s+=e.htmlCls.buttonStr+"reload_mmdb'>Load</button>",s+="</div>",s+=e.htmlCls.divStr+"dl_blast_rep_id' style='max-width:500px;' class='"+l+"'>",s+="Enter a Sequence ID(or FASTA sequence) and the aligned Structure ID, which can be found using the <a href='https://blast.ncbi.nlm.nih.gov/Blast.cgi?PROGRAM=blastp&PAGE_TYPE=BlastSearch&DATABASE=pdb' target='_blank'>BLAST</a> search against the pdb database with the Sequence ID or FASTA sequence as input.<br><br> ",s+="<b>Sequence ID</b>(NCBI protein accession of a sequence): "+e.htmlCls.inputTextStr+"id='"+e.pre+"query_id' value='NP_001108451.1' size=8><br> ",s+="or FASTA sequence: <br><textarea id='"+e.pre+"query_fasta' rows='5' style='width: 100%; height: "+e.htmlCls.LOG_HEIGHT+"px; padding: 0px; border: 0px;'></textarea><br><br>",s+="<b>Structure ID</b>(NCBI protein accession of a chain of a 3D structure): "+e.htmlCls.inputTextStr+"id='"+e.pre+"blast_rep_id' value='1TSR_A' size=8><br> ",s+=e.htmlCls.buttonStr+"reload_blast_rep_id'>Load</button>",s+="</div>",s+=e.htmlCls.divStr+"dl_yournote' class='"+l+"'>",s+='Your note will be saved in the HTML file when you click "File > Save Files > iCn3D PNG Image".<br><br>',s+="<textarea id='"+e.pre+"yournote' rows='5' style='width: 100%; height: "+e.htmlCls.LOG_HEIGHT+"px; padding: 0px; border: 0px;' placeholder='Enter your note here'></textarea><br>",s+=e.htmlCls.buttonStr+"applyyournote'>Save</button>",s+="</div>",s+=e.htmlCls.divStr+"dl_gi' class='"+l+"'>",s+="Protein gi: "+e.htmlCls.inputTextStr+"id='"+e.pre+"gi' value='1310960' size=8> ",s+=e.htmlCls.buttonStr+"reload_gi'>Load</button>",s+="</div>",s+=e.htmlCls.divStr+"dl_uniprotid' class='"+l+"'>",s+='Note: A list of structures will be shown. Click "View in iCn3D" to view each structure in 3D.<br><br>',s+="UniProt ID: "+e.htmlCls.inputTextStr+"id='"+e.pre+"uniprotid' value='P0DTC2' size=8> ",s+=e.htmlCls.buttonStr+"reload_uniprotid'>Load</button>",s+="</div>",s+=e.htmlCls.divStr+"dl_cid' class='"+l+"'>",s+="PubChem CID: "+e.htmlCls.inputTextStr+"id='"+e.pre+"cid' value='2244' size=8> ",s+=e.htmlCls.buttonStr+"reload_cid'>Load</button>",s+="</div>",s+=e.htmlCls.divStr+"dl_pngimage' class='"+l+"'>",s+="iCn3D PNG image: "+e.htmlCls.inputFileStr+"id='"+e.pre+"pngimage'><br/>",s+=e.htmlCls.buttonStr+"reload_pngimage' style='margin-top: 6px;'>Load</button>",s+="</div>",s+=e.htmlCls.divStr+"dl_state' class='"+l+"'>",s+="State file: "+e.htmlCls.inputFileStr+"id='"+e.pre+"state'><br/>",s+=e.htmlCls.buttonStr+"reload_state' style='margin-top: 6px;'>Load</button>",s+="</div>",s+=e.htmlCls.divStr+"dl_fixedversion' style='max-width:500px' class='"+l+"'>",s+='Since January 6, 2021, you can show the original view with the archived version of iCn3D by pasting your URL below and click "Show Originial View". Note the version in the parameter "v" was used to replace "full.html" with "full_[v].html" in the URL.<br><br>',s+="Share Link URL: "+e.htmlCls.inputTextStr+"id='"+e.pre+"sharelinkurl' size=60><br>",s+=e.htmlCls.buttonStr+"reload_fixedversion'>Show Original View</button><br><br>",s+="</div>",s+=e.htmlCls.divStr+"dl_selection' class='"+l+"'>",s+="Selection file: "+e.htmlCls.inputFileStr+"id='"+e.pre+"selectionfile'><br/>",s+=e.htmlCls.buttonStr+"reload_selectionfile' style='margin-top: 6px;'>Load</button>",s+="</div>",s+=e.htmlCls.divStr+"dl_dsn6' class='"+l+"'>",s+="<b>Note</b>: Always load a PDB file before loading DSN6 files. <br/><br/><br/>",s+="<span style='white-space:nowrap;font-weight:bold;'>2fofc contour at: <select id='"+e.pre+"dsn6sigma2fofc'>";let n=["0","0.5","1","1.5","2","3","4","5","6","7","8","9","10"];s+=e.htmlCls.setHtmlCls.getOptionHtml(n,3),s+="</select> &sigma;</span><br/>",s+=e.htmlCls.inputFileStr+"id='"+e.pre+"dsn6file2fofc'> "+e.htmlCls.buttonStr+"reload_dsn6file2fofc' style='margin-top: 6px;'>Load</button><br><br><br/>",s+="<span style='white-space:nowrap;font-weight:bold;'>fofc contour at: <select id='"+e.pre+"dsn6sigmafofc'>",s+=e.htmlCls.setHtmlCls.getOptionHtml(n,5),s+="</select> &sigma;</span><br/>",s+=e.htmlCls.inputFileStr+"id='"+e.pre+"dsn6filefofc'> "+e.htmlCls.buttonStr+"reload_dsn6filefofc' style='margin-top: 6px;'>Load</button><br><br><br>",s+=e.htmlCls.buttonStr+"elecmapNo4'>Remove Map</button><br>",s+="</div>",s+=e.htmlCls.divStr+"dl_dsn6url' class='"+l+"'>",s+="<b>Note</b>: Always load a PDB file before loading DSN6 files. <br/><br/><br/>",s+="<span style='white-space:nowrap;font-weight:bold;'>2fofc contour at: <select id='"+e.pre+"dsn6sigmaurl2fofc'>",s+=e.htmlCls.setHtmlCls.getOptionHtml(n,3),s+="</select> &sigma;</span><br/>",s+="URL in the same host: "+e.htmlCls.inputTextStr+"id='"+e.pre+"dsn6fileurl2fofc' size=20>"+e.htmlCls.space3+e.htmlCls.buttonStr+"reload_dsn6fileurl2fofc' style='margin-top: 6px;'>Load</button><br><br><br/>",s+="<span style='white-space:nowrap;font-weight:bold;'>fofc contour at: <select id='"+e.pre+"dsn6sigmaurlfofc'>",s+=e.htmlCls.setHtmlCls.getOptionHtml(n,5),s+="</select> &sigma;</span><br/>",s+="URL in the same host: "+e.htmlCls.inputTextStr+"id='"+e.pre+"dsn6fileurlfofc' size=20>"+e.htmlCls.space3+e.htmlCls.buttonStr+"reload_dsn6fileurlfofc' style='margin-top: 6px;'>Load</button><br><br><br/>",s+=e.htmlCls.buttonStr+"elecmapNo5'>Remove Map</button><br>",s+="</div>",s+=e.htmlCls.divStr+"dl_clr' class='"+l+"'>",s+="Click in the input box to use the color picker:<br><br> ",s+="Custom Color: "+e.htmlCls.inputTextStr+"id='"+e.pre+"colorcustom' value='FF0000' size=8> ",s+=e.htmlCls.buttonStr+"applycustomcolor'>Apply</button>",s+="</div>",s+=e.htmlCls.setHtmlCls.getPotentialHtml("delphi",l),s+=e.htmlCls.setHtmlCls.getPotentialHtml("local",l),s+=e.htmlCls.setHtmlCls.getPotentialHtml("url",l),s+=e.htmlCls.divStr+"dl_symmetry' class='"+l+"'><br>",s+=e.htmlCls.divNowrapStr+"Symmetry: <select id='"+e.pre+"selectSymmetry'>",s+="</select>"+e.htmlCls.space3,s+=e.htmlCls.buttonStr+"applysymmetry'>Apply</button>"+e.htmlCls.space3,s+=e.htmlCls.buttonStr+"clearsymmetry'>Clear</button></div>",s+="</div>",s+=e.htmlCls.divStr+"dl_symd' style='max-width:400px' class='"+l+"'><br>",s+="</div>",s+=e.htmlCls.divStr+"dl_contact' class='"+l+"'>",s+="<span style='white-space:nowrap;font-weight:bold;'>Distance: <select id='"+e.pre+"contactdist'>",s+=e.htmlCls.setHtmlCls.getOptionHtml(["4","5","6","7","8","9","10"],4),s+="</select></span>",s+="<span style='margin-left:30px; white-space:nowrap;font-weight:bold;'>Contact Type: <select id='"+e.pre+"contacttype'>",s+=e.htmlCls.optionStr+"'calpha' >between C-alpha Atoms</option>",s+=e.htmlCls.optionStr+"'cbeta' selected>between C-beta Atoms</option>",s+=e.htmlCls.optionStr+"'heavyatoms' >between Heavy Atoms</option>",s+="</select></span><br><br>",s+="<span style='white-space:nowrap;'>"+e.htmlCls.buttonStr+"applycontactmap'>Display</button></span><br>",s+="</div>",s+=e.htmlCls.divStr+"dl_hbonds' class='"+l+"'>",s+="1. Choose interaction types and their thresholds:<br>",s+="<div class='icn3d-box'><table border=0 width=450><tr>",s+="<td style='white-space:nowrap'>"+e.htmlCls.inputCheckStr+"id='"+e.pre+"analysis_hbond' checked>Hydrogen Bonds <span style='background-color:#"+e.htmlCls.hbondColor+"'>"+e.htmlCls.space3+"</span></td>",s+="<td>",s+=e.htmlCls.divNowrapStr+" <select id='"+e.pre+"hbondthreshold'>";let o=["3.2","3.3","3.4","3.5","3.6","3.7","3.8","3.9","4.0","4.1","4.2"];s+=e.htmlCls.setHtmlCls.getOptionHtml(o,6),s+="</select> &#197;"+e.htmlCls.space3+"</div></td>",s+="<td style='white-space:nowrap'>"+e.htmlCls.inputCheckStr+"id='"+e.pre+"analysis_saltbridge' checked>Salt Bridge/Ionic <span style='background-color:#"+e.htmlCls.ionicColor+"'>"+e.htmlCls.space3+"</span></td>",s+="<td>",s+=e.htmlCls.divNowrapStr+" <select id='"+e.pre+"saltbridgethreshold'>";let r=["3","4","5","6","7","8"];s+=e.htmlCls.setHtmlCls.getOptionHtml(r,3),s+="</select> &#197;"+e.htmlCls.space3+"</div></td>",s+="<td style='white-space:nowrap'>"+e.htmlCls.inputCheckStr+"id='"+e.pre+"analysis_contact' checked>Contacts/Interactions <span style='background-color:#"+e.htmlCls.contactColor+"'>"+e.htmlCls.space3+"</span></td>",s+="<td>",s+=e.htmlCls.divNowrapStr+" <select id='"+e.pre+"contactthreshold'>",s+=e.htmlCls.setHtmlCls.getOptionHtml(r,1),s+="</select> &#197;"+e.htmlCls.space3+"</div></td>",s+="</tr>",s+="<tr>",s+="<td style='white-space:nowrap'>"+e.htmlCls.inputCheckStr+"id='"+e.pre+"analysis_halogen' checked>Halogen Bonds <span style='background-color:#"+e.htmlCls.halogenColor+"'>"+e.htmlCls.space3+"</span></td>",s+="<td>",s+=e.htmlCls.divNowrapStr+" <select id='"+e.pre+"halogenthreshold'>",s+=e.htmlCls.setHtmlCls.getOptionHtml(o,6),s+="</select> &#197;"+e.htmlCls.space3+"</div></td>",s+="<td style='white-space:nowrap'>"+e.htmlCls.inputCheckStr+"id='"+e.pre+"analysis_pication' checked>&pi;-Cation <span style='background-color:#"+e.htmlCls.picationColor+"'>"+e.htmlCls.space3+"</span></td>",s+="<td>",s+=e.htmlCls.divNowrapStr+" <select id='"+e.pre+"picationthreshold'>",s+=e.htmlCls.setHtmlCls.getOptionHtml(r,3),s+="</select> &#197;"+e.htmlCls.space3+"</div></td>",s+="<td style='white-space:nowrap'>"+e.htmlCls.inputCheckStr+"id='"+e.pre+"analysis_pistacking' checked>&pi;-Stacking <span style='background-color:#"+e.htmlCls.pistackingColor+"'>"+e.htmlCls.space3+"</span></td>",s+="<td>",s+=e.htmlCls.divNowrapStr+" <select id='"+e.pre+"pistackingthreshold'>",s+=e.htmlCls.setHtmlCls.getOptionHtml(["3","4","5"],99),s+=e.htmlCls.optionStr+"'5.5' selected>5.5</option>",s+=e.htmlCls.setHtmlCls.getOptionHtml(["6","7","8"],99),s+="</select> &#197;"+e.htmlCls.space3+"</div></td>",s+="</tr></table></div>",s+="<table border=0 width=400 cellspacing=10><tr><td>",s+=e.htmlCls.divNowrapStr+"2. Select the first set:</div>",s+="<div style='text-indent:1.1em'><select style='max-width:200px' id='"+e.pre+"atomsCustomHbond2' multiple size='5' style='min-width:130px;'>",s+="</select></div>",s+="</td><td>",s+=e.htmlCls.divNowrapStr+"3. Select the second set:</div>",s+="<div style='text-indent:1.1em'><select style='max-width:200px' id='"+e.pre+"atomsCustomHbond' multiple size='5' style='min-width:130px;'>",s+="</select></div>",s+="</td></tr></table>",void 0!==e.cfg.align||void 0!==e.cfg.chainalign?(s+="<div>4. <b>Cross Structure Interactions</b>: <select id='"+e.pre+"crossstrucinter'>",s+=e.htmlCls.optionStr+"'1'>Yes</option>",s+=e.htmlCls.optionStr+"'0' selected>No</option>",s+="</select></div><br>",s+="<div style='text-indent:1.1em'>"+e.htmlCls.buttonStr+"applyhbonds'>3D Display Interactions</button></div><br>"):s+="<div>4. "+e.htmlCls.buttonStr+"applyhbonds'>3D Display Interactions</button></div><br>",s+="<div style='text-indent:1.1em'>"+e.htmlCls.buttonStr+"hbondWindow'>Highlight Interactions in Table</button><span style='margin-left:30px; font-wieght:bold'>Sort Interactions on</span>: "+e.htmlCls.buttonStr+"sortSet1'> Set 1</button>"+e.htmlCls.buttonStr+"sortSet2' style='margin-left:20px'>Set 2</button></div><br>",s+="<div style='text-indent:1.1em'>"+e.htmlCls.buttonStr+"hbondLineGraph'>2D Interaction Network</button> to show interactions between two lines of residue nodes</div><br>",s+="<div style='text-indent:1.1em'>"+e.htmlCls.buttonStr+"hbondScatterplot'>2D Interaction Map</button> to show interactions as map</div><br>";let a=': </td><td><input style="margin-left:-12px" type="text" id="';s+="<div style='text-indent:1.1em'>"+e.htmlCls.buttonStr+"hbondGraph'>2D Graph(Force-Directed)</button> to show interactions with strength parameters in 0-200:</div>",s+='<div style="text-indent:1.1em"><table><tr><td>Helix or Sheet'+a+e.pre+'dist_ss" size="4" value="100"></td>',s+="<td>Coil or Nucleotide"+a+e.pre+'dist_coil" size="4" value="50"></td>',s+="<td>Disulfide Bonds"+a+e.pre+'dist_ssbond" size="4" value="50"></td></tr>',s+="<tr><td>Hydrogen Bonds"+a+e.pre+'dist_hbond" size="4" value="50"></td>',s+="<td>Salt Bridge/Ionic"+a+e.pre+'dist_ionic" size="4" value="50"></td>',s+="<td>Contacts"+a+e.pre+'dist_inter" size="4" value="25"></td></tr>',s+="<tr><td>Halogen Bonds"+a+e.pre+'dist_halogen" size="4" value="50"></td>',s+="<td>&pi;-Cation"+a+e.pre+'dist_pication" size="4" value="50"></td>',s+="<td>&pi;-Stacking"+a+e.pre+'dist_pistacking" size="4" value="50"></td></tr></table></div>',s+='<div style="text-indent:1.1em">(Note: you can also adjust thresholds at #1 to add/remove interactions.)</div><br>',s+="<div style='text-indent:1.1em'>"+e.htmlCls.buttonStr+"areaWindow'>Buried Surface Area</button></div><br>",s+="<div>5. "+e.htmlCls.buttonStr+"hbondReset'>Reset</button> and select new sets</div>",s+="</div>",s+=e.htmlCls.divStr+"dl_realign' class='"+l+"'>",s+=e.htmlCls.divNowrapStr+"1. Select sets from two structures below <br>or use your current selection:</div><br>",s+="<div style='text-indent:1.1em'><select id='"+e.pre+"atomsCustomRealign' multiple size='5' style='min-width:130px;'>",s+="</select></div>",s+="<div>2. "+e.htmlCls.buttonStr+"applyRealign'>Realign</button></div><br>",s+="</div>",s+=e.htmlCls.divStr+"dl_allinteraction' style='background-color:white' class='"+l+"'>",s+="</div>",s+=e.htmlCls.divStr+"dl_interactionsorted' style='background-color:white' class='"+l+"'>",s+="</div>",s+=e.htmlCls.divStr+"dl_linegraph' style='background-color:white' class='"+l+"'>",s+=e.htmlCls.divNowrapStr+'<div style="width:20px; margin-top:6px; display:inline-block;"><span id="'+e.pre+'dl_linegraphcolor_expand" class="ui-icon ui-icon-plus icn3d-expand icn3d-link" style="display:none; width:15px;" title="Expand"></span><span id="'+e.pre+'dl_linegraphcolor_shrink" class="ui-icon ui-icon-minus icn3d-shrink icn3d-link" style="width:15px;" title="Shrink"></span></div>',s+=e.htmlCls.space2+"Hold Ctrl key to select multiple nodes/lines.</div>",s+=e.htmlCls.divStr+"dl_linegraphcolor' style='display:block;'>",s+=e.htmlCls.setHtmlCls.setColorHints(),s+="</div><br>";let d='<button class="icn3d-commandTitle" style="-webkit-appearance:button; height:24px;background-color:#DDD;" id="';e.linegraphid=e.pre+"linegraph",s+=e.htmlCls.divNowrapStr+d+e.linegraphid+'_svg">SVG</button>'+e.htmlCls.space2,s+=d+e.linegraphid+'_png">PNG</button>'+e.htmlCls.space2,s+=d+e.linegraphid+'_json">JSON</button>'+e.htmlCls.space4,s+="<b>Scale</b>: <select id='"+e.linegraphid+"_scale'>";let c=["0.1","0.2","0.4","0.6","0.8","1","2","4","6","8","10"];s+=e.htmlCls.setHtmlCls.getOptionHtml(c,5),s+="</select></div><br>",s+='<div id="'+e.pre+'linegraphDiv"></div>',s+="</div>",s+=e.htmlCls.divStr+"dl_scatterplot' style='background-color:white' class='"+l+"'>",s+=e.htmlCls.divNowrapStr+"Hold Ctrl key to select multiple nodes."+e.htmlCls.space3,s+='<div style="width:20px; margin-top:6px; display:inline-block;"><span id="'+e.pre+'dl_scatterplotcolor_expand" class="ui-icon ui-icon-plus icn3d-expand icn3d-link" style="width:15px;" title="Expand"></span><span id="'+e.pre+'dl_scatterplotcolor_shrink" class="ui-icon ui-icon-minus icn3d-shrink icn3d-link" style="display:none; width:15px;" title="Shrink"></span></div></div>',s+=e.htmlCls.divStr+"dl_scatterplotcolor' style='display:none;'>",s+=e.htmlCls.setHtmlCls.setColorHints(),s+="</div>",e.scatterplotid=e.pre+"scatterplot",s+=e.htmlCls.divNowrapStr+d+e.scatterplotid+'_svg">SVG</button>'+e.htmlCls.space2,s+=d+e.scatterplotid+'_png">PNG</button>'+e.htmlCls.space2,s+=d+e.scatterplotid+'_json">JSON</button>'+e.htmlCls.space4,s+="<b>Scale</b>: <select id='"+e.scatterplotid+"_scale'>",s+=e.htmlCls.setHtmlCls.getOptionHtml(c,5),s+="</select></div><br>",s+='<div id="'+e.pre+'scatterplotDiv"></div>',s+="</div>",s+=e.htmlCls.divStr+"dl_contactmap' style='background-color:white' class='"+l+"'>",s+=e.htmlCls.divNowrapStr+"Hold Ctrl key to select multiple nodes."+e.htmlCls.space3+"</div>",e.contactmapid=e.pre+"contactmap",s+=e.htmlCls.divNowrapStr+d+e.contactmapid+'_svg">SVG</button>'+e.htmlCls.space2,s+=d+e.contactmapid+'_png">PNG</button>'+e.htmlCls.space2,s+=d+e.contactmapid+'_json">JSON</button>'+e.htmlCls.space4,s+="<b>Scale</b>: <select id='"+e.contactmapid+"_scale'>";s+=e.htmlCls.setHtmlCls.getOptionHtml(["0.01","0.02","0.04","0.06","0.08","0.1","0.2","0.4","0.6","0.8","1"],10),s+="</select></div><br>",s+='<div id="'+e.pre+'contactmapDiv"></div>',s+="</div>",s+=e.htmlCls.divStr+"dl_elecmap2fofc' class='"+l+"'>",s+="<span style='white-space:nowrap;font-weight:bold;'>Contour at: <select id='"+e.pre+"sigma2fofc'>",s+=e.htmlCls.setHtmlCls.getOptionHtml(n,3),s+="</select> &sigma;</span> <span style='white-space:nowrap; margin-left:30px;'>"+e.htmlCls.buttonStr+"applymap2fofc'>Display</button></span> <span style='white-space:nowrap; margin-left:30px;'>"+e.htmlCls.buttonStr+"elecmapNo2'>Remove Map</button></span>",s+="</div>",s+=e.htmlCls.divStr+"dl_elecmapfofc' class='"+l+"'>",s+="<span style='white-space:nowrap;font-weight:bold;'>Contour at: <select id='"+e.pre+"sigmafofc'>",s+=e.htmlCls.setHtmlCls.getOptionHtml(n,5),s+="</select> &sigma;</span> <span style='white-space:nowrap; margin-left:30px;'>"+e.htmlCls.buttonStr+"applymapfofc'>Display</button></span> <span style='white-space:nowrap; margin-left:30px;'>"+e.htmlCls.buttonStr+"elecmapNo3'>Remove Map</button></span>",s+="</div>",s+=e.htmlCls.divStr+"dl_emmap' class='"+l+"'>",s+="<span style='white-space:nowrap;font-weight:bold;'>Contour at: <select id='"+e.pre+"empercentage'>",s+=e.htmlCls.setHtmlCls.getOptionHtml(["0","10","20","30","40","50","60","70","80","90","100"],3),s+="</select> % of maximum EM values</span><br><span style='white-space:nowrap; margin-left:30px;'>"+e.htmlCls.buttonStr+"applyemmap'>Display</button></span> <span style='white-space:nowrap; margin-left:30px;'>"+e.htmlCls.buttonStr+"emmapNo2'>Remove EM Map</button></span>",s+="</div>",s+=e.htmlCls.divStr+"dl_aroundsphere' class='"+l+"'>",s+=e.htmlCls.divNowrapStr+"1. Select the first set:</div>",s+="<div style='text-indent:1.1em'><select id='"+e.pre+"atomsCustomSphere2' multiple size='3' style='min-width:130px;'>",s+="</select></div><br>",s+=e.htmlCls.divNowrapStr+"2. Sphere with a radius: "+e.htmlCls.inputTextStr+"id='"+e.pre+"radius_aroundsphere' value='4' size='2'> &#197;</div><br/>",s+=e.htmlCls.divNowrapStr+"3. Select the second set to apply the sphere:</div>",s+="<div style='text-indent:1.1em'><select id='"+e.pre+"atomsCustomSphere' multiple size='3' style='min-width:130px;'>",s+="</select></div><br>",s+=e.htmlCls.divNowrapStr+"4. "+e.htmlCls.buttonStr+"applypick_aroundsphere'>Display</button> the sphere around the first set of atoms</div><br>",s+="<div style='text-indent:1.1em'>"+e.htmlCls.buttonStr+"sphereExport'>Save</button> interacting/contacting residue pairs in a file</div>",s+="</div>",s+=e.htmlCls.divStr+"dl_adjustmem' class='"+l+"'>",s+="<b>Note</b>: The membranes are parallel to the X-Y plane. The center of the membranes is at Z = 0. <br/><br/>",s+=e.htmlCls.divNowrapStr+"1. Extracellular membrane Z-axis position: "+e.htmlCls.inputTextStr+"id='"+e.pre+"extra_mem_z' value='' size='3'> &#197;</div><br/>",s+=e.htmlCls.divNowrapStr+"2. intracellular membrane Z-axis position: "+e.htmlCls.inputTextStr+"id='"+e.pre+"intra_mem_z' value='' size='3'> &#197;</div><br/>",s+=e.htmlCls.divNowrapStr+"3. "+e.htmlCls.buttonStr+"apply_adjustmem'>Display</button> the adjusted membranes</div><br>",s+="</div>",s+=e.htmlCls.divStr+"dl_selectplane' class='"+l+"'>",s+="<b>Note</b>: The membranes are parallel to the X-Y plane. The center of the membranes is at Z = 0. <br/><br/>",s+=e.htmlCls.divNowrapStr+"1. Z-axis position of the first X-Y plane: "+e.htmlCls.inputTextStr+"id='"+e.pre+"selectplane_z1' value='15' size='3'> &#197;</div><br/>",s+=e.htmlCls.divNowrapStr+"2. Z-axis position of the second X-Y plane: "+e.htmlCls.inputTextStr+"id='"+e.pre+"selectplane_z2' value='-15' size='3'> &#197;</div><br/>",s+=e.htmlCls.divNowrapStr+"3. "+e.htmlCls.buttonStr+"apply_selectplane'>Save</button> the region between the planes to Defined Sets</div><br>",s+="</div>",s+=e.htmlCls.divStr+"dl_addlabel' class='"+l+"'>",s+="1. Text: "+e.htmlCls.inputTextStr+"id='"+e.pre+"labeltext' value='Text' size=4><br/>",s+="2. Size: "+e.htmlCls.inputTextStr+"id='"+e.pre+"labelsize' value='18' size=4 maxlength=2><br/>",s+="3. Color: "+e.htmlCls.inputTextStr+"id='"+e.pre+"labelcolor' value='ffff00' size=4><br/>",s+="4. Background: "+e.htmlCls.inputTextStr+"id='"+e.pre+"labelbkgd' value='cccccc' size=4><br/>",e.utilsCls.isMobile()?s+=e.htmlCls.spanNowrapStr+"5. Touch TWO atoms</span><br/>":s+=e.htmlCls.spanNowrapStr+'5. Pick TWO atoms while holding "Alt" key</span><br/>',s+=e.htmlCls.spanNowrapStr+"6. "+e.htmlCls.buttonStr+"applypick_labels'>Display</button></span>",s+="</div>",s+=e.htmlCls.divStr+"dl_addlabelselection' class='"+l+"'>",s+="1. Text: "+e.htmlCls.inputTextStr+"id='"+e.pre+"labeltext2' value='Text' size=4><br/>",s+="2. Size: "+e.htmlCls.inputTextStr+"id='"+e.pre+"labelsize2' value='18' size=4 maxlength=2><br/>",s+="3. Color: "+e.htmlCls.inputTextStr+"id='"+e.pre+"labelcolor2' value='ffff00' size=4><br/>",s+="4. Background: "+e.htmlCls.inputTextStr+"id='"+e.pre+"labelbkgd2' value='cccccc' size=4><br/>",s+=e.htmlCls.spanNowrapStr+"5. "+e.htmlCls.buttonStr+"applyselection_labels'>Display</button></span>",s+="</div>",s+=e.htmlCls.divStr+"dl_distance' class='"+l+"'>",e.utilsCls.isMobile()?s+=e.htmlCls.spanNowrapStr+"1. Touch TWO atoms</span><br/>":s+=e.htmlCls.spanNowrapStr+'1. Pick TWO atoms while holding "Alt" key</span><br/>',s+=e.htmlCls.spanNowrapStr+"2. Color: "+e.htmlCls.inputTextStr+"id='"+e.pre+"distancecolor' value='ffff00' size=4><br/>",s+=e.htmlCls.spanNowrapStr+"3. "+e.htmlCls.buttonStr+"applypick_measuredistance'>Display</button></span>",s+="</div>",s+=e.htmlCls.divStr+"dl_stabilizer' class='"+l+"'>",e.utilsCls.isMobile()?s+=e.htmlCls.spanNowrapStr+"1. Touch TWO atoms</span><br/>":s+=e.htmlCls.spanNowrapStr+'1. Pick TWO atoms while holding "Alt" key</span><br/>',s+=e.htmlCls.spanNowrapStr+"2. Color: "+e.htmlCls.inputTextStr+"id='"+e.pre+"stabilizercolor' value='ffffff' size=4><br/>",s+=e.htmlCls.spanNowrapStr+"3. "+e.htmlCls.buttonStr+"applypick_stabilizer'>Add</button></span>",s+="</div>",s+=e.htmlCls.divStr+"dl_disttwosets' class='"+l+"'>",s+=e.htmlCls.spanNowrapStr+"1. Select two sets</span><br/>",s+="<table border=0 width=400 cellspacing=10><tr><td>",s+=e.htmlCls.divNowrapStr+"First set:</div>",s+="<div style='text-indent:1.1em'><select style='max-width:200px' id='"+e.pre+"atomsCustomDist2' multiple size='5' style='min-width:130px;'>",s+="</select></div>",s+="</td><td>",s+=e.htmlCls.divNowrapStr+"Second set:</div>",s+="<div style='text-indent:1.1em'><select style='max-width:200px' id='"+e.pre+"atomsCustomDist' multiple size='5' style='min-width:130px;'>",s+="</select></div>",s+="</td></tr></table>",s+=e.htmlCls.spanNowrapStr+"2. Color: "+e.htmlCls.inputTextStr+"id='"+e.pre+"distancecolor2' value='ffff00' size=4><br/><br/>",s+=e.htmlCls.spanNowrapStr+"3. "+e.htmlCls.buttonStr+"applydist2'>Display</button></span>",s+="</div>",s+=e.htmlCls.divStr+"dl_stabilizer_rm' class='"+l+"'>",e.utilsCls.isMobile()?s+=e.htmlCls.spanNowrapStr+"1. Touch TWO atoms</span><br/>":s+=e.htmlCls.spanNowrapStr+'1. Pick TWO atoms while holding "Alt" key</span><br/>',s+=e.htmlCls.spanNowrapStr+"2. "+e.htmlCls.buttonStr+"applypick_stabilizer_rm'>Remove</button></span>",s+="</div>",s+=e.htmlCls.divStr+"dl_thickness' class='"+l+"'>",s+=e.htmlCls.setHtmlCls.setThicknessHtml("3dprint"),s+="</div>",s+=e.htmlCls.divStr+"dl_thickness2' class='"+l+"'>",s+=e.htmlCls.setHtmlCls.setThicknessHtml("style"),s+="</div>",s+=e.htmlCls.divStr+"dl_addtrack' class='"+l+"'>",s+=" <input type='hidden' id='"+e.pre+"track_chainid' value=''>",s+=e.htmlCls.divStr+"dl_addtrack_tabs' style='border:0px;'>",s+="<ul>",s+="<li><a href='#"+e.pre+"tracktab1'>NCBI gi/Accession</a></li>",s+="<li><a href='#"+e.pre+"tracktab2'>FASTA</a></li>",s+="<li><a href='#"+e.pre+"tracktab2b'>FASTA Alignment</a></li>",s+="<li><a href='#"+e.pre+"tracktab3'>BED File</a></li>",s+="<li><a href='#"+e.pre+"tracktab4'>Custom</a></li>",s+="<li><a href='#"+e.pre+"tracktab5'>Current Selection</a></li>",s+="</ul>",s+=e.htmlCls.divStr+"tracktab1'>",s+="NCBI gi/Accession: "+e.htmlCls.inputTextStr+"id='"+e.pre+"track_gi' placeholder='gi' size=16> <br><br>",s+=e.htmlCls.buttonStr+"addtrack_button1'>Add Track</button>",s+="</div>",s+=e.htmlCls.divStr+"tracktab2'>",s+="FASTA Title: "+e.htmlCls.inputTextStr+"id='"+e.pre+"fasta_title' placeholder='track title' size=16> <br><br>",s+="FASTA sequence: <br><textarea id='"+e.pre+"track_fasta' rows='5' style='width: 100%; height: "+2*e.htmlCls.LOG_HEIGHT+"px; padding: 0px; border: 0px;'></textarea><br><br>",s+=e.htmlCls.buttonStr+"addtrack_button2'>Add Track</button>",s+="</div>",s+=e.htmlCls.divStr+"tracktab2b'>",s+="<div style='width:600px'>The full protein sequences with gaps are listed one by one. The sequence of the structure is listed at the top. If there are non-gap residues(e.g., from RefSeq) outside of the sequence of the structure, please remove them. Each sequence has a title line starting with \">\".</div><br>",s+="<b>FASTA alignment sequences</b>:<br>",s+="<textarea id='"+e.pre+"track_fastaalign' rows='5' style='width: 100%; height: "+2*e.htmlCls.LOG_HEIGHT+"px; padding: 0px; border: 0px;'></textarea><br><br>",s+="Position of the first residue in Sequences & Annotations window: "+e.htmlCls.inputTextStr+"id='"+e.pre+"fasta_startpos' value='1' size=2> <br><br>",s+="Color Sequence by: <select id='"+e.pre+"colorseqby'>",s+=e.htmlCls.optionStr+"'identity' selected>Identity</option>",s+=e.htmlCls.optionStr+"'conservation'>Conservation</option>",s+="</select> <br><br>",s+=e.htmlCls.buttonStr+"addtrack_button2b'>Add Track(s)</button>",s+="</div>",s+=e.htmlCls.divStr+"tracktab3'>",s+="BED file: "+e.htmlCls.inputFileStr+"id='"+e.pre+"track_bed' size=16> <br><br>",s+=e.htmlCls.buttonStr+"addtrack_button3'>Add Track</button>",s+="</div>",s+=e.htmlCls.divStr+"tracktab4'>",s+="Track Title: "+e.htmlCls.inputTextStr+"id='"+e.pre+"track_title' placeholder='track title' size=16> <br><br>",s+='Track Text(e.g., "152 G, 155-156 RR" defines a character "G" at the position 152 and two continuous characters "RR" at positions from 155 to 156. The starting position is 1): <br>',s+="<textarea id='"+e.pre+"track_text' rows='5' style='width: 100%; height: "+2*e.htmlCls.MENU_HEIGHT+"px; padding: 0px; border: 0px;'></textarea><br><br>",s+=e.htmlCls.buttonStr+"addtrack_button4'>Add Track</button>",s+="</div>",s+=e.htmlCls.divStr+"tracktab5'>",s+="Track Title: "+e.htmlCls.inputTextStr+"id='"+e.pre+"track_selection' placeholder='track title' size=16> <br><br>",s+=e.htmlCls.buttonStr+"addtrack_button5'>Add Track</button>",s+="</div>",s+="</div>",s+="</div>",s+=e.htmlCls.divStr+"dl_saveselection' class='"+l+"'>";let h=t&&t.defNames2Atoms?Object.keys(t.defNames2Atoms).length:1;s+="Name: "+e.htmlCls.inputTextStr+"id='"+e.pre+"seq_command_name' value='seq_"+h+"' size='5'> <br>",s+="<button style='white-space:nowrap;' id='"+e.pre+"seq_saveselection'>Save</button> <button style='white-space:nowrap; margin-left:20px;' id='"+e.pre+"seq_clearselection'>Clear</button><br/><br/>",s+="</div>",s+=e.htmlCls.divStr+"dl_copyurl' style='width:520px;' class='"+l+"'>",s+='Please copy one of the URLs below. They show the same result.<br>(To add a title to share link, click "Windows > Your Note" and click "File > Share Link" again.)<br><br>',s+="Original URL with commands: <br><textarea id='"+e.pre+"ori_url' rows='4' style='width:100%'></textarea><br><br>",s+="Lifelong Short URL:(To replace this URL, send a pull request to update share.html at <a href='https://github.com/ncbi/icn3d' target='_blank'>iCn3D GitHub</a>)<br>"+e.htmlCls.inputTextStr+"id='"+e.pre+"short_url' value='' style='width:100%'><br><br>",s+='Lifelong Short URL + Window Title:(To update the window title, click "Analysis > Your Note/Window Title".)<br>'+e.htmlCls.inputTextStr+"id='"+e.pre+"short_url_title' value='' style='width:100%'><br><br>",s+="</div>",s+=e.htmlCls.divStr+"dl_selectannotations' class='"+l+" icn3d-annotation' style='background-color:white;'>",s+=e.htmlCls.divStr+"dl_annotations_tabs'>",s+=e.htmlCls.divStr+"dl_anno_view_tabs' style='border:0px; height:33px;'>",s+="<ul>",s+="<li><a href='#"+e.pre+"anno_tmp1' id='"+e.pre+"anno_summary'>Summary</a></li>",s+="<li><a href='#"+e.pre+"anno_tmp2' id='"+e.pre+"anno_details'>Details</a></li>",s+="</ul>",s+=e.htmlCls.divStr+"anno_tmp1'>",s+="</div>",s+=e.htmlCls.divStr+"anno_tmp2'>",s+="</div>",s+="</div>",s+="<div class='icn3d-box' style='width:520px;'><b>Annotations:&nbsp;</b><br><table border=0><tr>";let m="<td style='min-width:110px;'><span style='white-space:nowrap'>",p="<td style='min-width:130px;'><span style='white-space:nowrap'>";return s+=m+e.htmlCls.inputCheckStr+"id='"+e.pre+"anno_all'>All"+e.htmlCls.space2+"</span></td>",s+=p+e.htmlCls.inputCheckStr+"id='"+e.pre+"anno_cdd' checked>Conserved Domains"+e.htmlCls.space2+"</span></td>",s+=m+e.htmlCls.inputCheckStr+"id='"+e.pre+"anno_clinvar'>ClinVar"+e.htmlCls.space2+"</span></td>",s+=m+e.htmlCls.inputCheckStr+"id='"+e.pre+"anno_binding'>Functional Sites"+e.htmlCls.space2+"</span></td>",s+="</tr><tr>",s+=m+e.htmlCls.inputCheckStr+"id='"+e.pre+"anno_custom'>Custom"+e.htmlCls.space2+"</span></td>",s+=p+e.htmlCls.inputCheckStr+"id='"+e.pre+"anno_3dd'>3D Domains"+e.htmlCls.space2+"</span></td>",s+=m+e.htmlCls.inputCheckStr+"id='"+e.pre+"anno_snp'>SNPs"+e.htmlCls.space2+"</span></td>",s+=m+e.htmlCls.inputCheckStr+"id='"+e.pre+"anno_interact'>Interactions"+e.htmlCls.space2+"</span></td>",s+="<td></td>",s+="</tr><tr>",s+=m+e.htmlCls.inputCheckStr+"id='"+e.pre+"anno_ssbond'>Disulfide Bonds"+e.htmlCls.space2+"</span></td>",s+=m+e.htmlCls.inputCheckStr+"id='"+e.pre+"anno_crosslink'>Cross-Linkages"+e.htmlCls.space2+"</span></td>",void 0!==e.cfg.opmid?s+="<td style='min-width:110px;'><span id='"+e.pre+"anno_transmemli' style='white-space:nowrap'>"+e.htmlCls.inputCheckStr+"id='"+e.pre+"anno_transmem'>Transmembrane"+e.htmlCls.space2+"</span></td>":s+="<td style='min-width:110px;'><span id='"+e.pre+"anno_transmemli' style='display:none; white-space:nowrap'>"+e.htmlCls.inputCheckStr+"id='"+e.pre+"anno_transmem'>Transmembrane"+e.htmlCls.space2+"</span></td>",s+="<td></td>",s+="</tr></table></div>",s+="<button style='white-space:nowrap; margin-left:5px;' id='"+e.pre+"showallchains'>Show All Chains</button><br>",s+=e.htmlCls.divStr+"seqguide_wrapper' style='display:none'><br>"+e.htmlCls.setHtmlCls.setSequenceGuide("2")+"</div>",s+="</div><br/><hr><br>",s+=e.htmlCls.divStr+"dl_annotations'>",s+="</div>",s+="</div>",s+=e.htmlCls.divStr+"dl_graph' style='background-color:white;' class='"+l+"'>",e.svgid=e.pre+"icn3d_viz",s+="<style>",s+="#"+e.svgid+" svg { border: 1px solid; font: 13px sans-serif; text-anchor: end; }",s+="#"+e.svgid+" .node { stroke: #eee; stroke-width: 1.5px; }",s+=".node .selected { stroke: "+e.htmlCls.ORANGE+"; }",s+=".link { stroke: #999; stroke-opacity: 0.6; }",s+="</style>",s+=e.htmlCls.divNowrapStr+"<b>Zoom</b>: mouse wheel; "+e.htmlCls.space3+" <b>Move</b>: left button; "+e.htmlCls.space3+" <b>Select Multiple Nodes</b>: Ctrl Key and drag an Area"+e.htmlCls.space3,s+='<div id="'+e.pre+'interactionDesc" style="width:20px; margin-top:6px; display:inline-block;"><span id="'+e.pre+'dl_svgcolor_expand" class="ui-icon ui-icon-plus icn3d-expand icn3d-link" style="width:15px;" title="Expand"></span><span id="'+e.pre+'dl_svgcolor_shrink" class="ui-icon ui-icon-minus icn3d-shrink icn3d-link" style="display:none; width:15px;" title="Shrink"></span></div></div>',s+=e.htmlCls.divStr+"dl_svgcolor' style='display:none;'>",s+=e.htmlCls.divNowrapStr+'<span style="margin-left:33px">Click "View > H-Bonds & Interactions" to adjust parameters and relaunch the graph</span></div>',s+=e.htmlCls.divNowrapStr+'<span style="margin-left:33px; color:#00FF00; font-weight:bold">Green</span>: H-Bonds; ',s+='<span style="color:#00FFFF; font-weight:bold">Cyan</span>: Salt Bridge/Ionic; ',s+='<span style="font-weight:bold">Grey</span>: contacts; ',s+='<span style="color:'+e.htmlCls.ORANGE+'; font-weight:bold">Orange</span>: disulfide bonds</div>',s+=e.htmlCls.divNowrapStr+'<span style="margin-left:33px; color:#FF00FF; font-weight:bold">Magenta</span>: Halogen Bonds; ',s+='<span style="color:#FF0000; font-weight:bold">Red</span>: &pi;-Cation; ',s+='<span style="color:#0000FF; font-weight:bold">Blue</span>: &pi;-Stacking</div>',s+="</div>",s+=e.htmlCls.divNowrapStr+d+e.svgid+'_svg">SVG</button>'+e.htmlCls.space2,s+=d+e.svgid+'_png">PNG</button>'+e.htmlCls.space2,s+=d+e.svgid+'_json">JSON</button>',s+=e.htmlCls.space3+"<div id='"+e.pre+"force' style='display:inline-block;'><b>Force on Nodes</b>: <select id='"+e.svgid+"_force'>",s+=e.htmlCls.optionStr+"'0'>No</option>",s+=e.htmlCls.optionStr+"'1'>X-axis</option>",s+=e.htmlCls.optionStr+"'2'>Y-axis</option>",s+=e.htmlCls.optionStr+"'3'>Circle</option>",s+=e.htmlCls.optionStr+"'4' selected>Random</option>",s+="</select></div>",s+=e.htmlCls.space3+"<b>Label Size</b>: <select id='"+e.svgid+"_label'>",a="icn3d-node-text",s+=e.htmlCls.optionStr+"'"+a+"0'>No</option>",s+=e.htmlCls.optionStr+"'"+a+"4'>4px</option>",s+=e.htmlCls.optionStr+"'"+a+"8' selected>8px</option>",s+=e.htmlCls.optionStr+"'"+a+"12'>12px</option>",s+=e.htmlCls.optionStr+"'"+a+"16'>16px</option>",s+=e.htmlCls.optionStr+"'"+a+"24'>24px</option>",s+=e.htmlCls.optionStr+"'"+a+"32'>32px</option>",s+="</select>",s+=e.htmlCls.space3+"<div id='"+e.pre+"internalEdges' style='display:inline-block;'><b>Internal Edges</b>: <select id='"+e.svgid+"_hideedges'>",s+=e.htmlCls.optionStr+"'1' selected>Hide</option>",s+=e.htmlCls.optionStr+"'0'>Show</option>",s+="</select></div>",s+="</div>",s+='<svg id="'+e.svgid+'" style="margin-top:6px;"></svg>',s+="</div>",s+=e.htmlCls.divStr+"dl_area' class='"+l+"'>",s+="Solvent Accessible Surface Area(SASA) calculated using the <a href='https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0008140' target='_blank'>EDTSurf algorithm</a>: <br>",s+='(0-20% out is considered "in". 50-100% out is considered "out".)<br><br>',s+="<b>Toal</b>: "+e.htmlCls.inputTextStr+"id='"+e.pre+"areavalue' value='' size='10'> &#8491;<sup>2</sup><br><br>",s+="<div id='"+e.pre+"areatable' style='max-height:400px; overflow:auto'></div>",s+="</div>",s+=e.htmlCls.divStr+"dl_colorbyarea' class='"+l+"'>",s+="<div style='width:500px'>Color each residue based on the percentage of solvent accessilbe surface area. The color ranges from blue, to white, to red for a percentage of 0, 35(variable), and 100, respectively.</div><br>",s+="<b>Middle Percentage(White)</b>: "+e.htmlCls.inputTextStr+"id='"+e.pre+"midpercent' value='35' size='10'>% <br><br>",s+="<button style='white-space:nowrap;' id='"+e.pre+"applycolorbyarea'>Color</button><br/><br/>",s+="</div>",s+=e.htmlCls.divStr+"dl_rmsd' class='"+l+"'>",s+="<br><b>Alignment RMSD</b>: "+e.htmlCls.inputTextStr+"id='"+e.pre+"realignrmsd' value='35' size='10'>&#8491;<br><br>",s+="</div>",s+=e.htmlCls.divStr+"dl_buriedarea' class='"+l+"'>",s+="</div>",s+=e.htmlCls.divStr+"dl_propbypercentout' class='"+l+"'>",s+="<div style='width:400px'>Select residue based on the percentage of solvent accessilbe surface area. The values are in the range of 0-100.</div><br>",s+="<b>Min Percentage</b>: "+e.htmlCls.inputTextStr+"id='"+e.pre+"minpercentout' value='0' size='10'>% <br>",s+="<b>Max Percentage</b>: "+e.htmlCls.inputTextStr+"id='"+e.pre+"maxpercentout' value='100' size='10'>% <br>",s+="<button style='white-space:nowrap;' id='"+e.pre+"applypropbypercentout'>Apply</button><br/><br/>",s+="</div>",s+=e.htmlCls.divStr+"dl_propbybfactor' class='"+l+"'>",s+="<div style='width:400px'>Select residue based on B-factor. The values are in the range of 0-100.</div><br>",s+="<b>Min B-factor</b>: "+e.htmlCls.inputTextStr+"id='"+e.pre+"minbfactor' value='0' size='10'>% <br>",s+="<b>Max B-factor</b>: "+e.htmlCls.inputTextStr+"id='"+e.pre+"maxbfactor' value='100' size='10'>% <br>",s+="<button style='white-space:nowrap;' id='"+e.pre+"applypropbybfactor'>Apply</button><br/><br/>",s+="</div>",s+="</div>",s+="\x3c!--/form--\x3e",s}}class tt{constructor(e){this.icn3dui=e}fullScreenChange(){let e=this.icn3dui,t=e.icn3d;e.bNode||document.fullscreenElement||document.webkitFullscreenElement||document.mozFullscreenElement||document.msFullscreenElement||(e.htmlCls.clickMenuCls.setLogCmd("exit full screen",!1),t.bFullscreen=!1,e.utilsCls.setViewerWidthHeight(e),t.applyCenterCls.setWidthHeight(e.htmlCls.WIDTH,e.htmlCls.HEIGHT),t.drawCls.draw())}searchSeq(){let e=this.icn3dui,t=e.icn3d,s=$("#"+e.pre+"search_seq").val();isNaN(s)&&-1==s.indexOf("$")&&-1==s.indexOf(".")&&-1==s.indexOf(":")&&-1==s.indexOf("@")&&(s=":"+s);let i=s.replace(/\s+/g,"_"),l=i;t.selByCommCls.selectByCommand(s,i,l),e.htmlCls.clickMenuCls.setLogCmd("select "+s+" | name "+i,!0)}allEventFunctions(){let e=this.icn3dui,t=e.icn3d,s=this;if(e.bNode)return;t.definedSetsCls.clickCustomAtoms(),t.definedSetsCls.clickCommand_apply(),t.definedSetsCls.clickModeswitch(),t.selectionCls.clickShow_selected(),t.selectionCls.clickHide_selected(),t.diagram2dCls.click2Ddgm(),t.cartoon2dCls.click2Dcartoon(),t.addTrackCls.clickAddTrackButton(),t.resizeCanvasCls.windowResize(),t.annotationCls.setTabs(),t.resid2specCls.switchHighlightLevel(),e.utilsCls.isMobile()?(t.hlSeqCls.selectSequenceMobile(),t.hlSeqCls.selectChainMobile()):t.hlSeqCls.selectSequenceNonMobile(),e.htmlCls.clickMenuCls.clickMenu1(),e.htmlCls.clickMenuCls.clickMenu2(),e.htmlCls.clickMenuCls.clickMenu3(),e.htmlCls.clickMenuCls.clickMenu4(),e.htmlCls.clickMenuCls.clickMenu5(),e.htmlCls.clickMenuCls.clickMenu6(),e.myEventCls.onIds(["#"+e.pre+"back","#"+e.pre+"mn6_back"],"click",(function(t){let s=e.icn3d;t.preventDefault(),e.htmlCls.clickMenuCls.setLogCmd("back",!1),s.resizeCanvasCls.back()})),e.myEventCls.onIds(["#"+e.pre+"forward","#"+e.pre+"mn6_forward"],"click",(function(t){let s=e.icn3d;t.preventDefault(),e.htmlCls.clickMenuCls.setLogCmd("forward",!1),s.resizeCanvasCls.forward()})),e.myEventCls.onIds(["#"+e.pre+"fullscreen","#"+e.pre+"mn6_fullscreen"],"click",(function(t){let s=e.icn3d;t.preventDefault(),e.htmlCls.clickMenuCls.setLogCmd("enter full screen",!1),s.bFullscreen=!0,e.htmlCls.WIDTH=$(window).width(),e.htmlCls.HEIGHT=$(window).height(),s.applyCenterCls.setWidthHeight(e.htmlCls.WIDTH,e.htmlCls.HEIGHT),s.drawCls.draw(),s.resizeCanvasCls.openFullscreen($("#"+e.pre+"canvas")[0])})),document.addEventListener("fullscreenchange",this.fullScreenChange.bind(this)),document.addEventListener("webkitfullscreenchange",this.fullScreenChange.bind(this)),document.addEventListener("mozfullscreenchange",this.fullScreenChange.bind(this)),document.addEventListener("msfullscreenchange",this.fullScreenChange.bind(this)),e.myEventCls.onIds(["#"+e.pre+"toggle","#"+e.pre+"mn2_toggle"],"click",(function(t){e.icn3d.selectionCls.toggleSelection(),e.htmlCls.clickMenuCls.setLogCmd("toggle selection",!0)})),e.myEventCls.onIds("#"+e.pre+"mn2_hl_clrYellow","click",(function(t){let s=e.icn3d;e.htmlCls.clickMenuCls.setLogCmd("set highlight color yellow",!0),s.hColor=e.parasCls.thr(16776960),s.matShader=s.setColorCls.setOutlineColor("yellow"),s.drawCls.draw()})),e.myEventCls.onIds("#"+e.pre+"mn2_hl_clrGreen","click",(function(t){let s=e.icn3d;e.htmlCls.clickMenuCls.setLogCmd("set highlight color green",!0),s.hColor=e.parasCls.thr(65280),s.matShader=s.setColorCls.setOutlineColor("green"),s.drawCls.draw()})),e.myEventCls.onIds("#"+e.pre+"mn2_hl_clrRed","click",(function(t){let s=e.icn3d;e.htmlCls.clickMenuCls.setLogCmd("set highlight color red",!0),s.hColor=e.parasCls.thr(16711680),s.matShader=s.setColorCls.setOutlineColor("red"),s.drawCls.draw()})),e.myEventCls.onIds("#"+e.pre+"mn2_hl_styleOutline","click",(function(t){let s=e.icn3d;e.htmlCls.clickMenuCls.setLogCmd("set highlight style outline",!0),s.bHighlight=1,s.hlUpdateCls.showHighlight()})),e.myEventCls.onIds("#"+e.pre+"mn2_hl_styleObject","click",(function(t){let s=e.icn3d;e.htmlCls.clickMenuCls.setLogCmd("set highlight style 3d",!0),s.bHighlight=2,s.hlUpdateCls.showHighlight()})),e.myEventCls.onIds("#"+e.pre+"mn2_hl_styleNone","click",(function(t){let s=e.icn3d;t.stopImmediatePropagation(),s.hlUpdateCls.clearHighlight(),e.htmlCls.clickMenuCls.setLogCmd("clear selection",!0)})),e.myEventCls.onIds(["#"+e.pre+"alternate","#"+e.pre+"mn2_alternate","#"+e.pre+"alternate2"],"click",(function(t){let s=e.icn3d;s.bAlternate=!0,s.alternateCls.alternateStructures(),s.bAlternate=!1,e.htmlCls.clickMenuCls.setLogCmd("alternate structures",!1)})),e.myEventCls.onIds("#"+e.pre+"mn2_realignresbyres","click",(function(t){e.icn3d.realignParserCls.realign(),e.htmlCls.clickMenuCls.setLogCmd("realign",!0)})),e.myEventCls.onIds("#"+e.pre+"mn2_realignonseqalign","click",(function(t){let s=e.icn3d;if(void 0===s.bSetChainsAdvancedMenu||!s.bSetChainsAdvancedMenu){let t=e.hashUtilsCls.cloneHash(s.hAtoms);s.definedSetsCls.setPredefinedInMenu(),s.bSetChainsAdvancedMenu=!0,s.hAtoms=e.hashUtilsCls.cloneHash(t)}let i=s.definedSetsCls.setAtomMenu(["protein"]);$("#"+e.pre+"atomsCustomRealign").length&&$("#"+e.pre+"atomsCustomRealign").html(i),$("#"+e.pre+"atomsCustomRealign2").length&&$("#"+e.pre+"atomsCustomRealign2").html(i),s.bRender&&e.htmlCls.dialogCls.openDlg("dl_realign","Please select two sets to realign"),$("#"+e.pre+"atomsCustomRealign").resizable(),$("#"+e.pre+"atomsCustomRealign2").resizable()})),e.myEventCls.onIds("#"+e.pre+"applyRealign","click",(function(t){let s=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close");let i=$("#"+e.pre+"atomsCustomRealign").val();i.length>0&&(s.hAtoms=s.definedSetsCls.getAtomsFromNameArray(i)),s.realignParserCls.realignOnSeqAlign(),i.length>0?e.htmlCls.clickMenuCls.setLogCmd("realign on seq align | "+i,!0):e.htmlCls.clickMenuCls.setLogCmd("realign on seq align",!0)})),e.myEventCls.onIds("#"+e.pre+"anno_summary","click",(function(t){let s=e.icn3d;t.preventDefault(),s.annotationCls.setAnnoViewAndDisplay("overview"),e.htmlCls.clickMenuCls.setLogCmd("set view overview",!0)})),e.myEventCls.onIds("#"+e.pre+"anno_details","click",(function(t){let s=e.icn3d;t.preventDefault(),s.annotationCls.setAnnoViewAndDisplay("detailed view"),e.htmlCls.clickMenuCls.setLogCmd("set view detailed view",!0)})),e.myEventCls.onIds("#"+e.pre+"show_annotations","click",(function(t){e.icn3d.showAnnoCls.showAnnotations(),e.htmlCls.clickMenuCls.setLogCmd("view annotations",!0)})),e.myEventCls.onIds("#"+e.pre+"showallchains","click",(function(t){e.icn3d.annotationCls.showAnnoAllChains(),e.htmlCls.clickMenuCls.setLogCmd("show annotations all chains",!0)})),e.myEventCls.onIds("#"+e.pre+"show_alignsequences","click",(function(t){e.icn3d,e.htmlCls.dialogCls.openDlg("dl_alignment","Select residues in aligned sequences")})),e.myEventCls.onIds(["#"+e.pre+"show_2ddgm","#"+e.pre+"mn2_2ddgm"],"click",(function(t){let s=e.icn3d;e.htmlCls.dialogCls.openDlg("dl_2ddgm","2D Diagram"),s.viewInterPairsCls.retrieveInteractionData(),e.htmlCls.clickMenuCls.setLogCmd("view interactions",!0)})),e.myEventCls.onIds("#"+e.pre+"search_seq_button","click",(function(t){e.icn3d,t.stopImmediatePropagation(),s.searchSeq()})),e.myEventCls.onIds("#"+e.pre+"search_seq","keyup",(function(t){e.icn3d,13===t.keyCode&&(t.preventDefault(),s.searchSeq())})),e.myEventCls.onIds("#"+e.pre+"reload_mmtf","click",(function(t){e.icn3d,t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),e.htmlCls.clickMenuCls.setLogCmd("load mmtf "+$("#"+e.pre+"mmtfid").val(),!1),window.open(e.htmlCls.baseUrl+"icn3d/full.html?mmtfid="+$("#"+e.pre+"mmtfid").val(),"_blank")})),e.myEventCls.onIds("#"+e.pre+"mmtfid","keyup",(function(t){e.icn3d,13===t.keyCode&&(t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),e.htmlCls.clickMenuCls.setLogCmd("load mmtf "+$("#"+e.pre+"mmtfid").val(),!1),window.open(e.htmlCls.baseUrl+"icn3d/full.html?mmtfid="+$("#"+e.pre+"mmtfid").val(),"_blank"))})),e.myEventCls.onIds("#"+e.pre+"reload_pdb","click",(function(t){e.icn3d,t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),e.htmlCls.clickMenuCls.setLogCmd("load pdb "+$("#"+e.pre+"pdbid").val(),!1),window.open(e.htmlCls.baseUrl+"icn3d/full.html?pdbid="+$("#"+e.pre+"pdbid").val(),"_blank")})),e.myEventCls.onIds("#"+e.pre+"pdbid","keyup",(function(t){e.icn3d,13===t.keyCode&&(t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),e.htmlCls.clickMenuCls.setLogCmd("load pdb "+$("#"+e.pre+"pdbid").val(),!1),window.open(e.htmlCls.baseUrl+"icn3d/full.html?pdbid="+$("#"+e.pre+"pdbid").val(),"_blank"))})),e.myEventCls.onIds("#"+e.pre+"reload_opm","click",(function(t){e.icn3d,t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),e.htmlCls.clickMenuCls.setLogCmd("load opm "+$("#"+e.pre+"opmid").val(),!1),window.open(e.htmlCls.baseUrl+"icn3d/full.html?opmid="+$("#"+e.pre+"opmid").val(),"_blank")})),e.myEventCls.onIds("#"+e.pre+"opmid","keyup",(function(t){e.icn3d,13===t.keyCode&&(t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),e.htmlCls.clickMenuCls.setLogCmd("load opm "+$("#"+e.pre+"opmid").val(),!1),window.open(e.htmlCls.baseUrl+"icn3d/full.html?opmid="+$("#"+e.pre+"opmid").val(),"_blank"))})),e.myEventCls.onIds("#"+e.pre+"reload_align_refined","click",(function(t){e.icn3d,t.preventDefault(),e.cfg.notebook||dialog.dialog("close");let s=$("#"+e.pre+"alignid1").val()+","+$("#"+e.pre+"alignid2").val();e.htmlCls.clickMenuCls.setLogCmd("load alignment "+s+" | parameters &atype=1",!1),window.open(e.htmlCls.baseUrl+"icn3d/full.html?align="+s+"&showalignseq=1&atype=1","_blank")})),e.myEventCls.onIds("#"+e.pre+"reload_align_ori","click",(function(t){e.icn3d,t.preventDefault(),e.cfg.notebook||dialog.dialog("close");let s=$("#"+e.pre+"alignid1").val()+","+$("#"+e.pre+"alignid2").val();e.htmlCls.clickMenuCls.setLogCmd("load alignment "+s+" | parameters &atype=0",!1),window.open(e.htmlCls.baseUrl+"icn3d/full.html?align="+s+"&showalignseq=1&atype=0","_blank")})),e.myEventCls.onIds("#"+e.pre+"reload_chainalign","click",(function(t){e.icn3d,t.preventDefault(),e.cfg.notebook||dialog.dialog("close");let s=$("#"+e.pre+"chainalignids").val(),i=$("#"+e.pre+"resalignids").val(),l=$("#"+e.pre+"predefinedres").val().trim().replace(/\n/g," | ");l&&s.split(",").length!=l.split(" | ").length?alert("Please make sure the number of chains and the lines of predefined residues are the same..."):(e.htmlCls.clickMenuCls.setLogCmd("load chains "+s+" | residues "+i+" | resdef "+l,!1),window.open(e.htmlCls.baseUrl+"icn3d/full.html?chainalign="+s+"&resnum="+i+"&resdef="+l+"&showalignseq=1","_blank"))})),e.myEventCls.onIds("#"+e.pre+"reload_chainalign_asym","click",(function(t){e.icn3d,t.preventDefault(),e.cfg.notebook||dialog.dialog("close");let s=$("#"+e.pre+"chainalignids").val(),i=$("#"+e.pre+"resalignids").val(),l=$("#"+e.pre+"predefinedres").val().trim().replace(/\n/g," | ");l&&s.split(",").length!=l.split(" | ").length?alert("Please make sure the number of chains and the lines of predefined residues are the same..."):(e.htmlCls.clickMenuCls.setLogCmd("load chains "+s+" on asymmetric unit | residues "+i+" | resdef "+l,!1),window.open(e.htmlCls.baseUrl+"icn3d/full.html?chainalign="+s+"&resnum="+i+"&resdef="+l+"&showalignseq=1&buidx=0","_blank"))})),e.myEventCls.onIds("#"+e.pre+"reload_mutation_3d","click",(function(t){e.icn3d,t.preventDefault(),e.cfg.notebook||dialog.dialog("close");let s=$("#"+e.pre+"mutationids").val(),i=s.substr(0,s.indexOf("_"));e.htmlCls.clickMenuCls.setLogCmd("3d of mutation "+s,!1),window.open(e.htmlCls.baseUrl+"icn3d/full.html?mmdbid="+i+"&command=scap 3d "+s+"; select displayed set","_blank")})),e.myEventCls.onIds("#"+e.pre+"reload_mutation_pdb","click",(function(t){e.icn3d,t.preventDefault(),e.cfg.notebook||dialog.dialog("close");let s=$("#"+e.pre+"mutationids").val(),i=s.substr(0,s.indexOf("_"));e.htmlCls.clickMenuCls.setLogCmd("pdb of mutation "+s,!1),window.open(e.htmlCls.baseUrl+"icn3d/full.html?mmdbid="+i+"&command=scap pdb "+s+"; select displayed set","_blank")})),e.myEventCls.onIds("#"+e.pre+"reload_mutation_inter","click",(function(t){let s=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close");let i=$("#"+e.pre+"mutationids").val(),l=i.split(","),n=[];for(let e=0,t=l.length;e<t;++e){let t=l[e].lastIndexOf("_"),s=l[e].substr(0,t);n.push(s)}let o=i.substr(0,i.indexOf("_"));s.structures||(s.structures={},s.structures[o]=1),s.resid2specCls.residueids2spec(n),e.htmlCls.clickMenuCls.setLogCmd("interaction change of mutation "+i,!1),window.open(e.htmlCls.baseUrl+"icn3d/full.html?mmdbid="+o+"&command=scap interaction "+i,"_blank")})),e.myEventCls.onIds("#"+e.pre+"reload_mmcif","click",(function(t){e.icn3d,t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),e.htmlCls.clickMenuCls.setLogCmd("load mmcif "+$("#"+e.pre+"mmcifid").val(),!1),window.open(e.htmlCls.baseUrl+"icn3d/full.html?mmcifid="+$("#"+e.pre+"mmcifid").val(),"_blank")})),e.myEventCls.onIds("#"+e.pre+"mmcifid","keyup",(function(t){e.icn3d,13===t.keyCode&&(t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),e.htmlCls.clickMenuCls.setLogCmd("load mmcif "+$("#"+e.pre+"mmcifid").val(),!1),window.open(e.htmlCls.baseUrl+"icn3d/full.html?mmcifid="+$("#"+e.pre+"mmcifid").val(),"_blank"))})),e.myEventCls.onIds("#"+e.pre+"reload_mmdb","click",(function(t){e.icn3d,t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),e.htmlCls.clickMenuCls.setLogCmd("load mmdb "+$("#"+e.pre+"mmdbid").val(),!1),window.open(e.htmlCls.baseUrl+"icn3d/full.html?mmdbid="+$("#"+e.pre+"mmdbid").val(),"_blank")})),e.myEventCls.onIds("#"+e.pre+"mmdbid","keyup",(function(t){e.icn3d,13===t.keyCode&&(t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),e.htmlCls.clickMenuCls.setLogCmd("load mmdb "+$("#"+e.pre+"mmdbid").val(),!1),window.open(e.htmlCls.baseUrl+"icn3d/full.html?mmdbid="+$("#"+e.pre+"mmdbid").val(),"_blank"))})),e.myEventCls.onIds("#"+e.pre+"reload_blast_rep_id","click",(function(t){e.icn3d,t.preventDefault(),e.cfg.notebook||dialog.dialog("close");let s=$("#"+e.pre+"query_id").val(),i=encodeURIComponent($("#"+e.pre+"query_fasta").val()),l=$("#"+e.pre+"blast_rep_id").val();e.htmlCls.clickMenuCls.setLogCmd("load seq_struc_ids "+s+","+l,!1),s=""!==s&&void 0!==s?s:i,window.open(e.htmlCls.baseUrl+"icn3d/full.html?from=icn3d&blast_rep_id="+l+"&query_id="+s+"&command=view annotations; set annotation cdd; set annotation site; set view detailed view; select chain "+l+"; show selection","_blank")})),e.myEventCls.onIds("#"+e.pre+"reload_gi","click",(function(t){e.icn3d,t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),e.htmlCls.clickMenuCls.setLogCmd("load gi "+$("#"+e.pre+"gi").val(),!1),window.open(e.htmlCls.baseUrl+"icn3d/full.html?gi="+$("#"+e.pre+"gi").val(),"_blank")})),e.myEventCls.onIds("#"+e.pre+"gi","keyup",(function(t){e.icn3d,13===t.keyCode&&(t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),e.htmlCls.clickMenuCls.setLogCmd("load gi "+$("#"+e.pre+"gi").val(),!1),window.open(e.htmlCls.baseUrl+"icn3d/full.html?gi="+$("#"+e.pre+"gi").val(),"_blank"))})),e.myEventCls.onIds("#"+e.pre+"reload_uniprotid","click",(function(t){e.icn3d,t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),e.htmlCls.clickMenuCls.setLogCmd("load uniprotid "+$("#"+e.pre+"uniprotid").val(),!1),window.open(e.htmlCls.baseUrl+"icn3d/full.html?uniprotid="+$("#"+e.pre+"uniprotid").val(),"_blank")})),e.myEventCls.onIds("#"+e.pre+"uniprotid","keyup",(function(t){e.icn3d,13===t.keyCode&&(t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),e.htmlCls.clickMenuCls.setLogCmd("load uniprotid "+$("#"+e.pre+"uniprotid").val(),!1),window.open(e.htmlCls.baseUrl+"icn3d/full.html?uniprotid="+$("#"+e.pre+"uniprotid").val(),"_blank"))})),e.myEventCls.onIds("#"+e.pre+"reload_cid","click",(function(t){e.icn3d,t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),e.htmlCls.clickMenuCls.setLogCmd("load cid "+$("#"+e.pre+"cid").val(),!1),window.open(e.htmlCls.baseUrl+"icn3d/full.html?cid="+$("#"+e.pre+"cid").val(),"_blank")})),e.myEventCls.onIds("#"+e.pre+"cid","keyup",(function(t){e.icn3d,13===t.keyCode&&(t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),e.htmlCls.clickMenuCls.setLogCmd("load cid "+$("#"+e.pre+"cid").val(),!1),window.open(e.htmlCls.baseUrl+"icn3d/full.html?cid="+$("#"+e.pre+"cid").val(),"_blank"))})),e.htmlCls.setHtmlCls.clickReload_pngimage(),e.myEventCls.onIds("#"+e.pre+"reload_state","click",(function(t){let s=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),e.cfg.notebook?s.resizeCanvasCls.closeDialogs():$(".ui-dialog-content").dialog("close"),s.bInputfile||s.init();let i=$("#"+e.pre+"state")[0].files[0];if(i){e.htmlCls.setHtmlCls.fileSupport();let t=new FileReader;t.onload=function(t){s.bStatefile=!0;let i=t.target.result;e.htmlCls.clickMenuCls.setLogCmd("load state file "+$("#"+e.pre+"state").val(),!1),s.commands=[],s.optsHistory=[],s.loadScriptCls.loadScript(i,!0)},t.readAsText(i)}else alert("Please select a file before clicking 'Load'")})),e.myEventCls.onIds("#"+e.pre+"reload_selectionfile","click",(function(t){let s=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close");let i=$("#"+e.pre+"selectionfile")[0].files[0];if(i){e.htmlCls.setHtmlCls.fileSupport();let t=new FileReader;t.onload=function(t){let i=t.target.result;s.selectionCls.loadSelection(i),e.htmlCls.clickMenuCls.setLogCmd("load selection file "+$("#"+e.pre+"selectionfile").val(),!1)},t.readAsText(i)}else alert("Please select a file before clicking 'Load'")})),e.myEventCls.onIds("#"+e.pre+"reload_dsn6file2fofc","click",(function(t){let s=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),s.dsn6ParserCls.loadDsn6File("2fofc")})),e.myEventCls.onIds("#"+e.pre+"reload_dsn6filefofc","click",(function(t){let s=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),s.dsn6ParserCls.loadDsn6File("fofc")})),e.myEventCls.onIds("#"+e.pre+"reload_delphifile","click",(function(t){let s=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),s.delphiCls.loadDelphiFile("delphi")})),e.myEventCls.onIds("#"+e.pre+"reload_pqrfile","click",(function(t){let s=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),s.delphiCls.loadPhiFile("pqr")})),e.myEventCls.onIds("#"+e.pre+"reload_phifile","click",(function(t){let s=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),s.delphiCls.loadPhiFile("phi")})),e.myEventCls.onIds("#"+e.pre+"reload_cubefile","click",(function(t){let s=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),s.delphiCls.loadPhiFile("cube")})),e.myEventCls.onIds("#"+e.pre+"reload_pqrurlfile","click",(function(t){let s=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),s.delphiCls.loadPhiFileUrl("pqrurl")})),e.myEventCls.onIds("#"+e.pre+"reload_phiurlfile","click",(function(t){let s=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),s.delphiCls.loadPhiFileUrl("phiurl")})),e.myEventCls.onIds("#"+e.pre+"reload_cubeurlfile","click",(function(t){let s=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),s.delphiCls.loadPhiFileUrl("cubeurl")})),e.myEventCls.onIds("#"+e.pre+"reload_delphifile2","click",(function(t){let s=e.icn3d;t.preventDefault(),e.htmlCls.setHtmlCls.updateSurfPara("delphi"),e.cfg.notebook||dialog.dialog("close"),s.delphiCls.loadDelphiFile("delphi2")})),e.myEventCls.onIds("#"+e.pre+"reload_pqrfile2","click",(function(t){let s=e.icn3d;t.preventDefault(),e.htmlCls.setHtmlCls.updateSurfPara("phi"),e.cfg.notebook||dialog.dialog("close"),s.delphiCls.loadPhiFile("pqr2")})),e.myEventCls.onIds("#"+e.pre+"reload_phifile2","click",(function(t){let s=e.icn3d;t.preventDefault(),e.htmlCls.setHtmlCls.updateSurfPara("phi"),e.cfg.notebook||dialog.dialog("close"),s.delphiCls.loadPhiFile("phi2")})),e.myEventCls.onIds("#"+e.pre+"reload_cubefile2","click",(function(t){let s=e.icn3d;t.preventDefault(),e.htmlCls.setHtmlCls.updateSurfPara("phi"),e.cfg.notebook||dialog.dialog("close"),s.delphiCls.loadPhiFile("cube2")})),e.myEventCls.onIds("#"+e.pre+"reload_pqrurlfile2","click",(function(t){let s=e.icn3d;t.preventDefault(),e.htmlCls.setHtmlCls.updateSurfPara("phiurl"),e.cfg.notebook||dialog.dialog("close"),s.delphiCls.loadPhiFileUrl("pqrurl2")})),e.myEventCls.onIds("#"+e.pre+"reload_phiurlfile2","click",(function(t){let s=e.icn3d;t.preventDefault(),e.htmlCls.setHtmlCls.updateSurfPara("phiurl"),e.cfg.notebook||dialog.dialog("close"),s.delphiCls.loadPhiFileUrl("phiurl2")})),e.myEventCls.onIds("#"+e.pre+"reload_cubeurlfile2","click",(function(t){let s=e.icn3d;t.preventDefault(),e.htmlCls.setHtmlCls.updateSurfPara("phiurl"),e.cfg.notebook||dialog.dialog("close"),s.delphiCls.loadPhiFileUrl("cubeurl2")})),e.myEventCls.onIds("#"+e.pre+"reload_dsn6fileurl2fofc","click",(function(t){let s=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),s.dsn6ParserCls.loadDsn6FileUrl("2fofc")})),e.myEventCls.onIds("#"+e.pre+"reload_dsn6fileurlfofc","click",(function(t){let s=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),s.dsn6ParserCls.loadDsn6FileUrl("fofc")})),e.myEventCls.onIds("#"+e.pre+"reload_pdbfile","click",(function(t){let s=e.icn3d;t.preventDefault(),s.bInitial=!0,e.cfg.notebook||dialog.dialog("close"),e.cfg.notebook?s.resizeCanvasCls.closeDialogs():$(".ui-dialog-content").dialog("close");let i=$("#"+e.pre+"pdbfile")[0].files[0];if(i){e.htmlCls.setHtmlCls.fileSupport();let t=new FileReader;t.onload=function(t){let i=t.target.result;e.htmlCls.clickMenuCls.setLogCmd("load pdb file "+$("#"+e.pre+"pdbfile").val(),!1),s.molTitle="",s.init(),s.bInputfile=!0,s.InputfileData=i,s.InputfileType="pdb",s.pdbParserCls.loadPdbData(i)},t.readAsText(i)}else alert("Please select a file before clicking 'Load'")})),e.myEventCls.onIds("#"+e.pre+"reload_mol2file","click",(function(t){let s=e.icn3d;t.preventDefault(),s.bInitial=!0,e.cfg.notebook||dialog.dialog("close"),e.cfg.notebook?s.resizeCanvasCls.closeDialogs():$(".ui-dialog-content").dialog("close");let i=$("#"+e.pre+"mol2file")[0].files[0];if(i){e.htmlCls.setHtmlCls.fileSupport();let t=new FileReader;t.onload=function(t){let i=t.target.result;e.htmlCls.clickMenuCls.setLogCmd("load mol2 file "+$("#"+e.pre+"mol2file").val(),!1),s.molTitle="",s.inputid=void 0,s.init(),s.bInputfile=!0,s.InputfileData=i,s.InputfileType="mol2",s.mol2ParserCls.loadMol2Data(i)},t.readAsText(i)}else alert("Please select a file before clicking 'Load'")})),e.myEventCls.onIds("#"+e.pre+"reload_sdffile","click",(function(t){let s=e.icn3d;t.preventDefault(),s.bInitial=!0,e.cfg.notebook||dialog.dialog("close"),e.cfg.notebook?s.resizeCanvasCls.closeDialogs():$(".ui-dialog-content").dialog("close");let i=$("#"+e.pre+"sdffile")[0].files[0];if(i){e.htmlCls.setHtmlCls.fileSupport();let t=new FileReader;t.onload=function(t){let i=t.target.result;e.htmlCls.clickMenuCls.setLogCmd("load sdf file "+$("#"+e.pre+"sdffile").val(),!1),s.molTitle="",s.inputid=void 0,s.init(),s.bInputfile=!0,s.InputfileData=i,s.InputfileType="sdf",s.sdfParserCls.loadSdfData(i)},t.readAsText(i)}else alert("Please select a file before clicking 'Load'")})),e.myEventCls.onIds("#"+e.pre+"reload_xyzfile","click",(function(t){let s=e.icn3d;t.preventDefault(),s.bInitial=!0,e.cfg.notebook||dialog.dialog("close"),e.cfg.notebook?s.resizeCanvasCls.closeDialogs():$(".ui-dialog-content").dialog("close");let i=$("#"+e.pre+"xyzfile")[0].files[0];if(i){e.htmlCls.setHtmlCls.fileSupport();let t=new FileReader;t.onload=function(t){let i=t.target.result;e.htmlCls.clickMenuCls.setLogCmd("load xyz file "+$("#"+e.pre+"xyzfile").val(),!1),s.molTitle="",s.inputid=void 0,s.init(),s.bInputfile=!0,s.InputfileData=i,s.InputfileType="xyz",s.xyzParserCls.loadXyzData(i)},t.readAsText(i)}else alert("Please select a file before clicking 'Load'")})),e.myEventCls.onIds("#"+e.pre+"reload_urlfile","click",(function(t){let s=e.icn3d;t.preventDefault(),s.bInitial=!0,e.cfg.notebook||dialog.dialog("close"),e.cfg.notebook?s.resizeCanvasCls.closeDialogs():$(".ui-dialog-content").dialog("close");let i=$("#"+e.pre+"filetype").val(),l=$("#"+e.pre+"urlfile").val();s.inputurl="type="+i+"&url="+encodeURIComponent(l),s.init(),s.bInputfile=!0,s.bInputUrlfile=!0,s.pdbParserCls.downloadUrl(l,i)})),e.myEventCls.onIds("#"+e.pre+"reload_mmciffile","click",(function(t){let s=e.icn3d;t.preventDefault(),s.bInitial=!0,e.cfg.notebook||dialog.dialog("close"),e.cfg.notebook?s.resizeCanvasCls.closeDialogs():$(".ui-dialog-content").dialog("close");let i=$("#"+e.pre+"mmciffile")[0].files[0];if(i){e.htmlCls.setHtmlCls.fileSupport();let t=new FileReader;t.onload=function(t){let i=t.target.result;e.htmlCls.clickMenuCls.setLogCmd("load mmcif file "+$("#"+e.pre+"mmciffile").val(),!1),s.molTitle="";let l=e.htmlCls.baseUrl+"mmcifparser/mmcifparser.cgi";s.bCid=void 0,$.ajax({url:l,type:"POST",data:{mmciffile:i},dataType:"jsonp",cache:!0,tryCount:0,retryLimit:1,beforeSend:function(){s.ParserUtilsCls.showLoading()},complete:function(){},success:function(e){s.init(),s.bInputfile=!0,s.InputfileData=e,s.InputfileType="mmcif",s.mmcifParserCls.loadMmcifData(e)},error:function(e,t,s){this.tryCount++,this.tryCount<=this.retryLimit&&$.ajax(this)}})},t.readAsText(i)}else alert("Please select a file before clicking 'Load'")})),e.myEventCls.onIds("#"+e.pre+"applycustomcolor","click",(function(t){let s=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),s.setOptionCls.setOption("color",$("#"+e.pre+"colorcustom").val()),e.htmlCls.clickMenuCls.setLogCmd("color "+$("#"+e.pre+"colorcustom").val(),!0)})),e.myEventCls.onIds(["#"+e.pre+"atomsCustomSphere2","#"+e.pre+"atomsCustomSphere","#"+e.pre+"radius_aroundsphere"],"change",(function(t){e.icn3d.bSphereCalc=!1})),e.myEventCls.onIds("#"+e.pre+"applypick_aroundsphere","click",(function(t){let s=e.icn3d,i=parseFloat($("#"+e.pre+"radius_aroundsphere").val()),l=$("#"+e.pre+"atomsCustomSphere").val(),n=$("#"+e.pre+"atomsCustomSphere2").val();if(0==n.length)alert("Please select the first set at step #1");else{let t="select zone cutoff "+i+" | sets "+n+" "+l+" | "+s.bSphereCalc;s.bSphereCalc||s.showInterCls.pickCustomSphere(i,n,l,s.bSphereCalc),s.bSphereCalc=!0,s.hlUpdateCls.updateHlAll(),e.htmlCls.clickMenuCls.setLogCmd(t,!0)}})),e.myEventCls.onIds("#"+e.pre+"sphereExport","click",(function(t){let s=e.icn3d;t.preventDefault();let i=parseFloat($("#"+e.pre+"radius_aroundsphere").val()),l=$("#"+e.pre+"atomsCustomSphere").val(),n=$("#"+e.pre+"atomsCustomSphere2").val();if(0==n.length)alert("Please select the first set at step #1");else{s.showInterCls.pickCustomSphere(i,n,l,s.bSphereCalc),s.bSphereCalc=!0;let t=s.viewInterPairsCls.exportSpherePairs(),o=s.inputid?s.inputid:"custom";s.saveFileCls.saveFile(o+"_sphere_pairs.html","html",t),e.htmlCls.clickMenuCls.setLogCmd("export pairs | "+n+" "+l+" | dist "+i,!0)}})),e.myEventCls.onIds("#"+e.pre+"apply_adjustmem","click",(function(t){let s=e.icn3d;e.cfg.notebook||dialog.dialog("close");let i=parseFloat($("#"+e.pre+"extra_mem_z").val()),l=parseFloat($("#"+e.pre+"intra_mem_z").val());s.selectionCls.adjustMembrane(i,l);let n="adjust membrane z-axis "+i+" "+l;e.htmlCls.clickMenuCls.setLogCmd(n,!0)})),e.myEventCls.onIds("#"+e.pre+"apply_selectplane","click",(function(t){let s=e.icn3d;e.cfg.notebook||dialog.dialog("close");let i=parseFloat($("#"+e.pre+"selectplane_z1").val()),l=parseFloat($("#"+e.pre+"selectplane_z2").val());s.selectionCls.selectBtwPlanes(i,l);let n="select planes z-axis "+i+" "+l;e.htmlCls.clickMenuCls.setLogCmd(n,!0)})),e.myEventCls.onIds(["#"+e.pre+"atomsCustomHbond2","#"+e.pre+"atomsCustomHbond","#"+e.pre+"analysis_hbond","#"+e.pre+"analysis_saltbridge","#"+e.pre+"analysis_contact","#"+e.pre+"hbondthreshold","#"+e.pre+"saltbridgethreshold","#"+e.pre+"contactthreshold"],"change",(function(t){e.icn3d.bHbondCalc=!1})),e.myEventCls.onIds("#"+e.pre+"crossstrucinter","change",(function(t){let s=e.icn3d;t.preventDefault(),s.crossstrucinter=parseInt($("#"+e.pre+"crossstrucinter").val()),e.htmlCls.clickMenuCls.setLogCmd("cross structure interaction "+s.crossstrucinter,!0)})),e.myEventCls.onIds("#"+e.pre+"applyhbonds","click",(function(t){let s=e.icn3d;t.preventDefault(),s.showInterCls.showInteractions("3d")})),e.myEventCls.onIds("#"+e.pre+"applycontactmap","click",(function(t){let s=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close");let i=parseFloat($("#"+s.pre+"contactdist").val()),l=$("#"+s.pre+"contacttype").val();s.contactMapCls.contactMap(i,l),e.htmlCls.clickMenuCls.setLogCmd("contact map | dist "+i+" | type "+l,!0)})),e.myEventCls.onIds("#"+e.pre+"hbondWindow","click",(function(t){let s=e.icn3d;t.preventDefault(),s.showInterCls.showInteractions("view")})),e.myEventCls.onIds("#"+e.pre+"areaWindow","click",(function(t){let s=e.icn3d;t.preventDefault();let i=$("#"+e.pre+"atomsCustomHbond").val(),l=$("#"+e.pre+"atomsCustomHbond2").val();s.analysisCls.calcBuriedSurface(l,i),e.htmlCls.clickMenuCls.setLogCmd("calc buried surface | "+l+" "+i,!0)})),e.myEventCls.onIds("#"+e.pre+"sortSet1","click",(function(t){let s=e.icn3d;t.preventDefault(),s.showInterCls.showInteractions("save1")})),$(document).on("click","."+e.pre+"showintercntonly",(function(t){e.icn3d,t.stopImmediatePropagation(),$(".icn3d-border").hide(),e.htmlCls.clickMenuCls.setLogCmd("table inter count only",!0)})),$(document).on("click","."+e.pre+"showinterdetails",(function(t){e.icn3d,t.stopImmediatePropagation(),$(".icn3d-border").show(),e.htmlCls.clickMenuCls.setLogCmd("table inter details",!0)})),e.myEventCls.onIds("#"+e.pre+"sortSet2","click",(function(t){let s=e.icn3d;t.preventDefault(),s.showInterCls.showInteractions("save2")})),e.myEventCls.onIds("#"+e.pre+"hbondGraph","click",(function(t){let s=e.icn3d;t.preventDefault(),s.showInterCls.showInteractions("graph")})),e.myEventCls.onIds("#"+e.pre+"hbondLineGraph","click",(function(t){let s=e.icn3d;t.preventDefault(),s.showInterCls.showInteractions("linegraph")})),e.myEventCls.onIds("#"+e.pre+"hbondScatterplot","click",(function(t){let s=e.icn3d;t.preventDefault(),s.showInterCls.showInteractions("scatterplot")})),$(document).on("click","#"+e.svgid+" circle.selected",(function(t){let s=e.icn3d;t.stopImmediatePropagation();let i=$(this).attr("res");!1!==s.bSelectResidue||s.bShift||s.bCtrl||s.selectionCls.removeSelection(),void 0!==i&&(s.hlSeqCls.selectResidues(i,this),s.hlObjectsCls.addHlObjects())})),e.myEventCls.onIds("#"+e.svgid+"_svg","click",(function(t){let s=e.icn3d;t.preventDefault(),s.saveFileCls.saveSvg(e.svgid,s.inputid+"_force_directed_graph.svg")})),e.myEventCls.onIds("#"+e.svgid+"_png","click",(function(t){let s=e.icn3d;t.preventDefault();let i=$("#"+e.pre+"dl_graph").width(),l=$("#"+e.pre+"dl_graph").height();s.saveFileCls.savePng(e.svgid,s.inputid+"_force_directed_graph.png",i,l)})),e.myEventCls.onIds("#"+e.svgid+"_json","click",(function(t){let s=e.icn3d;t.preventDefault();let i=s.graphStr.substr(0,s.graphStr.lastIndexOf("}"));i+=e.htmlCls.setHtmlCls.getLinkColor(),s.saveFileCls.saveFile(s.inputid+"_force_directed_graph.json","text",[i])})),e.myEventCls.onIds("#"+e.linegraphid+"_svg","click",(function(t){let s=e.icn3d;t.preventDefault(),s.saveFileCls.saveSvg(e.linegraphid,s.inputid+"_line_graph.svg")})),e.myEventCls.onIds("#"+e.linegraphid+"_png","click",(function(t){let s=e.icn3d;t.preventDefault();let i=$("#"+e.pre+"dl_linegraph").width(),l=$("#"+e.pre+"dl_linegraph").height();s.saveFileCls.savePng(e.linegraphid,s.inputid+"_line_graph.png",i,l)})),e.myEventCls.onIds("#"+e.linegraphid+"_json","click",(function(t){let s=e.icn3d;t.preventDefault();let i=s.lineGraphStr.substr(0,s.lineGraphStr.lastIndexOf("}"));i+=e.htmlCls.setHtmlCls.getLinkColor(),s.saveFileCls.saveFile(s.inputid+"_line_graph.json","text",[i])})),e.myEventCls.onIds("#"+e.linegraphid+"_scale","change",(function(t){let s=e.icn3d;t.preventDefault();let i=$("#"+e.linegraphid+"_scale").val();$("#"+e.linegraphid).attr("width",(s.linegraphWidth*parseFloat(i)).toString()+"px"),e.htmlCls.clickMenuCls.setLogCmd("line graph scale "+i,!0)})),e.myEventCls.onIds("#"+e.scatterplotid+"_svg","click",(function(t){let s=e.icn3d;t.preventDefault(),s.saveFileCls.saveSvg(e.scatterplotid,s.inputid+"_scatterplot.svg")})),e.myEventCls.onIds("#"+e.scatterplotid+"_png","click",(function(t){let s=e.icn3d;t.preventDefault();let i=$("#"+e.pre+"dl_scatterplot").width(),l=$("#"+e.pre+"dl_scatterplot").height();s.saveFileCls.savePng(e.scatterplotid,s.inputid+"_scatterplot.png",i,l)})),e.myEventCls.onIds("#"+e.scatterplotid+"_json","click",(function(t){let s=e.icn3d;t.preventDefault();let i=s.scatterplotStr.substr(0,s.scatterplotStr.lastIndexOf("}"));i+=e.htmlCls.setHtmlCls.getLinkColor(),s.saveFileCls.saveFile(s.inputid+"_scatterplot.json","text",[i])})),e.myEventCls.onIds("#"+e.scatterplotid+"_scale","change",(function(t){let s=e.icn3d;t.preventDefault();let i=$("#"+e.scatterplotid+"_scale").val();$("#"+e.scatterplotid).attr("width",(s.scatterplotWidth*parseFloat(i)).toString()+"px"),e.htmlCls.clickMenuCls.setLogCmd("scatterplot scale "+i,!0)})),e.myEventCls.onIds("#"+e.contactmapid+"_svg","click",(function(t){let s=e.icn3d;t.preventDefault(),s.saveFileCls.saveSvg(e.contactmapid,s.inputid+"_contactmap.svg")})),e.myEventCls.onIds("#"+e.contactmapid+"_png","click",(function(t){let s=e.icn3d;t.preventDefault();let i=$("#"+e.pre+"dl_contactmap").width(),l=$("#"+e.pre+"dl_contactmap").height();s.saveFileCls.savePng(e.contactmapid,s.inputid+"_contactmap.png",i,l)})),e.myEventCls.onIds("#"+e.contactmapid+"_json","click",(function(t){let s=e.icn3d;t.preventDefault();let i=s.contactmapStr.substr(0,s.contactmapStr.lastIndexOf("}"));i+=e.htmlCls.setHtmlCls.getLinkColor(),s.saveFileCls.saveFile(s.inputid+"_contactmap.json","text",[i])})),e.myEventCls.onIds("#"+e.contactmapid+"_scale","change",(function(t){let s=e.icn3d;t.preventDefault();let i=$("#"+e.contactmapid+"_scale").val();$("#"+e.contactmapid).attr("width",(s.contactmapWidth*parseFloat(i)).toString()+"px"),e.htmlCls.clickMenuCls.setLogCmd("contactmap scale "+i,!0)})),e.myEventCls.onIds("#"+e.svgid+"_label","change",(function(t){e.icn3d,t.preventDefault();let s=$("#"+e.svgid+"_label").val();$("#"+e.svgid+" text").removeClass(),$("#"+e.svgid+" text").addClass(s),e.htmlCls.clickMenuCls.setLogCmd("graph label "+s,!0)})),e.myEventCls.onIds("#"+e.svgid+"_hideedges","change",(function(t){let s=e.icn3d;t.preventDefault(),e.htmlCls.hideedges=parseInt($("#"+e.svgid+"_hideedges").val()),e.htmlCls.hideedges?(e.htmlCls.contactInsideColor="FFF",e.htmlCls.hbondInsideColor="FFF",e.htmlCls.ionicInsideColor="FFF"):(e.htmlCls.contactInsideColor="DDD",e.htmlCls.hbondInsideColor="AFA",e.htmlCls.ionicInsideColor="8FF"),void 0!==s.graphStr&&(s.bRender&&e.htmlCls.force&&e.drawGraph(s.graphStr,e.pre+"dl_graph"),e.htmlCls.clickMenuCls.setLogCmd("hide edges "+e.htmlCls.hideedges,!0))})),e.myEventCls.onIds("#"+e.svgid+"_force","change",(function(t){let s=e.icn3d;t.preventDefault(),e.htmlCls.force=parseInt($("#"+e.svgid+"_force").val()),void 0!==s.graphStr&&(e.htmlCls.clickMenuCls.setLogCmd("graph force "+e.htmlCls.force,!0),s.getGraphCls.handleForce())})),e.myEventCls.onIds("#"+e.pre+"hbondReset","click",(function(t){let s=e.icn3d;t.preventDefault(),s.viewInterPairsCls.resetInteractionPairs(),e.htmlCls.clickMenuCls.setLogCmd("reset interaction pairs",!0)})),e.myEventCls.onIds("#"+e.pre+"applypick_labels","click",(function(t){let s=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close");let i=$("#"+e.pre+"labeltext").val(),l=$("#"+e.pre+"labelsize").val(),n=$("#"+e.pre+"labelcolor").val(),o=$("#"+e.pre+"labelbkgd").val();if("0"!==l&&""!==l&&"undefined"!==l||(l=0),"0"!==n&&""!==n&&"undefined"!==n||(n=0),"0"!==o&&""!==o&&"undefined"!==o||(o=0),void 0===s.pAtom||void 0===s.pAtom2)alert("Please pick another atom");else{let t=(s.pAtom.coord.x+s.pAtom2.coord.x)/2,r=(s.pAtom.coord.y+s.pAtom2.coord.y)/2,a=(s.pAtom.coord.z+s.pAtom2.coord.z)/2;s.analysisCls.addLabel(i,t,r,a,l,n,o,"custom"),s.pickpair=!1;let d="",c="",h="";0!=l&&(d=" | size "+l),0!=n&&(c=" | color "+n),0!=o&&(h=" | background "+o),e.htmlCls.clickMenuCls.setLogCmd("add label "+i+" | x "+t.toPrecision(4)+" y "+r.toPrecision(4)+" z "+a.toPrecision(4)+d+c+h+" | type custom",!0),s.drawCls.draw()}})),e.myEventCls.onIds("#"+e.pre+"applyselection_labels","click",(function(t){let s=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close");let i=$("#"+e.pre+"labeltext2").val(),l=$("#"+e.pre+"labelsize2").val(),n=$("#"+e.pre+"labelcolor2").val(),o=$("#"+e.pre+"labelbkgd2").val();"0"!==l&&""!==l&&"undefined"!==l||(l=0),"0"!==n&&""!==n&&"undefined"!==n||(n=0),"0"!==o&&""!==o&&"undefined"!==o||(o=0);let r=s.applyCenterCls.centerAtoms(e.hashUtilsCls.hash2Atoms(s.hAtoms,s.atoms)),a=r.center.x,d=r.center.y,c=r.center.z;s.analysisCls.addLabel(i,a,d,c,l,n,o,"custom");let h="",m="",p="";0!=l&&(h=" | size "+l),0!=n&&(m=" | color "+n),0!=o&&(p=" | background "+o),e.htmlCls.clickMenuCls.setLogCmd("add label "+i+" | x "+a.toPrecision(4)+" y "+d.toPrecision(4)+" z "+c.toPrecision(4)+h+m+p+" | type custom",!0),s.drawCls.draw()})),e.myEventCls.onIds("#"+e.pre+"applypick_stabilizer","click",(function(t){let s=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),void 0===s.pAtom||void 0===s.pAtom2?alert("Please pick another atom"):(s.pickpair=!1,e.htmlCls.clickMenuCls.setLogCmd("add one stabilizer | "+s.pAtom.serial+" "+s.pAtom2.serial,!0),void 0===s.pairArray&&(s.pairArray=[]),s.pairArray.push(s.pAtom.serial),s.pairArray.push(s.pAtom2.serial),s.threeDPrintCls.setThichknessFor3Dprint(),s.drawCls.draw())}));let i=new CP(document.querySelector("#"+e.pre+"colorcustom"));i.on("change",(function(e){this.target.value=e})),e.myEventCls.onIds("#"+e.pre+"colorcustom","input",(function(){let t=$("#"+e.pre+"colorcustom").val();i.set("#"+t).enter()})),e.myEventCls.onIds("#"+e.pre+"colorcustom","keyup",(function(){let t=$("#"+e.pre+"colorcustom").val();i.set("#"+t).enter()})),e.myEventCls.onIds("#"+e.pre+"colorcustom","paste",(function(){let t=$("#"+e.pre+"colorcustom").val();i.set("#"+t).enter()})),e.myEventCls.onIds("#"+e.pre+"colorcustom","cut",(function(){let t=$("#"+e.pre+"colorcustom").val();i.set("#"+t).enter()})),e.myEventCls.onIds("#"+e.pre+"applypick_stabilizer_rm","click",(function(t){let s=e.icn3d;if(t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),void 0===s.pAtom||void 0===s.pAtom2)alert("Please pick another atom");else{s.pickpair=!1,e.htmlCls.clickMenuCls.setLogCmd("remove one stabilizer | "+s.pAtom.serial+" "+s.pAtom2.serial,!0);let t=[];t.push(s.pAtom.serial),t.push(s.pAtom2.serial),s.threeDPrintCls.removeOneStabilizer(t),s.drawCls.draw()}})),e.myEventCls.onIds("#"+e.pre+"applypick_measuredistance","click",(function(t){let s=e.icn3d;if(t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),s.bMeasureDistance=!1,void 0===s.pAtom||void 0===s.pAtom2)alert("Please pick another atom");else{let t=0,i=0,l=$("#"+e.pre+"linecolor").val(),n=(s.pAtom.coord.x+s.pAtom2.coord.x)/2,o=(s.pAtom.coord.y+s.pAtom2.coord.y)/2,r=(s.pAtom.coord.z+s.pAtom2.coord.z)/2;s.analysisCls.addLineFromPicking("distance");let a=(parseInt(10*s.pAtom.coord.distanceTo(s.pAtom2.coord))/10).toString()+" A";s.analysisCls.addLabel(a,n,o,r,t,l,i,"distance");let d="",c="",h="";0!=l&&(c=" | color "+l),e.htmlCls.clickMenuCls.setLogCmd("add label "+a+" | x "+n.toPrecision(4)+" y "+o.toPrecision(4)+" z "+r.toPrecision(4)+d+c+h+" | type distance",!0),s.drawCls.draw(),s.pk=2}})),e.myEventCls.onIds("#"+e.pre+"applydist2","click",(function(t){let s=e.icn3d;t.preventDefault(),e.cfg.notebook||dialog.dialog("close"),s.bMeasureDistance=!1;let i=$("#"+e.pre+"atomsCustomDist").val(),l=$("#"+e.pre+"atomsCustomDist2").val();s.analysisCls.measureDistTwoSets(i,l),e.htmlCls.clickMenuCls.setLogCmd("dist | "+l+" "+i,!0)})),e.myEventCls.onIds("#"+e.pre+"apply_thickness_3dprint","click",(function(t){e.icn3d,t.preventDefault(),e.htmlCls.setHtmlCls.setLineThickness("3dprint")})),e.myEventCls.onIds("#"+e.pre+"apply_thickness_style","click",(function(t){e.icn3d,t.preventDefault(),e.htmlCls.setHtmlCls.setLineThickness("style")})),e.myEventCls.onIds("#"+e.pre+"reset_thickness_3dprint","click",(function(t){e.icn3d,t.preventDefault(),e.htmlCls.setHtmlCls.setLineThickness("3dprint",!0)})),e.myEventCls.onIds("#"+e.pre+"reset_thickness_style","click",(function(t){e.icn3d,t.preventDefault(),e.htmlCls.setHtmlCls.setLineThickness("style",!0)})),e.myEventCls.onIds("#"+e.pre+"reset","click",(function(t){let s=e.icn3d;s.selectionCls.resetAll(),s.bRender&&s.drawCls.draw()})),e.myEventCls.onIds(["#"+e.pre+"toggleHighlight","#"+e.pre+"toggleHighlight2"],"click",(function(t){let s=e.icn3d;t.stopImmediatePropagation(),s.hlUpdateCls.toggleHighlight(),e.htmlCls.clickMenuCls.setLogCmd("toggle highlight",!0)})),e.myEventCls.onIds("#"+e.pre+"seq_clearselection","click",(function(t){let s=e.icn3d;t.stopImmediatePropagation(),e.cfg.notebook||dialog.dialog("close"),s.hlUpdateCls.clearHighlight(),e.htmlCls.clickMenuCls.setLogCmd("clear selection",!0)})),e.myEventCls.onIds("#"+e.pre+"seq_clearselection2","click",(function(t){let s=e.icn3d;t.stopImmediatePropagation(),t.preventDefault(),s.hlUpdateCls.clearHighlight(),e.htmlCls.clickMenuCls.setLogCmd("clear selection",!0)})),e.myEventCls.onIds("#"+e.pre+"alignseq_clearselection","click",(function(t){let s=e.icn3d;t.stopImmediatePropagation(),s.hlUpdateCls.clearHighlight(),e.htmlCls.clickMenuCls.setLogCmd("clear selection",!0)})),e.myEventCls.onIds("#"+e.pre+"replay","click",(function(t){let s=e.icn3d;t.stopImmediatePropagation(),s.CURRENTNUMBER++;let i=e.cfg.replay?s.STATENUMBER:s.STATENUMBER-1;if(s.CURRENTNUMBER==i)s.bReplay=0,$("#"+e.pre+"replay").hide();else if(s.commands.length>0&&s.commands[s.CURRENTNUMBER]){s.loadScriptCls.execCommandsBase(s.CURRENTNUMBER,s.CURRENTNUMBER,s.STATENUMBER);let t=s.commands[s.CURRENTNUMBER].indexOf("|||"),i=-1!=t?s.commands[s.CURRENTNUMBER].substr(0,t):s.commands[s.CURRENTNUMBER],l=30,n=i.length>l?i.substr(0,l)+"...":i,o=s.applyCommandCls.getMenuFromCmd(n);$("#"+e.pre+"replay_cmd").html("Cmd: "+n),$("#"+e.pre+"replay_menu").html("Menu: "+o),s.drawCls.draw()}})),t.loadScriptCls.pressCommandtext(),e.myEventCls.onIds("#"+e.pre+"seq_saveselection","click",(function(t){let s=e.icn3d;t.stopImmediatePropagation(),e.cfg.notebook||dialog.dialog("close"),s.selectionCls.saveSelectionPrep();let i=$("#"+e.pre+"seq_command_name").val().replace(/\s+/g,"_");s.selectionCls.saveSelection(i,i)})),e.myEventCls.onIds("#"+e.pre+"seq_saveselection2","click",(function(t){let s=e.icn3d;t.stopImmediatePropagation(),s.selectionCls.saveSelectionPrep();let i=$("#"+e.pre+"seq_command_name2").val().replace(/\s+/g,"_");s.selectionCls.saveSelection(i,i)})),e.myEventCls.onIds("#"+e.pre+"alignseq_saveselection","click",(function(t){let s=e.icn3d;t.stopImmediatePropagation(),s.selectionCls.saveSelectionPrep();let i=$("#"+e.pre+"alignseq_command_name").val().replace(/\s+/g,"_");s.selectionCls.saveSelection(i,i)})),$(document).on("click","."+e.pre+"outputselection",(function(t){let s=e.icn3d;t.stopImmediatePropagation(),s.bSelectResidue=!1,s.bSelectAlignResidue=!1,e.htmlCls.clickMenuCls.setLogCmd("output selection",!0),s.threeDPrintCls.outputSelection()})),$(document).on("click",".icn3d-saveicon",(function(t){let s=e.icn3d;t.stopImmediatePropagation();let i=$(this).attr("pid"),l="";l+='<link rel="stylesheet" href="https:///structure.ncbi.nlm.nih.gov/icn3d/lib/jquery-ui-1.12.1.min.css">\n',l+='<link rel="stylesheet" href="https:///structure.ncbi.nlm.nih.gov/icn3d/icn3d_full_ui.css">\n',l+=$("#"+i).html();let n=i.split("_"),o=n.length>2?n[2]:i,r=Object.keys(s.structures)[0];Object.keys(s.structures).length>1&&(r+="-"+Object.keys(s.structures)[1]),s.saveFileCls.saveFile(r+"-"+o+".html","html",encodeURIComponent(l))})),$(document).on("click",".icn3d-hideicon",(function(t){let s=e.icn3d;t.stopImmediatePropagation();let i=$(this).attr("pid");if(!e.cfg.notebook)if(void 0===s.dialogHashHideDone&&(s.dialogHashHideDone={}),void 0===s.dialogHashPosToRight&&(s.dialogHashPosToRight={}),s.dialogHashHideDone.hasOwnProperty(i)){let e=s.dialogHashHideDone[i].width,t=s.dialogHashHideDone[i].height,l=s.dialogHashHideDone[i].position;$("#"+i).dialog("option","width",e),$("#"+i).dialog("option","height",t),$("#"+i).dialog("option","position",l),delete s.dialogHashHideDone[i]}else{s.dialogHashHideDone[i]={width:$("#"+i).dialog("option","width"),height:$("#"+i).dialog("option","height"),position:$("#"+i).dialog("option","position")};let e,t=160,l=80;$("#"+i).dialog("option","width",t),$("#"+i).dialog("option","height",l),s.dialogHashPosToRight.hasOwnProperty(i)?e=s.dialogHashPosToRight[i]:(e=Object.keys(s.dialogHashPosToRight).length*(t+10),s.dialogHashPosToRight[i]=e);let n={my:"right bottom",at:"right-"+e+" bottom+60",of:"#"+s.divid,collision:"none"};$("#"+i).dialog("option","position",n)}})),$(document).on("click","."+e.pre+"selres",(function(t){let s=e.icn3d;t.stopImmediatePropagation(),s.bSelOneRes=!1;let i=$("."+e.pre+"seloneres");for(let e=0,t=i.length;e<t;++e)i[e].checked=!1;let l=$(this).attr("resid").split("|");s.hAtoms={},s.selectedResidues={};let n="select ";for(let e=0,t=l.length;e<t;++e){let t=l[e];e>0&&(n+=" or "),n+=s.selectionCls.selectOneResid(t)}s.hlUpdateCls.updateHlAll(),e.htmlCls.clickMenuCls.setLogCmd(n,!0)})),$(document).on("click","."+e.pre+"seloneres",(function(t){let s=e.icn3d;t.stopImmediatePropagation(),s.bSelOneRes||(s.hAtoms={},s.selectedResidues={},s.bSelOneRes=!0);let i=$(this).attr("resid"),l=$(this).attr("id");$("#"+l).length&&$("#"+l)[0].checked?s.selectionCls.selectOneResid(i):$("#"+l).length&&!$("#"+l)[0].checked&&s.selectionCls.selectOneResid(i,!0),s.hlUpdateCls.updateHlAll()})),$(document).on("click","."+e.pre+"selset",(function(t){let s=e.icn3d;t.stopImmediatePropagation(),s.bSelOneRes=!1;let i=$("."+e.pre+"seloneres");for(let e=0,t=i.length;e<t;++e)i[e].checked=!1;let l=$(this).attr("cmd");s.selByCommCls.selectByCommand(l,"",""),s.hlObjectsCls.removeHlObjects(),s.hlObjectsCls.addHlObjects(),e.htmlCls.clickMenuCls.setLogCmd(l,!0)})),$(document).on("click",".icn3d-addtrack",(function(t){e.icn3d,t.stopImmediatePropagation(),$("#"+e.pre+"anno_custom")[0].checked=!0,$("[id^="+e.pre+"custom]").show();let s=$(this).attr("chainid");$("#"+e.pre+"track_chainid").val(s),e.htmlCls.dialogCls.openDlg("dl_addtrack","Add track for Chain: "+s),$("#"+e.pre+"track_gi").focus()})),$(document).on("click",".icn3d-customcolor",(function(t){e.icn3d,t.stopImmediatePropagation();let s=$(this).attr("chainid");$("#"+e.pre+"customcolor_chainid").val(s),e.htmlCls.dialogCls.openDlg("dl_customcolor","Apply custom color or tube for Chain: "+s)})),$(document).on("click",".icn3d-helixsets",(function(t){let s=e.icn3d;t.stopImmediatePropagation();let i=$(this).attr("chainid");s.addTrackCls.defineSecondary(i,"helix"),e.htmlCls.clickMenuCls.setLogCmd("define helix sets | chain "+i,!0)})),$(document).on("click",".icn3d-sheetsets",(function(t){let s=e.icn3d;t.stopImmediatePropagation();let i=$(this).attr("chainid");s.addTrackCls.defineSecondary(i,"sheet"),e.htmlCls.clickMenuCls.setLogCmd("define sheet sets | chain "+i,!0)})),$(document).on("click",".icn3d-coilsets",(function(t){let s=e.icn3d;t.stopImmediatePropagation();let i=$(this).attr("chainid");s.addTrackCls.defineSecondary(i,"coil"),e.htmlCls.clickMenuCls.setLogCmd("define coil sets | chain "+i,!0)})),e.myEventCls.onIds("#"+e.pre+"deletesets","click",(function(t){e.icn3d.definedSetsCls.deleteSelectedSets(),e.htmlCls.clickMenuCls.setLogCmd("delete selected sets",!0)})),$(document).on("mouseup touchend","accordion",(function(t){let s=e.icn3d;s.bControlGl&&!s.icn3dui.bNode?window.controls&&(window.controls.noRotate=!1,window.controls.noZoom=!1,window.controls.noPan=!1):s.controls&&(s.controls.noRotate=!1,s.controls.noZoom=!1,s.controls.noPan=!1)})),$(document).on("mousedown touchstart","accordion",(function(t){let s=e.icn3d;s.bControlGl&&!s.icn3dui.bNode?window.controls&&(window.controls.noRotate=!0,window.controls.noZoom=!0,window.controls.noPan=!0):s.controls&&(s.controls.noRotate=!0,s.controls.noZoom=!0,s.controls.noPan=!0)})),$(document).on("click",".icn3d-expand",(function(t){e.icn3d,t.stopImmediatePropagation();let s=$(this).attr("id"),i=s.lastIndexOf("_"),l=s.substr(0,i);$("#"+l).show(),$("#"+l+"_expand").hide(),$("#"+l+"_shrink").show()})),$(document).on("click",".icn3d-shrink",(function(t){e.icn3d,t.stopImmediatePropagation();let s=$(this).attr("id"),i=s.lastIndexOf("_"),l=s.substr(0,i);$("#"+l).hide(),$("#"+l+"_expand").show(),$("#"+l+"_shrink").hide()})),window.onscroll=function(t){let s=e.icn3d;"detailed view"==s.view&&0==$(window).scrollTop()&&0==$(window).scrollTop()&&0==$("#"+e.pre+"dl_selectannotations").scrollTop()?s.annotationCls.showFixedTitle():s.annotationCls.hideFixedTitle()},e.myEventCls.onIds("#"+e.pre+"dl_selectannotations","scroll",(function(){"detailed view"==t.view&&0==$(window).scrollTop()&&0==$(window).scrollTop()&&0==$("#"+e.pre+"dl_selectannotations").scrollTop()?t.annotationCls.showFixedTitle():t.annotationCls.hideFixedTitle()})),e.myEventCls.onIds("#"+e.pre+"mn6_themeBlue","click",(function(t){e.icn3d,e.htmlCls.setMenuCls.setTheme("blue"),e.htmlCls.clickMenuCls.setLogCmd("set theme blue",!0)})),e.myEventCls.onIds("#"+e.pre+"mn6_themeOrange","click",(function(t){e.icn3d,e.htmlCls.setMenuCls.setTheme("orange"),e.htmlCls.clickMenuCls.setLogCmd("set theme orange",!0)})),e.myEventCls.onIds("#"+e.pre+"mn6_themeBlack","click",(function(t){e.icn3d,e.htmlCls.setMenuCls.setTheme("black"),e.htmlCls.clickMenuCls.setLogCmd("set theme black",!0)})),$(document).on("click","."+e.pre+"snpin3d",(function(t){let s=e.icn3d;t.stopImmediatePropagation();let i=$(this).attr("snp");s.scapCls.retrieveScap(i),e.htmlCls.clickMenuCls.setLogCmd("scap 3d "+i,!0),e.htmlCls.clickMenuCls.setLogCmd("select displayed set",!0)})),$(document).on("click","."+e.pre+"snpinter",(function(t){let s=e.icn3d;t.stopImmediatePropagation();let i=$(this).attr("snp");s.scapCls.retrieveScap(i,!0),e.htmlCls.clickMenuCls.setLogCmd("scap interaction "+i,!0);let l=i.split("_"),n="."+l[1]+":"+l[2],o="snp_"+l[1]+"_"+l[2];e.htmlCls.clickMenuCls.setLogCmd("select "+n+" | name "+o,!0),e.htmlCls.clickMenuCls.setLogCmd("line graph interaction pairs | selected non-selected | hbonds,salt bridge,interactions,halogen,pi-cation,pi-stacking | false | threshold 3.8 6 4 3.8 6 5.5",!0),e.htmlCls.clickMenuCls.setLogCmd("adjust dialog dl_linegraph",!0),e.htmlCls.clickMenuCls.setLogCmd("select displayed set",!0)})),$(document).on("click","."+e.pre+"snppdb",(function(t){let s=e.icn3d;t.stopImmediatePropagation();let i=$(this).attr("snp");s.scapCls.retrieveScap(i,void 0,!0),e.htmlCls.clickMenuCls.setLogCmd("scap pdb "+i,!0)}))}}class st{constructor(e){this.icn3dui=e}getAlignSequencesAnnotations(e,t,s,i,l,n){let o=this.icn3dui,r=o.icn3d,a="";e=Object.keys(r.alnChains),n&&(e=e.reverse());let d=0,c={};if(void 0!==e)for(let t=0,s=e.length;t<s;++t)c[e[t]]=1;let h,m=void 0===t||t;m&&(r.hAtoms={});let p,u,C=0,g=0;for(let t=0,n=e.length;t<n;++t){let n=e[t];0==C&&(p=n),u=l&&C>0?p:n,m&&(r.hAtoms=o.hashUtilsCls.unionHash(r.hAtoms,r.alnChains[n]));let f=[],b="",y=void 0!==r.alnChainsSeq[n]?r.alnChainsSeq[n].length:0;y>d&&(d=y);let v=u.indexOf("_"),w=u.substr(0,v),S=u.substr(v+1);b+="<span class='icn3d-residueNum' title='starting residue number'>"+(void 0!==r.alnChainsSeq[n][0]?r.alnChainsSeq[n][0].resi:"")+"</span>",h=!(void 0===e||!c.hasOwnProperty(u));for(let e=0,t=y;e<t;++e){let t="N/A",a="";""===r.alnChainsSeq[n][e].resi||isNaN(r.alnChainsSeq[n][e].resi)||(t=r.alnChainsSeq[n][e].resi,a=w+"_"+S+"_"+t,r.alnChainsSeq[n][e].color);let d,c="class='icn3d-residue";if((void 0===i||i)&&(h||void 0!==s&&""!==a&&-1!==s.indexOf(a))&&(c="class='icn3d-residue icn3d-highlightSeq"),c+=""===a?"'":" "+r.alnChainsSeq[n][e].class+"'",r.residues.hasOwnProperty(a)){let e=r.firstAtomObjCls.getFirstCalphaAtomObj(r.residues[a]);d=void 0!==e.color?"#"+e.color.getHexString()+";":"#000000;"}else d="#000000;";if("#FFFFFF;"===d.toUpperCase()&&(d=o.htmlCls.GREYD),l&&0==e){b+="<span style='width:"+g*10+"px'></span>"}""!==a?-1!=r.alnChainsSeq[n][e].resi?b+="<span id='align_"+o.pre+a+"' "+c+" style='color:"+d+"' title='"+r.alnChainsSeq[n][e].resn+r.alnChainsSeq[n][e].resi+"'>"+r.alnChainsSeq[n][e].resn+"</span>":b+="<span>"+r.alnChainsSeq[n][e].resn+"</span>":b+="<span title='"+r.alnChainsSeq[n][e].resn+r.alnChainsSeq[n][e].resi+"'>"+r.alnChainsSeq[n][e].resn+"</span>"}b+="<span class='icn3d-residueNum' title='ending residue number'>"+(void 0!==r.alnChainsSeq[n][y-1]?r.alnChainsSeq[n][y-1].resi:"")+"</span>";let _=void 0!==r.alnChainsAnno[n]?r.alnChainsAnno[n].length:0;for(let e=0,t=_;e<t;++e){f[e]="";let t=0==e&&_>=7?r.alnChainsAnTtl[n][4][0]:u;f[e]+="<span class='icn3d-residueNum'></span>";for(let s=0,i=r.alnChainsAnno[n][e].length;s<i;++s){let i=r.alnChainsAnno[n][e][s];if("H"==i||"E"==i||"c"==i||"o"==i)if("H"==i)f[e]+=s%2==0?'<span class="icn3d-helix">&nbsp;</span>':'<span class="icn3d-helix2">&nbsp;</span>';else if("E"==i){if(void 0!==r.alnChainsSeq[t][s]){let i=t+"_"+r.alnChainsSeq[t][s].resi;if(r.residues.hasOwnProperty(i)){r.firstAtomObjCls.getFirstCalphaAtomObj(r.residues[i]).ssend?f[e]+='<span class="icn3d-sheet2">&nbsp;</span>':f[e]+='<span class="icn3d-sheet">&nbsp;</span>'}}}else f[e]+="c"==i?'<span class="icn3d-coil">&nbsp;</span>':"o"==i?'<span class="icn3d-other">&nbsp;</span>':"<span></span>";else f[e]+="<span>"+i+"</span>"}f[e]+="<span class='icn3d-residueNum'></span>"}let A=n,x=void 0!==r.pdbid_chain2title?r.pdbid_chain2title[u]:"";for(let e=_-1;e>=0;--e){let t=r.alnChainsAnTtl[n][e][0];"SS"==t&&(t=""),a+="<div class='icn3d-residueLine' style='white-space:nowrap;'><div class='icn3d-seqTitle' anno='"+e+"'>"+t+"</div>"+f[e]+"<br/></div>"}a+='<div class="icn3d-seqTitle icn3d-link icn3d-blue" chain="'+n+'" anno="sequence" title="'+x+'">'+A+' </div><span class="icn3d-seqLine">'+b+"</span><br/>",C>0&&(g+=y),++C}return{sequencesHtml:a,maxSeqCnt:d}}}class it{constructor(e){this.icn3dui=e}getLink(e,t){let s=this.icn3dui;return s.icn3d,"<li><span id='"+s.pre+e+"' class='icn3d-link'>"+t+"</span></li>"}getLinkWrapper(e,t,s){let i=this.icn3dui;return i.icn3d,"<li id='"+i.pre+s+"'><span id='"+i.pre+e+"' class='icn3d-link'>"+t+"</span></li>"}getRadio(e,t,s,i){let l=this.icn3dui;l.icn3d;let n=i?" checked":"";return"<li><label for='"+l.pre+t+"' class='icn3d-rad'>"+l.htmlCls.inputRadioStr+"name='"+l.pre+e+"' class='"+l.pre+e+"' v='"+s+"' id='"+l.pre+t+"'"+n+"><span class='ui-icon ui-icon-blank'></span> <span class='icn3d-rad-text'>"+s+"</span></label></li>"}getRadioColor(e,t,s,i,l){let n=this.icn3dui;n.icn3d;let o=l?" checked":"";return"<li><label for='"+n.pre+t+"' class='icn3d-rad'>"+n.htmlCls.inputRadioStr+"name='"+n.pre+e+"' id='"+n.pre+t+"'"+o+"><span class='ui-icon ui-icon-blank'></span> <span class='icn3d-color-rad-text' color='"+i+"'><span style='background-color:#"+i+"'>"+n.htmlCls.space3+"</span> "+s+"</span></label></li>"}setAdvanced(e){let t=this.icn3dui;t.icn3d;let s=void 0===e?"":e,i=t.cfg.notebook?"icn3d-hidden":"",l=t.htmlCls.divStr+"dl_advanced"+s+"' class='"+i+"'>";return l+="<table width='500'><tr><td valign='top'><table cellspacing='0'>",l+="<tr><td><b>Select:</b></td><td>"+t.htmlCls.inputTextStr+"id='"+t.pre+"command"+s+"' placeholder='$[structures].[chains]:[residues]@[atoms]' size='60'></td></tr>",l+="<tr><td><b>Name:</b></td><td>"+t.htmlCls.inputTextStr+"id='"+t.pre+"command_name"+s+"' placeholder='my_selection' size='60'></td></tr>",l+="<tr><td colspan='2' align='left'>"+t.htmlCls.space3+t.htmlCls.buttonStr+"command_apply"+s+"'><b>Save Selection to Defined Sets</b></button></td></tr>",l+="</table></td>",l+="</tr>",l+="<tr><td>",l+='Specification Tips: <div style="width:20px; margin-top:6px; display:inline-block;"><span id="'+t.pre+"specguide"+s+'_expand" class="ui-icon ui-icon-plus icn3d-expand icn3d-link" style="width:15px;" title="Expand"></span><span id="'+t.pre+"specguide"+s+'_shrink" class="ui-icon ui-icon-minus icn3d-shrink icn3d-link" style="display:none; width:15px;" title="Shrink"></span></div><br>',l+=t.htmlCls.divStr+"specguide"+s+"' style='display:none; width:500px' class='icn3d-box'>",l+='<b>Specification:</b> In the selection "$1HHO,4N7N.A,B,C:5-10,LV,3AlaVal,chemicals@CA,C":',l+='<ul><li>"$1HHO,4N7N" uses "$" to indicate structure selection.<br/>',l+='<li>".A,B,C" uses "." to indicate chain selection.<br/>',l+='<li>":5-10,LV,3LeuVal,chemicals" uses the colon ":" to indicate residue selection. Residue selection could be residue number(5-10), one-letter IUPAC residue name abbreviations(LV), three-letter residue names(AlaVal, "3" indicates each residue name has three letters), or predefined names: "proteins", "nucleotides", "chemicals", "ions", and "water". IUPAC abbreviations can be written either as a contiguous string(e.g., ":LV"), in order to find all instances of that sequence in the structure, or they can be separated by commas(e.g., ":L,V") to select all residues of a given type in the structure(in the latter case, select all Leucine and Valine in the structure).<br/>',l+='<li>"@CA,C" uses "@" to indicate atom selection.<br/>',l+='<li>Partial definition is allowed, e.g., ":1-10" selects all residue IDs 1-10 in all chains.<br/>',l+='<li>Different selections can be unioned(with "<b>or</b>", default), intersected(with "<b>and</b>"), or negated(with "<b>not</b>"). For example, ":1-10 or :K" selects all residues 1-10 and all Lys residues. ":1-10 and :K" selects all Lys residues in the range of residue number 1-10. ":1-10 or not :K" selects all residues 1-10, which are not Lys residues.<br/>',l+='<li>The wild card character "X" or "x" can be used to represent any character.',l+="</ul>",l+="<b>Set Operation:</b>",l+='<ul><li>Users can select multiple sets in the menu "Select > Defined Sets".<br/>',l+='<li>Different sets can be unioned(with "<b>or</b>", default), intersected(with "<b>and</b>"), or negated(with "<b>not</b>"). For example, if the "Defined Sets" menu has four sets ":1-10", ":11-20", ":5-15", and ":7-8", the command "saved atoms :1-10 or :11-20 and :5-15 not :7-8" unions all residues 1-10 and 11-20 to get the residues 1-20, then intersects with the residues 5-15 to get the residues 5-15, then exclude the residues 7-8 to get the final residues 5-6 and 9-15.</ul>',l+="<b>Full commands in url or command window:</b>",l+="<ul><li>Select without saving the set: select $1HHO,4N7N.A,B,C:5-10,LV,chemicals@CA,C<br/>",l+="<li>Select and save: select $1HHO,4N7N.A,B,C:5-10,LV,chemicals@CA,C | name my_name</ul>",l+="</div>",l+="</td></tr></table>",l+="</div>",l}getOptionHtml(e,t){let s=this.icn3dui;s.icn3d;let i="";for(let l=0,n=e.length;l<n;++l){let n=e[l];i+=l==t?s.htmlCls.optionStr+"'"+n+"' selected>"+n+"</option>":s.htmlCls.optionStr+"'"+n+"'>"+n+"</option>"}return i}setColorHints(){let e=this.icn3dui;e.icn3d;let t="";return t+=e.htmlCls.divNowrapStr+'<span style="margin-left:33px; color:#00FF00; font-weight:bold">Green</span>: H-Bonds; ',t+='<span style="color:#00FFFF; font-weight:bold">Cyan</span>: Salt Bridge/Ionic; ',t+='<span style="font-weight:bold">Grey</span>: contacts</div>',t+=e.htmlCls.divNowrapStr+'<span style="margin-left:33px; color:#FF00FF; font-weight:bold">Magenta</span>: Halogen Bonds; ',t+='<span style="color:#FF0000; font-weight:bold">Red</span>: &pi;-Cation; ',t+='<span style="color:#0000FF; font-weight:bold">Blue</span>: &pi;-Stacking</div>',t}setThicknessHtml(e){let t=this.icn3dui;t.icn3d;let s="",i="3dprint"==e?"1":"0.1",l="3dprint"==e?"1.2":"0.3",n="3dprint"==e?"0.8":"0.4",o="3dprint"==e?"1":"0.2",r="3dprint"==e?"0.6":"0.3",a="3dprint"==e?"1":"0.2",d="3dprint"==e?"2":"1.3",c="3dprint"==e?"1.4":"0.8",h=40,m=.6,p=.4,u=.2,C=0;return"style"==e&&(""!=this.getCookie("shininess")&&(h=parseFloat(this.getCookie("shininess"))),""!=this.getCookie("light1")&&(m=parseFloat(this.getCookie("light1")),p=parseFloat(this.getCookie("light2")),u=parseFloat(this.getCookie("light3"))),""!=this.getCookie("lineRadius")&&(i=parseFloat(this.getCookie("lineRadius")),l=parseFloat(this.getCookie("coilWidth")),n=parseFloat(this.getCookie("cylinderRadius")),o=parseFloat(this.getCookie("traceRadius")),r=parseFloat(this.getCookie("dotSphereScale")),a=parseFloat(this.getCookie("ribbonthickness")),d=parseFloat(this.getCookie("helixSheetWidth")),c=parseFloat(this.getCookie("nucleicAcidWidth"))),""!=this.getCookie("glycan")&&(C=parseFloat(this.getCookie("glycan"))),s+="<b>Note</b>: The following parameters will be saved in cache. You just need to set them once. <br><br>",s+="<b>1. Shininess</b>: "+t.htmlCls.inputTextStr+"id='"+t.pre+"shininess' value='"+h+"' size=4>"+t.htmlCls.space3+"(for the shininess of the 3D objects, default 40)<br/><br/>",s+="<b>2. Three directional lights</b>: <br>",s+="<b>Key Light</b>: "+t.htmlCls.inputTextStr+"id='"+t.pre+"light1' value='"+m+"' size=4>"+t.htmlCls.space3+"(for the light strength of the key light, default 0.6)<br/>",s+="<b>Fill Light</b>: "+t.htmlCls.inputTextStr+"id='"+t.pre+"light2' value='"+p+"' size=4>"+t.htmlCls.space3+"(for the light strength of the fill light, default 0.4)<br/>",s+="<b>Back Light</b>: "+t.htmlCls.inputTextStr+"id='"+t.pre+"light3' value='"+u+"' size=4>"+t.htmlCls.space3+"(for the light strength of the back light, default 0.2)<br/><br/>",s+="<b>3. Thickness</b>: <br>"),s+="<b>Line Radius</b>: "+t.htmlCls.inputTextStr+"id='"+t.pre+"linerad_"+e+"' value='"+i+"' size=4>"+t.htmlCls.space3+"(for stabilizers, hydrogen bonds, distance lines, default 0.1)<br/>",s+="<b>Coil Radius</b>: "+t.htmlCls.inputTextStr+"id='"+t.pre+"coilrad_"+e+"' value='"+l+"' size=4>"+t.htmlCls.space3+"(for coils, default 0.3)<br/>",s+="<b>Stick Radius</b>: "+t.htmlCls.inputTextStr+"id='"+t.pre+"stickrad_"+e+"' value='"+n+"' size=4>"+t.htmlCls.space3+"(for sticks, default 0.4)<br/>",s+="<b>Trace Radius</b>: "+t.htmlCls.inputTextStr+"id='"+t.pre+"tracerad_"+e+"' value='"+o+"' size=4>"+t.htmlCls.space3+"(for C alpha trace, O3' trace, default 0.2)<br/>",s+="<b>Ribbon Thickness</b>: "+t.htmlCls.inputTextStr+"id='"+t.pre+"ribbonthick_"+e+"' value='"+a+"' size=4>"+t.htmlCls.space3+"(for helix and sheet ribbons, nucleotide ribbons, default 0.2)<br/>",s+="<b>Protein Ribbon Width</b>: "+t.htmlCls.inputTextStr+"id='"+t.pre+"prtribbonwidth_"+e+"' value='"+d+"' size=4>"+t.htmlCls.space3+"(for helix and sheet ribbons, default 1.3)<br/>",s+="<b>Nucleotide Ribbon Width</b>: "+t.htmlCls.inputTextStr+"id='"+t.pre+"nucleotideribbonwidth_"+e+"' value='"+c+"' size=4>"+t.htmlCls.space3+"(for nucleotide ribbons, default 0.8)<br/>",s+="<b>Ball Scale</b>: "+t.htmlCls.inputTextStr+"id='"+t.pre+"ballscale_"+e+"' value='"+r+"' size=4>"+t.htmlCls.space3+"(for styles 'Ball and Stick' and 'Dot', default 0.3)<br/>","style"==e&&(s+="<br><b>4. Show Glycan Cartoon</b>: "+t.htmlCls.inputTextStr+"id='"+t.pre+"glycan' value='"+C+"' size=4>"+t.htmlCls.space3+"(0: hide, 1: show, default 0)<br/><br/>"),s+=t.htmlCls.spanNowrapStr+""+t.htmlCls.buttonStr+"apply_thickness_"+e+"'>Apply</button></span>&nbsp;&nbsp;&nbsp;",s+=t.htmlCls.spanNowrapStr+""+t.htmlCls.buttonStr+"reset_thickness_"+e+"'>Reset</button></span>",s}getCookie(e){let t=e+"=",s=decodeURIComponent(document.cookie).split(";");for(let e=0;e<s.length;e++){let i=s[e];for(;" "==i.charAt(0);)i=i.substring(1);if(0==i.indexOf(t))return i.substring(t.length,i.length)}return""}setSequenceGuide(e,t){let s=this.icn3dui,i=s.icn3d,l="",n=i&&i.defNames2Atoms?Object.keys(i.defNames2Atoms).length:1;t?l+=s.htmlCls.divStr+"seqguide"+e+"'>":(l+='<div style="width:20px; margin-left:3px; display:inline-block;"><span id="'+s.pre+"seqguide"+e+'_expand" class="ui-icon ui-icon-plus icn3d-expand icn3d-link" style="width:15px;" title="Expand"></span><span id="'+s.pre+"seqguide"+e+'_shrink" class="ui-icon ui-icon-minus icn3d-shrink icn3d-link" style="display:none; width:15px;" title="Shrink"></span></div> ',l+="<div style='min-width:200px; display:inline-block;'><b>Selection:</b> Name: "+s.htmlCls.inputTextStr+"id='"+s.pre+"seq_command_name"+e+"' value='seq_"+n+"' size='5'> "+s.htmlCls.space2+"<button style='white-space:nowrap;' id='"+s.pre+"seq_saveselection"+e+"'>Save</button> <button style='white-space:nowrap; margin-left:20px;' id='"+s.pre+"seq_clearselection"+e+"'>Clear</button></div><br/>",l+=s.htmlCls.divStr+"seqguide"+e+"' style='display:none; white-space:normal;' class='icn3d-box'>"),l+=this.getSelectionHints();return l+="<b>Residue labeling:</b> standard residue with coordinates: UPPER case letter; nonstandard residue with coordinates: the first UPPER case letter plus a period except that water residue uses the letter 'O'; residue missing coordinates: lower case letter."+(s.utilsCls.isMac()&&!s.utilsCls.isMobile()?"<br/><br/><b>Turn on scroll bar:</b> System preferences -> General -> show scroll bars -> check Always":"")+"<br/></div>",l}setAlignSequenceGuide(e,t){let s=this.icn3dui,i=s.icn3d,l="";let n=i&&i.defNames2Atoms?Object.keys(i.defNames2Atoms).length:1;l+='<div style="width:20px; margin-left:3px; display:inline-block;"><span id="'+s.pre+'alignseqguide_expand" class="ui-icon ui-icon-plus icn3d-expand icn3d-link" style="width:15px;" title="Expand"></span><span id="'+s.pre+'alignseqguide_shrink" class="ui-icon ui-icon-minus icn3d-shrink icn3d-link" style="display:none; width:15px;" title="Shrink"></span></div> ',l+="<div style='min-width:200px; display:inline-block;''><b>Selection:</b> Name: "+s.htmlCls.inputTextStr+"id='"+s.pre+"alignseq_command_name' value='alseq_"+n+"' size='10'> "+s.htmlCls.space2+"<button style='white-space:nowrap;' id='"+s.pre+"alignseq_saveselection'>Save</button> <button style='white-space:nowrap; margin-left:20px;' id='"+s.pre+"alignseq_clearselection'>Clear</button></div><br/>",l+=s.htmlCls.divStr+"alignseqguide' style='display:none; white-space:normal;' class='icn3d-box'>",l+=this.getSelectionHints();return l+="<b>Residue labeling:</b> aligned residue with coordinates: UPPER case letter; non-aligned residue with coordinates: lower case letter which can be highlighted; residue missing coordinates: lower case letter which can NOT be highlighted."+(s.utilsCls.isMac()&&!s.utilsCls.isMobile()?"<br/><br/><b>Turn on scroll bar:</b> System preferences -> General -> show scroll bars -> check Always":"")+"<br/></div>",l}getSelectionHints(){let e=this.icn3dui;e.icn3d;let t="";if(e.utilsCls.isMobile())t+='<b>Select Aligned Sequences:</b> touch to select, touch again to deselect, multiple selection is allowed without Ctrl key, click "Save Selection" to save the current selection.<br/>';else{t+='<b>Select on 1D sequences:</b> drag to select, drag again to deselect, multiple selection is allowed without Ctrl key, click "Save Selection" to save the current selection.<br/><br/>',t+="<b>Select on 2D interaction diagram:</b> click on the nodes or lines. The nodes are chains and can be united with the Ctrl key. The lines are interactions and can NOT be united. Each click on the lines selects half of the lines, i.e., select the interacting residues in one of the two chains.<br/><br/>",t+="<b>Select on 3D structures:</b> "+(e.utilsCls.isMobile()?"use finger to pick":'hold "Alt" and use mouse to pick')+', click the second time to deselect, hold "Ctrl" to union selection, hold "Shift" to select a range, press the up/down arrow to switch among atom/residue/strand/chain/structure, click "Save Selection" to save the current selection.<br/><br/>',t+='<b>Save the current selection</b>(either on 3D structure, 2D interactions, or 1D sequence): open the menu "Select -> Save Selection", specify the name and description for the selection, and click "Save".<br/><br/>'}return t}addGsizeSalt(e){let t=this.icn3dui;t.icn3d;let s="";s+="<span style='white-space:nowrap;font-weight:bold;'>Grid Size: <select id='"+t.pre+e+"gsize'>";s+=this.getOptionHtml(["65","97","129"],0),s+="</select></span>",s+="<span style='white-space:nowrap;font-weight:bold;margin-left:30px;'>Salt Concentration: <select id='"+t.pre+e+"salt'>";return s+=this.getOptionHtml(["0","0.15"],1),s+="</select> M</span><br/>",s}getFootHtml(e,t){let s=this.icn3dui;s.icn3d;let i="<div style='width:500px;'>";return"delphi"==e?s.cfg.cid?i+="<b>Note</b>: Partial charges(MMFF94) are from PubChem Compound SDF files.<br/><br/>":(i+="<b>Note</b>: Only the selected residues are used for <a href='http://honig.c2b2.columbia.edu/delphi'>DelPhi</a> potential calculation by solving linear Poisson-Boltzmann equation.",i+='<div style="width:20px; margin-top:6px; display:inline-block;"><span id="'+s.pre+t+'_expand" class="ui-icon ui-icon-plus icn3d-expand icn3d-link" style="width:15px;" title="Expand"></span><span id="'+s.pre+t+'_shrink" class="ui-icon ui-icon-minus icn3d-shrink icn3d-link" style="display:none; width:15px;" title="Shrink"></span></div><br>',i+=s.htmlCls.divStr+t+"' style='display:none;'>",i+="<br>The hydrogens and partial charges of proteins and nucleotides are added using <a href='http://compbio.clemson.edu/pka_webserver'>DelPhiPKa</a> with the Amber charge and size files. The hydrogens of ligands are added using <a href='http://openbabel.org/wiki/Main_Page'>Open Babel</a>. The partial charges of ligands are calculated using <a href='http://ambermd.org/antechamber/ac.html'>Antechamber</a> with the Gasteiger charge method. All partial charges are calculated at pH 7.<br/><br/>",i+='Lipids are treated as ligands. Please use "HETATM" instead of "ATOM  " for each lipid atom in your PDB file. Each phosphate in lipids is assigned with a charge of -1. You can download PQR and modify it, or prepare your PQR file using other tools. Then load the PQR file at the menu "Analysis > Load PQR/Potential".<br/><br/>',i+="</div>"):(i+="<b>Note</b>: Always load a PDB file before loading a PQR or DelPhi potential file.",i+='<div style="width:20px; margin-top:6px; display:inline-block;"><span id="'+s.pre+t+'_expand" class="ui-icon ui-icon-plus icn3d-expand icn3d-link" style="width:15px;" title="Expand"></span><span id="'+s.pre+t+'_shrink" class="ui-icon ui-icon-minus icn3d-shrink icn3d-link" style="display:none; width:15px;" title="Shrink"></span></div><br>',i+=s.htmlCls.divStr+t+"' style='display:none;'>",i+='The PDB file can be loaded in the URL with "pdbid=" or at "File > Open File". The PQR file can be prepared at the menu "Analysis > Download PQR" with your modification or using other tools. The DelPhi potential file can be calculated at <a href=\'http://compbio.clemson.edu/sapp/delphi_webserver/\'>DelPhi Web Server</a> and be exported as a Cube file. ',"url"==e&&(i+="The PQR or potential file can be accessed in a URL if it is located in the same host as iCn3D."),i+="<br/><br/>",i+="</div>"),i+="</div>",i}getPotentialHtml(e,t){let s=this.icn3dui;s.icn3d;let i,l,n,o,r,a="";o="Equipotential Map",r="Surface with Potential","delphi"==e?l="delphi":"local"==e?(i="pqr",l="phi",n="cube"):"url"==e&&(i="pqrurl",l="phiurl",n="cubeurl"),a+=s.htmlCls.divStr+"dl_"+l+"' class='"+t+"'>",a+=s.htmlCls.divStr+"dl_"+l+"_tabs' style='border:0px;'>",a+="<ul>",a+="<li><a href='#"+s.pre+l+"tab1'>Equipotential Map</a></li>",a+="<li><a href='#"+s.pre+l+"tab2'>Surface with Potential</a></li>",a+="</ul>",a+=s.htmlCls.divStr+l+"tab1'>","delphi"==e&&(a+=this.addGsizeSalt(l)+"<br>"),a+="<span style='white-space:nowrap;font-weight:bold;'>Potential contour at: <select id='"+s.pre+l+"contour'>";let d;a+=this.getOptionHtml(["0.5","1","2","4","6","8","10"],1),a+="</select> kT/e(25.6mV at 298K)</span><br/><br/>","delphi"==e?(a+=s.htmlCls.buttonStr+"reload_"+l+"file' style='margin-top: 6px;'>Equipotential Map</button>",a+=s.htmlCls.buttonStr+l+"mapNo' style='margin-left:30px;'>Remove Map</button><br>"):"local"==e?(a+=s.htmlCls.divStr+l+"tab1_tabs' style='border:0px;'>",a+="<ul>",a+="<li><a href='#"+s.pre+l+"tab1_"+i+"'>PQR</a></li>",a+="<li><a href='#"+s.pre+l+"tab1_"+l+"'>Phi</a></li>",a+="<li><a href='#"+s.pre+l+"tab1_"+n+"'>Cube</a></li>",a+="</ul>",d="<span style='margin-left:30px'>"+s.htmlCls.buttonStr+l+"mapNo'>Remove Map</button></span></div>",a+=s.htmlCls.divStr+l+"tab1_"+i+"'>",a+=this.addGsizeSalt(i)+"<br>",a+="<b>PQR File</b>: "+s.htmlCls.inputFileStr+"id='"+s.pre+i+"file'> <br><br>"+s.htmlCls.buttonStr+"reload_"+i+"file' style='margin-top: 6px;'>Equipotential Map</button>"+d,a+=s.htmlCls.divStr+l+"tab1_"+l+"'>",a+="<b>Phi File</b>: "+s.htmlCls.inputFileStr+"id='"+s.pre+l+"file'> <br><br>"+s.htmlCls.buttonStr+"reload_"+l+"file' style='margin-top: 6px;'>Equipotential Map</button>"+d,a+=s.htmlCls.divStr+l+"tab1_"+n+"'>",a+="<b>Cube File</b>: "+s.htmlCls.inputFileStr+"id='"+s.pre+n+"file'> <br><br>"+s.htmlCls.buttonStr+"reload_"+n+"file' style='margin-top: 6px;'>Equipotential Map</button>"+d,a+="</div>"):"url"==e&&(a+=s.htmlCls.divStr+l+"tab1_tabs' style='border:0px;'>",a+="<ul>",a+="<li><a href='#"+s.pre+l+"tab1_"+i+"2'>PQR</a></li>",a+="<li><a href='#"+s.pre+l+"tab1_"+l+"2'>Phi</a></li>",a+="<li><a href='#"+s.pre+l+"tab1_"+n+"2'>Cube</a></li>",a+="</ul>",d="<span style='margin-left:30px'>"+s.htmlCls.buttonStr+l+"mapNo'>Remove Map</button></span></div>",a+=s.htmlCls.divStr+l+"tab1_"+i+"2'>",a+=this.addGsizeSalt(i)+"<br>",a+="<b>PQR URL</b> in the same host: "+s.htmlCls.inputTextStr+"id='"+s.pre+i+"file'> <br><br>"+s.htmlCls.buttonStr+"reload_"+i+"file' style='margin-top: 6px;'>Equipotential Map</button>"+d,a+=s.htmlCls.divStr+l+"tab1_"+l+"2'>",a+="<b>Phi URL</b> in the same host: "+s.htmlCls.inputTextStr+"id='"+s.pre+l+"file'> <br><br>"+s.htmlCls.buttonStr+"reload_"+l+"file' style='margin-top: 6px;'>Equipotential Map</button>"+d,a+=s.htmlCls.divStr+l+"tab1_"+n+"2'>",a+="<b>Cube URL</b> in the same host: "+s.htmlCls.inputTextStr+"id='"+s.pre+n+"file'> <br><br>"+s.htmlCls.buttonStr+"reload_"+n+"file' style='margin-top: 6px;'>Equipotential Map</button>"+d,a+="</div>"),a+="<br>"+this.getFootHtml(e,l+"tab1_foot"),a+="</div>",a+=s.htmlCls.divStr+l+"tab2'>","delphi"==e&&(a+=this.addGsizeSalt(l)+"<br>"),a+="<span style='white-space:nowrap;font-weight:bold;'>Surface with max potential at: <select id='"+s.pre+l+"contour2'>";a+=this.getOptionHtml(["1","2","3","4","5","6","7","8","9","10"],2),a+="</select> kT/e(25.6mV at 298K)</span><br/><br/>",a+="<b>Surface</b>: <select id='"+s.pre+l+"surftype'>",a+="<option value='21'>Van der Waals</option>",a+="<option value='22' selected>Molecular Surface</option>",a+="<option value='23'>Solvent Accessible</option>",a+="</select>",a+="<span style='margin-left:20px'><b>Opacity</b>: <select id='"+s.pre+l+"surfop'>";return a+=this.getOptionHtml(["1.0","0.9","0.8","0.7","0.6","0.5","0.4","0.3","0.2","0.1"],0),a+="</select></span>",a+="<span style='margin-left:20px'><b>Wireframe</b>: <select id='"+s.pre+l+"surfwf'>",a+="<option value='yes'>Yes</option>",a+="<option value='no' selected>No</option>",a+="</select></span><br/>",a+="<br/>","delphi"==e?(a+=s.htmlCls.buttonStr+"reload_"+l+"file2' style='margin-top: 6px;'>Surface with Potential</button>",a+=s.htmlCls.buttonStr+l+"mapNo2' style='margin-left:30px;'>Remove Surface</button><br>"):"local"==e?(a+=s.htmlCls.divStr+l+"tab2_tabs' style='border:0px;'>",a+="<ul>",a+="<li><a href='#"+s.pre+l+"tab2_"+i+"'>PQR</a></li>",a+="<li><a href='#"+s.pre+l+"tab2_"+l+"'>Phi</a></li>",a+="<li><a href='#"+s.pre+l+"tab2_"+n+"'>Cube</a></li>",a+="</ul>",d="<span style='margin-left:30px'>"+s.htmlCls.buttonStr+l+"mapNo2'>Remove Surface</button></span></div>",a+=s.htmlCls.divStr+l+"tab2_"+i+"'>",a+=this.addGsizeSalt(i+"2")+"<br>",a+="<b>PQR File</b>: "+s.htmlCls.inputFileStr+"id='"+s.pre+i+"file2'> <br><br>"+s.htmlCls.buttonStr+"reload_"+i+"file2' style='margin-top: 6px;'>Surface with Potential</button>"+d,a+=s.htmlCls.divStr+l+"tab2_"+l+"'>",a+="<b>Phi File</b>: "+s.htmlCls.inputFileStr+"id='"+s.pre+l+"file2'> <br><br>"+s.htmlCls.buttonStr+"reload_"+l+"file2' style='margin-top: 6px;'>Surface with Potential</button>"+d,a+=s.htmlCls.divStr+l+"tab2_"+n+"'>",a+="<b>Cube File</b>: "+s.htmlCls.inputFileStr+"id='"+s.pre+n+"file2'> <br><br>"+s.htmlCls.buttonStr+"reload_"+n+"file2' style='margin-top: 6px;'>Surface with Potential</button>"+d,a+="</div>"):"url"==e&&(a+=s.htmlCls.divStr+l+"tab2_tabs' style='border:0px;'>",a+="<ul>",a+="<li><a href='#"+s.pre+l+"tab2_"+i+"2'>PQR</a></li>",a+="<li><a href='#"+s.pre+l+"tab2_"+l+"2'>Phi</a></li>",a+="<li><a href='#"+s.pre+l+"tab2_"+n+"2'>Cube</a></li>",a+="</ul>",d="<span style='margin-left:30px'>"+s.htmlCls.buttonStr+l+"mapNo2'>Remove Surface</button></span></div>",a+=s.htmlCls.divStr+l+"tab2_"+i+"2'>",a+=this.addGsizeSalt(i+"2")+"<br>",a+="<b>PQR URL</b> in the same host: "+s.htmlCls.inputTextStr+"id='"+s.pre+i+"file2'> <br><br>"+s.htmlCls.buttonStr+"reload_"+i+"file2' style='margin-top: 6px;'>Surface with Potential</button>"+d,a+=s.htmlCls.divStr+l+"tab2_"+l+"2'>",a+="<b>Phi URL</b> in the same host: "+s.htmlCls.inputTextStr+"id='"+s.pre+l+"file2'> <br><br>"+s.htmlCls.buttonStr+"reload_"+l+"file2' style='margin-top: 6px;'>Surface with Potential</button>"+d,a+=s.htmlCls.divStr+l+"tab2_"+n+"2'>",a+="<b>Cube URL</b> in the same host: "+s.htmlCls.inputTextStr+"id='"+s.pre+n+"file2'> <br><br>"+s.htmlCls.buttonStr+"reload_"+n+"file2' style='margin-top: 6px;'>Surface with Potential</button>"+d,a+="</div>"),a+="<br>"+this.getFootHtml(e,l+"tab2_foot"),a+="</div>",a+="</div>",a+="</div>",a}exportPqr(){let e=this.icn3dui,t=e.icn3d,s={},i={},l=e.hashUtilsCls.intHash(t.dAtoms,t.hAtoms);for(let e in l)t.atoms[e],t.ions.hasOwnProperty(e)?s[e]=1:i[e]=1;if(e.cfg.cid){let e="";e+=t.saveFileCls.getPDBHeader(),e+=t.saveFileCls.getAtomPDB(i,!0)+t.saveFileCls.getAtomPDB(s,!0);let l=t.inputid?t.inputid:"custom";t.saveFileCls.saveFile(l+"_icn3d.pqr","text",[e])}else{if(e.utilsCls.isCalphaPhosOnly(e.hashUtilsCls.hash2Atoms(i,t.atoms)))return void alert("The potential will not be shown because the side chains are missing in the structure...");let l="";l+=t.saveFileCls.getPDBHeader(),l+=t.saveFileCls.getAtomPDB(i),l+=t.saveFileCls.getAtomPDB(s,!0);let n="https://www.ncbi.nlm.nih.gov/Structure/delphi/delphi.fcgi",o=e.cfg.cid?e.cfg.cid:Object.keys(t.structures).toString();$.ajax({url:n,type:"POST",data:{pdb2pqr:l,pdbid:o},dataType:"text",cache:!0,tryCount:0,retryLimit:0,beforeSend:function(){t.ParserUtilsCls.showLoading()},complete:function(){t.ParserUtilsCls.hideLoading()},success:function(e){let s=e,i=t.inputid?t.inputid:"custom";t.saveFileCls.saveFile(i+"_icn3d_residues.pqr","text",[s])},error:function(e,t,s){this.tryCount++,this.tryCount<=this.retryLimit&&$.ajax(this)}})}}clickReload_pngimage(){let e=this.icn3dui;if(e.icn3d,e.bNode)return;let t=this;e.myEventCls.onIds("#"+e.pre+"reload_pngimage","click",(function(s){let i=e.icn3d;s.preventDefault(),e.cfg.notebook||dialog.dialog("close"),e.cfg.notebook?i.resizeCanvasCls.closeDialogs():$(".ui-dialog-content").dialog("close"),i.init();let l=$("#"+e.pre+"pngimage")[0].files[0];if(l){t.fileSupport();let e=new FileReader;e.onload=function(e){let s=e.target.result;t.loadPng(s)},e.readAsText(l)}else alert("Please select a file before clicking 'Load'")}))}loadPng(e){let t=this.icn3dui,s=t.icn3d,i="Share Link: ",l=e.indexOf(i),n="Start of state file======\n",o=e.indexOf(n);if(-1==l&&-1==o)alert('Please load a PNG image saved by clicking "Save Datas > PNG Image" in the Data menu...');else if(-1!=l){let s=e.substr(l+i.length);t.htmlCls.clickMenuCls.setLogCmd("load iCn3D PNG image "+$("#"+t.pre+"pngimage").val(),!1),window.open(s)}else if(-1!=o){let i="Start of data file======\n",l=e.indexOf(i);if(s.bInputfile=-1!=l,s.bInputfile){let t=e.indexOf("End of data file======\n"),r=e.substr(l+i.length,t-l-i.length);s.InputfileData=r;let a="Start of type file======\n",d=e.indexOf(a),c=e.indexOf("End of type file======\n"),h=e.substr(d+a.length,c-d-a.length-1);s.InputfileType=h;let m=e.indexOf("End of state file======\n"),p=e.substr(o+n.length,m-o-n.length);p=decodeURIComponent(p),"pdb"===h?$.when(s.pdbParserCls.loadPdbData(r)).then((function(){s.commands=[],s.optsHistory=[],s.loadScriptCls.loadScript(p,!0)})):("mol2"===h?s.mol2ParserCls.loadMol2Data(r):"sdf"===h?s.sdfParserCls.loadSdfData(r):"xyz"===h?s.xyzParserCls.loadXyzData(r):"mmcif"===h&&s.mmcifParserCls.loadMmcifData(r),s.commands=[],s.optsHistory=[],s.loadScriptCls.loadScript(p,!0))}else{let t=e.indexOf("End of state file======\n"),i=e.substr(o+n.length,t-o-n.length);i=decodeURIComponent(i),s.commands=[],s.optsHistory=[],s.loadScriptCls.loadScript(i,!0)}t.htmlCls.clickMenuCls.setLogCmd("load iCn3D PNG image "+$("#"+t.pre+"pngimage").val(),!1)}}fileSupport(){window.File&&window.FileReader&&window.FileList&&window.Blob||alert("The File APIs are not fully supported in this browser.")}getLinkColor(){let e="";return e+=", linkmap: {\n",e+='3: {"type": "peptidebond", "c":""},\n',e+='4: {"type": "ssbond", "c":"FFA500"},\n',e+='5: {"type": "ionic", "c":"0FF"},\n',e+='6: {"type": "ionicInside", "c":"FFF"},\n',e+='11: {"type": "contact", "c":"888"},\n',e+='12: {"type": "contactInside", "c":"FFF"},\n',e+='13: {"type": "hbond", "c":"0F0"},\n',e+='14: {"type": "hbondInside", "c":"FFF"},\n',e+='15: {"type": "clbond", "c":"006400"},\n',e+='17: {"type": "halogen", "c":"F0F"},\n',e+='18: {"type": "halogenInside", "c":"FFF"},\n',e+='19: {"type": "pication", "c":"F00"},\n',e+='20: {"type": "picationInside", "c":"FFF"},\n',e+='21: {"type": "pistacking", "c":"00F"},\n',e+='22: {"type": "pistackingInside", "c":"FFF"}\n',e+="}}\n",', linkmap: {\n3: {"type": "peptidebond", "c":""},\n4: {"type": "ssbond", "c":"FFA500"},\n5: {"type": "ionic", "c":"0FF"},\n6: {"type": "ionicInside", "c":"FFF"},\n11: {"type": "contact", "c":"888"},\n12: {"type": "contactInside", "c":"FFF"},\n13: {"type": "hbond", "c":"0F0"},\n14: {"type": "hbondInside", "c":"FFF"},\n15: {"type": "clbond", "c":"006400"},\n17: {"type": "halogen", "c":"F0F"},\n18: {"type": "halogenInside", "c":"FFF"},\n19: {"type": "pication", "c":"F00"},\n20: {"type": "picationInside", "c":"FFF"},\n21: {"type": "pistacking", "c":"00F"},\n22: {"type": "pistackingInside", "c":"FFF"}\n}}\n'}setCookieForThickness(){let e=this.icn3dui,t=e.icn3d;if(!e.bNode){let e=3650;this.setCookie("lineRadius",t.lineRadius,e),this.setCookie("coilWidth",t.coilWidth,e),this.setCookie("cylinderRadius",t.cylinderRadius,e),this.setCookie("traceRadius",t.traceRadius,e),this.setCookie("dotSphereScale",t.dotSphereScale,e),this.setCookie("ribbonthickness",t.ribbonthickness,e),this.setCookie("helixSheetWidth",t.helixSheetWidth,e),this.setCookie("nucleicAcidWidth",t.nucleicAcidWidth,e)}}setLineThickness(e,t){let s=this.icn3dui,i=s.icn3d;if(i.bSetThickness=!0,"style"==e&&(t&&($("#"+s.pre+"shininess").val("40"),$("#"+s.pre+"light1").val("0.6"),$("#"+s.pre+"light2").val("0.4"),$("#"+s.pre+"light3").val("0.2"),$("#"+s.pre+"glycan").val("0")),i.shininess=parseFloat($("#"+s.pre+"shininess").val()),i.light1=parseFloat($("#"+s.pre+"light1").val()),i.light2=parseFloat($("#"+s.pre+"light2").val()),i.light3=parseFloat($("#"+s.pre+"light3").val()),i.bGlycansCartoon=parseInt($("#"+s.pre+"glycan").val())),t&&($("#"+s.pre+"linerad_"+e).val(.1),$("#"+s.pre+"coilrad_"+e).val(.4),$("#"+s.pre+"stickrad_"+e).val(.4),$("#"+s.pre+"stickrad_"+e).val(.2),$("#"+s.pre+"ballscale_"+e).val(.3),$("#"+s.pre+"ribbonthick_"+e).val(.4),$("#"+s.pre+"prtribbonwidth_"+e).val(1.3),$("#"+s.pre+"nucleotideribbonwidth_"+e).val(.8)),i.lineRadius=parseFloat($("#"+s.pre+"linerad_"+e).val()),i.coilWidth=parseFloat($("#"+s.pre+"coilrad_"+e).val()),i.cylinderRadius=parseFloat($("#"+s.pre+"stickrad_"+e).val()),i.traceRadius=parseFloat($("#"+s.pre+"stickrad_"+e).val()),i.dotSphereScale=parseFloat($("#"+s.pre+"ballscale_"+e).val()),i.ribbonthickness=parseFloat($("#"+s.pre+"ribbonthick_"+e).val()),i.helixSheetWidth=parseFloat($("#"+s.pre+"prtribbonwidth_"+e).val()),i.nucleicAcidWidth=parseFloat($("#"+s.pre+"nucleotideribbonwidth_"+e).val()),!s.bNode){let e=3650;this.setCookie("shininess",i.shininess,e),this.setCookie("light1",i.light1,e),this.setCookie("light2",i.light2,e),this.setCookie("light3",i.light3,e),this.setCookie("glycan",i.bGlycansCartoon,e)}if(this.setCookieForThickness(),e=t){let e="reset thickness";s.htmlCls.clickMenuCls.setLogCmd(e,!0),i.bSetThickness=!1,i.threeDPrintCls.resetAfter3Dprint()}else s.htmlCls.clickMenuCls.setLogCmd("set thickness | linerad "+i.lineRadius+" | coilrad "+i.coilWidth+" | stickrad "+i.cylinderRadius+" | tracerad "+i.traceRadius+" | ribbonthick "+i.ribbonthickness+" | proteinwidth "+i.helixSheetWidth+" | nucleotidewidth "+i.nucleicAcidWidth+" | ballscale "+i.dotSphereScale,!0);i.drawCls.draw()}setCookie(e,t,s){let i=new Date;i.setTime(i.getTime()+24*s*60*60*1e3);let l="expires="+i.toUTCString();document.cookie=e+"="+t+";"+l+";path=/"}updateSurfPara(e){let t=this.icn3dui,s=t.icn3d;s.phisurftype=$("#"+t.pre+e+"surftype").val(),s.phisurfop=$("#"+t.pre+e+"surfop").val(),s.phisurfwf=$("#"+t.pre+e+"surfwf").val()}exportPdb(){let e=this.icn3dui,t=e.icn3d,s="";s+=t.saveFileCls.getPDBHeader();let i=e.hashUtilsCls.intHash(t.dAtoms,t.hAtoms);s+=t.saveFileCls.getAtomPDB(i);let l=t.inputid?t.inputid:"custom";t.saveFileCls.saveFile(l+"_icn3d.pdb","text",[s])}}class lt{constructor(e){let t=e;this.icn3dui=e,this.cfg=this.icn3dui.cfg,this.opts={},this.opts.background="transparent",this.WIDTH=400,this.HEIGHT=400,this.RESIDUE_WIDTH=10,t.utilsCls.isMobile()||this.cfg.mobilemenu?this.MENU_HEIGHT=0:this.MENU_HEIGHT=40,this.LOG_HEIGHT=40,this.MENU_WIDTH=750,this.LESSWIDTH=20,this.LESSWIDTH_RESIZE=20,this.LESSHEIGHT=20,this.CMD_HEIGHT=.8*this.LOG_HEIGHT,this.EXTRAHEIGHT=this.MENU_HEIGHT+this.CMD_HEIGHT,null!=this.cfg.showmenu&&0==this.cfg.showmenu&&(this.EXTRAHEIGHT-=this.MENU_HEIGHT),null!=this.cfg.showcommand&&0==this.cfg.showcommand&&(this.EXTRAHEIGHT-=this.CMD_HEIGHT),this.GREY8="#AAAAAA",this.GREYB="#CCCCCC",this.GREYC="#DDDDDD",this.GREYD="#EEEEEE",this.ORANGE="#FFA500",this.themecolor="blue",this.defaultValue=1,this.ssValue=3,this.coilValue=3,this.contactValue=11,this.contactInsideValue=12,this.hbondValue=13,this.hbondInsideValue=14,this.ssbondValue=4,this.ionicValue=5,this.ionicInsideValue=6,this.clbondValue=15,this.halogenValue=17,this.halogenInsideValue=18,this.picationValue=19,this.picationInsideValue=20,this.pistackingValue=21,this.pistackingInsideValue=22,this.contactColor="888",this.contactInsideColor="FFF",this.hbondColor="0F0",this.hbondInsideColor="FFF",this.ssbondColor="FFA500",this.ionicColor="0FF",this.ionicInsideColor="FFF",this.clbondColor="006400",this.halogenColor="F0F",this.halogenInsideColor="FFF",this.picationColor="F00",this.picationInsideColor="FFF",this.pistackingColor="00F",this.pistackingInsideColor="FFF",this.hideedges=1,this.force=4,this.simulation=void 0,this.baseUrl="https://www.ncbi.nlm.nih.gov/Structure/",this.divStr="<div id='"+this.icn3dui.pre,this.divNowrapStr="<div style='white-space:nowrap'>",this.spanNowrapStr="<span style='white-space:nowrap'>",this.inputTextStr="<input type='text' ",this.inputFileStr="<input type='file' ",this.inputRadioStr="<input type='radio' ",this.inputCheckStr="<input type='checkbox' ",this.optionStr="<option value=",this.buttonStr="<button id='"+this.icn3dui.pre,this.postfix="2",this.space2="&nbsp;&nbsp;",this.space3=this.space2+"&nbsp;",this.space4=this.space2+this.space2,this.wifiStr="",this.licenseStr="",this.closeAc={collapsible:!0,active:!1},this.clickMenuCls=new Ke(this.icn3dui),this.setMenuCls=new Qe(this.icn3dui),this.dialogCls=new Ze(this.icn3dui),this.setDialogCls=new et(this.icn3dui),this.eventsCls=new tt(this.icn3dui),this.alignSeqCls=new st(this.icn3dui),this.setHtmlCls=new it(this.icn3dui)}}class nt{constructor(e){this.icn3d=e}alternateStructures(){let e=this.icn3d,t=e.icn3dui,s=Object.keys(e.hAtoms).length,i=Object.keys(e.atoms).length;e.dAtoms={};let l=Object.keys(e.structures);for(let s=0,i=l.length;s<i;++s){let n=l[s];if(s>e.ALTERNATE_STRUCTURE||e.ALTERNATE_STRUCTURE===i-1&&0===s){for(let s in e.structures[n]){let i=e.structures[n][s];e.dAtoms=t.hashUtilsCls.unionHash(e.dAtoms,e.chains[i])}e.ALTERNATE_STRUCTURE=s,$("#"+e.pre+"title").html(n);break}}s<i&&(e.dAtoms=t.hashUtilsCls.intHash(e.dAtoms,e.hAtoms),e.bShowHighlight=!1,e.opts.rotationcenter="highlight center"),e.applyMapCls.removeSurfaces(),e.applyMapCls.applySurfaceOptions(),e.applyMapCls.removeMaps(),e.applyMapCls.applyMapOptions(),e.applyMapCls.removeEmmaps(),e.applyMapCls.applyEmmapOptions(),e.applyMapCls.removePhimaps(),e.axes=[],e.pc1&&e.axesCls.setPc1Axes(),e.drawCls.draw(),e.bShowHighlight=!0,e.opts.rotationcenter="molecule center"}alternateWrapper(){let e=this.icn3d;e.icn3dui,e.bAlternate=!0,this.alternateStructures(),e.bAlternate=!1}}class ot{constructor(e){this.icn3d=e}drawGraph(e,t){let s=this.icn3d,i=s.icn3dui,l=d3,n=JSON.parse(e),o=$("#"+t).width(),r=$("#"+t).height(),a=isNaN(o)?300:1*o,d=isNaN(r)?300:1*r,c=o,h=r,m=d3.select("#"+i.svgid).attr("xmlns:xl","http://www.w3.org/1999/xlink").attr("xmlns","http://www.w3.org/2000/svg").attr("xmlns:dc","http://purl.org/dc/elements/1.1/").attr("width",o).attr("height",r).attr("viewBox","0,0,"+a+","+d);m.selectAll(".g-main").remove();let p=m.append("g").classed("g-main",!0),u=p.append("rect").attr("width",c).attr("height",h).style("fill","#FFF"),C=p.append("g"),g=l.zoom().on("zoom",(function(){C.attr("transform",l.event.transform)}));if(p.call(g),!n.links)return void console.log("Graph is missing links");let f=[],b={};for(let e=0,t=n.nodes.length;e<t;++e){b[n.nodes[e].id]=1}let y=!1;for(let e=0,t=n.links.length;e<t;++e){let t=n.links[e];b.hasOwnProperty(t.source)&&b.hasOwnProperty(t.target)?f.push(t):(b.hasOwnProperty(t.source)||console.log("The node "+t.source+" is not found... "),b.hasOwnProperty(t.target)||console.log("The node "+t.target+" is not found... "),y=!0)}y&&console.log(JSON.stringify(n)),n.links=f;let v,w={};for(v=0;v<n.nodes.length;v++)i.htmlCls.force||(n.nodes[v].x*=10,n.nodes[v].y*=10),w[n.nodes[v].id]=n.nodes[v],n.nodes[v].weight=1.01;if(i.htmlCls.hideedges&&!i.htmlCls.force){let e=[];for(v=0;v<n.links.length;v++)"FFF"!=n.links[v].c&&e.push(n.links[v]);n.links=e}let S=C.append("g"),_=null,A=C.append("g").attr("class","link").selectAll("line").data(n.links).enter().append("line").attr("stroke",(function(e){return e.v==i.htmlCls.contactInsideValue?"#"+i.htmlCls.contactInsideColor:e.v==i.htmlCls.hbondInsideValue?"#"+i.htmlCls.hbondInsideColor:e.v==i.htmlCls.ionicInsideValue?"#"+i.htmlCls.ionicInsideColor:e.v==i.htmlCls.halogenInsideValue?"#"+i.htmlCls.halogenInsideColor:e.v==i.htmlCls.picationInsideValue?"#"+i.htmlCls.picationInsideColor:e.v==i.htmlCls.pistackingInsideValue?"#"+i.htmlCls.pistackingInsideColor:"#"+e.c})).attr("stroke-width",(function(e){return e.v==i.htmlCls.contactValue||e.v==i.htmlCls.contactInsideValue||e.v==i.htmlCls.hbondInsideValue||e.v==i.htmlCls.ionicInsideValue||e.v==i.htmlCls.halogenInsideValue||e.v==i.htmlCls.picationInsideValue||e.v==i.htmlCls.pistackingInsideValue?"1px":e.v==i.htmlCls.hbondValue||e.v==i.htmlCls.ionicValue||e.v==i.htmlCls.halogenValue||e.v==i.htmlCls.picationValue||e.v==i.htmlCls.pistackingValue?"2px":e.v==i.htmlCls.ssbondValue||e.v==i.htmlCls.clbondValue?"3px":"2px"})),x=C.append("g").attr("class","node"),k=!!n.level;if(k)for(let e=0,t=n.nodes.length;e<t;++e){let t="",s=n.nodes[e];s.x,s.y,s.rx,s.ry,t+="<linearGradient id='"+s.id+"_g_obj' x1='0%' y1='0%' x2='100%' y2='0%'>",t+="  <stop offset='0%' style='stop-color:rgb(255,255,255);stop-opacity:1' />",t+="  <stop offset='100%' style='stop-color:#"+s.c+";stop-opacity:1' />",t+="</linearGradient>",x.append("defs").html(t)}let O=x.selectAll("ellipse").data(n.nodes).enter().append("ellipse").attr("rx",(function(e){return k?.5*e.rx:3})).attr("ry",(function(e){return k?.5*e.ry:3})).attr("fill",(function(e){return k?"url(#"+e.id+"_g_obj)":"#"+e.c})).attr("stroke",(function(e){return k?"none":"#"+e.c})).attr("res",(function(e){return e.r})).attr("class","icn3d-node").call(l.drag().on("start",(function(e){l.event.active||s.simulation.alphaTarget(.9).restart();e.selected||N||O.classed("selected",(function(e){return e.selected=e.previouslySelected=!1}));l.select(this).classed("selected",(function(t){return e.previouslySelected=e.selected,e.selected=!0})),O.filter((function(e){return e.selected})).each((function(e){e.fx=e.x,e.fy=e.y}))})).on("drag",(function(e){O.filter((function(e){return e.selected})).each((function(e){e.fx+=l.event.dx,e.fy-=l.event.dy}))})).on("end",(function(e){l.event.active||s.simulation.alphaTarget(0);e.fx=null,e.fy=null,O.filter((function(e){return e.selected})).each((function(e){e.fx=null,e.fy=null}))}))),H=x.selectAll("text").data(n.nodes).enter().append("text").text((function(e){let t=e.id,s=t.indexOf(".");return-1!==s&&(t=t.substr(0,s)),k&&(t=t.substr(t.lastIndexOf("_")+1)),t})).attr("fill",(function(e){return k?"#000":"#"+e.c})).attr("stroke","none").attr("class","icn3d-node-text8");O.append("title").text((function(e){return e.id}));let R=parseInt($("#"+s.pre+"dist_ss").val()),E=parseInt($("#"+s.pre+"dist_coil").val()),I=parseInt($("#"+s.pre+"dist_hbond").val()),D=parseInt($("#"+s.pre+"dist_inter").val()),T=parseInt($("#"+s.pre+"dist_ssbond").val()),P=parseInt($("#"+s.pre+"dist_ionic").val()),F=parseInt($("#"+s.pre+"dist_halogen").val()),M=parseInt($("#"+s.pre+"dist_pication").val()),L=parseInt($("#"+s.pre+"dist_pistacking").val());s.simulation=l.forceSimulation().force("link",l.forceLink().id((function(e){return e.id})).distance((function(e){return 30})).strength((function(e){return i.htmlCls.force?e.v==i.htmlCls.ssValue?isNaN(R)?1:R/100:e.v==i.htmlCls.coilValue||e.v==i.htmlCls.clbondValue?isNaN(E)?.5:E/100:e.v==i.htmlCls.hbondValue||e.v==i.htmlCls.hbondInsideValue?isNaN(I)?.5:I/100:e.v==i.htmlCls.contactValue||e.v==i.htmlCls.contactInsideValue?isNaN(D)?.25:D/100:e.v==i.htmlCls.ssbondValue?isNaN(T)?.5:T/100:e.v==i.htmlCls.ionicValue||e.v==i.htmlCls.ionicInsideValue?isNaN(P)?.5:P/100:e.v==i.htmlCls.halogenValue||e.v==i.htmlCls.halogenInsideValue?isNaN(F)?.5:F/100:e.v==i.htmlCls.picationValue||e.v==i.htmlCls.picationInsideValue?isNaN(M)?.5:M/100:e.v==i.htmlCls.pistackingValue||e.v==i.htmlCls.pistackingInsideValue?isNaN(L)?.5:L/100:0:0}))).force("center",l.forceCenter(c/2,h/2)),i.htmlCls.force&&s.simulation.force("charge",l.forceManyBody()),1==i.htmlCls.force?s.simulation.force("x",l.forceX((function(e){return"a"==e.s?c/4:.75*c})).strength((function(e){return.4}))).force("y",l.forceY(h/2).strength((function(e){return.02}))):2==i.htmlCls.force?s.simulation.force("y",l.forceY((function(e){return"a"==e.s?.75*h:h/4})).strength((function(e){return.4}))).force("x",l.forceX(c/2).strength((function(e){return.02}))):3==i.htmlCls.force?s.simulation.force("r",l.forceRadial((function(e){return"a"==e.s?200:100}),c/2,h/2).strength((function(e){return.8}))):i.htmlCls.force,s.simulation.nodes(n.nodes).on("tick",(function(){A.attr("x1",(function(e){let t=e.source.x;return isNaN(t)?0:t})).attr("y1",(function(e){let t=h-e.source.y;return isNaN(t)?0:t})).attr("x2",(function(e){let t=e.target.x;return isNaN(t)?0:t})).attr("y2",(function(e){let t=h-e.target.y;return isNaN(t)?0:t})),O.attr("cx",(function(e){let t=e.x.toFixed(0);return isNaN(t)?0:t})).attr("cy",(function(e){let t=(h-e.y).toFixed(0);return isNaN(t)?0:t})).attr("transform",(function(e){return k?"rotate("+e.ang+","+e.x.toFixed(0)+","+(h-e.y).toFixed(0)+")":""})),H.attr("x",(function(e){let t=k?e.x:e.x+6;return isNaN(t)?0:t})).attr("y",(function(e){let t=k?h-e.y:h-(e.y+3);return isNaN(t)?0:t}))})),s.simulation.force("link").links(n.links);let N,U=!1,q=!1,B=l.brush().on("start",(function(){q=!0,O.each((function(e){e.previouslySelected=N&&e.selected}))})).on("brush",(function(){if(!l.event.sourceEvent)return;if(!l.event.selection)return;let e=l.event.selection;O.classed("selected",(function(t){return t.selected=t.previouslySelected^(e[0][0]<=t.x&&t.x<e[1][0]&&e[0][1]<=h-t.y&&h-t.y<e[1][1])}))})).on("end",(function(){if(!l.event.sourceEvent)return;if(!l.event.selection)return;if(!_)return;_.call(B.move,null),U||(_.remove(),_=null);q=!1}));return u.on("click",(function(){O.each((function(e){e.selected=!1,e.previouslySelected=!1})),O.classed("selected",!1)})),l.select("body").on("keydown",(function(){if(N=l.event.ctrlKey,N){if(_)return;U=!0,_||(_=S.append("g"),_.call(B))}})),l.select("body").on("keyup",(function(){if(N=!1,U=!1,!_)return;q||(_.remove(),_=null)})),n}}class rt{constructor(e){this.icn3d=e}contactMap(e,t){let s=this.icn3d;s.icn3dui;let i=["selected"],l=["selected"];if(0==l.length)alert("Please select the first set");else{s.definedSetsCls.setMode("selection");let n=!1,o=!1,r=!0,a=!1,d=!1,c=!1;s.viewInterPairsCls.viewInteractionPairs(l,i,!1,t,n,o,r,a,d,c,e)}}drawContactMap(e){let t,s=this.icn3d,i=s.icn3dui,l=JSON.parse(e),n=l.links,o=[],r=[],a={};for(let e=0,t=l.nodes.length;e<t;++e){let t=l.nodes[e];t&&(a[t.id]=t,"a"==t.s?o.push(t):"b"==t.s?r.push(t):"ab"==t.s&&(o.push(t),r.push(t)))}o.sort((function(e,t){return s.getGraphCls.compNode(e,t)})),r.sort((function(e,t){return s.getGraphCls.compNode(e,t)}));let d,c,h,m,p="{\n",u=Object.keys(s.structures)[0];c=10*(o.length+2)+20+30,d=10*(r.length+2)+20+30,s.contactmapWidth=2*d,m=s.contactmapWidth,h=i.contactmapid,t=n.length>0?"":"No interactions found for these two sets<br><br>",t+="<svg id='"+h+"' viewBox='0,0,"+d+","+c+"' width='"+m+"px'>";return t+=s.lineGraphCls.drawScatterplot_base(o,r,n,a,0,!0),p+=s.getGraphCls.updateGraphJson(u,1,o,r,n),t+="</svg>",p+="}\n",s.contactmapStr=p,$("#"+s.pre+"contactmapDiv").html(t),t}}class at{constructor(e){this.icn3d=e}densityCifParser(e,t,s,i){let l,n=this.icn3d,o=n.icn3dui,r=this,a=o.utilsCls.isMobile()||n.icn3dui.cfg.notebook?0:4;if("2fofc"==t||"fofc"==t?l="https://www.ebi.ac.uk/pdbe/densities/x-ray/"+e.toLowerCase()+"/cell?detail="+a:"em"==t&&(l="https://www.ebi.ac.uk/pdbe/densities/emd/"+i.toLowerCase()+"/cell?detail="+a),"2fofc"==t&&n.bAjax2fofc)n.mapData.sigma2=s,n.setOptionCls.setOption("map",t);else if("fofc"==t&&n.bAjaxfofc)n.mapData.sigma=s,n.setOptionCls.setOption("map",t);else if("em"==t&&n.bAjaxEm)n.mapData.sigmaEm=s,n.setOptionCls.setOption("emmap",t);else{let e=new XMLHttpRequest;e.open("GET",l,!0),e.responseType="arraybuffer",e.onreadystatechange=function(){if(4==this.readyState){if(200==this.status){let i=e.response;r.parseChannels(i,t,s),"2fofc"==t||"fofc"==t?(n.bAjax2fofc=!0,n.bAjaxfofc=!0,n.setOptionCls.setOption("map",t)):"em"==t&&(n.bAjaxEm=!0,n.setOptionCls.setOption("emmap",t))}else"2fofc"==t||"fofc"==t?alert("Density server at EBI has no corresponding electron density map for this structure."):"em"==t&&alert("Density server at EBI has no corresponding EM density map for this structure.");void 0!==n.deferredEmmap&&n.deferredEmmap.resolve()}else n.ParserUtilsCls.showLoading()},e.send()}}parseChannels(e,t,s){let i=this.icn3d;i.icn3dui;let l=this.BinaryParse(e);if("2fofc"==t||"fofc"==t){let e=this.getChannel(l,"2FO-FC"),n=this.getChannel(l,"FO-FC"),o=e,r=o.box.sampleCount,a={xExtent:r[0],yExtent:r[1],zExtent:r[2],mean:o.valuesInfo.mean,sigma:o.valuesInfo.sigma};i.mapData.header2=a,i.mapData.data2=o.data;let d=o.box.origin,c=o.box.dimensions,h=o.spacegroup.basis,m=(new THREE.Matrix4).makeScale(c[0]/r[0],c[1]/r[1],c[2]/r[2]),p=(new THREE.Matrix4).makeTranslation(d[0],d[1],d[2]),u=(new THREE.Matrix4).set(h.x[0],h.y[0],h.z[0],0,0,h.y[1],h.z[1],0,0,0,h.z[2],0,0,0,0,1),C=u.multiply(p).multiply(m);i.mapData.matrix2=C,i.mapData.type2=t,i.mapData.sigma2=s,o=n,r=o.box.sampleCount,a={xExtent:r[0],yExtent:r[1],zExtent:r[2],mean:o.valuesInfo.mean,sigma:o.valuesInfo.sigma},i.mapData.header=a,i.mapData.data=o.data,d=o.box.origin,c=o.box.dimensions,h=o.spacegroup.basis,m=(new THREE.Matrix4).makeScale(c[0]/r[0],c[1]/r[1],c[2]/r[2]),p=(new THREE.Matrix4).makeTranslation(d[0],d[1],d[2]),u=(new THREE.Matrix4).set(h.x[0],h.y[0],h.z[0],0,0,h.y[1],h.z[1],0,0,0,h.z[2],0,0,0,0,1),C=u.multiply(p).multiply(m),i.mapData.matrix=C,i.mapData.type=t,i.mapData.sigma=s}else if("em"==t){let e=this.getChannel(l,"EM"),n=e.box.sampleCount,o={xExtent:n[0],yExtent:n[1],zExtent:n[2],max:e.valuesInfo.max,min:e.valuesInfo.min};i.mapData.headerEm=o,i.mapData.dataEm=e.data;let r=e.box.origin,a=e.box.dimensions,d=e.spacegroup.basis,c=(new THREE.Matrix4).makeScale(a[0]/n[0],a[1]/n[1],a[2]/n[2]),h=(new THREE.Matrix4).makeTranslation(r[0],r[1],r[2]),m=(new THREE.Matrix4).set(d.x[0],d.y[0],d.z[0],0,0,d.y[1],d.z[1],0,0,0,d.z[2],0,0,0,0,1).multiply(h).multiply(c);i.mapData.matrixEm=m,i.mapData.typeEm=t,i.mapData.sigmaEm=s}}getChannel(e,t){this.icn3d.icn3dui;let s,i=e.toJSON();for(let l=0,n=i.length;l<n;++l)i[l].id==t&&(s=e.dataBlocks[l]);return this.CIFParse(s)}CIFParse(e){this.icn3d.icn3dui;let t=e.getCategory("_volume_data_3d_info");if(!t)return void conole.log("_volume_data_3d_info category is missing.");if(!e.getCategory("_volume_data_3d"))return void conole.log("_volume_data_3d category is missing.");function s(e){let s=[0,0,0];for(let i=0;i<3;i++)s[i]=t.getColumn(e+"["+i+"]").getFloat(0);return s}function i(e){return t.getColumn(e).getFloat(0)}let l={name:t.getColumn("name").getString(0),axisOrder:s("axis_order"),origin:s("origin"),dimensions:s("dimensions"),sampleCount:s("sample_count"),spacegroupNumber:0|i("spacegroup_number"),cellSize:s("spacegroup_cell_size"),cellAngles:s("spacegroup_cell_angles"),mean:i("mean_sampled"),sigma:i("sigma_sampled")},n=[0,0,0];function o(e){return[e[n[0]],e[n[1]],e[n[2]]]}n[l.axisOrder[0]]=0,n[l.axisOrder[1]]=1,n[l.axisOrder[2]]=2;let r=o(l.sampleCount),a=function(e,t,s,i){let l=new Float32Array(t[0]*t[1]*t[2]),n=[0,0,0],o=i[0],r=i[1],a=i[2],d=s[0],c=s[1],h=s[2];t[0],t[0],t[1];let m=t[2],p=t[1]*t[2],u=0,C=e.getFloat(0),g=C;for(let t=0;t<h;t++){n[2]=t;for(let t=0;t<c;t++){n[1]=t;for(let t=0;t<d;t++){n[0]=t;let s=e.getFloat(u);u+=1,l[n[a]+n[r]*m+n[o]*p]=s,s<C?C=s:s>g&&(g=s)}}}return{data:l,min:C,max:g}}(e.getCategory("_volume_data_3d").getColumn("values"),r,l.sampleCount,n);return{name:l.name,spacegroup:function(e,t,s){let i=Math.PI/180*s[0],l=Math.PI/180*s[1],n=Math.PI/180*s[2],o=t[0],r=t[1],a=t[2],d=Math.cos(l),c=(Math.cos(i)-Math.cos(l)*Math.cos(n))/Math.sin(n),h=Math.sqrt(1-d*d-c*c);return{number:e,size:t,angles:s,basis:{x:[o,0,0],y:[Math.cos(n)*r,Math.sin(n)*r,0],z:[d*a,c*a,h*a]}}}(l.spacegroupNumber,l.cellSize,l.cellAngles),box:{origin:o(l.origin),dimensions:o(l.dimensions),sampleCount:r},data:a.data,valuesInfo:{min:a.min,max:a.max,mean:l.mean,sigma:l.sigma}}}BinaryParse(e){this.icn3d.icn3dui;let t=new Uint8Array(e),s=this.MessagePackParse({buffer:t,offset:0,dataView:new DataView(t.buffer)}),i=function(){function e(e){this.additionalData={},this.header=e.header,this.categoryList=e.categories.map((function(e){return new l(e)})),this.categoryMap=new Map;for(let e=0,t=this.categoryList;e<t.length;e++){let s=t[e];this.categoryMap.set(s.name,s)}}return Object.defineProperty(e.prototype,"categories",{get:function(){return this.categoryList},enumerable:!0,configurable:!0}),e.prototype.getCategory=function(e){return this.categoryMap.get(e)},e.prototype.toJSON=function(){return{id:this.header,categories:this.categoryList.map((function(e){return e.toJSON()})),additionalData:this.additionalData}},e}(),l=function(){function e(e){this.name=e.name,this.columnCount=e.columns.length,this.rowCount=e.rowCount,this.columnNameList=[],this.encodedColumns=new Map;for(let t=0,s=e.columns;t<s.length;t++){let e=s[t];this.encodedColumns.set(e.name,e),this.columnNameList.push(e.name)}}Object.defineProperty(e.prototype,"columnNames",{get:function(){return this.columnNameList},enumerable:!0,configurable:!0});let t=function(){function e(){this.isDefined=!1}return e.prototype.getString=function(e){return null},e.prototype.getInteger=function(e){return 0},e.prototype.getFloat=function(e){return 0},e.prototype.getValuePresence=function(e){return 1},e.prototype.areValuesEqual=function(e,t){return!0},e.prototype.stringEquals=function(e,t){return null===t},e}();return e.prototype.getColumn=function(e){let s=this.encodedColumns.get(e);return s?m(s):t},e.prototype.toJSON=function(){let e=this,t=[],s=this.columnNameList.map((function(t){return{name:t,column:e.getColumn(t)}}));for(let e=0;e<this.rowCount;e++){let i={};for(let t=0,l=s;t<l.length;t++){let s=l[t],n=s.column.getValuePresence(e);i[s.name]=0===n?s.column.getString(e):1===n?".":"?"}t[e]=i}return{name:this.name,columns:this.columnNames,rows:t}},e}();function n(e,t){switch(e){case 1:return new Int8Array(t);case 2:return new Int16Array(t);case 3:return new Int32Array(t);case 4:return new Uint8Array(t);case 5:return new Uint16Array(t);case 6:return new Uint32Array(t);default:throw new Error("Unsupported integer data type.")}}function o(e,t){switch(e){case 32:return new Float32Array(t);case 33:return new Float64Array(t);default:throw new Error("Unsupported floating data type.")}}let r=function(){let e=new ArrayBuffer(2),t=new Uint8Array(e),s=new Uint16Array(e);return t[0]=170,t[1]=187,48042===s[0]}();function a(e,t,s){return new s(r?e.buffer:function(e,t){let s=new ArrayBuffer(e.length),i=new Uint8Array(s);for(let s=0,l=e.length;s<l;s+=t)for(let l=0;l<t;l++)i[s+t-l-1]=e[s+l];return s}(e,t))}function d(e,t){return t.isUnsigned?function(e,t){let s=1===t.byteCount?255:65535,i=e.length,l=new Int32Array(t.srcSize),n=0,o=0;for(;n<i;){let t=0,i=e[n];for(;i===s;)t+=i,n++,i=e[n];t+=i,l[o]=t,n++,o++}return l}(e,t):function(e,t){let s=1===t.byteCount?127:32767,i=-s-1,l=e.length,n=new Int32Array(t.srcSize),o=0,r=0;for(;o<l;){let t=0,l=e[o];for(;l===s||l===i;)t+=l,o++,l=e[o];t+=l,n[r]=t,o++,r++}return n}(e,t)}function c(e,t){switch(t.kind){case"ByteArray":switch(t.type){case 4:return e;case 1:return function(e){return new Int8Array(e.buffer,e.byteOffset)}(e);case 2:return function(e){return a(e,2,Int16Array)}(e);case 5:return function(e){return a(e,2,Uint16Array)}(e);case 3:return function(e){return a(e,4,Int32Array)}(e);case 6:return function(e){return a(e,4,Uint32Array)}(e);case 32:return function(e){return a(e,4,Float32Array)}(e);case 33:return function(e){return a(e,8,Float64Array)}(e);default:throw new Error("Unsupported ByteArray type.")}case"FixedPoint":return function(e,t){let s=e.length,i=o(t.srcType,s),l=1/t.factor;for(let t=0;t<s;t++)i[t]=l*e[t];return i}(e,t);case"IntervalQuantization":return function(e,t){let s=e.length,i=o(t.srcType,s),l=(t.max-t.min)/(t.numSteps-1),n=t.min;for(let t=0;t<s;t++)i[t]=n+l*e[t];return i}(e,t);case"RunLength":return function(e,t){let s=n(t.srcType,t.srcSize),i=0;for(let t=0,l=e.length;t<l;t+=2){let l=e[t],n=e[t+1];for(let e=0;e<n;++e)s[i++]=l}return s}(e,t);case"Delta":return function(e,t){let s=e.length,i=n(t.srcType,s);if(!s)return i;i[0]=e[0]+(0|t.origin);for(let t=1;t<s;++t)i[t]=e[t]+i[t-1];return i}(e,t);case"IntegerPacking":return d(e,t);case"StringArray":return function(e,t){let s=t.stringData,i=h({encoding:t.offsetEncoding,data:t.offsets}),l=h({encoding:t.dataEncoding,data:e}),n=Object.create(null),o=new Array(l.length),r=0;for(let e=0,t=l;e<t.length;e++){let l=t[e];if(l<0){o[r++]=null;continue}let a=n[l];void 0===a&&(a=s.substring(i[l],i[l+1]),n[l]=a),o[r++]=a}return o}(e,t)}}function h(e){let t=e.data;for(let s=e.encoding.length-1;s>=0;s--)t=c(t,e.encoding[s]);return t}function m(e){if(!e.data.data)return _UndefinedColumn;let t,s=h(e.data);return e.mask&&(t=h(e.mask)),s.buffer&&s.byteLength&&s.BYTES_PER_ELEMENT?t?new g(s,t):new C(s):t?new b(s,t):new f(s)}function p(e,t,s){let i=0,l=1;for(45===e.charCodeAt(t)&&(l=-1,t++);t<s;t++){let s=e.charCodeAt(t)-48;if(s>9||s<0)return l*i|0;i=10*i+s|0}return l*i}function u(e,t,s){let i=1,l=0,n=0,o=1;for(45===e.charCodeAt(t)&&(i=-1,++t);t<s;){let r=e.charCodeAt(t)-48;if(!(r>=0&&r<10)){if(-2===r){for(++t;t<s;){if(r=e.charCodeAt(t)-48,!(r>=0&&r<10))return 53===r||21===r?parseScientific(i*(l+n/o),e,t+1,s):i*(l+n/o);n=10*n+r,o*=10,++t}return i*(l+n/o)}if(53===r||21===r)return parseScientific(i*l,e,t+1,s);break}l=10*l+r,++t}return i*l}let C=function(){function e(e){this.data=e,this.isDefined=!0}return e.prototype.getString=function(e){return""+this.data[e]},e.prototype.getInteger=function(e){return 0|this.data[e]},e.prototype.getFloat=function(e){return 1*this.data[e]},e.prototype.stringEquals=function(e,t){return this.data[e]===u(t,0,t.length)},e.prototype.areValuesEqual=function(e,t){return this.data[e]===this.data[t]},e.prototype.getValuePresence=function(e){return 0},e}(),g=function(){function e(e,t){this.data=e,this.mask=t,this.isDefined=!0}return e.prototype.getString=function(e){return 0===this.mask[e]?""+this.data[e]:null},e.prototype.getInteger=function(e){return 0===this.mask[e]?this.data[e]:0},e.prototype.getFloat=function(e){return 0===this.mask[e]?this.data[e]:0},e.prototype.stringEquals=function(e,t){return 0===this.mask[e]?this.data[e]===u(t,0,t.length):null==t},e.prototype.areValuesEqual=function(e,t){return this.data[e]===this.data[t]},e.prototype.getValuePresence=function(e){return this.mask[e]},e}(),f=function(){function e(e){this.data=e,this.isDefined=!0}return e.prototype.getString=function(e){return this.data[e]},e.prototype.getInteger=function(e){let t=this.data[e];return p(t,0,t.length)},e.prototype.getFloat=function(e){let t=this.data[e];return u(t,0,t.length)},e.prototype.stringEquals=function(e,t){return this.data[e]===t},e.prototype.areValuesEqual=function(e,t){return this.data[e]===this.data[t]},e.prototype.getValuePresence=function(e){return 0},e}(),b=function(){function e(e,t){this.data=e,this.mask=t,this.isDefined=!0}return e.prototype.getString=function(e){return 0===this.mask[e]?this.data[e]:null},e.prototype.getInteger=function(e){if(0!==this.mask[e])return 0;let t=this.data[e];return p(t||"",0,(t||"").length)},e.prototype.getFloat=function(e){if(0!==this.mask[e])return 0;let t=this.data[e];return u(t||"",0,(t||"").length)},e.prototype.stringEquals=function(e,t){return this.data[e]===t},e.prototype.areValuesEqual=function(e,t){return this.data[e]===this.data[t]},e.prototype.getValuePresence=function(e){return this.mask[e]},e}();return new(function(){function e(e){this.dataBlocks=e.dataBlocks.map((function(e){return new i(e)}))}return e.prototype.toJSON=function(){return this.dataBlocks.map((function(e){return e.toJSON()}))},e}())(s)}MessagePackParse(e){this.icn3d.icn3dui;let t=this;function s(e,s){let i={};for(let l=0;l<s;l++){i[t.MessagePackParse(e)]=t.MessagePackParse(e)}return i}function i(e,t){let s=new Uint8Array(t),i=e.offset;for(let l=0;l<t;l++)s[l]=e.buffer[l+i];return e.offset+=t,s}function l(e,s){let i=new Array(s);for(let l=0;l<s;l++)i[l]=t.MessagePackParse(e);return i}function n(e,t){let s=function(e,t,s){let i,l=o,n=[],r=512,a=0;for(let o=t,d=t+s;o<d;o++){let t=e[o];0==(128&t)?n[a++]=l[t]:192==(224&t)?n[a++]=l[(15&t)<<6|63&e[++o]]:224==(240&t)?n[a++]=String.fromCharCode((15&t)<<12|(63&e[++o])<<6|(63&e[++o])<<0):240==(248&t)?n[a++]=String.fromCharCode((7&t)<<18|(63&e[++o])<<12|(63&e[++o])<<6|(63&e[++o])<<0):throwError("Invalid byte "+t.toString(16)),a===r&&(i=i||[],i[i.length]=n.join(""),a=0)}if(!i)return n.slice(0,a).join("");a>0&&(i[i.length]=n.slice(0,a).join(""));return i.join("")}(e.buffer,e.offset,t);return e.offset+=t,s}let o=function(){let e=[];for(let t=0;t<1024;t++)e[t]=String.fromCharCode(t);return e}();let r,a,d=e.buffer[e.offset];if(0==(128&d))return e.offset++,d;if(128==(240&d))return a=15&d,e.offset++,s(e,a);if(144==(240&d))return a=15&d,e.offset++,l(e,a);if(160==(224&d))return a=31&d,e.offset++,n(e,a);if(224==(224&d))return r=e.dataView.getInt8(e.offset),e.offset++,r;switch(d){case 192:return e.offset++,null;case 194:return e.offset++,!1;case 195:return e.offset++,!0;case 196:return a=e.dataView.getUint8(e.offset+1),e.offset+=2,i(e,a);case 197:return a=e.dataView.getUint16(e.offset+1),e.offset+=3,i(e,a);case 198:return a=e.dataView.getUint32(e.offset+1),e.offset+=5,i(e,a);case 202:return r=e.dataView.getFloat32(e.offset+1),e.offset+=5,r;case 203:return r=e.dataView.getFloat64(e.offset+1),e.offset+=9,r;case 204:return r=e.buffer[e.offset+1],e.offset+=2,r;case 205:return r=e.dataView.getUint16(e.offset+1),e.offset+=3,r;case 206:return r=e.dataView.getUint32(e.offset+1),e.offset+=5,r;case 208:return r=e.dataView.getInt8(e.offset+1),e.offset+=2,r;case 209:return r=e.dataView.getInt16(e.offset+1),e.offset+=3,r;case 210:return r=e.dataView.getInt32(e.offset+1),e.offset+=5,r;case 217:return a=e.dataView.getUint8(e.offset+1),e.offset+=2,n(e,a);case 218:return a=e.dataView.getUint16(e.offset+1),e.offset+=3,n(e,a);case 219:return a=e.dataView.getUint32(e.offset+1),e.offset+=5,n(e,a);case 220:return a=e.dataView.getUint16(e.offset+1),e.offset+=3,l(e,a);case 221:return a=e.dataView.getUint32(e.offset+1),e.offset+=5,l(e,a);case 222:return a=e.dataView.getUint16(e.offset+1),e.offset+=3,s(e,a);case 223:return a=e.dataView.getUint32(e.offset+1),e.offset+=5,s(e,a)}}}class dt{constructor(e){this.icn3d=e}draw2Dcartoon(e){let t=this.icn3d;t.icn3dui;let s=this;t.icn3dui.htmlCls.clickMenuCls.setLogCmd("cartoon 2d "+e,!0),t.bGraph=!1,"domain"!=e||t.chainid2pssmid?(this.getNodesLinksForSetCartoonBase(e),t.graphStr=s.getCartoonData(e,t.node_link),t.viewInterPairsCls.drawGraphWrapper(t.graphStr,t.deferredCartoon2d,!0)):$.when(s.getNodesLinksForSetCartoon(e)).then((function(){t.graphStr=s.getCartoonData(e,t.node_link),t.viewInterPairsCls.drawGraphWrapper(t.graphStr,t.deferredCartoon2d,!0)}))}getCartoonData(e,t){let s=this.icn3d;s.icn3dui;let i,l,n=[],o=[];n=t.node;let r=[],a={},d=0;for(let e=0,t=n.length;e<t;++e){let t=n[e],s=JSON.parse(t);a.hasOwnProperty(s.id)||(r.push(s),a[s.id]=d,++d)}let c=[];for(let e=0,t=r.length;e<t;++e){let t=r[e];c.push(JSON.stringify(t))}i=c.join(", "),o=t.link,l=o.join(", "),s.hAtoms;let h='{"nodes": ['+i+'], "links": [';return h+=l+"",h+='], "level": "'+(t.level?t.level:"")+'"}',h}getNodesLinksForSetCartoon(e){let t=this.icn3d;t.icn3dui;let s=this;return t.deferredCartoon2d=$.Deferred((function(){s.getNodesLinksForSetCartoonBase(e)})),t.deferredCartoon2d.promise()}getNodesLinksForSetCartoonBase(e){let t,s,i,l,n,o,r,a,d=this.icn3d,c=d.icn3dui,h=this,m=[],p=[],u=0,C=d.icn3dui.htmlCls.defaultValue,g="",f="",b="",y=!1,v=!0;if("chain"==e){let e={};for(let t in d.hAtoms){let s=d.atoms[t];if("DUM"==s.chain)continue;let i=s.structure+"_"+s.chain;d.proteins.hasOwnProperty(t)&&(e.hasOwnProperty(i)||(e[i]={}),e[i][s.serial]=s)}for(let t in e){let s=d.contactCls.getExtent(e[t]);s[1][0],s[0][0],s[1][0],s[0][0],s[1][1],s[0][1],s[1][1],s[0][1],s[1][2],s[0][2],s[1][2],s[0][2];let i=Object.keys(e[t])[0],l=d.atoms[i];a=t,m.push('{"id": "'+t+'", "r": "'+a+'", "s": "a", "x": '+s[2][0].toFixed(0)+', "y": '+s[2][1].toFixed(0)+', "c": "'+l.color.getHexString().toUpperCase()+'"}')}}else if("domain"==e){if(d.chainid2pssmid)return this.getNodesLinksForDomains(d.chainid2pssmid);$.when(d.loadScriptCls.applyCommandAnnotationsAndCddSite("view annotations")).then((function(){return h.getNodesLinksForDomains(d.chainid2pssmid)}))}else if("secondary"==e){d.resi2resirange={};let e,h=[];for(let w in d.hAtoms){let S=d.atoms[w];if("DUM"!=S.chain&&((S.ssbegin||S.ssend)&&"CA"==S.name&&"C"==S.elem)){let w=S.structure+"_"+S.chain+"_"+S.resi;if(v&&S.ssbegin&&(l=S.coord.x,n=S.coord.y,o=S.coord.z,y=!0,v=!1,t=S,r=c.utilsCls.residueName2Abbr(S.resn)+S.resi,a="1_1_"+w,b=S.chain),y&&(e=c.utilsCls.residueName2Abbr(S.resn)+S.resi,e+="."+S.chain,Object.keys(d.structures).length>1&&(e+="."+S.structure),h.push(e)),b==S.chain&&y&&S.ssend){s=.5*(l+S.coord.x),i=.5*(n+S.coord.y),S.coord.z,S.coord.distanceTo(t.coord),y=!1,v=!0,r+="-"+S.resi,a+="-"+S.resi,r+="."+S.chain,Object.keys(d.structures).length>1&&(r+="."+S.structure);for(let t=0,s=h.length;t<s;++t)e=h[t],d.resi2resirange[e]=r;h=[],u>0&&g==S.chain&&p.push('{"source": "'+f+'", "target": "'+r+'", "v": '+C+', "c": "'+t.color.getHexString().toUpperCase()+'"}'),m.push('{"id": "'+r+'", "r": "'+a+'", "s": "a", "x": '+s.toFixed(0)+', "y": '+i.toFixed(0)+', "c": "'+S.color.getHexString().toUpperCase()+'"}'),g=S.chain,f=r,++u}}}}d.node_link={node:m,link:p}}getNodesLinksForDomains(e){let t,s=this.icn3d,i=s.icn3dui,l=[],n=[],o=s.icn3dui.htmlCls.defaultValue;s.resi2resirange={};let r={};for(let e in s.hAtoms){let t=s.atoms[e];"DUM"!=t.chain&&(r[t.structure+"_"+t.chain]=1)}for(let d in r){if(!e.hasOwnProperty(d))continue;let r=e[d].pssmid2name,c=e[d].pssmid2fromArray,h=e[d].pssmid2toArray,m={};for(let e in r){let t=c[e];m[e]=t[0]}var a=Object.keys(m);let p,u;a.sort((function(e,t){return m[e]-m[t]}));for(let e=0,m=a.length;e<m;++e){let m=a[e],C=r[m];C+="."+d.substr(d.indexOf("_")+1),Object.keys(s.structures).length>1&&(C+="."+d.substr(0,d.indexOf("_")));let g=c[m],f=h[m];s.hAtoms={};for(let e=0,t=g.length;e<t;++e){let t=g[e]+1,l=f[e]+1;for(let e=t;e<=l;++e)s.hAtoms=i.hashUtilsCls.unionHash(s.hAtoms,s.residues[d+"_"+e])}if(0==Object.keys(s.hAtoms).length)continue;let b=s.axesCls.setPc1Axes(),y=b[0],v=b[1].distanceTo(b[0]),w=b[2].distanceTo(b[0]),S=180*new THREE.Vector2(b[1].x-b[0].x,b[1].y-b[0].y).angle()/3.1416;S>180&&(S-=180);let _=Object.keys(s.hAtoms)[0],A=s.atoms[_];t=d;let x=0;void 0!==p&&n.push('{"source": "'+p+'", "target": "'+C+'", "v": '+o+', "c": "'+u.color.getHexString().toUpperCase()+'"}'),l.push('{"id": "'+C+'", "r": "'+t+'", "s": "a", "x": '+y.x.toFixed(0)+', "y": '+y.y.toFixed(0)+', "rx": '+v.toFixed(0)+', "ry": '+w.toFixed(0)+', "ang": '+S.toFixed(0)+', "shape": '+x+', "c": "'+A.color.getHexString().toUpperCase()+'"}'),p=C,u=A}}s.node_link={node:l,link:n,level:"domain"},void 0!==s.deferredCartoon2d&&s.deferredCartoon2d.resolve()}click2Dcartoon(){let e=this.icn3d.icn3dui;e.myEventCls.onIds("#"+e.pre+"2ddgm_chain","click",(function(t){let s=e.icn3d;t.preventDefault(),s.cartoon2dCls.draw2Dcartoon("chain")})),e.myEventCls.onIds("#"+e.pre+"2ddgm_domain","click",(function(t){let s=e.icn3d;t.preventDefault(),s.cartoon2dCls.draw2Dcartoon("domain")})),e.myEventCls.onIds("#"+e.pre+"2ddgm_secondary","click",(function(t){let s=e.icn3d;t.preventDefault(),s.cartoon2dCls.draw2Dcartoon("secondary")}))}}class ct{constructor(e){this.icn3d=e}rayCaster(e,t){this.rayCasterBase(e,t)}rayCasterBase(e,t){let s=this.icn3d;s.icn3dui;let i=e.pageX,l=e.pageY;e.originalEvent.targetTouches&&e.originalEvent.targetTouches[0]&&(i=e.originalEvent.targetTouches[0].pageX,l=e.originalEvent.targetTouches[0].pageY);let n=s.oriContainer.offset().left,o=s.oriContainer.offset().top,r=s.oriContainer.width(),a=s.oriContainer.height(),d=i-n,c=l-o;s.mouse.x=d/r*2-1,s.mouse.y=-c/a*2+1;let h=new THREE.Vector3;h.x=s.mouse.x,h.y=s.mouse.y,s.cam_z>0?h.z=-1:h.z=1,s.cam===s.perspectiveCamera?(s.cam_z>0?h.z=-1:h.z=1,h.unproject(s.cam),s.raycaster.set(s.cam.position,h.sub(s.cam.position).normalize())):s.cam===s.orthographicCamera&&(s.cam_z>0?h.z=1:h.z=-1,h.unproject(s.cam),s.raycaster.set(h,new THREE.Vector3(0,0,-1).transformDirection(s.cam.matrixWorld)));let m=this.isIntersect(s.objects,s.mdl,t,d,c);m||(m=this.isIntersect(s.objects_ghost,s.mdl_ghost,t,d,c))}isIntersect(e,t,s,i,l){let n=this.icn3d;n.icn3dui;let o=n.raycaster.intersectObjects(e),r=!1,a=t.position;if(o.length>0){o[0].point.sub(a);let e=.5,t=this.getAtomsFromPosition(o[0].point,e);for(;!t&&e<10;)e+=.5,t=this.getAtomsFromPosition(o[0].point,e);t?(r=!0,n.pickpair?s&&(n.pAtomNum%2==0?n.pAtom=t:n.pAtom2=t,++n.pAtomNum):n.pAtom=t,s?n.pickingCls.showPicking(t):n.pickingCls.showPicking(t,i,l)):console.log("No atoms were found in 10 andstrom range")}return r}getAtomsFromPosition(e,t){let s,i=this.icn3d,l=i.icn3dui;for(s in null==t&&(t=1),i.dAtoms){let n=i.atoms[s];if(i.ions.hasOwnProperty(s)&&"sphere"===i.opts.ions){let s=l.parasCls.vdwRadii[n.elem.toUpperCase()];if(Math.abs(n.coord.x-e.x)-s>t)continue;if(Math.abs(n.coord.y-e.y)-s>t)continue;if(Math.abs(n.coord.z-e.z)-s>t)continue}else{if(n.coord.x<e.x-t||n.coord.x>e.x+t)continue;if(n.coord.y<e.y-t||n.coord.y>e.y+t)continue;if(n.coord.z<e.z-t||n.coord.z>e.z+t)continue}return n}return null}}class ht{constructor(e){this.icn3d=e}setControl(){let e=this.icn3d;if(e.icn3dui,e.icn3dui.bNode)return;let t=this;e.WIDTH=e.container.width(),e.HEIGHT=e.container.height(),e.applyCenterCls.setWidthHeight(e.WIDTH,e.HEIGHT),e._zoomFactor=1,e.mouseChange=new THREE.Vector2(0,0),e.quaternion=new THREE.Quaternion(0,0,0,1),e.container.bind("contextmenu",(function(e){e.preventDefault()})),e.typetext=!1,$(document).bind("keyup",(function(t){16===t.keyCode&&(e.bShift=!1),17!==t.keyCode&&224!==t.keyCode&&91!==t.keyCode||(e.bCtrl=!1)})),$("input[type=text], textarea").focus((function(){e.typetext=!0})),$("input[type=text], textarea").blur((function(){e.typetext=!1})),$(document).bind("keydown",(function(t){if((t.shiftKey||16===t.keyCode)&&(e.bShift=!0),(t.ctrlKey||17===t.keyCode||224===t.keyCode||91===t.keyCode)&&(e.bCtrl=!0),!e.bControlGl&&!e.controls||e.bControlGl&&!window.controls)return;e.bStopRotate=!0;let s=e.bShift?90:5;if(!e.typetext)if(90===t.keyCode){let t={};e.bControlGl&&!e.icn3dui.bNode?window.cam===e.perspectiveCamera?t._zoomFactor=.9:window.cam===e.orthographicCamera&&(e._zoomFactor<.1?e._zoomFactor=.1:e._zoomFactor>1&&(e._zoomFactor=1),t._zoomFactor=.8*e._zoomFactor,t._zoomFactor<.1&&(t._zoomFactor=.1)):e.cam===e.perspectiveCamera?t._zoomFactor=.9:e.cam===e.orthographicCamera&&(e._zoomFactor<.1?e._zoomFactor=.1:e._zoomFactor>1&&(e._zoomFactor=1),t._zoomFactor=.8*e._zoomFactor,t._zoomFactor<.1&&(t._zoomFactor=.1)),t.update=!0,e.bControlGl&&!e.icn3dui.bNode?window.controls.update(t):e.controls.update(t),e.bRender&&e.drawCls.render()}else if(88===t.keyCode){let t={};e.bControlGl&&!e.icn3dui.bNode?window.cam===e.perspectiveCamera?t._zoomFactor=1.03:window.cam===e.orthographicCamera&&(e._zoomFactor>10?e._zoomFactor=10:e._zoomFactor<1&&(e._zoomFactor=1),t._zoomFactor=1.01*e._zoomFactor,t._zoomFactor>10&&(t._zoomFactor=10)):e.cam===e.perspectiveCamera?t._zoomFactor=1.03:e.cam===e.orthographicCamera&&(e._zoomFactor>10?e._zoomFactor=10:e._zoomFactor<1&&(e._zoomFactor=1),t._zoomFactor=1.01*e._zoomFactor,t._zoomFactor>10&&(t._zoomFactor=10)),t.update=!0,e.bControlGl&&!e.icn3dui.bNode?window.controls.update(t):e.controls.update(t),e.bRender&&e.drawCls.render()}else if(76===t.keyCode){let t=new THREE.Vector3(0,1,0),i=-s/180*Math.PI;e.transformCls.setRotation(t,i)}else if(74===t.keyCode){let t=new THREE.Vector3(0,1,0),i=s/180*Math.PI;e.transformCls.setRotation(t,i)}else if(73===t.keyCode){let t=new THREE.Vector3(1,0,0),i=-s/180*Math.PI;e.transformCls.setRotation(t,i)}else if(77===t.keyCode){let t=new THREE.Vector3(1,0,0),i=s/180*Math.PI;e.transformCls.setRotation(t,i)}else 65===t.keyCode&&Object.keys(e.structures).length>1&&e.alternateCls.alternateWrapper()})),e.container.bind("mouseup",(function(t){e.isDragging=!1})),e.container.bind("touchend",(function(t){e.isDragging=!1})),e.container.bind("mousedown",(function(t){if(e.isDragging=!0,e.scene){if(e.bStopRotate=!0,e.pk&&(t.altKey||t.ctrlKey||t.shiftKey||18===t.keyCode||16===t.keyCode||17===t.keyCode||224===t.keyCode||91===t.keyCode)){e.highlightlevel=e.pk;let s=!0;e.rayCls.rayCaster(t,s)}e.bControlGl&&!e.icn3dui.bNode?(window.controls.handleResize(),window.controls.update()):(e.controls.handleResize(),e.controls.update()),e.bRender&&e.drawCls.render()}})),e.container.bind("touchstart",(function(t){if(t.preventDefault(),e.isDragging=!0,!e.scene)return;e.bStopRotate=!0,$("#"+e.pre+"popup").hide();e.rayCls.rayCaster(t,!0),e.bControlGl&&!e.icn3dui.bNode?(window.controls.handleResize(),window.controls.update()):(e.controls.handleResize(),e.controls.update()),e.bRender&&e.drawCls.render()})),e.container.bind("mousemove touchmove",(function(e){t.mouseMove(e)})),e.container.bind("mousewheel",(function(t){t.preventDefault(),e.scene&&(e.bStopRotate=!0,e.bControlGl&&!e.icn3dui.bNode?(window.controls.handleResize(),window.controls.update()):(e.controls.handleResize(),e.controls.update()),e.bRender&&e.drawCls.render())})),e.container.bind("DOMMouseScroll",(function(t){t.preventDefault(),e.scene&&(e.bStopRotate=!0,e.bControlGl&&!e.icn3dui.bNode?(window.controls.handleResize(),window.controls.update()):(e.controls.handleResize(),e.controls.update()),e.bRender&&e.drawCls.render())}))}mouseMove(e){let t=this.icn3d;if(t.icn3dui,t.icn3dui.bNode)return;if(e.preventDefault(),!t.scene)return;$("#"+t.pre+"popup").hide();if(t.rayCls.rayCaster(e,!1),t.bControlGl&&!t.icn3dui.bNode){window.controls.handleResize(),window.controls.update();for(let e in window.icn3duiHash){let t=window.icn3duiHash[e].icn3d;t.bRender&&t.drawCls.render()}}else t.controls.handleResize(),t.controls.update(),t.bRender&&t.drawCls.render()}}class mt{constructor(e){let t=e;if(this.icn3dui=e,this.id=this.icn3dui.pre+"canvas",this.pre=this.icn3dui.pre,this.container=$("#"+this.id),this.oriContainer=$("#"+this.id),this.bControlGl=!1,this.maxatomcnt=1e5,this.overdraw=0,this.bDrawn=!1,this.bOpm=!1,this.crossstrucinter=0,this.bSecondaryStructure=!1,this.bHighlight=1,this.renderOrderPicking=-1,this.bInitial=!0,this.bDoublecolor=!1,this.originSize=1,this.ALTERNATE_STRUCTURE=-1,this.bUsePdbNum=!0,!this.icn3dui.bNode){let e=document.createElement("canvas");!(!window.WebGLRenderingContext||!e.getContext("webgl")&&!e.getContext("experimental-webgl"))?(this.renderer=new THREE.WebGL1Renderer({canvas:this.oriContainer.get(0),antialias:!0,preserveDrawingBuffer:!0,sortObjects:!1,alpha:!0}),this.overdraw=0):alert("Currently your web browser has a problem on WebGL. If you are using Chrome, open a new tab for the same URL and WebGL may work again.")}this.frac=new THREE.Color(.1,.1,.1),this.shininess=40,this.emissive=1118481,this.light1=.6,this.light2=.4,this.light3=.2,this.lineRadius=.1,this.coilWidth=.3,this.cylinderRadius=.4,this.traceRadius=.4,this.dotSphereScale=.3,this.sphereRadius=1.5,this.cylinderHelixRadius=1.6,this.ribbonthickness=.2,this.helixSheetWidth=1.3,this.nucleicAcidWidth=.8,this.scaleFactor=1,this.labelScale=1,this.bImpo=!0,this.bInstanced=!0,this.icn3dui.bNode||(this.bExtFragDepth=this.renderer.extensions.get("EXT_frag_depth"),this.bExtFragDepth?console.log("EXT_frag_depth is supported. All spheres and cylinders are drawn using shaders."):(this.bImpo=!1,console.log("EXT_frag_depth is NOT supported. All spheres and cylinders are drawn using geometry.")),this.bInstanced=this.renderer.extensions.get("ANGLE_instanced_arrays"),this.bInstanced?console.log("ANGLE_instanced_arrays is supported. Assembly is drawn with one copy of the asymmetric unit using hardware instancing."):console.log("ANGLE_instanced_arrays is NOT supported. Assembly is drawn by making copies of the asymmetric unit.")),this.posArray=new Array,this.colorArray=new Array,this.pos2Array=new Array,this.color2Array=new Array,this.radiusArray=new Array,this.posArraySphere=new Array,this.colorArraySphere=new Array,this.radiusArraySphere=new Array,this.axis=!1,this.pk=1,this.highlightlevel=1,this.pickpair=!1,this.pAtomNum=0,this.pAtom=void 0,this.pAtom2=void 0,this.bCtrl=!1,this.bShift=!1,this.bStopRotate=!1,this.bCalphaOnly=!1,this.bAllAtoms=!0,this.bConsiderNeighbors=!1,this.bShowCrossResidueBond=!0,this.bExtrude=!0,this.effects={none:this.renderer},this.maxD=500,this.oriMaxD=this.maxD,this.cam_z=2*this.maxD,this.commands=[],this.optsHistory=[],this.logs=[],this.bRender=!0,this.hColor=new THREE.Color(16777011),this.sphereGeometry=new THREE.SphereGeometry(1,32,32),this.boxGeometry=new THREE.BoxGeometry(1,1,1),this.cylinderGeometry=new THREE.CylinderGeometry(1,1,1,32,1),this.cylinderGeometryOutline=new THREE.CylinderGeometry(1,1,1,32,1,!0),this.axisDIV=15,this.strandDIV=6,this.tubeDIV=8,this.nucleicAcidStrandDIV=6,this.linewidth=1,this.hlLineRadius=.1,this.threshbox=180,this.maxAtoms3DMultiFile=4e4,this.tsHbond=3.8,this.tsIonic=6,this.tsContact=4,this.tsHalogen=3.8,this.tsPication=6,this.tsPistacking=5.5,this.LABELSIZE=30,this.optsOri={},this.optsOri.camera="perspective",this.optsOri.background="transparent",this.optsOri.color="chain",this.optsOri.proteins="ribbon",this.optsOri.sidec="nothing",this.optsOri.nucleotides="nucleotide cartoon",this.optsOri.surface="nothing",this.optsOri.opacity="1.0",this.optsOri.wireframe="no",this.optsOri.map="nothing",this.optsOri.mapwireframe="yes",this.optsOri.emmap="nothing",this.optsOri.emmapwireframe="yes",this.optsOri.phimap="nothing",this.optsOri.phimapwireframe="yes",this.optsOri.phisurface="nothing",this.optsOri.phisurftype="nothing",this.optsOri.phisurfop="1.0",this.optsOri.phisurfwf="yes",this.optsOri.chemicals="stick",this.optsOri.water="nothing",this.optsOri.ions="sphere",this.optsOri.hbonds="no",this.optsOri.saltbridge="no",this.optsOri.contact="no",this.optsOri.halogen="no",this.optsOri["pi-cation"]="no",this.optsOri["pi-stacking"]="no",this.optsOri.ssbonds="yes",this.optsOri.clbonds="yes",this.optsOri.rotationcenter="molecule center",this.optsOri.axis="no",this.optsOri.fog="no",this.optsOri.slab="no",this.optsOri.pk="residue",this.optsOri.chemicalbinding="hide",this.opts=t.hashUtilsCls.cloneHash(this.optsOri),this.sheetcolor="green",this.bShowHighlight=!0,this.mapData={},this.bFullUi=!0,this.divid=this.icn3dui.cfg.divid,this.inputid="",this.setOperation="or",this.ROT_DIR="right",this.currSelectedSets=[],this.selectedResidues={},this.bHideSelection=!0,this.bSelectResidue=!1,this.bSelectAlignResidue=!1,this.bAnnoShown=!1,this.bSetChainsAdvancedMenu=!1,this.b2DShown=!1,this.bCrashed=!1,this.bAddCommands=!0,this.bAddLogs=!0,this.bNotLoadStructure=!1,this.startColor="blue",this.midColor="white",this.endColor="red",this.startValue=0,this.midValue=50,this.endValue=100,this.sceneCls=new Ge(this),this.cameraCls=new a(this),this.fogCls=new c(this),this.boxCls=new g(this),this.brickCls=new y(this),this.curveStripArrowCls=new u(this),this.curveCls=new p(this),this.cylinderCls=new S(this),this.lineCls=new v(this),this.reprSubCls=new C(this),this.sphereCls=new w(this),this.stickCls=new Me(this),this.strandCls=new b(this),this.stripCls=new m(this),this.tubeCls=new f(this),this.cartoonNuclCls=new Le(this),this.surfaceCls=new H(this),this.labelCls=new $e(this),this.axesCls=new z(this),this.glycanCls=new qe(this),this.applyCenterCls=new d(this),this.applyClbondsCls=new _(this),this.applyDisplayCls=new Ue(this),this.applyMapCls=new D(this),this.applyOtherCls=new je(this),this.applySsbondsCls=new ze(this),this.applySymdCls=new Be(this),this.hlObjectsCls=new E(this),this.residueLabelsCls=new G(this),this.alternateCls=new nt(this),this.drawCls=new Ye(this),this.firstAtomObjCls=new h(this),this.impostorCls=new Ve(this),this.instancingCls=new We(this),this.contactCls=new A(this),this.hBondCls=new F(this),this.piHalogenCls=new M(this),this.saltbridgeCls=new L(this),this.loadPDBCls=new X(this),this.transformCls=new Xe(this),this.setStyleCls=new Fe(this),this.setColorCls=new j(this),this.threeDPrintCls=new I(this),this.export3DCls=new T(this),this.annoCddSiteCls=new ue(this),this.annoContactCls=new xe(this),this.annoCrossLinkCls=new ke(this),this.annoDomainCls=new Oe(this),this.annoSnpClinVarCls=new He(this),this.annoSsbondCls=new Ce(this),this.annoTransMemCls=new Re(this),this.addTrackCls=new me(this),this.annotationCls=new Ee(this),this.showAnnoCls=new Ae(this),this.showSeqCls=new he(this),this.hlSeqCls=new _e(this),this.hlUpdateCls=new De(this),this.lineGraphCls=new U(this),this.getGraphCls=new N(this),this.showInterCls=new B(this),this.viewInterPairsCls=new q(this),this.drawGraphCls=new ot(this),this.contactMapCls=new rt(this),this.alignParserCls=new ie(this),this.chainalignParserCls=new re(this),this.dsn6ParserCls=new ae(this),this.mmcifParserCls=new Se(this),this.mmdbParserCls=new ne(this),this.mmtfParserCls=new se(this),this.mol2ParserCls=new Z(this),this.opmParserCls=new le(this),this.pdbParserCls=new te(this),this.sdfParserCls=new K(this),this.xyzParserCls=new Q(this),this.realignParserCls=new oe(this),this.densityCifParserCls=new at(this),this.ParserUtilsCls=new we(this),this.loadAtomDataCls=new J(this),this.setSeqAlignCls=new ve(this),this.applyCommandCls=new fe(this),this.definedSetsCls=new P(this),this.loadScriptCls=new de(this),this.selByCommCls=new be(this),this.selectionCls=new Te(this),this.resid2specCls=new ye(this),this.delphiCls=new V(this),this.dsspCls=new ee(this),this.scapCls=new W(this),this.symdCls=new Y(this),this.analysisCls=new pe(this),this.resizeCanvasCls=new ce(this),this.saveFileCls=new Je(this),this.setOptionCls=new Pe(this),this.shareLinkCls=new R(this),this.diagram2dCls=new Ie(this),this.cartoon2dCls=new dt(this),this.rayCls=new ct(this),this.controlCls=new ht(this),this.pickingCls=new ge(this),this.matShader=this.setColorCls.setOutlineColor("yellow")}}mt.prototype.init=function(){this.init_base(),this.molTitle="",this.ssbondpnts={},this.clbondpnts={},this.biomtMatrices=[],this.bAssembly=!0,this.bDrawn=!1,this.bSecondaryStructure=!1,this.bHighlight=1,this.axes=[]},mt.prototype.init_base=function(){this.resetConfig(),this.structures={},this.chains={},this.tddomains={},this.residues={},this.secondaries={},this.alnChains={},this.chainsSeq={},this.chainsColor={},this.chainsGene={},this.chainsAn={},this.chainsAnTitle={},this.alnChainsSeq={},this.alnChainsAnno={},this.alnChainsAnTtl={},this.pickedAtomList={},this.prevHighlightObjects=[],this.prevHighlightObjects_ghost=[],this.prevSurfaces=[],this.prevMaps=[],this.prevEmmaps=[],this.prevPhimaps=[],this.prevOtherMesh=[],this.defNames2Residues={},this.defNames2Atoms={},this.defNames2Descr={},this.defNames2Command={},this.residueId2Name={},this.atoms={},this.dAtoms={},this.hAtoms={},this.proteins={},this.sidec={},this.nucleotides={},this.nucleotidesO3={},this.chemicals={},this.ions={},this.water={},this.calphas={},this.hbondpnts=[],this.saltbridgepnts=[],this.contactpnts=[],this.stabilizerpnts=[],this.halogenpnts=[],this.picationpnts=[],this.pistackingpnts=[],this.distPnts=[],this.doublebonds={},this.triplebonds={},this.aromaticbonds={},this.atomPrevColors={},this.style2atoms={},this.labels={},this.lines={},this.resids2inter={},this.resids2interAll={},this.transformCls.rotateCount=0,this.transformCls.rotateCountMax=20,this.commands=[],this.axes=[],this.bGlycansCartoon=!1,this.chainid2offset={}},mt.prototype.reinitAfterLoad=function(){let e=this,t=e.icn3dui;e.resetConfig(),e.setStyleCls.setAtomStyleByOptions(),e.setColorCls.setColorByOptions(e.opts,e.atoms),e.dAtoms=t.hashUtilsCls.cloneHash(e.atoms),e.hAtoms=t.hashUtilsCls.cloneHash(e.atoms),e.prevHighlightObjects=[],e.prevHighlightObjects_ghost=[],e.prevSurfaces=[],e.prevMaps=[],e.prevEmmaps=[],e.prevPhimaps=[],e.prevOtherMesh=[],e.labels={},e.lines={},e.bAssembly=!0},mt.prototype.resetConfig=function(){let e=this.icn3dui;this.opts=e.hashUtilsCls.cloneHash(this.optsOri),void 0===e.cfg.align&&void 0===e.cfg.chainalign||(this.opts.color="identity",this.opts.proteins="c alpha trace",this.opts.nucleotides="o3 trace"),void 0!==e.cfg.cid&&(this.opts.color="atom",this.opts.pk="atom",this.opts.chemicals="ball and stick"),void 0!==e.cfg.blast_rep_id&&(this.opts.color="conservation"),void 0!==e.cfg.options&&$.extend(this.opts,e.cfg.options)};class pt{constructor(e){this.cfg=e,this.pre=this.cfg.divid+"_",this.REVISION="3.3.4",this.bNode=Object.keys(window).length<2,void 0===this.cfg.command&&(this.cfg.command=""),void 0===this.cfg.width&&(this.cfg.width="100%"),void 0===this.cfg.height&&(this.cfg.height="100%"),void 0===this.cfg.resize&&(this.cfg.resize=!0),void 0===this.cfg.showmenu&&(this.cfg.showmenu=!0),void 0===this.cfg.showtitle&&(this.cfg.showtitle=!0),void 0===this.cfg.showcommand&&(this.cfg.showcommand=!0),void 0===this.cfg.simplemenu&&(this.cfg.simplemenu=!1),void 0===this.cfg.mobilemenu&&(this.cfg.mobilemenu=!1),void 0===this.cfg.closepopup&&(this.cfg.closepopup=!1),void 0===this.cfg.showanno&&(this.cfg.showanno=!1),void 0===this.cfg.showseq&&(this.cfg.showseq=!1),void 0===this.cfg.showalignseq&&(this.cfg.showalignseq=!1),void 0===this.cfg.show2d&&(this.cfg.show2d=!1),void 0===this.cfg.showsets&&(this.cfg.showsets=!1),void 0===this.cfg.rotate&&(this.cfg.rotate="right"),void 0===this.cfg.hidelicense&&(this.cfg.hidelicense=!1),this.hashUtilsCls=new t(this),this.utilsCls=new i(this),this.parasCls=new s(this),this.myEventCls=new l(this),this.rmsdSuprCls=new n(this),this.subdivideCls=new o(this),this.convertTypeCls=new r(this),this.htmlCls=new lt(this)}allCustomEvents(){}}pt.prototype.show3DStructure=function(){let e=this,t=this;return e.deferred=$.Deferred((function(){1==e.cfg.menumode?(e.htmlCls.wifiStr='<i class="icn3d-wifi" title="requires internet">&nbsp;</i>',e.htmlCls.licenseStr='<i class="icn3d-license" title="requires license">&nbsp;</i>'):(e.htmlCls.wifiStr="",e.htmlCls.licenseStr=""),e.setIcn3d();let s=e.icn3d;e.utilsCls.isSessionStorageSupported()&&s.setStyleCls.getCommandsBeforeCrash();let i=e.htmlCls.WIDTH,l=e.htmlCls.HEIGHT;e.oriWidth=i,e.oriHeight=l,e.htmlCls.eventsCls.allEventFunctions(),t.allCustomEvents();let n=0;if((null==e.cfg.showmenu||e.cfg.showmenu)&&(n+=e.htmlCls.MENU_HEIGHT),(null==e.cfg.showcommand||e.cfg.showcommand)&&(n+=e.htmlCls.CMD_HEIGHT),null!=e.cfg.showmenu&&0==e.cfg.showmenu?e.htmlCls.setMenuCls.hideMenu():e.htmlCls.setMenuCls.showMenu(),null!=e.cfg.showtitle&&0==e.cfg.showtitle?$("#"+s.pre+"title").hide():$("#"+s.pre+"title").show(),$("#"+s.pre+"viewer").width(i).height(parseInt(l)+n),$("#"+s.pre+"canvas").width(i).height(parseInt(l)),$("#"+s.pre+"canvas").resizable({resize:function(t,i){e.htmlCls.WIDTH=$("#"+s.pre+"canvas").width(),e.htmlCls.HEIGHT=$("#"+s.pre+"canvas").height(),void 0===s.icn3d||e.icn3d.bFullscreen||s.resizeCanvasCls.resizeCanvas(e.htmlCls.WIDTH,e.htmlCls.HEIGHT,!0)}}),void 0!==e.cfg.usepdbnum?e.icn3d.bUsePdbNum=e.cfg.usepdbnum:void 0!==e.cfg.date?e.icn3d.bUsePdbNum=parseInt(e.cfg.date)>=20201222:"1tup"==e.cfg.mmdbid&&1==e.cfg.showanno&&1==e.cfg.show2d&&1==e.cfg.showsets||"118496"==e.cfg.mmdbid&&0==e.cfg.showanno&&-1!=e.cfg.inpara.indexOf("bu=1")||"163605,1,91105,1,1,1"==e.cfg.align&&-1!=e.cfg.inpara.indexOf("atype=1")?e.icn3d.bUsePdbNum=!1:e.icn3d.bUsePdbNum=!0,e.cfg.replay?(s.bReplay=1,$("#"+s.pre+"replay").show()):(s.bReplay=0,$("#"+s.pre+"replay").hide()),e.utilsCls.isMobile()&&(s.threshbox=60),e.cfg.controlGl&&(s.bControlGl=!0,s.container=s.bControlGl&&!s.icn3dui.bNode?$(document):$("#"+s.id)),s.setStyleCls.handleContextLost(),s.applyCenterCls.setWidthHeight(i,l),s.ori_chemicalbinding=s.opts.chemicalbinding,void 0!==e.cfg.bCalphaOnly&&(s.bCalphaOnly=e.cfg.bCalphaOnly),s.opts=e.hashUtilsCls.cloneHash(s.opts),s.STATENUMBER=s.commands.length,e.utilsCls.isSessionStorageSupported()&&s.bCrashed){s.bCrashed=!1;let t=s.commandsBeforeCrash.split("|||")[0],i=t.substr(t.lastIndexOf(" ")+1);if(i===e.cfg.mmtfid||i===e.cfg.pdbid||i===e.cfg.opmid||i===e.cfg.mmdbid||i===e.cfg.gi||i===e.cfg.blast_rep_id||i===e.cfg.cid||i===e.cfg.mmcifid||i===e.cfg.align||i===e.cfg.chainalign)return void s.loadScriptCls.loadScript(s.commandsBeforeCrash,!0)}if(s.molTitle="",s.loadCmd,void 0!==e.cfg.url){let t=e.cfg.url.split("|"),i=t[0],l=t[1];s.molTitle="",s.inputid=l,s.loadCmd="load url "+l+" | type "+i,e.htmlCls.clickMenuCls.setLogCmd(s.loadCmd,!0),s.pdbParserCls.downloadUrl(l,i)}else if(void 0!==e.cfg.mmtfid)s.inputid=e.cfg.mmtfid,s.loadCmd="load mmtf "+e.cfg.mmtfid,e.htmlCls.clickMenuCls.setLogCmd(s.loadCmd,!0),s.mmtfParserCls.downloadMmtf(e.cfg.mmtfid);else if(void 0!==e.cfg.pdbid)s.inputid=e.cfg.pdbid,s.loadCmd="load pdb "+e.cfg.pdbid,e.htmlCls.clickMenuCls.setLogCmd(s.loadCmd,!0),s.pdbParserCls.downloadPdb(e.cfg.pdbid);else if(void 0!==e.cfg.opmid)s.inputid=e.cfg.opmid,s.loadCmd="load opm "+e.cfg.opmid,e.htmlCls.clickMenuCls.setLogCmd(s.loadCmd,!0),s.opmParserCls.downloadOpm(e.cfg.opmid);else if(void 0!==e.cfg.mmdbid)s.inputid=e.cfg.mmdbid,s.loadCmd="load mmdb "+e.cfg.mmdbid+" | parameters "+e.cfg.inpara,e.htmlCls.clickMenuCls.setLogCmd(s.loadCmd,!0),s.mmdbParserCls.downloadMmdb(e.cfg.mmdbid);else if(void 0!==e.cfg.gi)s.loadCmd="load gi "+e.cfg.gi,e.htmlCls.clickMenuCls.setLogCmd(s.loadCmd,!0),s.mmdbParserCls.downloadGi(e.cfg.gi);else if(void 0!==e.cfg.uniprotid)s.loadCmd="load uniprotid "+e.cfg.uniprotid,e.htmlCls.clickMenuCls.setLogCmd(s.loadCmd,!0),s.mmdbParserCls.downloadUniprotid(e.cfg.uniprotid);else if(void 0!==e.cfg.blast_rep_id)if("Query"!==e.cfg.query_id.substr(0,5)&&void 0===e.cfg.rid)s.inputid=e.cfg.query_id+"_"+e.cfg.blast_rep_id,s.loadCmd="load seq_struct_ids "+e.cfg.query_id+","+e.cfg.blast_rep_id,e.htmlCls.clickMenuCls.setLogCmd(s.loadCmd,!0),s.mmdbParserCls.downloadBlast_rep_id(e.cfg.query_id+","+e.cfg.blast_rep_id);else if(void 0!==e.cfg.rid){let t="https://blast.ncbi.nlm.nih.gov/Blast.cgi?RESULTS_FILE=on&FORMAT_TYPE=JSON2_S&FORMAT_OBJECT=Alignment&CMD=Get&RID="+e.cfg.rid;$.ajax({url:t,dataType:"json",tryCount:0,retryLimit:1,success:function(t){for(let i=0,l=t.BlastOutput2.length;i<l;++i){if(t.BlastOutput2[i].report.results.search.query_id!=e.cfg.query_id)continue;let l,n=t.BlastOutput2[i].report.results.search.hits;for(let t=0,s=n.length;t<s;++t){let s=n[t],i=!1;for(let t=0,l=s.description.length;t<l;++t){if(s.description[t].accession==e.cfg.blast_rep_id){i=!0;break}}if(i){l=s.hsps[0].qseq,l=l.replace(/-/g,"");break}}void 0!==l&&(e.cfg.query_id=l),s.inputid=e.cfg.query_id+"_"+e.cfg.blast_rep_id,s.loadCmd="load seq_struct_ids "+e.cfg.query_id+","+e.cfg.blast_rep_id,e.htmlCls.clickMenuCls.setLogCmd(s.loadCmd,!0),s.mmdbParserCls.downloadBlast_rep_id(e.cfg.query_id+","+e.cfg.blast_rep_id);break}},error:function(t,s,i){this.tryCount++,this.tryCount<=this.retryLimit?$.ajax(this):alert("The RID "+e.cfg.rid+" may have expired...")}})}else alert('BLAST "RID" is a required parameter...');else if(void 0!==e.cfg.cid){s.inputid=e.cfg.cid;let t="https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/cid/"+s.inputid+"/description/jsonp";$.ajax({url:t,dataType:"jsonp",tryCount:0,retryLimit:1,success:function(e){void 0!==e.InformationList&&void 0!==e.InformationList.Information&&(s.molTitle=e.InformationList.Information[0].Title)},error:function(e,t,s){this.tryCount++,this.tryCount<=this.retryLimit&&$.ajax(this)}}),s.loadCmd="load cid "+e.cfg.cid,e.htmlCls.clickMenuCls.setLogCmd(s.loadCmd,!0),s.sdfParserCls.downloadCid(e.cfg.cid)}else if(void 0!==e.cfg.mmcifid)s.inputid=e.cfg.mmcifid,s.loadCmd="load mmcif "+e.cfg.mmcifid,e.htmlCls.clickMenuCls.setLogCmd(s.loadCmd,!0),s.mmcifParserCls.downloadMmcif(e.cfg.mmcifid);else if(void 0!==e.cfg.align){let t=e.cfg.align.split(",");6===t.length?s.inputid=t[0]+"_"+t[3]:2===t.length&&(s.inputid=t[0]+"_"+t[1]),s.loadCmd="load alignment "+e.cfg.align+" | parameters "+e.cfg.inpara,e.htmlCls.clickMenuCls.setLogCmd(s.loadCmd,!0),s.alignParserCls.downloadAlignment(e.cfg.align)}else void 0!==e.cfg.chainalign?(s.bChainAlign=!0,s.inputid=e.cfg.chainalign,s.loadCmd="load chainalignment "+e.cfg.chainalign+" | resnum "+e.cfg.resnum+" | resdef "+e.cfg.resdef+" | parameters "+e.cfg.inpara,e.htmlCls.clickMenuCls.setLogCmd(s.loadCmd,!0),s.chainalignParserCls.downloadChainalignment(e.cfg.chainalign,e.cfg.resnum,e.cfg.resdef)):void 0!==e.cfg.command&&""!==e.cfg.command?(-1!==e.cfg.command.indexOf("url=")&&(s.bInputUrlfile=!0),s.loadScriptCls.loadScript(e.cfg.command)):e.htmlCls.dialogCls.openDlg("dl_mmdbid","Please input MMDB or PDB ID")})),e.deferred.promise()},pt.prototype.setIcn3d=function(){let e=this,t="<label class='icn3d-switch'><input id='"+e.pre+"modeswitch' type='checkbox'><div class='icn3d-slider icn3d-round' style='width:34px; height:18px; margin: 6px 0px 0px 3px;' title='Left(\"All atoms\"): Style and color menu options will be applied to all atoms in the structure&#13;Right(\"Selection\"): Style and color menu options will be applied only to selected atoms'></div></label>",s="<span id='"+e.pre+"modeall' title='Style and color menu options will be applied to all atoms in the structure'>All atoms&nbsp;&nbsp;</span><span id='"+e.pre+"modeselection' class='icn3d-modeselection' style='display:none;' title='Style and color menu options will be applied only to selected atoms'>Selection&nbsp;&nbsp;</span></div></div></td>";e.utilsCls.setViewerWidthHeight(e),e.utilsCls.isMobile()||e.cfg.mobilemenu?e.htmlCls.setMenuCls.setTopMenusHtmlMobile(e.cfg.divid,t,s):e.htmlCls.setMenuCls.setTopMenusHtml(e.cfg.divid,t,s),e.icn3d=new mt(e),e.icn3d.controlCls.setControl(),e.setDialogAjax()},pt.prototype.setDialogAjax=function(){this.bNode||$.ui.dialog.prototype._makeDraggableBase||($.ui.dialog.prototype._makeDraggableBase=$.ui.dialog.prototype._makeDraggable,$.ui.dialog.prototype._makeDraggable=function(){this._makeDraggableBase(),this.uiDialog.draggable("option","containment",!1)}),$.ajaxTransport("+binary",(function(e,t,s){if(window.FormData&&(e.dataType&&"binary"==e.dataType||e.data&&(window.ArrayBuffer&&e.data instanceof ArrayBuffer||window.Blob&&e.data instanceof Blob)))return{send:function(t,s){let i=new XMLHttpRequest,l=e.url,n=e.type,o=e.async||!0,r=e.responseType||"blob",a=e.data||null;i.addEventListener("load",(function(){let t={};t[e.dataType]=i.response,s(i.status,i.statusText,t,i.getAllResponseHeaders())})),i.open(n,l,o);for(let e in t)i.setRequestHeader(e,t[e]);i.responseType=r,i.send(a)},abort:function(){s.abort()}}}))};return e.AddTrack=me,e.AlignParser=ie,e.AlignSeq=st,e.Alternate=nt,e.Analysis=pe,e.AnnoCddSite=ue,e.AnnoContact=xe,e.AnnoCrossLink=ke,e.AnnoDomain=Oe,e.AnnoSnpClinVar=He,e.AnnoSsbond=Ce,e.AnnoTransMem=Re,e.Annotation=Ee,e.ApplyCenter=d,e.ApplyClbonds=_,e.ApplyCommand=fe,e.ApplyDisplay=Ue,e.ApplyMap=D,e.ApplyOther=je,e.ApplySsbonds=ze,e.ApplySymd=Be,e.Axes=z,e.Box=g,e.Brick=y,e.Camera=a,e.CartoonNucl=Le,e.ChainalignParser=re,e.ClickMenu=Ke,e.Contact=A,e.Control=ht,e.ConvertTypeCls=r,e.Curve=p,e.CurveStripArrow=u,e.Cylinder=S,e.DefinedSets=P,e.Delphi=V,e.DensityCifParser=at,e.Diagram2d=Ie,e.Dialog=Ze,e.Draw=Ye,e.DrawGraph=ot,e.Dsn6Parser=ae,e.Dssp=ee,e.ElectronMap=O,e.Events=tt,e.Export3D=T,e.FirstAtomObj=h,e.Fog=c,e.GetGraph=N,e.Glycan=qe,e.HBond=F,e.HashUtilsCls=t,e.HlObjects=E,e.HlSeq=_e,e.HlUpdate=De,e.Html=lt,e.Impostor=Ve,e.Instancing=We,e.Label=$e,e.Line=v,e.LineGraph=U,e.LoadAtomData=J,e.LoadPDB=X,e.LoadScript=de,e.MarchingCube=x,e.MmcifParser=Se,e.MmdbParser=ne,e.MmtfParser=se,e.Mol2Parser=Z,e.MyEventCls=l,e.OpmParser=le,e.ParasCls=s,e.ParserUtils=we,e.PdbParser=te,e.PiHalogen=M,e.Picking=ge,e.ProteinSurface=k,e.Ray=ct,e.RealignParser=oe,e.ReprSub=C,e.Resid2spec=ye,e.ResidueLabels=G,e.ResizeCanvas=ce,e.RmsdSuprCls=n,e.Saltbridge=L,e.SaveFile=Je,e.Scap=W,e.Scene=Ge,e.SdfParser=K,e.SelectByCommand=be,e.Selection=Te,e.SetColor=j,e.SetDialog=et,e.SetHtml=it,e.SetMenu=Qe,e.SetOption=Pe,e.SetSeqAlign=ve,e.SetStyle=Fe,e.ShareLink=R,e.ShowAnno=Ae,e.ShowInter=B,e.ShowSeq=he,e.Sphere=w,e.Stick=Me,e.Strand=b,e.Strip=m,e.SubdivideCls=o,e.Surface=H,e.Symd=Y,e.ThreeDPrint=I,e.Transform=Xe,e.Tube=f,e.UtilsCls=i,e.ViewInterPairs=q,e.XyzParser=Q,e.iCn3D=mt,e.iCn3DUI=pt,e.printMsg=class{constructor(){console.log("This is a message from the icn3d package")}},Object.defineProperty(e,"__esModule",{value:!0}),e}({});
